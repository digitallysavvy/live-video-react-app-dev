var $G=Object.defineProperty;var ZG=(s,o,d)=>o in s?$G(s,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):s[o]=d;var Yd=(s,o,d)=>(ZG(s,typeof o!="symbol"?o+"":o,d),d);function eW(s,o){for(var d=0;d<o.length;d++){const f=o[d];if(typeof f!="string"&&!Array.isArray(f)){for(const m in f)if(m!=="default"&&!(m in s)){const v=Object.getOwnPropertyDescriptor(f,m);v&&Object.defineProperty(s,m,v.get?v:{enumerable:!0,get:()=>f[m]})}}}return Object.freeze(Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}))}(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const m of document.querySelectorAll('link[rel="modulepreload"]'))f(m);new MutationObserver(m=>{for(const v of m)if(v.type==="childList")for(const I of v.addedNodes)I.tagName==="LINK"&&I.rel==="modulepreload"&&f(I)}).observe(document,{childList:!0,subtree:!0});function d(m){const v={};return m.integrity&&(v.integrity=m.integrity),m.referrerPolicy&&(v.referrerPolicy=m.referrerPolicy),m.crossOrigin==="use-credentials"?v.credentials="include":m.crossOrigin==="anonymous"?v.credentials="omit":v.credentials="same-origin",v}function f(m){if(m.ep)return;m.ep=!0;const v=d(m);fetch(m.href,v)}})();function tW(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var OD={exports:{}},r_={},ND={exports:{}},_t={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Mu=Symbol.for("react.element"),iW=Symbol.for("react.portal"),rW=Symbol.for("react.fragment"),nW=Symbol.for("react.strict_mode"),sW=Symbol.for("react.profiler"),aW=Symbol.for("react.provider"),oW=Symbol.for("react.context"),cW=Symbol.for("react.forward_ref"),lW=Symbol.for("react.suspense"),dW=Symbol.for("react.memo"),uW=Symbol.for("react.lazy"),db=Symbol.iterator;function hW(s){return s===null||typeof s!="object"?null:(s=db&&s[db]||s["@@iterator"],typeof s=="function"?s:null)}var bD={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},DD=Object.assign,PD={};function xl(s,o,d){this.props=s,this.context=o,this.refs=PD,this.updater=d||bD}xl.prototype.isReactComponent={};xl.prototype.setState=function(s,o){if(typeof s!="object"&&typeof s!="function"&&s!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,s,o,"setState")};xl.prototype.forceUpdate=function(s){this.updater.enqueueForceUpdate(this,s,"forceUpdate")};function kD(){}kD.prototype=xl.prototype;function JT(s,o,d){this.props=s,this.context=o,this.refs=PD,this.updater=d||bD}var XT=JT.prototype=new kD;XT.constructor=JT;DD(XT,xl.prototype);XT.isPureReactComponent=!0;var ub=Array.isArray,LD=Object.prototype.hasOwnProperty,QT={current:null},MD={key:!0,ref:!0,__self:!0,__source:!0};function UD(s,o,d){var f,m={},v=null,I=null;if(o!=null)for(f in o.ref!==void 0&&(I=o.ref),o.key!==void 0&&(v=""+o.key),o)LD.call(o,f)&&!MD.hasOwnProperty(f)&&(m[f]=o[f]);var D=arguments.length-2;if(D===1)m.children=d;else if(1<D){for(var L=Array(D),V=0;V<D;V++)L[V]=arguments[V+2];m.children=L}if(s&&s.defaultProps)for(f in D=s.defaultProps,D)m[f]===void 0&&(m[f]=D[f]);return{$$typeof:Mu,type:s,key:v,ref:I,props:m,_owner:QT.current}}function pW(s,o){return{$$typeof:Mu,type:s.type,key:o,ref:s.ref,props:s.props,_owner:s._owner}}function $T(s){return typeof s=="object"&&s!==null&&s.$$typeof===Mu}function fW(s){var o={"=":"=0",":":"=2"};return"$"+s.replace(/[=:]/g,function(d){return o[d]})}var hb=/\/+/g;function yS(s,o){return typeof s=="object"&&s!==null&&s.key!=null?fW(""+s.key):o.toString(36)}function Tf(s,o,d,f,m){var v=typeof s;(v==="undefined"||v==="boolean")&&(s=null);var I=!1;if(s===null)I=!0;else switch(v){case"string":case"number":I=!0;break;case"object":switch(s.$$typeof){case Mu:case iW:I=!0}}if(I)return I=s,m=m(I),s=f===""?"."+yS(I,0):f,ub(m)?(d="",s!=null&&(d=s.replace(hb,"$&/")+"/"),Tf(m,o,d,"",function(V){return V})):m!=null&&($T(m)&&(m=pW(m,d+(!m.key||I&&I.key===m.key?"":(""+m.key).replace(hb,"$&/")+"/")+s)),o.push(m)),1;if(I=0,f=f===""?".":f+":",ub(s))for(var D=0;D<s.length;D++){v=s[D];var L=f+yS(v,D);I+=Tf(v,o,d,L,m)}else if(L=hW(s),typeof L=="function")for(s=L.call(s),D=0;!(v=s.next()).done;)v=v.value,L=f+yS(v,D++),I+=Tf(v,o,d,L,m);else if(v==="object")throw o=String(s),Error("Objects are not valid as a React child (found: "+(o==="[object Object]"?"object with keys {"+Object.keys(s).join(", ")+"}":o)+"). If you meant to render a collection of children, use an array instead.");return I}function ef(s,o,d){if(s==null)return s;var f=[],m=0;return Tf(s,f,"","",function(v){return o.call(d,v,m++)}),f}function _W(s){if(s._status===-1){var o=s._result;o=o(),o.then(function(d){(s._status===0||s._status===-1)&&(s._status=1,s._result=d)},function(d){(s._status===0||s._status===-1)&&(s._status=2,s._result=d)}),s._status===-1&&(s._status=0,s._result=o)}if(s._status===1)return s._result.default;throw s._result}var Dr={current:null},vf={transition:null},mW={ReactCurrentDispatcher:Dr,ReactCurrentBatchConfig:vf,ReactCurrentOwner:QT};_t.Children={map:ef,forEach:function(s,o,d){ef(s,function(){o.apply(this,arguments)},d)},count:function(s){var o=0;return ef(s,function(){o++}),o},toArray:function(s){return ef(s,function(o){return o})||[]},only:function(s){if(!$T(s))throw Error("React.Children.only expected to receive a single React element child.");return s}};_t.Component=xl;_t.Fragment=rW;_t.Profiler=sW;_t.PureComponent=JT;_t.StrictMode=nW;_t.Suspense=lW;_t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mW;_t.cloneElement=function(s,o,d){if(s==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+s+".");var f=DD({},s.props),m=s.key,v=s.ref,I=s._owner;if(o!=null){if(o.ref!==void 0&&(v=o.ref,I=QT.current),o.key!==void 0&&(m=""+o.key),s.type&&s.type.defaultProps)var D=s.type.defaultProps;for(L in o)LD.call(o,L)&&!MD.hasOwnProperty(L)&&(f[L]=o[L]===void 0&&D!==void 0?D[L]:o[L])}var L=arguments.length-2;if(L===1)f.children=d;else if(1<L){D=Array(L);for(var V=0;V<L;V++)D[V]=arguments[V+2];f.children=D}return{$$typeof:Mu,type:s.type,key:m,ref:v,props:f,_owner:I}};_t.createContext=function(s){return s={$$typeof:oW,_currentValue:s,_currentValue2:s,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},s.Provider={$$typeof:aW,_context:s},s.Consumer=s};_t.createElement=UD;_t.createFactory=function(s){var o=UD.bind(null,s);return o.type=s,o};_t.createRef=function(){return{current:null}};_t.forwardRef=function(s){return{$$typeof:cW,render:s}};_t.isValidElement=$T;_t.lazy=function(s){return{$$typeof:uW,_payload:{_status:-1,_result:s},_init:_W}};_t.memo=function(s,o){return{$$typeof:dW,type:s,compare:o===void 0?null:o}};_t.startTransition=function(s){var o=vf.transition;vf.transition={};try{s()}finally{vf.transition=o}};_t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")};_t.useCallback=function(s,o){return Dr.current.useCallback(s,o)};_t.useContext=function(s){return Dr.current.useContext(s)};_t.useDebugValue=function(){};_t.useDeferredValue=function(s){return Dr.current.useDeferredValue(s)};_t.useEffect=function(s,o){return Dr.current.useEffect(s,o)};_t.useId=function(){return Dr.current.useId()};_t.useImperativeHandle=function(s,o,d){return Dr.current.useImperativeHandle(s,o,d)};_t.useInsertionEffect=function(s,o){return Dr.current.useInsertionEffect(s,o)};_t.useLayoutEffect=function(s,o){return Dr.current.useLayoutEffect(s,o)};_t.useMemo=function(s,o){return Dr.current.useMemo(s,o)};_t.useReducer=function(s,o,d){return Dr.current.useReducer(s,o,d)};_t.useRef=function(s){return Dr.current.useRef(s)};_t.useState=function(s){return Dr.current.useState(s)};_t.useSyncExternalStore=function(s,o,d){return Dr.current.useSyncExternalStore(s,o,d)};_t.useTransition=function(){return Dr.current.useTransition()};_t.version="18.2.0";ND.exports=_t;var se=ND.exports;const xD=tW(se),EW=eW({__proto__:null,default:xD},[se]);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var gW=se,SW=Symbol.for("react.element"),TW=Symbol.for("react.fragment"),vW=Object.prototype.hasOwnProperty,yW=gW.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,CW={key:!0,ref:!0,__self:!0,__source:!0};function VD(s,o,d){var f,m={},v=null,I=null;d!==void 0&&(v=""+d),o.key!==void 0&&(v=""+o.key),o.ref!==void 0&&(I=o.ref);for(f in o)vW.call(o,f)&&!CW.hasOwnProperty(f)&&(m[f]=o[f]);if(s&&s.defaultProps)for(f in o=s.defaultProps,o)m[f]===void 0&&(m[f]=o[f]);return{$$typeof:SW,type:s,key:v,ref:I,props:m,_owner:yW.current}}r_.Fragment=TW;r_.jsx=VD;r_.jsxs=VD;OD.exports=r_;var we=OD.exports,QS={},FD={exports:{}},Tn={},jD={exports:{}},BD={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(s){function o(Oe,$e){var rt=Oe.length;Oe.push($e);e:for(;0<rt;){var ri=rt-1>>>1,vi=Oe[ri];if(0<m(vi,$e))Oe[ri]=$e,Oe[rt]=vi,rt=ri;else break e}}function d(Oe){return Oe.length===0?null:Oe[0]}function f(Oe){if(Oe.length===0)return null;var $e=Oe[0],rt=Oe.pop();if(rt!==$e){Oe[0]=rt;e:for(var ri=0,vi=Oe.length,io=vi>>>1;ri<io;){var rs=2*(ri+1)-1,dc=Oe[rs],ns=rs+1,ro=Oe[ns];if(0>m(dc,rt))ns<vi&&0>m(ro,dc)?(Oe[ri]=ro,Oe[ns]=rt,ri=ns):(Oe[ri]=dc,Oe[rs]=rt,ri=rs);else if(ns<vi&&0>m(ro,rt))Oe[ri]=ro,Oe[ns]=rt,ri=ns;else break e}}return $e}function m(Oe,$e){var rt=Oe.sortIndex-$e.sortIndex;return rt!==0?rt:Oe.id-$e.id}if(typeof performance=="object"&&typeof performance.now=="function"){var v=performance;s.unstable_now=function(){return v.now()}}else{var I=Date,D=I.now();s.unstable_now=function(){return I.now()-D}}var L=[],V=[],q=1,H=null,te=3,de=!1,pe=!1,ee=!1,ae=typeof setTimeout=="function"?setTimeout:null,K=typeof clearTimeout=="function"?clearTimeout:null,G=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function Q(Oe){for(var $e=d(V);$e!==null;){if($e.callback===null)f(V);else if($e.startTime<=Oe)f(V),$e.sortIndex=$e.expirationTime,o(L,$e);else break;$e=d(V)}}function _e(Oe){if(ee=!1,Q(Oe),!pe)if(d(L)!==null)pe=!0,cc(Re);else{var $e=d(V);$e!==null&&lc(_e,$e.startTime-Oe)}}function Re(Oe,$e){pe=!1,ee&&(ee=!1,K(Fe),Fe=-1),de=!0;var rt=te;try{for(Q($e),H=d(L);H!==null&&(!(H.expirationTime>$e)||Oe&&!kr());){var ri=H.callback;if(typeof ri=="function"){H.callback=null,te=H.priorityLevel;var vi=ri(H.expirationTime<=$e);$e=s.unstable_now(),typeof vi=="function"?H.callback=vi:H===d(L)&&f(L),Q($e)}else f(L);H=d(L)}if(H!==null)var io=!0;else{var rs=d(V);rs!==null&&lc(_e,rs.startTime-$e),io=!1}return io}finally{H=null,te=rt,de=!1}}var Le=!1,Me=null,Fe=-1,ii=5,dt=-1;function kr(){return!(s.unstable_now()-dt<ii)}function ta(){if(Me!==null){var Oe=s.unstable_now();dt=Oe;var $e=!0;try{$e=Me(!0,Oe)}finally{$e?Ns():(Le=!1,Me=null)}}else Le=!1}var Ns;if(typeof G=="function")Ns=function(){G(ta)};else if(typeof MessageChannel<"u"){var Bl=new MessageChannel,ju=Bl.port2;Bl.port1.onmessage=ta,Ns=function(){ju.postMessage(null)}}else Ns=function(){ae(ta,0)};function cc(Oe){Me=Oe,Le||(Le=!0,Ns())}function lc(Oe,$e){Fe=ae(function(){Oe(s.unstable_now())},$e)}s.unstable_IdlePriority=5,s.unstable_ImmediatePriority=1,s.unstable_LowPriority=4,s.unstable_NormalPriority=3,s.unstable_Profiling=null,s.unstable_UserBlockingPriority=2,s.unstable_cancelCallback=function(Oe){Oe.callback=null},s.unstable_continueExecution=function(){pe||de||(pe=!0,cc(Re))},s.unstable_forceFrameRate=function(Oe){0>Oe||125<Oe?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):ii=0<Oe?Math.floor(1e3/Oe):5},s.unstable_getCurrentPriorityLevel=function(){return te},s.unstable_getFirstCallbackNode=function(){return d(L)},s.unstable_next=function(Oe){switch(te){case 1:case 2:case 3:var $e=3;break;default:$e=te}var rt=te;te=$e;try{return Oe()}finally{te=rt}},s.unstable_pauseExecution=function(){},s.unstable_requestPaint=function(){},s.unstable_runWithPriority=function(Oe,$e){switch(Oe){case 1:case 2:case 3:case 4:case 5:break;default:Oe=3}var rt=te;te=Oe;try{return $e()}finally{te=rt}},s.unstable_scheduleCallback=function(Oe,$e,rt){var ri=s.unstable_now();switch(typeof rt=="object"&&rt!==null?(rt=rt.delay,rt=typeof rt=="number"&&0<rt?ri+rt:ri):rt=ri,Oe){case 1:var vi=-1;break;case 2:vi=250;break;case 5:vi=1073741823;break;case 4:vi=1e4;break;default:vi=5e3}return vi=rt+vi,Oe={id:q++,callback:$e,priorityLevel:Oe,startTime:rt,expirationTime:vi,sortIndex:-1},rt>ri?(Oe.sortIndex=rt,o(V,Oe),d(L)===null&&Oe===d(V)&&(ee?(K(Fe),Fe=-1):ee=!0,lc(_e,rt-ri))):(Oe.sortIndex=vi,o(L,Oe),pe||de||(pe=!0,cc(Re))),Oe},s.unstable_shouldYield=kr,s.unstable_wrapCallback=function(Oe){var $e=te;return function(){var rt=te;te=$e;try{return Oe.apply(this,arguments)}finally{te=rt}}}})(BD);jD.exports=BD;var RW=jD.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var GD=se,Sn=RW;function Te(s){for(var o="https://reactjs.org/docs/error-decoder.html?invariant="+s,d=1;d<arguments.length;d++)o+="&args[]="+encodeURIComponent(arguments[d]);return"Minified React error #"+s+"; visit "+o+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var WD=new Set,mu={};function tc(s,o){bl(s,o),bl(s+"Capture",o)}function bl(s,o){for(mu[s]=o,s=0;s<o.length;s++)WD.add(o[s])}var Js=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),$S=Object.prototype.hasOwnProperty,IW=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,pb={},fb={};function wW(s){return $S.call(fb,s)?!0:$S.call(pb,s)?!1:IW.test(s)?fb[s]=!0:(pb[s]=!0,!1)}function AW(s,o,d,f){if(d!==null&&d.type===0)return!1;switch(typeof o){case"function":case"symbol":return!0;case"boolean":return f?!1:d!==null?!d.acceptsBooleans:(s=s.toLowerCase().slice(0,5),s!=="data-"&&s!=="aria-");default:return!1}}function OW(s,o,d,f){if(o===null||typeof o>"u"||AW(s,o,d,f))return!0;if(f)return!1;if(d!==null)switch(d.type){case 3:return!o;case 4:return o===!1;case 5:return isNaN(o);case 6:return isNaN(o)||1>o}return!1}function Pr(s,o,d,f,m,v,I){this.acceptsBooleans=o===2||o===3||o===4,this.attributeName=f,this.attributeNamespace=m,this.mustUseProperty=d,this.propertyName=s,this.type=o,this.sanitizeURL=v,this.removeEmptyString=I}var sr={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(s){sr[s]=new Pr(s,0,!1,s,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(s){var o=s[0];sr[o]=new Pr(o,1,!1,s[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(s){sr[s]=new Pr(s,2,!1,s.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(s){sr[s]=new Pr(s,2,!1,s,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(s){sr[s]=new Pr(s,3,!1,s.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(s){sr[s]=new Pr(s,3,!0,s,null,!1,!1)});["capture","download"].forEach(function(s){sr[s]=new Pr(s,4,!1,s,null,!1,!1)});["cols","rows","size","span"].forEach(function(s){sr[s]=new Pr(s,6,!1,s,null,!1,!1)});["rowSpan","start"].forEach(function(s){sr[s]=new Pr(s,5,!1,s.toLowerCase(),null,!1,!1)});var ZT=/[\-:]([a-z])/g;function ev(s){return s[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(s){var o=s.replace(ZT,ev);sr[o]=new Pr(o,1,!1,s,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(s){var o=s.replace(ZT,ev);sr[o]=new Pr(o,1,!1,s,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(s){var o=s.replace(ZT,ev);sr[o]=new Pr(o,1,!1,s,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(s){sr[s]=new Pr(s,1,!1,s.toLowerCase(),null,!1,!1)});sr.xlinkHref=new Pr("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(s){sr[s]=new Pr(s,1,!1,s.toLowerCase(),null,!0,!0)});function tv(s,o,d,f){var m=sr.hasOwnProperty(o)?sr[o]:null;(m!==null?m.type!==0:f||!(2<o.length)||o[0]!=="o"&&o[0]!=="O"||o[1]!=="n"&&o[1]!=="N")&&(OW(o,d,m,f)&&(d=null),f||m===null?wW(o)&&(d===null?s.removeAttribute(o):s.setAttribute(o,""+d)):m.mustUseProperty?s[m.propertyName]=d===null?m.type===3?!1:"":d:(o=m.attributeName,f=m.attributeNamespace,d===null?s.removeAttribute(o):(m=m.type,d=m===3||m===4&&d===!0?"":""+d,f?s.setAttributeNS(f,o,d):s.setAttribute(o,d))))}var Zs=GD.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,tf=Symbol.for("react.element"),hl=Symbol.for("react.portal"),pl=Symbol.for("react.fragment"),iv=Symbol.for("react.strict_mode"),ZS=Symbol.for("react.profiler"),HD=Symbol.for("react.provider"),KD=Symbol.for("react.context"),rv=Symbol.for("react.forward_ref"),eT=Symbol.for("react.suspense"),tT=Symbol.for("react.suspense_list"),nv=Symbol.for("react.memo"),Ma=Symbol.for("react.lazy"),zD=Symbol.for("react.offscreen"),_b=Symbol.iterator;function qd(s){return s===null||typeof s!="object"?null:(s=_b&&s[_b]||s["@@iterator"],typeof s=="function"?s:null)}var mi=Object.assign,CS;function iu(s){if(CS===void 0)try{throw Error()}catch(d){var o=d.stack.trim().match(/\n( *(at )?)/);CS=o&&o[1]||""}return`
`+CS+s}var RS=!1;function IS(s,o){if(!s||RS)return"";RS=!0;var d=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(o)if(o=function(){throw Error()},Object.defineProperty(o.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(o,[])}catch(V){var f=V}Reflect.construct(s,[],o)}else{try{o.call()}catch(V){f=V}s.call(o.prototype)}else{try{throw Error()}catch(V){f=V}s()}}catch(V){if(V&&f&&typeof V.stack=="string"){for(var m=V.stack.split(`
`),v=f.stack.split(`
`),I=m.length-1,D=v.length-1;1<=I&&0<=D&&m[I]!==v[D];)D--;for(;1<=I&&0<=D;I--,D--)if(m[I]!==v[D]){if(I!==1||D!==1)do if(I--,D--,0>D||m[I]!==v[D]){var L=`
`+m[I].replace(" at new "," at ");return s.displayName&&L.includes("<anonymous>")&&(L=L.replace("<anonymous>",s.displayName)),L}while(1<=I&&0<=D);break}}}finally{RS=!1,Error.prepareStackTrace=d}return(s=s?s.displayName||s.name:"")?iu(s):""}function NW(s){switch(s.tag){case 5:return iu(s.type);case 16:return iu("Lazy");case 13:return iu("Suspense");case 19:return iu("SuspenseList");case 0:case 2:case 15:return s=IS(s.type,!1),s;case 11:return s=IS(s.type.render,!1),s;case 1:return s=IS(s.type,!0),s;default:return""}}function iT(s){if(s==null)return null;if(typeof s=="function")return s.displayName||s.name||null;if(typeof s=="string")return s;switch(s){case pl:return"Fragment";case hl:return"Portal";case ZS:return"Profiler";case iv:return"StrictMode";case eT:return"Suspense";case tT:return"SuspenseList"}if(typeof s=="object")switch(s.$$typeof){case KD:return(s.displayName||"Context")+".Consumer";case HD:return(s._context.displayName||"Context")+".Provider";case rv:var o=s.render;return s=s.displayName,s||(s=o.displayName||o.name||"",s=s!==""?"ForwardRef("+s+")":"ForwardRef"),s;case nv:return o=s.displayName||null,o!==null?o:iT(s.type)||"Memo";case Ma:o=s._payload,s=s._init;try{return iT(s(o))}catch{}}return null}function bW(s){var o=s.type;switch(s.tag){case 24:return"Cache";case 9:return(o.displayName||"Context")+".Consumer";case 10:return(o._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return s=o.render,s=s.displayName||s.name||"",o.displayName||(s!==""?"ForwardRef("+s+")":"ForwardRef");case 7:return"Fragment";case 5:return o;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return iT(o);case 8:return o===iv?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof o=="function")return o.displayName||o.name||null;if(typeof o=="string")return o}return null}function Xa(s){switch(typeof s){case"boolean":case"number":case"string":case"undefined":return s;case"object":return s;default:return""}}function YD(s){var o=s.type;return(s=s.nodeName)&&s.toLowerCase()==="input"&&(o==="checkbox"||o==="radio")}function DW(s){var o=YD(s)?"checked":"value",d=Object.getOwnPropertyDescriptor(s.constructor.prototype,o),f=""+s[o];if(!s.hasOwnProperty(o)&&typeof d<"u"&&typeof d.get=="function"&&typeof d.set=="function"){var m=d.get,v=d.set;return Object.defineProperty(s,o,{configurable:!0,get:function(){return m.call(this)},set:function(I){f=""+I,v.call(this,I)}}),Object.defineProperty(s,o,{enumerable:d.enumerable}),{getValue:function(){return f},setValue:function(I){f=""+I},stopTracking:function(){s._valueTracker=null,delete s[o]}}}}function rf(s){s._valueTracker||(s._valueTracker=DW(s))}function qD(s){if(!s)return!1;var o=s._valueTracker;if(!o)return!0;var d=o.getValue(),f="";return s&&(f=YD(s)?s.checked?"true":"false":s.value),s=f,s!==d?(o.setValue(s),!0):!1}function Pf(s){if(s=s||(typeof document<"u"?document:void 0),typeof s>"u")return null;try{return s.activeElement||s.body}catch{return s.body}}function rT(s,o){var d=o.checked;return mi({},o,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:d??s._wrapperState.initialChecked})}function mb(s,o){var d=o.defaultValue==null?"":o.defaultValue,f=o.checked!=null?o.checked:o.defaultChecked;d=Xa(o.value!=null?o.value:d),s._wrapperState={initialChecked:f,initialValue:d,controlled:o.type==="checkbox"||o.type==="radio"?o.checked!=null:o.value!=null}}function JD(s,o){o=o.checked,o!=null&&tv(s,"checked",o,!1)}function nT(s,o){JD(s,o);var d=Xa(o.value),f=o.type;if(d!=null)f==="number"?(d===0&&s.value===""||s.value!=d)&&(s.value=""+d):s.value!==""+d&&(s.value=""+d);else if(f==="submit"||f==="reset"){s.removeAttribute("value");return}o.hasOwnProperty("value")?sT(s,o.type,d):o.hasOwnProperty("defaultValue")&&sT(s,o.type,Xa(o.defaultValue)),o.checked==null&&o.defaultChecked!=null&&(s.defaultChecked=!!o.defaultChecked)}function Eb(s,o,d){if(o.hasOwnProperty("value")||o.hasOwnProperty("defaultValue")){var f=o.type;if(!(f!=="submit"&&f!=="reset"||o.value!==void 0&&o.value!==null))return;o=""+s._wrapperState.initialValue,d||o===s.value||(s.value=o),s.defaultValue=o}d=s.name,d!==""&&(s.name=""),s.defaultChecked=!!s._wrapperState.initialChecked,d!==""&&(s.name=d)}function sT(s,o,d){(o!=="number"||Pf(s.ownerDocument)!==s)&&(d==null?s.defaultValue=""+s._wrapperState.initialValue:s.defaultValue!==""+d&&(s.defaultValue=""+d))}var ru=Array.isArray;function Rl(s,o,d,f){if(s=s.options,o){o={};for(var m=0;m<d.length;m++)o["$"+d[m]]=!0;for(d=0;d<s.length;d++)m=o.hasOwnProperty("$"+s[d].value),s[d].selected!==m&&(s[d].selected=m),m&&f&&(s[d].defaultSelected=!0)}else{for(d=""+Xa(d),o=null,m=0;m<s.length;m++){if(s[m].value===d){s[m].selected=!0,f&&(s[m].defaultSelected=!0);return}o!==null||s[m].disabled||(o=s[m])}o!==null&&(o.selected=!0)}}function aT(s,o){if(o.dangerouslySetInnerHTML!=null)throw Error(Te(91));return mi({},o,{value:void 0,defaultValue:void 0,children:""+s._wrapperState.initialValue})}function gb(s,o){var d=o.value;if(d==null){if(d=o.children,o=o.defaultValue,d!=null){if(o!=null)throw Error(Te(92));if(ru(d)){if(1<d.length)throw Error(Te(93));d=d[0]}o=d}o==null&&(o=""),d=o}s._wrapperState={initialValue:Xa(d)}}function XD(s,o){var d=Xa(o.value),f=Xa(o.defaultValue);d!=null&&(d=""+d,d!==s.value&&(s.value=d),o.defaultValue==null&&s.defaultValue!==d&&(s.defaultValue=d)),f!=null&&(s.defaultValue=""+f)}function Sb(s){var o=s.textContent;o===s._wrapperState.initialValue&&o!==""&&o!==null&&(s.value=o)}function QD(s){switch(s){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function oT(s,o){return s==null||s==="http://www.w3.org/1999/xhtml"?QD(o):s==="http://www.w3.org/2000/svg"&&o==="foreignObject"?"http://www.w3.org/1999/xhtml":s}var nf,$D=function(s){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(o,d,f,m){MSApp.execUnsafeLocalFunction(function(){return s(o,d,f,m)})}:s}(function(s,o){if(s.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in s)s.innerHTML=o;else{for(nf=nf||document.createElement("div"),nf.innerHTML="<svg>"+o.valueOf().toString()+"</svg>",o=nf.firstChild;s.firstChild;)s.removeChild(s.firstChild);for(;o.firstChild;)s.appendChild(o.firstChild)}});function Eu(s,o){if(o){var d=s.firstChild;if(d&&d===s.lastChild&&d.nodeType===3){d.nodeValue=o;return}}s.textContent=o}var ou={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},PW=["Webkit","ms","Moz","O"];Object.keys(ou).forEach(function(s){PW.forEach(function(o){o=o+s.charAt(0).toUpperCase()+s.substring(1),ou[o]=ou[s]})});function ZD(s,o,d){return o==null||typeof o=="boolean"||o===""?"":d||typeof o!="number"||o===0||ou.hasOwnProperty(s)&&ou[s]?(""+o).trim():o+"px"}function eP(s,o){s=s.style;for(var d in o)if(o.hasOwnProperty(d)){var f=d.indexOf("--")===0,m=ZD(d,o[d],f);d==="float"&&(d="cssFloat"),f?s.setProperty(d,m):s[d]=m}}var kW=mi({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function cT(s,o){if(o){if(kW[s]&&(o.children!=null||o.dangerouslySetInnerHTML!=null))throw Error(Te(137,s));if(o.dangerouslySetInnerHTML!=null){if(o.children!=null)throw Error(Te(60));if(typeof o.dangerouslySetInnerHTML!="object"||!("__html"in o.dangerouslySetInnerHTML))throw Error(Te(61))}if(o.style!=null&&typeof o.style!="object")throw Error(Te(62))}}function lT(s,o){if(s.indexOf("-")===-1)return typeof o.is=="string";switch(s){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var dT=null;function sv(s){return s=s.target||s.srcElement||window,s.correspondingUseElement&&(s=s.correspondingUseElement),s.nodeType===3?s.parentNode:s}var uT=null,Il=null,wl=null;function Tb(s){if(s=Vu(s)){if(typeof uT!="function")throw Error(Te(280));var o=s.stateNode;o&&(o=c_(o),uT(s.stateNode,s.type,o))}}function tP(s){Il?wl?wl.push(s):wl=[s]:Il=s}function iP(){if(Il){var s=Il,o=wl;if(wl=Il=null,Tb(s),o)for(s=0;s<o.length;s++)Tb(o[s])}}function rP(s,o){return s(o)}function nP(){}var wS=!1;function sP(s,o,d){if(wS)return s(o,d);wS=!0;try{return rP(s,o,d)}finally{wS=!1,(Il!==null||wl!==null)&&(nP(),iP())}}function gu(s,o){var d=s.stateNode;if(d===null)return null;var f=c_(d);if(f===null)return null;d=f[o];e:switch(o){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(f=!f.disabled)||(s=s.type,f=!(s==="button"||s==="input"||s==="select"||s==="textarea")),s=!f;break e;default:s=!1}if(s)return null;if(d&&typeof d!="function")throw Error(Te(231,o,typeof d));return d}var hT=!1;if(Js)try{var Jd={};Object.defineProperty(Jd,"passive",{get:function(){hT=!0}}),window.addEventListener("test",Jd,Jd),window.removeEventListener("test",Jd,Jd)}catch{hT=!1}function LW(s,o,d,f,m,v,I,D,L){var V=Array.prototype.slice.call(arguments,3);try{o.apply(d,V)}catch(q){this.onError(q)}}var cu=!1,kf=null,Lf=!1,pT=null,MW={onError:function(s){cu=!0,kf=s}};function UW(s,o,d,f,m,v,I,D,L){cu=!1,kf=null,LW.apply(MW,arguments)}function xW(s,o,d,f,m,v,I,D,L){if(UW.apply(this,arguments),cu){if(cu){var V=kf;cu=!1,kf=null}else throw Error(Te(198));Lf||(Lf=!0,pT=V)}}function ic(s){var o=s,d=s;if(s.alternate)for(;o.return;)o=o.return;else{s=o;do o=s,o.flags&4098&&(d=o.return),s=o.return;while(s)}return o.tag===3?d:null}function aP(s){if(s.tag===13){var o=s.memoizedState;if(o===null&&(s=s.alternate,s!==null&&(o=s.memoizedState)),o!==null)return o.dehydrated}return null}function vb(s){if(ic(s)!==s)throw Error(Te(188))}function VW(s){var o=s.alternate;if(!o){if(o=ic(s),o===null)throw Error(Te(188));return o!==s?null:s}for(var d=s,f=o;;){var m=d.return;if(m===null)break;var v=m.alternate;if(v===null){if(f=m.return,f!==null){d=f;continue}break}if(m.child===v.child){for(v=m.child;v;){if(v===d)return vb(m),s;if(v===f)return vb(m),o;v=v.sibling}throw Error(Te(188))}if(d.return!==f.return)d=m,f=v;else{for(var I=!1,D=m.child;D;){if(D===d){I=!0,d=m,f=v;break}if(D===f){I=!0,f=m,d=v;break}D=D.sibling}if(!I){for(D=v.child;D;){if(D===d){I=!0,d=v,f=m;break}if(D===f){I=!0,f=v,d=m;break}D=D.sibling}if(!I)throw Error(Te(189))}}if(d.alternate!==f)throw Error(Te(190))}if(d.tag!==3)throw Error(Te(188));return d.stateNode.current===d?s:o}function oP(s){return s=VW(s),s!==null?cP(s):null}function cP(s){if(s.tag===5||s.tag===6)return s;for(s=s.child;s!==null;){var o=cP(s);if(o!==null)return o;s=s.sibling}return null}var lP=Sn.unstable_scheduleCallback,yb=Sn.unstable_cancelCallback,FW=Sn.unstable_shouldYield,jW=Sn.unstable_requestPaint,Ni=Sn.unstable_now,BW=Sn.unstable_getCurrentPriorityLevel,av=Sn.unstable_ImmediatePriority,dP=Sn.unstable_UserBlockingPriority,Mf=Sn.unstable_NormalPriority,GW=Sn.unstable_LowPriority,uP=Sn.unstable_IdlePriority,n_=null,As=null;function WW(s){if(As&&typeof As.onCommitFiberRoot=="function")try{As.onCommitFiberRoot(n_,s,void 0,(s.current.flags&128)===128)}catch{}}var es=Math.clz32?Math.clz32:zW,HW=Math.log,KW=Math.LN2;function zW(s){return s>>>=0,s===0?32:31-(HW(s)/KW|0)|0}var sf=64,af=4194304;function nu(s){switch(s&-s){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return s&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return s&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return s}}function Uf(s,o){var d=s.pendingLanes;if(d===0)return 0;var f=0,m=s.suspendedLanes,v=s.pingedLanes,I=d&268435455;if(I!==0){var D=I&~m;D!==0?f=nu(D):(v&=I,v!==0&&(f=nu(v)))}else I=d&~m,I!==0?f=nu(I):v!==0&&(f=nu(v));if(f===0)return 0;if(o!==0&&o!==f&&!(o&m)&&(m=f&-f,v=o&-o,m>=v||m===16&&(v&4194240)!==0))return o;if(f&4&&(f|=d&16),o=s.entangledLanes,o!==0)for(s=s.entanglements,o&=f;0<o;)d=31-es(o),m=1<<d,f|=s[d],o&=~m;return f}function YW(s,o){switch(s){case 1:case 2:case 4:return o+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return o+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function qW(s,o){for(var d=s.suspendedLanes,f=s.pingedLanes,m=s.expirationTimes,v=s.pendingLanes;0<v;){var I=31-es(v),D=1<<I,L=m[I];L===-1?(!(D&d)||D&f)&&(m[I]=YW(D,o)):L<=o&&(s.expiredLanes|=D),v&=~D}}function fT(s){return s=s.pendingLanes&-1073741825,s!==0?s:s&1073741824?1073741824:0}function hP(){var s=sf;return sf<<=1,!(sf&4194240)&&(sf=64),s}function AS(s){for(var o=[],d=0;31>d;d++)o.push(s);return o}function Uu(s,o,d){s.pendingLanes|=o,o!==536870912&&(s.suspendedLanes=0,s.pingedLanes=0),s=s.eventTimes,o=31-es(o),s[o]=d}function JW(s,o){var d=s.pendingLanes&~o;s.pendingLanes=o,s.suspendedLanes=0,s.pingedLanes=0,s.expiredLanes&=o,s.mutableReadLanes&=o,s.entangledLanes&=o,o=s.entanglements;var f=s.eventTimes;for(s=s.expirationTimes;0<d;){var m=31-es(d),v=1<<m;o[m]=0,f[m]=-1,s[m]=-1,d&=~v}}function ov(s,o){var d=s.entangledLanes|=o;for(s=s.entanglements;d;){var f=31-es(d),m=1<<f;m&o|s[f]&o&&(s[f]|=o),d&=~m}}var Lt=0;function pP(s){return s&=-s,1<s?4<s?s&268435455?16:536870912:4:1}var fP,cv,_P,mP,EP,_T=!1,of=[],Ga=null,Wa=null,Ha=null,Su=new Map,Tu=new Map,xa=[],XW="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Cb(s,o){switch(s){case"focusin":case"focusout":Ga=null;break;case"dragenter":case"dragleave":Wa=null;break;case"mouseover":case"mouseout":Ha=null;break;case"pointerover":case"pointerout":Su.delete(o.pointerId);break;case"gotpointercapture":case"lostpointercapture":Tu.delete(o.pointerId)}}function Xd(s,o,d,f,m,v){return s===null||s.nativeEvent!==v?(s={blockedOn:o,domEventName:d,eventSystemFlags:f,nativeEvent:v,targetContainers:[m]},o!==null&&(o=Vu(o),o!==null&&cv(o)),s):(s.eventSystemFlags|=f,o=s.targetContainers,m!==null&&o.indexOf(m)===-1&&o.push(m),s)}function QW(s,o,d,f,m){switch(o){case"focusin":return Ga=Xd(Ga,s,o,d,f,m),!0;case"dragenter":return Wa=Xd(Wa,s,o,d,f,m),!0;case"mouseover":return Ha=Xd(Ha,s,o,d,f,m),!0;case"pointerover":var v=m.pointerId;return Su.set(v,Xd(Su.get(v)||null,s,o,d,f,m)),!0;case"gotpointercapture":return v=m.pointerId,Tu.set(v,Xd(Tu.get(v)||null,s,o,d,f,m)),!0}return!1}function gP(s){var o=Ho(s.target);if(o!==null){var d=ic(o);if(d!==null){if(o=d.tag,o===13){if(o=aP(d),o!==null){s.blockedOn=o,EP(s.priority,function(){_P(d)});return}}else if(o===3&&d.stateNode.current.memoizedState.isDehydrated){s.blockedOn=d.tag===3?d.stateNode.containerInfo:null;return}}}s.blockedOn=null}function yf(s){if(s.blockedOn!==null)return!1;for(var o=s.targetContainers;0<o.length;){var d=mT(s.domEventName,s.eventSystemFlags,o[0],s.nativeEvent);if(d===null){d=s.nativeEvent;var f=new d.constructor(d.type,d);dT=f,d.target.dispatchEvent(f),dT=null}else return o=Vu(d),o!==null&&cv(o),s.blockedOn=d,!1;o.shift()}return!0}function Rb(s,o,d){yf(s)&&d.delete(o)}function $W(){_T=!1,Ga!==null&&yf(Ga)&&(Ga=null),Wa!==null&&yf(Wa)&&(Wa=null),Ha!==null&&yf(Ha)&&(Ha=null),Su.forEach(Rb),Tu.forEach(Rb)}function Qd(s,o){s.blockedOn===o&&(s.blockedOn=null,_T||(_T=!0,Sn.unstable_scheduleCallback(Sn.unstable_NormalPriority,$W)))}function vu(s){function o(m){return Qd(m,s)}if(0<of.length){Qd(of[0],s);for(var d=1;d<of.length;d++){var f=of[d];f.blockedOn===s&&(f.blockedOn=null)}}for(Ga!==null&&Qd(Ga,s),Wa!==null&&Qd(Wa,s),Ha!==null&&Qd(Ha,s),Su.forEach(o),Tu.forEach(o),d=0;d<xa.length;d++)f=xa[d],f.blockedOn===s&&(f.blockedOn=null);for(;0<xa.length&&(d=xa[0],d.blockedOn===null);)gP(d),d.blockedOn===null&&xa.shift()}var Al=Zs.ReactCurrentBatchConfig,xf=!0;function ZW(s,o,d,f){var m=Lt,v=Al.transition;Al.transition=null;try{Lt=1,lv(s,o,d,f)}finally{Lt=m,Al.transition=v}}function e6(s,o,d,f){var m=Lt,v=Al.transition;Al.transition=null;try{Lt=4,lv(s,o,d,f)}finally{Lt=m,Al.transition=v}}function lv(s,o,d,f){if(xf){var m=mT(s,o,d,f);if(m===null)xS(s,o,f,Vf,d),Cb(s,f);else if(QW(m,s,o,d,f))f.stopPropagation();else if(Cb(s,f),o&4&&-1<XW.indexOf(s)){for(;m!==null;){var v=Vu(m);if(v!==null&&fP(v),v=mT(s,o,d,f),v===null&&xS(s,o,f,Vf,d),v===m)break;m=v}m!==null&&f.stopPropagation()}else xS(s,o,f,null,d)}}var Vf=null;function mT(s,o,d,f){if(Vf=null,s=sv(f),s=Ho(s),s!==null)if(o=ic(s),o===null)s=null;else if(d=o.tag,d===13){if(s=aP(o),s!==null)return s;s=null}else if(d===3){if(o.stateNode.current.memoizedState.isDehydrated)return o.tag===3?o.stateNode.containerInfo:null;s=null}else o!==s&&(s=null);return Vf=s,null}function SP(s){switch(s){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(BW()){case av:return 1;case dP:return 4;case Mf:case GW:return 16;case uP:return 536870912;default:return 16}default:return 16}}var Fa=null,dv=null,Cf=null;function TP(){if(Cf)return Cf;var s,o=dv,d=o.length,f,m="value"in Fa?Fa.value:Fa.textContent,v=m.length;for(s=0;s<d&&o[s]===m[s];s++);var I=d-s;for(f=1;f<=I&&o[d-f]===m[v-f];f++);return Cf=m.slice(s,1<f?1-f:void 0)}function Rf(s){var o=s.keyCode;return"charCode"in s?(s=s.charCode,s===0&&o===13&&(s=13)):s=o,s===10&&(s=13),32<=s||s===13?s:0}function cf(){return!0}function Ib(){return!1}function vn(s){function o(d,f,m,v,I){this._reactName=d,this._targetInst=m,this.type=f,this.nativeEvent=v,this.target=I,this.currentTarget=null;for(var D in s)s.hasOwnProperty(D)&&(d=s[D],this[D]=d?d(v):v[D]);return this.isDefaultPrevented=(v.defaultPrevented!=null?v.defaultPrevented:v.returnValue===!1)?cf:Ib,this.isPropagationStopped=Ib,this}return mi(o.prototype,{preventDefault:function(){this.defaultPrevented=!0;var d=this.nativeEvent;d&&(d.preventDefault?d.preventDefault():typeof d.returnValue!="unknown"&&(d.returnValue=!1),this.isDefaultPrevented=cf)},stopPropagation:function(){var d=this.nativeEvent;d&&(d.stopPropagation?d.stopPropagation():typeof d.cancelBubble!="unknown"&&(d.cancelBubble=!0),this.isPropagationStopped=cf)},persist:function(){},isPersistent:cf}),o}var Vl={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(s){return s.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},uv=vn(Vl),xu=mi({},Vl,{view:0,detail:0}),t6=vn(xu),OS,NS,$d,s_=mi({},xu,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:hv,button:0,buttons:0,relatedTarget:function(s){return s.relatedTarget===void 0?s.fromElement===s.srcElement?s.toElement:s.fromElement:s.relatedTarget},movementX:function(s){return"movementX"in s?s.movementX:(s!==$d&&($d&&s.type==="mousemove"?(OS=s.screenX-$d.screenX,NS=s.screenY-$d.screenY):NS=OS=0,$d=s),OS)},movementY:function(s){return"movementY"in s?s.movementY:NS}}),wb=vn(s_),i6=mi({},s_,{dataTransfer:0}),r6=vn(i6),n6=mi({},xu,{relatedTarget:0}),bS=vn(n6),s6=mi({},Vl,{animationName:0,elapsedTime:0,pseudoElement:0}),a6=vn(s6),o6=mi({},Vl,{clipboardData:function(s){return"clipboardData"in s?s.clipboardData:window.clipboardData}}),c6=vn(o6),l6=mi({},Vl,{data:0}),Ab=vn(l6),d6={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},u6={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},h6={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function p6(s){var o=this.nativeEvent;return o.getModifierState?o.getModifierState(s):(s=h6[s])?!!o[s]:!1}function hv(){return p6}var f6=mi({},xu,{key:function(s){if(s.key){var o=d6[s.key]||s.key;if(o!=="Unidentified")return o}return s.type==="keypress"?(s=Rf(s),s===13?"Enter":String.fromCharCode(s)):s.type==="keydown"||s.type==="keyup"?u6[s.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:hv,charCode:function(s){return s.type==="keypress"?Rf(s):0},keyCode:function(s){return s.type==="keydown"||s.type==="keyup"?s.keyCode:0},which:function(s){return s.type==="keypress"?Rf(s):s.type==="keydown"||s.type==="keyup"?s.keyCode:0}}),_6=vn(f6),m6=mi({},s_,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Ob=vn(m6),E6=mi({},xu,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:hv}),g6=vn(E6),S6=mi({},Vl,{propertyName:0,elapsedTime:0,pseudoElement:0}),T6=vn(S6),v6=mi({},s_,{deltaX:function(s){return"deltaX"in s?s.deltaX:"wheelDeltaX"in s?-s.wheelDeltaX:0},deltaY:function(s){return"deltaY"in s?s.deltaY:"wheelDeltaY"in s?-s.wheelDeltaY:"wheelDelta"in s?-s.wheelDelta:0},deltaZ:0,deltaMode:0}),y6=vn(v6),C6=[9,13,27,32],pv=Js&&"CompositionEvent"in window,lu=null;Js&&"documentMode"in document&&(lu=document.documentMode);var R6=Js&&"TextEvent"in window&&!lu,vP=Js&&(!pv||lu&&8<lu&&11>=lu),Nb=" ",bb=!1;function yP(s,o){switch(s){case"keyup":return C6.indexOf(o.keyCode)!==-1;case"keydown":return o.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function CP(s){return s=s.detail,typeof s=="object"&&"data"in s?s.data:null}var fl=!1;function I6(s,o){switch(s){case"compositionend":return CP(o);case"keypress":return o.which!==32?null:(bb=!0,Nb);case"textInput":return s=o.data,s===Nb&&bb?null:s;default:return null}}function w6(s,o){if(fl)return s==="compositionend"||!pv&&yP(s,o)?(s=TP(),Cf=dv=Fa=null,fl=!1,s):null;switch(s){case"paste":return null;case"keypress":if(!(o.ctrlKey||o.altKey||o.metaKey)||o.ctrlKey&&o.altKey){if(o.char&&1<o.char.length)return o.char;if(o.which)return String.fromCharCode(o.which)}return null;case"compositionend":return vP&&o.locale!=="ko"?null:o.data;default:return null}}var A6={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Db(s){var o=s&&s.nodeName&&s.nodeName.toLowerCase();return o==="input"?!!A6[s.type]:o==="textarea"}function RP(s,o,d,f){tP(f),o=Ff(o,"onChange"),0<o.length&&(d=new uv("onChange","change",null,d,f),s.push({event:d,listeners:o}))}var du=null,yu=null;function O6(s){MP(s,0)}function a_(s){var o=El(s);if(qD(o))return s}function N6(s,o){if(s==="change")return o}var IP=!1;if(Js){var DS;if(Js){var PS="oninput"in document;if(!PS){var Pb=document.createElement("div");Pb.setAttribute("oninput","return;"),PS=typeof Pb.oninput=="function"}DS=PS}else DS=!1;IP=DS&&(!document.documentMode||9<document.documentMode)}function kb(){du&&(du.detachEvent("onpropertychange",wP),yu=du=null)}function wP(s){if(s.propertyName==="value"&&a_(yu)){var o=[];RP(o,yu,s,sv(s)),sP(O6,o)}}function b6(s,o,d){s==="focusin"?(kb(),du=o,yu=d,du.attachEvent("onpropertychange",wP)):s==="focusout"&&kb()}function D6(s){if(s==="selectionchange"||s==="keyup"||s==="keydown")return a_(yu)}function P6(s,o){if(s==="click")return a_(o)}function k6(s,o){if(s==="input"||s==="change")return a_(o)}function L6(s,o){return s===o&&(s!==0||1/s===1/o)||s!==s&&o!==o}var is=typeof Object.is=="function"?Object.is:L6;function Cu(s,o){if(is(s,o))return!0;if(typeof s!="object"||s===null||typeof o!="object"||o===null)return!1;var d=Object.keys(s),f=Object.keys(o);if(d.length!==f.length)return!1;for(f=0;f<d.length;f++){var m=d[f];if(!$S.call(o,m)||!is(s[m],o[m]))return!1}return!0}function Lb(s){for(;s&&s.firstChild;)s=s.firstChild;return s}function Mb(s,o){var d=Lb(s);s=0;for(var f;d;){if(d.nodeType===3){if(f=s+d.textContent.length,s<=o&&f>=o)return{node:d,offset:o-s};s=f}e:{for(;d;){if(d.nextSibling){d=d.nextSibling;break e}d=d.parentNode}d=void 0}d=Lb(d)}}function AP(s,o){return s&&o?s===o?!0:s&&s.nodeType===3?!1:o&&o.nodeType===3?AP(s,o.parentNode):"contains"in s?s.contains(o):s.compareDocumentPosition?!!(s.compareDocumentPosition(o)&16):!1:!1}function OP(){for(var s=window,o=Pf();o instanceof s.HTMLIFrameElement;){try{var d=typeof o.contentWindow.location.href=="string"}catch{d=!1}if(d)s=o.contentWindow;else break;o=Pf(s.document)}return o}function fv(s){var o=s&&s.nodeName&&s.nodeName.toLowerCase();return o&&(o==="input"&&(s.type==="text"||s.type==="search"||s.type==="tel"||s.type==="url"||s.type==="password")||o==="textarea"||s.contentEditable==="true")}function M6(s){var o=OP(),d=s.focusedElem,f=s.selectionRange;if(o!==d&&d&&d.ownerDocument&&AP(d.ownerDocument.documentElement,d)){if(f!==null&&fv(d)){if(o=f.start,s=f.end,s===void 0&&(s=o),"selectionStart"in d)d.selectionStart=o,d.selectionEnd=Math.min(s,d.value.length);else if(s=(o=d.ownerDocument||document)&&o.defaultView||window,s.getSelection){s=s.getSelection();var m=d.textContent.length,v=Math.min(f.start,m);f=f.end===void 0?v:Math.min(f.end,m),!s.extend&&v>f&&(m=f,f=v,v=m),m=Mb(d,v);var I=Mb(d,f);m&&I&&(s.rangeCount!==1||s.anchorNode!==m.node||s.anchorOffset!==m.offset||s.focusNode!==I.node||s.focusOffset!==I.offset)&&(o=o.createRange(),o.setStart(m.node,m.offset),s.removeAllRanges(),v>f?(s.addRange(o),s.extend(I.node,I.offset)):(o.setEnd(I.node,I.offset),s.addRange(o)))}}for(o=[],s=d;s=s.parentNode;)s.nodeType===1&&o.push({element:s,left:s.scrollLeft,top:s.scrollTop});for(typeof d.focus=="function"&&d.focus(),d=0;d<o.length;d++)s=o[d],s.element.scrollLeft=s.left,s.element.scrollTop=s.top}}var U6=Js&&"documentMode"in document&&11>=document.documentMode,_l=null,ET=null,uu=null,gT=!1;function Ub(s,o,d){var f=d.window===d?d.document:d.nodeType===9?d:d.ownerDocument;gT||_l==null||_l!==Pf(f)||(f=_l,"selectionStart"in f&&fv(f)?f={start:f.selectionStart,end:f.selectionEnd}:(f=(f.ownerDocument&&f.ownerDocument.defaultView||window).getSelection(),f={anchorNode:f.anchorNode,anchorOffset:f.anchorOffset,focusNode:f.focusNode,focusOffset:f.focusOffset}),uu&&Cu(uu,f)||(uu=f,f=Ff(ET,"onSelect"),0<f.length&&(o=new uv("onSelect","select",null,o,d),s.push({event:o,listeners:f}),o.target=_l)))}function lf(s,o){var d={};return d[s.toLowerCase()]=o.toLowerCase(),d["Webkit"+s]="webkit"+o,d["Moz"+s]="moz"+o,d}var ml={animationend:lf("Animation","AnimationEnd"),animationiteration:lf("Animation","AnimationIteration"),animationstart:lf("Animation","AnimationStart"),transitionend:lf("Transition","TransitionEnd")},kS={},NP={};Js&&(NP=document.createElement("div").style,"AnimationEvent"in window||(delete ml.animationend.animation,delete ml.animationiteration.animation,delete ml.animationstart.animation),"TransitionEvent"in window||delete ml.transitionend.transition);function o_(s){if(kS[s])return kS[s];if(!ml[s])return s;var o=ml[s],d;for(d in o)if(o.hasOwnProperty(d)&&d in NP)return kS[s]=o[d];return s}var bP=o_("animationend"),DP=o_("animationiteration"),PP=o_("animationstart"),kP=o_("transitionend"),LP=new Map,xb="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function $a(s,o){LP.set(s,o),tc(o,[s])}for(var LS=0;LS<xb.length;LS++){var MS=xb[LS],x6=MS.toLowerCase(),V6=MS[0].toUpperCase()+MS.slice(1);$a(x6,"on"+V6)}$a(bP,"onAnimationEnd");$a(DP,"onAnimationIteration");$a(PP,"onAnimationStart");$a("dblclick","onDoubleClick");$a("focusin","onFocus");$a("focusout","onBlur");$a(kP,"onTransitionEnd");bl("onMouseEnter",["mouseout","mouseover"]);bl("onMouseLeave",["mouseout","mouseover"]);bl("onPointerEnter",["pointerout","pointerover"]);bl("onPointerLeave",["pointerout","pointerover"]);tc("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));tc("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));tc("onBeforeInput",["compositionend","keypress","textInput","paste"]);tc("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));tc("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));tc("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var su="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),F6=new Set("cancel close invalid load scroll toggle".split(" ").concat(su));function Vb(s,o,d){var f=s.type||"unknown-event";s.currentTarget=d,xW(f,o,void 0,s),s.currentTarget=null}function MP(s,o){o=(o&4)!==0;for(var d=0;d<s.length;d++){var f=s[d],m=f.event;f=f.listeners;e:{var v=void 0;if(o)for(var I=f.length-1;0<=I;I--){var D=f[I],L=D.instance,V=D.currentTarget;if(D=D.listener,L!==v&&m.isPropagationStopped())break e;Vb(m,D,V),v=L}else for(I=0;I<f.length;I++){if(D=f[I],L=D.instance,V=D.currentTarget,D=D.listener,L!==v&&m.isPropagationStopped())break e;Vb(m,D,V),v=L}}}if(Lf)throw s=pT,Lf=!1,pT=null,s}function ei(s,o){var d=o[CT];d===void 0&&(d=o[CT]=new Set);var f=s+"__bubble";d.has(f)||(UP(o,s,2,!1),d.add(f))}function US(s,o,d){var f=0;o&&(f|=4),UP(d,s,f,o)}var df="_reactListening"+Math.random().toString(36).slice(2);function Ru(s){if(!s[df]){s[df]=!0,WD.forEach(function(d){d!=="selectionchange"&&(F6.has(d)||US(d,!1,s),US(d,!0,s))});var o=s.nodeType===9?s:s.ownerDocument;o===null||o[df]||(o[df]=!0,US("selectionchange",!1,o))}}function UP(s,o,d,f){switch(SP(o)){case 1:var m=ZW;break;case 4:m=e6;break;default:m=lv}d=m.bind(null,o,d,s),m=void 0,!hT||o!=="touchstart"&&o!=="touchmove"&&o!=="wheel"||(m=!0),f?m!==void 0?s.addEventListener(o,d,{capture:!0,passive:m}):s.addEventListener(o,d,!0):m!==void 0?s.addEventListener(o,d,{passive:m}):s.addEventListener(o,d,!1)}function xS(s,o,d,f,m){var v=f;if(!(o&1)&&!(o&2)&&f!==null)e:for(;;){if(f===null)return;var I=f.tag;if(I===3||I===4){var D=f.stateNode.containerInfo;if(D===m||D.nodeType===8&&D.parentNode===m)break;if(I===4)for(I=f.return;I!==null;){var L=I.tag;if((L===3||L===4)&&(L=I.stateNode.containerInfo,L===m||L.nodeType===8&&L.parentNode===m))return;I=I.return}for(;D!==null;){if(I=Ho(D),I===null)return;if(L=I.tag,L===5||L===6){f=v=I;continue e}D=D.parentNode}}f=f.return}sP(function(){var V=v,q=sv(d),H=[];e:{var te=LP.get(s);if(te!==void 0){var de=uv,pe=s;switch(s){case"keypress":if(Rf(d)===0)break e;case"keydown":case"keyup":de=_6;break;case"focusin":pe="focus",de=bS;break;case"focusout":pe="blur",de=bS;break;case"beforeblur":case"afterblur":de=bS;break;case"click":if(d.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":de=wb;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":de=r6;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":de=g6;break;case bP:case DP:case PP:de=a6;break;case kP:de=T6;break;case"scroll":de=t6;break;case"wheel":de=y6;break;case"copy":case"cut":case"paste":de=c6;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":de=Ob}var ee=(o&4)!==0,ae=!ee&&s==="scroll",K=ee?te!==null?te+"Capture":null:te;ee=[];for(var G=V,Q;G!==null;){Q=G;var _e=Q.stateNode;if(Q.tag===5&&_e!==null&&(Q=_e,K!==null&&(_e=gu(G,K),_e!=null&&ee.push(Iu(G,_e,Q)))),ae)break;G=G.return}0<ee.length&&(te=new de(te,pe,null,d,q),H.push({event:te,listeners:ee}))}}if(!(o&7)){e:{if(te=s==="mouseover"||s==="pointerover",de=s==="mouseout"||s==="pointerout",te&&d!==dT&&(pe=d.relatedTarget||d.fromElement)&&(Ho(pe)||pe[Xs]))break e;if((de||te)&&(te=q.window===q?q:(te=q.ownerDocument)?te.defaultView||te.parentWindow:window,de?(pe=d.relatedTarget||d.toElement,de=V,pe=pe?Ho(pe):null,pe!==null&&(ae=ic(pe),pe!==ae||pe.tag!==5&&pe.tag!==6)&&(pe=null)):(de=null,pe=V),de!==pe)){if(ee=wb,_e="onMouseLeave",K="onMouseEnter",G="mouse",(s==="pointerout"||s==="pointerover")&&(ee=Ob,_e="onPointerLeave",K="onPointerEnter",G="pointer"),ae=de==null?te:El(de),Q=pe==null?te:El(pe),te=new ee(_e,G+"leave",de,d,q),te.target=ae,te.relatedTarget=Q,_e=null,Ho(q)===V&&(ee=new ee(K,G+"enter",pe,d,q),ee.target=Q,ee.relatedTarget=ae,_e=ee),ae=_e,de&&pe)t:{for(ee=de,K=pe,G=0,Q=ee;Q;Q=ul(Q))G++;for(Q=0,_e=K;_e;_e=ul(_e))Q++;for(;0<G-Q;)ee=ul(ee),G--;for(;0<Q-G;)K=ul(K),Q--;for(;G--;){if(ee===K||K!==null&&ee===K.alternate)break t;ee=ul(ee),K=ul(K)}ee=null}else ee=null;de!==null&&Fb(H,te,de,ee,!1),pe!==null&&ae!==null&&Fb(H,ae,pe,ee,!0)}}e:{if(te=V?El(V):window,de=te.nodeName&&te.nodeName.toLowerCase(),de==="select"||de==="input"&&te.type==="file")var Re=N6;else if(Db(te))if(IP)Re=k6;else{Re=D6;var Le=b6}else(de=te.nodeName)&&de.toLowerCase()==="input"&&(te.type==="checkbox"||te.type==="radio")&&(Re=P6);if(Re&&(Re=Re(s,V))){RP(H,Re,d,q);break e}Le&&Le(s,te,V),s==="focusout"&&(Le=te._wrapperState)&&Le.controlled&&te.type==="number"&&sT(te,"number",te.value)}switch(Le=V?El(V):window,s){case"focusin":(Db(Le)||Le.contentEditable==="true")&&(_l=Le,ET=V,uu=null);break;case"focusout":uu=ET=_l=null;break;case"mousedown":gT=!0;break;case"contextmenu":case"mouseup":case"dragend":gT=!1,Ub(H,d,q);break;case"selectionchange":if(U6)break;case"keydown":case"keyup":Ub(H,d,q)}var Me;if(pv)e:{switch(s){case"compositionstart":var Fe="onCompositionStart";break e;case"compositionend":Fe="onCompositionEnd";break e;case"compositionupdate":Fe="onCompositionUpdate";break e}Fe=void 0}else fl?yP(s,d)&&(Fe="onCompositionEnd"):s==="keydown"&&d.keyCode===229&&(Fe="onCompositionStart");Fe&&(vP&&d.locale!=="ko"&&(fl||Fe!=="onCompositionStart"?Fe==="onCompositionEnd"&&fl&&(Me=TP()):(Fa=q,dv="value"in Fa?Fa.value:Fa.textContent,fl=!0)),Le=Ff(V,Fe),0<Le.length&&(Fe=new Ab(Fe,s,null,d,q),H.push({event:Fe,listeners:Le}),Me?Fe.data=Me:(Me=CP(d),Me!==null&&(Fe.data=Me)))),(Me=R6?I6(s,d):w6(s,d))&&(V=Ff(V,"onBeforeInput"),0<V.length&&(q=new Ab("onBeforeInput","beforeinput",null,d,q),H.push({event:q,listeners:V}),q.data=Me))}MP(H,o)})}function Iu(s,o,d){return{instance:s,listener:o,currentTarget:d}}function Ff(s,o){for(var d=o+"Capture",f=[];s!==null;){var m=s,v=m.stateNode;m.tag===5&&v!==null&&(m=v,v=gu(s,d),v!=null&&f.unshift(Iu(s,v,m)),v=gu(s,o),v!=null&&f.push(Iu(s,v,m))),s=s.return}return f}function ul(s){if(s===null)return null;do s=s.return;while(s&&s.tag!==5);return s||null}function Fb(s,o,d,f,m){for(var v=o._reactName,I=[];d!==null&&d!==f;){var D=d,L=D.alternate,V=D.stateNode;if(L!==null&&L===f)break;D.tag===5&&V!==null&&(D=V,m?(L=gu(d,v),L!=null&&I.unshift(Iu(d,L,D))):m||(L=gu(d,v),L!=null&&I.push(Iu(d,L,D)))),d=d.return}I.length!==0&&s.push({event:o,listeners:I})}var j6=/\r\n?/g,B6=/\u0000|\uFFFD/g;function jb(s){return(typeof s=="string"?s:""+s).replace(j6,`
`).replace(B6,"")}function uf(s,o,d){if(o=jb(o),jb(s)!==o&&d)throw Error(Te(425))}function jf(){}var ST=null,TT=null;function vT(s,o){return s==="textarea"||s==="noscript"||typeof o.children=="string"||typeof o.children=="number"||typeof o.dangerouslySetInnerHTML=="object"&&o.dangerouslySetInnerHTML!==null&&o.dangerouslySetInnerHTML.__html!=null}var yT=typeof setTimeout=="function"?setTimeout:void 0,G6=typeof clearTimeout=="function"?clearTimeout:void 0,Bb=typeof Promise=="function"?Promise:void 0,W6=typeof queueMicrotask=="function"?queueMicrotask:typeof Bb<"u"?function(s){return Bb.resolve(null).then(s).catch(H6)}:yT;function H6(s){setTimeout(function(){throw s})}function VS(s,o){var d=o,f=0;do{var m=d.nextSibling;if(s.removeChild(d),m&&m.nodeType===8)if(d=m.data,d==="/$"){if(f===0){s.removeChild(m),vu(o);return}f--}else d!=="$"&&d!=="$?"&&d!=="$!"||f++;d=m}while(d);vu(o)}function Ka(s){for(;s!=null;s=s.nextSibling){var o=s.nodeType;if(o===1||o===3)break;if(o===8){if(o=s.data,o==="$"||o==="$!"||o==="$?")break;if(o==="/$")return null}}return s}function Gb(s){s=s.previousSibling;for(var o=0;s;){if(s.nodeType===8){var d=s.data;if(d==="$"||d==="$!"||d==="$?"){if(o===0)return s;o--}else d==="/$"&&o++}s=s.previousSibling}return null}var Fl=Math.random().toString(36).slice(2),ws="__reactFiber$"+Fl,wu="__reactProps$"+Fl,Xs="__reactContainer$"+Fl,CT="__reactEvents$"+Fl,K6="__reactListeners$"+Fl,z6="__reactHandles$"+Fl;function Ho(s){var o=s[ws];if(o)return o;for(var d=s.parentNode;d;){if(o=d[Xs]||d[ws]){if(d=o.alternate,o.child!==null||d!==null&&d.child!==null)for(s=Gb(s);s!==null;){if(d=s[ws])return d;s=Gb(s)}return o}s=d,d=s.parentNode}return null}function Vu(s){return s=s[ws]||s[Xs],!s||s.tag!==5&&s.tag!==6&&s.tag!==13&&s.tag!==3?null:s}function El(s){if(s.tag===5||s.tag===6)return s.stateNode;throw Error(Te(33))}function c_(s){return s[wu]||null}var RT=[],gl=-1;function Za(s){return{current:s}}function ti(s){0>gl||(s.current=RT[gl],RT[gl]=null,gl--)}function qt(s,o){gl++,RT[gl]=s.current,s.current=o}var Qa={},vr=Za(Qa),$r=Za(!1),Xo=Qa;function Dl(s,o){var d=s.type.contextTypes;if(!d)return Qa;var f=s.stateNode;if(f&&f.__reactInternalMemoizedUnmaskedChildContext===o)return f.__reactInternalMemoizedMaskedChildContext;var m={},v;for(v in d)m[v]=o[v];return f&&(s=s.stateNode,s.__reactInternalMemoizedUnmaskedChildContext=o,s.__reactInternalMemoizedMaskedChildContext=m),m}function Zr(s){return s=s.childContextTypes,s!=null}function Bf(){ti($r),ti(vr)}function Wb(s,o,d){if(vr.current!==Qa)throw Error(Te(168));qt(vr,o),qt($r,d)}function xP(s,o,d){var f=s.stateNode;if(o=o.childContextTypes,typeof f.getChildContext!="function")return d;f=f.getChildContext();for(var m in f)if(!(m in o))throw Error(Te(108,bW(s)||"Unknown",m));return mi({},d,f)}function Gf(s){return s=(s=s.stateNode)&&s.__reactInternalMemoizedMergedChildContext||Qa,Xo=vr.current,qt(vr,s),qt($r,$r.current),!0}function Hb(s,o,d){var f=s.stateNode;if(!f)throw Error(Te(169));d?(s=xP(s,o,Xo),f.__reactInternalMemoizedMergedChildContext=s,ti($r),ti(vr),qt(vr,s)):ti($r),qt($r,d)}var Ks=null,l_=!1,FS=!1;function VP(s){Ks===null?Ks=[s]:Ks.push(s)}function Y6(s){l_=!0,VP(s)}function eo(){if(!FS&&Ks!==null){FS=!0;var s=0,o=Lt;try{var d=Ks;for(Lt=1;s<d.length;s++){var f=d[s];do f=f(!0);while(f!==null)}Ks=null,l_=!1}catch(m){throw Ks!==null&&(Ks=Ks.slice(s+1)),lP(av,eo),m}finally{Lt=o,FS=!1}}return null}var Sl=[],Tl=0,Wf=null,Hf=0,Mn=[],Un=0,Qo=null,zs=1,Ys="";function Go(s,o){Sl[Tl++]=Hf,Sl[Tl++]=Wf,Wf=s,Hf=o}function FP(s,o,d){Mn[Un++]=zs,Mn[Un++]=Ys,Mn[Un++]=Qo,Qo=s;var f=zs;s=Ys;var m=32-es(f)-1;f&=~(1<<m),d+=1;var v=32-es(o)+m;if(30<v){var I=m-m%5;v=(f&(1<<I)-1).toString(32),f>>=I,m-=I,zs=1<<32-es(o)+m|d<<m|f,Ys=v+s}else zs=1<<v|d<<m|f,Ys=s}function _v(s){s.return!==null&&(Go(s,1),FP(s,1,0))}function mv(s){for(;s===Wf;)Wf=Sl[--Tl],Sl[Tl]=null,Hf=Sl[--Tl],Sl[Tl]=null;for(;s===Qo;)Qo=Mn[--Un],Mn[Un]=null,Ys=Mn[--Un],Mn[Un]=null,zs=Mn[--Un],Mn[Un]=null}var gn=null,En=null,ui=!1,Zn=null;function jP(s,o){var d=xn(5,null,null,0);d.elementType="DELETED",d.stateNode=o,d.return=s,o=s.deletions,o===null?(s.deletions=[d],s.flags|=16):o.push(d)}function Kb(s,o){switch(s.tag){case 5:var d=s.type;return o=o.nodeType!==1||d.toLowerCase()!==o.nodeName.toLowerCase()?null:o,o!==null?(s.stateNode=o,gn=s,En=Ka(o.firstChild),!0):!1;case 6:return o=s.pendingProps===""||o.nodeType!==3?null:o,o!==null?(s.stateNode=o,gn=s,En=null,!0):!1;case 13:return o=o.nodeType!==8?null:o,o!==null?(d=Qo!==null?{id:zs,overflow:Ys}:null,s.memoizedState={dehydrated:o,treeContext:d,retryLane:1073741824},d=xn(18,null,null,0),d.stateNode=o,d.return=s,s.child=d,gn=s,En=null,!0):!1;default:return!1}}function IT(s){return(s.mode&1)!==0&&(s.flags&128)===0}function wT(s){if(ui){var o=En;if(o){var d=o;if(!Kb(s,o)){if(IT(s))throw Error(Te(418));o=Ka(d.nextSibling);var f=gn;o&&Kb(s,o)?jP(f,d):(s.flags=s.flags&-4097|2,ui=!1,gn=s)}}else{if(IT(s))throw Error(Te(418));s.flags=s.flags&-4097|2,ui=!1,gn=s}}}function zb(s){for(s=s.return;s!==null&&s.tag!==5&&s.tag!==3&&s.tag!==13;)s=s.return;gn=s}function hf(s){if(s!==gn)return!1;if(!ui)return zb(s),ui=!0,!1;var o;if((o=s.tag!==3)&&!(o=s.tag!==5)&&(o=s.type,o=o!=="head"&&o!=="body"&&!vT(s.type,s.memoizedProps)),o&&(o=En)){if(IT(s))throw BP(),Error(Te(418));for(;o;)jP(s,o),o=Ka(o.nextSibling)}if(zb(s),s.tag===13){if(s=s.memoizedState,s=s!==null?s.dehydrated:null,!s)throw Error(Te(317));e:{for(s=s.nextSibling,o=0;s;){if(s.nodeType===8){var d=s.data;if(d==="/$"){if(o===0){En=Ka(s.nextSibling);break e}o--}else d!=="$"&&d!=="$!"&&d!=="$?"||o++}s=s.nextSibling}En=null}}else En=gn?Ka(s.stateNode.nextSibling):null;return!0}function BP(){for(var s=En;s;)s=Ka(s.nextSibling)}function Pl(){En=gn=null,ui=!1}function Ev(s){Zn===null?Zn=[s]:Zn.push(s)}var q6=Zs.ReactCurrentBatchConfig;function Qn(s,o){if(s&&s.defaultProps){o=mi({},o),s=s.defaultProps;for(var d in s)o[d]===void 0&&(o[d]=s[d]);return o}return o}var Kf=Za(null),zf=null,vl=null,gv=null;function Sv(){gv=vl=zf=null}function Tv(s){var o=Kf.current;ti(Kf),s._currentValue=o}function AT(s,o,d){for(;s!==null;){var f=s.alternate;if((s.childLanes&o)!==o?(s.childLanes|=o,f!==null&&(f.childLanes|=o)):f!==null&&(f.childLanes&o)!==o&&(f.childLanes|=o),s===d)break;s=s.return}}function Ol(s,o){zf=s,gv=vl=null,s=s.dependencies,s!==null&&s.firstContext!==null&&(s.lanes&o&&(Qr=!0),s.firstContext=null)}function Fn(s){var o=s._currentValue;if(gv!==s)if(s={context:s,memoizedValue:o,next:null},vl===null){if(zf===null)throw Error(Te(308));vl=s,zf.dependencies={lanes:0,firstContext:s}}else vl=vl.next=s;return o}var Ko=null;function vv(s){Ko===null?Ko=[s]:Ko.push(s)}function GP(s,o,d,f){var m=o.interleaved;return m===null?(d.next=d,vv(o)):(d.next=m.next,m.next=d),o.interleaved=d,Qs(s,f)}function Qs(s,o){s.lanes|=o;var d=s.alternate;for(d!==null&&(d.lanes|=o),d=s,s=s.return;s!==null;)s.childLanes|=o,d=s.alternate,d!==null&&(d.childLanes|=o),d=s,s=s.return;return d.tag===3?d.stateNode:null}var Ua=!1;function yv(s){s.updateQueue={baseState:s.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function WP(s,o){s=s.updateQueue,o.updateQueue===s&&(o.updateQueue={baseState:s.baseState,firstBaseUpdate:s.firstBaseUpdate,lastBaseUpdate:s.lastBaseUpdate,shared:s.shared,effects:s.effects})}function qs(s,o){return{eventTime:s,lane:o,tag:0,payload:null,callback:null,next:null}}function za(s,o,d){var f=s.updateQueue;if(f===null)return null;if(f=f.shared,yt&2){var m=f.pending;return m===null?o.next=o:(o.next=m.next,m.next=o),f.pending=o,Qs(s,d)}return m=f.interleaved,m===null?(o.next=o,vv(f)):(o.next=m.next,m.next=o),f.interleaved=o,Qs(s,d)}function If(s,o,d){if(o=o.updateQueue,o!==null&&(o=o.shared,(d&4194240)!==0)){var f=o.lanes;f&=s.pendingLanes,d|=f,o.lanes=d,ov(s,d)}}function Yb(s,o){var d=s.updateQueue,f=s.alternate;if(f!==null&&(f=f.updateQueue,d===f)){var m=null,v=null;if(d=d.firstBaseUpdate,d!==null){do{var I={eventTime:d.eventTime,lane:d.lane,tag:d.tag,payload:d.payload,callback:d.callback,next:null};v===null?m=v=I:v=v.next=I,d=d.next}while(d!==null);v===null?m=v=o:v=v.next=o}else m=v=o;d={baseState:f.baseState,firstBaseUpdate:m,lastBaseUpdate:v,shared:f.shared,effects:f.effects},s.updateQueue=d;return}s=d.lastBaseUpdate,s===null?d.firstBaseUpdate=o:s.next=o,d.lastBaseUpdate=o}function Yf(s,o,d,f){var m=s.updateQueue;Ua=!1;var v=m.firstBaseUpdate,I=m.lastBaseUpdate,D=m.shared.pending;if(D!==null){m.shared.pending=null;var L=D,V=L.next;L.next=null,I===null?v=V:I.next=V,I=L;var q=s.alternate;q!==null&&(q=q.updateQueue,D=q.lastBaseUpdate,D!==I&&(D===null?q.firstBaseUpdate=V:D.next=V,q.lastBaseUpdate=L))}if(v!==null){var H=m.baseState;I=0,q=V=L=null,D=v;do{var te=D.lane,de=D.eventTime;if((f&te)===te){q!==null&&(q=q.next={eventTime:de,lane:0,tag:D.tag,payload:D.payload,callback:D.callback,next:null});e:{var pe=s,ee=D;switch(te=o,de=d,ee.tag){case 1:if(pe=ee.payload,typeof pe=="function"){H=pe.call(de,H,te);break e}H=pe;break e;case 3:pe.flags=pe.flags&-65537|128;case 0:if(pe=ee.payload,te=typeof pe=="function"?pe.call(de,H,te):pe,te==null)break e;H=mi({},H,te);break e;case 2:Ua=!0}}D.callback!==null&&D.lane!==0&&(s.flags|=64,te=m.effects,te===null?m.effects=[D]:te.push(D))}else de={eventTime:de,lane:te,tag:D.tag,payload:D.payload,callback:D.callback,next:null},q===null?(V=q=de,L=H):q=q.next=de,I|=te;if(D=D.next,D===null){if(D=m.shared.pending,D===null)break;te=D,D=te.next,te.next=null,m.lastBaseUpdate=te,m.shared.pending=null}}while(!0);if(q===null&&(L=H),m.baseState=L,m.firstBaseUpdate=V,m.lastBaseUpdate=q,o=m.shared.interleaved,o!==null){m=o;do I|=m.lane,m=m.next;while(m!==o)}else v===null&&(m.shared.lanes=0);Zo|=I,s.lanes=I,s.memoizedState=H}}function qb(s,o,d){if(s=o.effects,o.effects=null,s!==null)for(o=0;o<s.length;o++){var f=s[o],m=f.callback;if(m!==null){if(f.callback=null,f=d,typeof m!="function")throw Error(Te(191,m));m.call(f)}}}var HP=new GD.Component().refs;function OT(s,o,d,f){o=s.memoizedState,d=d(f,o),d=d==null?o:mi({},o,d),s.memoizedState=d,s.lanes===0&&(s.updateQueue.baseState=d)}var d_={isMounted:function(s){return(s=s._reactInternals)?ic(s)===s:!1},enqueueSetState:function(s,o,d){s=s._reactInternals;var f=Nr(),m=qa(s),v=qs(f,m);v.payload=o,d!=null&&(v.callback=d),o=za(s,v,m),o!==null&&(ts(o,s,m,f),If(o,s,m))},enqueueReplaceState:function(s,o,d){s=s._reactInternals;var f=Nr(),m=qa(s),v=qs(f,m);v.tag=1,v.payload=o,d!=null&&(v.callback=d),o=za(s,v,m),o!==null&&(ts(o,s,m,f),If(o,s,m))},enqueueForceUpdate:function(s,o){s=s._reactInternals;var d=Nr(),f=qa(s),m=qs(d,f);m.tag=2,o!=null&&(m.callback=o),o=za(s,m,f),o!==null&&(ts(o,s,f,d),If(o,s,f))}};function Jb(s,o,d,f,m,v,I){return s=s.stateNode,typeof s.shouldComponentUpdate=="function"?s.shouldComponentUpdate(f,v,I):o.prototype&&o.prototype.isPureReactComponent?!Cu(d,f)||!Cu(m,v):!0}function KP(s,o,d){var f=!1,m=Qa,v=o.contextType;return typeof v=="object"&&v!==null?v=Fn(v):(m=Zr(o)?Xo:vr.current,f=o.contextTypes,v=(f=f!=null)?Dl(s,m):Qa),o=new o(d,v),s.memoizedState=o.state!==null&&o.state!==void 0?o.state:null,o.updater=d_,s.stateNode=o,o._reactInternals=s,f&&(s=s.stateNode,s.__reactInternalMemoizedUnmaskedChildContext=m,s.__reactInternalMemoizedMaskedChildContext=v),o}function Xb(s,o,d,f){s=o.state,typeof o.componentWillReceiveProps=="function"&&o.componentWillReceiveProps(d,f),typeof o.UNSAFE_componentWillReceiveProps=="function"&&o.UNSAFE_componentWillReceiveProps(d,f),o.state!==s&&d_.enqueueReplaceState(o,o.state,null)}function NT(s,o,d,f){var m=s.stateNode;m.props=d,m.state=s.memoizedState,m.refs=HP,yv(s);var v=o.contextType;typeof v=="object"&&v!==null?m.context=Fn(v):(v=Zr(o)?Xo:vr.current,m.context=Dl(s,v)),m.state=s.memoizedState,v=o.getDerivedStateFromProps,typeof v=="function"&&(OT(s,o,v,d),m.state=s.memoizedState),typeof o.getDerivedStateFromProps=="function"||typeof m.getSnapshotBeforeUpdate=="function"||typeof m.UNSAFE_componentWillMount!="function"&&typeof m.componentWillMount!="function"||(o=m.state,typeof m.componentWillMount=="function"&&m.componentWillMount(),typeof m.UNSAFE_componentWillMount=="function"&&m.UNSAFE_componentWillMount(),o!==m.state&&d_.enqueueReplaceState(m,m.state,null),Yf(s,d,m,f),m.state=s.memoizedState),typeof m.componentDidMount=="function"&&(s.flags|=4194308)}function Zd(s,o,d){if(s=d.ref,s!==null&&typeof s!="function"&&typeof s!="object"){if(d._owner){if(d=d._owner,d){if(d.tag!==1)throw Error(Te(309));var f=d.stateNode}if(!f)throw Error(Te(147,s));var m=f,v=""+s;return o!==null&&o.ref!==null&&typeof o.ref=="function"&&o.ref._stringRef===v?o.ref:(o=function(I){var D=m.refs;D===HP&&(D=m.refs={}),I===null?delete D[v]:D[v]=I},o._stringRef=v,o)}if(typeof s!="string")throw Error(Te(284));if(!d._owner)throw Error(Te(290,s))}return s}function pf(s,o){throw s=Object.prototype.toString.call(o),Error(Te(31,s==="[object Object]"?"object with keys {"+Object.keys(o).join(", ")+"}":s))}function Qb(s){var o=s._init;return o(s._payload)}function zP(s){function o(K,G){if(s){var Q=K.deletions;Q===null?(K.deletions=[G],K.flags|=16):Q.push(G)}}function d(K,G){if(!s)return null;for(;G!==null;)o(K,G),G=G.sibling;return null}function f(K,G){for(K=new Map;G!==null;)G.key!==null?K.set(G.key,G):K.set(G.index,G),G=G.sibling;return K}function m(K,G){return K=Ja(K,G),K.index=0,K.sibling=null,K}function v(K,G,Q){return K.index=Q,s?(Q=K.alternate,Q!==null?(Q=Q.index,Q<G?(K.flags|=2,G):Q):(K.flags|=2,G)):(K.flags|=1048576,G)}function I(K){return s&&K.alternate===null&&(K.flags|=2),K}function D(K,G,Q,_e){return G===null||G.tag!==6?(G=zS(Q,K.mode,_e),G.return=K,G):(G=m(G,Q),G.return=K,G)}function L(K,G,Q,_e){var Re=Q.type;return Re===pl?q(K,G,Q.props.children,_e,Q.key):G!==null&&(G.elementType===Re||typeof Re=="object"&&Re!==null&&Re.$$typeof===Ma&&Qb(Re)===G.type)?(_e=m(G,Q.props),_e.ref=Zd(K,G,Q),_e.return=K,_e):(_e=Df(Q.type,Q.key,Q.props,null,K.mode,_e),_e.ref=Zd(K,G,Q),_e.return=K,_e)}function V(K,G,Q,_e){return G===null||G.tag!==4||G.stateNode.containerInfo!==Q.containerInfo||G.stateNode.implementation!==Q.implementation?(G=YS(Q,K.mode,_e),G.return=K,G):(G=m(G,Q.children||[]),G.return=K,G)}function q(K,G,Q,_e,Re){return G===null||G.tag!==7?(G=qo(Q,K.mode,_e,Re),G.return=K,G):(G=m(G,Q),G.return=K,G)}function H(K,G,Q){if(typeof G=="string"&&G!==""||typeof G=="number")return G=zS(""+G,K.mode,Q),G.return=K,G;if(typeof G=="object"&&G!==null){switch(G.$$typeof){case tf:return Q=Df(G.type,G.key,G.props,null,K.mode,Q),Q.ref=Zd(K,null,G),Q.return=K,Q;case hl:return G=YS(G,K.mode,Q),G.return=K,G;case Ma:var _e=G._init;return H(K,_e(G._payload),Q)}if(ru(G)||qd(G))return G=qo(G,K.mode,Q,null),G.return=K,G;pf(K,G)}return null}function te(K,G,Q,_e){var Re=G!==null?G.key:null;if(typeof Q=="string"&&Q!==""||typeof Q=="number")return Re!==null?null:D(K,G,""+Q,_e);if(typeof Q=="object"&&Q!==null){switch(Q.$$typeof){case tf:return Q.key===Re?L(K,G,Q,_e):null;case hl:return Q.key===Re?V(K,G,Q,_e):null;case Ma:return Re=Q._init,te(K,G,Re(Q._payload),_e)}if(ru(Q)||qd(Q))return Re!==null?null:q(K,G,Q,_e,null);pf(K,Q)}return null}function de(K,G,Q,_e,Re){if(typeof _e=="string"&&_e!==""||typeof _e=="number")return K=K.get(Q)||null,D(G,K,""+_e,Re);if(typeof _e=="object"&&_e!==null){switch(_e.$$typeof){case tf:return K=K.get(_e.key===null?Q:_e.key)||null,L(G,K,_e,Re);case hl:return K=K.get(_e.key===null?Q:_e.key)||null,V(G,K,_e,Re);case Ma:var Le=_e._init;return de(K,G,Q,Le(_e._payload),Re)}if(ru(_e)||qd(_e))return K=K.get(Q)||null,q(G,K,_e,Re,null);pf(G,_e)}return null}function pe(K,G,Q,_e){for(var Re=null,Le=null,Me=G,Fe=G=0,ii=null;Me!==null&&Fe<Q.length;Fe++){Me.index>Fe?(ii=Me,Me=null):ii=Me.sibling;var dt=te(K,Me,Q[Fe],_e);if(dt===null){Me===null&&(Me=ii);break}s&&Me&&dt.alternate===null&&o(K,Me),G=v(dt,G,Fe),Le===null?Re=dt:Le.sibling=dt,Le=dt,Me=ii}if(Fe===Q.length)return d(K,Me),ui&&Go(K,Fe),Re;if(Me===null){for(;Fe<Q.length;Fe++)Me=H(K,Q[Fe],_e),Me!==null&&(G=v(Me,G,Fe),Le===null?Re=Me:Le.sibling=Me,Le=Me);return ui&&Go(K,Fe),Re}for(Me=f(K,Me);Fe<Q.length;Fe++)ii=de(Me,K,Fe,Q[Fe],_e),ii!==null&&(s&&ii.alternate!==null&&Me.delete(ii.key===null?Fe:ii.key),G=v(ii,G,Fe),Le===null?Re=ii:Le.sibling=ii,Le=ii);return s&&Me.forEach(function(kr){return o(K,kr)}),ui&&Go(K,Fe),Re}function ee(K,G,Q,_e){var Re=qd(Q);if(typeof Re!="function")throw Error(Te(150));if(Q=Re.call(Q),Q==null)throw Error(Te(151));for(var Le=Re=null,Me=G,Fe=G=0,ii=null,dt=Q.next();Me!==null&&!dt.done;Fe++,dt=Q.next()){Me.index>Fe?(ii=Me,Me=null):ii=Me.sibling;var kr=te(K,Me,dt.value,_e);if(kr===null){Me===null&&(Me=ii);break}s&&Me&&kr.alternate===null&&o(K,Me),G=v(kr,G,Fe),Le===null?Re=kr:Le.sibling=kr,Le=kr,Me=ii}if(dt.done)return d(K,Me),ui&&Go(K,Fe),Re;if(Me===null){for(;!dt.done;Fe++,dt=Q.next())dt=H(K,dt.value,_e),dt!==null&&(G=v(dt,G,Fe),Le===null?Re=dt:Le.sibling=dt,Le=dt);return ui&&Go(K,Fe),Re}for(Me=f(K,Me);!dt.done;Fe++,dt=Q.next())dt=de(Me,K,Fe,dt.value,_e),dt!==null&&(s&&dt.alternate!==null&&Me.delete(dt.key===null?Fe:dt.key),G=v(dt,G,Fe),Le===null?Re=dt:Le.sibling=dt,Le=dt);return s&&Me.forEach(function(ta){return o(K,ta)}),ui&&Go(K,Fe),Re}function ae(K,G,Q,_e){if(typeof Q=="object"&&Q!==null&&Q.type===pl&&Q.key===null&&(Q=Q.props.children),typeof Q=="object"&&Q!==null){switch(Q.$$typeof){case tf:e:{for(var Re=Q.key,Le=G;Le!==null;){if(Le.key===Re){if(Re=Q.type,Re===pl){if(Le.tag===7){d(K,Le.sibling),G=m(Le,Q.props.children),G.return=K,K=G;break e}}else if(Le.elementType===Re||typeof Re=="object"&&Re!==null&&Re.$$typeof===Ma&&Qb(Re)===Le.type){d(K,Le.sibling),G=m(Le,Q.props),G.ref=Zd(K,Le,Q),G.return=K,K=G;break e}d(K,Le);break}else o(K,Le);Le=Le.sibling}Q.type===pl?(G=qo(Q.props.children,K.mode,_e,Q.key),G.return=K,K=G):(_e=Df(Q.type,Q.key,Q.props,null,K.mode,_e),_e.ref=Zd(K,G,Q),_e.return=K,K=_e)}return I(K);case hl:e:{for(Le=Q.key;G!==null;){if(G.key===Le)if(G.tag===4&&G.stateNode.containerInfo===Q.containerInfo&&G.stateNode.implementation===Q.implementation){d(K,G.sibling),G=m(G,Q.children||[]),G.return=K,K=G;break e}else{d(K,G);break}else o(K,G);G=G.sibling}G=YS(Q,K.mode,_e),G.return=K,K=G}return I(K);case Ma:return Le=Q._init,ae(K,G,Le(Q._payload),_e)}if(ru(Q))return pe(K,G,Q,_e);if(qd(Q))return ee(K,G,Q,_e);pf(K,Q)}return typeof Q=="string"&&Q!==""||typeof Q=="number"?(Q=""+Q,G!==null&&G.tag===6?(d(K,G.sibling),G=m(G,Q),G.return=K,K=G):(d(K,G),G=zS(Q,K.mode,_e),G.return=K,K=G),I(K)):d(K,G)}return ae}var kl=zP(!0),YP=zP(!1),Fu={},Os=Za(Fu),Au=Za(Fu),Ou=Za(Fu);function zo(s){if(s===Fu)throw Error(Te(174));return s}function Cv(s,o){switch(qt(Ou,o),qt(Au,s),qt(Os,Fu),s=o.nodeType,s){case 9:case 11:o=(o=o.documentElement)?o.namespaceURI:oT(null,"");break;default:s=s===8?o.parentNode:o,o=s.namespaceURI||null,s=s.tagName,o=oT(o,s)}ti(Os),qt(Os,o)}function Ll(){ti(Os),ti(Au),ti(Ou)}function qP(s){zo(Ou.current);var o=zo(Os.current),d=oT(o,s.type);o!==d&&(qt(Au,s),qt(Os,d))}function Rv(s){Au.current===s&&(ti(Os),ti(Au))}var fi=Za(0);function qf(s){for(var o=s;o!==null;){if(o.tag===13){var d=o.memoizedState;if(d!==null&&(d=d.dehydrated,d===null||d.data==="$?"||d.data==="$!"))return o}else if(o.tag===19&&o.memoizedProps.revealOrder!==void 0){if(o.flags&128)return o}else if(o.child!==null){o.child.return=o,o=o.child;continue}if(o===s)break;for(;o.sibling===null;){if(o.return===null||o.return===s)return null;o=o.return}o.sibling.return=o.return,o=o.sibling}return null}var jS=[];function Iv(){for(var s=0;s<jS.length;s++)jS[s]._workInProgressVersionPrimary=null;jS.length=0}var wf=Zs.ReactCurrentDispatcher,BS=Zs.ReactCurrentBatchConfig,$o=0,_i=null,Bi=null,Qi=null,Jf=!1,hu=!1,Nu=0,J6=0;function Er(){throw Error(Te(321))}function wv(s,o){if(o===null)return!1;for(var d=0;d<o.length&&d<s.length;d++)if(!is(s[d],o[d]))return!1;return!0}function Av(s,o,d,f,m,v){if($o=v,_i=o,o.memoizedState=null,o.updateQueue=null,o.lanes=0,wf.current=s===null||s.memoizedState===null?Z6:e8,s=d(f,m),hu){v=0;do{if(hu=!1,Nu=0,25<=v)throw Error(Te(301));v+=1,Qi=Bi=null,o.updateQueue=null,wf.current=t8,s=d(f,m)}while(hu)}if(wf.current=Xf,o=Bi!==null&&Bi.next!==null,$o=0,Qi=Bi=_i=null,Jf=!1,o)throw Error(Te(300));return s}function Ov(){var s=Nu!==0;return Nu=0,s}function Is(){var s={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Qi===null?_i.memoizedState=Qi=s:Qi=Qi.next=s,Qi}function jn(){if(Bi===null){var s=_i.alternate;s=s!==null?s.memoizedState:null}else s=Bi.next;var o=Qi===null?_i.memoizedState:Qi.next;if(o!==null)Qi=o,Bi=s;else{if(s===null)throw Error(Te(310));Bi=s,s={memoizedState:Bi.memoizedState,baseState:Bi.baseState,baseQueue:Bi.baseQueue,queue:Bi.queue,next:null},Qi===null?_i.memoizedState=Qi=s:Qi=Qi.next=s}return Qi}function bu(s,o){return typeof o=="function"?o(s):o}function GS(s){var o=jn(),d=o.queue;if(d===null)throw Error(Te(311));d.lastRenderedReducer=s;var f=Bi,m=f.baseQueue,v=d.pending;if(v!==null){if(m!==null){var I=m.next;m.next=v.next,v.next=I}f.baseQueue=m=v,d.pending=null}if(m!==null){v=m.next,f=f.baseState;var D=I=null,L=null,V=v;do{var q=V.lane;if(($o&q)===q)L!==null&&(L=L.next={lane:0,action:V.action,hasEagerState:V.hasEagerState,eagerState:V.eagerState,next:null}),f=V.hasEagerState?V.eagerState:s(f,V.action);else{var H={lane:q,action:V.action,hasEagerState:V.hasEagerState,eagerState:V.eagerState,next:null};L===null?(D=L=H,I=f):L=L.next=H,_i.lanes|=q,Zo|=q}V=V.next}while(V!==null&&V!==v);L===null?I=f:L.next=D,is(f,o.memoizedState)||(Qr=!0),o.memoizedState=f,o.baseState=I,o.baseQueue=L,d.lastRenderedState=f}if(s=d.interleaved,s!==null){m=s;do v=m.lane,_i.lanes|=v,Zo|=v,m=m.next;while(m!==s)}else m===null&&(d.lanes=0);return[o.memoizedState,d.dispatch]}function WS(s){var o=jn(),d=o.queue;if(d===null)throw Error(Te(311));d.lastRenderedReducer=s;var f=d.dispatch,m=d.pending,v=o.memoizedState;if(m!==null){d.pending=null;var I=m=m.next;do v=s(v,I.action),I=I.next;while(I!==m);is(v,o.memoizedState)||(Qr=!0),o.memoizedState=v,o.baseQueue===null&&(o.baseState=v),d.lastRenderedState=v}return[v,f]}function JP(){}function XP(s,o){var d=_i,f=jn(),m=o(),v=!is(f.memoizedState,m);if(v&&(f.memoizedState=m,Qr=!0),f=f.queue,Nv(ZP.bind(null,d,f,s),[s]),f.getSnapshot!==o||v||Qi!==null&&Qi.memoizedState.tag&1){if(d.flags|=2048,Du(9,$P.bind(null,d,f,m,o),void 0,null),$i===null)throw Error(Te(349));$o&30||QP(d,o,m)}return m}function QP(s,o,d){s.flags|=16384,s={getSnapshot:o,value:d},o=_i.updateQueue,o===null?(o={lastEffect:null,stores:null},_i.updateQueue=o,o.stores=[s]):(d=o.stores,d===null?o.stores=[s]:d.push(s))}function $P(s,o,d,f){o.value=d,o.getSnapshot=f,ek(o)&&tk(s)}function ZP(s,o,d){return d(function(){ek(o)&&tk(s)})}function ek(s){var o=s.getSnapshot;s=s.value;try{var d=o();return!is(s,d)}catch{return!0}}function tk(s){var o=Qs(s,1);o!==null&&ts(o,s,1,-1)}function $b(s){var o=Is();return typeof s=="function"&&(s=s()),o.memoizedState=o.baseState=s,s={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:bu,lastRenderedState:s},o.queue=s,s=s.dispatch=$6.bind(null,_i,s),[o.memoizedState,s]}function Du(s,o,d,f){return s={tag:s,create:o,destroy:d,deps:f,next:null},o=_i.updateQueue,o===null?(o={lastEffect:null,stores:null},_i.updateQueue=o,o.lastEffect=s.next=s):(d=o.lastEffect,d===null?o.lastEffect=s.next=s:(f=d.next,d.next=s,s.next=f,o.lastEffect=s)),s}function ik(){return jn().memoizedState}function Af(s,o,d,f){var m=Is();_i.flags|=s,m.memoizedState=Du(1|o,d,void 0,f===void 0?null:f)}function u_(s,o,d,f){var m=jn();f=f===void 0?null:f;var v=void 0;if(Bi!==null){var I=Bi.memoizedState;if(v=I.destroy,f!==null&&wv(f,I.deps)){m.memoizedState=Du(o,d,v,f);return}}_i.flags|=s,m.memoizedState=Du(1|o,d,v,f)}function Zb(s,o){return Af(8390656,8,s,o)}function Nv(s,o){return u_(2048,8,s,o)}function rk(s,o){return u_(4,2,s,o)}function nk(s,o){return u_(4,4,s,o)}function sk(s,o){if(typeof o=="function")return s=s(),o(s),function(){o(null)};if(o!=null)return s=s(),o.current=s,function(){o.current=null}}function ak(s,o,d){return d=d!=null?d.concat([s]):null,u_(4,4,sk.bind(null,o,s),d)}function bv(){}function ok(s,o){var d=jn();o=o===void 0?null:o;var f=d.memoizedState;return f!==null&&o!==null&&wv(o,f[1])?f[0]:(d.memoizedState=[s,o],s)}function ck(s,o){var d=jn();o=o===void 0?null:o;var f=d.memoizedState;return f!==null&&o!==null&&wv(o,f[1])?f[0]:(s=s(),d.memoizedState=[s,o],s)}function lk(s,o,d){return $o&21?(is(d,o)||(d=hP(),_i.lanes|=d,Zo|=d,s.baseState=!0),o):(s.baseState&&(s.baseState=!1,Qr=!0),s.memoizedState=d)}function X6(s,o){var d=Lt;Lt=d!==0&&4>d?d:4,s(!0);var f=BS.transition;BS.transition={};try{s(!1),o()}finally{Lt=d,BS.transition=f}}function dk(){return jn().memoizedState}function Q6(s,o,d){var f=qa(s);if(d={lane:f,action:d,hasEagerState:!1,eagerState:null,next:null},uk(s))hk(o,d);else if(d=GP(s,o,d,f),d!==null){var m=Nr();ts(d,s,f,m),pk(d,o,f)}}function $6(s,o,d){var f=qa(s),m={lane:f,action:d,hasEagerState:!1,eagerState:null,next:null};if(uk(s))hk(o,m);else{var v=s.alternate;if(s.lanes===0&&(v===null||v.lanes===0)&&(v=o.lastRenderedReducer,v!==null))try{var I=o.lastRenderedState,D=v(I,d);if(m.hasEagerState=!0,m.eagerState=D,is(D,I)){var L=o.interleaved;L===null?(m.next=m,vv(o)):(m.next=L.next,L.next=m),o.interleaved=m;return}}catch{}finally{}d=GP(s,o,m,f),d!==null&&(m=Nr(),ts(d,s,f,m),pk(d,o,f))}}function uk(s){var o=s.alternate;return s===_i||o!==null&&o===_i}function hk(s,o){hu=Jf=!0;var d=s.pending;d===null?o.next=o:(o.next=d.next,d.next=o),s.pending=o}function pk(s,o,d){if(d&4194240){var f=o.lanes;f&=s.pendingLanes,d|=f,o.lanes=d,ov(s,d)}}var Xf={readContext:Fn,useCallback:Er,useContext:Er,useEffect:Er,useImperativeHandle:Er,useInsertionEffect:Er,useLayoutEffect:Er,useMemo:Er,useReducer:Er,useRef:Er,useState:Er,useDebugValue:Er,useDeferredValue:Er,useTransition:Er,useMutableSource:Er,useSyncExternalStore:Er,useId:Er,unstable_isNewReconciler:!1},Z6={readContext:Fn,useCallback:function(s,o){return Is().memoizedState=[s,o===void 0?null:o],s},useContext:Fn,useEffect:Zb,useImperativeHandle:function(s,o,d){return d=d!=null?d.concat([s]):null,Af(4194308,4,sk.bind(null,o,s),d)},useLayoutEffect:function(s,o){return Af(4194308,4,s,o)},useInsertionEffect:function(s,o){return Af(4,2,s,o)},useMemo:function(s,o){var d=Is();return o=o===void 0?null:o,s=s(),d.memoizedState=[s,o],s},useReducer:function(s,o,d){var f=Is();return o=d!==void 0?d(o):o,f.memoizedState=f.baseState=o,s={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:s,lastRenderedState:o},f.queue=s,s=s.dispatch=Q6.bind(null,_i,s),[f.memoizedState,s]},useRef:function(s){var o=Is();return s={current:s},o.memoizedState=s},useState:$b,useDebugValue:bv,useDeferredValue:function(s){return Is().memoizedState=s},useTransition:function(){var s=$b(!1),o=s[0];return s=X6.bind(null,s[1]),Is().memoizedState=s,[o,s]},useMutableSource:function(){},useSyncExternalStore:function(s,o,d){var f=_i,m=Is();if(ui){if(d===void 0)throw Error(Te(407));d=d()}else{if(d=o(),$i===null)throw Error(Te(349));$o&30||QP(f,o,d)}m.memoizedState=d;var v={value:d,getSnapshot:o};return m.queue=v,Zb(ZP.bind(null,f,v,s),[s]),f.flags|=2048,Du(9,$P.bind(null,f,v,d,o),void 0,null),d},useId:function(){var s=Is(),o=$i.identifierPrefix;if(ui){var d=Ys,f=zs;d=(f&~(1<<32-es(f)-1)).toString(32)+d,o=":"+o+"R"+d,d=Nu++,0<d&&(o+="H"+d.toString(32)),o+=":"}else d=J6++,o=":"+o+"r"+d.toString(32)+":";return s.memoizedState=o},unstable_isNewReconciler:!1},e8={readContext:Fn,useCallback:ok,useContext:Fn,useEffect:Nv,useImperativeHandle:ak,useInsertionEffect:rk,useLayoutEffect:nk,useMemo:ck,useReducer:GS,useRef:ik,useState:function(){return GS(bu)},useDebugValue:bv,useDeferredValue:function(s){var o=jn();return lk(o,Bi.memoizedState,s)},useTransition:function(){var s=GS(bu)[0],o=jn().memoizedState;return[s,o]},useMutableSource:JP,useSyncExternalStore:XP,useId:dk,unstable_isNewReconciler:!1},t8={readContext:Fn,useCallback:ok,useContext:Fn,useEffect:Nv,useImperativeHandle:ak,useInsertionEffect:rk,useLayoutEffect:nk,useMemo:ck,useReducer:WS,useRef:ik,useState:function(){return WS(bu)},useDebugValue:bv,useDeferredValue:function(s){var o=jn();return Bi===null?o.memoizedState=s:lk(o,Bi.memoizedState,s)},useTransition:function(){var s=WS(bu)[0],o=jn().memoizedState;return[s,o]},useMutableSource:JP,useSyncExternalStore:XP,useId:dk,unstable_isNewReconciler:!1};function Ml(s,o){try{var d="",f=o;do d+=NW(f),f=f.return;while(f);var m=d}catch(v){m=`
Error generating stack: `+v.message+`
`+v.stack}return{value:s,source:o,stack:m,digest:null}}function HS(s,o,d){return{value:s,source:null,stack:d??null,digest:o??null}}function bT(s,o){try{console.error(o.value)}catch(d){setTimeout(function(){throw d})}}var i8=typeof WeakMap=="function"?WeakMap:Map;function fk(s,o,d){d=qs(-1,d),d.tag=3,d.payload={element:null};var f=o.value;return d.callback=function(){$f||($f=!0,jT=f),bT(s,o)},d}function _k(s,o,d){d=qs(-1,d),d.tag=3;var f=s.type.getDerivedStateFromError;if(typeof f=="function"){var m=o.value;d.payload=function(){return f(m)},d.callback=function(){bT(s,o)}}var v=s.stateNode;return v!==null&&typeof v.componentDidCatch=="function"&&(d.callback=function(){bT(s,o),typeof f!="function"&&(Ya===null?Ya=new Set([this]):Ya.add(this));var I=o.stack;this.componentDidCatch(o.value,{componentStack:I!==null?I:""})}),d}function eD(s,o,d){var f=s.pingCache;if(f===null){f=s.pingCache=new i8;var m=new Set;f.set(o,m)}else m=f.get(o),m===void 0&&(m=new Set,f.set(o,m));m.has(d)||(m.add(d),s=m8.bind(null,s,o,d),o.then(s,s))}function tD(s){do{var o;if((o=s.tag===13)&&(o=s.memoizedState,o=o!==null?o.dehydrated!==null:!0),o)return s;s=s.return}while(s!==null);return null}function iD(s,o,d,f,m){return s.mode&1?(s.flags|=65536,s.lanes=m,s):(s===o?s.flags|=65536:(s.flags|=128,d.flags|=131072,d.flags&=-52805,d.tag===1&&(d.alternate===null?d.tag=17:(o=qs(-1,1),o.tag=2,za(d,o,1))),d.lanes|=1),s)}var r8=Zs.ReactCurrentOwner,Qr=!1;function Or(s,o,d,f){o.child=s===null?YP(o,null,d,f):kl(o,s.child,d,f)}function rD(s,o,d,f,m){d=d.render;var v=o.ref;return Ol(o,m),f=Av(s,o,d,f,v,m),d=Ov(),s!==null&&!Qr?(o.updateQueue=s.updateQueue,o.flags&=-2053,s.lanes&=~m,$s(s,o,m)):(ui&&d&&_v(o),o.flags|=1,Or(s,o,f,m),o.child)}function nD(s,o,d,f,m){if(s===null){var v=d.type;return typeof v=="function"&&!Vv(v)&&v.defaultProps===void 0&&d.compare===null&&d.defaultProps===void 0?(o.tag=15,o.type=v,mk(s,o,v,f,m)):(s=Df(d.type,null,f,o,o.mode,m),s.ref=o.ref,s.return=o,o.child=s)}if(v=s.child,!(s.lanes&m)){var I=v.memoizedProps;if(d=d.compare,d=d!==null?d:Cu,d(I,f)&&s.ref===o.ref)return $s(s,o,m)}return o.flags|=1,s=Ja(v,f),s.ref=o.ref,s.return=o,o.child=s}function mk(s,o,d,f,m){if(s!==null){var v=s.memoizedProps;if(Cu(v,f)&&s.ref===o.ref)if(Qr=!1,o.pendingProps=f=v,(s.lanes&m)!==0)s.flags&131072&&(Qr=!0);else return o.lanes=s.lanes,$s(s,o,m)}return DT(s,o,d,f,m)}function Ek(s,o,d){var f=o.pendingProps,m=f.children,v=s!==null?s.memoizedState:null;if(f.mode==="hidden")if(!(o.mode&1))o.memoizedState={baseLanes:0,cachePool:null,transitions:null},qt(Cl,mn),mn|=d;else{if(!(d&1073741824))return s=v!==null?v.baseLanes|d:d,o.lanes=o.childLanes=1073741824,o.memoizedState={baseLanes:s,cachePool:null,transitions:null},o.updateQueue=null,qt(Cl,mn),mn|=s,null;o.memoizedState={baseLanes:0,cachePool:null,transitions:null},f=v!==null?v.baseLanes:d,qt(Cl,mn),mn|=f}else v!==null?(f=v.baseLanes|d,o.memoizedState=null):f=d,qt(Cl,mn),mn|=f;return Or(s,o,m,d),o.child}function gk(s,o){var d=o.ref;(s===null&&d!==null||s!==null&&s.ref!==d)&&(o.flags|=512,o.flags|=2097152)}function DT(s,o,d,f,m){var v=Zr(d)?Xo:vr.current;return v=Dl(o,v),Ol(o,m),d=Av(s,o,d,f,v,m),f=Ov(),s!==null&&!Qr?(o.updateQueue=s.updateQueue,o.flags&=-2053,s.lanes&=~m,$s(s,o,m)):(ui&&f&&_v(o),o.flags|=1,Or(s,o,d,m),o.child)}function sD(s,o,d,f,m){if(Zr(d)){var v=!0;Gf(o)}else v=!1;if(Ol(o,m),o.stateNode===null)Of(s,o),KP(o,d,f),NT(o,d,f,m),f=!0;else if(s===null){var I=o.stateNode,D=o.memoizedProps;I.props=D;var L=I.context,V=d.contextType;typeof V=="object"&&V!==null?V=Fn(V):(V=Zr(d)?Xo:vr.current,V=Dl(o,V));var q=d.getDerivedStateFromProps,H=typeof q=="function"||typeof I.getSnapshotBeforeUpdate=="function";H||typeof I.UNSAFE_componentWillReceiveProps!="function"&&typeof I.componentWillReceiveProps!="function"||(D!==f||L!==V)&&Xb(o,I,f,V),Ua=!1;var te=o.memoizedState;I.state=te,Yf(o,f,I,m),L=o.memoizedState,D!==f||te!==L||$r.current||Ua?(typeof q=="function"&&(OT(o,d,q,f),L=o.memoizedState),(D=Ua||Jb(o,d,D,f,te,L,V))?(H||typeof I.UNSAFE_componentWillMount!="function"&&typeof I.componentWillMount!="function"||(typeof I.componentWillMount=="function"&&I.componentWillMount(),typeof I.UNSAFE_componentWillMount=="function"&&I.UNSAFE_componentWillMount()),typeof I.componentDidMount=="function"&&(o.flags|=4194308)):(typeof I.componentDidMount=="function"&&(o.flags|=4194308),o.memoizedProps=f,o.memoizedState=L),I.props=f,I.state=L,I.context=V,f=D):(typeof I.componentDidMount=="function"&&(o.flags|=4194308),f=!1)}else{I=o.stateNode,WP(s,o),D=o.memoizedProps,V=o.type===o.elementType?D:Qn(o.type,D),I.props=V,H=o.pendingProps,te=I.context,L=d.contextType,typeof L=="object"&&L!==null?L=Fn(L):(L=Zr(d)?Xo:vr.current,L=Dl(o,L));var de=d.getDerivedStateFromProps;(q=typeof de=="function"||typeof I.getSnapshotBeforeUpdate=="function")||typeof I.UNSAFE_componentWillReceiveProps!="function"&&typeof I.componentWillReceiveProps!="function"||(D!==H||te!==L)&&Xb(o,I,f,L),Ua=!1,te=o.memoizedState,I.state=te,Yf(o,f,I,m);var pe=o.memoizedState;D!==H||te!==pe||$r.current||Ua?(typeof de=="function"&&(OT(o,d,de,f),pe=o.memoizedState),(V=Ua||Jb(o,d,V,f,te,pe,L)||!1)?(q||typeof I.UNSAFE_componentWillUpdate!="function"&&typeof I.componentWillUpdate!="function"||(typeof I.componentWillUpdate=="function"&&I.componentWillUpdate(f,pe,L),typeof I.UNSAFE_componentWillUpdate=="function"&&I.UNSAFE_componentWillUpdate(f,pe,L)),typeof I.componentDidUpdate=="function"&&(o.flags|=4),typeof I.getSnapshotBeforeUpdate=="function"&&(o.flags|=1024)):(typeof I.componentDidUpdate!="function"||D===s.memoizedProps&&te===s.memoizedState||(o.flags|=4),typeof I.getSnapshotBeforeUpdate!="function"||D===s.memoizedProps&&te===s.memoizedState||(o.flags|=1024),o.memoizedProps=f,o.memoizedState=pe),I.props=f,I.state=pe,I.context=L,f=V):(typeof I.componentDidUpdate!="function"||D===s.memoizedProps&&te===s.memoizedState||(o.flags|=4),typeof I.getSnapshotBeforeUpdate!="function"||D===s.memoizedProps&&te===s.memoizedState||(o.flags|=1024),f=!1)}return PT(s,o,d,f,v,m)}function PT(s,o,d,f,m,v){gk(s,o);var I=(o.flags&128)!==0;if(!f&&!I)return m&&Hb(o,d,!1),$s(s,o,v);f=o.stateNode,r8.current=o;var D=I&&typeof d.getDerivedStateFromError!="function"?null:f.render();return o.flags|=1,s!==null&&I?(o.child=kl(o,s.child,null,v),o.child=kl(o,null,D,v)):Or(s,o,D,v),o.memoizedState=f.state,m&&Hb(o,d,!0),o.child}function Sk(s){var o=s.stateNode;o.pendingContext?Wb(s,o.pendingContext,o.pendingContext!==o.context):o.context&&Wb(s,o.context,!1),Cv(s,o.containerInfo)}function aD(s,o,d,f,m){return Pl(),Ev(m),o.flags|=256,Or(s,o,d,f),o.child}var kT={dehydrated:null,treeContext:null,retryLane:0};function LT(s){return{baseLanes:s,cachePool:null,transitions:null}}function Tk(s,o,d){var f=o.pendingProps,m=fi.current,v=!1,I=(o.flags&128)!==0,D;if((D=I)||(D=s!==null&&s.memoizedState===null?!1:(m&2)!==0),D?(v=!0,o.flags&=-129):(s===null||s.memoizedState!==null)&&(m|=1),qt(fi,m&1),s===null)return wT(o),s=o.memoizedState,s!==null&&(s=s.dehydrated,s!==null)?(o.mode&1?s.data==="$!"?o.lanes=8:o.lanes=1073741824:o.lanes=1,null):(I=f.children,s=f.fallback,v?(f=o.mode,v=o.child,I={mode:"hidden",children:I},!(f&1)&&v!==null?(v.childLanes=0,v.pendingProps=I):v=f_(I,f,0,null),s=qo(s,f,d,null),v.return=o,s.return=o,v.sibling=s,o.child=v,o.child.memoizedState=LT(d),o.memoizedState=kT,s):Dv(o,I));if(m=s.memoizedState,m!==null&&(D=m.dehydrated,D!==null))return n8(s,o,I,f,D,m,d);if(v){v=f.fallback,I=o.mode,m=s.child,D=m.sibling;var L={mode:"hidden",children:f.children};return!(I&1)&&o.child!==m?(f=o.child,f.childLanes=0,f.pendingProps=L,o.deletions=null):(f=Ja(m,L),f.subtreeFlags=m.subtreeFlags&14680064),D!==null?v=Ja(D,v):(v=qo(v,I,d,null),v.flags|=2),v.return=o,f.return=o,f.sibling=v,o.child=f,f=v,v=o.child,I=s.child.memoizedState,I=I===null?LT(d):{baseLanes:I.baseLanes|d,cachePool:null,transitions:I.transitions},v.memoizedState=I,v.childLanes=s.childLanes&~d,o.memoizedState=kT,f}return v=s.child,s=v.sibling,f=Ja(v,{mode:"visible",children:f.children}),!(o.mode&1)&&(f.lanes=d),f.return=o,f.sibling=null,s!==null&&(d=o.deletions,d===null?(o.deletions=[s],o.flags|=16):d.push(s)),o.child=f,o.memoizedState=null,f}function Dv(s,o){return o=f_({mode:"visible",children:o},s.mode,0,null),o.return=s,s.child=o}function ff(s,o,d,f){return f!==null&&Ev(f),kl(o,s.child,null,d),s=Dv(o,o.pendingProps.children),s.flags|=2,o.memoizedState=null,s}function n8(s,o,d,f,m,v,I){if(d)return o.flags&256?(o.flags&=-257,f=HS(Error(Te(422))),ff(s,o,I,f)):o.memoizedState!==null?(o.child=s.child,o.flags|=128,null):(v=f.fallback,m=o.mode,f=f_({mode:"visible",children:f.children},m,0,null),v=qo(v,m,I,null),v.flags|=2,f.return=o,v.return=o,f.sibling=v,o.child=f,o.mode&1&&kl(o,s.child,null,I),o.child.memoizedState=LT(I),o.memoizedState=kT,v);if(!(o.mode&1))return ff(s,o,I,null);if(m.data==="$!"){if(f=m.nextSibling&&m.nextSibling.dataset,f)var D=f.dgst;return f=D,v=Error(Te(419)),f=HS(v,f,void 0),ff(s,o,I,f)}if(D=(I&s.childLanes)!==0,Qr||D){if(f=$i,f!==null){switch(I&-I){case 4:m=2;break;case 16:m=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:m=32;break;case 536870912:m=268435456;break;default:m=0}m=m&(f.suspendedLanes|I)?0:m,m!==0&&m!==v.retryLane&&(v.retryLane=m,Qs(s,m),ts(f,s,m,-1))}return xv(),f=HS(Error(Te(421))),ff(s,o,I,f)}return m.data==="$?"?(o.flags|=128,o.child=s.child,o=E8.bind(null,s),m._reactRetry=o,null):(s=v.treeContext,En=Ka(m.nextSibling),gn=o,ui=!0,Zn=null,s!==null&&(Mn[Un++]=zs,Mn[Un++]=Ys,Mn[Un++]=Qo,zs=s.id,Ys=s.overflow,Qo=o),o=Dv(o,f.children),o.flags|=4096,o)}function oD(s,o,d){s.lanes|=o;var f=s.alternate;f!==null&&(f.lanes|=o),AT(s.return,o,d)}function KS(s,o,d,f,m){var v=s.memoizedState;v===null?s.memoizedState={isBackwards:o,rendering:null,renderingStartTime:0,last:f,tail:d,tailMode:m}:(v.isBackwards=o,v.rendering=null,v.renderingStartTime=0,v.last=f,v.tail=d,v.tailMode=m)}function vk(s,o,d){var f=o.pendingProps,m=f.revealOrder,v=f.tail;if(Or(s,o,f.children,d),f=fi.current,f&2)f=f&1|2,o.flags|=128;else{if(s!==null&&s.flags&128)e:for(s=o.child;s!==null;){if(s.tag===13)s.memoizedState!==null&&oD(s,d,o);else if(s.tag===19)oD(s,d,o);else if(s.child!==null){s.child.return=s,s=s.child;continue}if(s===o)break e;for(;s.sibling===null;){if(s.return===null||s.return===o)break e;s=s.return}s.sibling.return=s.return,s=s.sibling}f&=1}if(qt(fi,f),!(o.mode&1))o.memoizedState=null;else switch(m){case"forwards":for(d=o.child,m=null;d!==null;)s=d.alternate,s!==null&&qf(s)===null&&(m=d),d=d.sibling;d=m,d===null?(m=o.child,o.child=null):(m=d.sibling,d.sibling=null),KS(o,!1,m,d,v);break;case"backwards":for(d=null,m=o.child,o.child=null;m!==null;){if(s=m.alternate,s!==null&&qf(s)===null){o.child=m;break}s=m.sibling,m.sibling=d,d=m,m=s}KS(o,!0,d,null,v);break;case"together":KS(o,!1,null,null,void 0);break;default:o.memoizedState=null}return o.child}function Of(s,o){!(o.mode&1)&&s!==null&&(s.alternate=null,o.alternate=null,o.flags|=2)}function $s(s,o,d){if(s!==null&&(o.dependencies=s.dependencies),Zo|=o.lanes,!(d&o.childLanes))return null;if(s!==null&&o.child!==s.child)throw Error(Te(153));if(o.child!==null){for(s=o.child,d=Ja(s,s.pendingProps),o.child=d,d.return=o;s.sibling!==null;)s=s.sibling,d=d.sibling=Ja(s,s.pendingProps),d.return=o;d.sibling=null}return o.child}function s8(s,o,d){switch(o.tag){case 3:Sk(o),Pl();break;case 5:qP(o);break;case 1:Zr(o.type)&&Gf(o);break;case 4:Cv(o,o.stateNode.containerInfo);break;case 10:var f=o.type._context,m=o.memoizedProps.value;qt(Kf,f._currentValue),f._currentValue=m;break;case 13:if(f=o.memoizedState,f!==null)return f.dehydrated!==null?(qt(fi,fi.current&1),o.flags|=128,null):d&o.child.childLanes?Tk(s,o,d):(qt(fi,fi.current&1),s=$s(s,o,d),s!==null?s.sibling:null);qt(fi,fi.current&1);break;case 19:if(f=(d&o.childLanes)!==0,s.flags&128){if(f)return vk(s,o,d);o.flags|=128}if(m=o.memoizedState,m!==null&&(m.rendering=null,m.tail=null,m.lastEffect=null),qt(fi,fi.current),f)break;return null;case 22:case 23:return o.lanes=0,Ek(s,o,d)}return $s(s,o,d)}var yk,MT,Ck,Rk;yk=function(s,o){for(var d=o.child;d!==null;){if(d.tag===5||d.tag===6)s.appendChild(d.stateNode);else if(d.tag!==4&&d.child!==null){d.child.return=d,d=d.child;continue}if(d===o)break;for(;d.sibling===null;){if(d.return===null||d.return===o)return;d=d.return}d.sibling.return=d.return,d=d.sibling}};MT=function(){};Ck=function(s,o,d,f){var m=s.memoizedProps;if(m!==f){s=o.stateNode,zo(Os.current);var v=null;switch(d){case"input":m=rT(s,m),f=rT(s,f),v=[];break;case"select":m=mi({},m,{value:void 0}),f=mi({},f,{value:void 0}),v=[];break;case"textarea":m=aT(s,m),f=aT(s,f),v=[];break;default:typeof m.onClick!="function"&&typeof f.onClick=="function"&&(s.onclick=jf)}cT(d,f);var I;d=null;for(V in m)if(!f.hasOwnProperty(V)&&m.hasOwnProperty(V)&&m[V]!=null)if(V==="style"){var D=m[V];for(I in D)D.hasOwnProperty(I)&&(d||(d={}),d[I]="")}else V!=="dangerouslySetInnerHTML"&&V!=="children"&&V!=="suppressContentEditableWarning"&&V!=="suppressHydrationWarning"&&V!=="autoFocus"&&(mu.hasOwnProperty(V)?v||(v=[]):(v=v||[]).push(V,null));for(V in f){var L=f[V];if(D=m!=null?m[V]:void 0,f.hasOwnProperty(V)&&L!==D&&(L!=null||D!=null))if(V==="style")if(D){for(I in D)!D.hasOwnProperty(I)||L&&L.hasOwnProperty(I)||(d||(d={}),d[I]="");for(I in L)L.hasOwnProperty(I)&&D[I]!==L[I]&&(d||(d={}),d[I]=L[I])}else d||(v||(v=[]),v.push(V,d)),d=L;else V==="dangerouslySetInnerHTML"?(L=L?L.__html:void 0,D=D?D.__html:void 0,L!=null&&D!==L&&(v=v||[]).push(V,L)):V==="children"?typeof L!="string"&&typeof L!="number"||(v=v||[]).push(V,""+L):V!=="suppressContentEditableWarning"&&V!=="suppressHydrationWarning"&&(mu.hasOwnProperty(V)?(L!=null&&V==="onScroll"&&ei("scroll",s),v||D===L||(v=[])):(v=v||[]).push(V,L))}d&&(v=v||[]).push("style",d);var V=v;(o.updateQueue=V)&&(o.flags|=4)}};Rk=function(s,o,d,f){d!==f&&(o.flags|=4)};function eu(s,o){if(!ui)switch(s.tailMode){case"hidden":o=s.tail;for(var d=null;o!==null;)o.alternate!==null&&(d=o),o=o.sibling;d===null?s.tail=null:d.sibling=null;break;case"collapsed":d=s.tail;for(var f=null;d!==null;)d.alternate!==null&&(f=d),d=d.sibling;f===null?o||s.tail===null?s.tail=null:s.tail.sibling=null:f.sibling=null}}function gr(s){var o=s.alternate!==null&&s.alternate.child===s.child,d=0,f=0;if(o)for(var m=s.child;m!==null;)d|=m.lanes|m.childLanes,f|=m.subtreeFlags&14680064,f|=m.flags&14680064,m.return=s,m=m.sibling;else for(m=s.child;m!==null;)d|=m.lanes|m.childLanes,f|=m.subtreeFlags,f|=m.flags,m.return=s,m=m.sibling;return s.subtreeFlags|=f,s.childLanes=d,o}function a8(s,o,d){var f=o.pendingProps;switch(mv(o),o.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return gr(o),null;case 1:return Zr(o.type)&&Bf(),gr(o),null;case 3:return f=o.stateNode,Ll(),ti($r),ti(vr),Iv(),f.pendingContext&&(f.context=f.pendingContext,f.pendingContext=null),(s===null||s.child===null)&&(hf(o)?o.flags|=4:s===null||s.memoizedState.isDehydrated&&!(o.flags&256)||(o.flags|=1024,Zn!==null&&(WT(Zn),Zn=null))),MT(s,o),gr(o),null;case 5:Rv(o);var m=zo(Ou.current);if(d=o.type,s!==null&&o.stateNode!=null)Ck(s,o,d,f,m),s.ref!==o.ref&&(o.flags|=512,o.flags|=2097152);else{if(!f){if(o.stateNode===null)throw Error(Te(166));return gr(o),null}if(s=zo(Os.current),hf(o)){f=o.stateNode,d=o.type;var v=o.memoizedProps;switch(f[ws]=o,f[wu]=v,s=(o.mode&1)!==0,d){case"dialog":ei("cancel",f),ei("close",f);break;case"iframe":case"object":case"embed":ei("load",f);break;case"video":case"audio":for(m=0;m<su.length;m++)ei(su[m],f);break;case"source":ei("error",f);break;case"img":case"image":case"link":ei("error",f),ei("load",f);break;case"details":ei("toggle",f);break;case"input":mb(f,v),ei("invalid",f);break;case"select":f._wrapperState={wasMultiple:!!v.multiple},ei("invalid",f);break;case"textarea":gb(f,v),ei("invalid",f)}cT(d,v),m=null;for(var I in v)if(v.hasOwnProperty(I)){var D=v[I];I==="children"?typeof D=="string"?f.textContent!==D&&(v.suppressHydrationWarning!==!0&&uf(f.textContent,D,s),m=["children",D]):typeof D=="number"&&f.textContent!==""+D&&(v.suppressHydrationWarning!==!0&&uf(f.textContent,D,s),m=["children",""+D]):mu.hasOwnProperty(I)&&D!=null&&I==="onScroll"&&ei("scroll",f)}switch(d){case"input":rf(f),Eb(f,v,!0);break;case"textarea":rf(f),Sb(f);break;case"select":case"option":break;default:typeof v.onClick=="function"&&(f.onclick=jf)}f=m,o.updateQueue=f,f!==null&&(o.flags|=4)}else{I=m.nodeType===9?m:m.ownerDocument,s==="http://www.w3.org/1999/xhtml"&&(s=QD(d)),s==="http://www.w3.org/1999/xhtml"?d==="script"?(s=I.createElement("div"),s.innerHTML="<script><\/script>",s=s.removeChild(s.firstChild)):typeof f.is=="string"?s=I.createElement(d,{is:f.is}):(s=I.createElement(d),d==="select"&&(I=s,f.multiple?I.multiple=!0:f.size&&(I.size=f.size))):s=I.createElementNS(s,d),s[ws]=o,s[wu]=f,yk(s,o,!1,!1),o.stateNode=s;e:{switch(I=lT(d,f),d){case"dialog":ei("cancel",s),ei("close",s),m=f;break;case"iframe":case"object":case"embed":ei("load",s),m=f;break;case"video":case"audio":for(m=0;m<su.length;m++)ei(su[m],s);m=f;break;case"source":ei("error",s),m=f;break;case"img":case"image":case"link":ei("error",s),ei("load",s),m=f;break;case"details":ei("toggle",s),m=f;break;case"input":mb(s,f),m=rT(s,f),ei("invalid",s);break;case"option":m=f;break;case"select":s._wrapperState={wasMultiple:!!f.multiple},m=mi({},f,{value:void 0}),ei("invalid",s);break;case"textarea":gb(s,f),m=aT(s,f),ei("invalid",s);break;default:m=f}cT(d,m),D=m;for(v in D)if(D.hasOwnProperty(v)){var L=D[v];v==="style"?eP(s,L):v==="dangerouslySetInnerHTML"?(L=L?L.__html:void 0,L!=null&&$D(s,L)):v==="children"?typeof L=="string"?(d!=="textarea"||L!=="")&&Eu(s,L):typeof L=="number"&&Eu(s,""+L):v!=="suppressContentEditableWarning"&&v!=="suppressHydrationWarning"&&v!=="autoFocus"&&(mu.hasOwnProperty(v)?L!=null&&v==="onScroll"&&ei("scroll",s):L!=null&&tv(s,v,L,I))}switch(d){case"input":rf(s),Eb(s,f,!1);break;case"textarea":rf(s),Sb(s);break;case"option":f.value!=null&&s.setAttribute("value",""+Xa(f.value));break;case"select":s.multiple=!!f.multiple,v=f.value,v!=null?Rl(s,!!f.multiple,v,!1):f.defaultValue!=null&&Rl(s,!!f.multiple,f.defaultValue,!0);break;default:typeof m.onClick=="function"&&(s.onclick=jf)}switch(d){case"button":case"input":case"select":case"textarea":f=!!f.autoFocus;break e;case"img":f=!0;break e;default:f=!1}}f&&(o.flags|=4)}o.ref!==null&&(o.flags|=512,o.flags|=2097152)}return gr(o),null;case 6:if(s&&o.stateNode!=null)Rk(s,o,s.memoizedProps,f);else{if(typeof f!="string"&&o.stateNode===null)throw Error(Te(166));if(d=zo(Ou.current),zo(Os.current),hf(o)){if(f=o.stateNode,d=o.memoizedProps,f[ws]=o,(v=f.nodeValue!==d)&&(s=gn,s!==null))switch(s.tag){case 3:uf(f.nodeValue,d,(s.mode&1)!==0);break;case 5:s.memoizedProps.suppressHydrationWarning!==!0&&uf(f.nodeValue,d,(s.mode&1)!==0)}v&&(o.flags|=4)}else f=(d.nodeType===9?d:d.ownerDocument).createTextNode(f),f[ws]=o,o.stateNode=f}return gr(o),null;case 13:if(ti(fi),f=o.memoizedState,s===null||s.memoizedState!==null&&s.memoizedState.dehydrated!==null){if(ui&&En!==null&&o.mode&1&&!(o.flags&128))BP(),Pl(),o.flags|=98560,v=!1;else if(v=hf(o),f!==null&&f.dehydrated!==null){if(s===null){if(!v)throw Error(Te(318));if(v=o.memoizedState,v=v!==null?v.dehydrated:null,!v)throw Error(Te(317));v[ws]=o}else Pl(),!(o.flags&128)&&(o.memoizedState=null),o.flags|=4;gr(o),v=!1}else Zn!==null&&(WT(Zn),Zn=null),v=!0;if(!v)return o.flags&65536?o:null}return o.flags&128?(o.lanes=d,o):(f=f!==null,f!==(s!==null&&s.memoizedState!==null)&&f&&(o.child.flags|=8192,o.mode&1&&(s===null||fi.current&1?Gi===0&&(Gi=3):xv())),o.updateQueue!==null&&(o.flags|=4),gr(o),null);case 4:return Ll(),MT(s,o),s===null&&Ru(o.stateNode.containerInfo),gr(o),null;case 10:return Tv(o.type._context),gr(o),null;case 17:return Zr(o.type)&&Bf(),gr(o),null;case 19:if(ti(fi),v=o.memoizedState,v===null)return gr(o),null;if(f=(o.flags&128)!==0,I=v.rendering,I===null)if(f)eu(v,!1);else{if(Gi!==0||s!==null&&s.flags&128)for(s=o.child;s!==null;){if(I=qf(s),I!==null){for(o.flags|=128,eu(v,!1),f=I.updateQueue,f!==null&&(o.updateQueue=f,o.flags|=4),o.subtreeFlags=0,f=d,d=o.child;d!==null;)v=d,s=f,v.flags&=14680066,I=v.alternate,I===null?(v.childLanes=0,v.lanes=s,v.child=null,v.subtreeFlags=0,v.memoizedProps=null,v.memoizedState=null,v.updateQueue=null,v.dependencies=null,v.stateNode=null):(v.childLanes=I.childLanes,v.lanes=I.lanes,v.child=I.child,v.subtreeFlags=0,v.deletions=null,v.memoizedProps=I.memoizedProps,v.memoizedState=I.memoizedState,v.updateQueue=I.updateQueue,v.type=I.type,s=I.dependencies,v.dependencies=s===null?null:{lanes:s.lanes,firstContext:s.firstContext}),d=d.sibling;return qt(fi,fi.current&1|2),o.child}s=s.sibling}v.tail!==null&&Ni()>Ul&&(o.flags|=128,f=!0,eu(v,!1),o.lanes=4194304)}else{if(!f)if(s=qf(I),s!==null){if(o.flags|=128,f=!0,d=s.updateQueue,d!==null&&(o.updateQueue=d,o.flags|=4),eu(v,!0),v.tail===null&&v.tailMode==="hidden"&&!I.alternate&&!ui)return gr(o),null}else 2*Ni()-v.renderingStartTime>Ul&&d!==1073741824&&(o.flags|=128,f=!0,eu(v,!1),o.lanes=4194304);v.isBackwards?(I.sibling=o.child,o.child=I):(d=v.last,d!==null?d.sibling=I:o.child=I,v.last=I)}return v.tail!==null?(o=v.tail,v.rendering=o,v.tail=o.sibling,v.renderingStartTime=Ni(),o.sibling=null,d=fi.current,qt(fi,f?d&1|2:d&1),o):(gr(o),null);case 22:case 23:return Uv(),f=o.memoizedState!==null,s!==null&&s.memoizedState!==null!==f&&(o.flags|=8192),f&&o.mode&1?mn&1073741824&&(gr(o),o.subtreeFlags&6&&(o.flags|=8192)):gr(o),null;case 24:return null;case 25:return null}throw Error(Te(156,o.tag))}function o8(s,o){switch(mv(o),o.tag){case 1:return Zr(o.type)&&Bf(),s=o.flags,s&65536?(o.flags=s&-65537|128,o):null;case 3:return Ll(),ti($r),ti(vr),Iv(),s=o.flags,s&65536&&!(s&128)?(o.flags=s&-65537|128,o):null;case 5:return Rv(o),null;case 13:if(ti(fi),s=o.memoizedState,s!==null&&s.dehydrated!==null){if(o.alternate===null)throw Error(Te(340));Pl()}return s=o.flags,s&65536?(o.flags=s&-65537|128,o):null;case 19:return ti(fi),null;case 4:return Ll(),null;case 10:return Tv(o.type._context),null;case 22:case 23:return Uv(),null;case 24:return null;default:return null}}var _f=!1,Sr=!1,c8=typeof WeakSet=="function"?WeakSet:Set,be=null;function yl(s,o){var d=s.ref;if(d!==null)if(typeof d=="function")try{d(null)}catch(f){Ti(s,o,f)}else d.current=null}function UT(s,o,d){try{d()}catch(f){Ti(s,o,f)}}var cD=!1;function l8(s,o){if(ST=xf,s=OP(),fv(s)){if("selectionStart"in s)var d={start:s.selectionStart,end:s.selectionEnd};else e:{d=(d=s.ownerDocument)&&d.defaultView||window;var f=d.getSelection&&d.getSelection();if(f&&f.rangeCount!==0){d=f.anchorNode;var m=f.anchorOffset,v=f.focusNode;f=f.focusOffset;try{d.nodeType,v.nodeType}catch{d=null;break e}var I=0,D=-1,L=-1,V=0,q=0,H=s,te=null;t:for(;;){for(var de;H!==d||m!==0&&H.nodeType!==3||(D=I+m),H!==v||f!==0&&H.nodeType!==3||(L=I+f),H.nodeType===3&&(I+=H.nodeValue.length),(de=H.firstChild)!==null;)te=H,H=de;for(;;){if(H===s)break t;if(te===d&&++V===m&&(D=I),te===v&&++q===f&&(L=I),(de=H.nextSibling)!==null)break;H=te,te=H.parentNode}H=de}d=D===-1||L===-1?null:{start:D,end:L}}else d=null}d=d||{start:0,end:0}}else d=null;for(TT={focusedElem:s,selectionRange:d},xf=!1,be=o;be!==null;)if(o=be,s=o.child,(o.subtreeFlags&1028)!==0&&s!==null)s.return=o,be=s;else for(;be!==null;){o=be;try{var pe=o.alternate;if(o.flags&1024)switch(o.tag){case 0:case 11:case 15:break;case 1:if(pe!==null){var ee=pe.memoizedProps,ae=pe.memoizedState,K=o.stateNode,G=K.getSnapshotBeforeUpdate(o.elementType===o.type?ee:Qn(o.type,ee),ae);K.__reactInternalSnapshotBeforeUpdate=G}break;case 3:var Q=o.stateNode.containerInfo;Q.nodeType===1?Q.textContent="":Q.nodeType===9&&Q.documentElement&&Q.removeChild(Q.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(Te(163))}}catch(_e){Ti(o,o.return,_e)}if(s=o.sibling,s!==null){s.return=o.return,be=s;break}be=o.return}return pe=cD,cD=!1,pe}function pu(s,o,d){var f=o.updateQueue;if(f=f!==null?f.lastEffect:null,f!==null){var m=f=f.next;do{if((m.tag&s)===s){var v=m.destroy;m.destroy=void 0,v!==void 0&&UT(o,d,v)}m=m.next}while(m!==f)}}function h_(s,o){if(o=o.updateQueue,o=o!==null?o.lastEffect:null,o!==null){var d=o=o.next;do{if((d.tag&s)===s){var f=d.create;d.destroy=f()}d=d.next}while(d!==o)}}function xT(s){var o=s.ref;if(o!==null){var d=s.stateNode;switch(s.tag){case 5:s=d;break;default:s=d}typeof o=="function"?o(s):o.current=s}}function Ik(s){var o=s.alternate;o!==null&&(s.alternate=null,Ik(o)),s.child=null,s.deletions=null,s.sibling=null,s.tag===5&&(o=s.stateNode,o!==null&&(delete o[ws],delete o[wu],delete o[CT],delete o[K6],delete o[z6])),s.stateNode=null,s.return=null,s.dependencies=null,s.memoizedProps=null,s.memoizedState=null,s.pendingProps=null,s.stateNode=null,s.updateQueue=null}function wk(s){return s.tag===5||s.tag===3||s.tag===4}function lD(s){e:for(;;){for(;s.sibling===null;){if(s.return===null||wk(s.return))return null;s=s.return}for(s.sibling.return=s.return,s=s.sibling;s.tag!==5&&s.tag!==6&&s.tag!==18;){if(s.flags&2||s.child===null||s.tag===4)continue e;s.child.return=s,s=s.child}if(!(s.flags&2))return s.stateNode}}function VT(s,o,d){var f=s.tag;if(f===5||f===6)s=s.stateNode,o?d.nodeType===8?d.parentNode.insertBefore(s,o):d.insertBefore(s,o):(d.nodeType===8?(o=d.parentNode,o.insertBefore(s,d)):(o=d,o.appendChild(s)),d=d._reactRootContainer,d!=null||o.onclick!==null||(o.onclick=jf));else if(f!==4&&(s=s.child,s!==null))for(VT(s,o,d),s=s.sibling;s!==null;)VT(s,o,d),s=s.sibling}function FT(s,o,d){var f=s.tag;if(f===5||f===6)s=s.stateNode,o?d.insertBefore(s,o):d.appendChild(s);else if(f!==4&&(s=s.child,s!==null))for(FT(s,o,d),s=s.sibling;s!==null;)FT(s,o,d),s=s.sibling}var rr=null,$n=!1;function La(s,o,d){for(d=d.child;d!==null;)Ak(s,o,d),d=d.sibling}function Ak(s,o,d){if(As&&typeof As.onCommitFiberUnmount=="function")try{As.onCommitFiberUnmount(n_,d)}catch{}switch(d.tag){case 5:Sr||yl(d,o);case 6:var f=rr,m=$n;rr=null,La(s,o,d),rr=f,$n=m,rr!==null&&($n?(s=rr,d=d.stateNode,s.nodeType===8?s.parentNode.removeChild(d):s.removeChild(d)):rr.removeChild(d.stateNode));break;case 18:rr!==null&&($n?(s=rr,d=d.stateNode,s.nodeType===8?VS(s.parentNode,d):s.nodeType===1&&VS(s,d),vu(s)):VS(rr,d.stateNode));break;case 4:f=rr,m=$n,rr=d.stateNode.containerInfo,$n=!0,La(s,o,d),rr=f,$n=m;break;case 0:case 11:case 14:case 15:if(!Sr&&(f=d.updateQueue,f!==null&&(f=f.lastEffect,f!==null))){m=f=f.next;do{var v=m,I=v.destroy;v=v.tag,I!==void 0&&(v&2||v&4)&&UT(d,o,I),m=m.next}while(m!==f)}La(s,o,d);break;case 1:if(!Sr&&(yl(d,o),f=d.stateNode,typeof f.componentWillUnmount=="function"))try{f.props=d.memoizedProps,f.state=d.memoizedState,f.componentWillUnmount()}catch(D){Ti(d,o,D)}La(s,o,d);break;case 21:La(s,o,d);break;case 22:d.mode&1?(Sr=(f=Sr)||d.memoizedState!==null,La(s,o,d),Sr=f):La(s,o,d);break;default:La(s,o,d)}}function dD(s){var o=s.updateQueue;if(o!==null){s.updateQueue=null;var d=s.stateNode;d===null&&(d=s.stateNode=new c8),o.forEach(function(f){var m=g8.bind(null,s,f);d.has(f)||(d.add(f),f.then(m,m))})}}function Xn(s,o){var d=o.deletions;if(d!==null)for(var f=0;f<d.length;f++){var m=d[f];try{var v=s,I=o,D=I;e:for(;D!==null;){switch(D.tag){case 5:rr=D.stateNode,$n=!1;break e;case 3:rr=D.stateNode.containerInfo,$n=!0;break e;case 4:rr=D.stateNode.containerInfo,$n=!0;break e}D=D.return}if(rr===null)throw Error(Te(160));Ak(v,I,m),rr=null,$n=!1;var L=m.alternate;L!==null&&(L.return=null),m.return=null}catch(V){Ti(m,o,V)}}if(o.subtreeFlags&12854)for(o=o.child;o!==null;)Ok(o,s),o=o.sibling}function Ok(s,o){var d=s.alternate,f=s.flags;switch(s.tag){case 0:case 11:case 14:case 15:if(Xn(o,s),Rs(s),f&4){try{pu(3,s,s.return),h_(3,s)}catch(ee){Ti(s,s.return,ee)}try{pu(5,s,s.return)}catch(ee){Ti(s,s.return,ee)}}break;case 1:Xn(o,s),Rs(s),f&512&&d!==null&&yl(d,d.return);break;case 5:if(Xn(o,s),Rs(s),f&512&&d!==null&&yl(d,d.return),s.flags&32){var m=s.stateNode;try{Eu(m,"")}catch(ee){Ti(s,s.return,ee)}}if(f&4&&(m=s.stateNode,m!=null)){var v=s.memoizedProps,I=d!==null?d.memoizedProps:v,D=s.type,L=s.updateQueue;if(s.updateQueue=null,L!==null)try{D==="input"&&v.type==="radio"&&v.name!=null&&JD(m,v),lT(D,I);var V=lT(D,v);for(I=0;I<L.length;I+=2){var q=L[I],H=L[I+1];q==="style"?eP(m,H):q==="dangerouslySetInnerHTML"?$D(m,H):q==="children"?Eu(m,H):tv(m,q,H,V)}switch(D){case"input":nT(m,v);break;case"textarea":XD(m,v);break;case"select":var te=m._wrapperState.wasMultiple;m._wrapperState.wasMultiple=!!v.multiple;var de=v.value;de!=null?Rl(m,!!v.multiple,de,!1):te!==!!v.multiple&&(v.defaultValue!=null?Rl(m,!!v.multiple,v.defaultValue,!0):Rl(m,!!v.multiple,v.multiple?[]:"",!1))}m[wu]=v}catch(ee){Ti(s,s.return,ee)}}break;case 6:if(Xn(o,s),Rs(s),f&4){if(s.stateNode===null)throw Error(Te(162));m=s.stateNode,v=s.memoizedProps;try{m.nodeValue=v}catch(ee){Ti(s,s.return,ee)}}break;case 3:if(Xn(o,s),Rs(s),f&4&&d!==null&&d.memoizedState.isDehydrated)try{vu(o.containerInfo)}catch(ee){Ti(s,s.return,ee)}break;case 4:Xn(o,s),Rs(s);break;case 13:Xn(o,s),Rs(s),m=s.child,m.flags&8192&&(v=m.memoizedState!==null,m.stateNode.isHidden=v,!v||m.alternate!==null&&m.alternate.memoizedState!==null||(Lv=Ni())),f&4&&dD(s);break;case 22:if(q=d!==null&&d.memoizedState!==null,s.mode&1?(Sr=(V=Sr)||q,Xn(o,s),Sr=V):Xn(o,s),Rs(s),f&8192){if(V=s.memoizedState!==null,(s.stateNode.isHidden=V)&&!q&&s.mode&1)for(be=s,q=s.child;q!==null;){for(H=be=q;be!==null;){switch(te=be,de=te.child,te.tag){case 0:case 11:case 14:case 15:pu(4,te,te.return);break;case 1:yl(te,te.return);var pe=te.stateNode;if(typeof pe.componentWillUnmount=="function"){f=te,d=te.return;try{o=f,pe.props=o.memoizedProps,pe.state=o.memoizedState,pe.componentWillUnmount()}catch(ee){Ti(f,d,ee)}}break;case 5:yl(te,te.return);break;case 22:if(te.memoizedState!==null){hD(H);continue}}de!==null?(de.return=te,be=de):hD(H)}q=q.sibling}e:for(q=null,H=s;;){if(H.tag===5){if(q===null){q=H;try{m=H.stateNode,V?(v=m.style,typeof v.setProperty=="function"?v.setProperty("display","none","important"):v.display="none"):(D=H.stateNode,L=H.memoizedProps.style,I=L!=null&&L.hasOwnProperty("display")?L.display:null,D.style.display=ZD("display",I))}catch(ee){Ti(s,s.return,ee)}}}else if(H.tag===6){if(q===null)try{H.stateNode.nodeValue=V?"":H.memoizedProps}catch(ee){Ti(s,s.return,ee)}}else if((H.tag!==22&&H.tag!==23||H.memoizedState===null||H===s)&&H.child!==null){H.child.return=H,H=H.child;continue}if(H===s)break e;for(;H.sibling===null;){if(H.return===null||H.return===s)break e;q===H&&(q=null),H=H.return}q===H&&(q=null),H.sibling.return=H.return,H=H.sibling}}break;case 19:Xn(o,s),Rs(s),f&4&&dD(s);break;case 21:break;default:Xn(o,s),Rs(s)}}function Rs(s){var o=s.flags;if(o&2){try{e:{for(var d=s.return;d!==null;){if(wk(d)){var f=d;break e}d=d.return}throw Error(Te(160))}switch(f.tag){case 5:var m=f.stateNode;f.flags&32&&(Eu(m,""),f.flags&=-33);var v=lD(s);FT(s,v,m);break;case 3:case 4:var I=f.stateNode.containerInfo,D=lD(s);VT(s,D,I);break;default:throw Error(Te(161))}}catch(L){Ti(s,s.return,L)}s.flags&=-3}o&4096&&(s.flags&=-4097)}function d8(s,o,d){be=s,Nk(s)}function Nk(s,o,d){for(var f=(s.mode&1)!==0;be!==null;){var m=be,v=m.child;if(m.tag===22&&f){var I=m.memoizedState!==null||_f;if(!I){var D=m.alternate,L=D!==null&&D.memoizedState!==null||Sr;D=_f;var V=Sr;if(_f=I,(Sr=L)&&!V)for(be=m;be!==null;)I=be,L=I.child,I.tag===22&&I.memoizedState!==null?pD(m):L!==null?(L.return=I,be=L):pD(m);for(;v!==null;)be=v,Nk(v),v=v.sibling;be=m,_f=D,Sr=V}uD(s)}else m.subtreeFlags&8772&&v!==null?(v.return=m,be=v):uD(s)}}function uD(s){for(;be!==null;){var o=be;if(o.flags&8772){var d=o.alternate;try{if(o.flags&8772)switch(o.tag){case 0:case 11:case 15:Sr||h_(5,o);break;case 1:var f=o.stateNode;if(o.flags&4&&!Sr)if(d===null)f.componentDidMount();else{var m=o.elementType===o.type?d.memoizedProps:Qn(o.type,d.memoizedProps);f.componentDidUpdate(m,d.memoizedState,f.__reactInternalSnapshotBeforeUpdate)}var v=o.updateQueue;v!==null&&qb(o,v,f);break;case 3:var I=o.updateQueue;if(I!==null){if(d=null,o.child!==null)switch(o.child.tag){case 5:d=o.child.stateNode;break;case 1:d=o.child.stateNode}qb(o,I,d)}break;case 5:var D=o.stateNode;if(d===null&&o.flags&4){d=D;var L=o.memoizedProps;switch(o.type){case"button":case"input":case"select":case"textarea":L.autoFocus&&d.focus();break;case"img":L.src&&(d.src=L.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(o.memoizedState===null){var V=o.alternate;if(V!==null){var q=V.memoizedState;if(q!==null){var H=q.dehydrated;H!==null&&vu(H)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(Te(163))}Sr||o.flags&512&&xT(o)}catch(te){Ti(o,o.return,te)}}if(o===s){be=null;break}if(d=o.sibling,d!==null){d.return=o.return,be=d;break}be=o.return}}function hD(s){for(;be!==null;){var o=be;if(o===s){be=null;break}var d=o.sibling;if(d!==null){d.return=o.return,be=d;break}be=o.return}}function pD(s){for(;be!==null;){var o=be;try{switch(o.tag){case 0:case 11:case 15:var d=o.return;try{h_(4,o)}catch(L){Ti(o,d,L)}break;case 1:var f=o.stateNode;if(typeof f.componentDidMount=="function"){var m=o.return;try{f.componentDidMount()}catch(L){Ti(o,m,L)}}var v=o.return;try{xT(o)}catch(L){Ti(o,v,L)}break;case 5:var I=o.return;try{xT(o)}catch(L){Ti(o,I,L)}}}catch(L){Ti(o,o.return,L)}if(o===s){be=null;break}var D=o.sibling;if(D!==null){D.return=o.return,be=D;break}be=o.return}}var u8=Math.ceil,Qf=Zs.ReactCurrentDispatcher,Pv=Zs.ReactCurrentOwner,Vn=Zs.ReactCurrentBatchConfig,yt=0,$i=null,xi=null,nr=0,mn=0,Cl=Za(0),Gi=0,Pu=null,Zo=0,p_=0,kv=0,fu=null,Xr=null,Lv=0,Ul=1/0,Hs=null,$f=!1,jT=null,Ya=null,mf=!1,ja=null,Zf=0,_u=0,BT=null,Nf=-1,bf=0;function Nr(){return yt&6?Ni():Nf!==-1?Nf:Nf=Ni()}function qa(s){return s.mode&1?yt&2&&nr!==0?nr&-nr:q6.transition!==null?(bf===0&&(bf=hP()),bf):(s=Lt,s!==0||(s=window.event,s=s===void 0?16:SP(s.type)),s):1}function ts(s,o,d,f){if(50<_u)throw _u=0,BT=null,Error(Te(185));Uu(s,d,f),(!(yt&2)||s!==$i)&&(s===$i&&(!(yt&2)&&(p_|=d),Gi===4&&Va(s,nr)),en(s,f),d===1&&yt===0&&!(o.mode&1)&&(Ul=Ni()+500,l_&&eo()))}function en(s,o){var d=s.callbackNode;qW(s,o);var f=Uf(s,s===$i?nr:0);if(f===0)d!==null&&yb(d),s.callbackNode=null,s.callbackPriority=0;else if(o=f&-f,s.callbackPriority!==o){if(d!=null&&yb(d),o===1)s.tag===0?Y6(fD.bind(null,s)):VP(fD.bind(null,s)),W6(function(){!(yt&6)&&eo()}),d=null;else{switch(pP(f)){case 1:d=av;break;case 4:d=dP;break;case 16:d=Mf;break;case 536870912:d=uP;break;default:d=Mf}d=xk(d,bk.bind(null,s))}s.callbackPriority=o,s.callbackNode=d}}function bk(s,o){if(Nf=-1,bf=0,yt&6)throw Error(Te(327));var d=s.callbackNode;if(Nl()&&s.callbackNode!==d)return null;var f=Uf(s,s===$i?nr:0);if(f===0)return null;if(f&30||f&s.expiredLanes||o)o=e_(s,f);else{o=f;var m=yt;yt|=2;var v=Pk();($i!==s||nr!==o)&&(Hs=null,Ul=Ni()+500,Yo(s,o));do try{f8();break}catch(D){Dk(s,D)}while(!0);Sv(),Qf.current=v,yt=m,xi!==null?o=0:($i=null,nr=0,o=Gi)}if(o!==0){if(o===2&&(m=fT(s),m!==0&&(f=m,o=GT(s,m))),o===1)throw d=Pu,Yo(s,0),Va(s,f),en(s,Ni()),d;if(o===6)Va(s,f);else{if(m=s.current.alternate,!(f&30)&&!h8(m)&&(o=e_(s,f),o===2&&(v=fT(s),v!==0&&(f=v,o=GT(s,v))),o===1))throw d=Pu,Yo(s,0),Va(s,f),en(s,Ni()),d;switch(s.finishedWork=m,s.finishedLanes=f,o){case 0:case 1:throw Error(Te(345));case 2:Wo(s,Xr,Hs);break;case 3:if(Va(s,f),(f&130023424)===f&&(o=Lv+500-Ni(),10<o)){if(Uf(s,0)!==0)break;if(m=s.suspendedLanes,(m&f)!==f){Nr(),s.pingedLanes|=s.suspendedLanes&m;break}s.timeoutHandle=yT(Wo.bind(null,s,Xr,Hs),o);break}Wo(s,Xr,Hs);break;case 4:if(Va(s,f),(f&4194240)===f)break;for(o=s.eventTimes,m=-1;0<f;){var I=31-es(f);v=1<<I,I=o[I],I>m&&(m=I),f&=~v}if(f=m,f=Ni()-f,f=(120>f?120:480>f?480:1080>f?1080:1920>f?1920:3e3>f?3e3:4320>f?4320:1960*u8(f/1960))-f,10<f){s.timeoutHandle=yT(Wo.bind(null,s,Xr,Hs),f);break}Wo(s,Xr,Hs);break;case 5:Wo(s,Xr,Hs);break;default:throw Error(Te(329))}}}return en(s,Ni()),s.callbackNode===d?bk.bind(null,s):null}function GT(s,o){var d=fu;return s.current.memoizedState.isDehydrated&&(Yo(s,o).flags|=256),s=e_(s,o),s!==2&&(o=Xr,Xr=d,o!==null&&WT(o)),s}function WT(s){Xr===null?Xr=s:Xr.push.apply(Xr,s)}function h8(s){for(var o=s;;){if(o.flags&16384){var d=o.updateQueue;if(d!==null&&(d=d.stores,d!==null))for(var f=0;f<d.length;f++){var m=d[f],v=m.getSnapshot;m=m.value;try{if(!is(v(),m))return!1}catch{return!1}}}if(d=o.child,o.subtreeFlags&16384&&d!==null)d.return=o,o=d;else{if(o===s)break;for(;o.sibling===null;){if(o.return===null||o.return===s)return!0;o=o.return}o.sibling.return=o.return,o=o.sibling}}return!0}function Va(s,o){for(o&=~kv,o&=~p_,s.suspendedLanes|=o,s.pingedLanes&=~o,s=s.expirationTimes;0<o;){var d=31-es(o),f=1<<d;s[d]=-1,o&=~f}}function fD(s){if(yt&6)throw Error(Te(327));Nl();var o=Uf(s,0);if(!(o&1))return en(s,Ni()),null;var d=e_(s,o);if(s.tag!==0&&d===2){var f=fT(s);f!==0&&(o=f,d=GT(s,f))}if(d===1)throw d=Pu,Yo(s,0),Va(s,o),en(s,Ni()),d;if(d===6)throw Error(Te(345));return s.finishedWork=s.current.alternate,s.finishedLanes=o,Wo(s,Xr,Hs),en(s,Ni()),null}function Mv(s,o){var d=yt;yt|=1;try{return s(o)}finally{yt=d,yt===0&&(Ul=Ni()+500,l_&&eo())}}function ec(s){ja!==null&&ja.tag===0&&!(yt&6)&&Nl();var o=yt;yt|=1;var d=Vn.transition,f=Lt;try{if(Vn.transition=null,Lt=1,s)return s()}finally{Lt=f,Vn.transition=d,yt=o,!(yt&6)&&eo()}}function Uv(){mn=Cl.current,ti(Cl)}function Yo(s,o){s.finishedWork=null,s.finishedLanes=0;var d=s.timeoutHandle;if(d!==-1&&(s.timeoutHandle=-1,G6(d)),xi!==null)for(d=xi.return;d!==null;){var f=d;switch(mv(f),f.tag){case 1:f=f.type.childContextTypes,f!=null&&Bf();break;case 3:Ll(),ti($r),ti(vr),Iv();break;case 5:Rv(f);break;case 4:Ll();break;case 13:ti(fi);break;case 19:ti(fi);break;case 10:Tv(f.type._context);break;case 22:case 23:Uv()}d=d.return}if($i=s,xi=s=Ja(s.current,null),nr=mn=o,Gi=0,Pu=null,kv=p_=Zo=0,Xr=fu=null,Ko!==null){for(o=0;o<Ko.length;o++)if(d=Ko[o],f=d.interleaved,f!==null){d.interleaved=null;var m=f.next,v=d.pending;if(v!==null){var I=v.next;v.next=m,f.next=I}d.pending=f}Ko=null}return s}function Dk(s,o){do{var d=xi;try{if(Sv(),wf.current=Xf,Jf){for(var f=_i.memoizedState;f!==null;){var m=f.queue;m!==null&&(m.pending=null),f=f.next}Jf=!1}if($o=0,Qi=Bi=_i=null,hu=!1,Nu=0,Pv.current=null,d===null||d.return===null){Gi=1,Pu=o,xi=null;break}e:{var v=s,I=d.return,D=d,L=o;if(o=nr,D.flags|=32768,L!==null&&typeof L=="object"&&typeof L.then=="function"){var V=L,q=D,H=q.tag;if(!(q.mode&1)&&(H===0||H===11||H===15)){var te=q.alternate;te?(q.updateQueue=te.updateQueue,q.memoizedState=te.memoizedState,q.lanes=te.lanes):(q.updateQueue=null,q.memoizedState=null)}var de=tD(I);if(de!==null){de.flags&=-257,iD(de,I,D,v,o),de.mode&1&&eD(v,V,o),o=de,L=V;var pe=o.updateQueue;if(pe===null){var ee=new Set;ee.add(L),o.updateQueue=ee}else pe.add(L);break e}else{if(!(o&1)){eD(v,V,o),xv();break e}L=Error(Te(426))}}else if(ui&&D.mode&1){var ae=tD(I);if(ae!==null){!(ae.flags&65536)&&(ae.flags|=256),iD(ae,I,D,v,o),Ev(Ml(L,D));break e}}v=L=Ml(L,D),Gi!==4&&(Gi=2),fu===null?fu=[v]:fu.push(v),v=I;do{switch(v.tag){case 3:v.flags|=65536,o&=-o,v.lanes|=o;var K=fk(v,L,o);Yb(v,K);break e;case 1:D=L;var G=v.type,Q=v.stateNode;if(!(v.flags&128)&&(typeof G.getDerivedStateFromError=="function"||Q!==null&&typeof Q.componentDidCatch=="function"&&(Ya===null||!Ya.has(Q)))){v.flags|=65536,o&=-o,v.lanes|=o;var _e=_k(v,D,o);Yb(v,_e);break e}}v=v.return}while(v!==null)}Lk(d)}catch(Re){o=Re,xi===d&&d!==null&&(xi=d=d.return);continue}break}while(!0)}function Pk(){var s=Qf.current;return Qf.current=Xf,s===null?Xf:s}function xv(){(Gi===0||Gi===3||Gi===2)&&(Gi=4),$i===null||!(Zo&268435455)&&!(p_&268435455)||Va($i,nr)}function e_(s,o){var d=yt;yt|=2;var f=Pk();($i!==s||nr!==o)&&(Hs=null,Yo(s,o));do try{p8();break}catch(m){Dk(s,m)}while(!0);if(Sv(),yt=d,Qf.current=f,xi!==null)throw Error(Te(261));return $i=null,nr=0,Gi}function p8(){for(;xi!==null;)kk(xi)}function f8(){for(;xi!==null&&!FW();)kk(xi)}function kk(s){var o=Uk(s.alternate,s,mn);s.memoizedProps=s.pendingProps,o===null?Lk(s):xi=o,Pv.current=null}function Lk(s){var o=s;do{var d=o.alternate;if(s=o.return,o.flags&32768){if(d=o8(d,o),d!==null){d.flags&=32767,xi=d;return}if(s!==null)s.flags|=32768,s.subtreeFlags=0,s.deletions=null;else{Gi=6,xi=null;return}}else if(d=a8(d,o,mn),d!==null){xi=d;return}if(o=o.sibling,o!==null){xi=o;return}xi=o=s}while(o!==null);Gi===0&&(Gi=5)}function Wo(s,o,d){var f=Lt,m=Vn.transition;try{Vn.transition=null,Lt=1,_8(s,o,d,f)}finally{Vn.transition=m,Lt=f}return null}function _8(s,o,d,f){do Nl();while(ja!==null);if(yt&6)throw Error(Te(327));d=s.finishedWork;var m=s.finishedLanes;if(d===null)return null;if(s.finishedWork=null,s.finishedLanes=0,d===s.current)throw Error(Te(177));s.callbackNode=null,s.callbackPriority=0;var v=d.lanes|d.childLanes;if(JW(s,v),s===$i&&(xi=$i=null,nr=0),!(d.subtreeFlags&2064)&&!(d.flags&2064)||mf||(mf=!0,xk(Mf,function(){return Nl(),null})),v=(d.flags&15990)!==0,d.subtreeFlags&15990||v){v=Vn.transition,Vn.transition=null;var I=Lt;Lt=1;var D=yt;yt|=4,Pv.current=null,l8(s,d),Ok(d,s),M6(TT),xf=!!ST,TT=ST=null,s.current=d,d8(d),jW(),yt=D,Lt=I,Vn.transition=v}else s.current=d;if(mf&&(mf=!1,ja=s,Zf=m),v=s.pendingLanes,v===0&&(Ya=null),WW(d.stateNode),en(s,Ni()),o!==null)for(f=s.onRecoverableError,d=0;d<o.length;d++)m=o[d],f(m.value,{componentStack:m.stack,digest:m.digest});if($f)throw $f=!1,s=jT,jT=null,s;return Zf&1&&s.tag!==0&&Nl(),v=s.pendingLanes,v&1?s===BT?_u++:(_u=0,BT=s):_u=0,eo(),null}function Nl(){if(ja!==null){var s=pP(Zf),o=Vn.transition,d=Lt;try{if(Vn.transition=null,Lt=16>s?16:s,ja===null)var f=!1;else{if(s=ja,ja=null,Zf=0,yt&6)throw Error(Te(331));var m=yt;for(yt|=4,be=s.current;be!==null;){var v=be,I=v.child;if(be.flags&16){var D=v.deletions;if(D!==null){for(var L=0;L<D.length;L++){var V=D[L];for(be=V;be!==null;){var q=be;switch(q.tag){case 0:case 11:case 15:pu(8,q,v)}var H=q.child;if(H!==null)H.return=q,be=H;else for(;be!==null;){q=be;var te=q.sibling,de=q.return;if(Ik(q),q===V){be=null;break}if(te!==null){te.return=de,be=te;break}be=de}}}var pe=v.alternate;if(pe!==null){var ee=pe.child;if(ee!==null){pe.child=null;do{var ae=ee.sibling;ee.sibling=null,ee=ae}while(ee!==null)}}be=v}}if(v.subtreeFlags&2064&&I!==null)I.return=v,be=I;else e:for(;be!==null;){if(v=be,v.flags&2048)switch(v.tag){case 0:case 11:case 15:pu(9,v,v.return)}var K=v.sibling;if(K!==null){K.return=v.return,be=K;break e}be=v.return}}var G=s.current;for(be=G;be!==null;){I=be;var Q=I.child;if(I.subtreeFlags&2064&&Q!==null)Q.return=I,be=Q;else e:for(I=G;be!==null;){if(D=be,D.flags&2048)try{switch(D.tag){case 0:case 11:case 15:h_(9,D)}}catch(Re){Ti(D,D.return,Re)}if(D===I){be=null;break e}var _e=D.sibling;if(_e!==null){_e.return=D.return,be=_e;break e}be=D.return}}if(yt=m,eo(),As&&typeof As.onPostCommitFiberRoot=="function")try{As.onPostCommitFiberRoot(n_,s)}catch{}f=!0}return f}finally{Lt=d,Vn.transition=o}}return!1}function _D(s,o,d){o=Ml(d,o),o=fk(s,o,1),s=za(s,o,1),o=Nr(),s!==null&&(Uu(s,1,o),en(s,o))}function Ti(s,o,d){if(s.tag===3)_D(s,s,d);else for(;o!==null;){if(o.tag===3){_D(o,s,d);break}else if(o.tag===1){var f=o.stateNode;if(typeof o.type.getDerivedStateFromError=="function"||typeof f.componentDidCatch=="function"&&(Ya===null||!Ya.has(f))){s=Ml(d,s),s=_k(o,s,1),o=za(o,s,1),s=Nr(),o!==null&&(Uu(o,1,s),en(o,s));break}}o=o.return}}function m8(s,o,d){var f=s.pingCache;f!==null&&f.delete(o),o=Nr(),s.pingedLanes|=s.suspendedLanes&d,$i===s&&(nr&d)===d&&(Gi===4||Gi===3&&(nr&130023424)===nr&&500>Ni()-Lv?Yo(s,0):kv|=d),en(s,o)}function Mk(s,o){o===0&&(s.mode&1?(o=af,af<<=1,!(af&130023424)&&(af=4194304)):o=1);var d=Nr();s=Qs(s,o),s!==null&&(Uu(s,o,d),en(s,d))}function E8(s){var o=s.memoizedState,d=0;o!==null&&(d=o.retryLane),Mk(s,d)}function g8(s,o){var d=0;switch(s.tag){case 13:var f=s.stateNode,m=s.memoizedState;m!==null&&(d=m.retryLane);break;case 19:f=s.stateNode;break;default:throw Error(Te(314))}f!==null&&f.delete(o),Mk(s,d)}var Uk;Uk=function(s,o,d){if(s!==null)if(s.memoizedProps!==o.pendingProps||$r.current)Qr=!0;else{if(!(s.lanes&d)&&!(o.flags&128))return Qr=!1,s8(s,o,d);Qr=!!(s.flags&131072)}else Qr=!1,ui&&o.flags&1048576&&FP(o,Hf,o.index);switch(o.lanes=0,o.tag){case 2:var f=o.type;Of(s,o),s=o.pendingProps;var m=Dl(o,vr.current);Ol(o,d),m=Av(null,o,f,s,m,d);var v=Ov();return o.flags|=1,typeof m=="object"&&m!==null&&typeof m.render=="function"&&m.$$typeof===void 0?(o.tag=1,o.memoizedState=null,o.updateQueue=null,Zr(f)?(v=!0,Gf(o)):v=!1,o.memoizedState=m.state!==null&&m.state!==void 0?m.state:null,yv(o),m.updater=d_,o.stateNode=m,m._reactInternals=o,NT(o,f,s,d),o=PT(null,o,f,!0,v,d)):(o.tag=0,ui&&v&&_v(o),Or(null,o,m,d),o=o.child),o;case 16:f=o.elementType;e:{switch(Of(s,o),s=o.pendingProps,m=f._init,f=m(f._payload),o.type=f,m=o.tag=T8(f),s=Qn(f,s),m){case 0:o=DT(null,o,f,s,d);break e;case 1:o=sD(null,o,f,s,d);break e;case 11:o=rD(null,o,f,s,d);break e;case 14:o=nD(null,o,f,Qn(f.type,s),d);break e}throw Error(Te(306,f,""))}return o;case 0:return f=o.type,m=o.pendingProps,m=o.elementType===f?m:Qn(f,m),DT(s,o,f,m,d);case 1:return f=o.type,m=o.pendingProps,m=o.elementType===f?m:Qn(f,m),sD(s,o,f,m,d);case 3:e:{if(Sk(o),s===null)throw Error(Te(387));f=o.pendingProps,v=o.memoizedState,m=v.element,WP(s,o),Yf(o,f,null,d);var I=o.memoizedState;if(f=I.element,v.isDehydrated)if(v={element:f,isDehydrated:!1,cache:I.cache,pendingSuspenseBoundaries:I.pendingSuspenseBoundaries,transitions:I.transitions},o.updateQueue.baseState=v,o.memoizedState=v,o.flags&256){m=Ml(Error(Te(423)),o),o=aD(s,o,f,d,m);break e}else if(f!==m){m=Ml(Error(Te(424)),o),o=aD(s,o,f,d,m);break e}else for(En=Ka(o.stateNode.containerInfo.firstChild),gn=o,ui=!0,Zn=null,d=YP(o,null,f,d),o.child=d;d;)d.flags=d.flags&-3|4096,d=d.sibling;else{if(Pl(),f===m){o=$s(s,o,d);break e}Or(s,o,f,d)}o=o.child}return o;case 5:return qP(o),s===null&&wT(o),f=o.type,m=o.pendingProps,v=s!==null?s.memoizedProps:null,I=m.children,vT(f,m)?I=null:v!==null&&vT(f,v)&&(o.flags|=32),gk(s,o),Or(s,o,I,d),o.child;case 6:return s===null&&wT(o),null;case 13:return Tk(s,o,d);case 4:return Cv(o,o.stateNode.containerInfo),f=o.pendingProps,s===null?o.child=kl(o,null,f,d):Or(s,o,f,d),o.child;case 11:return f=o.type,m=o.pendingProps,m=o.elementType===f?m:Qn(f,m),rD(s,o,f,m,d);case 7:return Or(s,o,o.pendingProps,d),o.child;case 8:return Or(s,o,o.pendingProps.children,d),o.child;case 12:return Or(s,o,o.pendingProps.children,d),o.child;case 10:e:{if(f=o.type._context,m=o.pendingProps,v=o.memoizedProps,I=m.value,qt(Kf,f._currentValue),f._currentValue=I,v!==null)if(is(v.value,I)){if(v.children===m.children&&!$r.current){o=$s(s,o,d);break e}}else for(v=o.child,v!==null&&(v.return=o);v!==null;){var D=v.dependencies;if(D!==null){I=v.child;for(var L=D.firstContext;L!==null;){if(L.context===f){if(v.tag===1){L=qs(-1,d&-d),L.tag=2;var V=v.updateQueue;if(V!==null){V=V.shared;var q=V.pending;q===null?L.next=L:(L.next=q.next,q.next=L),V.pending=L}}v.lanes|=d,L=v.alternate,L!==null&&(L.lanes|=d),AT(v.return,d,o),D.lanes|=d;break}L=L.next}}else if(v.tag===10)I=v.type===o.type?null:v.child;else if(v.tag===18){if(I=v.return,I===null)throw Error(Te(341));I.lanes|=d,D=I.alternate,D!==null&&(D.lanes|=d),AT(I,d,o),I=v.sibling}else I=v.child;if(I!==null)I.return=v;else for(I=v;I!==null;){if(I===o){I=null;break}if(v=I.sibling,v!==null){v.return=I.return,I=v;break}I=I.return}v=I}Or(s,o,m.children,d),o=o.child}return o;case 9:return m=o.type,f=o.pendingProps.children,Ol(o,d),m=Fn(m),f=f(m),o.flags|=1,Or(s,o,f,d),o.child;case 14:return f=o.type,m=Qn(f,o.pendingProps),m=Qn(f.type,m),nD(s,o,f,m,d);case 15:return mk(s,o,o.type,o.pendingProps,d);case 17:return f=o.type,m=o.pendingProps,m=o.elementType===f?m:Qn(f,m),Of(s,o),o.tag=1,Zr(f)?(s=!0,Gf(o)):s=!1,Ol(o,d),KP(o,f,m),NT(o,f,m,d),PT(null,o,f,!0,s,d);case 19:return vk(s,o,d);case 22:return Ek(s,o,d)}throw Error(Te(156,o.tag))};function xk(s,o){return lP(s,o)}function S8(s,o,d,f){this.tag=s,this.key=d,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=o,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=f,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function xn(s,o,d,f){return new S8(s,o,d,f)}function Vv(s){return s=s.prototype,!(!s||!s.isReactComponent)}function T8(s){if(typeof s=="function")return Vv(s)?1:0;if(s!=null){if(s=s.$$typeof,s===rv)return 11;if(s===nv)return 14}return 2}function Ja(s,o){var d=s.alternate;return d===null?(d=xn(s.tag,o,s.key,s.mode),d.elementType=s.elementType,d.type=s.type,d.stateNode=s.stateNode,d.alternate=s,s.alternate=d):(d.pendingProps=o,d.type=s.type,d.flags=0,d.subtreeFlags=0,d.deletions=null),d.flags=s.flags&14680064,d.childLanes=s.childLanes,d.lanes=s.lanes,d.child=s.child,d.memoizedProps=s.memoizedProps,d.memoizedState=s.memoizedState,d.updateQueue=s.updateQueue,o=s.dependencies,d.dependencies=o===null?null:{lanes:o.lanes,firstContext:o.firstContext},d.sibling=s.sibling,d.index=s.index,d.ref=s.ref,d}function Df(s,o,d,f,m,v){var I=2;if(f=s,typeof s=="function")Vv(s)&&(I=1);else if(typeof s=="string")I=5;else e:switch(s){case pl:return qo(d.children,m,v,o);case iv:I=8,m|=8;break;case ZS:return s=xn(12,d,o,m|2),s.elementType=ZS,s.lanes=v,s;case eT:return s=xn(13,d,o,m),s.elementType=eT,s.lanes=v,s;case tT:return s=xn(19,d,o,m),s.elementType=tT,s.lanes=v,s;case zD:return f_(d,m,v,o);default:if(typeof s=="object"&&s!==null)switch(s.$$typeof){case HD:I=10;break e;case KD:I=9;break e;case rv:I=11;break e;case nv:I=14;break e;case Ma:I=16,f=null;break e}throw Error(Te(130,s==null?s:typeof s,""))}return o=xn(I,d,o,m),o.elementType=s,o.type=f,o.lanes=v,o}function qo(s,o,d,f){return s=xn(7,s,f,o),s.lanes=d,s}function f_(s,o,d,f){return s=xn(22,s,f,o),s.elementType=zD,s.lanes=d,s.stateNode={isHidden:!1},s}function zS(s,o,d){return s=xn(6,s,null,o),s.lanes=d,s}function YS(s,o,d){return o=xn(4,s.children!==null?s.children:[],s.key,o),o.lanes=d,o.stateNode={containerInfo:s.containerInfo,pendingChildren:null,implementation:s.implementation},o}function v8(s,o,d,f,m){this.tag=o,this.containerInfo=s,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=AS(0),this.expirationTimes=AS(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=AS(0),this.identifierPrefix=f,this.onRecoverableError=m,this.mutableSourceEagerHydrationData=null}function Fv(s,o,d,f,m,v,I,D,L){return s=new v8(s,o,d,D,L),o===1?(o=1,v===!0&&(o|=8)):o=0,v=xn(3,null,null,o),s.current=v,v.stateNode=s,v.memoizedState={element:f,isDehydrated:d,cache:null,transitions:null,pendingSuspenseBoundaries:null},yv(v),s}function y8(s,o,d){var f=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:hl,key:f==null?null:""+f,children:s,containerInfo:o,implementation:d}}function Vk(s){if(!s)return Qa;s=s._reactInternals;e:{if(ic(s)!==s||s.tag!==1)throw Error(Te(170));var o=s;do{switch(o.tag){case 3:o=o.stateNode.context;break e;case 1:if(Zr(o.type)){o=o.stateNode.__reactInternalMemoizedMergedChildContext;break e}}o=o.return}while(o!==null);throw Error(Te(171))}if(s.tag===1){var d=s.type;if(Zr(d))return xP(s,d,o)}return o}function Fk(s,o,d,f,m,v,I,D,L){return s=Fv(d,f,!0,s,m,v,I,D,L),s.context=Vk(null),d=s.current,f=Nr(),m=qa(d),v=qs(f,m),v.callback=o??null,za(d,v,m),s.current.lanes=m,Uu(s,m,f),en(s,f),s}function __(s,o,d,f){var m=o.current,v=Nr(),I=qa(m);return d=Vk(d),o.context===null?o.context=d:o.pendingContext=d,o=qs(v,I),o.payload={element:s},f=f===void 0?null:f,f!==null&&(o.callback=f),s=za(m,o,I),s!==null&&(ts(s,m,I,v),If(s,m,I)),I}function t_(s){if(s=s.current,!s.child)return null;switch(s.child.tag){case 5:return s.child.stateNode;default:return s.child.stateNode}}function mD(s,o){if(s=s.memoizedState,s!==null&&s.dehydrated!==null){var d=s.retryLane;s.retryLane=d!==0&&d<o?d:o}}function jv(s,o){mD(s,o),(s=s.alternate)&&mD(s,o)}function C8(){return null}var jk=typeof reportError=="function"?reportError:function(s){console.error(s)};function Bv(s){this._internalRoot=s}m_.prototype.render=Bv.prototype.render=function(s){var o=this._internalRoot;if(o===null)throw Error(Te(409));__(s,o,null,null)};m_.prototype.unmount=Bv.prototype.unmount=function(){var s=this._internalRoot;if(s!==null){this._internalRoot=null;var o=s.containerInfo;ec(function(){__(null,s,null,null)}),o[Xs]=null}};function m_(s){this._internalRoot=s}m_.prototype.unstable_scheduleHydration=function(s){if(s){var o=mP();s={blockedOn:null,target:s,priority:o};for(var d=0;d<xa.length&&o!==0&&o<xa[d].priority;d++);xa.splice(d,0,s),d===0&&gP(s)}};function Gv(s){return!(!s||s.nodeType!==1&&s.nodeType!==9&&s.nodeType!==11)}function E_(s){return!(!s||s.nodeType!==1&&s.nodeType!==9&&s.nodeType!==11&&(s.nodeType!==8||s.nodeValue!==" react-mount-point-unstable "))}function ED(){}function R8(s,o,d,f,m){if(m){if(typeof f=="function"){var v=f;f=function(){var V=t_(I);v.call(V)}}var I=Fk(o,f,s,0,null,!1,!1,"",ED);return s._reactRootContainer=I,s[Xs]=I.current,Ru(s.nodeType===8?s.parentNode:s),ec(),I}for(;m=s.lastChild;)s.removeChild(m);if(typeof f=="function"){var D=f;f=function(){var V=t_(L);D.call(V)}}var L=Fv(s,0,!1,null,null,!1,!1,"",ED);return s._reactRootContainer=L,s[Xs]=L.current,Ru(s.nodeType===8?s.parentNode:s),ec(function(){__(o,L,d,f)}),L}function g_(s,o,d,f,m){var v=d._reactRootContainer;if(v){var I=v;if(typeof m=="function"){var D=m;m=function(){var L=t_(I);D.call(L)}}__(o,I,s,m)}else I=R8(d,o,s,m,f);return t_(I)}fP=function(s){switch(s.tag){case 3:var o=s.stateNode;if(o.current.memoizedState.isDehydrated){var d=nu(o.pendingLanes);d!==0&&(ov(o,d|1),en(o,Ni()),!(yt&6)&&(Ul=Ni()+500,eo()))}break;case 13:ec(function(){var f=Qs(s,1);if(f!==null){var m=Nr();ts(f,s,1,m)}}),jv(s,1)}};cv=function(s){if(s.tag===13){var o=Qs(s,134217728);if(o!==null){var d=Nr();ts(o,s,134217728,d)}jv(s,134217728)}};_P=function(s){if(s.tag===13){var o=qa(s),d=Qs(s,o);if(d!==null){var f=Nr();ts(d,s,o,f)}jv(s,o)}};mP=function(){return Lt};EP=function(s,o){var d=Lt;try{return Lt=s,o()}finally{Lt=d}};uT=function(s,o,d){switch(o){case"input":if(nT(s,d),o=d.name,d.type==="radio"&&o!=null){for(d=s;d.parentNode;)d=d.parentNode;for(d=d.querySelectorAll("input[name="+JSON.stringify(""+o)+'][type="radio"]'),o=0;o<d.length;o++){var f=d[o];if(f!==s&&f.form===s.form){var m=c_(f);if(!m)throw Error(Te(90));qD(f),nT(f,m)}}}break;case"textarea":XD(s,d);break;case"select":o=d.value,o!=null&&Rl(s,!!d.multiple,o,!1)}};rP=Mv;nP=ec;var I8={usingClientEntryPoint:!1,Events:[Vu,El,c_,tP,iP,Mv]},tu={findFiberByHostInstance:Ho,bundleType:0,version:"18.2.0",rendererPackageName:"react-dom"},w8={bundleType:tu.bundleType,version:tu.version,rendererPackageName:tu.rendererPackageName,rendererConfig:tu.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Zs.ReactCurrentDispatcher,findHostInstanceByFiber:function(s){return s=oP(s),s===null?null:s.stateNode},findFiberByHostInstance:tu.findFiberByHostInstance||C8,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.2.0-next-9e3b772b8-20220608"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Ef=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Ef.isDisabled&&Ef.supportsFiber)try{n_=Ef.inject(w8),As=Ef}catch{}}Tn.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=I8;Tn.createPortal=function(s,o){var d=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!Gv(o))throw Error(Te(200));return y8(s,o,null,d)};Tn.createRoot=function(s,o){if(!Gv(s))throw Error(Te(299));var d=!1,f="",m=jk;return o!=null&&(o.unstable_strictMode===!0&&(d=!0),o.identifierPrefix!==void 0&&(f=o.identifierPrefix),o.onRecoverableError!==void 0&&(m=o.onRecoverableError)),o=Fv(s,1,!1,null,null,d,!1,f,m),s[Xs]=o.current,Ru(s.nodeType===8?s.parentNode:s),new Bv(o)};Tn.findDOMNode=function(s){if(s==null)return null;if(s.nodeType===1)return s;var o=s._reactInternals;if(o===void 0)throw typeof s.render=="function"?Error(Te(188)):(s=Object.keys(s).join(","),Error(Te(268,s)));return s=oP(o),s=s===null?null:s.stateNode,s};Tn.flushSync=function(s){return ec(s)};Tn.hydrate=function(s,o,d){if(!E_(o))throw Error(Te(200));return g_(null,s,o,!0,d)};Tn.hydrateRoot=function(s,o,d){if(!Gv(s))throw Error(Te(405));var f=d!=null&&d.hydratedSources||null,m=!1,v="",I=jk;if(d!=null&&(d.unstable_strictMode===!0&&(m=!0),d.identifierPrefix!==void 0&&(v=d.identifierPrefix),d.onRecoverableError!==void 0&&(I=d.onRecoverableError)),o=Fk(o,null,s,1,d??null,m,!1,v,I),s[Xs]=o.current,Ru(s),f)for(s=0;s<f.length;s++)d=f[s],m=d._getVersion,m=m(d._source),o.mutableSourceEagerHydrationData==null?o.mutableSourceEagerHydrationData=[d,m]:o.mutableSourceEagerHydrationData.push(d,m);return new m_(o)};Tn.render=function(s,o,d){if(!E_(o))throw Error(Te(200));return g_(null,s,o,!1,d)};Tn.unmountComponentAtNode=function(s){if(!E_(s))throw Error(Te(40));return s._reactRootContainer?(ec(function(){g_(null,null,s,!1,function(){s._reactRootContainer=null,s[Xs]=null})}),!0):!1};Tn.unstable_batchedUpdates=Mv;Tn.unstable_renderSubtreeIntoContainer=function(s,o,d,f){if(!E_(d))throw Error(Te(200));if(s==null||s._reactInternals===void 0)throw Error(Te(38));return g_(s,o,d,!1,f)};Tn.version="18.2.0-next-9e3b772b8-20220608";function Bk(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(Bk)}catch(s){console.error(s)}}Bk(),FD.exports=Tn;var A8=FD.exports,gD=A8;QS.createRoot=gD.createRoot,QS.hydrateRoot=gD.hydrateRoot;/**
 * @remix-run/router v1.14.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function ku(){return ku=Object.assign?Object.assign.bind():function(s){for(var o=1;o<arguments.length;o++){var d=arguments[o];for(var f in d)Object.prototype.hasOwnProperty.call(d,f)&&(s[f]=d[f])}return s},ku.apply(this,arguments)}var Ba;(function(s){s.Pop="POP",s.Push="PUSH",s.Replace="REPLACE"})(Ba||(Ba={}));const SD="popstate";function O8(s){s===void 0&&(s={});function o(f,m){let{pathname:v,search:I,hash:D}=f.location;return HT("",{pathname:v,search:I,hash:D},m.state&&m.state.usr||null,m.state&&m.state.key||"default")}function d(f,m){return typeof m=="string"?m:Gk(m)}return b8(o,d,null,s)}function Wi(s,o){if(s===!1||s===null||typeof s>"u")throw new Error(o)}function Wv(s,o){if(!s){typeof console<"u"&&console.warn(o);try{throw new Error(o)}catch{}}}function N8(){return Math.random().toString(36).substr(2,8)}function TD(s,o){return{usr:s.state,key:s.key,idx:o}}function HT(s,o,d,f){return d===void 0&&(d=null),ku({pathname:typeof s=="string"?s:s.pathname,search:"",hash:""},typeof o=="string"?jl(o):o,{state:d,key:o&&o.key||f||N8()})}function Gk(s){let{pathname:o="/",search:d="",hash:f=""}=s;return d&&d!=="?"&&(o+=d.charAt(0)==="?"?d:"?"+d),f&&f!=="#"&&(o+=f.charAt(0)==="#"?f:"#"+f),o}function jl(s){let o={};if(s){let d=s.indexOf("#");d>=0&&(o.hash=s.substr(d),s=s.substr(0,d));let f=s.indexOf("?");f>=0&&(o.search=s.substr(f),s=s.substr(0,f)),s&&(o.pathname=s)}return o}function b8(s,o,d,f){f===void 0&&(f={});let{window:m=document.defaultView,v5Compat:v=!1}=f,I=m.history,D=Ba.Pop,L=null,V=q();V==null&&(V=0,I.replaceState(ku({},I.state,{idx:V}),""));function q(){return(I.state||{idx:null}).idx}function H(){D=Ba.Pop;let ae=q(),K=ae==null?null:ae-V;V=ae,L&&L({action:D,location:ee.location,delta:K})}function te(ae,K){D=Ba.Push;let G=HT(ee.location,ae,K);d&&d(G,ae),V=q()+1;let Q=TD(G,V),_e=ee.createHref(G);try{I.pushState(Q,"",_e)}catch(Re){if(Re instanceof DOMException&&Re.name==="DataCloneError")throw Re;m.location.assign(_e)}v&&L&&L({action:D,location:ee.location,delta:1})}function de(ae,K){D=Ba.Replace;let G=HT(ee.location,ae,K);d&&d(G,ae),V=q();let Q=TD(G,V),_e=ee.createHref(G);I.replaceState(Q,"",_e),v&&L&&L({action:D,location:ee.location,delta:0})}function pe(ae){let K=m.location.origin!=="null"?m.location.origin:m.location.href,G=typeof ae=="string"?ae:Gk(ae);return Wi(K,"No window.location.(origin|href) available to create URL for href: "+G),new URL(G,K)}let ee={get action(){return D},get location(){return s(m,I)},listen(ae){if(L)throw new Error("A history only accepts one active listener");return m.addEventListener(SD,H),L=ae,()=>{m.removeEventListener(SD,H),L=null}},createHref(ae){return o(m,ae)},createURL:pe,encodeLocation(ae){let K=pe(ae);return{pathname:K.pathname,search:K.search,hash:K.hash}},push:te,replace:de,go(ae){return I.go(ae)}};return ee}var vD;(function(s){s.data="data",s.deferred="deferred",s.redirect="redirect",s.error="error"})(vD||(vD={}));function D8(s,o,d){d===void 0&&(d="/");let f=typeof o=="string"?jl(o):o,m=Kk(f.pathname||"/",d);if(m==null)return null;let v=Wk(s);P8(v);let I=null;for(let D=0;I==null&&D<v.length;++D)I=B8(v[D],H8(m));return I}function Wk(s,o,d,f){o===void 0&&(o=[]),d===void 0&&(d=[]),f===void 0&&(f="");let m=(v,I,D)=>{let L={relativePath:D===void 0?v.path||"":D,caseSensitive:v.caseSensitive===!0,childrenIndex:I,route:v};L.relativePath.startsWith("/")&&(Wi(L.relativePath.startsWith(f),'Absolute route path "'+L.relativePath+'" nested under path '+('"'+f+'" is not valid. An absolute child route path ')+"must start with the combined path of all its parent routes."),L.relativePath=L.relativePath.slice(f.length));let V=Jo([f,L.relativePath]),q=d.concat(L);v.children&&v.children.length>0&&(Wi(v.index!==!0,"Index routes must not have child routes. Please remove "+('all child routes from route path "'+V+'".')),Wk(v.children,o,q,V)),!(v.path==null&&!v.index)&&o.push({path:V,score:F8(V,v.index),routesMeta:q})};return s.forEach((v,I)=>{var D;if(v.path===""||!((D=v.path)!=null&&D.includes("?")))m(v,I);else for(let L of Hk(v.path))m(v,I,L)}),o}function Hk(s){let o=s.split("/");if(o.length===0)return[];let[d,...f]=o,m=d.endsWith("?"),v=d.replace(/\?$/,"");if(f.length===0)return m?[v,""]:[v];let I=Hk(f.join("/")),D=[];return D.push(...I.map(L=>L===""?v:[v,L].join("/"))),m&&D.push(...I),D.map(L=>s.startsWith("/")&&L===""?"/":L)}function P8(s){s.sort((o,d)=>o.score!==d.score?d.score-o.score:j8(o.routesMeta.map(f=>f.childrenIndex),d.routesMeta.map(f=>f.childrenIndex)))}const k8=/^:\w+$/,L8=3,M8=2,U8=1,x8=10,V8=-2,yD=s=>s==="*";function F8(s,o){let d=s.split("/"),f=d.length;return d.some(yD)&&(f+=V8),o&&(f+=M8),d.filter(m=>!yD(m)).reduce((m,v)=>m+(k8.test(v)?L8:v===""?U8:x8),f)}function j8(s,o){return s.length===o.length&&s.slice(0,-1).every((f,m)=>f===o[m])?s[s.length-1]-o[o.length-1]:0}function B8(s,o){let{routesMeta:d}=s,f={},m="/",v=[];for(let I=0;I<d.length;++I){let D=d[I],L=I===d.length-1,V=m==="/"?o:o.slice(m.length)||"/",q=G8({path:D.relativePath,caseSensitive:D.caseSensitive,end:L},V);if(!q)return null;Object.assign(f,q.params);let H=D.route;v.push({params:f,pathname:Jo([m,q.pathname]),pathnameBase:Q8(Jo([m,q.pathnameBase])),route:H}),q.pathnameBase!=="/"&&(m=Jo([m,q.pathnameBase]))}return v}function G8(s,o){typeof s=="string"&&(s={path:s,caseSensitive:!1,end:!0});let[d,f]=W8(s.path,s.caseSensitive,s.end),m=o.match(d);if(!m)return null;let v=m[0],I=v.replace(/(.)\/+$/,"$1"),D=m.slice(1);return{params:f.reduce((V,q,H)=>{let{paramName:te,isOptional:de}=q;if(te==="*"){let ee=D[H]||"";I=v.slice(0,v.length-ee.length).replace(/(.)\/+$/,"$1")}const pe=D[H];return de&&!pe?V[te]=void 0:V[te]=K8(pe||"",te),V},{}),pathname:v,pathnameBase:I,pattern:s}}function W8(s,o,d){o===void 0&&(o=!1),d===void 0&&(d=!0),Wv(s==="*"||!s.endsWith("*")||s.endsWith("/*"),'Route path "'+s+'" will be treated as if it were '+('"'+s.replace(/\*$/,"/*")+'" because the `*` character must ')+"always follow a `/` in the pattern. To get rid of this warning, "+('please change the route path to "'+s.replace(/\*$/,"/*")+'".'));let f=[],m="^"+s.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:(\w+)(\?)?/g,(I,D,L)=>(f.push({paramName:D,isOptional:L!=null}),L?"/?([^\\/]+)?":"/([^\\/]+)"));return s.endsWith("*")?(f.push({paramName:"*"}),m+=s==="*"||s==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):d?m+="\\/*$":s!==""&&s!=="/"&&(m+="(?:(?=\\/|$))"),[new RegExp(m,o?void 0:"i"),f]}function H8(s){try{return decodeURI(s)}catch(o){return Wv(!1,'The URL path "'+s+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent '+("encoding ("+o+").")),s}}function K8(s,o){try{return decodeURIComponent(s)}catch(d){return Wv(!1,'The value for the URL param "'+o+'" will not be decoded because'+(' the string "'+s+'" is a malformed URL segment. This is probably')+(" due to a bad percent encoding ("+d+").")),s}}function Kk(s,o){if(o==="/")return s;if(!s.toLowerCase().startsWith(o.toLowerCase()))return null;let d=o.endsWith("/")?o.length-1:o.length,f=s.charAt(d);return f&&f!=="/"?null:s.slice(d)||"/"}function z8(s,o){o===void 0&&(o="/");let{pathname:d,search:f="",hash:m=""}=typeof s=="string"?jl(s):s;return{pathname:d?d.startsWith("/")?d:Y8(d,o):o,search:$8(f),hash:Z8(m)}}function Y8(s,o){let d=o.replace(/\/+$/,"").split("/");return s.split("/").forEach(m=>{m===".."?d.length>1&&d.pop():m!=="."&&d.push(m)}),d.length>1?d.join("/"):"/"}function qS(s,o,d,f){return"Cannot include a '"+s+"' character in a manually specified "+("`to."+o+"` field ["+JSON.stringify(f)+"].  Please separate it out to the ")+("`to."+d+"` field. Alternatively you may provide the full path as ")+'a string in <Link to="..."> and the router will parse it for you.'}function q8(s){return s.filter((o,d)=>d===0||o.route.path&&o.route.path.length>0)}function J8(s,o){let d=q8(s);return o?d.map((f,m)=>m===s.length-1?f.pathname:f.pathnameBase):d.map(f=>f.pathnameBase)}function X8(s,o,d,f){f===void 0&&(f=!1);let m;typeof s=="string"?m=jl(s):(m=ku({},s),Wi(!m.pathname||!m.pathname.includes("?"),qS("?","pathname","search",m)),Wi(!m.pathname||!m.pathname.includes("#"),qS("#","pathname","hash",m)),Wi(!m.search||!m.search.includes("#"),qS("#","search","hash",m)));let v=s===""||m.pathname==="",I=v?"/":m.pathname,D;if(I==null)D=d;else{let H=o.length-1;if(!f&&I.startsWith("..")){let te=I.split("/");for(;te[0]==="..";)te.shift(),H-=1;m.pathname=te.join("/")}D=H>=0?o[H]:"/"}let L=z8(m,D),V=I&&I!=="/"&&I.endsWith("/"),q=(v||I===".")&&d.endsWith("/");return!L.pathname.endsWith("/")&&(V||q)&&(L.pathname+="/"),L}const Jo=s=>s.join("/").replace(/\/\/+/g,"/"),Q8=s=>s.replace(/\/+$/,"").replace(/^\/*/,"/"),$8=s=>!s||s==="?"?"":s.startsWith("?")?s:"?"+s,Z8=s=>!s||s==="#"?"":s.startsWith("#")?s:"#"+s;function eH(s){return s!=null&&typeof s.status=="number"&&typeof s.statusText=="string"&&typeof s.internal=="boolean"&&"data"in s}const zk=["post","put","patch","delete"];new Set(zk);const tH=["get",...zk];new Set(tH);/**
 * React Router v6.21.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */function Lu(){return Lu=Object.assign?Object.assign.bind():function(s){for(var o=1;o<arguments.length;o++){var d=arguments[o];for(var f in d)Object.prototype.hasOwnProperty.call(d,f)&&(s[f]=d[f])}return s},Lu.apply(this,arguments)}const Hv=se.createContext(null),iH=se.createContext(null),S_=se.createContext(null),T_=se.createContext(null),rc=se.createContext({outlet:null,matches:[],isDataRoute:!1}),Yk=se.createContext(null);function v_(){return se.useContext(T_)!=null}function qk(){return v_()||Wi(!1),se.useContext(T_).location}function Jk(s){se.useContext(S_).static||se.useLayoutEffect(s)}function Xk(){let{isDataRoute:s}=se.useContext(rc);return s?mH():rH()}function rH(){v_()||Wi(!1);let s=se.useContext(Hv),{basename:o,future:d,navigator:f}=se.useContext(S_),{matches:m}=se.useContext(rc),{pathname:v}=qk(),I=JSON.stringify(J8(m,d.v7_relativeSplatPath)),D=se.useRef(!1);return Jk(()=>{D.current=!0}),se.useCallback(function(V,q){if(q===void 0&&(q={}),!D.current)return;if(typeof V=="number"){f.go(V);return}let H=X8(V,JSON.parse(I),v,q.relative==="path");s==null&&o!=="/"&&(H.pathname=H.pathname==="/"?o:Jo([o,H.pathname])),(q.replace?f.replace:f.push)(H,q.state,q)},[o,f,I,v,s])}function nH(){let{matches:s}=se.useContext(rc),o=s[s.length-1];return o?o.params:{}}function sH(s,o){return aH(s,o)}function aH(s,o,d,f){v_()||Wi(!1);let{navigator:m}=se.useContext(S_),{matches:v}=se.useContext(rc),I=v[v.length-1],D=I?I.params:{};I&&I.pathname;let L=I?I.pathnameBase:"/";I&&I.route;let V=qk(),q;if(o){var H;let ae=typeof o=="string"?jl(o):o;L==="/"||(H=ae.pathname)!=null&&H.startsWith(L)||Wi(!1),q=ae}else q=V;let te=q.pathname||"/",de=L==="/"?te:te.slice(L.length)||"/",pe=D8(s,{pathname:de}),ee=uH(pe&&pe.map(ae=>Object.assign({},ae,{params:Object.assign({},D,ae.params),pathname:Jo([L,m.encodeLocation?m.encodeLocation(ae.pathname).pathname:ae.pathname]),pathnameBase:ae.pathnameBase==="/"?L:Jo([L,m.encodeLocation?m.encodeLocation(ae.pathnameBase).pathname:ae.pathnameBase])})),v,d,f);return o&&ee?se.createElement(T_.Provider,{value:{location:Lu({pathname:"/",search:"",hash:"",state:null,key:"default"},q),navigationType:Ba.Pop}},ee):ee}function oH(){let s=_H(),o=eH(s)?s.status+" "+s.statusText:s instanceof Error?s.message:JSON.stringify(s),d=s instanceof Error?s.stack:null,m={padding:"0.5rem",backgroundColor:"rgba(200,200,200, 0.5)"};return se.createElement(se.Fragment,null,se.createElement("h2",null,"Unexpected Application Error!"),se.createElement("h3",{style:{fontStyle:"italic"}},o),d?se.createElement("pre",{style:m},d):null,null)}const cH=se.createElement(oH,null);class lH extends se.Component{constructor(o){super(o),this.state={location:o.location,revalidation:o.revalidation,error:o.error}}static getDerivedStateFromError(o){return{error:o}}static getDerivedStateFromProps(o,d){return d.location!==o.location||d.revalidation!=="idle"&&o.revalidation==="idle"?{error:o.error,location:o.location,revalidation:o.revalidation}:{error:o.error!==void 0?o.error:d.error,location:d.location,revalidation:o.revalidation||d.revalidation}}componentDidCatch(o,d){console.error("React Router caught the following error during render",o,d)}render(){return this.state.error!==void 0?se.createElement(rc.Provider,{value:this.props.routeContext},se.createElement(Yk.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function dH(s){let{routeContext:o,match:d,children:f}=s,m=se.useContext(Hv);return m&&m.static&&m.staticContext&&(d.route.errorElement||d.route.ErrorBoundary)&&(m.staticContext._deepestRenderedBoundaryId=d.route.id),se.createElement(rc.Provider,{value:o},f)}function uH(s,o,d,f){var m;if(o===void 0&&(o=[]),d===void 0&&(d=null),f===void 0&&(f=null),s==null){var v;if((v=d)!=null&&v.errors)s=d.matches;else return null}let I=s,D=(m=d)==null?void 0:m.errors;if(D!=null){let q=I.findIndex(H=>H.route.id&&(D==null?void 0:D[H.route.id]));q>=0||Wi(!1),I=I.slice(0,Math.min(I.length,q+1))}let L=!1,V=-1;if(d&&f&&f.v7_partialHydration)for(let q=0;q<I.length;q++){let H=I[q];if((H.route.HydrateFallback||H.route.hydrateFallbackElement)&&(V=q),H.route.id){let{loaderData:te,errors:de}=d,pe=H.route.loader&&te[H.route.id]===void 0&&(!de||de[H.route.id]===void 0);if(H.route.lazy||pe){L=!0,V>=0?I=I.slice(0,V+1):I=[I[0]];break}}}return I.reduceRight((q,H,te)=>{let de,pe=!1,ee=null,ae=null;d&&(de=D&&H.route.id?D[H.route.id]:void 0,ee=H.route.errorElement||cH,L&&(V<0&&te===0?(EH("route-fallback",!1),pe=!0,ae=null):V===te&&(pe=!0,ae=H.route.hydrateFallbackElement||null)));let K=o.concat(I.slice(0,te+1)),G=()=>{let Q;return de?Q=ee:pe?Q=ae:H.route.Component?Q=se.createElement(H.route.Component,null):H.route.element?Q=H.route.element:Q=q,se.createElement(dH,{match:H,routeContext:{outlet:q,matches:K,isDataRoute:d!=null},children:Q})};return d&&(H.route.ErrorBoundary||H.route.errorElement||te===0)?se.createElement(lH,{location:d.location,revalidation:d.revalidation,component:ee,error:de,children:G(),routeContext:{outlet:null,matches:K,isDataRoute:!0}}):G()},null)}var Qk=function(s){return s.UseBlocker="useBlocker",s.UseRevalidator="useRevalidator",s.UseNavigateStable="useNavigate",s}(Qk||{}),i_=function(s){return s.UseBlocker="useBlocker",s.UseLoaderData="useLoaderData",s.UseActionData="useActionData",s.UseRouteError="useRouteError",s.UseNavigation="useNavigation",s.UseRouteLoaderData="useRouteLoaderData",s.UseMatches="useMatches",s.UseRevalidator="useRevalidator",s.UseNavigateStable="useNavigate",s.UseRouteId="useRouteId",s}(i_||{});function hH(s){let o=se.useContext(Hv);return o||Wi(!1),o}function pH(s){let o=se.useContext(iH);return o||Wi(!1),o}function fH(s){let o=se.useContext(rc);return o||Wi(!1),o}function $k(s){let o=fH(),d=o.matches[o.matches.length-1];return d.route.id||Wi(!1),d.route.id}function _H(){var s;let o=se.useContext(Yk),d=pH(i_.UseRouteError),f=$k(i_.UseRouteError);return o!==void 0?o:(s=d.errors)==null?void 0:s[f]}function mH(){let{router:s}=hH(Qk.UseNavigateStable),o=$k(i_.UseNavigateStable),d=se.useRef(!1);return Jk(()=>{d.current=!0}),se.useCallback(function(m,v){v===void 0&&(v={}),d.current&&(typeof m=="number"?s.navigate(m):s.navigate(m,Lu({fromRouteId:o},v)))},[s,o])}const CD={};function EH(s,o,d){!o&&!CD[s]&&(CD[s]=!0)}function KT(s){Wi(!1)}function gH(s){let{basename:o="/",children:d=null,location:f,navigationType:m=Ba.Pop,navigator:v,static:I=!1,future:D}=s;v_()&&Wi(!1);let L=o.replace(/^\/*/,"/"),V=se.useMemo(()=>({basename:L,navigator:v,static:I,future:Lu({v7_relativeSplatPath:!1},D)}),[L,D,v,I]);typeof f=="string"&&(f=jl(f));let{pathname:q="/",search:H="",hash:te="",state:de=null,key:pe="default"}=f,ee=se.useMemo(()=>{let ae=Kk(q,L);return ae==null?null:{location:{pathname:ae,search:H,hash:te,state:de,key:pe},navigationType:m}},[L,q,H,te,de,pe,m]);return ee==null?null:se.createElement(S_.Provider,{value:V},se.createElement(T_.Provider,{children:d,value:ee}))}function SH(s){let{children:o,location:d}=s;return sH(zT(o),d)}new Promise(()=>{});function zT(s,o){o===void 0&&(o=[]);let d=[];return se.Children.forEach(s,(f,m)=>{if(!se.isValidElement(f))return;let v=[...o,m];if(f.type===se.Fragment){d.push.apply(d,zT(f.props.children,v));return}f.type!==KT&&Wi(!1),!f.props.index||!f.props.children||Wi(!1);let I={id:f.props.id||v.join("-"),caseSensitive:f.props.caseSensitive,element:f.props.element,Component:f.props.Component,index:f.props.index,path:f.props.path,loader:f.props.loader,action:f.props.action,errorElement:f.props.errorElement,ErrorBoundary:f.props.ErrorBoundary,hasErrorBoundary:f.props.ErrorBoundary!=null||f.props.errorElement!=null,shouldRevalidate:f.props.shouldRevalidate,handle:f.props.handle,lazy:f.props.lazy};f.props.children&&(I.children=zT(f.props.children,v)),d.push(I)}),d}/**
 * React Router DOM v6.21.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */const TH="startTransition",RD=EW[TH];function vH(s){let{basename:o,children:d,future:f,window:m}=s,v=se.useRef();v.current==null&&(v.current=O8({window:m,v5Compat:!0}));let I=v.current,[D,L]=se.useState({action:I.action,location:I.location}),{v7_startTransition:V}=f||{},q=se.useCallback(H=>{V&&RD?RD(()=>L(H)):L(H)},[L,V]);return se.useLayoutEffect(()=>I.listen(q),[I,q]),se.createElement(gH,{basename:o,children:d,location:D.location,navigationType:D.action,navigator:I,future:f})}var ID;(function(s){s.UseScrollRestoration="useScrollRestoration",s.UseSubmit="useSubmit",s.UseSubmitFetcher="useSubmitFetcher",s.UseFetcher="useFetcher",s.useViewTransitionState="useViewTransitionState"})(ID||(ID={}));var wD;(function(s){s.UseFetcher="useFetcher",s.UseFetchers="useFetchers",s.UseScrollRestoration="useScrollRestoration"})(wD||(wD={}));const yH="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='175'%20height='61'%20viewBox='0%200%20175%2061'%3e%3cg%3e%3cpath%20d='M98,28.19a9.85,9.85,0,1,1,9.84-9.85A9.86,9.86,0,0,1,98,28.19M98,.48a17.86,17.86,0,1,0,17.86,17.86A17.89,17.89,0,0,0,98,.48'%20fill='%23099dfd'/%3e%3cpath%20d='M127.67,5.08l-.22.22-.24.23-.16-.29L126.91,5a8.53,8.53,0,0,0-6.34-4.4L119.9.47V36.21l.67-.09a8.3,8.3,0,0,0,7.35-8.41V18.34a9.93,9.93,0,0,1,8.83-9.79l.53-.06v-8l-.64.07a15.21,15.21,0,0,0-9,4.54'%20fill='%23099dfd'/%3e%3cpath%20d='M17.86,28.2a9.85,9.85,0,1,1,9.85-9.85,9.86,9.86,0,0,1-9.85,9.85M29.33,4l-.15.2-.15.2-.2-.15-.19-.15A17.86,17.86,0,1,0,17.86,36.21a17.67,17.67,0,0,0,10.78-3.63l.19-.14.2-.16.15.21.15.2a8.52,8.52,0,0,0,5.73,3.44l.66.09V.48l-.66.09A8.53,8.53,0,0,0,29.33,4'%20fill='%23099dfd'/%3e%3cpath%20d='M157.14,28.2A9.85,9.85,0,1,1,167,18.35a9.86,9.86,0,0,1-9.85,9.85M174.34.57A8.57,8.57,0,0,0,168.6,4l-.14.19-.15.21-.2-.15-.19-.15a17.86,17.86,0,1,0-10.78,32.09,17.67,17.67,0,0,0,10.78-3.63l.19-.14.2-.16.15.21.14.2a8.56,8.56,0,0,0,5.74,3.44l.66.09V.48Z'%20fill='%23099dfd'/%3e%3cpath%20d='M58.18,8.49h0a9.85,9.85,0,1,1-9.86,9.85A9.86,9.86,0,0,1,58.2,8.49M69.35,32.27A17.82,17.82,0,0,0,73,8.33c-.25-.38-.53-.75-.82-1.11A8.66,8.66,0,0,0,76,1.15l.1-.67H58.11A17.85,17.85,0,0,0,47,32.27a17.81,17.81,0,0,0-2.14,2l5.44,6a9.85,9.85,0,1,1,13,14.3l5.45,6a17.84,17.84,0,0,0,.51-28.26'%20fill='%23099dfd'/%3e%3c/g%3e%3c/svg%3e",CH=({connectToVideo:s})=>{const[o,d]=se.useState(""),[f,m]=se.useState(""),v=I=>{const D=o.trim();if(D===""){I.preventDefault(),m("Channel name can't be empty."),d("");return}s(D)};return we.jsxs("form",{onSubmit:v,children:[we.jsx("img",{src:yH,className:"logo",alt:"Agora logo"}),we.jsxs("div",{className:"card",children:[we.jsx("input",{id:"channelName",type:"text",placeholder:"Channel Name",value:o,onChange:I=>{d(I.target.value),m("")}}),we.jsx("button",{children:"Connect"}),f&&we.jsxs("p",{style:{color:"red"},children:[" ",f," "]})]})]})};function Zk(s){var o,d,f="";if(typeof s=="string"||typeof s=="number")f+=s;else if(typeof s=="object")if(Array.isArray(s)){var m=s.length;for(o=0;o<m;o++)s[o]&&(d=Zk(s[o]))&&(f&&(f+=" "),f+=d)}else for(d in s)s[d]&&(f&&(f+=" "),f+=d);return f}function RH(){for(var s,o,d=0,f="",m=arguments.length;d<m;d++)(s=arguments[d])&&(o=Zk(s))&&(f&&(f+=" "),f+=o);return f}/**
 * @license agora-rtc-react
 * @version 2.0.0
 *
 * Copyright (c) Agora, Inc.
 *
 * This source code is licensed under the MIT license.
 */var IH=Object.create,Kv=Object.defineProperty,wH=Object.getOwnPropertyDescriptor,AH=Object.getOwnPropertyNames,OH=Object.getPrototypeOf,NH=Object.prototype.hasOwnProperty,bH=(s,o)=>()=>(o||s((o={exports:{}}).exports,o),o.exports),DH=(s,o)=>{for(var d in o)Kv(s,d,{get:o[d],enumerable:!0})},YT=(s,o,d,f)=>{if(o&&typeof o=="object"||typeof o=="function")for(let m of AH(o))!NH.call(s,m)&&m!==d&&Kv(s,m,{get:()=>o[m],enumerable:!(f=wH(o,m))||f.enumerable});return s},PH=(s,o,d)=>(YT(s,o,"default"),d&&YT(d,o,"default")),nc=(s,o,d)=>(d=s!=null?IH(OH(s)):{},YT(o||!s||!s.__esModule?Kv(d,"default",{value:s,enumerable:!0}):d,s)),sc=bH((s,o)=>{(function(d,f){typeof s=="object"&&typeof o<"u"?o.exports=f():typeof define=="function"&&define.amd?define(f):(d=typeof globalThis<"u"?globalThis:d||self).AgoraRTC=f()})(s,function(){function d(i,e){return e.forEach(function(t){t&&typeof t!="string"&&!Array.isArray(t)&&Object.keys(t).forEach(function(r){if(r!=="default"&&!(r in i)){var n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(i,r,n.get?n:{enumerable:!0,get:function(){return t[r]}})}})}),Object.freeze(i)}let f=!0,m=!0;function v(i,e,t){let r=i.match(e);return r&&r.length>=t&&parseInt(r[t],10)}function I(i,e,t){if(!i.RTCPeerConnection)return;let r=i.RTCPeerConnection.prototype,n=r.addEventListener;r.addEventListener=function(c,l){if(c!==e)return n.apply(this,arguments);let u=h=>{let p=t(h);p&&(l.handleEvent?l.handleEvent(p):l(p))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(l,u),n.apply(this,[c,u])};let a=r.removeEventListener;r.removeEventListener=function(c,l){if(c!==e||!this._eventMap||!this._eventMap[e])return a.apply(this,arguments);if(!this._eventMap[e].has(l))return a.apply(this,arguments);let u=this._eventMap[e].get(l);return this._eventMap[e].delete(l),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,a.apply(this,[c,u])},Object.defineProperty(r,"on"+e,{get(){return this["_on"+e]},set(c){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),c&&this.addEventListener(e,this["_on"+e]=c)},enumerable:!0,configurable:!0})}function D(i){return typeof i!="boolean"?new Error("Argument type: "+typeof i+". Please use a boolean."):(f=i,i?"adapter.js logging disabled":"adapter.js logging enabled")}function L(i){return typeof i!="boolean"?new Error("Argument type: "+typeof i+". Please use a boolean."):(m=!i,"adapter.js deprecation warnings "+(i?"disabled":"enabled"))}function V(){if(typeof window=="object"){if(f)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function q(i,e){m&&console.warn(i+" is deprecated, please use "+e+" instead.")}function H(i){return Object.prototype.toString.call(i)==="[object Object]"}function te(i){return H(i)?Object.keys(i).reduce(function(e,t){let r=H(i[t]),n=r?te(i[t]):i[t],a=r&&!Object.keys(n).length;return n===void 0||a?e:Object.assign(e,{[t]:n})},{}):i}function de(i,e,t){e&&!t.has(e.id)&&(t.set(e.id,e),Object.keys(e).forEach(r=>{r.endsWith("Id")?de(i,i.get(e[r]),t):r.endsWith("Ids")&&e[r].forEach(n=>{de(i,i.get(n),t)})}))}function pe(i,e,t){let r=t?"outbound-rtp":"inbound-rtp",n=new Map;if(e===null)return n;let a=[];return i.forEach(c=>{c.type==="track"&&c.trackIdentifier===e.id&&a.push(c)}),a.forEach(c=>{i.forEach(l=>{l.type===r&&l.trackId===c.id&&de(i,l,n)})}),n}let ee=V;function ae(i,e){let t=i&&i.navigator;if(!t.mediaDevices)return;let r=function(c){if(typeof c!="object"||c.mandatory||c.optional)return c;let l={};return Object.keys(c).forEach(u=>{if(u==="require"||u==="advanced"||u==="mediaSource")return;let h=typeof c[u]=="object"?c[u]:{ideal:c[u]};h.exact!==void 0&&typeof h.exact=="number"&&(h.min=h.max=h.exact);let p=function(_,E){return _?_+E.charAt(0).toUpperCase()+E.slice(1):E==="deviceId"?"sourceId":E};if(h.ideal!==void 0){l.optional=l.optional||[];let _={};typeof h.ideal=="number"?(_[p("min",u)]=h.ideal,l.optional.push(_),_={},_[p("max",u)]=h.ideal,l.optional.push(_)):(_[p("",u)]=h.ideal,l.optional.push(_))}h.exact!==void 0&&typeof h.exact!="number"?(l.mandatory=l.mandatory||{},l.mandatory[p("",u)]=h.exact):["min","max"].forEach(_=>{h[_]!==void 0&&(l.mandatory=l.mandatory||{},l.mandatory[p(_,u)]=h[_])})}),c.advanced&&(l.optional=(l.optional||[]).concat(c.advanced)),l},n=function(c,l){if(e.version>=61)return l(c);if((c=JSON.parse(JSON.stringify(c)))&&typeof c.audio=="object"){let u=function(h,p,_){p in h&&!(_ in h)&&(h[_]=h[p],delete h[p])};u((c=JSON.parse(JSON.stringify(c))).audio,"autoGainControl","googAutoGainControl"),u(c.audio,"noiseSuppression","googNoiseSuppression"),c.audio=r(c.audio)}if(c&&typeof c.video=="object"){let u=c.video.facingMode;u=u&&(typeof u=="object"?u:{ideal:u});let h=e.version<66;if(u&&(u.exact==="user"||u.exact==="environment"||u.ideal==="user"||u.ideal==="environment")&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||h)){let p;if(delete c.video.facingMode,u.exact==="environment"||u.ideal==="environment"?p=["back","rear"]:u.exact!=="user"&&u.ideal!=="user"||(p=["front"]),p)return t.mediaDevices.enumerateDevices().then(_=>{let E=(_=_.filter(T=>T.kind==="videoinput")).find(T=>p.some(w=>T.label.toLowerCase().includes(w)));return!E&&_.length&&p.includes("back")&&(E=_[_.length-1]),E&&(c.video.deviceId=u.exact?{exact:E.deviceId}:{ideal:E.deviceId}),c.video=r(c.video),ee("chrome: "+JSON.stringify(c)),l(c)})}c.video=r(c.video)}return ee("chrome: "+JSON.stringify(c)),l(c)},a=function(c){return e.version>=64?c:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[c.name]||c.name,message:c.message,constraint:c.constraint||c.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=(function(c,l,u){n(c,h=>{t.webkitGetUserMedia(h,l,p=>{u&&u(a(p))})})}).bind(t),t.mediaDevices.getUserMedia){let c=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(l){return n(l,u=>c(u).then(h=>{if(u.audio&&!h.getAudioTracks().length||u.video&&!h.getVideoTracks().length)throw h.getTracks().forEach(p=>{p.stop()}),new DOMException("","NotFoundError");return h},h=>Promise.reject(a(h))))}}}function K(i){i.MediaStream=i.MediaStream||i.webkitMediaStream}function G(i){if(typeof i=="object"&&i.RTCPeerConnection&&!("ontrack"in i.RTCPeerConnection.prototype)){Object.defineProperty(i.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});let e=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",r=>{let n;n=i.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(c=>c.track&&c.track.id===r.track.id):{track:r.track};let a=new Event("track");a.track=r.track,a.receiver=n,a.transceiver={receiver:n},a.streams=[t.stream],this.dispatchEvent(a)}),t.stream.getTracks().forEach(r=>{let n;n=i.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(c=>c.track&&c.track.id===r.id):{track:r};let a=new Event("track");a.track=r,a.receiver=n,a.transceiver={receiver:n},a.streams=[t.stream],this.dispatchEvent(a)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else I(i,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Q(i){if(typeof i=="object"&&i.RTCPeerConnection&&!("getSenders"in i.RTCPeerConnection.prototype)&&"createDTMFSender"in i.RTCPeerConnection.prototype){let e=function(n,a){return{track:a,get dtmf(){return this._dtmf===void 0&&(a.kind==="audio"?this._dtmf=n.createDTMFSender(a):this._dtmf=null),this._dtmf},_pc:n}};if(!i.RTCPeerConnection.prototype.getSenders){i.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let n=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(c,l){let u=n.apply(this,arguments);return u||(u=e(this,c),this._senders.push(u)),u};let a=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(c){a.apply(this,arguments);let l=this._senders.indexOf(c);l!==-1&&this._senders.splice(l,1)}}let t=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(n){this._senders=this._senders||[],t.apply(this,[n]),n.getTracks().forEach(a=>{this._senders.push(e(this,a))})};let r=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(n){this._senders=this._senders||[],r.apply(this,[n]),n.getTracks().forEach(a=>{let c=this._senders.find(l=>l.track===a);c&&this._senders.splice(this._senders.indexOf(c),1)})}}else if(typeof i=="object"&&i.RTCPeerConnection&&"getSenders"in i.RTCPeerConnection.prototype&&"createDTMFSender"in i.RTCPeerConnection.prototype&&i.RTCRtpSender&&!("dtmf"in i.RTCRtpSender.prototype)){let e=i.RTCPeerConnection.prototype.getSenders;i.RTCPeerConnection.prototype.getSenders=function(){let t=e.apply(this,[]);return t.forEach(r=>r._pc=this),t},Object.defineProperty(i.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function _e(i){if(!i.RTCPeerConnection)return;let e=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){let[t,r,n]=arguments;if(arguments.length>0&&typeof t=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof t!="function"))return e.apply(this,[]);let a=function(l){let u={};return l.result().forEach(h=>{let p={id:h.id,timestamp:h.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[h.type]||h.type};h.names().forEach(_=>{p[_]=h.stat(_)}),u[p.id]=p}),u},c=function(l){return new Map(Object.keys(l).map(u=>[u,l[u]]))};if(arguments.length>=2){let l=function(u){r(c(a(u)))};return e.apply(this,[l,t])}return new Promise((l,u)=>{e.apply(this,[function(h){l(c(a(h)))},u])}).then(r,n)}}function Re(i){if(!(typeof i=="object"&&i.RTCPeerConnection&&i.RTCRtpSender&&i.RTCRtpReceiver))return;if(!("getStats"in i.RTCRtpSender.prototype)){let t=i.RTCPeerConnection.prototype.getSenders;t&&(i.RTCPeerConnection.prototype.getSenders=function(){let n=t.apply(this,[]);return n.forEach(a=>a._pc=this),n});let r=i.RTCPeerConnection.prototype.addTrack;r&&(i.RTCPeerConnection.prototype.addTrack=function(){let n=r.apply(this,arguments);return n._pc=this,n}),i.RTCRtpSender.prototype.getStats=function(){let n=this;return this._pc.getStats().then(a=>pe(a,n.track,!0))}}if(!("getStats"in i.RTCRtpReceiver.prototype)){let t=i.RTCPeerConnection.prototype.getReceivers;t&&(i.RTCPeerConnection.prototype.getReceivers=function(){let r=t.apply(this,[]);return r.forEach(n=>n._pc=this),r}),I(i,"track",r=>(r.receiver._pc=r.srcElement,r)),i.RTCRtpReceiver.prototype.getStats=function(){let r=this;return this._pc.getStats().then(n=>pe(n,r.track,!1))}}if(!("getStats"in i.RTCRtpSender.prototype)||!("getStats"in i.RTCRtpReceiver.prototype))return;let e=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof i.MediaStreamTrack){let t=arguments[0],r,n,a;return this.getSenders().forEach(c=>{c.track===t&&(r?a=!0:r=c)}),this.getReceivers().forEach(c=>(c.track===t&&(n?a=!0:n=c),c.track===t)),a||r&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function Le(i){i.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(a=>this._shimmedLocalStreams[a][0])};let e=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(a,c){if(!c)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let l=e.apply(this,arguments);return this._shimmedLocalStreams[c.id]?this._shimmedLocalStreams[c.id].indexOf(l)===-1&&this._shimmedLocalStreams[c.id].push(l):this._shimmedLocalStreams[c.id]=[c,l],l};let t=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(a){this._shimmedLocalStreams=this._shimmedLocalStreams||{},a.getTracks().forEach(u=>{if(this.getSenders().find(h=>h.track===u))throw new DOMException("Track already exists.","InvalidAccessError")});let c=this.getSenders();t.apply(this,arguments);let l=this.getSenders().filter(u=>c.indexOf(u)===-1);this._shimmedLocalStreams[a.id]=[a].concat(l)};let r=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[a.id],r.apply(this,arguments)};let n=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},a&&Object.keys(this._shimmedLocalStreams).forEach(c=>{let l=this._shimmedLocalStreams[c].indexOf(a);l!==-1&&this._shimmedLocalStreams[c].splice(l,1),this._shimmedLocalStreams[c].length===1&&delete this._shimmedLocalStreams[c]}),n.apply(this,arguments)}}function Me(i,e){if(!i.RTCPeerConnection)return;if(i.RTCPeerConnection.prototype.addTrack&&e.version>=65)return Le(i);let t=i.RTCPeerConnection.prototype.getLocalStreams;i.RTCPeerConnection.prototype.getLocalStreams=function(){let u=t.apply(this);return this._reverseStreams=this._reverseStreams||{},u.map(h=>this._reverseStreams[h.id])};let r=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(u){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},u.getTracks().forEach(h=>{if(this.getSenders().find(p=>p.track===h))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[u.id]){let h=new i.MediaStream(u.getTracks());this._streams[u.id]=h,this._reverseStreams[h.id]=u,u=h}r.apply(this,[u])};let n=i.RTCPeerConnection.prototype.removeStream;function a(u,h){let p=h.sdp;return Object.keys(u._reverseStreams||[]).forEach(_=>{let E=u._reverseStreams[_],T=u._streams[E.id];p=p.replace(new RegExp(T.id,"g"),E.id)}),new RTCSessionDescription({type:h.type,sdp:p})}i.RTCPeerConnection.prototype.removeStream=function(u){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[u.id]||u]),delete this._reverseStreams[this._streams[u.id]?this._streams[u.id].id:u.id],delete this._streams[u.id]},i.RTCPeerConnection.prototype.addTrack=function(u,h){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let p=[].slice.call(arguments,1);if(p.length!==1||!p[0].getTracks().find(E=>E===u))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(E=>E.track===u))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let _=this._streams[h.id];if(_)_.addTrack(u),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let E=new i.MediaStream([u]);this._streams[h.id]=E,this._reverseStreams[E.id]=h,this.addStream(E)}return this.getSenders().find(E=>E.track===u)},["createOffer","createAnswer"].forEach(function(u){let h=i.RTCPeerConnection.prototype[u],p={[u](){let _=arguments;return arguments.length&&typeof arguments[0]=="function"?h.apply(this,[E=>{let T=a(this,E);_[0].apply(null,[T])},E=>{_[1]&&_[1].apply(null,E)},arguments[2]]):h.apply(this,arguments).then(E=>a(this,E))}};i.RTCPeerConnection.prototype[u]=p[u]});let c=i.RTCPeerConnection.prototype.setLocalDescription;i.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(u,h){let p=h.sdp;return Object.keys(u._reverseStreams||[]).forEach(_=>{let E=u._reverseStreams[_],T=u._streams[E.id];p=p.replace(new RegExp(E.id,"g"),T.id)}),new RTCSessionDescription({type:h.type,sdp:p})}(this,arguments[0]),c.apply(this,arguments)):c.apply(this,arguments)};let l=Object.getOwnPropertyDescriptor(i.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(i.RTCPeerConnection.prototype,"localDescription",{get(){let u=l.get.apply(this);return u.type===""?u:a(this,u)}}),i.RTCPeerConnection.prototype.removeTrack=function(u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!u._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(u._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let h;this._streams=this._streams||{},Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(_=>u.track===_)&&(h=this._streams[p])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(u.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Fe(i,e){!i.RTCPeerConnection&&i.webkitRTCPeerConnection&&(i.RTCPeerConnection=i.webkitRTCPeerConnection),i.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){let r=i.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new(t==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};i.RTCPeerConnection.prototype[t]=n[t]})}function ii(i,e){I(i,"negotiationneeded",t=>{let r=t.target;if(!(e.version<72||r.getConfiguration&&r.getConfiguration().sdpSemantics==="plan-b")||r.signalingState==="stable")return t})}var dt=Object.freeze({__proto__:null,fixNegotiationNeeded:ii,shimAddTrackRemoveTrack:Me,shimAddTrackRemoveTrackWithNative:Le,shimGetDisplayMedia:function(i,e){i.navigator.mediaDevices&&"getDisplayMedia"in i.navigator.mediaDevices||i.navigator.mediaDevices&&(typeof e=="function"?i.navigator.mediaDevices.getDisplayMedia=function(t){return e(t).then(r=>{let n=t.video&&t.video.width,a=t.video&&t.video.height,c=t.video&&t.video.frameRate;return t.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:c||3}},n&&(t.video.mandatory.maxWidth=n),a&&(t.video.mandatory.maxHeight=a),i.navigator.mediaDevices.getUserMedia(t)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:Q,shimGetStats:_e,shimGetUserMedia:ae,shimMediaStream:K,shimOnTrack:G,shimPeerConnection:Fe,shimSenderReceiverGetStats:Re});function kr(i,e){let t=i&&i.navigator,r=i&&i.MediaStreamTrack;if(t.getUserMedia=function(n,a,c){q("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(n).then(a,c)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){let n=function(c,l,u){l in c&&!(u in c)&&(c[u]=c[l],delete c[l])},a=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(c){return typeof c=="object"&&typeof c.audio=="object"&&(c=JSON.parse(JSON.stringify(c)),n(c.audio,"autoGainControl","mozAutoGainControl"),n(c.audio,"noiseSuppression","mozNoiseSuppression")),a(c)},r&&r.prototype.getSettings){let c=r.prototype.getSettings;r.prototype.getSettings=function(){let l=c.apply(this,arguments);return n(l,"mozAutoGainControl","autoGainControl"),n(l,"mozNoiseSuppression","noiseSuppression"),l}}if(r&&r.prototype.applyConstraints){let c=r.prototype.applyConstraints;r.prototype.applyConstraints=function(l){return this.kind==="audio"&&typeof l=="object"&&(l=JSON.parse(JSON.stringify(l)),n(l,"autoGainControl","mozAutoGainControl"),n(l,"noiseSuppression","mozNoiseSuppression")),c.apply(this,[l])}}}}function ta(i){typeof i=="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Ns(i,e){if(typeof i!="object"||!i.RTCPeerConnection&&!i.mozRTCPeerConnection)return;!i.RTCPeerConnection&&i.mozRTCPeerConnection&&(i.RTCPeerConnection=i.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){let a=i.RTCPeerConnection.prototype[n],c={[n](){return arguments[0]=new(n==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),a.apply(this,arguments)}};i.RTCPeerConnection.prototype[n]=c[n]});let t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){let[n,a,c]=arguments;return r.apply(this,[n||null]).then(l=>{if(e.version<53&&!a)try{l.forEach(u=>{u.type=t[u.type]||u.type})}catch(u){if(u.name!=="TypeError")throw u;l.forEach((h,p)=>{l.set(p,Object.assign({},h,{type:t[h.type]||h.type}))})}return l}).then(a,c)}}function Bl(i){if(typeof i!="object"||!i.RTCPeerConnection||!i.RTCRtpSender||i.RTCRtpSender&&"getStats"in i.RTCRtpSender.prototype)return;let e=i.RTCPeerConnection.prototype.getSenders;e&&(i.RTCPeerConnection.prototype.getSenders=function(){let r=e.apply(this,[]);return r.forEach(n=>n._pc=this),r});let t=i.RTCPeerConnection.prototype.addTrack;t&&(i.RTCPeerConnection.prototype.addTrack=function(){let r=t.apply(this,arguments);return r._pc=this,r}),i.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function ju(i){if(typeof i!="object"||!i.RTCPeerConnection||!i.RTCRtpSender||i.RTCRtpSender&&"getStats"in i.RTCRtpReceiver.prototype)return;let e=i.RTCPeerConnection.prototype.getReceivers;e&&(i.RTCPeerConnection.prototype.getReceivers=function(){let t=e.apply(this,[]);return t.forEach(r=>r._pc=this),t}),I(i,"track",t=>(t.receiver._pc=t.srcElement,t)),i.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function cc(i){i.RTCPeerConnection&&!("removeStream"in i.RTCPeerConnection.prototype)&&(i.RTCPeerConnection.prototype.removeStream=function(e){q("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function lc(i){i.DataChannel&&!i.RTCDataChannel&&(i.RTCDataChannel=i.DataChannel)}function Oe(i){if(typeof i!="object"||!i.RTCPeerConnection)return;let e=i.RTCPeerConnection.prototype.addTransceiver;e&&(i.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let t=arguments[1]&&arguments[1].sendEncodings;t===void 0&&(t=[]),t=[...t];let r=t.length>0;r&&t.forEach(a=>{if("rid"in a&&!/^[a-z0-9]{0,16}$/i.test(a.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in a&&!(parseFloat(a.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in a&&!(parseFloat(a.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let n=e.apply(this,arguments);if(r){let{sender:a}=n,c=a.getParameters();(!("encodings"in c)||c.encodings.length===1&&Object.keys(c.encodings[0]).length===0)&&(c.encodings=t,a.sendEncodings=t,this.setParametersPromises.push(a.setParameters(c).then(()=>{delete a.sendEncodings}).catch(()=>{delete a.sendEncodings})))}return n})}function $e(i){if(typeof i!="object"||!i.RTCRtpSender)return;let e=i.RTCRtpSender.prototype.getParameters;e&&(i.RTCRtpSender.prototype.getParameters=function(){let t=e.apply(this,arguments);return"encodings"in t||(t.encodings=[].concat(this.sendEncodings||[{}])),t})}function rt(i){if(typeof i!="object"||!i.RTCPeerConnection)return;let e=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function ri(i){if(typeof i!="object"||!i.RTCPeerConnection)return;let e=i.RTCPeerConnection.prototype.createAnswer;i.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var vi=Object.freeze({__proto__:null,shimAddTransceiver:Oe,shimCreateAnswer:ri,shimCreateOffer:rt,shimGetDisplayMedia:function(i,e){i.navigator.mediaDevices&&"getDisplayMedia"in i.navigator.mediaDevices||i.navigator.mediaDevices&&(i.navigator.mediaDevices.getDisplayMedia=function(t){if(!t||!t.video){let r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return t.video===!0?t.video={mediaSource:e}:t.video.mediaSource=e,i.navigator.mediaDevices.getUserMedia(t)})},shimGetParameters:$e,shimGetUserMedia:kr,shimOnTrack:ta,shimPeerConnection:Ns,shimRTCDataChannel:lc,shimReceiverGetStats:ju,shimRemoveStream:cc,shimSenderGetStats:Bl});function io(i){if(typeof i=="object"&&i.RTCPeerConnection){if("getLocalStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in i.RTCPeerConnection.prototype)){let e=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addStream=function(t){this._localStreams||(this._localStreams=[]),this._localStreams.includes(t)||this._localStreams.push(t),t.getAudioTracks().forEach(r=>e.call(this,r,t)),t.getVideoTracks().forEach(r=>e.call(this,r,t))},i.RTCPeerConnection.prototype.addTrack=function(t,...r){return r&&r.forEach(n=>{this._localStreams?this._localStreams.includes(n)||this._localStreams.push(n):this._localStreams=[n]}),e.apply(this,arguments)}}"removeStream"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);let t=this._localStreams.indexOf(e);if(t===-1)return;this._localStreams.splice(t,1);let r=e.getTracks();this.getSenders().forEach(n=>{r.includes(n.track)&&this.removeTrack(n)})})}}function rs(i){if(typeof i=="object"&&i.RTCPeerConnection&&("getRemoteStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in i.RTCPeerConnection.prototype))){Object.defineProperty(i.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=r=>{r.streams.forEach(n=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(n))return;this._remoteStreams.push(n);let a=new Event("addstream");a.stream=n,this.dispatchEvent(a)})})}});let e=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){let t=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(n=>{if(t._remoteStreams||(t._remoteStreams=[]),t._remoteStreams.indexOf(n)>=0)return;t._remoteStreams.push(n);let a=new Event("addstream");a.stream=n,t.dispatchEvent(a)})}),e.apply(t,arguments)}}}function dc(i){if(typeof i!="object"||!i.RTCPeerConnection)return;let e=i.RTCPeerConnection.prototype,t=e.createOffer,r=e.createAnswer,n=e.setLocalDescription,a=e.setRemoteDescription,c=e.addIceCandidate;e.createOffer=function(u,h){let p=arguments.length>=2?arguments[2]:arguments[0],_=t.apply(this,[p]);return h?(_.then(u,h),Promise.resolve()):_},e.createAnswer=function(u,h){let p=arguments.length>=2?arguments[2]:arguments[0],_=r.apply(this,[p]);return h?(_.then(u,h),Promise.resolve()):_};let l=function(u,h,p){let _=n.apply(this,[u]);return p?(_.then(h,p),Promise.resolve()):_};e.setLocalDescription=l,l=function(u,h,p){let _=a.apply(this,[u]);return p?(_.then(h,p),Promise.resolve()):_},e.setRemoteDescription=l,l=function(u,h,p){let _=c.apply(this,[u]);return p?(_.then(h,p),Promise.resolve()):_},e.addIceCandidate=l}function ns(i){let e=i&&i.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){let t=e.mediaDevices,r=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=n=>r(ro(n))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(t,r,n){e.mediaDevices.getUserMedia(t).then(r,n)}).bind(e))}function ro(i){return i&&i.video!==void 0?Object.assign({},i,{video:te(i.video)}):i}function Qv(i){if(!i.RTCPeerConnection)return;let e=i.RTCPeerConnection;i.RTCPeerConnection=function(t,r){if(t&&t.iceServers){let n=[];for(let a=0;a<t.iceServers.length;a++){let c=t.iceServers[a];!c.hasOwnProperty("urls")&&c.hasOwnProperty("url")?(q("RTCIceServer.url","RTCIceServer.urls"),c=JSON.parse(JSON.stringify(c)),c.urls=c.url,delete c.url,n.push(c)):n.push(t.iceServers[a])}t.iceServers=n}return new e(t,r)},i.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(i.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function $v(i){typeof i=="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Zv(i){let e=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(t){if(t){t.offerToReceiveAudio!==void 0&&(t.offerToReceiveAudio=!!t.offerToReceiveAudio);let r=this.getTransceivers().find(a=>a.receiver.track.kind==="audio");t.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):t.offerToReceiveAudio!==!0||r||this.addTransceiver("audio",{direction:"recvonly"}),t.offerToReceiveVideo!==void 0&&(t.offerToReceiveVideo=!!t.offerToReceiveVideo);let n=this.getTransceivers().find(a=>a.receiver.track.kind==="video");t.offerToReceiveVideo===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):t.offerToReceiveVideo!==!0||n||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function ey(i){typeof i!="object"||i.AudioContext||(i.AudioContext=i.webkitAudioContext)}var ty=Object.freeze({__proto__:null,shimAudioContext:ey,shimCallbacksAPI:dc,shimConstraints:ro,shimCreateOfferLegacy:Zv,shimGetUserMedia:ns,shimLocalStreamsAPI:io,shimRTCIceServerUrls:Qv,shimRemoteStreamsAPI:rs,shimTrackEventTransceiver:$v}),uc=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Zi(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var iy={exports:{}};(function(i){let e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(r=>r.trim())},e.splitSections=function(t){return t.split(`
m=`).map((r,n)=>(n>0?"m="+r:r).trim()+`\r
`)},e.getDescription=function(t){let r=e.splitSections(t);return r&&r[0]},e.getMediaSections=function(t){let r=e.splitSections(t);return r.shift(),r},e.matchPrefix=function(t,r){return e.splitLines(t).filter(n=>n.indexOf(r)===0)},e.parseCandidate=function(t){let r;r=t.indexOf("a=candidate:")===0?t.substring(12).split(" "):t.substring(10).split(" ");let n={foundation:r[0],component:{1:"rtp",2:"rtcp"}[r[1]]||r[1],protocol:r[2].toLowerCase(),priority:parseInt(r[3],10),ip:r[4],address:r[4],port:parseInt(r[5],10),type:r[7]};for(let a=8;a<r.length;a+=2)switch(r[a]){case"raddr":n.relatedAddress=r[a+1];break;case"rport":n.relatedPort=parseInt(r[a+1],10);break;case"tcptype":n.tcpType=r[a+1];break;case"ufrag":n.ufrag=r[a+1],n.usernameFragment=r[a+1];break;default:n[r[a]]===void 0&&(n[r[a]]=r[a+1])}return n},e.writeCandidate=function(t){let r=[];r.push(t.foundation);let n=t.component;n==="rtp"?r.push(1):n==="rtcp"?r.push(2):r.push(n),r.push(t.protocol.toUpperCase()),r.push(t.priority),r.push(t.address||t.ip),r.push(t.port);let a=t.type;return r.push("typ"),r.push(a),a!=="host"&&t.relatedAddress&&t.relatedPort&&(r.push("raddr"),r.push(t.relatedAddress),r.push("rport"),r.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(r.push("tcptype"),r.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(r.push("ufrag"),r.push(t.usernameFragment||t.ufrag)),"candidate:"+r.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let r=t.substring(9).split(" "),n={payloadType:parseInt(r.shift(),10)};return r=r[0].split("/"),n.name=r[0],n.clockRate=parseInt(r[1],10),n.channels=r.length===3?parseInt(r[2],10):1,n.numChannels=n.channels,n},e.writeRtpMap=function(t){let r=t.payloadType;t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType);let n=t.channels||t.numChannels||1;return"a=rtpmap:"+r+" "+t.name+"/"+t.clockRate+(n!==1?"/"+n:"")+`\r
`},e.parseExtmap=function(t){let r=t.substring(9).split(" ");return{id:parseInt(r[0],10),direction:r[0].indexOf("/")>0?r[0].split("/")[1]:"sendrecv",uri:r[1],attributes:r.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){let r={},n,a=t.substring(t.indexOf(" ")+1).split(";");for(let c=0;c<a.length;c++)n=a[c].trim().split("="),r[n[0].trim()]=n[1];return r},e.writeFmtp=function(t){let r="",n=t.payloadType;if(t.preferredPayloadType!==void 0&&(n=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){let a=[];Object.keys(t.parameters).forEach(c=>{t.parameters[c]!==void 0?a.push(c+"="+t.parameters[c]):a.push(c)}),r+="a=fmtp:"+n+" "+a.join(";")+`\r
`}return r},e.parseRtcpFb=function(t){let r=t.substring(t.indexOf(" ")+1).split(" ");return{type:r.shift(),parameter:r.join(" ")}},e.writeRtcpFb=function(t){let r="",n=t.payloadType;return t.preferredPayloadType!==void 0&&(n=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(a=>{r+="a=rtcp-fb:"+n+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+`\r
`}),r},e.parseSsrcMedia=function(t){let r=t.indexOf(" "),n={ssrc:parseInt(t.substring(7,r),10)},a=t.indexOf(":",r);return a>-1?(n.attribute=t.substring(r+1,a),n.value=t.substring(a+1)):n.attribute=t.substring(r+1),n},e.parseSsrcGroup=function(t){let r=t.substring(13).split(" ");return{semantics:r.shift(),ssrcs:r.map(n=>parseInt(n,10))}},e.getMid=function(t){let r=e.matchPrefix(t,"a=mid:")[0];if(r)return r.substring(6)},e.parseFingerprint=function(t){let r=t.substring(14).split(" ");return{algorithm:r[0].toLowerCase(),value:r[1].toUpperCase()}},e.getDtlsParameters=function(t,r){return{role:"auto",fingerprints:e.matchPrefix(t+r,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,r){let n="a=setup:"+r+`\r
`;return t.fingerprints.forEach(a=>{n+="a=fingerprint:"+a.algorithm+" "+a.value+`\r
`}),n},e.parseCryptoLine=function(t){let r=t.substring(9).split(" ");return{tag:parseInt(r[0],10),cryptoSuite:r[1],keyParams:r[2],sessionParams:r.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;let r=t.substring(7).split("|");return{keyMethod:"inline",keySalt:r[0],lifeTime:r[1],mkiValue:r[2]?r[2].split(":")[0]:void 0,mkiLength:r[2]?r[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,r){return e.matchPrefix(t+r,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,r){let n=e.matchPrefix(t+r,"a=ice-ufrag:")[0],a=e.matchPrefix(t+r,"a=ice-pwd:")[0];return n&&a?{usernameFragment:n.substring(12),password:a.substring(10)}:null},e.writeIceParameters=function(t){let r="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(r+=`a=ice-lite\r
`),r},e.parseRtpParameters=function(t){let r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=e.splitLines(t)[0].split(" ");r.profile=n[2];for(let c=3;c<n.length;c++){let l=n[c],u=e.matchPrefix(t,"a=rtpmap:"+l+" ")[0];if(u){let h=e.parseRtpMap(u),p=e.matchPrefix(t,"a=fmtp:"+l+" ");switch(h.parameters=p.length?e.parseFmtp(p[0]):{},h.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+l+" ").map(e.parseRtcpFb),r.codecs.push(h),h.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(h.name.toUpperCase())}}}e.matchPrefix(t,"a=extmap:").forEach(c=>{r.headerExtensions.push(e.parseExtmap(c))});let a=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return r.codecs.forEach(c=>{a.forEach(l=>{c.rtcpFeedback.find(u=>u.type===l.type&&u.parameter===l.parameter)||c.rtcpFeedback.push(l)})}),r},e.writeRtpDescription=function(t,r){let n="";n+="m="+t+" ",n+=r.codecs.length>0?"9":"0",n+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",n+=r.codecs.map(c=>c.preferredPayloadType!==void 0?c.preferredPayloadType:c.payloadType).join(" ")+`\r
`,n+=`c=IN IP4 0.0.0.0\r
`,n+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,r.codecs.forEach(c=>{n+=e.writeRtpMap(c),n+=e.writeFmtp(c),n+=e.writeRtcpFb(c)});let a=0;return r.codecs.forEach(c=>{c.maxptime>a&&(a=c.maxptime)}),a>0&&(n+="a=maxptime:"+a+`\r
`),r.headerExtensions&&r.headerExtensions.forEach(c=>{n+=e.writeExtmap(c)}),n},e.parseRtpEncodingParameters=function(t){let r=[],n=e.parseRtpParameters(t),a=n.fecMechanisms.indexOf("RED")!==-1,c=n.fecMechanisms.indexOf("ULPFEC")!==-1,l=e.matchPrefix(t,"a=ssrc:").map(E=>e.parseSsrcMedia(E)).filter(E=>E.attribute==="cname"),u=l.length>0&&l[0].ssrc,h,p=e.matchPrefix(t,"a=ssrc-group:FID").map(E=>E.substring(17).split(" ").map(T=>parseInt(T,10)));p.length>0&&p[0].length>1&&p[0][0]===u&&(h=p[0][1]),n.codecs.forEach(E=>{if(E.name.toUpperCase()==="RTX"&&E.parameters.apt){let T={ssrc:u,codecPayloadType:parseInt(E.parameters.apt,10)};u&&h&&(T.rtx={ssrc:h}),r.push(T),a&&(T=JSON.parse(JSON.stringify(T)),T.fec={ssrc:u,mechanism:c?"red+ulpfec":"red"},r.push(T))}}),r.length===0&&u&&r.push({ssrc:u});let _=e.matchPrefix(t,"b=");return _.length&&(_=_[0].indexOf("b=TIAS:")===0?parseInt(_[0].substring(7),10):_[0].indexOf("b=AS:")===0?1e3*parseInt(_[0].substring(5),10)*.95-16e3:void 0,r.forEach(E=>{E.maxBitrate=_})),r},e.parseRtcpParameters=function(t){let r={},n=e.matchPrefix(t,"a=ssrc:").map(l=>e.parseSsrcMedia(l)).filter(l=>l.attribute==="cname")[0];n&&(r.cname=n.value,r.ssrc=n.ssrc);let a=e.matchPrefix(t,"a=rtcp-rsize");r.reducedSize=a.length>0,r.compound=a.length===0;let c=e.matchPrefix(t,"a=rtcp-mux");return r.mux=c.length>0,r},e.writeRtcpParameters=function(t){let r="";return t.reducedSize&&(r+=`a=rtcp-rsize\r
`),t.mux&&(r+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(r+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),r},e.parseMsid=function(t){let r,n=e.matchPrefix(t,"a=msid:");if(n.length===1)return r=n[0].substring(7).split(" "),{stream:r[0],track:r[1]};let a=e.matchPrefix(t,"a=ssrc:").map(c=>e.parseSsrcMedia(c)).filter(c=>c.attribute==="msid");return a.length>0?(r=a[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},e.parseSctpDescription=function(t){let r=e.parseMLine(t),n=e.matchPrefix(t,"a=max-message-size:"),a;n.length>0&&(a=parseInt(n[0].substring(19),10)),isNaN(a)&&(a=65536);let c=e.matchPrefix(t,"a=sctp-port:");if(c.length>0)return{port:parseInt(c[0].substring(12),10),protocol:r.fmt,maxMessageSize:a};let l=e.matchPrefix(t,"a=sctpmap:");if(l.length>0){let u=l[0].substring(10).split(" ");return{port:parseInt(u[0],10),protocol:u[1],maxMessageSize:a}}},e.writeSctpDescription=function(t,r){let n=[];return n=t.protocol!=="DTLS/SCTP"?["m="+t.kind+" 9 "+t.protocol+" "+r.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+r.port+`\r
`]:["m="+t.kind+" 9 "+t.protocol+" "+r.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+r.port+" "+r.protocol+` 65535\r
`],r.maxMessageSize!==void 0&&n.push("a=max-message-size:"+r.maxMessageSize+`\r
`),n.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,r,n){let a,c=r!==void 0?r:2;return a=t||e.generateSessionId(),`v=0\r
o=`+(n||"thisisadapterortc")+" "+a+" "+c+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,r){let n=e.splitLines(t);for(let a=0;a<n.length;a++)switch(n[a]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[a].substring(2)}return r?e.getDirection(r):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){let r=e.splitLines(t)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(t){let r=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;let r=e.splitLines(t);for(let n=0;n<r.length;n++)if(r[n].length<2||r[n].charAt(1)!=="=")return!1;return!0},i.exports=e})(iy);var ry=iy.exports,hc=Zi(ry),vL=d({__proto__:null,default:hc},[ry]);function Bu(i){if(!i.RTCIceCandidate||i.RTCIceCandidate&&"foundation"in i.RTCIceCandidate.prototype)return;let e=i.RTCIceCandidate;i.RTCIceCandidate=function(t){if(typeof t=="object"&&t.candidate&&t.candidate.indexOf("a=")===0&&((t=JSON.parse(JSON.stringify(t))).candidate=t.candidate.substr(2)),t.candidate&&t.candidate.length){let r=new e(t),n=hc.parseCandidate(t.candidate),a=Object.assign(r,n);return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a}return new e(t)},i.RTCIceCandidate.prototype=e.prototype,I(i,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new i.RTCIceCandidate(t.candidate),writable:"false"}),t))}function I_(i){!i.RTCIceCandidate||i.RTCIceCandidate&&"relayProtocol"in i.RTCIceCandidate.prototype||I(i,"icecandidate",e=>{if(e.candidate){let t=hc.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function Gu(i,e){if(!i.RTCPeerConnection)return;"sctp"in i.RTCPeerConnection.prototype||Object.defineProperty(i.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});let t=function(l){if(!l||!l.sdp)return!1;let u=hc.splitSections(l.sdp);return u.shift(),u.some(h=>{let p=hc.parseMLine(h);return p&&p.kind==="application"&&p.protocol.indexOf("SCTP")!==-1})},r=function(l){let u=l.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(u===null||u.length<2)return-1;let h=parseInt(u[1],10);return h!=h?-1:h},n=function(l){let u=65536;return e.browser==="firefox"&&(u=e.version<57?l===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),u},a=function(l,u){let h=65536;e.browser==="firefox"&&e.version===57&&(h=65535);let p=hc.matchPrefix(l.sdp,"a=max-message-size:");return p.length>0?h=parseInt(p[0].substr(19),10):e.browser==="firefox"&&u!==-1&&(h=2147483637),h},c=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){let{sdpSemantics:l}=this.getConfiguration();l==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){let l=r(arguments[0]),u=n(l),h=a(arguments[0],l),p;p=u===0&&h===0?Number.POSITIVE_INFINITY:u===0||h===0?Math.max(u,h):Math.min(u,h);let _={};Object.defineProperty(_,"maxMessageSize",{get:()=>p}),this._sctp=_}return c.apply(this,arguments)}}function Wu(i){if(!i.RTCPeerConnection||!("createDataChannel"in i.RTCPeerConnection.prototype))return;function e(r,n){let a=r.send;r.send=function(){let c=arguments[0],l=c.length||c.size||c.byteLength;if(r.readyState==="open"&&n.sctp&&l>n.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+n.sctp.maxMessageSize+" bytes)");return a.apply(r,arguments)}}let t=i.RTCPeerConnection.prototype.createDataChannel;i.RTCPeerConnection.prototype.createDataChannel=function(){let r=t.apply(this,arguments);return e(r,this),r},I(i,"datachannel",r=>(e(r.channel,r.target),r))}function w_(i){if(!i.RTCPeerConnection||"connectionState"in i.RTCPeerConnection.prototype)return;let e=i.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{let r=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=n=>{let a=n.target;if(a._lastConnectionState!==a.connectionState){a._lastConnectionState=a.connectionState;let c=new Event("connectionstatechange",n);a.dispatchEvent(c)}return n},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function A_(i,e){if(!i.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;let t=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let n=r.sdp.split(`
`).filter(a=>a.trim()!=="a=extmap-allow-mixed").join(`
`);i.RTCSessionDescription&&r instanceof i.RTCSessionDescription?arguments[0]=new i.RTCSessionDescription({type:r.type,sdp:n}):r.sdp=n}return t.apply(this,arguments)}}function Hu(i,e){if(!i.RTCPeerConnection||!i.RTCPeerConnection.prototype)return;let t=i.RTCPeerConnection.prototype.addIceCandidate;t&&t.length!==0&&(i.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Ku(i,e){if(!i.RTCPeerConnection||!i.RTCPeerConnection.prototype)return;let t=i.RTCPeerConnection.prototype.setLocalDescription;t&&t.length!==0&&(i.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return t.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer"}return r.sdp||r.type!=="offer"&&r.type!=="answer"?t.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(n=>t.apply(this,[n]))})}var yL=Object.freeze({__proto__:null,removeExtmapAllowMixed:A_,shimAddIceCandidateNullOrEmpty:Hu,shimConnectionState:w_,shimMaxMessageSize:Gu,shimParameterlessSetLocalDescription:Ku,shimRTCIceCandidate:Bu,shimRTCIceCandidateRelayProtocol:I_,shimSendThrowTypeError:Wu});(function({window:i}={},e={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){let t=V,r=function(a){let c={browser:null,version:null};if(a===void 0||!a.navigator)return c.browser="Not a browser.",c;let{navigator:l}=a;if(l.mozGetUserMedia)c.browser="firefox",c.version=v(l.userAgent,/Firefox\/(\d+)\./,1);else if(l.webkitGetUserMedia||a.isSecureContext===!1&&a.webkitRTCPeerConnection)c.browser="chrome",c.version=v(l.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!a.RTCPeerConnection||!l.userAgent.match(/AppleWebKit\/(\d+)\./))return c.browser="Not a supported browser.",c;c.browser="safari",c.version=v(l.userAgent,/AppleWebKit\/(\d+)\./,1),c.supportsUnifiedPlan=a.RTCRtpTransceiver&&"currentDirection"in a.RTCRtpTransceiver.prototype}return c}(i),n={browserDetails:r,commonShim:yL,extractVersion:v,disableLog:D,disableWarnings:L,sdp:vL};switch(r.browser){case"chrome":if(!dt||!Fe||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),n;if(r.version===null)return t("Chrome shim can not determine version, not shimming."),n;t("adapter.js shimming chrome."),n.browserShim=dt,Hu(i,r),Ku(i),ae(i,r),K(i),Fe(i,r),G(i),Me(i,r),Q(i),_e(i),Re(i),ii(i,r),Bu(i),I_(i),w_(i),Gu(i,r),Wu(i),A_(i,r);break;case"firefox":if(!vi||!Ns||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),n;t("adapter.js shimming firefox."),n.browserShim=vi,Hu(i,r),Ku(i),kr(i,r),Ns(i,r),ta(i),cc(i),Bl(i),ju(i),lc(i),Oe(i),$e(i),rt(i),ri(i),Bu(i),w_(i),Gu(i,r),Wu(i);break;case"safari":if(!ty||!e.shimSafari)return t("Safari shim is not included in this adapter release."),n;t("adapter.js shimming safari."),n.browserShim=ty,Hu(i,r),Ku(i),Qv(i),Zv(i),dc(i),io(i),rs(i),$v(i),ns(i),ey(i),Bu(i),I_(i),Gu(i,r),Wu(i),A_(i,r);break;default:t("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var Ei=function(i){try{return!!i()}catch{return!0}},zu=!Ei(function(){var i=(function(){}).bind();return typeof i!="function"||i.hasOwnProperty("prototype")}),ny=zu,sy=Function.prototype,O_=sy.call,CL=ny&&sy.bind.bind(O_,O_),hi=ny?CL:function(i){return function(){return O_.apply(i,arguments)}},Gn=hi({}.isPrototypeOf),Yu=function(i){return i&&i.Math==Math&&i},Hi=Yu(typeof globalThis=="object"&&globalThis)||Yu(typeof window=="object"&&window)||Yu(typeof self=="object"&&self)||Yu(typeof uc=="object"&&uc)||function(){return this}()||uc||Function("return this")(),RL=zu,ay=Function.prototype,oy=ay.apply,cy=ay.call,N_=typeof Reflect=="object"&&Reflect.apply||(RL?cy.bind(oy):function(){return cy.apply(oy,arguments)}),ly=hi,IL=ly({}.toString),wL=ly("".slice),ia=function(i){return wL(IL(i),8,-1)},AL=ia,OL=hi,b_=function(i){if(AL(i)==="Function")return OL(i)},D_=typeof document=="object"&&document.all,qu={all:D_,IS_HTMLDDA:D_===void 0&&D_!==void 0},NL=qu.all,bi=qu.IS_HTMLDDA?function(i){return typeof i=="function"||i===NL}:function(i){return typeof i=="function"},Gl={},ss=!Ei(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),bL=zu,Ju=Function.prototype.call,ar=bL?Ju.bind(Ju):function(){return Ju.apply(Ju,arguments)},P_={},dy={}.propertyIsEnumerable,uy=Object.getOwnPropertyDescriptor,DL=uy&&!dy.call({1:2},1);P_.f=DL?function(i){var e=uy(this,i);return!!e&&e.enumerable}:dy;var ra,Xu,no=function(i,e){return{enumerable:!(1&i),configurable:!(2&i),writable:!(4&i),value:e}},PL=Ei,kL=ia,k_=Object,LL=hi("".split),L_=PL(function(){return!k_("z").propertyIsEnumerable(0)})?function(i){return kL(i)=="String"?LL(i,""):k_(i)}:k_,Qu=function(i){return i==null},ML=Qu,UL=TypeError,Wl=function(i){if(ML(i))throw UL("Can't call method on "+i);return i},xL=L_,VL=Wl,so=function(i){return xL(VL(i))},hy=bi,FL=qu.all,yn=qu.IS_HTMLDDA?function(i){return typeof i=="object"?i!==null:hy(i)||i===FL}:function(i){return typeof i=="object"?i!==null:hy(i)},ao={},M_=ao,U_=Hi,jL=bi,py=function(i){return jL(i)?i:void 0},Lr=function(i,e){return arguments.length<2?py(M_[i])||py(U_[i]):M_[i]&&M_[i][e]||U_[i]&&U_[i][e]},oo=typeof navigator<"u"&&String(navigator.userAgent)||"",fy=Hi,x_=oo,_y=fy.process,my=fy.Deno,Ey=_y&&_y.versions||my&&my.version,gy=Ey&&Ey.v8;gy&&(Xu=(ra=gy.split("."))[0]>0&&ra[0]<4?1:+(ra[0]+ra[1])),!Xu&&x_&&(!(ra=x_.match(/Edge\/(\d+)/))||ra[1]>=74)&&(ra=x_.match(/Chrome\/(\d+)/))&&(Xu=+ra[1]);var co=Xu,Sy=co,BL=Ei,GL=Hi.String,pc=!!Object.getOwnPropertySymbols&&!BL(function(){var i=Symbol();return!GL(i)||!(Object(i)instanceof Symbol)||!Symbol.sham&&Sy&&Sy<41}),Ty=pc&&!Symbol.sham&&typeof Symbol.iterator=="symbol",WL=Lr,HL=bi,KL=Gn,zL=Object,Hl=Ty?function(i){return typeof i=="symbol"}:function(i){var e=WL("Symbol");return HL(e)&&KL(e.prototype,zL(i))},YL=String,fc=function(i){try{return YL(i)}catch{return"Object"}},qL=bi,JL=fc,XL=TypeError,Cn=function(i){if(qL(i))return i;throw XL(JL(i)+" is not a function")},QL=Cn,$L=Qu,V_=function(i,e){var t=i[e];return $L(t)?void 0:QL(t)},F_=ar,j_=bi,B_=yn,ZL=TypeError,vy={exports:{}},yy=Hi,e1=Object.defineProperty,t1=function(i,e){try{e1(yy,i,{value:e,configurable:!0,writable:!0})}catch{yy[i]=e}return e},Cy="__core-js_shared__",G_=Hi[Cy]||t1(Cy,{}),Ry=G_;(vy.exports=function(i,e){return Ry[i]||(Ry[i]=e!==void 0?e:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:" 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var _c=vy.exports,i1=Wl,r1=Object,lo=function(i){return r1(i1(i))},n1=lo,s1=hi({}.hasOwnProperty),or=Object.hasOwn||function(i,e){return s1(n1(i),e)},a1=hi,o1=0,c1=Math.random(),l1=a1(1 .toString),W_=function(i){return"Symbol("+(i===void 0?"":i)+")_"+l1(++o1+c1,36)},d1=_c,Iy=or,u1=W_,h1=pc,p1=Ty,mc=Hi.Symbol,H_=d1("wks"),f1=p1?mc.for||mc:mc&&mc.withoutSetter||u1,ni=function(i){return Iy(H_,i)||(H_[i]=h1&&Iy(mc,i)?mc[i]:f1("Symbol."+i)),H_[i]},_1=ar,wy=yn,Ay=Hl,m1=V_,E1=function(i,e){var t,r;if(e==="string"&&j_(t=i.toString)&&!B_(r=F_(t,i))||j_(t=i.valueOf)&&!B_(r=F_(t,i))||e!=="string"&&j_(t=i.toString)&&!B_(r=F_(t,i)))return r;throw ZL("Can't convert object to primitive value")},g1=TypeError,S1=ni("toPrimitive"),T1=function(i,e){if(!wy(i)||Ay(i))return i;var t,r=m1(i,S1);if(r){if(e===void 0&&(e="default"),t=_1(r,i,e),!wy(t)||Ay(t))return t;throw g1("Can't convert object to primitive value")}return e===void 0&&(e="number"),E1(i,e)},v1=Hl,$u=function(i){var e=T1(i,"string");return v1(e)?e:e+""},Oy=yn,K_=Hi.document,y1=Oy(K_)&&Oy(K_.createElement),z_=function(i){return y1?K_.createElement(i):{}},C1=z_,Ny=!ss&&!Ei(function(){return Object.defineProperty(C1("div"),"a",{get:function(){return 7}}).a!=7}),R1=ss,I1=ar,w1=P_,A1=no,O1=so,N1=$u,b1=or,D1=Ny,by=Object.getOwnPropertyDescriptor;Gl.f=R1?by:function(i,e){if(i=O1(i),e=N1(e),D1)try{return by(i,e)}catch{}if(b1(i,e))return A1(!I1(w1.f,i,e),i[e])};var P1=Ei,k1=bi,L1=/#|\.prototype\./,Kl=function(i,e){var t=U1[M1(i)];return t==V1||t!=x1&&(k1(e)?P1(e):!!e)},M1=Kl.normalize=function(i){return String(i).replace(L1,".").toLowerCase()},U1=Kl.data={},x1=Kl.NATIVE="N",V1=Kl.POLYFILL="P",Dy=Kl,F1=Cn,j1=zu,B1=b_(b_.bind),zl=function(i,e){return F1(i),e===void 0?i:j1?B1(i,e):function(){return i.apply(e,arguments)}},Rn={},Py=ss&&Ei(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),G1=yn,W1=String,H1=TypeError,Wn=function(i){if(G1(i))return i;throw H1(W1(i)+" is not an object")},K1=ss,z1=Ny,Y1=Py,Zu=Wn,ky=$u,q1=TypeError,Y_=Object.defineProperty,J1=Object.getOwnPropertyDescriptor,q_="enumerable",J_="configurable",X_="writable";Rn.f=K1?Y1?function(i,e,t){if(Zu(i),e=ky(e),Zu(t),typeof i=="function"&&e==="prototype"&&"value"in t&&X_ in t&&!t[X_]){var r=J1(i,e);r&&r[X_]&&(i[e]=t.value,t={configurable:J_ in t?t[J_]:r[J_],enumerable:q_ in t?t[q_]:r[q_],writable:!1})}return Y_(i,e,t)}:Y_:function(i,e,t){if(Zu(i),e=ky(e),Zu(t),z1)try{return Y_(i,e,t)}catch{}if("get"in t||"set"in t)throw q1("Accessors not supported");return"value"in t&&(i[e]=t.value),i};var X1=Rn,Q1=no,na=ss?function(i,e,t){return X1.f(i,e,Q1(1,t))}:function(i,e,t){return i[e]=t,i},eh=Hi,$1=N_,Z1=b_,eM=bi,tM=Gl.f,iM=Dy,Ec=ao,rM=zl,gc=na,Ly=or,nM=function(i){var e=function(t,r,n){if(this instanceof e){switch(arguments.length){case 0:return new i;case 1:return new i(t);case 2:return new i(t,r)}return new i(t,r,n)}return $1(i,this,arguments)};return e.prototype=i.prototype,e},Pt=function(i,e){var t,r,n,a,c,l,u,h,p,_=i.target,E=i.global,T=i.stat,w=i.proto,C=E?eh:T?eh[_]:(eh[_]||{}).prototype,O=E?Ec:Ec[_]||gc(Ec,_,{})[_],b=O.prototype;for(a in e)r=!(t=iM(E?a:_+(T?".":"#")+a,i.forced))&&C&&Ly(C,a),l=O[a],r&&(u=i.dontCallGetSet?(p=tM(C,a))&&p.value:C[a]),c=r&&u?u:e[a],r&&typeof l==typeof c||(h=i.bind&&r?rM(c,eh):i.wrap&&r?nM(c):w&&eM(c)?Z1(c):c,(i.sham||c&&c.sham||l&&l.sham)&&gc(h,"sham",!0),gc(O,a,h),w&&(Ly(Ec,n=_+"Prototype")||gc(Ec,n,{}),gc(Ec[n],a,c),i.real&&b&&(t||!b[a])&&gc(b,a,c)))},sM=Math.ceil,aM=Math.floor,oM=Math.trunc||function(i){var e=+i;return(e>0?aM:sM)(e)},Q_=function(i){var e=+i;return e!=e||e===0?0:oM(e)},cM=Q_,lM=Math.max,dM=Math.min,My=function(i,e){var t=cM(i);return t<0?lM(t+e,0):dM(t,e)},uM=Q_,hM=Math.min,pM=function(i){return i>0?hM(uM(i),9007199254740991):0},uo=function(i){return pM(i.length)},fM=so,_M=My,mM=uo,Uy=function(i){return function(e,t,r){var n,a=fM(e),c=mM(a),l=_M(r,c);if(i&&t!=t){for(;c>l;)if((n=a[l++])!=n)return!0}else for(;c>l;l++)if((i||l in a)&&a[l]===t)return i||l||0;return!i&&-1}},xy={includes:Uy(!0),indexOf:Uy(!1)},EM=xy.includes;Pt({target:"Array",proto:!0,forced:Ei(function(){return!Array(1).includes()})},{includes:function(i){return EM(this,i,arguments.length>1?arguments[1]:void 0)}});var gM=ao,ho=function(i){return gM[i+"Prototype"]},SM=ho("Array").includes,TM=yn,vM=ia,yM=ni("match"),CM=function(i){var e;return TM(i)&&((e=i[yM])!==void 0?!!e:vM(i)=="RegExp")},RM=TypeError,Vy={};Vy[ni("toStringTag")]="z";var $_=String(Vy)==="[object z]",IM=$_,wM=bi,th=ia,AM=ni("toStringTag"),OM=Object,NM=th(function(){return arguments}())=="Arguments",po=IM?th:function(i){var e,t,r;return i===void 0?"Undefined":i===null?"Null":typeof(t=function(n,a){try{return n[a]}catch{}}(e=OM(i),AM))=="string"?t:NM?th(e):(r=th(e))=="Object"&&wM(e.callee)?"Arguments":r},bM=po,DM=String,bs=function(i){if(bM(i)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return DM(i)},PM=ni("match"),kM=Pt,LM=function(i){if(CM(i))throw RM("The method doesn't accept regular expressions");return i},MM=Wl,Fy=bs,UM=function(i){var e=/./;try{"/./"[i](e)}catch{try{return e[PM]=!1,"/./"[i](e)}catch{}}return!1},xM=hi("".indexOf);kM({target:"String",proto:!0,forced:!UM("includes")},{includes:function(i){return!!~xM(Fy(MM(this)),Fy(LM(i)),arguments.length>1?arguments[1]:void 0)}});var VM=ho("String").includes,jy=Gn,FM=SM,jM=VM,Z_=Array.prototype,em=String.prototype,ge=Zi(function(i){var e=i.includes;return i===Z_||jy(Z_,i)&&e===Z_.includes?FM:typeof i=="string"||i===em||jy(em,i)&&e===em.includes?jM:e}),By={exports:{}},BM=Pt,GM=ss,Gy=Rn.f;BM({target:"Object",stat:!0,forced:Object.defineProperty!==Gy,sham:!GM},{defineProperty:Gy});var Wy=ao.Object,WM=By.exports=function(i,e,t){return Wy.defineProperty(i,e,t)};Wy.defineProperty.sham&&(WM.sham=!0);var HM=Zi(By.exports),KM=ia,tm=Array.isArray||function(i){return KM(i)=="Array"},zM=TypeError,YM=$u,qM=Rn,JM=no,Hy=function(i,e,t){var r=YM(e);r in i?qM.f(i,r,JM(0,t)):i[r]=t},XM=bi,im=G_,QM=hi(Function.toString);XM(im.inspectSource)||(im.inspectSource=function(i){return QM(i)});var Ky=im.inspectSource,$M=hi,ZM=Ei,zy=bi,eU=po,tU=Ky,Yy=function(){},iU=[],qy=Lr("Reflect","construct"),rm=/^\s*(?:class|function)\b/,rU=$M(rm.exec),nU=!rm.exec(Yy),Yl=function(i){if(!zy(i))return!1;try{return qy(Yy,iU,i),!0}catch{return!1}},Jy=function(i){if(!zy(i))return!1;switch(eU(i)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return nU||!!rU(rm,tU(i))}catch{return!0}};Jy.sham=!0;var Xy=!qy||ZM(function(){var i;return Yl(Yl.call)||!Yl(Object)||!Yl(function(){i=!0})||i})?Jy:Yl,Qy=tm,sU=Xy,aU=yn,oU=ni("species"),$y=Array,cU=function(i){var e;return Qy(i)&&(e=i.constructor,(sU(e)&&(e===$y||Qy(e.prototype))||aU(e)&&(e=e[oU])===null)&&(e=void 0)),e===void 0?$y:e},Zy=function(i,e){return new(cU(i))(e===0?0:e)},lU=Ei,dU=co,uU=ni("species"),hU=Pt,pU=Ei,fU=tm,_U=yn,mU=lo,EU=uo,eC=function(i){if(i>9007199254740991)throw zM("Maximum allowed index exceeded");return i},tC=Hy,gU=Zy,SU=function(i){return dU>=51||!lU(function(){var e=[];return(e.constructor={})[uU]=function(){return{foo:1}},e[i](Boolean).foo!==1})},TU=co,iC=ni("isConcatSpreadable"),vU=TU>=51||!pU(function(){var i=[];return i[iC]=!1,i.concat()[0]!==i}),yU=function(i){if(!_U(i))return!1;var e=i[iC];return e!==void 0?!!e:fU(i)};hU({target:"Array",proto:!0,arity:1,forced:!vU||!SU("concat")},{concat:function(i){var e,t,r,n,a,c=mU(this),l=gU(c,0),u=0;for(e=-1,r=arguments.length;e<r;e++)if(yU(a=e===-1?c:arguments[e]))for(n=EU(a),eC(u+n),t=0;t<n;t++,u++)t in a&&tC(l,u,a[t]);else eC(u+1),tC(l,u++,a);return l.length=u,l}});var nm={},ih={},sm=or,CU=so,RU=xy.indexOf,IU=ih,rC=hi([].push),nC=function(i,e){var t,r=CU(i),n=0,a=[];for(t in r)!sm(IU,t)&&sm(r,t)&&rC(a,t);for(;e.length>n;)sm(r,t=e[n++])&&(~RU(a,t)||rC(a,t));return a},am=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],wU=nC,AU=am,sC=Object.keys||function(i){return wU(i,AU)},OU=ss,NU=Py,bU=Rn,DU=Wn,PU=so,kU=sC;nm.f=OU&&!NU?Object.defineProperties:function(i,e){DU(i);for(var t,r=PU(e),n=kU(e),a=n.length,c=0;a>c;)bU.f(i,t=n[c++],r[t]);return i};var rh,aC=Lr("document","documentElement"),LU=W_,oC=_c("keys"),nh=function(i){return oC[i]||(oC[i]=LU(i))},MU=Wn,UU=nm,cC=am,xU=ih,VU=aC,FU=z_,om="prototype",cm="script",lC=nh("IE_PROTO"),lm=function(){},dC=function(i){return"<"+cm+">"+i+"</"+cm+">"},uC=function(i){i.write(dC("")),i.close();var e=i.parentWindow.Object;return i=null,e},sh=function(){try{rh=new ActiveXObject("htmlfile")}catch{}var i,e,t;sh=typeof document<"u"?document.domain&&rh?uC(rh):(e=FU("iframe"),t="java"+cm+":",e.style.display="none",VU.appendChild(e),e.src=String(t),(i=e.contentWindow.document).open(),i.write(dC("document.F=Object")),i.close(),i.F):uC(rh);for(var r=cC.length;r--;)delete sh[om][cC[r]];return sh()};xU[lC]=!0;var ah=Object.create||function(i,e){var t;return i!==null?(lm[om]=MU(i),t=new lm,lm[om]=null,t[lC]=i):t=sh(),e===void 0?t:UU.f(t,e)},oh={},jU=nC,BU=am.concat("length","prototype");oh.f=Object.getOwnPropertyNames||function(i){return jU(i,BU)};var hC={},pC=My,GU=uo,WU=Hy,HU=Array,KU=Math.max,fC=function(i,e,t){for(var r=GU(i),n=pC(e,r),a=pC(t===void 0?r:t,r),c=HU(KU(a-n,0)),l=0;n<a;n++,l++)WU(c,l,i[n]);return c.length=l,c},zU=ia,YU=so,_C=oh.f,qU=fC,mC=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];hC.f=function(i){return mC&&zU(i)=="Window"?function(e){try{return _C(e)}catch{return qU(mC)}}(i):_C(YU(i))};var ch={};ch.f=Object.getOwnPropertySymbols;var JU=na,ql=function(i,e,t,r){return r&&r.enumerable?i[e]=t:JU(i,e,t),i},XU=Rn,EC=function(i,e,t){return XU.f(i,e,t)},Sc={},QU=ni;Sc.f=QU;var lh,Jl,dh,gC=ao,$U=or,ZU=Sc,e2=Rn.f,gi=function(i){var e=gC.Symbol||(gC.Symbol={});$U(e,i)||e2(e,i,{value:ZU.f(i)})},t2=ar,i2=Lr,r2=ni,n2=ql,SC=function(){var i=i2("Symbol"),e=i&&i.prototype,t=e&&e.valueOf,r=r2("toPrimitive");e&&!e[r]&&n2(e,r,function(n){return t2(t,this)},{arity:1})},s2=po,a2=$_?{}.toString:function(){return"[object "+s2(this)+"]"},o2=$_,c2=Rn.f,l2=na,d2=or,u2=a2,TC=ni("toStringTag"),Tc=function(i,e,t,r){if(i){var n=t?i:i.prototype;d2(n,TC)||c2(n,TC,{configurable:!0,value:e}),r&&!o2&&l2(n,"toString",u2)}},h2=bi,vC=Hi.WeakMap,p2=h2(vC)&&/native code/.test(String(vC)),yC=Hi,f2=yn,_2=na,dm=or,um=G_,m2=nh,E2=ih,CC="Object already initialized",hm=yC.TypeError,g2=yC.WeakMap;if(p2||um.state){var as=um.state||(um.state=new g2);as.get=as.get,as.has=as.has,as.set=as.set,lh=function(i,e){if(as.has(i))throw hm(CC);return e.facade=i,as.set(i,e),e},Jl=function(i){return as.get(i)||{}},dh=function(i){return as.has(i)}}else{var vc=m2("state");E2[vc]=!0,lh=function(i,e){if(dm(i,vc))throw hm(CC);return e.facade=i,_2(i,vc,e),e},Jl=function(i){return dm(i,vc)?i[vc]:{}},dh=function(i){return dm(i,vc)}}var uh={set:lh,get:Jl,has:dh,enforce:function(i){return dh(i)?Jl(i):lh(i,{})},getterFor:function(i){return function(e){var t;if(!f2(e)||(t=Jl(e)).type!==i)throw hm("Incompatible receiver, "+i+" required");return t}}},S2=zl,T2=L_,v2=lo,y2=uo,C2=Zy,RC=hi([].push),sa=function(i){var e=i==1,t=i==2,r=i==3,n=i==4,a=i==6,c=i==7,l=i==5||a;return function(u,h,p,_){for(var E,T,w=v2(u),C=T2(w),O=S2(h,p),b=y2(C),k=0,U=_||C2,X=e?U(u,b):t||c?U(u,0):void 0;b>k;k++)if((l||k in C)&&(T=O(E=C[k],k,w),i))if(e)X[k]=T;else if(T)switch(i){case 3:return!0;case 5:return E;case 6:return k;case 2:RC(X,E)}else switch(i){case 4:return!1;case 7:RC(X,E)}return a?-1:r||n?n:X}},R2={forEach:sa(0),map:sa(1),filter:sa(2),some:sa(3),every:sa(4),find:sa(5),findIndex:sa(6),filterReject:sa(7)},hh=Pt,pm=Hi,fm=ar,I2=hi,yc=ss,Cc=pc,w2=Ei,Ki=or,A2=Gn,_m=Wn,ph=so,mm=$u,O2=bs,Em=no,Xl=ah,IC=sC,N2=oh,wC=hC,b2=ch,AC=Gl,OC=Rn,D2=nm,NC=P_,bC=ql,P2=EC,gm=_c,DC=ih,PC=W_,k2=ni,L2=Sc,M2=gi,U2=SC,x2=Tc,kC=uh,fh=R2.forEach,Mr=nh("hidden"),_h="Symbol",Ql="prototype",V2=kC.set,LC=kC.getterFor(_h),Hn=Object[Ql],fo=pm.Symbol,mh=fo&&fo[Ql],F2=pm.TypeError,Sm=pm.QObject,MC=AC.f,_o=OC.f,UC=wC.f,j2=NC.f,xC=I2([].push),Ds=gm("symbols"),$l=gm("op-symbols"),B2=gm("wks"),Tm=!Sm||!Sm[Ql]||!Sm[Ql].findChild,vm=yc&&w2(function(){return Xl(_o({},"a",{get:function(){return _o(this,"a",{value:7}).a}})).a!=7})?function(i,e,t){var r=MC(Hn,e);r&&delete Hn[e],_o(i,e,t),r&&i!==Hn&&_o(Hn,e,r)}:_o,ym=function(i,e){var t=Ds[i]=Xl(mh);return V2(t,{type:_h,tag:i,description:e}),yc||(t.description=e),t},Eh=function(i,e,t){i===Hn&&Eh($l,e,t),_m(i);var r=mm(e);return _m(t),Ki(Ds,r)?(t.enumerable?(Ki(i,Mr)&&i[Mr][r]&&(i[Mr][r]=!1),t=Xl(t,{enumerable:Em(0,!1)})):(Ki(i,Mr)||_o(i,Mr,Em(1,{})),i[Mr][r]=!0),vm(i,r,t)):_o(i,r,t)},Cm=function(i,e){_m(i);var t=ph(e),r=IC(t).concat(BC(t));return fh(r,function(n){yc&&!fm(VC,t,n)||Eh(i,n,t[n])}),i},VC=function(i){var e=mm(i),t=fm(j2,this,e);return!(this===Hn&&Ki(Ds,e)&&!Ki($l,e))&&(!(t||!Ki(this,e)||!Ki(Ds,e)||Ki(this,Mr)&&this[Mr][e])||t)},FC=function(i,e){var t=ph(i),r=mm(e);if(t!==Hn||!Ki(Ds,r)||Ki($l,r)){var n=MC(t,r);return!n||!Ki(Ds,r)||Ki(t,Mr)&&t[Mr][r]||(n.enumerable=!0),n}},jC=function(i){var e=UC(ph(i)),t=[];return fh(e,function(r){Ki(Ds,r)||Ki(DC,r)||xC(t,r)}),t},BC=function(i){var e=i===Hn,t=UC(e?$l:ph(i)),r=[];return fh(t,function(n){!Ki(Ds,n)||e&&!Ki(Hn,n)||xC(r,Ds[n])}),r};Cc||(fo=function(){if(A2(mh,this))throw F2("Symbol is not a constructor");var i=arguments.length&&arguments[0]!==void 0?O2(arguments[0]):void 0,e=PC(i),t=function(r){this===Hn&&fm(t,$l,r),Ki(this,Mr)&&Ki(this[Mr],e)&&(this[Mr][e]=!1),vm(this,e,Em(1,r))};return yc&&Tm&&vm(Hn,e,{configurable:!0,set:t}),ym(e,i)},bC(mh=fo[Ql],"toString",function(){return LC(this).tag}),bC(fo,"withoutSetter",function(i){return ym(PC(i),i)}),NC.f=VC,OC.f=Eh,D2.f=Cm,AC.f=FC,N2.f=wC.f=jC,b2.f=BC,L2.f=function(i){return ym(k2(i),i)},yc&&P2(mh,"description",{configurable:!0,get:function(){return LC(this).description}})),hh({global:!0,constructor:!0,wrap:!0,forced:!Cc,sham:!Cc},{Symbol:fo}),fh(IC(B2),function(i){M2(i)}),hh({target:_h,stat:!0,forced:!Cc},{useSetter:function(){Tm=!0},useSimple:function(){Tm=!1}}),hh({target:"Object",stat:!0,forced:!Cc,sham:!yc},{create:function(i,e){return e===void 0?Xl(i):Cm(Xl(i),e)},defineProperty:Eh,defineProperties:Cm,getOwnPropertyDescriptor:FC}),hh({target:"Object",stat:!0,forced:!Cc},{getOwnPropertyNames:jC}),U2(),x2(fo,_h),DC[Mr]=!0;var GC=pc&&!!Symbol.for&&!!Symbol.keyFor,G2=Pt,W2=Lr,H2=or,K2=bs,WC=_c,z2=GC,Rm=WC("string-to-symbol-registry"),Y2=WC("symbol-to-string-registry");G2({target:"Symbol",stat:!0,forced:!z2},{for:function(i){var e=K2(i);if(H2(Rm,e))return Rm[e];var t=W2("Symbol")(e);return Rm[e]=t,Y2[t]=e,t}});var q2=Pt,J2=or,X2=Hl,Q2=fc,$2=GC,HC=_c("symbol-to-string-registry");q2({target:"Symbol",stat:!0,forced:!$2},{keyFor:function(i){if(!X2(i))throw TypeError(Q2(i)+" is not a symbol");if(J2(HC,i))return HC[i]}});var KC=hi([].slice),zC=tm,Z2=bi,YC=ia,ex=bs,qC=hi([].push),tx=Pt,JC=Lr,XC=N_,ix=ar,Zl=hi,QC=Ei,$C=bi,ZC=Hl,eR=KC,rx=function(i){if(Z2(i))return i;if(zC(i)){for(var e=i.length,t=[],r=0;r<e;r++){var n=i[r];typeof n=="string"?qC(t,n):typeof n!="number"&&YC(n)!="Number"&&YC(n)!="String"||qC(t,ex(n))}var a=t.length,c=!0;return function(l,u){if(c)return c=!1,u;if(zC(this))return u;for(var h=0;h<a;h++)if(t[h]===l)return u}}},nx=pc,sx=String,aa=JC("JSON","stringify"),gh=Zl(/./.exec),tR=Zl("".charAt),ax=Zl("".charCodeAt),ox=Zl("".replace),cx=Zl(1 .toString),lx=/[\uD800-\uDFFF]/g,iR=/^[\uD800-\uDBFF]$/,rR=/^[\uDC00-\uDFFF]$/,nR=!nx||QC(function(){var i=JC("Symbol")();return aa([i])!="[null]"||aa({a:i})!="{}"||aa(Object(i))!="{}"}),sR=QC(function(){return aa("\uDF06\uD834")!=='"\\udf06\\ud834"'||aa("\uDEAD")!=='"\\udead"'}),dx=function(i,e){var t=eR(arguments),r=rx(e);if($C(r)||i!==void 0&&!ZC(i))return t[1]=function(n,a){if($C(r)&&(a=ix(r,this,sx(n),a)),!ZC(a))return a},XC(aa,null,t)},ux=function(i,e,t){var r=tR(t,e-1),n=tR(t,e+1);return gh(iR,i)&&!gh(rR,n)||gh(rR,i)&&!gh(iR,r)?"\\u"+cx(ax(i,0),16):i};aa&&tx({target:"JSON",stat:!0,arity:3,forced:nR||sR},{stringify:function(i,e,t){var r=eR(arguments),n=XC(nR?dx:aa,null,r);return sR&&typeof n=="string"?ox(n,lx,ux):n}});var aR=ch,hx=lo;Pt({target:"Object",stat:!0,forced:!pc||Ei(function(){aR.f(1)})},{getOwnPropertySymbols:function(i){var e=aR.f;return e?e(hx(i)):[]}}),gi("asyncIterator"),gi("hasInstance"),gi("isConcatSpreadable"),gi("iterator"),gi("match"),gi("matchAll"),gi("replace"),gi("search"),gi("species"),gi("split");var px=SC;gi("toPrimitive"),px();var fx=Lr,_x=Tc;gi("toStringTag"),_x(fx("Symbol"),"Symbol"),gi("unscopables"),Tc(Hi.JSON,"JSON",!0);var mo,oR,cR,mx=ao.Symbol,Rc={},Im=ss,Ex=or,lR=Function.prototype,gx=Im&&Object.getOwnPropertyDescriptor,wm=Ex(lR,"name"),dR={EXISTS:wm,PROPER:wm&&(function(){}).name==="something",CONFIGURABLE:wm&&(!Im||Im&&gx(lR,"name").configurable)},Sx=!Ei(function(){function i(){}return i.prototype.constructor=null,Object.getPrototypeOf(new i)!==i.prototype}),Tx=or,vx=bi,yx=lo,Cx=Sx,uR=nh("IE_PROTO"),Am=Object,Rx=Am.prototype,Om=Cx?Am.getPrototypeOf:function(i){var e=yx(i);if(Tx(e,uR))return e[uR];var t=e.constructor;return vx(t)&&e instanceof t?t.prototype:e instanceof Am?Rx:null},Ix=Ei,wx=bi,Ax=yn,Ox=ah,hR=Om,Nx=ql,Nm=ni("iterator"),pR=!1;[].keys&&("next"in(cR=[].keys())?(oR=hR(hR(cR)))!==Object.prototype&&(mo=oR):pR=!0);var bx=!Ax(mo)||Ix(function(){var i={};return mo[Nm].call(i)!==i});wx((mo=bx?{}:Ox(mo))[Nm])||Nx(mo,Nm,function(){return this});var fR={IteratorPrototype:mo,BUGGY_SAFARI_ITERATORS:pR},Dx=fR.IteratorPrototype,Px=ah,kx=no,Lx=Tc,Mx=Rc,Ux=function(){return this},xx=hi,Vx=Cn,Fx=bi,jx=String,Bx=TypeError,Gx=function(i,e,t){try{return xx(Vx(Object.getOwnPropertyDescriptor(i,e)[t]))}catch{}},Wx=Wn,Hx=function(i){if(typeof i=="object"||Fx(i))return i;throw Bx("Can't set "+jx(i)+" as a prototype")},Kx=Object.setPrototypeOf||("__proto__"in{}?function(){var i,e=!1,t={};try{(i=Gx(Object.prototype,"__proto__","set"))(t,[]),e=t instanceof Array}catch{}return function(r,n){return Wx(r),Hx(n),e?i(r,n):r.__proto__=n,r}}():void 0),zx=Pt,Yx=ar,qx=dR,Jx=function(i,e,t,r){var n=e+" Iterator";return i.prototype=Px(Dx,{next:kx(+!r,t)}),Lx(i,n,!1,!0),Mx[n]=Ux,i},Xx=Om,Qx=Tc,_R=ql,mR=Rc,$x=fR,Zx=qx.PROPER,Sh=$x.BUGGY_SAFARI_ITERATORS,bm=ni("iterator"),ER="keys",Th="values",gR="entries",eV=function(){return this},SR=function(i,e,t,r,n,a,c){Jx(t,e,r);var l,u,h,p=function(b){if(b===n&&C)return C;if(!Sh&&b in T)return T[b];switch(b){case ER:case Th:case gR:return function(){return new t(this,b)}}return function(){return new t(this)}},_=e+" Iterator",E=!1,T=i.prototype,w=T[bm]||T["@@iterator"]||n&&T[n],C=!Sh&&w||p(n),O=e=="Array"&&T.entries||w;if(O&&(l=Xx(O.call(new i)))!==Object.prototype&&l.next&&(Qx(l,_,!0,!0),mR[_]=eV),Zx&&n==Th&&w&&w.name!==Th&&(E=!0,C=function(){return Yx(w,this)}),n)if(u={values:p(Th),keys:a?C:p(ER),entries:p(gR)},c)for(h in u)(Sh||E||!(h in T))&&_R(T,h,u[h]);else zx({target:e,proto:!0,forced:Sh||E},u);return c&&T[bm]!==C&&_R(T,bm,C,{name:n}),mR[e]=C,u},TR=function(i,e){return{value:i,done:e}},tV=so,vR=Rc,yR=uh;Rn.f;var iV=SR,CR=TR,RR="Array Iterator",rV=yR.set,nV=yR.getterFor(RR);iV(Array,"Array",function(i,e){rV(this,{type:RR,target:tV(i),index:0,kind:e})},function(){var i=nV(this),e=i.target,t=i.kind,r=i.index++;return!e||r>=e.length?(i.target=void 0,CR(void 0,!0)):CR(t=="keys"?r:t=="values"?e[r]:[r,e[r]],!1)},"values"),vR.Arguments=vR.Array;var sV={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},aV=Hi,oV=po,cV=na,IR=Rc,wR=ni("toStringTag");for(var Dm in sV){var AR=aV[Dm],Pm=AR&&AR.prototype;Pm&&oV(Pm)!==wR&&cV(Pm,wR,Dm),IR[Dm]=IR.Array}var lV=mx,dV=ni,uV=Rn.f,OR=dV("metadata"),NR=Function.prototype;NR[OR]===void 0&&uV(NR,OR,{value:null}),gi("dispose"),gi("metadata");var hV=lV;gi("asyncDispose");var pV=hi,km=Lr("Symbol"),fV=km.keyFor,_V=pV(km.prototype.valueOf),bR=km.isRegisteredSymbol||function(i){try{return fV(_V(i))!==void 0}catch{return!1}};Pt({target:"Symbol",stat:!0},{isRegisteredSymbol:bR});for(var mV=_c,DR=Lr,EV=hi,gV=Hl,SV=ni,vh=DR("Symbol"),PR=vh.isWellKnownSymbol,kR=DR("Object","getOwnPropertyNames"),TV=EV(vh.prototype.valueOf),LR=mV("wks"),Lm=0,MR=kR(vh),vV=MR.length;Lm<vV;Lm++)try{var UR=MR[Lm];gV(vh[UR])&&SV(UR)}catch{}var xR=function(i){if(PR&&PR(i))return!0;try{for(var e=TV(i),t=0,r=kR(LR),n=r.length;t<n;t++)if(LR[r[t]]==e)return!0}catch{}return!1};Pt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:xR}),gi("matcher"),gi("observable"),Pt({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:bR}),Pt({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:xR}),gi("metadataKey"),gi("patternMatch"),gi("replaceAll");var Ic=Zi(hV),Mm=hi,yV=Q_,CV=bs,RV=Wl,IV=Mm("".charAt),VR=Mm("".charCodeAt),wV=Mm("".slice),FR=function(i){return function(e,t){var r,n,a=CV(RV(e)),c=yV(t),l=a.length;return c<0||c>=l?i?"":void 0:(r=VR(a,c))<55296||r>56319||c+1===l||(n=VR(a,c+1))<56320||n>57343?i?IV(a,c):r:i?wV(a,c,c+2):n-56320+(r-55296<<10)+65536}},AV={codeAt:FR(!1),charAt:FR(!0)}.charAt,OV=bs,jR=uh,NV=SR,BR=TR,GR="String Iterator",bV=jR.set,DV=jR.getterFor(GR);NV(String,"String",function(i){bV(this,{type:GR,string:OV(i),index:0})},function(){var i,e=DV(this),t=e.string,r=e.index;return r>=t.length?BR(void 0,!0):(i=AV(t,r),e.index+=i.length,BR(i,!1))});var WR=Zi(Sc.f("iterator"));function ed(i){return ed=typeof Ic=="function"&&typeof WR=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Ic=="function"&&e.constructor===Ic&&e!==Ic.prototype?"symbol":typeof e},ed(i)}var PV=Zi(Sc.f("toPrimitive"));function kV(i){var e=function(t,r){if(ed(t)!=="object"||t===null)return t;var n=t[PV];if(n!==void 0){var a=n.call(t,r||"default");if(ed(a)!=="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(r==="string"?String:Number)(t)}(i,"string");return ed(e)==="symbol"?e:String(e)}function g(i,e,t){return(e=kV(e))in i?HM(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}var LV=ho("Array").keys,MV=po,UV=or,xV=Gn,VV=LV,Um=Array.prototype,FV={DOMTokenList:!0,NodeList:!0},Ur=Zi(function(i){var e=i.keys;return i===Um||xV(Um,i)&&e===Um.keys||UV(FV,MV(i))?VV:e}),HR=fc,jV=TypeError,KR=fC,BV=Math.floor,xm=function(i,e){var t=i.length,r=BV(t/2);return t<8?GV(i,e):WV(i,xm(KR(i,0,r),e),xm(KR(i,r),e),e)},GV=function(i,e){for(var t,r,n=i.length,a=1;a<n;){for(r=a,t=i[a];r&&e(i[r-1],t)>0;)i[r]=i[--r];r!==a++&&(i[r]=t)}return i},WV=function(i,e,t,r){for(var n=e.length,a=t.length,c=0,l=0;c<n||l<a;)i[c+l]=c<n&&l<a?r(e[c],t[l])<=0?e[c++]:t[l++]:c<n?e[c++]:t[l++];return i},HV=xm,KV=Ei,zR=function(i,e){var t=[][i];return!!t&&KV(function(){t.call(null,e||function(){return 1},1)})},YR=oo.match(/firefox\/(\d+)/i),zV=!!YR&&+YR[1],YV=/MSIE|Trident/.test(oo),qR=oo.match(/AppleWebKit\/(\d+)\./),qV=!!qR&&+qR[1],JV=Pt,JR=hi,XV=Cn,QV=lo,XR=uo,$V=function(i,e){if(!delete i[e])throw jV("Cannot delete property "+HR(e)+" of "+HR(i))},QR=bs,Vm=Ei,ZV=HV,eF=zR,$R=zV,tF=YV,ZR=co,eI=qV,oa=[],tI=JR(oa.sort),iF=JR(oa.push),rF=Vm(function(){oa.sort(void 0)}),nF=Vm(function(){oa.sort(null)}),sF=eF("sort"),iI=!Vm(function(){if(ZR)return ZR<70;if(!($R&&$R>3)){if(tF)return!0;if(eI)return eI<603;var i,e,t,r,n="";for(i=65;i<76;i++){switch(e=String.fromCharCode(i),i){case 66:case 69:case 70:case 72:t=3;break;case 68:case 71:t=4;break;default:t=2}for(r=0;r<47;r++)oa.push({k:e+r,v:t})}for(oa.sort(function(a,c){return c.v-a.v}),r=0;r<oa.length;r++)e=oa[r].k.charAt(0),n.charAt(n.length-1)!==e&&(n+=e);return n!=="DGBEFHACIJK"}});JV({target:"Array",proto:!0,forced:rF||!nF||!sF||!iI},{sort:function(i){i!==void 0&&XV(i);var e=QV(this);if(iI)return i===void 0?tI(e):tI(e,i);var t,r,n=[],a=XR(e);for(r=0;r<a;r++)r in e&&iF(n,e[r]);for(ZV(n,function(c){return function(l,u){return u===void 0?-1:l===void 0?1:c!==void 0?+c(l,u)||0:QR(l)>QR(u)?1:-1}}(i)),t=XR(n),r=0;r<t;)e[r]=n[r++];for(;r<a;)$V(e,r++);return e}});var aF=ho("Array").sort,oF=Gn,cF=aF,Fm=Array.prototype,td=Zi(function(i){var e=i.sort;return i===Fm||oF(Fm,i)&&e===Fm.sort?cF:e}),lF=Lr,dF=oh,uF=ch,hF=Wn,pF=hi([].concat),fF=lF("Reflect","ownKeys")||function(i){var e=dF.f(hF(i)),t=uF.f;return t?pF(e,t(i)):e},rI=or,_F=fF,mF=Gl,EF=Rn,gF=yn,SF=na,nI=Error,TF=hi("".replace),vF=String(nI("zxcasd").stack),sI=/\n\s*at [^:]*:[^\n]*/,yF=sI.test(vF),CF=no,RF=!Ei(function(){var i=Error("a");return!("stack"in i)||(Object.defineProperty(i,"stack",CF(1,7)),i.stack!==7)}),IF=na,wF=function(i,e){if(yF&&typeof i=="string"&&!nI.prepareStackTrace)for(;e--;)i=TF(i,sI,"");return i},AF=RF,aI=Error.captureStackTrace,OF=Rc,NF=ni("iterator"),bF=Array.prototype,DF=po,oI=V_,PF=Qu,kF=Rc,LF=ni("iterator"),cI=function(i){if(!PF(i))return oI(i,LF)||oI(i,"@@iterator")||kF[DF(i)]},MF=ar,UF=Cn,xF=Wn,VF=fc,FF=cI,jF=TypeError,BF=ar,lI=Wn,GF=V_,WF=zl,HF=ar,KF=Wn,zF=fc,YF=function(i){return i!==void 0&&(OF.Array===i||bF[NF]===i)},qF=uo,dI=Gn,JF=function(i,e){var t=arguments.length<2?FF(i):e;if(UF(t))return xF(MF(t,i));throw jF(VF(i)+" is not iterable")},XF=cI,uI=function(i,e,t){var r,n;lI(i);try{if(!(r=GF(i,"return"))){if(e==="throw")throw t;return t}r=BF(r,i)}catch(a){n=!0,r=a}if(e==="throw")throw t;if(n)throw r;return lI(r),t},QF=TypeError,yh=function(i,e){this.stopped=i,this.result=e},hI=yh.prototype,id=function(i,e,t){var r,n,a,c,l,u,h,p=t&&t.that,_=!(!t||!t.AS_ENTRIES),E=!(!t||!t.IS_RECORD),T=!(!t||!t.IS_ITERATOR),w=!(!t||!t.INTERRUPTED),C=WF(e,p),O=function(k){return r&&uI(r,"normal",k),new yh(!0,k)},b=function(k){return _?(KF(k),w?C(k[0],k[1],O):C(k[0],k[1])):w?C(k,O):C(k)};if(E)r=i.iterator;else if(T)r=i;else{if(!(n=XF(i)))throw QF(zF(i)+" is not iterable");if(YF(n)){for(a=0,c=qF(i);c>a;a++)if((l=b(i[a]))&&dI(hI,l))return l;return new yh(!1)}r=JF(i,n)}for(u=E?i.next:r.next;!(h=HF(u,r)).done;){try{l=b(h.value)}catch(k){uI(r,"throw",k)}if(typeof l=="object"&&l&&dI(hI,l))return l}return new yh(!1)},$F=bs,ZF=Pt,ej=Gn,tj=Om,Ch=Kx,ij=function(i,e,t){for(var r=_F(e),n=EF.f,a=mF.f,c=0;c<r.length;c++){var l=r[c];rI(i,l)||t&&rI(t,l)||n(i,l,a(e,l))}},pI=ah,jm=na,Bm=no,rj=function(i,e){gF(e)&&"cause"in e&&SF(i,"cause",e.cause)},nj=function(i,e,t,r){AF&&(aI?aI(i,e):IF(i,"stack",wF(t,r)))},sj=id,aj=function(i,e){return i===void 0?arguments.length<2?"":e:$F(i)},oj=ni("toStringTag"),Rh=Error,cj=[].push,wc=function(i,e){var t,r=ej(Gm,this);Ch?t=Ch(Rh(),r?tj(this):Gm):(t=r?this:pI(Gm),jm(t,oj,"Error")),e!==void 0&&jm(t,"message",aj(e)),nj(t,wc,t.stack,1),arguments.length>2&&rj(t,arguments[2]);var n=[];return sj(i,cj,{that:n}),jm(t,"errors",n),t};Ch?Ch(wc,Rh):ij(wc,Rh,{name:!0});var Gm=wc.prototype=pI(Rh.prototype,{constructor:Bm(1,wc),message:Bm(1,""),name:Bm(1,"AggregateError")});ZF({global:!0,constructor:!0,arity:2},{AggregateError:wc});var rd,Ac,fI,Wm,nd=typeof process<"u"&&ia(process)=="process",lj=Lr,dj=EC,uj=ss,_I=ni("species"),hj=Gn,pj=TypeError,fj=Xy,_j=fc,mj=TypeError,mI=Wn,Ej=function(i){if(fj(i))return i;throw mj(_j(i)+" is not a constructor")},gj=Qu,Sj=ni("species"),EI=function(i,e){var t,r=mI(i).constructor;return r===void 0||gj(t=mI(r)[Sj])?e:Ej(t)},Tj=TypeError,gI=/(?:ipad|iphone|ipod).*applewebkit/i.test(oo),tn=Hi,vj=N_,yj=zl,SI=bi,Cj=or,TI=Ei,vI=aC,Rj=KC,yI=z_,Ij=function(i,e){if(i<e)throw Tj("Not enough arguments");return i},wj=gI,Aj=nd,Hm=tn.setImmediate,Km=tn.clearImmediate,Oj=tn.process,zm=tn.Dispatch,Nj=tn.Function,CI=tn.MessageChannel,bj=tn.String,Ym=0,sd={},RI="onreadystatechange";TI(function(){rd=tn.location});var qm=function(i){if(Cj(sd,i)){var e=sd[i];delete sd[i],e()}},Jm=function(i){return function(){qm(i)}},II=function(i){qm(i.data)},wI=function(i){tn.postMessage(bj(i),rd.protocol+"//"+rd.host)};Hm&&Km||(Hm=function(i){Ij(arguments.length,1);var e=SI(i)?i:Nj(i),t=Rj(arguments,1);return sd[++Ym]=function(){vj(e,void 0,t)},Ac(Ym),Ym},Km=function(i){delete sd[i]},Aj?Ac=function(i){Oj.nextTick(Jm(i))}:zm&&zm.now?Ac=function(i){zm.now(Jm(i))}:CI&&!wj?(Wm=(fI=new CI).port2,fI.port1.onmessage=II,Ac=yj(Wm.postMessage,Wm)):tn.addEventListener&&SI(tn.postMessage)&&!tn.importScripts&&rd&&rd.protocol!=="file:"&&!TI(wI)?(Ac=wI,tn.addEventListener("message",II,!1)):Ac=RI in yI("script")?function(i){vI.appendChild(yI("script"))[RI]=function(){vI.removeChild(this),qm(i)}}:function(i){setTimeout(Jm(i),0)});var AI={set:Hm,clear:Km},OI=function(){this.head=null,this.tail=null};OI.prototype={add:function(i){var e={item:i,next:null},t=this.tail;t?t.next=e:this.head=e,this.tail=e},get:function(){var i=this.head;if(i)return(this.head=i.next)===null&&(this.tail=null),i.item}};var Oc,Xm,Qm,$m,NI,bI=OI,Dj=/ipad|iphone|ipod/i.test(oo)&&typeof Pebble<"u",Pj=/web0s(?!.*chrome)/i.test(oo),Eo=Hi,DI=zl,kj=Gl.f,Zm=AI.set,Lj=bI,Mj=gI,Uj=Dj,xj=Pj,eE=nd,PI=Eo.MutationObserver||Eo.WebKitMutationObserver,kI=Eo.document,LI=Eo.process,Ih=Eo.Promise,MI=kj(Eo,"queueMicrotask"),tE=MI&&MI.value;if(!tE){var wh=new Lj,Ah=function(){var i,e;for(eE&&(i=LI.domain)&&i.exit();e=wh.get();)try{e()}catch(t){throw wh.head&&Oc(),t}i&&i.enter()};Mj||eE||xj||!PI||!kI?!Uj&&Ih&&Ih.resolve?(($m=Ih.resolve(void 0)).constructor=Ih,NI=DI($m.then,$m),Oc=function(){NI(Ah)}):eE?Oc=function(){LI.nextTick(Ah)}:(Zm=DI(Zm,Eo),Oc=function(){Zm(Ah)}):(Xm=!0,Qm=kI.createTextNode(""),new PI(Ah).observe(Qm,{characterData:!0}),Oc=function(){Qm.data=Xm=!Xm}),tE=function(i){wh.head||Oc(),wh.add(i)}}var Vj=tE,Nc=function(i){try{return{error:!1,value:i()}}catch(e){return{error:!0,value:e}}},go=Hi.Promise,UI=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",Fj=!UI&&!nd&&typeof window=="object"&&typeof document=="object",jj=Hi,ad=go,Bj=bi,Gj=Dy,Wj=Ky,Hj=ni,Kj=Fj,zj=UI,iE=co,xI=ad&&ad.prototype,Yj=Hj("species"),VI=!1,FI=Bj(jj.PromiseRejectionEvent),qj=Gj("Promise",function(){var i=Wj(ad),e=i!==String(ad);if(!e&&iE===66||!xI.catch||!xI.finally)return!0;if(!iE||iE<51||!/native code/.test(i)){var t=new ad(function(n){n(1)}),r=function(n){n(function(){},function(){})};if((t.constructor={})[Yj]=r,!(VI=t.then(function(){})instanceof r))return!0}return!e&&(Kj||zj)&&!FI}),od={CONSTRUCTOR:qj,REJECTION_EVENT:FI,SUBCLASSING:VI},os={},jI=Cn,Jj=TypeError,Xj=function(i){var e,t;this.promise=new i(function(r,n){if(e!==void 0||t!==void 0)throw Jj("Bad Promise constructor");e=r,t=n}),this.resolve=jI(e),this.reject=jI(t)};os.f=function(i){return new Xj(i)};var rE,BI,Qj=Pt,Oh=nd,ca=Hi,cd=ar,$j=ql,Zj=Tc,eB=function(i){var e=lj(i);uj&&e&&!e[_I]&&dj(e,_I,{configurable:!0,get:function(){return this}})},tB=Cn,nE=bi,iB=yn,rB=function(i,e){if(hj(e,i))return i;throw pj("Incorrect invocation")},nB=EI,GI=AI.set,sE=Vj,sB=function(i,e){try{arguments.length==1?console.error(i):console.error(i,e)}catch{}},aB=Nc,oB=bI,WI=uh,aE=go,HI=od,KI=os,Nh="Promise",zI=HI.CONSTRUCTOR,cB=HI.REJECTION_EVENT,oE=WI.getterFor(Nh),lB=WI.set,dB=aE&&aE.prototype,ld=aE,cE=dB,YI=ca.TypeError,lE=ca.document,dE=ca.process,uE=KI.f,uB=uE,hB=!!(lE&&lE.createEvent&&ca.dispatchEvent),qI="unhandledrejection",JI=function(i){var e;return!(!iB(i)||!nE(e=i.then))&&e},XI=function(i,e){var t,r,n,a=e.value,c=e.state==1,l=c?i.ok:i.fail,u=i.resolve,h=i.reject,p=i.domain;try{l?(c||(e.rejection===2&&fB(e),e.rejection=1),l===!0?t=a:(p&&p.enter(),t=l(a),p&&(p.exit(),n=!0)),t===i.promise?h(YI("Promise-chain cycle")):(r=JI(t))?cd(r,t,u,h):u(t)):h(a)}catch(_){p&&!n&&p.exit(),h(_)}},QI=function(i,e){i.notified||(i.notified=!0,sE(function(){for(var t,r=i.reactions;t=r.get();)XI(t,i);i.notified=!1,e&&!i.rejection&&pB(i)}))},$I=function(i,e,t){var r,n;hB?((r=lE.createEvent("Event")).promise=e,r.reason=t,r.initEvent(i,!1,!0),ca.dispatchEvent(r)):r={promise:e,reason:t},!cB&&(n=ca["on"+i])?n(r):i===qI&&sB("Unhandled promise rejection",t)},pB=function(i){cd(GI,ca,function(){var e,t=i.facade,r=i.value;if(ZI(i)&&(e=aB(function(){Oh?dE.emit("unhandledRejection",r,t):$I(qI,t,r)}),i.rejection=Oh||ZI(i)?2:1,e.error))throw e.value})},ZI=function(i){return i.rejection!==1&&!i.parent},fB=function(i){cd(GI,ca,function(){var e=i.facade;Oh?dE.emit("rejectionHandled",e):$I("rejectionhandled",e,i.value)})},bc=function(i,e,t){return function(r){i(e,r,t)}},Dc=function(i,e,t){i.done||(i.done=!0,t&&(i=t),i.value=e,i.state=2,QI(i,!0))},hE=function(i,e,t){if(!i.done){i.done=!0,t&&(i=t);try{if(i.facade===e)throw YI("Promise can't be resolved itself");var r=JI(e);r?sE(function(){var n={done:!1};try{cd(r,e,bc(hE,n,i),bc(Dc,n,i))}catch(a){Dc(n,a,i)}}):(i.value=e,i.state=1,QI(i,!1))}catch(n){Dc({done:!1},n,i)}}};zI&&(cE=(ld=function(i){rB(this,cE),tB(i),cd(rE,this);var e=oE(this);try{i(bc(hE,e),bc(Dc,e))}catch(t){Dc(e,t)}}).prototype,(rE=function(i){lB(this,{type:Nh,done:!1,notified:!1,parent:!1,reactions:new oB,rejection:!1,state:0,value:void 0})}).prototype=$j(cE,"then",function(i,e){var t=oE(this),r=uE(nB(this,ld));return t.parent=!0,r.ok=!nE(i)||i,r.fail=nE(e)&&e,r.domain=Oh?dE.domain:void 0,t.state==0?t.reactions.add(r):sE(function(){XI(r,t)}),r.promise}),BI=function(){var i=new rE,e=oE(i);this.promise=i,this.resolve=bc(hE,e),this.reject=bc(Dc,e)},KI.f=uE=function(i){return i===ld||i===void 0?new BI(i):uB(i)}),Qj({global:!0,constructor:!0,wrap:!0,forced:zI},{Promise:ld}),Zj(ld,Nh,!1,!0),eB(Nh);var ew=ni("iterator"),tw=!1;try{var _B=0,iw={next:function(){return{done:!!_B++}},return:function(){tw=!0}};iw[ew]=function(){return this},Array.from(iw,function(){throw 2})}catch{}var mB=go,EB=function(i,e){if(!e&&!tw)return!1;var t=!1;try{var r={};r[ew]=function(){return{next:function(){return{done:t=!0}}}},i(r)}catch{}return t},bh=od.CONSTRUCTOR||!EB(function(i){mB.all(i).then(void 0,function(){})}),gB=ar,SB=Cn,TB=os,vB=Nc,yB=id;Pt({target:"Promise",stat:!0,forced:bh},{all:function(i){var e=this,t=TB.f(e),r=t.resolve,n=t.reject,a=vB(function(){var c=SB(e.resolve),l=[],u=0,h=1;yB(i,function(p){var _=u++,E=!1;h++,gB(c,e,p).then(function(T){E||(E=!0,l[_]=T,--h||r(l))},n)}),--h||r(l)});return a.error&&n(a.value),t.promise}});var CB=Pt,RB=od.CONSTRUCTOR;go&&go.prototype,CB({target:"Promise",proto:!0,forced:RB,real:!0},{catch:function(i){return this.then(void 0,i)}});var IB=ar,wB=Cn,AB=os,OB=Nc,NB=id;Pt({target:"Promise",stat:!0,forced:bh},{race:function(i){var e=this,t=AB.f(e),r=t.reject,n=OB(function(){var a=wB(e.resolve);NB(i,function(c){IB(a,e,c).then(t.resolve,r)})});return n.error&&r(n.value),t.promise}});var bB=ar,DB=os;Pt({target:"Promise",stat:!0,forced:od.CONSTRUCTOR},{reject:function(i){var e=DB.f(this);return bB(e.reject,void 0,i),e.promise}});var PB=Wn,kB=yn,LB=os,rw=function(i,e){if(PB(i),kB(e)&&e.constructor===i)return e;var t=LB.f(i);return(0,t.resolve)(e),t.promise},MB=Pt,UB=go,xB=od.CONSTRUCTOR,VB=rw,FB=Lr("Promise"),jB=!xB;MB({target:"Promise",stat:!0,forced:!0},{resolve:function(i){return VB(jB&&this===FB?UB:this,i)}});var BB=ar,GB=Cn,WB=os,HB=Nc,KB=id;Pt({target:"Promise",stat:!0,forced:bh},{allSettled:function(i){var e=this,t=WB.f(e),r=t.resolve,n=t.reject,a=HB(function(){var c=GB(e.resolve),l=[],u=0,h=1;KB(i,function(p){var _=u++,E=!1;h++,BB(c,e,p).then(function(T){E||(E=!0,l[_]={status:"fulfilled",value:T},--h||r(l))},function(T){E||(E=!0,l[_]={status:"rejected",reason:T},--h||r(l))})}),--h||r(l)});return a.error&&n(a.value),t.promise}});var zB=ar,YB=Cn,qB=Lr,JB=os,XB=Nc,QB=id,nw="No one promise resolved";Pt({target:"Promise",stat:!0,forced:bh},{any:function(i){var e=this,t=qB("AggregateError"),r=JB.f(e),n=r.resolve,a=r.reject,c=XB(function(){var l=YB(e.resolve),u=[],h=0,p=1,_=!1;QB(i,function(E){var T=h++,w=!1;p++,zB(l,e,E).then(function(C){w||_||(_=!0,n(C))},function(C){w||_||(w=!0,u[T]=C,--p||a(new t(u,nw)))})}),--p||a(new t(u,nw))});return c.error&&a(c.value),r.promise}});var $B=Pt,pE=go,ZB=Ei,e3=Lr,t3=bi,i3=EI,sw=rw,r3=pE&&pE.prototype;$B({target:"Promise",proto:!0,real:!0,forced:!!pE&&ZB(function(){r3.finally.call({then:function(){}},function(){})})},{finally:function(i){var e=i3(this,e3("Promise")),t=t3(i);return this.then(t?function(r){return sw(e,i()).then(function(){return r})}:i,t?function(r){return sw(e,i()).then(function(){throw r})}:i)}});var aw=ao.Promise,F=Zi(aw);let n3=()=>{};function dd(){let i={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:n3};return i.promise=new F((e,t)=>{i.resolve=r=>{i.isFinished||(i.isResolved=!0,i.isFinished=!0,e(r),i.value=r)},i.reject=r=>{i.isFinished||(i.isRejected=!0,i.isFinished=!0,t(r))}}),i}let Dh=new Map,Ph=new Map,cs=new Map;var Jt,Xe;(function(i){i.WIN_10="Windows 10",i.WIN_81="Windows 8.1",i.WIN_8="Windows 8",i.WIN_7="Windows 7",i.WIN_VISTA="Windows Vista",i.WIN_SERVER_2003="Windows Server 2003",i.WIN_XP="Windows XP",i.WIN_2000="Windows 2000",i.ANDROID="Android",i.HARMONY_OS="HarmonyOS",i.OPEN_BSD="Open BSD",i.SUN_OS="Sun OS",i.LINUX="Linux",i.IOS="iOS",i.MAC_OS="Mac OS",i.QNX="QNX",i.UNIX="UNIX",i.BEOS="BeOS",i.OS_2="OS/2",i.SEARCH_BOT="Search Bot"})(Jt||(Jt={})),function(i){i.CHROME="Chrome",i.SAFARI="Safari",i.EDGE="Edge",i.FIREFOX="Firefox",i.OPERA="OPR",i.QQ="QQBrowser",i.WECHAT="MicroMessenger"}(Xe||(Xe={}));var fE={exports:{}};(function(i,e){(function(t,r){var n="function",a="undefined",c="object",l="string",u="major",h="model",p="name",_="type",E="vendor",T="version",w="architecture",C="console",O="mobile",b="tablet",k="smarttv",U="wearable",X="embedded",z="Amazon",j="Apple",B="ASUS",W="BlackBerry",ce="Browser",ne="Chrome",Pe="Firefox",We="Google",It="Huawei",Gt="LG",pt="Microsoft",Ir="Motorola",Z="Opera",re="Samsung",he="Sharp",Ne="Sony",qe="Xiaomi",oe="Zebra",y="Facebook",N="Chromium OS",M="Mac OS",ie=function(bt){for(var Wt={},ft=0;ft<bt.length;ft++)Wt[bt[ft].toUpperCase()]=bt[ft];return Wt},De=function(bt,Wt){return typeof bt===l&&gt(Wt).indexOf(gt(bt))!==-1},gt=function(bt){return bt.toLowerCase()},Oi=function(bt,Wt){if(typeof bt===l)return bt=bt.replace(/^\s\s*/,""),typeof Wt===a?bt:bt.substring(0,350)},wr=function(bt,Wt){for(var ft,Ar,Cs,Dt,Je,mr,ka=0;ka<Wt.length&&!Je;){var Jn=Wt[ka],lb=Wt[ka+1];for(ft=Ar=0;ft<Jn.length&&!Je&&Jn[ft];)if(Je=Jn[ft++].exec(bt))for(Cs=0;Cs<lb.length;Cs++)mr=Je[++Ar],typeof(Dt=lb[Cs])===c&&Dt.length>0?Dt.length===2?typeof Dt[1]==n?this[Dt[0]]=Dt[1].call(this,mr):this[Dt[0]]=Dt[1]:Dt.length===3?typeof Dt[1]!==n||Dt[1].exec&&Dt[1].test?this[Dt[0]]=mr?mr.replace(Dt[1],Dt[2]):r:this[Dt[0]]=mr?Dt[1].call(this,mr,Dt[2]):r:Dt.length===4&&(this[Dt[0]]=mr?Dt[3].call(this,mr.replace(Dt[1],Dt[2])):r):this[Dt]=mr||r;ka+=2}},Ws=function(bt,Wt){for(var ft in Wt)if(typeof Wt[ft]===c&&Wt[ft].length>0){for(var Ar=0;Ar<Wt[ft].length;Ar++)if(De(Wt[ft][Ar],bt))return ft==="?"?r:ft}else if(De(Wt[ft],bt))return ft==="?"?r:ft;return bt},$p={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Zp={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[T,[p,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[T,[p,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[p,T],[/opios[\/ ]+([\w\.]+)/i],[T,[p,Z+" Mini"]],[/\bopr\/([\w\.]+)/i],[T,[p,Z]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[p,T],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[T,[p,"UC"+ce]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[T,[p,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[T,[p,"WeChat"]],[/konqueror\/([\w\.]+)/i],[T,[p,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[T,[p,"IE"]],[/yabrowser\/([\w\.]+)/i],[T,[p,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[p,/(.+)/,"$1 Secure "+ce],T],[/\bfocus\/([\w\.]+)/i],[T,[p,Pe+" Focus"]],[/\bopt\/([\w\.]+)/i],[T,[p,Z+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[T,[p,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[T,[p,"Dolphin"]],[/coast\/([\w\.]+)/i],[T,[p,Z+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[T,[p,"MIUI "+ce]],[/fxios\/([-\w\.]+)/i],[T,[p,Pe]],[/\bqihu|(qi?ho?o?|360)browser/i],[[p,"360 "+ce]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[p,/(.+)/,"$1 "+ce],T],[/(comodo_dragon)\/([\w\.]+)/i],[[p,/_/g," "],T],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[p,T],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[p],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[p,y],T],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[p,T],[/\bgsa\/([\w\.]+) .*safari\//i],[T,[p,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[T,[p,ne+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[p,ne+" WebView"],T],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[T,[p,"Android "+ce]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[p,T],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[T,[p,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[T,p],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[p,[T,Ws,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[p,T],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[p,"Netscape"],T],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[T,[p,Pe+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[p,T],[/(cobalt)\/([\w\.]+)/i],[p,[T,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[w,"amd64"]],[/(ia32(?=;))/i],[[w,gt]],[/((?:i[346]|x)86)[;\)]/i],[[w,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[w,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[w,"armhf"]],[/windows (ce|mobile); ppc;/i],[[w,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[w,/ower/,"",gt]],[/(sun4\w)[;\)]/i],[[w,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[w,gt]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[h,[E,re],[_,b]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[h,[E,re],[_,O]],[/\((ip(?:hone|od)[\w ]*);/i],[h,[E,j],[_,O]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[h,[E,j],[_,b]],[/(macintosh);/i],[h,[E,j]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[h,[E,he],[_,O]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[h,[E,It],[_,b]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[h,[E,It],[_,O]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[h,/_/g," "],[E,qe],[_,O]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[h,/_/g," "],[E,qe],[_,b]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[h,[E,"OPPO"],[_,O]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[h,[E,"Vivo"],[_,O]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[h,[E,"Realme"],[_,O]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[h,[E,Ir],[_,O]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[h,[E,Ir],[_,b]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[h,[E,Gt],[_,b]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[h,[E,Gt],[_,O]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[h,[E,"Lenovo"],[_,b]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[h,/_/g," "],[E,"Nokia"],[_,O]],[/(pixel c)\b/i],[h,[E,We],[_,b]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[h,[E,We],[_,O]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[h,[E,Ne],[_,O]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[h,"Xperia Tablet"],[E,Ne],[_,b]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[h,[E,"OnePlus"],[_,O]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[h,[E,z],[_,b]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[h,/(.+)/g,"Fire Phone $1"],[E,z],[_,O]],[/(playbook);[-\w\),; ]+(rim)/i],[h,E,[_,b]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[h,[E,W],[_,O]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[h,[E,B],[_,b]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[h,[E,B],[_,O]],[/(nexus 9)/i],[h,[E,"HTC"],[_,b]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[E,[h,/_/g," "],[_,O]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[h,[E,"Acer"],[_,b]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[h,[E,"Meizu"],[_,O]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[E,h,[_,O]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[E,h,[_,b]],[/(surface duo)/i],[h,[E,pt],[_,b]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[h,[E,"Fairphone"],[_,O]],[/(u304aa)/i],[h,[E,"AT&T"],[_,O]],[/\bsie-(\w*)/i],[h,[E,"Siemens"],[_,O]],[/\b(rct\w+) b/i],[h,[E,"RCA"],[_,b]],[/\b(venue[\d ]{2,7}) b/i],[h,[E,"Dell"],[_,b]],[/\b(q(?:mv|ta)\w+) b/i],[h,[E,"Verizon"],[_,b]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[h,[E,"Barnes & Noble"],[_,b]],[/\b(tm\d{3}\w+) b/i],[h,[E,"NuVision"],[_,b]],[/\b(k88) b/i],[h,[E,"ZTE"],[_,b]],[/\b(nx\d{3}j) b/i],[h,[E,"ZTE"],[_,O]],[/\b(gen\d{3}) b.+49h/i],[h,[E,"Swiss"],[_,O]],[/\b(zur\d{3}) b/i],[h,[E,"Swiss"],[_,b]],[/\b((zeki)?tb.*\b) b/i],[h,[E,"Zeki"],[_,b]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[E,"Dragon Touch"],h,[_,b]],[/\b(ns-?\w{0,9}) b/i],[h,[E,"Insignia"],[_,b]],[/\b((nxa|next)-?\w{0,9}) b/i],[h,[E,"NextBook"],[_,b]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[E,"Voice"],h,[_,O]],[/\b(lvtel\-)?(v1[12]) b/i],[[E,"LvTel"],h,[_,O]],[/\b(ph-1) /i],[h,[E,"Essential"],[_,O]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[h,[E,"Envizen"],[_,b]],[/\b(trio[-\w\. ]+) b/i],[h,[E,"MachSpeed"],[_,b]],[/\btu_(1491) b/i],[h,[E,"Rotor"],[_,b]],[/(shield[\w ]+) b/i],[h,[E,"Nvidia"],[_,b]],[/(sprint) (\w+)/i],[E,h,[_,O]],[/(kin\.[onetw]{3})/i],[[h,/\./g," "],[E,pt],[_,O]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[h,[E,oe],[_,b]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[h,[E,oe],[_,O]],[/smart-tv.+(samsung)/i],[E,[_,k]],[/hbbtv.+maple;(\d+)/i],[[h,/^/,"SmartTV"],[E,re],[_,k]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[E,Gt],[_,k]],[/(apple) ?tv/i],[E,[h,j+" TV"],[_,k]],[/crkey/i],[[h,ne+"cast"],[E,We],[_,k]],[/droid.+aft(\w)( bui|\))/i],[h,[E,z],[_,k]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[h,[E,he],[_,k]],[/(bravia[\w ]+)( bui|\))/i],[h,[E,Ne],[_,k]],[/(mitv-\w{5}) bui/i],[h,[E,qe],[_,k]],[/Hbbtv.*(technisat) (.*);/i],[E,h,[_,k]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[E,Oi],[h,Oi],[_,k]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[_,k]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[E,h,[_,C]],[/droid.+; (shield) bui/i],[h,[E,"Nvidia"],[_,C]],[/(playstation [345portablevi]+)/i],[h,[E,Ne],[_,C]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[h,[E,pt],[_,C]],[/((pebble))app/i],[E,h,[_,U]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[h,[E,j],[_,U]],[/droid.+; (glass) \d/i],[h,[E,We],[_,U]],[/droid.+; (wt63?0{2,3})\)/i],[h,[E,oe],[_,U]],[/(quest( 2| pro)?)/i],[h,[E,y],[_,U]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[E,[_,X]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[h,[_,O]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[h,[_,b]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[_,b]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[_,O]],[/(android[-\w\. ]{0,9});.+buil/i],[h,[E,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[T,[p,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[T,[p,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[p,T],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[T,p]],os:[[/microsoft (windows) (vista|xp)/i],[p,T],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[p,[T,Ws,$p]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[p,"Windows"],[T,Ws,$p]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[T,/_/g,"."],[p,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[p,M],[T,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[T,p],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[p,T],[/\(bb(10);/i],[T,[p,W]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[T,[p,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[T,[p,Pe+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[T,[p,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[T,[p,"watchOS"]],[/crkey\/([\d\.]+)/i],[T,[p,ne+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[p,N],T],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[p,T],[/(sunos) ?([\w\.\d]*)/i],[[p,"Solaris"],T],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[p,T]]},_n=function(bt,Wt){if(typeof bt===c&&(Wt=bt,bt=r),!(this instanceof _n))return new _n(bt,Wt).getResult();var ft=typeof t!==a&&t.navigator?t.navigator:r,Ar=bt||(ft&&ft.userAgent?ft.userAgent:""),Cs=ft&&ft.userAgentData?ft.userAgentData:r,Dt=Wt?function(Je,mr){var ka={};for(var Jn in Je)mr[Jn]&&mr[Jn].length%2==0?ka[Jn]=mr[Jn].concat(Je[Jn]):ka[Jn]=Je[Jn];return ka}(Zp,Wt):Zp;return this.getBrowser=function(){var Je={};return Je[p]=r,Je[T]=r,wr.call(Je,Ar,Dt.browser),Je[u]=function(mr){return typeof mr===l?mr.replace(/[^\d\.]/g,"").split(".")[0]:r}(Je[T]),ft&&ft.brave&&typeof ft.brave.isBrave==n&&(Je[p]="Brave"),Je},this.getCPU=function(){var Je={};return Je[w]=r,wr.call(Je,Ar,Dt.cpu),Je},this.getDevice=function(){var Je={};return Je[E]=r,Je[h]=r,Je[_]=r,wr.call(Je,Ar,Dt.device),!Je[_]&&Cs&&Cs.mobile&&(Je[_]=O),Je[h]=="Macintosh"&&ft&&typeof ft.standalone!==a&&ft.maxTouchPoints&&ft.maxTouchPoints>2&&(Je[h]="iPad",Je[_]=b),Je},this.getEngine=function(){var Je={};return Je[p]=r,Je[T]=r,wr.call(Je,Ar,Dt.engine),Je},this.getOS=function(){var Je={};return Je[p]=r,Je[T]=r,wr.call(Je,Ar,Dt.os),!Je[p]&&Cs&&Cs.platform!="Unknown"&&(Je[p]=Cs.platform.replace(/chrome os/i,N).replace(/macos/i,M)),Je},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Ar},this.setUA=function(Je){return Ar=typeof Je===l&&Je.length>350?Oi(Je,350):Je,this},this.setUA(Ar),this};_n.VERSION="0.7.34",_n.BROWSER=ie([p,T,u]),_n.CPU=ie([w]),_n.DEVICE=ie([h,E,_,C,O,k,b,U,X]),_n.ENGINE=_n.OS=ie([p,T]),i.exports&&(e=i.exports=_n),e.UAParser=_n;var Pa=typeof t!==a&&(t.jQuery||t.Zepto);if(Pa&&!Pa.ua){var dl=new _n;Pa.ua=dl.getResult(),Pa.ua.get=function(){return dl.getUA()},Pa.ua.set=function(bt){dl.setUA(bt);var Wt=dl.getResult();for(var ft in Wt)Pa.ua[ft]=Wt[ft]}}})(typeof window=="object"?window:uc)})(fE,fE.exports);let _E=new(Zi(fE.exports)),Ps=_E.getResult(),mE=null;function ze(i){if(!mE){i&&_E.setUA(i),Ps=_E.getResult();let e=function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return Xe.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Xe.CHROME;case"Safari":case"Mobile Safari":return Xe.SAFARI;case"Edge":return Xe.EDGE;case"Firefox":return Xe.FIREFOX;case"QQBrowser":return Xe.QQ;case"Opera":return Xe.OPERA;case"WeChat":return Xe.WECHAT;default:return a.browser.name||""}}(Ps),t=function(a){let c;return c=a.engine.name==="Blink"?a.engine.version||"":a.browser.version||"",c.split(".")[0]}(Ps),r=function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""}(Ps),n=Ps.os.version;if(!(e&&t&&r&&n))return{name:e,version:t,os:r,osVersion:n};mE={name:e,version:t,os:r,osVersion:n}}return mE}function kh(){return ze().os}function ow(){let i=ze();return"".concat(i.os," ").concat(i.osVersion)}function Lh(){let i=ze();return!!(Ps.engine.name==="WebKit"&&i.os===Jt.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&i.name!==Xe.SAFARI||Fi()&&i.name!==Xe.SAFARI)}function s3(){let i=ze();if(Lh()){if(i.os===Jt.MAC_OS)return!0;if(i.os===Jt.IOS){let e=Ps.os.version&&Ps.os.version.split(".");if(e&&Number(e[0])===14&&e[1]&&Number(e[1])>=3||e&&Number(e[0])>14)return!0}}return!1}function a3(){return Ps.engine.name==="WebKit"}function EE(){return ze().name===Xe.CHROME}function Vi(){return ze().name===Xe.SAFARI}function ht(){return ze().name===Xe.FIREFOX}function Fi(){return ze().os===Jt.IOS}function gE(i){let e=ze();return!(e.name!==Xe.CHROME||!e.osVersion)&&Number(e.version)>=i}function cw(i){let e=ze();return!(e.name!==Xe.EDGE||!e.osVersion)&&Number(e.version)>=i}function lw(i){let e=ze();return!(e.name!==Xe.OPERA||!e.osVersion)&&Number(e.version)>=i}function dw(){let i=ze();return!(i.name!==Xe.CHROME||!i.osVersion)&&Number(i.version)<=90}function uw(){let i=ze();if(i.os!==Jt.IOS||!i.osVersion)return!1;let e=i.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function Pc(){let i=ze();if(i.os!==Jt.IOS||!i.osVersion)return!1;let e=i.osVersion.split(".");return Number(e[0])===15}function SE(){let i=ze();if(i.os!==Jt.IOS||!i.osVersion)return!1;let e=i.osVersion.split(".");return Number(e[0])===16}function hw(){let i=ze();if(i.os!==Jt.IOS||!i.osVersion)return!1;let e=i.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function ls(){return Vi()&&navigator.maxTouchPoints>0}function pw(){return ze().name===Xe.WECHAT}function fw(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function la(){let i=ze();return i.name===Xe.EDGE||i.name===Xe.SAFARI?!1:!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Mh(){return kh()===Jt.ANDROID}function ud(){let i=ze();return Mh()&&(i.name===Xe.CHROME||i.name===Xe.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}var A;(function(i){i.UNEXPECTED_ERROR="UNEXPECTED_ERROR",i.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",i.TIMEOUT="TIMEOUT",i.INVALID_PARAMS="INVALID_PARAMS",i.NOT_READABLE="NOT_READABLE",i.NOT_SUPPORTED="NOT_SUPPORTED",i.INVALID_OPERATION="INVALID_OPERATION",i.OPERATION_ABORTED="OPERATION_ABORTED",i.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",i.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",i.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",i.DATACHANNEL_FAILED="DATACHANNEL_FAILED",i.NETWORK_ERROR="NETWORK_ERROR",i.NETWORK_TIMEOUT="NETWORK_TIMEOUT",i.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",i.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",i.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",i.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",i.ELECTRON_IS_NULL="ELECTRON_IS_NULL",i.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",i.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",i.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",i.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",i.PERMISSION_DENIED="PERMISSION_DENIED",i.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",i.TRACK_IS_DISABLED="TRACK_IS_DISABLED",i.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",i.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",i.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",i.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",i.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",i.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",i.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",i.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",i.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",i.UID_CONFLICT="UID_CONFLICT",i.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",i.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",i.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",i.INVALID_TRACK="INVALID_TRACK",i.SENDER_NOT_FOUND="SENDER_NOT_FOUND",i.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",i.SET_ANSWER_FAILED="SET_ANSWER_FAILED",i.ICE_FAILED="ICE_FAILED",i.PC_CLOSED="PC_CLOSED",i.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",i.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",i.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",i.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",i.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",i.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",i.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",i.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",i.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",i.INVALID_REMOTE_USER="INVALID_REMOTE_USER",i.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",i.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",i.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",i.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",i.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",i.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",i.WS_ABORT="WS_ABORT",i.WS_DISCONNECT="WS_DISCONNECT",i.WS_ERR="WS_ERR",i.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",i.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",i.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",i.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",i.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",i.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",i.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",i.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",i.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",i.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",i.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",i.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",i.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",i.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",i.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",i.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",i.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",i.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",i.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",i.INVALID_PLUGIN="INVALID_PLUGIN",i.DISCONNECT_P2P="DISCONNECT_P2P",i.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",i.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",i.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",i.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",i.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",i.PROHIBITED_OPERATION="PROHIBITED_OPERATION",i.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED"})(A||(A={}));let Y=class extends Error{constructor(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",t=arguments.length>2?arguments[2]:void 0;super(e),g(this,"code",void 0),g(this,"message",void 0),g(this,"data",void 0),g(this,"name","AgoraRTCException"),this.code=i,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=t}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return i==="error"&&(e||console).error(this.toString()),i==="warning"&&(e||console).warn(this.toString()),this}throw(i){throw this.print("error",i),this}};function So(i,e){if(typeof i!="boolean")throw new Y(A.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function Xt(i,e,t){if(!ge(t).call(t,i))throw new Y(A.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(t)))}function nt(i,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(i<t||i>r||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(n){return typeof n=="number"&&n%1==0}(i))throw new Y(A.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(t,", ").concat(r,"]. integer only"))}function TE(i,e){if(typeof i!="number"){if(!(i.min||i.max||i.ideal||i.exact))throw new Y(A.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));i.min!==void 0&&nt(i.min,"".concat(e,".min"),0,1/0),i.max!==void 0&&nt(i.max,"".concat(e,".max"),1,1/0),i.exact!==void 0&&nt(i.exact,"".concat(e,".exact"),1,1/0),i.ideal!==void 0&&nt(i.ideal,"".concat(e,".ideal"),1,1/0)}else nt(i,e,1,1/0)}function yi(i,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,n=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(i==null)throw new Y(A.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!_w(i,t,r,n))throw new Y(A.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(t,",").concat(r,"].").concat(n?" ASCII characters only.":""))}function ks(i,e){if(!Array.isArray(i))throw new Y(A.INVALID_PARAMS,"".concat(e," should be an array"))}function Tt(i){return i==null}function _w(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,r=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof i=="string"&&i.length<=t&&i.length>=e&&(!r||function(n){if(typeof n!="string")return!1;for(let a=0;a<n.length;a+=1){let c=n.charCodeAt(a);if(c<0||c>255)return!1}return!0}(i))}function mw(i,e,t){if("getBigUint64"in DataView.prototype)return i.getBigUint64(e,t);let r=i.getUint32(e,t),n=i.getUint32(e+4,t),a=+!!t,c=+!t;return BigInt(r*c+n*a)<<BigInt(32)|BigInt(r*a+n*c)}function Ew(i,e,t,r){if("setBigUint64"in DataView.prototype)return i.setBigUint64(e,t,r);let n=Number(t>>BigInt(32)),a=Number(t&BigInt(4294967295));r?(i.setUint32(e+4,n,r),i.setUint32(e,a,r)):(i.setUint32(e,n,r),i.setUint32(e+4,a,r))}var kc,Uh;(function(i){i.COVERED="COVERED",i.POSITION="POSITION",i.SIZE="SIZE",i.STYLE="STYLE"})(kc||(kc={})),function(i){i.UNMOUNTED="UNMOUNTED",i.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(Uh||(Uh={}));let gw=new class{constructor(){g(this,"_clientSize",null),g(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),g(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),g(this,"getStyle",i=>window.getComputedStyle(i,null)),g(this,"checkCssVisibleProperty",i=>{var e;let t=!0,r=this.getStyle(i),{display:n,visibility:a,opacity:c,filter:l}=r;return(n==="none"||ge(e=["hidden","collapse"]).call(e,a)||Number(c)<.1)&&(t=!1),t?(l&&l.split(" ").filter(u=>{var h;let p=u.split("(")[0];return ge(h=["brightness","blur","opacity"]).call(h,p)}).map(u=>{let[h,p]=u.split(/\(|\)/);return[h,Number(p.match(/^[0-9\.]+/))]}).forEach(u=>{let[h,p]=u;switch(h){case"brightness":(p<.1||p>3)&&(t=!1);break;case"blur":p>3&&(t=!1);break;case"opacity":p<.1&&(t=!1)}}),t):!1}),g(this,"checkPropertyUpToAllParentNodes",(i,e)=>{let t=!0,r=!0,n=c=>e(c),a=i;for(;a&&r;)n(a)||(t=!1,r=!1),a=a.parentElement,a||(r=!1);return t}),g(this,"checkActualCssVisibleIncludeInherit",i=>this.checkPropertyUpToAllParentNodes(i,this.checkCssVisibleProperty)),g(this,"getSizeAboutClient",i=>{let{width:e,height:t,left:r,right:n,top:a,bottom:c}=i.getBoundingClientRect(),l=this.getClientWidth(),u=this.getClientHeight();return{width:e,height:t,left:r,right:n,top:a,bottom:c,clientWidth:l,clientHeight:u,clientMin:Math.min(l,u)}}),g(this,"checkActualSize",()=>{let{width:i,height:e,clientMin:t}=this._clientSize;return this.checkSizeIsVisible(i,e,t)}),g(this,"elementFromPoint",(i,e)=>document.elementFromPoint?document.elementFromPoint(i,e):null),g(this,"checkCoverForAPoint",(i,e,t)=>{let r=this.elementFromPoint(i,e);return r!==null&&r!==t}),g(this,"getPointPositionList",()=>{let{width:i,height:e,left:t,top:r}=this._clientSize,n=i/6,a=e/6,c=[],l=10**6;for(let u=0;u<5;u++)for(let h=0;h<5;h++){let p=(t*l+(u===0?.1:u===4?(n*u*l-1e5)/l:n*u)*l)/l,_=(r*l+(h===0?.1:h===4?(a*h*l-1e5)/l:a*h)*l)/l;c.push({x:p,y:_})}return[...c]}),g(this,"checkElementCover",i=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,i)).filter(e=>!!e).length>6),g(this,"checkSizeIsVisible",(i,e,t)=>(i>50||t/i<=10)&&(e>50||t/e<=10)),g(this,"checkSizeOfPartInClient",()=>{let{left:i,right:e,top:t,bottom:r,clientHeight:n,clientWidth:a,clientMin:c}=this._clientSize,l,u,h,p;if(i<0)l=0;else{if(!(i<a))return!1;l=i}if(e<0)return!1;if(u=e<a?e:a,t<0)h=0;else{if(!(t<n))return!1;h=t}if(r<0)return!1;p=r<n?r:n;let _=u-l,E=p-h;return this.checkSizeIsVisible(_,E,c)}),g(this,"returnHiddenResult",i=>(this._clientSize=null,{visible:!1,reason:i})),g(this,"checkOneElementVisible",i=>{if(i instanceof HTMLElement){if(this.checkElementIsMountedOnDom(i)){if(this.checkActualCssVisibleIncludeInherit(i)){if(this._clientSize=this.getSizeAboutClient(i),this.checkElementCover(i))return this.returnHiddenResult(kc.COVERED);{let e=this.checkActualSize(),t=this.checkSizeOfPartInClient();return e&&!t?this.returnHiddenResult(kc.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(kc.SIZE)}}return this.returnHiddenResult(kc.STYLE)}return this.returnHiddenResult(Uh.UNMOUNTED)}return this.returnHiddenResult(Uh.INVALID_HTML_ELEMENT)}),g(this,"checkElementIsMountedOnDom",i=>this.checkPropertyUpToAllParentNodes(i,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function vE(i){return new TextEncoder().encode(i)}let Sw=function(i,e){let t=new Uint8Array(i.byteLength+e.byteLength);return t.set(new Uint8Array(i),0),t.set(new Uint8Array(e),i.byteLength),t},o3=async i=>{let e=function(a){let c=window.atob(a),l=new Uint8Array(new ArrayBuffer(c.length));for(let u=0;u<c.length;u+=1)l[u]=c.charCodeAt(u);return l}(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),t=await window.crypto.subtle.importKey("spki",e,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),r=vE(i),n=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},t,r);return function(a){let c="";for(let l=0;l<a.length;l+=1)c+=String.fromCharCode(a[l]);return window.btoa(c)}(new Uint8Array(n))},c3=async i=>function(e,t){let r="";return new Uint8Array(e).forEach(n=>{r+=n.toString(t).padStart(2,"0")}),r}(await crypto.subtle.digest("SHA-256",vE(i)),16);class mt{constructor(){g(this,"_events",{}),g(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map(t=>t.listener):[]}on(e,t){this._events[e]||(this._events[e]=[]);let r=this._events[e];this._indexOfListener(r,t)===-1&&r.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);let r=this._events[e];this._indexOfListener(r,t)===-1&&r.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;let r=this._events[e],n=this._indexOfListener(r,t);n!==-1&&r.splice(n,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);let t=this._events[e].map(c=>c);for(var r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];for(let c=0;c<t.length;c+=1){let l=t[c];l.once&&this.off(e,l.listener),l.listener.apply(this,n||[])}}safeEmit(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];[...this._events[e]||[]].forEach(a=>{a.once&&this.off(e,a.listener);try{a.listener.apply(this,r)}catch(c){console.error("safeEmit event:".concat(e," error ").concat(c==null?void 0:c.toString()))}})}_indexOfListener(e,t){let r=e.length;for(;r--;)if(e[r].listener===t)return r;return-1}}let hd=null;function Tw(){if(hd)return hd;if(window.electron)return hd=window.electron;if(!window.require)return null;try{return hd=window.require("electron"),hd}catch{return null}}var jt,St,yE,Ve,je,Qt,ji,Ls;function vw(i){return nt(i.timeout,"config.timeout",0,1e5),nt(i.timeoutFactor,"config.timeoutFactor",0,100,!1),nt(i.maxRetryCount,"config.maxRetryConfig",0,1/0),nt(i.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function Lc(i){if(!Array.isArray(i)||i.length<1)return!1;try{i.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function yw(i){return yi(i.turnServerURL,"turnServerURL"),yi(i.username,"username"),yi(i.password,"password"),i.udpport&&nt(i.udpport,"udpport",1,99999,!0),i.forceturn&&So(i.forceturn,"forceturn"),i.security&&So(i.security,"security"),i.tcpport&&nt(i.tcpport,"tcpport",1,99999,!0),!0}function Cw(i){return i.level!==void 0&&Xt(i.level,"level",[1,2,3]),i.delay!==void 0&&nt(i.delay,"delay",0,3e3,!0),!0}function vt(i,e){for(var t=arguments.length,r=new Array(t>2?t-2:0),n=2;n<t;n++)r[n-2]=arguments[n];return i.getListeners(e).length===0?F.reject(new Y(A.UNEXPECTED_ERROR,"can not emit promise")):new F((a,c)=>{i.emit(e,...r,a,c)})}function st(i,e){if(i.getListeners(e).length===0)return F.resolve();for(var t=arguments.length,r=new Array(t>2?t-2:0),n=2;n<t;n++)r[n-2]=arguments[n];return vt(i,e,...r)}function cr(i,e){if(i.getListeners(e).length===0)return null;for(var t=arguments.length,r=new Array(t>2?t-2:0),n=2;n<t;n++)r[n-2]=arguments[n];return Ms(i,e,...r)}function Ms(i,e){let t=null,r=null;for(var n=arguments.length,a=new Array(n>2?n-2:0),c=2;c<n;c++)a[c-2]=arguments[c];if(i.emit(e,...a,l=>{t=l},l=>{r=l}),r!==null)throw r;if(t===null)throw new Y(A.UNEXPECTED_ERROR,"handler is not sync");return t}(function(i){i.CREATE_CLIENT="createClient",i.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",i.SET_AREA="setArea",i.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",i.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",i.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",i.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",i.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",i.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",i.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",i.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",i.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",i.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",i.START_PROXY_SERVER="Client.startProxyServer",i.STOP_PROXY_SERVER="Client.stopProxyServer",i.SET_PROXY_SERVER="Client.setProxyServer",i.SET_TURN_SERVER="Client.setTurnServer",i.SET_CLIENT_ROLE="Client.setClientRole",i.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",i.ENABLE_DUAL_STREAM="Client.enableDualStream",i.DISABLE_DUAL_STREAM="Client.disableDualStream",i.JOIN="Client.join",i.LEAVE="Client.leave",i.PUBLISH="Client.publish",i.UNPUBLISH="Client.unpublish",i.SUBSCRIBE="Client.subscribe",i.MASS_SUBSCRIBE="Client.massSubscribe",i.MASS_UNSUBSCRIBE="Client.massUnsubscribe",i.UNSUBSCRIBE="Client.unsubscribe",i.RENEW_TOKEN="Client.renewToken",i.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",i.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",i.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",i.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",i.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",i.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",i.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",i.DATACHANNEL_FAILBACK="Client._datachannelFailback",i.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",i.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",i.START_LIVE_STREAMING="Client.startLiveStreaming",i.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",i.STOP_LIVE_STREAMING="Client.stopLiveStreaming",i.ADD_INJECT_STREAM_URL="Client.addInjectStreamUrl",i.REMOVE_INJECT_STREAM_URL="Client.removeInjectStreamUrl",i.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",i.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",i.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",i.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",i.SET_CONFIG_DISTRIBUTE="_configDistribute",i.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",i.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",i.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",i.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",i.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",i.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",i.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",i.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",i.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",i.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",i.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",i.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",i.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",i.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",i.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",i.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",i.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",i.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",i.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",i.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",i.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",i.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",i.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",i.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",i.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",i.STREAM_TYPE_CHANGE="streamTypeChange",i.CONNECTION_STATE_CHANGE="connectionStateChange",i.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",i.IMAGE_MODERATION_UPLOAD="imageModerationUpload"})(jt||(jt={})),function(i){i.TRACER="tracer"}(St||(St={})),function(i){i[i.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",i[i.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",i[i.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(yE||(yE={})),function(i){i.LEAVE="LEAVE",i.NETWORK_ERROR="NETWORK_ERROR",i.SERVER_ERROR="SERVER_ERROR",i.UID_BANNED="UID_BANNED",i.IP_BANNED="IP_BANNED",i.CHANNEL_BANNED="CHANNEL_BANNED",i.FALLBACK="FALLBACK",i.LICENSE_MISSING="LICENSE_MISSING",i.LICENSE_EXPIRED="LICENSE_EXPIRED",i.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",i.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",i.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",i.LICENSE_ILLEGAL="LICENSE_ILLEGAL",i.TOKEN_EXPIRE="TOKEN_EXPIRE"}(Ve||(Ve={})),function(i){i.CONNECTION_STATE_CHANGE="connection-state-change",i.MEDIA_RECONNECT_START="media-reconnect-start",i.MEDIA_RECONNECT_END="media-reconnect-end",i.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",i.USER_JOINED="user-joined",i.USER_LEAVED="user-left",i.USER_PUBLISHED="user-published",i.USER_UNPUBLISHED="user-unpublished",i.USER_INFO_UPDATED="user-info-updated",i.CLIENT_BANNED="client-banned",i.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",i.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",i.VOLUME_INDICATOR="volume-indicator",i.CRYPT_ERROR="crypt-error",i.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",i.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",i.NETWORK_QUALITY="network-quality",i.STREAM_TYPE_CHANGED="stream-type-changed",i.STREAM_FALLBACK="stream-fallback",i.RECEIVE_METADATA="receive-metadata",i.STREAM_MESSAGE="stream-message",i.LIVE_STREAMING_ERROR="live-streaming-error",i.LIVE_STREAMING_WARNING="live-streaming-warning",i.INJECT_STREAM_STATUS="stream-inject-status",i.EXCEPTION="exception",i.ERROR="error",i.P2P_LOST="p2p_lost",i.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",i.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",i.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",i.PUBLISHED_USER_LIST="published-user-list",i.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",i.CONTENT_INSPECT_ERROR="content-inspect-error",i.CONTENT_INSPECT_RESULT="content-inspect-result",i.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change"}(je||(je={})),function(i){i.NETWORK_ERROR="NETWORK_ERROR",i.SERVER_ERROR="SERVER_ERROR",i.MULTI_IP="MULTI_IP",i.TIMEOUT="TIMEOUT",i.OFFLINE="OFFLINE",i.LEAVE="LEAVE",i.P2P_FAILED="P2P_FAILED",i.FALLBACK="FALLBACK"}(Qt||(Qt={})),function(i){i.ONLINE="ONLINE",i.OFFLINE="OFFLINE"}(ji||(ji={})),function(i){i.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",i.ONLINE="ONLINE",i.OFFLINE="OFFLINE"}(Ls||(Ls={}));let Mt=new class extends mt{set networkState(i){this.emit(Ls.NETWORK_STATE_CHANGE,i,this._networkState),i===ji.ONLINE?this.emit(Ls.ONLINE):i===ji.OFFLINE&&(this.onlineWaiter=new F(e=>{this.once(Ls.ONLINE,()=>{this.onlineWaiter=void 0,e(ji.ONLINE)})}),this.emit(Ls.OFFLINE)),this._networkState=i}get networkState(){return this._networkState}get isOnline(){return this._networkState===ji.ONLINE}constructor(){super(),g(this,"_moduleName","network-indicator"),g(this,"_networkState",ji.ONLINE),g(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=ji.ONLINE}),window.addEventListener("offline",()=>{this.networkState=ji.OFFLINE})}};function Rw(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function To(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Rw(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Rw(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function CE(i,e){let t=i.indexOf(e);t!==-1&&i.splice(t,1)}function Mc(i){let e=[];return i.forEach(t=>{e.indexOf(t)===-1&&e.push(t)}),e}function In(i){F!==void 0?F.resolve().then(i):setTimeout(i,0)}function Ut(i){return JSON.parse(JSON.stringify(i))}function vo(i){try{return Ut(i)}catch{return i}}let Iw={};function pd(i,e){Iw[e]||(Iw[e]=!0,i())}function xh(i){let e=window.atob(i),t=new Uint8Array(new ArrayBuffer(e.length));for(let r=0;r<e.length;r+=1)t[r]=e.charCodeAt(r);return t}function Vh(i){let e="";for(let t=0;t<i.length;t+=1)e+=String.fromCharCode(i[t]);return window.btoa(e)}function ds(i){return window.TextEncoder?new TextEncoder().encode(i).length:i.length}function ww(i){let e=0;return/DingTalk/i.test(navigator.userAgent)&&i.realFormData&&(i=i.realFormData),i.forEach(t=>{e+=typeof t=="string"?ds(t):t.size}),e+138}function l3(i){let e=new Y(A.TIMEOUT,"timeout");return new F((t,r)=>{window.setTimeout(()=>r(e),i)})}function Si(i){return new F(e=>{window.setTimeout(e,i)})}function at(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0,t=Math.random().toString(16).substr(2,i).toLowerCase();return t.length===i?"".concat(e).concat(t):"".concat(e).concat(t)+at(i-t.length,"")}function RE(){return at(32,"").toUpperCase()}let Fh=()=>{},Aw=new class{constructor(){g(this,"fnMap",new Map)}throttleByKey(i,e,t,r){for(var n=arguments.length,a=new Array(n>4?n-4:0),c=4;c<n;c++)a[c-4]=arguments[c];if(this.fnMap.has(e)){let l=this.fnMap.get(e);if(l.threshold!==t){l.fn(...l.args),clearTimeout(l.timer);let u=window.setTimeout(()=>{let h=this.fnMap.get(e);h&&h.fn(...h.args),this.fnMap.delete(e)},t);this.fnMap.set(e,{fn:i,threshold:t,timer:u,args:a,skipFn:r})}else l.skipFn&&l.skipFn(...l.args),this.fnMap.set(e,To(To({},l),{},{fn:i,args:a,skipFn:r}))}else{let l=window.setTimeout(()=>{let u=this.fnMap.get(e);u&&u.fn(...u.args),this.fnMap.delete(e)},t);this.fnMap.set(e,{fn:i,threshold:t,timer:l,args:a,skipFn:r})}}},Ow=Aw.throttleByKey.bind(Aw);function Nw(i){return typeof i=="object"&&i!==null&&!(i instanceof RegExp)}function IE(i,e){if(!Nw(i)||!Nw(e)||Array.isArray(i)&&!Array.isArray(e)||!Array.isArray(i)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(i)){let t=[...i];for(let r=0;r<e.length;r++)t[r]=IE(i[r],e[r]);return t}{let t=To({},i);for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&(Object.prototype.hasOwnProperty.call(i,r)?t[r]=IE(i[r],e[r]):t[r]=e[r]);return t}}let d3=1,jh=console;class si{static setLogger(e){jh=e}constructor(e){g(this,"lockingPromise",F.resolve()),g(this,"locks",0),g(this,"name",""),g(this,"lockId",void 0),this.lockId=d3++,e&&(this.name=e),jh.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,jh.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:""));let r=new F(a=>{t=()=>{this.locks-=1,jh.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:"")),a()}}),n=this.lockingPromise.then(()=>t);return this.lockingPromise=this.lockingPromise.then(()=>r),n}}function Uc(i,e){return function(t,r,n){let a=n.value;if(typeof a!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let c=this[e];if(!c)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(i));let l=await c.lock("From ".concat(i,".").concat(r));try{for(var u=arguments.length,h=new Array(u),p=0;p<u;p++)h[p]=arguments[p];return await a.apply(this,h)}finally{l()}},n}}let xt={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function Bh(i,e){let t=Math.floor(e.timeout*Math.pow(e.timeoutFactor,i));return Math.min(e.maxRetryTimeout,t)}function Kn(i,e,t,r){let n=Object.assign({},xt,r),a=n.timeout,c=async()=>{await function(h){return new F(p=>{window.setTimeout(p,h)})}(a),a*=n.timeoutFactor,a=Math.min(n.maxRetryTimeout,a)},l=!1,u=new F(async(h,p)=>{e=e||(()=>!1),t=t||(()=>!0);for(let _=0;_<n.maxRetryCount;_+=1){if(l)return p(new Y(A.OPERATION_ABORTED));try{let E=await i();if(!e(E,_)||_+1===n.maxRetryCount)return h(E);await c()}catch(E){if(!t(E,_)||_+1===n.maxRetryCount)return p(E);await c()}}});return u.cancel=()=>l=!0,u}var u3=Cn,h3=lo,p3=L_,f3=uo,_3=TypeError,bw=function(i){return function(e,t,r,n){u3(t);var a=h3(e),c=p3(a),l=f3(a),u=i?l-1:0,h=i?-1:1;if(r<2)for(;;){if(u in c){n=c[u],u+=h;break}if(u+=h,i?u<0:l<=u)throw _3("Reduce of empty array with no initial value")}for(;i?u>=0:l>u;u+=h)u in c&&(n=t(n,c[u],u,a));return n}},m3={left:bw(!1),right:bw(!0)}.left;Pt({target:"Array",proto:!0,forced:!nd&&co>79&&co<83||!zR("reduce")},{reduce:function(i){var e=arguments.length;return m3(this,i,e,e>1?arguments[1]:void 0)}});var E3=ho("Array").reduce,g3=Gn,S3=E3,wE=Array.prototype,yo=Zi(function(i){var e=i.reduce;return i===wE||g3(wE,i)&&e===wE.reduce?S3:e});let AE=class{constructor(i){g(this,"input",[]),g(this,"size",void 0),this.size=i}add(i){this.input.push(i),this.input.length>this.size&&this.input.splice(0,1)}mean(){var i;return this.input.length===0?0:yo(i=this.input).call(i,(e,t)=>e+t)/this.input.length}};var OE,NE={exports:{}},Dw=function(i,e){return function(){for(var t=new Array(arguments.length),r=0;r<t.length;r++)t[r]=arguments[r];return i.apply(e,t)}},T3=Dw,bE=Object.prototype.toString,DE=(OE=Object.create(null),function(i){var e=bE.call(i);return OE[e]||(OE[e]=e.slice(8,-1).toLowerCase())});function Co(i){return i=i.toLowerCase(),function(e){return DE(e)===i}}function PE(i){return Array.isArray(i)}function Gh(i){return i===void 0}var Pw=Co("ArrayBuffer");function kw(i){return i!==null&&typeof i=="object"}function Wh(i){if(DE(i)!=="object")return!1;var e=Object.getPrototypeOf(i);return e===null||e===Object.prototype}var v3=Co("Date"),y3=Co("File"),C3=Co("Blob"),R3=Co("FileList");function kE(i){return bE.call(i)==="[object Function]"}var I3=Co("URLSearchParams");function LE(i,e){if(i!=null)if(typeof i!="object"&&(i=[i]),PE(i))for(var t=0,r=i.length;t<r;t++)e.call(null,i[t],t,i);else for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&e.call(null,i[n],n,i)}var ME,w3=(ME=typeof Uint8Array<"u"&&Object.getPrototypeOf(Uint8Array),function(i){return ME&&i instanceof ME}),er={isArray:PE,isArrayBuffer:Pw,isBuffer:function(i){return i!==null&&!Gh(i)&&i.constructor!==null&&!Gh(i.constructor)&&typeof i.constructor.isBuffer=="function"&&i.constructor.isBuffer(i)},isFormData:function(i){var e="[object FormData]";return i&&(typeof FormData=="function"&&i instanceof FormData||bE.call(i)===e||kE(i.toString)&&i.toString()===e)},isArrayBufferView:function(i){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(i):i&&i.buffer&&Pw(i.buffer)},isString:function(i){return typeof i=="string"},isNumber:function(i){return typeof i=="number"},isObject:kw,isPlainObject:Wh,isUndefined:Gh,isDate:v3,isFile:y3,isBlob:C3,isFunction:kE,isStream:function(i){return kw(i)&&kE(i.pipe)},isURLSearchParams:I3,isStandardBrowserEnv:function(){return(typeof navigator>"u"||navigator.product!=="ReactNative"&&navigator.product!=="NativeScript"&&navigator.product!=="NS")&&typeof window<"u"&&typeof document<"u"},forEach:LE,merge:function i(){var e={};function t(a,c){Wh(e[c])&&Wh(a)?e[c]=i(e[c],a):Wh(a)?e[c]=i({},a):PE(a)?e[c]=a.slice():e[c]=a}for(var r=0,n=arguments.length;r<n;r++)LE(arguments[r],t);return e},extend:function(i,e,t){return LE(e,function(r,n){i[n]=t&&typeof r=="function"?T3(r,t):r}),i},trim:function(i){return i.trim?i.trim():i.replace(/^\s+|\s+$/g,"")},stripBOM:function(i){return i.charCodeAt(0)===65279&&(i=i.slice(1)),i},inherits:function(i,e,t,r){i.prototype=Object.create(e.prototype,r),i.prototype.constructor=i,t&&Object.assign(i.prototype,t)},toFlatObject:function(i,e,t){var r,n,a,c={};e=e||{};do{for(n=(r=Object.getOwnPropertyNames(i)).length;n-- >0;)c[a=r[n]]||(e[a]=i[a],c[a]=!0);i=Object.getPrototypeOf(i)}while(i&&(!t||t(i,e))&&i!==Object.prototype);return e},kindOf:DE,kindOfTest:Co,endsWith:function(i,e,t){i=String(i),(t===void 0||t>i.length)&&(t=i.length),t-=e.length;var r=i.indexOf(e,t);return r!==-1&&r===t},toArray:function(i){if(!i)return null;var e=i.length;if(Gh(e))return null;for(var t=new Array(e);e-- >0;)t[e]=i[e];return t},isTypedArray:w3,isFileList:R3},xc=er;function Lw(i){return encodeURIComponent(i).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var Mw=function(i,e,t){if(!e)return i;var r;if(t)r=t(e);else if(xc.isURLSearchParams(e))r=e.toString();else{var n=[];xc.forEach(e,function(c,l){c!=null&&(xc.isArray(c)?l+="[]":c=[c],xc.forEach(c,function(u){xc.isDate(u)?u=u.toISOString():xc.isObject(u)&&(u=JSON.stringify(u)),n.push(Lw(l)+"="+Lw(u))}))}),r=n.join("&")}if(r){var a=i.indexOf("#");a!==-1&&(i=i.slice(0,a)),i+=(i.indexOf("?")===-1?"?":"&")+r}return i},A3=er;function Hh(){this.handlers=[]}Hh.prototype.use=function(i,e,t){return this.handlers.push({fulfilled:i,rejected:e,synchronous:!!t&&t.synchronous,runWhen:t?t.runWhen:null}),this.handlers.length-1},Hh.prototype.eject=function(i){this.handlers[i]&&(this.handlers[i]=null)},Hh.prototype.forEach=function(i){A3.forEach(this.handlers,function(e){e!==null&&i(e)})};var Uw,xw,O3=Hh,N3=er;function Vc(){if(xw)return Uw;xw=1;var i=er;function e(n,a,c,l,u){Error.call(this),this.message=n,this.name="AxiosError",a&&(this.code=a),c&&(this.config=c),l&&(this.request=l),u&&(this.response=u)}i.inherits(e,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var t=e.prototype,r={};return["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach(function(n){r[n]={value:n}}),Object.defineProperties(e,r),Object.defineProperty(t,"isAxiosError",{value:!0}),e.from=function(n,a,c,l,u,h){var p=Object.create(t);return i.toFlatObject(n,p,function(_){return _!==Error.prototype}),e.call(p,n.message,a,c,l,u),p.name=n.name,h&&Object.assign(p,h),p},Uw=e}var UE,Vw,Fw,jw,xE,Bw,Gw={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};function Ww(){if(Vw)return UE;Vw=1;var i=er;return UE=function(e,t){t=t||new FormData;var r=[];function n(a){return a===null?"":i.isDate(a)?a.toISOString():i.isArrayBuffer(a)||i.isTypedArray(a)?typeof Blob=="function"?new Blob([a]):Buffer.from(a):a}return function a(c,l){if(i.isPlainObject(c)||i.isArray(c)){if(r.indexOf(c)!==-1)throw Error("Circular reference detected in "+l);r.push(c),i.forEach(c,function(u,h){if(!i.isUndefined(u)){var p,_=l?l+"."+h:h;if(u&&!l&&typeof u=="object"){if(i.endsWith(h,"{}"))u=JSON.stringify(u);else if(i.endsWith(h,"[]")&&(p=i.toArray(u)))return void p.forEach(function(E){!i.isUndefined(E)&&t.append(_,n(E))})}a(u,_)}}),r.pop()}else t.append(l,n(c))}(e),t},UE}function b3(){if(jw)return Fw;jw=1;var i=Vc();return Fw=function(e,t,r){var n=r.config.validateStatus;r.status&&n&&!n(r.status)?t(new i("Request failed with status code "+r.status,[i.ERR_BAD_REQUEST,i.ERR_BAD_RESPONSE][Math.floor(r.status/100)-4],r.config,r.request,r)):e(r)}}function D3(){if(Bw)return xE;Bw=1;var i=er;return xE=i.isStandardBrowserEnv()?{write:function(e,t,r,n,a,c){var l=[];l.push(e+"="+encodeURIComponent(t)),i.isNumber(r)&&l.push("expires="+new Date(r).toGMTString()),i.isString(n)&&l.push("path="+n),i.isString(a)&&l.push("domain="+a),c===!0&&l.push("secure"),document.cookie=l.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},xE}var VE,Hw,Kw,zw,Yw,qw,Jw,Xw,FE,Qw,$w,Zw,P3=function(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)},k3=function(i,e){return e?i.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):i},eA=function(i,e){return i&&!P3(e)?k3(i,e):e};function L3(){if(Hw)return VE;Hw=1;var i=er,e=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];return VE=function(t){var r,n,a,c={};return t&&i.forEach(t.split(`
`),function(l){if(a=l.indexOf(":"),r=i.trim(l.substr(0,a)).toLowerCase(),n=i.trim(l.substr(a+1)),r){if(c[r]&&e.indexOf(r)>=0)return;c[r]=r==="set-cookie"?(c[r]?c[r]:[]).concat([n]):c[r]?c[r]+", "+n:n}}),c},VE}function M3(){if(zw)return Kw;zw=1;var i=er;return Kw=i.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),r=document.createElement("a");function n(a){var c=a;return t&&(r.setAttribute("href",c),c=r.href),r.setAttribute("href",c),{href:r.href,protocol:r.protocol?r.protocol.replace(/:$/,""):"",host:r.host,search:r.search?r.search.replace(/^\?/,""):"",hash:r.hash?r.hash.replace(/^#/,""):"",hostname:r.hostname,port:r.port,pathname:r.pathname.charAt(0)==="/"?r.pathname:"/"+r.pathname}}return e=n(window.location.href),function(a){var c=i.isString(a)?n(a):a;return c.protocol===e.protocol&&c.host===e.host}}():function(){return!0}}function Kh(){if(qw)return Yw;qw=1;var i=Vc();function e(t){i.call(this,t??"canceled",i.ERR_CANCELED),this.name="CanceledError"}return er.inherits(e,i,{__CANCEL__:!0}),Yw=e}function U3(){return Xw||(Xw=1,Jw=function(i){var e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(i);return e&&e[1]||""}),Jw}function x3(){if(Qw)return FE;Qw=1;var i=er,e=b3(),t=D3(),r=Mw,n=eA,a=L3(),c=M3(),l=Gw,u=Vc(),h=Kh(),p=U3();return FE=function(_){return new Promise(function(E,T){var w,C=_.data,O=_.headers,b=_.responseType;function k(){_.cancelToken&&_.cancelToken.unsubscribe(w),_.signal&&_.signal.removeEventListener("abort",w)}i.isFormData(C)&&i.isStandardBrowserEnv()&&delete O["Content-Type"];var U=new XMLHttpRequest;if(_.auth){var X=_.auth.username||"",z=_.auth.password?unescape(encodeURIComponent(_.auth.password)):"";O.Authorization="Basic "+btoa(X+":"+z)}var j=n(_.baseURL,_.url);function B(){if(U){var ne="getAllResponseHeaders"in U?a(U.getAllResponseHeaders()):null,Pe={data:b&&b!=="text"&&b!=="json"?U.response:U.responseText,status:U.status,statusText:U.statusText,headers:ne,config:_,request:U};e(function(We){E(We),k()},function(We){T(We),k()},Pe),U=null}}if(U.open(_.method.toUpperCase(),r(j,_.params,_.paramsSerializer),!0),U.timeout=_.timeout,"onloadend"in U?U.onloadend=B:U.onreadystatechange=function(){U&&U.readyState===4&&(U.status!==0||U.responseURL&&U.responseURL.indexOf("file:")===0)&&setTimeout(B)},U.onabort=function(){U&&(T(new u("Request aborted",u.ECONNABORTED,_,U)),U=null)},U.onerror=function(){T(new u("Network Error",u.ERR_NETWORK,_,U,U)),U=null},U.ontimeout=function(){var ne=_.timeout?"timeout of "+_.timeout+"ms exceeded":"timeout exceeded",Pe=_.transitional||l;_.timeoutErrorMessage&&(ne=_.timeoutErrorMessage),T(new u(ne,Pe.clarifyTimeoutError?u.ETIMEDOUT:u.ECONNABORTED,_,U)),U=null},i.isStandardBrowserEnv()){var W=(_.withCredentials||c(j))&&_.xsrfCookieName?t.read(_.xsrfCookieName):void 0;W&&(O[_.xsrfHeaderName]=W)}"setRequestHeader"in U&&i.forEach(O,function(ne,Pe){C===void 0&&Pe.toLowerCase()==="content-type"?delete O[Pe]:U.setRequestHeader(Pe,ne)}),i.isUndefined(_.withCredentials)||(U.withCredentials=!!_.withCredentials),b&&b!=="json"&&(U.responseType=_.responseType),typeof _.onDownloadProgress=="function"&&U.addEventListener("progress",_.onDownloadProgress),typeof _.onUploadProgress=="function"&&U.upload&&U.upload.addEventListener("progress",_.onUploadProgress),(_.cancelToken||_.signal)&&(w=function(ne){U&&(T(!ne||ne&&ne.type?new h:ne),U.abort(),U=null)},_.cancelToken&&_.cancelToken.subscribe(w),_.signal&&(_.signal.aborted?w():_.signal.addEventListener("abort",w))),C||(C=null);var ce=p(j);ce&&["http","https","file"].indexOf(ce)===-1?T(new u("Unsupported protocol "+ce+":",u.ERR_BAD_REQUEST,_)):U.send(C)})},FE}var zi=er,tA=function(i,e){N3.forEach(i,function(t,r){r!==e&&r.toUpperCase()===e.toUpperCase()&&(i[e]=t,delete i[r])})},iA=Vc(),V3=Gw,F3=Ww(),j3={"Content-Type":"application/x-www-form-urlencoded"};function rA(i,e){!zi.isUndefined(i)&&zi.isUndefined(i["Content-Type"])&&(i["Content-Type"]=e)}var nA,zh={transitional:V3,adapter:((typeof XMLHttpRequest<"u"||typeof process<"u"&&Object.prototype.toString.call(process)==="[object process]")&&(nA=x3()),nA),transformRequest:[function(i,e){if(tA(e,"Accept"),tA(e,"Content-Type"),zi.isFormData(i)||zi.isArrayBuffer(i)||zi.isBuffer(i)||zi.isStream(i)||zi.isFile(i)||zi.isBlob(i))return i;if(zi.isArrayBufferView(i))return i.buffer;if(zi.isURLSearchParams(i))return rA(e,"application/x-www-form-urlencoded;charset=utf-8"),i.toString();var t,r=zi.isObject(i),n=e&&e["Content-Type"];if((t=zi.isFileList(i))||r&&n==="multipart/form-data"){var a=this.env&&this.env.FormData;return F3(t?{"files[]":i}:i,a&&new a)}return r||n==="application/json"?(rA(e,"application/json"),function(c,l,u){if(zi.isString(c))try{return(l||JSON.parse)(c),zi.trim(c)}catch(h){if(h.name!=="SyntaxError")throw h}return(u||JSON.stringify)(c)}(i)):i}],transformResponse:[function(i){var e=this.transitional||zh.transitional,t=e&&e.silentJSONParsing,r=e&&e.forcedJSONParsing,n=!t&&this.responseType==="json";if(n||r&&zi.isString(i)&&i.length)try{return JSON.parse(i)}catch(a){if(n)throw a.name==="SyntaxError"?iA.from(a,iA.ERR_BAD_RESPONSE,this,null,this.response):a}return i}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Zw?$w:(Zw=1,$w=null)},validateStatus:function(i){return i>=200&&i<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};zi.forEach(["delete","get","head"],function(i){zh.headers[i]={}}),zi.forEach(["post","put","patch"],function(i){zh.headers[i]=zi.merge(j3)});var sA,aA,jE=zh,B3=er,G3=jE;function oA(){return aA?sA:(aA=1,sA=function(i){return!(!i||!i.__CANCEL__)})}var cA=er,BE=function(i,e,t){var r=this||G3;return B3.forEach(t,function(n){i=n.call(r,i,e)}),i},W3=oA(),H3=jE,K3=Kh();function GE(i){if(i.cancelToken&&i.cancelToken.throwIfRequested(),i.signal&&i.signal.aborted)throw new K3}var lA,dA,rn=er,uA=function(i,e){e=e||{};var t={};function r(h,p){return rn.isPlainObject(h)&&rn.isPlainObject(p)?rn.merge(h,p):rn.isPlainObject(p)?rn.merge({},p):rn.isArray(p)?p.slice():p}function n(h){return rn.isUndefined(e[h])?rn.isUndefined(i[h])?void 0:r(void 0,i[h]):r(i[h],e[h])}function a(h){if(!rn.isUndefined(e[h]))return r(void 0,e[h])}function c(h){return rn.isUndefined(e[h])?rn.isUndefined(i[h])?void 0:r(void 0,i[h]):r(void 0,e[h])}function l(h){return h in e?r(i[h],e[h]):h in i?r(void 0,i[h]):void 0}var u={url:a,method:a,data:a,baseURL:c,transformRequest:c,transformResponse:c,paramsSerializer:c,timeout:c,timeoutMessage:c,withCredentials:c,adapter:c,responseType:c,xsrfCookieName:c,xsrfHeaderName:c,onUploadProgress:c,onDownloadProgress:c,decompress:c,maxContentLength:c,maxBodyLength:c,beforeRedirect:c,transport:c,httpAgent:c,httpsAgent:c,cancelToken:c,socketPath:c,responseEncoding:c,validateStatus:l};return rn.forEach(Object.keys(i).concat(Object.keys(e)),function(h){var p=u[h]||n,_=p(h);rn.isUndefined(_)&&p!==l||(t[h]=_)}),t};function hA(){return dA?lA:(dA=1,lA={version:"0.27.2"})}var z3=hA().version,da=Vc(),WE={};["object","boolean","number","function","string","symbol"].forEach(function(i,e){WE[i]=function(t){return typeof t===i||"a"+(e<1?"n ":" ")+i}});var pA={};WE.transitional=function(i,e,t){function r(n,a){return"[Axios v"+z3+"] Transitional option '"+n+"'"+a+(t?". "+t:"")}return function(n,a,c){if(i===!1)throw new da(r(a," has been removed"+(e?" in "+e:"")),da.ERR_DEPRECATED);return e&&!pA[a]&&(pA[a]=!0,console.warn(r(a," has been deprecated since v"+e+" and will be removed in the near future"))),!i||i(n,a,c)}};var fA,_A,mA,EA,gA,SA,Y3={assertOptions:function(i,e,t){if(typeof i!="object")throw new da("options must be an object",da.ERR_BAD_OPTION_VALUE);for(var r=Object.keys(i),n=r.length;n-- >0;){var a=r[n],c=e[a];if(c){var l=i[a],u=l===void 0||c(l,a,i);if(u!==!0)throw new da("option "+a+" must be "+u,da.ERR_BAD_OPTION_VALUE)}else if(t!==!0)throw new da("Unknown option "+a,da.ERR_BAD_OPTION)}},validators:WE},TA=er,q3=Mw,vA=O3,yA=function(i){return GE(i),i.headers=i.headers||{},i.data=BE.call(i,i.data,i.headers,i.transformRequest),i.headers=cA.merge(i.headers.common||{},i.headers[i.method]||{},i.headers),cA.forEach(["delete","get","head","post","put","patch","common"],function(e){delete i.headers[e]}),(i.adapter||H3.adapter)(i).then(function(e){return GE(i),e.data=BE.call(i,e.data,e.headers,i.transformResponse),e},function(e){return W3(e)||(GE(i),e&&e.response&&(e.response.data=BE.call(i,e.response.data,e.response.headers,i.transformResponse))),Promise.reject(e)})},Yh=uA,J3=eA,CA=Y3,Fc=CA.validators;function jc(i){this.defaults=i,this.interceptors={request:new vA,response:new vA}}jc.prototype.request=function(i,e){typeof i=="string"?(e=e||{}).url=i:e=i||{},(e=Yh(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=e.transitional;t!==void 0&&CA.assertOptions(t,{silentJSONParsing:Fc.transitional(Fc.boolean),forcedJSONParsing:Fc.transitional(Fc.boolean),clarifyTimeoutError:Fc.transitional(Fc.boolean)},!1);var r=[],n=!0;this.interceptors.request.forEach(function(_){typeof _.runWhen=="function"&&_.runWhen(e)===!1||(n=n&&_.synchronous,r.unshift(_.fulfilled,_.rejected))});var a,c=[];if(this.interceptors.response.forEach(function(_){c.push(_.fulfilled,_.rejected)}),!n){var l=[yA,void 0];for(Array.prototype.unshift.apply(l,r),l=l.concat(c),a=Promise.resolve(e);l.length;)a=a.then(l.shift(),l.shift());return a}for(var u=e;r.length;){var h=r.shift(),p=r.shift();try{u=h(u)}catch(_){p(_);break}}try{a=yA(u)}catch(_){return Promise.reject(_)}for(;c.length;)a=a.then(c.shift(),c.shift());return a},jc.prototype.getUri=function(i){i=Yh(this.defaults,i);var e=J3(i.baseURL,i.url);return q3(e,i.params,i.paramsSerializer)},TA.forEach(["delete","get","head","options"],function(i){jc.prototype[i]=function(e,t){return this.request(Yh(t||{},{method:i,url:e,data:(t||{}).data}))}}),TA.forEach(["post","put","patch"],function(i){function e(t){return function(r,n,a){return this.request(Yh(a||{},{method:i,headers:t?{"Content-Type":"multipart/form-data"}:{},url:r,data:n}))}}jc.prototype[i]=e(),jc.prototype[i+"Form"]=e(!0)});var RA=er,X3=Dw,qh=jc,Q3=uA,xr=function i(e){var t=new qh(e),r=X3(qh.prototype.request,t);return RA.extend(r,qh.prototype,t),RA.extend(r,t),r.create=function(n){return i(Q3(e,n))},r}(jE);xr.Axios=qh,xr.CanceledError=Kh(),xr.CancelToken=function(){if(_A)return fA;_A=1;var i=Kh();function e(t){if(typeof t!="function")throw new TypeError("executor must be a function.");var r;this.promise=new Promise(function(a){r=a});var n=this;this.promise.then(function(a){if(n._listeners){var c,l=n._listeners.length;for(c=0;c<l;c++)n._listeners[c](a);n._listeners=null}}),this.promise.then=function(a){var c,l=new Promise(function(u){n.subscribe(u),c=u}).then(a);return l.cancel=function(){n.unsubscribe(c)},l},t(function(a){n.reason||(n.reason=new i(a),r(n.reason))})}return e.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},e.prototype.subscribe=function(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]},e.prototype.unsubscribe=function(t){if(this._listeners){var r=this._listeners.indexOf(t);r!==-1&&this._listeners.splice(r,1)}},e.source=function(){var t;return{token:new e(function(r){t=r}),cancel:t}},fA=e}(),xr.isCancel=oA(),xr.VERSION=hA().version,xr.toFormData=Ww(),xr.AxiosError=Vc(),xr.Cancel=xr.CanceledError,xr.all=function(i){return Promise.all(i)},xr.spread=EA?mA:(EA=1,mA=function(i){return function(e){return i.apply(null,e)}}),xr.isAxiosError=function(){if(SA)return gA;SA=1;var i=er;return gA=function(e){return i.isObject(e)&&e.isAxiosError===!0}}(),NE.exports=xr,NE.exports.default=xr;var lr=Zi(NE.exports);function IA(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function wA(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?IA(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):IA(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}let Jh,Xh=0,HE=0;function KE(i,e,t,r){return new F((n,a)=>{e.responseType=e.responseType||"json",e.data&&!t?(e.data=JSON.stringify(e.data),Xh+=ds(e.data)):t&&(e.data.size?Xh+=e.data.size:e.data instanceof FormData?Xh+=ww(e.data):Xh+=ds(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=i,lr.request(e).then(c=>{typeof c.data=="string"?HE+=ds(c.data):c.data instanceof ArrayBuffer||c.data instanceof Uint8Array?HE+=c.data.byteLength:HE+=ds(JSON.stringify(c.data)),r&&n({data:c.data,headers:c.headers}),n(c.data)}).catch(c=>{lr.isCancel(c)?a(new Y(A.OPERATION_ABORTED,"cancel token canceled")):c.code==="ECONNABORTED"?a(new Y(A.NETWORK_TIMEOUT,c.message)):c.response?a(new Y(A.NETWORK_RESPONSE_ERROR,c.response.status)):a(new Y(A.NETWORK_ERROR,c.message))})})}async function $3(i,e){let t=new Blob([e.data],{type:"buffer"});return await KE(i,wA(wA({},e),{},{data:t,headers:{"Content-Type":"application/octet-stream"}}),!0)}let Z3=()=>(Jh||Jh||(Jh=(window.location.protocol.split(":")[0]||"").toUpperCase(),Jh))==="HTTPS",AA=()=>window.isSecureContext!==void 0;function OA(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Se(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?OA(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):OA(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Be;(function(i){i.SET_SESSION_ID="SET_SESSION_ID",i.SET_P2P_ID="SET_P2P_id",i.SET_DC_ID="SET_DC_id",i.SET_UID="SET_UID",i.SET_PUB_ID="SET_PUB_ID",i.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",i.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",i.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",i.AVOID_JOIN_START="AVOID_JOIN_START",i.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",i.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",i.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",i.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",i.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",i.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",i.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",i.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",i.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",i.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",i.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",i.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",i.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",i.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",i.RESET_KEY_METRICS="RESET_KEY_METRICS",i.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",i.SET_USE_P2P="SET_USE_P2P"})(Be||(Be={}));class e5{constructor(e,t,r,n){g(this,"state",void 0),this.state={codec:e,audioCodec:t,mode:r,clientId:n,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1}}dispatch(e){this.state=function(t,r){switch(r.type){case Be.SET_SESSION_ID:return Se(Se({},t),{},{sessionId:r.sessionId});case Be.SET_P2P_ID:return Se(Se({},t),{},{p2pId:r.p2pId});case Be.SET_UID:return Se(Se({},t),{},{uid:r.uid});case Be.SET_PUB_ID:return Se(Se({},t),{},{pubId:r.pubId});case Be.KEY_METRIC_CLIENT_CREATED:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{clientCreated:r.metric})});case Be.KEY_METRIC_JOIN_START:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{joinStart:r.metric})});case Be.AVOID_JOIN_START:return Se(Se({},t),{},{avoidJoinStart:r.avoidJoinStart});case Be.KEY_METRIC_JOIN_END:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{joinEnd:r.metric})});case Be.KEY_METRIC_REQUEST_AP_START:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{requestAPStart:r.metric})});case Be.KEY_METRIC_REQUEST_AP_END:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{requestAPEnd:r.metric})});case Be.KEY_METRIC_JOIN_GATEWAY_START:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{joinGatewayStart:r.metric})});case Be.KEY_METRIC_JOIN_GATEWAY_END:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{joinGatewayEnd:r.metric})});case Be.KEY_METRIC_PEER_CONNECTION_START:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{peerConnectionStart:r.metric})});case Be.KEY_METRIC_PEER_CONNECTION_END:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{peerConnectionEnd:r.metric})});case Be.KEY_METRIC_DESCRIPTION_START:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{descriptionStart:r.metric})});case Be.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{signalChannelOpen:r.metric})});case Be.KEY_METRIC_ICE_CONNECTION_END:return Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{iceConnectionEnd:r.metric})});case Be.KEY_METRIC_PUBLISH:{let n=t.keyMetrics.publish,a=n.findIndex(c=>c.trackId===r.metric.trackId);return a!==-1?(n[a]=Se(Se({},n[a]),r.metric),Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{publish:[...n]})})):Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{publish:[...t.keyMetrics.publish,r.metric]})})}case Be.KEY_METRIC_SUBSCRIBE:{let n=t.keyMetrics.subscribe,a=n.findIndex(c=>c.userId===r.metric.userId&&c.type===r.metric.type);return a!==-1?(n[a]=Se(Se({},n[a]),r.metric),Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{subscribe:[...n]})})):Se(Se({},t),{},{keyMetrics:Se(Se({},t.keyMetrics),{},{subscribe:[...t.keyMetrics.subscribe,r.metric]})})}case Be.SET_CLOUD_PROXY_SERVER_MODE:return t.cloudProxyServerMode=r.mode,t;case Be.RECORD_JOIN_CHANNEL_SERVICE:return typeof r.index!="number"?t.joinChannelServiceRecords=[...t.joinChannelServiceRecords,r.record]:(t.joinChannelServiceRecords[r.index]=Se(Se({},t.joinChannelServiceRecords[r.index]),r.record),t.joinChannelServiceRecords=[...t.joinChannelServiceRecords]),t;case Be.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return t.joinChannelServiceRecords=[],t;case Be.RESET_KEY_METRICS:return t.keyMetrics={publish:[],subscribe:[]},t;case Be.SET_USE_DATACHANNEL:return Se(Se({},t),{},{useDataChannel:r.val});case Be.SET_USE_P2P:return Se(Se({},t),{},{useP2P:r.val});default:return t}}(this.state,e)}set sessionId(e){this.dispatch({type:Be.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}set codec(e){this.state.codec=e}get codec(){return this.state.codec}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:Be.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:Be.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:Be.SET_UID,uid:e})}get uid(){return this.state.uid}set pubId(e){this.dispatch({type:Be.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:Be.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:Be.SET_USE_DATACHANNEL,val:e})}get useDataChannel(){return this.state.useDataChannel}set useP2P(e){this.dispatch({type:Be.SET_USE_P2P,val:e})}get useP2P(){return this.state.useP2P}clientCreated(){this.dispatch({type:Be.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:Be.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:Be.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:Be.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:Be.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:Be.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:Be.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:Be.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:Be.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:Be.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:Be.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:Be.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,t,r,n){this.dispatch({type:Be.KEY_METRIC_PUBLISH,metric:Se(Se({trackId:e,type:t},r&&{publishStart:r}),n&&{publishEnd:n})})}subscribe(e,t,r,n,a,c,l){this.dispatch({type:Be.KEY_METRIC_SUBSCRIBE,metric:Se(Se(Se(Se(Se({userId:e,type:t},r&&{subscribeStart:r}),n&&{subscribeEnd:n}),a&&{firstFrame:a}),c&&{streamAdded:c}),l&&{firstDecoded:l})})}massSubscribe(e,t,r,n){e.forEach(a=>{this.dispatch({type:Be.KEY_METRIC_SUBSCRIBE,metric:Se(Se(Se({userId:a.userId,type:a.type},t&&{subscribeStart:t}),r&&{subscribeEnd:r}),n&&{firstFrame:n})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,t){e.service==="gateway"&&Array.isArray(e.urls)&&(e.urls=e.urls.map(r=>r.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof t!="number"?(this.dispatch({type:Be.RECORD_JOIN_CHANNEL_SERVICE,record:Se(Se({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(t<0||t>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Be.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:t}),t)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Be.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:Be.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:Be.AVOID_JOIN_START,avoidJoinStart:e})}}let nn=function(i){if(i.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return i;let e=i.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(e&&e[1]&&e[2]){let r=e[1],n=e[2];return"".concat(r,".").concat(n)}let t=i.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(t&&t[1]&&t[2]){let r=t[1],n=t[2];return"".concat(r,".").concat(100*(Number(n)+1))}return"4.0.0.999"}("4.19.3"),zE=function(){try{return JSON.parse("true")===!0}catch{return!0}}(),YE="v4.19.3-0-gb2ca8ca7(11/2/2023, 2:57:33 PM)",Yi={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:100,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!0,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,RTM2_FLAG:void 0,AP_RTM:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,USE_XR:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:1e4,P2P:!1,SHOW_P2P_LOG:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[]};function it(i,e,t){var r,n;ge(r=Object.keys(Yi)).call(r,i)&&(!t&&ge(n=Object.keys(ua)).call(n,i)||(Yi[i]=e))}function P(i){return Yi[i]}let ua={};var Ro,NA;(function(i){i.h264="h264",i.h265="h265",i.vp8="vp8",i.vp9="vp9",i.av1="av1"})(Ro||(Ro={})),function(i){i.opus="opus",i.pcma="pcma",i.pcmu="pcmu",i.g722="g722"}(NA||(NA={}));let Qh=new class extends mt{reportLogUploadError(i){this.emit("REPORT_LOG_UPLOAD",i)}};class t5{constructor(e){g(this,"logger",void 0),g(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.logger.debug(...this.prefixLists,...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.logger.info(...this.prefixLists,...t)}warning(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.logger.warning(...this.prefixLists,...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.logger.error(...this.prefixLists,...t)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function qE(){let i=new Date;return i.toTimeString().split(" ")[0]+":"+i.getMilliseconds()}function bA(){let i=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?(e==null?void 0:e[0])+":"+i.getUTCMilliseconds():i.toTimeString().split(" ")[0]+":"+i.getMilliseconds()}let sn={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},$h=Date.now(),fd=i=>{for(let e in sn)if(Object.prototype.hasOwnProperty.call(sn,e)&&sn[e]===i)return e;return"DEFAULT"},S=new class{constructor(){g(this,"proxyServerURL",void 0),g(this,"logLevel",sn.DEBUG),g(this,"uploadState","collecting"),g(this,"uploadLogWaitingList",[]),g(this,"uploadLogUploadingList",[]),g(this,"uploadErrorCount",0),g(this,"currentLogID",0),g(this,"url",void 0),g(this,"extLog",(i,e)=>{this.appendLogToWaitingList(i,...e)})}debug(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];let r=[sn.DEBUG].concat(e);this.log.apply(this,r)}info(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];let r=[sn.INFO].concat(e);this.log.apply(this,r)}warning(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];let r=[sn.WARNING].concat(e);this.log.apply(this,r)}warn(){this.warning(...arguments)}error(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];let r=[sn.ERROR].concat(e);this.log.apply(this,r)}upload(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];let r=[sn.DEBUG].concat(e);this.uploadLog.apply(this,r)}setLogLevel(i){i=Math.min(Math.max(0,i),4),this.logLevel=i}enableLogUpload(){it("UPLOAD_LOG",!0)}disableLogUpload(){it("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(i){this.proxyServerURL=i}prefix(i){return new t5(this).prefix(i)}log(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];if(Date.now()-$h<100)return void setTimeout(()=>{this.log(...e)},Date.now()-$h);let r=Math.max(0,Math.min(4,e[0]));if(e[0]=qE()+" Agora-SDK [".concat(fd(r),"]:"),this.appendLogToWaitingList(r,...e),r<this.logLevel)return;let n=qE()+" %cAgora-SDK [".concat(fd(r),"]:"),a=[];if(!P("USE_NEW_LOG"))switch(r){case sn.DEBUG:a=[n,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,a);break;case sn.INFO:a=[n,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,a);break;case sn.WARNING:a=[n,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,a);break;case sn.ERROR:a=[n,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,a)}}uploadLog(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];if(Date.now()-$h<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-$h);let r=Math.max(0,Math.min(4,e[0]));e[0]=qE()+" Agora-SDK [".concat(fd(r),"]:"),this.appendLogToWaitingList(r,...e)}appendLogToWaitingList(i){if(!P("UPLOAD_LOG"))return;for(var e=arguments.length,t=new Array(e>1?e-1:0),r=1;r<e;r++)t[r-1]=arguments[r];Array.isArray(t[0])?t[0][0]=bA()+" Agora-SDK [".concat(fd(i),"]:"):t[0]=bA()+" Agora-SDK [".concat(fd(i),"]:");let n="";t.forEach(a=>{typeof a=="object"&&(a=JSON.stringify(a)),n+="".concat(a," ")}),this.uploadLogWaitingList.push({payload_str:n,log_level:i,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){let i=this.uploadLogUploadingList,e={sdk_version:nn,process_id:P("PROCESS_ID"),payload:JSON.stringify(i)};return Kn(async()=>{let t=await lr.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(P("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(P("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(t.data!=="OK"){let r=new Error("unexpected upload log response");throw r.response=t,r}},()=>(this.uploadLogUploadingList=[],!1),t=>(t.response?Qh.reportLogUploadError({status:t.response.status,data:t.response.data,headers:t.response.headers,message:t.message}):t.request?Qh.reportLogUploadError({status:t.request.status,message:t.message}):Qh.reportLogUploadError({status:-1,message:t.message}),!0),{timeout:P("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:P("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,P("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),P("UPLOAD_LOG_INTERVAL"))}).catch(i=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),P("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),P("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var DA,PA;function i5(i){return yi(i.reportId,"params.reportId",0,100,!1),yi(i.category,"params.category",0,100,!1),yi(i.event,"params.event",0,100,!1),yi(i.label,"params.label",0,100,!1),nt(i.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(function(i){i.FREE="free",i.UPLOADING="uploading"})(DA||(DA={})),function(i){i[i.MISC=0]="MISC",i[i.INTERNAL_EVENT=1]="INTERNAL_EVENT",i[i.PUBLIC_EVENT=2]="PUBLIC_EVENT",i[i.WEB_EVENT=3]="WEB_EVENT",i[i.INTERNAL_API=4]="INTERNAL_API",i[i.WEB_API=5]="WEB_API",i[i.PUBLIC_API=6]="PUBLIC_API"}(PA||(PA={}));let r5={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};var $t,Et,kA,LA;function MA(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Ue(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?MA(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):MA(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}(function(i){i.PUBLISH="publish",i.SUBSCRIBE="subscribe",i.WS_COMPRESSOR_INIT="ws_compressor_init",i.SESSION_INIT="session_init",i.JOIN_CHOOSE_SERVER="join_choose_server",i.REQ_USER_ACCOUNT="req_user_account",i.JOIN_GATEWAY="join_gateway",i.REJOIN_GATEWAY="rejoin_gateway",i.STREAM_SWITCH="stream_switch",i.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",i.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",i.FIRST_VIDEO_RECEIVED="first_video_received",i.FIRST_AUDIO_RECEIVED="first_audio_received",i.FIRST_VIDEO_DECODE="first_video_decode",i.FIRST_AUDIO_DECODE="first_audio_decode",i.ON_ADD_AUDIO_STREAM="on_add_audio_stream",i.ON_ADD_VIDEO_STREAM="on_add_video_stream",i.ON_UPDATE_STREAM="on_update_stream",i.ON_REMOVE_STREAM="on_remove_stream",i.USER_ANALYTICS="req_user_analytics",i.PC_STATS="pc_stats"})($t||($t={})),function(i){i.SESSION="io.agora.pb.Wrtc.Session",i.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",i.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",i.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",i.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",i.PUBLISH="io.agora.pb.Wrtc.Publish",i.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",i.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",i.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",i.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",i.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",i.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",i.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",i.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",i.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",i.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",i.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",i.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",i.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",i.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",i.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",i.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",i.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",i.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",i.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",i.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",i.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",i.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",i.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",i.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",i.PC_STATS="io.agora.pb.Wrtc.PCStats"}(Et||(Et={})),function(i){i[i.WORKER_EVENT=156]="WORKER_EVENT",i[i.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}(kA||(kA={})),function(i){i[i.SESSION=26]="SESSION",i[i.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",i[i.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",i[i.JOIN_GATEWAY=28]="JOIN_GATEWAY",i[i.PUBLISH=30]="PUBLISH",i[i.SUBSCRIBE=29]="SUBSCRIBE",i[i.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",i[i.STREAM_SWITCH=32]="STREAM_SWITCH",i[i.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",i[i.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",i[i.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",i[i.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",i[i.API_INVOKE=41]="API_INVOKE",i[i.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",i[i.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",i[i.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",i[i.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",i[i.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",i[i.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",i[i.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",i[i.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",i[i.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",i[i.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",i[i.WORKER_EVENT=156]="WORKER_EVENT",i[i.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",i[i.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",i[i.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",i[i.USER_ANALYTICS=1e4]="USER_ANALYTICS",i[i.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(LA||(LA={}));class _d{constructor(){g(this,"baseInfoMap",new Map),g(this,"proxyServer",void 0),g(this,"eventUploadTimer",void 0),g(this,"setSessionIdTimer",void 0),g(this,"url",void 0),g(this,"backupUrl",void 0),g(this,"_appId",void 0),g(this,"keyEventUploadPendingItems",[]),g(this,"normalEventUploadPendingItems",[]),g(this,"apiInvokeUploadPendingItems",[]),g(this,"apiInvokeCount",0),g(this,"ltsList",[]),g(this,"lastSendNormalEventTime",Date.now()),g(this,"customReportCounterTimer",void 0),g(this,"customReportCount",0),g(this,"extApiInvoke",async e=>{for(let t of e){let r=Ue(Ue({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:St.TRACER});this.sendApiInvoke(r)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),P("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),P("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}adjustSessionStartTime(e){if(!this.baseInfoMap.has(e)&&!this.baseInfoMap.get(e))return void S.error("adjust session ".concat(e," start time, sid is not exist or info is undefined"));let t=this.baseInfoMap.get(e),r=Date.now(),n=t.startTime;t.startTime=r,S.debug("rewrite session ".concat(e," startTime: ").concat(r," , ").concat(r-n,"ms")),this.baseInfoMap.set(e,t)}setAppId(e){this._appId=e}reportApiInvoke(e,t,r){t.timeout=t.timeout||6e4,t.reportResult=t.reportResult===void 0||t.reportResult;let n=Date.now();this.apiInvokeCount+=1;let a=this.apiInvokeCount,c=()=>({tag:t.tag,invokeId:a,sid:e,name:t.name,apiInvokeTime:n,options:t.options,states:t.states||null}),l=!!P("SHOW_REPORT_INVOKER_LOG");l&&S.info("".concat(t.name," start"),t.options);let u=!1;Si(t.timeout).then(()=>{u||(this.sendApiInvoke(Ue(Ue({},c()),{},{error:A.API_INVOKE_TIMEOUT,success:!1})),S.debug("".concat(t.name," timeout")))});let h=new Y(A.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:p=>{let _=()=>{if(u)throw h;return u=!0,this.sendApiInvoke(Ue(Ue({},c()),{},{success:!0},t.reportResult&&{result:p})),l&&S.info("".concat(t.name," onSuccess")),p};return r?Ow(_,t.name+"Success",r,()=>u=!0):_()},onError:p=>{let _=()=>{if(u)throw p;u=!0,this.sendApiInvoke(Ue(Ue({},c()),{},{success:!1,error:p})),l&&S.info("".concat(t.name," onFailure"),p.toString())};return r?Ow(_,t.name+"Error",r,()=>u=!0):_()}}}sessionInit(e,t){if(this.baseInfoMap.has(e))return;let r=Date.now(),n=this.createBaseInfo(e,r);n.cname=t.cname;let a=Object.assign({},{willUploadConsoleLog:P("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:zE?"global":"oversea",areas:P("AREAS")&&P("AREAS").join(",")},t.extend),c=Date.now(),l=Ue(Ue({},n),{},{eventType:$t.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,build:YE,lts:c,elapse:c-r,extend:JSON.stringify(a),mode:t.mode,process:P("PROCESS_ID"),appType:P("APP_TYPE"),success:!0,version:nn});this.send({type:Et.SESSION,data:l},!0)}joinChooseServer(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue({},n),{},{eventType:$t.JOIN_CHOOSE_SERVER,lts:a,eventElapse:a-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:a-r.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3});this.send({type:Et.JOIN_CHOOSE_SERVER,data:c},!0)}reqUserAccount(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue({},n),{},{eventType:$t.REQ_USER_ACCOUNT,lts:a,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:a-r.startTime,eventElapse:a-t.lts,extend:JSON.stringify(t.extend)});this.send({type:Et.REQ_USER_ACCOUNT,data:c},!0)}joinGateway(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info;t.vid&&(n.vid=t.vid),n.uid=t.uid,n.cid=t.cid;let a=Date.now(),{firstSuccess:c,avoidJoinStartTime:l,isProxy:u,addr:h}=t,p=a-(c&&l?l:r.startTime),_=Ue(Ue({},n),{},{eventType:$t.JOIN_GATEWAY,lts:a,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,elapse:p,eventElapse:a-t.lts,firstSuccess:c,signalChannel:t.signalChannel}),E=_.success?1:0;if(t.succ&&(r.lastJoinSuccessTime=a),c)this.send({type:Et.JOIN_GATEWAY,data:_},!0);else{let T;if(h)if(u){let C=h.match(/h=(\d{1,3}-){3}\d{1,3}/g),O=h.match(/p=[0-9]{1,6}/g);T={isSuccess:E,gatewayIp:C&&C.length?C[0].split("=")[1].replace(/-/g,"."):"",port:O&&O.length?O[0].split("=")[1]:"",isProxy:u?1:0}}else{let C=h.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),O=h.match(/(:|p=)[0-9]{1,6}/g);T={isSuccess:E,gatewayIp:C&&C.length?C[0].split("//")[1].replace(/-/g,"."):"",port:O&&O.length?O[0].split(/:|p=/g)[1]:"",isProxy:u?1:0}}else T={isSuccess:E,gatewayIp:"",port:"",isProxy:u?1:0};delete _.success,delete _.eventType,delete _.firstSuccess,_.vid=Number(_.vid);let w=Object.assign({},_,T,{eventType:$t.REJOIN_GATEWAY});this.send({type:Et.RE_JOIN_GATEWAY,data:w},!0)}}joinChannelTimeout(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=Date.now(),a=Ue(Ue({},r.info),{},{lts:n,timeout:t,elapse:n-r.startTime});this.send({type:Et.JOIN_CHANNEL_TIMEOUT,data:a},!0)}publish(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue({},n),{},{eventType:$t.PUBLISH,lts:a,eventElapse:t.eventElapse,elapse:a-r.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:Et.PUBLISH,data:c},!0)}subscribe(e,t,r){let n=this.baseInfoMap.get(e);if(!n)return;let a=n.info,c=Date.now(),l=Ue(Ue({},a),{},{eventType:$t.SUBSCRIBE,lts:c,eventElapse:t.eventElapse,elapse:c-n.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid},r&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof t.peerid=="string"?l.peerSuid=t.peerid:l.peer=t.peerid,this.send({type:Et.SUBSCRIBE,data:l},!0)}wsCompressorInit(e){var t;let r=[...Ur(t=this.baseInfoMap).call(t)],n=r.length?r[0]:"UnableToGetSid",a=this.baseInfoMap.get(n);if(!a)return;let c=a.info,l=Date.now(),u=Ue(Ue({},c),{},{eventType:$t.WS_COMPRESSOR_INIT,lts:l,eventElapse:e.eventElapse,elapse:l-a.startTime,status:e.status?1:2});this.send({type:Et.WS_COMPRESSOR_INIT,data:u},!0)}firstRemoteVideoDecode(e,t,r,n){let a=this.baseInfoMap.get(e);if(!a)return;let c=a.info,l=Date.now(),u=Ue(Ue(Ue({},c),n),{},{elapse:l-a.startTime,eventType:t,lts:l,firstDecodeFrame:Math.max(l-a.startTime,0),apEnd:Math.max(n.apEnd-a.startTime,0),apStart:Math.max(n.apStart-a.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-a.startTime,0),joinGwStart:Math.max(n.joinGwStart-a.startTime,0),pcEnd:Math.max(n.pcEnd-a.startTime,0),pcStart:Math.max(n.pcStart-a.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-a.startTime,0),subscriberStart:Math.max(n.subscriberStart-a.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-a.startTime,0)});this.send({type:r,data:u},!0)}firstRemoteFrame(e,t,r,n){let a=this.baseInfoMap.get(e);if(!a)return;let c=a.info,l=Date.now(),u=Ue(Ue(Ue({},c),n),{},{elapse:l-a.startTime,eventType:t,lts:l});this.send({type:r,data:u},!0)}pcStats(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue(Ue({},n),t),{},{vid:n.vid===void 0?0:Number(n.vid),elapse:a-r.startTime,eventType:$t.PC_STATS,lts:a});this.send({type:Et.PC_STATS,data:c},!0)}updateRemoteRTPCapabilities(e,t){this.reportApiInvoke(e,{name:"Client.updateRemoteRTPCapabilities",options:t,tag:St.TRACER}).onSuccess()}onGatewayStream(e,t,r,n){let a=this.baseInfoMap.get(e);if(!a)return;let c=a.info,l=Date.now(),u=Ue(Ue(Ue({},c),n),{},{eventType:t,lts:l});this.send({type:r,data:u},!0)}streamSwitch(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue({},n),{},{eventType:$t.STREAM_SWITCH,lts:a,isDual:t.isdual,elapse:a-r.startTime,success:t.succ});this.send({type:Et.STREAM_SWITCH,data:c},!0)}requestProxyAppCenter(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue({},n),{},{eventType:$t.REQUEST_PROXY_APPCENTER,lts:a,eventElapse:a-t.lts,elapse:a-r.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Et.REQUEST_PROXY_APPCENTER,data:c},!0)}requestProxyWorkerManager(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue({},n),{},{eventType:$t.REQUEST_PROXY_WORKER_MANAGER,lts:a,eventElapse:a-t.lts,elapse:a-r.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Et.REQUEST_PROXY_WORKER_MANAGER,data:c},!0)}setProxyServer(e){this.proxyServer=e,e?S.debug("reportProxyServerurl: ".concat(e)):S.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue({},n),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:a,elapse:a-r.startTime,joinChannelSuccessElapse:a-(r.lastJoinSuccessTime||a),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:Et.PEER_PUBLISH_STATUS,data:c},!0)}workerEvent(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now();(function(c,l,u){let h=c[l];if(!h||typeof h!="string")return[c];c[l]="";let p=ds(JSON.stringify(c)),_=0,E=[],T=0;for(let w=0;w<h.length;w++)T+=h.charCodeAt(w)<=127?1:3,T<=u-p||(E[E.length]=To(To({},c),{},{[l]:h.substring(_,w)}),_=w,T=h.charCodeAt(w)<=127?1:3);return _!==h.length-1&&(E[E.length]=To(To({},c),{},{[l]:h.substring(_)})),E})(Ue(Ue(Ue({},n),t),{},{elapse:a-r.startTime,lts:a,productType:"WebRTC"}),"payload",1300).forEach(c=>this.send({type:Et.WORKER_EVENT,data:c},!0))}apworkerEvent(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue(Ue({},n),t),{},{elapse:a-r.startTime,lts:a});this.send({type:Et.AP_WORKER_EVENT,data:c},!0)}joinWebProxyAP(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue(Ue({},n),t),{},{elapse:a-r.startTime,lts:a,extend:t.extend||void 0});this.send({type:Et.JOIN_WEB_PROXY_AP,data:c},!0)}WebSocketQuit(e,t){let r=this.baseInfoMap.get(e);if(!r)return;let n=r.info,a=Date.now(),c=Ue(Ue(Ue({},n),t),{},{elapse:a-r.startTime,lts:a});this.send({type:Et.WEBSOCKET_QUIT,data:c},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>P("CUSTOM_REPORT_LIMIT"))throw new Y(A.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));let r=Date.now(),n=t.map(a=>({type:Et.USER_ANALYTICS,data:Ue(Ue({sid:e},a),{},{lts:r})}));try{P("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(a){throw S.error("send custom report message failed",a.toString()),new Y(A.CUSTOM_REPORT_SEND_FAILED,a.message)}}sendApiInvoke(e){let t=P("NOT_REPORT_EVENT");if(e.tag&&ge(t)&&ge(t).call(t,e.tag))return!1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;let r=this.baseInfoMap.get(e.sid);if(!r)return this.apiInvokeUploadPendingItems.push(e),!1;let{cname:n,uid:a,cid:c}=r.info,l;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof Y){let{code:h,message:p}=e.error;l=h||p||e.error.toString()}else l=e.error.toString();let u={invokeId:e.invokeId,sid:e.sid,cname:n,cid:c,uid:a,lts:e.lts,success:e.success,elapse:e.lts-r.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?l:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:Et.API_INVOKE,data:u},!1),!0}appendSessionId(){_d.__CLIENT_LIST__.forEach(e=>{if(e._sessionId){let t=this.apiInvokeUploadPendingItems.length;for(let r=0;r<t;r++){let n=this.apiInvokeUploadPendingItems.shift();n&&(n.sid=e._sessionId,this.sendApiInvoke(Object.assign({},n)))}}})}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>P("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){let r=[],n=[];for(;e.length;){let c=e.shift();r.length<20?r.push(c):n.push(c)}e.push(...n);for(let c of[...r]){var a;this.ltsList.indexOf(c.data.lts)!==-1?(c.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(c.data.lts)):(this.ltsList.push(c.data.lts),td(a=this.ltsList).call(a,(l,u)=>l-u))}return t||(this.lastSendNormalEventTime=Date.now()),P("ENABLE_EVENT_REPORT")&&r.length&&(P("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(r):this.postDataToStatsCollector(r)).catch((c=>l=>{P("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(c):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(c),this.normalEventUploadPendingItems.length>P("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-P("NORMAL_EVENT_QUEUE_CAPACITY")),S.warning("report: drop normal events"))))})(r)),e}async postDataToStatsCollector2(e){Mt.networkState===ji.OFFLINE&&await F.race([Mt.onlineWaiter,Si(2*xt.maxRetryTimeout)]);let t=a=>{let c=new Uint8Array;return a.forEach(l=>{let u=vE(JSON.stringify(l.data)),h=new ArrayBuffer(5),p=(E=>{let T=0;return Object.entries(Et).forEach(w=>{let[C,O]=w;O===E.type&&(T=EventNameToID[C])}),T})(l),_=new DataView(h);_.setUint16(0,u.byteLength,!0),_.setUint8(2,255&p),_.setUint8(3,p>>>8&255),_.setUint8(4,p>>>16&255),c=Sw(c,new Uint8Array(h)),c=Sw(c,u)}),c},r="event",n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(P("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(r):"https://".concat(P("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(r);for(let a=0;a<2;a+=1){a===1&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(P("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(r):"https://".concat(P("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(r));try{await KE(n,{timeout:1e4,data:t(e),headers:Ue(Ue({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(c){if(a===1)throw c;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1],r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map(c=>JSON.stringify(c)),vid:(c=>{let l=c&&c.data.sid&&this.baseInfoMap.get(c.data.sid);return l&&l.info.vid&&+l.info.vid||0})(e[0])};Mt.networkState===ji.OFFLINE&&await F.race([Mt.onlineWaiter,Si(2*xt.maxRetryTimeout)]);let n=t?"/events/proto-raws":"/events/messages",a=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(P("EVENT_REPORT_DOMAIN"),"&p=").concat(P("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(P("EVENT_REPORT_DOMAIN"),":").concat(P("STATS_COLLECTOR_PORT")).concat(n));for(let c=0;c<2;c+=1){c===1&&(a=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(P("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(P("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(P("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(P("STATS_COLLECTOR_PORT")).concat(n)));try{t?await $3(a,{timeout:1e4,data:r}):await KE(a,{timeout:1e4,data:r})}catch(l){if(c===1)throw l;continue}return}}createBaseInfo(e,t){let r=Object.assign({},r5);return r.sid=e,this.baseInfoMap.set(e,{info:r,startTime:t}),r}reportResourceTiming(e,t){let r=performance.getEntriesByName(e),n=r[r.length-1];n&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:n,tag:St.TRACER}).onSuccess()}}function Ce(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,t,r){let n=r.value;if(typeof n=="function"){let a=i.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);r.value=function(){for(var c=arguments.length,l=new Array(c),u=0;u<c;u++)l[u]=arguments[u];let h=l;if(i.argsMap)try{h=i.argsMap(this,...l)}catch(_){S.warning(_),h=[]}try{JSON.stringify(h)}catch{S.warning("arguments for method ".concat(a,".").concat(String(t)," not serializable for apiInvoke.")),h=[]}let p=(i.report||Ee).reportApiInvoke(this._sessionId||null,{name:"".concat(a,".").concat(String(t)),options:h,tag:St.TRACER,reportResult:i.reportResult},i.throttleTime);try{let _=n.apply(this,l);return _ instanceof F?_.then(E=>(p.onSuccess(i.reportResult&&E),E)).catch(E=>{throw p.onError(E),E}):(p.onSuccess(i.reportResult&&_),_)}catch(_){throw p.onError(_),_}}}return r}}g(_d,"__CLIENT_LIST__",[]);let Ee=new _d;Qh.on("REPORT_LOG_UPLOAD",i=>{i.networkState=Mt.networkState,Ee.reportApiInvoke(null,{name:"logUploadError",options:i,tag:St.TRACER})});let n5=["CHINA","GLOBAL"],Vr=function(){let i="us".concat("erna","me"),e="pa".concat("sswo","rd"),t=["t","s","t"];t.splice(1,0,"e");let r=t.join(""),n=[];for(let l=0;l<6;l++)n.push("1");let a=n.join(""),c={};return c[i]=r,c[e]=a,Object.assign(c,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Vr,zE||(Yi.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Yi.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Yi.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Yi.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Yi.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Yi.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Yi.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Yi.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Yi.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Yi.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Yi.AREAS=["NORTH_AMERICA","OVERSEA"]);let UA=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],ha=[];function Io(i,e){return!!e&&ha.some(t=>t.uid===i&&t.channelName===e)}_d.__CLIENT_LIST__=ha;var JE,dr,Bc,md,Fr,Di,ve,xe,le,me,ur,Ae,xA,Gc,Ie,Ht,pa,s5=ho("Array").values,a5=po,o5=or,c5=Gn,l5=s5,XE=Array.prototype,d5={DOMTokenList:!0,NodeList:!0},us=Zi(function(i){var e=i.values;return i===XE||c5(XE,i)&&e===XE.values||o5(d5,a5(i))?l5:e});function J(i,e,t,r){var n,a=arguments.length,c=a<3?e:r===null?r=Object.getOwnPropertyDescriptor(e,t):r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")c=Reflect.decorate(i,e,t,r);else for(var l=i.length-1;l>=0;l--)(n=i[l])&&(c=(a<3?n(c):a>3?n(e,t,c):n(e,t))||c);return a>3&&c&&Object.defineProperty(e,t,c),c}function R(i,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(i,e)}(function(i){i.L1T1="L1T1",i.L1T2="L1T2",i.L1T3="L1T3",i.L2T1_KEY="L2T1_KEY",i.L2T2_KEY="L2T2_KEY",i.L2T3_KEY="L2T3_KEY",i.L3T1_KEY="L3T1_KEY",i.L3T2_KEY="L3T2_KEY",i.L3T3_KEY="L3T3_KEY"})(JE||(JE={})),function(i){i.CERTIFICATE="certificate",i.CODEC="codec",i.CANDIDATE_PAIR="candidate-pair",i.LOCAL_CANDIDATE="local-candidate",i.REMOTE_CANDIDATE="remote-candidate",i.INBOUND="inbound-rtp",i.TRACK="track",i.OUTBOUND="outbound-rtp",i.PC="peer-connection",i.REMOTE_INBOUND="remote-inbound-rtp",i.REMOTE_OUTBOUND="remote-outbound-rtp",i.TRANSPORT="transport",i.CSRC="csrc",i.DATA_CHANNEL="data-channel",i.STREAM="stream",i.SENDER="sender",i.RECEIVER="receiver"}(dr||(dr={})),function(i){i[i.ACCESS_POINT=101]="ACCESS_POINT",i[i.UNILBS=201]="UNILBS",i[i.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(Bc||(Bc={})),function(i){i[i.IIIEGAL_APPID=1]="IIIEGAL_APPID",i[i.IIIEGAL_UID=2]="IIIEGAL_UID",i[i.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(md||(md={})),function(i){i[i.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",i[i.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",i[i.INTERNAL_ERROR=8]="INTERNAL_ERROR",i[i.NO_AUTHORIZED=9]="NO_AUTHORIZED",i[i.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",i[i.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",i[i.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",i[i.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",i[i.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",i[i.USER_OVERLOAD=16]="USER_OVERLOAD",i[i.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",i[i.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(Fr||(Fr={})),function(i){i[i.NO_FLAG_SET=100]="NO_FLAG_SET",i[i.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",i[i.INVALID_FALG_SET=102]="INVALID_FALG_SET",i[i.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",i[i.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",i[i.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",i[i.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",i[i.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",i[i.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",i[i.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",i[i.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",i[i.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",i[i.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",i[i.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",i[i.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",i[i.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",i[i.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",i[i.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",i[i.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(Di||(Di={})),function(i){i[i.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",i[i.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",i[i.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",i[i.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",i[i.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",i[i.K_TICKET_INVALID=7]="K_TICKET_INVALID",i[i.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",i[i.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",i[i.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",i[i.K_UID_BANNED=14]="K_UID_BANNED",i[i.K_IP_BANNED=15]="K_IP_BANNED",i[i.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",i[i.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",i[i.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",i[i.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",i[i.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",i[i.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",i[i.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",i[i.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",i[i.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",i[i.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",i[i.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",i[i.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",i[i.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",i[i.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",i[i.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",i[i.ERR_INVALID_UID=117]="ERR_INVALID_UID",i[i.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",i[i.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",i[i.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",i[i.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",i[i.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",i[i.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",i[i.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",i[i.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",i[i.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",i[i.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",i[i.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",i[i.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",i[i.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",i[i.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",i[i.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",i[i.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",i[i.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",i[i.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",i[i.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",i[i.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",i[i.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",i[i.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",i[i.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",i[i.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",i[i.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",i[i.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",i[i.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",i[i.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",i[i.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",i[i.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",i[i.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",i[i.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",i[i.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",i[i.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",i[i.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",i[i.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",i[i.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(ve||(ve={})),function(i){i.CONNECTING="connecting",i.CONNECTED="connected",i.RECONNECTING="reconnecting",i.CLOSED="closed"}(xe||(xe={})),function(i){i.WS_CONNECTED="ws_connected",i.WS_RECONNECTING="ws_reconnecting",i.WS_CLOSED="ws_closed",i.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",i.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",i.ON_BINARY_DATA="on_binary_data",i.REQUEST_RECOVER="request_recover",i.REQUEST_JOIN_INFO="request_join_info",i.REQUEST_REJOIN_INFO="req_rejoin_info",i.IS_P2P_DISCONNECTED="is_p2p_dis",i.DISCONNECT_P2P="dis_p2p",i.ABORT_P2P_EXECUTION="abort_p2p_execution",i.NEED_RENEW_SESSION="need-sid",i.REPORT_JOIN_GATEWAY="report_join_gateway",i.REQUEST_TIMEOUT="request_timeout",i.REQUEST_SUCCESS="request_success",i.JOIN_RESPONSE="join_response",i.DATACHANNEL_PRECONNECT="datachannel_preconnect",i.DATACHANNEL_CONNECTING="datachannel_connecting",i.DATACHANNEL_FAILBACK="datachannel_failback",i.P2P_START="p2p_start",i.P2P_CONNECTION="p2p_connection",i.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",i.P2P_SUBSCRIBE="p2p_subscribe",i.P2P_UNSUBSCRIBE="p2p_unsubscribe",i.P2P_EXCHANGE_SDP="p2p_exchange_sdp",i.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",i.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}(le||(le={})),function(i){i.PING="ping",i.PING_BACK="ping_back",i.JOIN="join_v3",i.REJOIN="rejoin_v3",i.LEAVE="leave",i.SET_CLIENT_ROLE="set_client_role",i.PUBLISH="publish",i.PUBLISH_DATASTREAM="publish_datastream",i.UNPUBLISH="unpublish",i.UNPUBLISH_DATASTREAM="unpublish_datastream",i.SUBSCRIBE="subscribe",i.SUBSCRIBE_DATASTREAM="subscribe_datastream",i.SUBSCRIBE_STREAMS="subscribe_streams",i.UNSUBSCRIBE="unsubscribe",i.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",i.UNSUBSCRIBE_STREAMS="unsubscribe_streams",i.SUBSCRIBE_CHANGE="subscribe_change",i.TRAFFIC_STATS="traffic_stats",i.RENEW_TOKEN="renew_token",i.SWITCH_VIDEO_STREAM="switch_video_stream",i.DEFAULT_VIDEO_STREAM="default_video_stream",i.SET_FALLBACK_OPTION="set_fallback_option",i.GATEWAY_INFO="gateway_info",i.CONTROL="control",i.SEND_METADATA="send_metadata",i.DATA_STREAM="data_stream",i.PICK_SVC_LAYER="pick_svc_layer",i.RESTART_ICE="restart_ice",i.CONNECT_PC="connect_pc",i.SET_VIDEO_PROFILE="set_video_profile",i.SET_PARAMETER="set_parameter",i.SET_RTM2_FLAG="set_rtm2_flag"}(me||(me={})),function(i){i.PUBLISH_STATS="publish_stats",i.PUBLISH_RELATED_STATS="publish_related_stats",i.SUBSCRIBE_STATS="subscribe_stats",i.SUBSCRIBE_RELATED_STATS="subscribe_related_stats",i.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",i.DENOISER_STATS="denoiser_stats",i.TRANSPORT_STATS="transport_stats",i.EXTENSION_USAGE_STATS="extension_usage_stats"}(ur||(ur={})),function(i){i.ON_USER_ONLINE="on_user_online",i.ON_USER_OFFLINE="on_user_offline",i.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",i.ON_PUBLISH_STREAM="on_publish_stream",i.ON_UPLINK_STATS="on_uplink_stats",i.ON_P2P_LOST="on_p2p_lost",i.ON_REMOVE_STREAM="on_remove_stream",i.ON_ADD_AUDIO_STREAM="on_add_audio_stream",i.ON_ADD_VIDEO_STREAM="on_add_video_stream",i.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",i.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",i.ON_USER_BANNED="on_user_banned",i.ON_USER_LICENSE_BANNED="on_user_license_banned",i.ON_NOTIFICATION="on_notification",i.ON_CRYPT_ERROR="on_crypt_error",i.MUTE_AUDIO="mute_audio",i.MUTE_VIDEO="mute_video",i.UNMUTE_AUDIO="unmute_audio",i.UNMUTE_VIDEO="unmute_video",i.ON_P2P_OK="on_p2p_ok",i.RECEIVE_METADATA="receive_metadata",i.ON_DATA_STREAM="on_data_stream",i.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",i.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",i.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",i.ENABLE_LOCAL_VIDEO="enable_local_video",i.DISABLE_LOCAL_VIDEO="disable_local_video",i.ENABLE_LOCAL_AUDIO="enable_local_audio",i.DISABLE_LOCAL_AUDIO="disable_local_audio",i.ON_PUBLISHED_USER_LIST="on_published_user_list"}(Ae||(Ae={})),function(i){i.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",i.NEED_ANSWER="NEED_ANSWER",i.NEED_RENEGOTIATE="NEED_RENEGOTIATE",i.P2P_LOST="P2P_LOST",i.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",i.NEED_UNPUB="NEED_UNPUB",i.NEED_UNSUB="NEED_UNSUB",i.NEED_UPLOAD="NEED_UPLOAD",i.NEED_CONTROL="NEED_CONTROL",i.START_RECONNECT="START_RECONNECT",i.END_RECONNECT="END_RECONNECT",i.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(xA||(xA={})),function(i){i.SEND_ONLY="SEND_ONLY",i.RECEIVE_ONLY="RECEIVE_ONLY"}(Gc||(Gc={})),function(i){i.CONNECTED="websocket:connected",i.RECONNECTING="websocket:reconnecting",i.WILL_RECONNECT="websocket:will_reconnect",i.CLOSED="websocket:closed",i.FAILED="websocket:failed",i.ON_MESSAGE="websocket:on_message",i.REQUEST_NEW_URLS="websocket:request_new_urls",i.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",i.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",i.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(Ie||(Ie={}));class x extends Y{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),g(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,S)}throw(){super.throw(S)}}function QE(i){if(typeof i!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(i))throw S.error("Invalid Channel Name ".concat(i)),new x(A.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function $E(i){if(e=i,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||_w(i,1,255)))throw new x(A.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof i=="string"&&S.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}(function(i){i.TRANSCODE="mix_streaming",i.RAW="raw_streaming",i.INJECT="inject_streaming"})(Ht||(Ht={})),function(i){i[i.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",i[i.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",i[i.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",i[i.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",i[i.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",i[i.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",i[i.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",i[i.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",i[i.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",i[i.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",i[i.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(pa||(pa={}));let u5={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},ZE={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function eg(i,e){yi(i.url,"".concat(e,".url"),1,1e3,!1),Tt(i.x)||nt(i.x,"".concat(e,".x"),0,1e4),Tt(i.y)||nt(i.y,"".concat(e,".y"),0,1e4),Tt(i.width)||nt(i.width,"".concat(e,".width"),0,1e4),Tt(i.height)||nt(i.height,"".concat(e,".height"),0,1e4),Tt(i.zOrder)||nt(i.zOrder,"".concat(e,".zOrder"),0,255),Tt(i.alpha)||nt(i.alpha,"".concat(e,".alpha"),0,1,!1)}let h5={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},p5={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var wn,Wc,kt,VA,Pi,zn,qi,fa,et,Ct,wo,Bt,Zh,He;function FA(i){if(!i.channelName)throw new x(A.INVALID_PARAMS,"invalid channelName in info");if(typeof i.uid!="number")throw new x(A.INVALID_PARAMS,"invalid uid in info, uid must be a number");return i.token&&yi(i.token,"info.token",1,2047),$E(i.uid),QE(i.channelName),!0}(function(i){i.WARNING="@live_uap-warning",i.ERROR="@line_uap-error",i.PUBLISH_STREAM_STATUS="@live_uap-publish-status",i.INJECT_STREAM_STATUS="@live_uap-inject-status",i.WORKER_STATUS="@live_uap-worker-status",i.REQUEST_NEW_ADDRESS="@live_uap-request-address"})(wn||(wn={})),function(i){i.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(Wc||(Wc={})),function(i){i[i.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",i[i.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",i[i.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",i[i.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",i[i.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",i[i.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",i[i.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",i[i.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",i[i.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",i[i.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",i[i.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",i[i.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",i[i.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",i[i.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",i[i.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",i[i.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",i[i.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",i[i.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",i[i.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",i[i.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",i[i.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(kt||(kt={})),function(i){i.CONNECT_FAILED="connect failed",i.CONNECT_TIMEOUT="connect timeout",i.WS_DISCONNECTED="websocket disconnected",i.REQUEST_TIMEOUT="request timeout",i.REQUEST_FAILED="request failed",i.WAIT_STATUS_TIMEOUT="wait status timeout",i.WAIT_STATUS_ERROR="wait status error",i.BAD_STATE="bad state",i.WS_ABORT="ws abort",i.AP_REQUEST_TIMEOUT="AP request timeout",i.AP_JSON_PARSE_ERROR="AP json parse error",i.AP_REQUEST_ERROR="AP request error",i.AP_REQUEST_ABORT="AP request abort"}(VA||(VA={})),function(i){i[i.SetSdkProfile=0]="SetSdkProfile",i[i.SetSourceChannel=1]="SetSourceChannel",i[i.SetSourceUserId=2]="SetSourceUserId",i[i.SetDestChannel=3]="SetDestChannel",i[i.StartPacketTransfer=4]="StartPacketTransfer",i[i.StopPacketTransfer=5]="StopPacketTransfer",i[i.UpdateDestChannel=6]="UpdateDestChannel",i[i.Reconnect=7]="Reconnect",i[i.SetVideoProfile=8]="SetVideoProfile"}(Pi||(Pi={})),function(i){i.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",i.NETWORK_CONNECTED="NETWORK_CONNECTED",i.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",i.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",i.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",i.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",i.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",i.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",i.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",i.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(zn||(zn={})),function(i){i.RELAY_STATE_IDLE="RELAY_STATE_IDLE",i.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",i.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",i.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(qi||(qi={})),function(i){i.RELAY_OK="RELAY_OK",i.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",i.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",i.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(fa||(fa={})),function(i){i.High="high",i.Low="low",i.Audio="audio",i.Screen="screen",i.ScreenLow="screen_low"}(et||(et={})),function(i){i.DISCONNECT="disconnect",i.CONNECTION_STATE_CHANGE="connection-state-change",i.NETWORK_QUALITY="network-quality",i.STREAM_TYPE_CHANGE="stream-type-change",i.IS_P2P_DISCONNECTED="is-p2p-dis",i.DISCONNECT_P2P="dis-p2p",i.REQUEST_NEW_GATEWAY_LIST="req-gate-url",i.NEED_RENEW_SESSION="need-sid",i.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",i.JOIN_RESPONSE="join-response",i.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",i.RESET_CONNECTION_EVENTS="reset-connection-events",i.DATACHANNEL_PRECONNECT="datachannel_preconnect",i.DATACHANNEL_FAILBACK="datachannel_failback",i.RESET_SIGNAL="reset-signal"}(Ct||(Ct={})),function(i){i.P2P_DISCONNECTED="P2P_DISCONNECTED",i.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",i.TIMEOUT="TIMEOUT",i.UNKNOWN_REASON="UNKNOWN_REASON"}(wo||(wo={})),function(i){i[i.Nothing=0]="Nothing",i[i.Audio=1]="Audio",i[i.LwoVideo=2]="LwoVideo",i[i.Video=4]="Video",i[i.Data=8]="Data",i[i.DataStream0=256]="DataStream0",i[i.DataStream1=512]="DataStream1",i[i.DataStream2=1024]="DataStream2",i[i.DataStream3=2048]="DataStream3",i[i.DataStream4=4096]="DataStream4",i[i.DataStream5=8192]="DataStream5",i[i.DataStream6=16384]="DataStream6",i[i.DataStream7=32768]="DataStream7"}(Bt||(Bt={})),function(i){i[i.websocket=0]="websocket",i[i.datachannel=1]="datachannel"}(Zh||(Zh={})),function(i){i.CHINA="CHINA",i.ASIA="ASIA",i.NORTH_AMERICA="NORTH_AMERICA",i.EUROPE="EUROPE",i.JAPAN="JAPAN",i.INDIA="INDIA",i.KOREA="KOREA",i.HKMC="HKMC",i.US="US",i.OCEANIA="OCEANIA",i.SOUTH_AMERICA="SOUTH_AMERICA",i.AFRICA="AFRICA",i.OVERSEA="OVERSEA",i.GLOBAL="GLOBAL",i.EXTENSIONS="EXTENSIONS"}(He||(He={}));let jA=[He.AFRICA,He.ASIA,He.CHINA,He.EUROPE,He.GLOBAL,He.INDIA,He.JAPAN,He.NORTH_AMERICA,He.OCEANIA,He.OVERSEA,He.SOUTH_AMERICA];var pi;(function(i){i.CHINA="CN",i.ASIA="AS",i.NORTH_AMERICA="NA",i.EUROPE="EU",i.JAPAN="JP",i.INDIA="IN",i.KOREA="KR",i.HKMC="HK",i.US="US",i.OCEANIA="OC",i.SOUTH_AMERICA="SA",i.AFRICA="AF",i.OVERSEA="OVERSEA",i.GLOBAL="GLOBAL",i.EXTENSIONS="GLOBAL"})(pi||(pi={}));let ep={CHINA:{},ASIA:{CODE:pi.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:pi.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:pi.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:pi.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","	uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:pi.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:pi.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:pi.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:pi.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:pi.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:pi.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:pi.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:pi.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:pi.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var Ed,BA,fe,Ci,Yn,$,Ke,ye,GA,jr,Br,Kt,hs,Ot,qn,WA,yr,an,_a,lt,ps,HA;zE&&(ep.CHINA={CODE:pi.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(i){i.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(Ed||(Ed={}));class KA extends mt{constructor(e,t){super(),g(this,"onICEConnectionStateChange",void 0),g(this,"onConnectionStateChange",void 0),g(this,"onDTLSTransportStateChange",void 0),g(this,"onDTLSTransportError",void 0),g(this,"onICETransportStateChange",void 0),g(this,"onFirstAudioReceived",void 0),g(this,"onFirstVideoReceived",void 0),g(this,"onFirstAudioDecoded",void 0),g(this,"onFirstVideoDecoded",void 0),g(this,"onFirstVideoDecodedTimeout",void 0),g(this,"onSelectedLocalCandidateChanged",void 0),g(this,"onSelectedRemoteCandidateChanged",void 0)}}class tp extends KA{constructor(e,t){super(e,t)}}(function(i){i.SEND="sendonly",i.RECV="recvonly",i.SENDRECV="sendrecv",i.INACTIVE="inactive"})(BA||(BA={})),function(i){i.VIDEO="video",i.AUDIO="audio"}(fe||(fe={})),function(i){i[i.UDP=0]="UDP",i[i.TCP=1]="TCP",i[i.RELAY=2]="RELAY"}(Ci||(Ci={})),function(i){i[i.FIRST_CONNECTION=0]="FIRST_CONNECTION",i[i.TCP_RESTART=1]="TCP_RESTART",i[i.RELAY_RESTART=2]="RELAY_RESTART",i[i.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",i[i.OLD_RESTART=11]="OLD_RESTART",i[i.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(Yn||(Yn={})),function(i){i.LocalVideoTrack="videoTrack",i.LocalAudioTrack="audioTrack",i.LocalVideoLowTrack="videoLowTrack"}($||($={})),function(i){i.New="new",i.Connected="connected",i.Reconnecting="reconnecting",i.Disconnected="disconnected"}(Ke||(Ke={})),function(i){i.StateChange="stateChange",i.IceConnectionStateChange="iceConnectionStateChange",i.RequestMuteLocal="requestMuteLocal",i.RequestUnmuteLocal="requestUnmuteLocal",i.RequestRePublish="requestRePublish",i.RequestRePublishDataChannel="requestRePublishDataChannel",i.RequestReSubscribe="requestReSubscribe",i.RequestUploadStats="requestUploadStats",i.MediaReconnectStart="MediaReconnectStart",i.MediaReconnectEnd="MediaReconnectEnd",i.NeedSignalRTT="NeedSignalRTT",i.RequestRestartICE="RequestRestartIce",i.PeerConnectionStateChange="PeerConnectionStateChange",i.RequestReconnect="RequestReconnect",i.RequestReconnectPC="RequestReconnectPC",i.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",i.P2PLost="P2PLost",i.UpdateVideoEncoder="UpdateVideoEncoder",i.ConnectionTypeChange="ConnectionTypeChange",i.RequestLowStreamParameter="RequestLowStreamParameter",i.QueryClientConnectionState="QueryClientConnectionState",i.LocalCandidate="LocalCandidate",i.RequestP2PMuteLocal="requestP2PMuteLocal",i.RequestP2PPublish="RequestP2PPublish",i.RequestP2PUnPublish="RequestP2PUnPublish",i.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",i.RequestP2PMuteRemote="RequestP2PMuteRemote",i.RequestP2PRestartICE="RequestP2PRestartICE"}(ye||(ye={})),function(i){i.MUTE_LOCAL_VIDEO="mute_local_video",i.MUTE_LOCAL_AUDIO="mute_local_audio",i.UNMUTE_LOCAL_VIDEO="unmute_local_video",i.UNMUTE_LOCAL_AUDIO="unmute_local_audio",i.MUTE_REMOTE_VIDEO="mute_remote_video",i.MUTE_REMOTE_AUDIO="mute_remote_audio",i.UNMUTE_REMOTE_VIDEO="unmute_remote_video",i.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(GA||(GA={})),function(i){i.CONNECTING="CONNECTING",i.RECONNECTING="RECONNECTING",i.CONNECTED="CONNECTED",i.CLOSED="CLOSED"}(jr||(jr={})),function(i){i[i.CONNECT_AP=0]="CONNECT_AP",i[i.AP_CONNECTED=1]="AP_CONNECTED",i[i.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",i[i.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",i[i.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",i[i.CONNECT_WORKER=5]="CONNECT_WORKER",i[i.WORKER_CONNECTED=6]="WORKER_CONNECTED",i[i.CLOSED=7]="CLOSED"}(Br||(Br={})),function(i){i.CONNECTION_STATE_CHANGE="connection-state-change",i.STATE_CHANGE="state-change",i.INSPECT_RESULT="inspect-result",i.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",i.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Kt||(Kt={})),function(i){i.NETWORK_ERROR="NETWORK_ERROR",i.SERVER_ERROR="SERVER_ERROR",i.MULTI_IP="MULTI_IP",i.TIMEOUT="TIMEOUT",i.OFFLINE="OFFLINE",i.LEAVE="LEAVE",i.P2P_FAILED="P2P_FAILED",i.FALLBACK="FALLBACK"}(hs||(hs={})),function(i){i.CONNECTED="transmitter:connected",i.RECONNECTING="transmitter:reconnecting",i.WILL_RECONNECT="transmitter:will_reconnect",i.CLOSED="transmitter:closed",i.FAILED="transmitter:failed",i.ON_MESSAGE="transmitter:on_message",i.REQUEST_NEW_URLS="transmitter:request_new_urls",i.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",i.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",i.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",i.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",i.FAILBACK="transmitter:failback"}(Ot||(Ot={})),function(i){i.CAMERA_CHANGED="camera-changed",i.MICROPHONE_CHANGED="microphone-changed",i.PLAYBACK_DEVICE_CHANGED="playback-device-changed",i.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",i.AUTOPLAY_FAILED="autoplay-failed",i.SECURITY_POLICY_VIOLATION="security-policy-violation"}(qn||(qn={})),function(i){i[i.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",i[i.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",i[i.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",i[i.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",i[i.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",i[i.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",i[i.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",i[i.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",i[i.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",i[i.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",i[i.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",i[i.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",i[i.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",i[i.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",i[i.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",i[i.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",i[i.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",i[i.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",i[i.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",i[i.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(WA||(WA={})),function(i){i.CONNECTING="CONNECTING",i.RECONNECTING="RECONNECTING",i.CONNECTED="CONNECTED",i.CLOSED="CLOSED"}(yr||(yr={})),function(i){i.CONNECTION_STATE_CHANGE="connection-state-change",i.STATE_CHANGE="state-change",i.INSPECT_RESULT="inspect-result",i.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",i.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(an||(an={})),function(i){i[i.CONNECT_AP=0]="CONNECT_AP",i[i.AP_CONNECTED=1]="AP_CONNECTED",i[i.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",i[i.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",i[i.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",i[i.CONNECT_WORKER=5]="CONNECT_WORKER",i[i.WORKER_CONNECTED=6]="WORKER_CONNECTED",i[i.CLOSED=7]="CLOSED"}(_a||(_a={})),function(i){i.CALL="call",i.CANDIDATE="candidate",i.PUBLISH="publish",i.UNPUBLISH="unpublish",i.SUBSCRIBE="subscribe",i.UNSUBSCRIBE="unsubscribe",i.CONTROL="control",i.RESTART_ICE="restart_ice",i.ACK="ack",i.JOIN="join",i.EXCHANGE_SDP="exchange_sdp",i.DO_SUBSCRIBE="do_subscribe",i.DO_UNSUBSCRIBE="do_unsubscribe"}(lt||(lt={})),function(i){i.MUTE_LOCAL_AUDIO="mute_local_audio",i.MUTE_LOCAL_VIDEO="mute_local_video",i.UNMUTE_LOCAL_AUDIO="unmute_local_audio",i.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(ps||(ps={})),function(i){i[i.SUCCESS=1]="SUCCESS",i[i.FAILED=0]="FAILED"}(HA||(HA={}));let f5={[Bc.ACCESS_POINT]:{[Di.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Di.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Di.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Di.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Di.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Di.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Di.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Bc.UNILBS]:{[Fr.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Fr.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Fr.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Fr.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Fr.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Fr.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Fr.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Fr.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Fr.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Fr.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Fr.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Fr.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Bc.STRING_UID_ALLOCATOR]:{[md.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[md.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[md.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function ip(i){let e=f5[Math.floor(i/1e4)];if(!e)return{desc:"unkonw error",retry:!1};let t=e[i%1e4];if(!t){if(Math.floor(i/1e4)===Bc.ACCESS_POINT){let r=i%1e4;if(r.toString()[0]==="1")return{desc:i.toString(),retry:!1};if(r.toString()[0]==="2")return{desc:i.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return t}let _5={[ve.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[ve.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[ve.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[ve.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[ve.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[ve.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[ve.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[ve.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[ve.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[ve.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[ve.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[ve.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[ve.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[ve.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[ve.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[ve.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[ve.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[ve.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[ve.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[ve.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[ve.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[ve.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[ve.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[ve.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[ve.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[ve.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[ve.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[ve.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[ve.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[ve.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[ve.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[ve.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[ve.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[ve.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[ve.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[ve.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[ve.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[ve.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[ve.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[ve.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[ve.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ve.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ve.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[ve.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[ve.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[ve.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[ve.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[ve.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[ve.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[ve.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[ve.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[ve.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[ve.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[ve.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[ve.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[ve.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[ve.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[ve.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[ve.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[ve.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[ve.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[ve.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[ve.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Ao(i){return _5[i]||{desc:"UNKNOW_ERROR_".concat(i),action:"failed"}}function zA(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function tg(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?zA(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):zA(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function YA(i){return i.every(e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)}function qA(i,e){if(typeof i=="string")return i;let{proxy:t,host:r,port:n}=i;if(e){let a=P("JOIN_GATEWAY_FALLBACK_PORT")||443;return a===443?"wss://".concat(r,"/ws/?p=").concat(Number(n)+150):"wss://".concat(r,":").concat(a,"/ws/?p=").concat(Number(n)+150)}return t?"wss://".concat(t,"/ws/?h=").concat(r,"&p=").concat(n):"wss://".concat(r,":").concat(n)}let m5=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,E5=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,g5=/wss:\/\/(.+):([0-9]+)\/?/,S5=/wss:\/\/(.[^\/]+)\/?/,T5=0;class v5{constructor(e,t){g(this,"id",0),g(this,"store",void 0),g(this,"recordIndex",void 0),g(this,"websockets",[]),g(this,"try443PortDuration",2e3),g(this,"forceCloseWSDuration",5e3),g(this,"try443PortTimeout",null),g(this,"forceCloseTimeout",null),g(this,"isTry443PortFailed",!1),g(this,"isNormalPortFailed",!1),g(this,"useDoubleDomain",!1),g(this,"useProxy",!1),g(this,"startTime",Date.now()),this.id=++T5,this.try443PortDuration=P("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;let t=Date.now()-this.startTime;for(var r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];S.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(t,"ms:"),...n)}createWebSocket(e,t,r){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:r});let n=P("GATEWAY_DOMAINS"),a=Date.now(),c=[],l=n.find(p=>{var _;return ge(_=e.host).call(_,p)});l||(this.useDoubleDomain=!1);let u=[];if(this.useDoubleDomain)n.forEach(p=>{u.push(qA(tg(tg({},e),{},{host:e.host.replace(l,p)}),t))});else{let p=tg({},e);if(t&&l){let _=n.find(E=>E!==l);_&&(p.host=p.host.replace(l,_))}u.push(qA(p,t))}try{u.forEach(p=>{let _=new WebSocket(p);_.binaryType="arraybuffer",c.push(_),this.logger("ws is connecting:",_.url)})}catch(p){if(this.logger("ws create failed"),c.forEach(_=>_.close()),c.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,r);if(!t&&Number(e.port)!==443)return this.createWebSocket(e,!0,r);throw new x(A.WS_ERR,"init websocket failed! Error: ".concat(p.toString()))}let h=dd();return this.store&&this.store.recordJoinChannelService({urls:c.map(p=>p.url),service:"gateway"},this.recordIndex),c.forEach(p=>{p.onopen=()=>{this.logger("onopen: ws ".concat(p.url," open cost ").concat(Date.now()-a,"ms")),this.websockets.forEach(_=>{_!==p&&(_.onopen=null,_.onclose=null,_.onmessage=null,_.close(),this.logger("close backup websocket: ".concat(_.url)))}),this.websockets.length=0,h.resolve(p)},p.onclose=_=>{this.logger("onclose: ws ".concat(p.url," closed cost ").concat(Date.now()-a,"ms state: ").concat(p.readyState)),t?this.isTry443PortFailed=YA(c):this.isNormalPortFailed=YA(c),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(t&&this.isTry443PortFailed||!t&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(_.reason)),h.reject({code:_.code,reason:wo.A_ROUND_WS_FAILED}))},p.onmessage=_=>this.logger("".concat(p.url," onmessage: ").concat(_.data))}),this.websockets.push(...c),r||(()=>{let p=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",h.isResolved),this.websockets.forEach(_=>_.readyState!==WebSocket.OPEN&&_.close())};if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(p,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",h.isResolved),h.isResolved)return p();ze().os===Jt.MAC_OS&&ht()&&p(),this.createWebSocket(e,!0,!0).then(_=>h.resolve(_)).catch(_=>{this.isNormalPortFailed&&h.reject(_),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(p,this.forceCloseWSDuration)},this.try443PortDuration)})(),h.promise}chooseBestWebsocket(e,t,r,n){return this.useDoubleDomain=!!t,typeof e=="string"&&(e=function(a){let c,l,u;return[,c,l,u]=a.match(m5)||[],c||([,l,u]=a.match(E5)||[]),l&&u||([,l,u]=a.match(g5)||[]),l&&u||([,l]=a.match(S5)||[]),l||S.warning("un-destructible url: ",a),{proxy:c,host:l,port:u||"443"}}(e)),this.recordIndex=n,this.useProxy=!!e.proxy,r&&this.useProxy&&(S.warn("cannot use 443 only when use proxy"),r=!1),this.createWebSocket(e,!!r,!1).finally(()=>this.clearTimeout())}}function JA(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}class XA extends mt{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;ge(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Ie.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Ie.CONNECTED):this._state==="closed"?this.emit(Ie.CLOSED):this._state==="failed"&&this.emit(Ie.FAILED))}resetReconnectCount(e){S.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2],n=arguments.length>3&&arguments[3]!==void 0&&arguments[3],a=arguments.length>4&&arguments[4]!==void 0&&arguments[4],c=arguments.length>5?arguments[5]:void 0;super(),g(this,"connectionID",0),g(this,"currentURLIndex",0),g(this,"urls",[]),g(this,"_reconnectMode","tryNext"),g(this,"reconnectReason",void 0),g(this,"_initMutex",new si("websocket")),g(this,"name",void 0),g(this,"_state","closed"),g(this,"reconnectInterrupter",void 0),g(this,"websocket",void 0),g(this,"retryConfig",void 0),g(this,"reconnectCount",0),g(this,"forceCloseTimeout",5e3),g(this,"onlineReconnectListener",void 0),g(this,"useCompress",void 0),g(this,"tryDoubleDomain",!1),g(this,"use443PortOnly",!1),g(this,"wsInflateLength",0),g(this,"wsDeflateLength",0),g(this,"closeEstablishingWs",()=>{}),g(this,"store",void 0),g(this,"joinGatewayRecordIndex",void 0),this.store=c,this.name=e,this.retryConfig=function(_){for(var E=1;E<arguments.length;E++){var T=arguments[E]!=null?arguments[E]:{};E%2?JA(Object(T),!0).forEach(function(w){g(_,w,T[w])}):Object.getOwnPropertyDescriptors?Object.defineProperties(_,Object.getOwnPropertyDescriptors(T)):JA(Object(T)).forEach(function(w){Object.defineProperty(_,w,Object.getOwnPropertyDescriptor(T,w))})}return _}({},t),this.useCompress=r,this.tryDoubleDomain=n,this.use443PortOnly=a;let{timeout:l,timeoutFactor:u}=t,h=Math.max(300,Math.floor(3*l/5)),p=Math.max(1.2,Math.floor(8*u)/10);ji.ONLINE&&(this.retryConfig.timeout=h,this.retryConfig.timeoutFactor=p),Mt.on(Ls.NETWORK_STATE_CHANGE,(_,E)=>{_!==E&&(this.resetReconnectCount("network state change: ".concat(E," -> ").concat(_)),_===ji.ONLINE?(this.retryConfig.timeout=h,this.retryConfig.timeoutFactor=p):(this.retryConfig.timeout=l,this.retryConfig.timeoutFactor=u))})}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,r=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{let n=dd(),a=this.urls[this.currentURLIndex];this.createWebSocketConnection(a).then(n.resolve).catch(n.reject),this.once(Ie.CLOSED,()=>{n.reject(new Y(A.WS_DISCONNECT))}),this.once(Ie.CONNECTED,n.resolve),await n.promise}catch{}finally{r()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;let r=this.websocket;t?setTimeout(()=>r.close(),500):r.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,t){if(!this.websocket)return void S.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),S.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(t)]},this.joinGatewayRecordIndex);let r=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),r&&r.bind(this.websocket)({code:9999,reason:t})}sendMessage(e){let t=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new Y(A.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(r){throw new Y(A.WS_ERR,"send websocket message error"+r.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){let e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var t;let r=dd();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;let n=p=>{var _;(_=this.store)===null||_===void 0||_.signalChannelOpen(),S.debug("[".concat(this.name,"] websocket opened:"),p),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),r.resolve()},a=async p=>{var _;if(S.debug("[".concat(this.name,"] websocket close ").concat((_=this.websocket)===null||_===void 0?void 0:_.url,", code: ").concat(p.code,", reason: ").concat(p.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)r.reject(new Y(A.WS_DISCONNECT,"websocket close: ".concat(p.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=p.reason,this.state="reconnecting");let E=cr(this,Ie.WILL_RECONNECT,this.reconnectMode,p.reason)||this.reconnectMode,T=await this.reconnectWithAction(E);if(this.state==="closed")return void S.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!T)return r.reject(new Y(A.WS_DISCONNECT,"websocket reconnect failed: ".concat(p.code))),this.close(!0);r.resolve()}},c=p=>{this.emit(Ie.ON_MESSAGE,p)},l=p=>{S.warn("[".concat(this.connectionID,"] ws open error ").concat(p))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),P("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=P("GATEWAY_WSS_ADDRESS")),S.debug("[".concat(this.name,"] start connect, url:"),e);let u=(t=this.store)===null||t===void 0?void 0:t.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var h;let p=await this.chooseBestWebsocketConnection(e);this.websocket=p,n&&n(this.websocket.url),this.websocket.onclose=a,this.websocket.onmessage=c,this.websocket.onerror=l,(h=this.store)===null||h===void 0||h.recordJoinChannelService({endTs:Date.now(),status:"success"},u),this.joinGatewayRecordIndex=u}catch(p){let _=this.state==="closed",E=p instanceof Y,T=E&&p.code===A.WS_ABORT,w=E&&p.code===A.WS_ERR,C=E?p.message:p&&(p.reason||p.toString());S.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(C)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:T?"aborted":"error",errors:[p]},u),_||w?(r.reject(_?new Y(A.WS_DISCONNECT,"websocket is closed: ".concat(C)):new Y(A.WS_ERR,"init websocket failed: ".concat(C))),w&&S.error("[".concat(this.name,"] init websocket failed: ").concat(C))):a&&a(p)}return r.promise}async reconnectWithAction(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;S.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||Mt.isOnline||!Mt.onlineWaiter||(this.onlineReconnectListener=Mt.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let r=!0;if(this.reconnectInterrupter=()=>r=!1,t){let c=Bh(this.reconnectCount,this.retryConfig);S.debug("[".concat(this.name,"] wait ").concat(c,"ms to reconnect websocket, mode: ").concat(e)),await F.race([Si(c),this.onlineReconnectListener||new F(()=>{})])}if(this._state==="closed"||!r)return!1;this.reconnectCount+=1;let n=async(c,l)=>{this.emit(Ie.RECONNECT_CREATE_CONNECTION,l),await this.createWebSocketConnection(c)};try{if(e==="retry")this.emit(Ie.RECONNECT_WAITTING_FINISH,e),await n(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);S.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(Ie.RECONNECT_WAITTING_FINISH,e),await n(this.urls[this.currentURLIndex],e)}else e==="recover"&&(S.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(Ie.RECONNECT_WAITTING_FINISH,e),this.urls=await vt(this,Ie.REQUEST_NEW_URLS),this.currentURLIndex=0,await n(this.urls[this.currentURLIndex],e))}catch(c){var a;S.error("[".concat(this.name,"] reconnect failed ").concat(c&&c.toString()));let l=c==null||(a=c.data)===null||a===void 0?void 0:a.desc;return Array.isArray(l)&&ge(l).call(l,"dynamic key expired")?(this.emit(Ie.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,t)}return!0}}class gd extends XA{constructor(e,t){super(e,t,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){let r=dd(),n=function(c,l){return new v5(c,l)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{S.debug("[choose-best-ws] close establishing websockets"),n.closeAllWebsockets(),r.reject(new Y(A.WS_ABORT,"choose best websocket aborted"))};let a=P("GATEWAY_DOMAINS");return S.debug("[choose-best-ws] currentDomain: ",e,", domains: ",a,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),n.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,t).then(r.resolve).catch(r.reject),r.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class Sd extends XA{constructor(e,t){super(e,t,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){return new F((r,n)=>{let a=!1,c=[];this.closeEstablishingWs=()=>{S.debug("[choose-best-ws] close establishing websockets"),c.forEach(w=>{w.onclose=null,w.onopen=null,w.onmessage=null,w.close()}),n(new Y(A.WS_ABORT,"choose best websocket aborted"))};let l=P("GATEWAY_DOMAINS"),u,h=e.indexOf("?h="),p=l.find(w=>h!==-1?ge(e).call(e,w,h):ge(e).call(e,w));S.debug("[choose-best-ws] currentDomain: ",p,", domains: ",l);let _=!this.tryDoubleDomain||!p;if(!_&&p){var E;let w=Date.now();try{l.forEach(C=>{let O=h===-1?e.replace(p,C):e.substr(0,h)+e.substr(h).replace(p,C),b=new WebSocket(O);b.binaryType="arraybuffer",c.push(b),S.debug("[choose-best-ws] ws is connecting:",b.url)})}catch{for(S.debug("[choose-best-ws] ws create failed, fallback to single url"),c.forEach(C=>C.close());c.length;)c.pop();_=!0}(E=this.store)===null||E===void 0||E.recordJoinChannelService({urls:c.map(C=>C.url),service:"gateway"},t),c.forEach(C=>{C.onopen=()=>{if(a)return;let O=Date.now()-w;S.debug("[choose-best-ws] ws open cost ".concat(O,"ms")),c.filter(b=>b!==C).forEach(b=>{S.debug("[choose-best-ws]close backup websocket: ".concat(b.url)),b.close()}),a=!0,r(C)},C.onclose=O=>{u=O,!a&&(c.find(b=>!(b.readyState===WebSocket.CLOSED||b.readyState===WebSocket.CLOSING))||(S.debug("[choose-best-ws] all websocket is closed"),a=!0,n(u)))},C.onmessage=O=>{S.debug("[choose-best-ws]".concat(C.url," onmessage: ").concat(O.data))}}),Si(this.forceCloseTimeout).then(()=>{c.forEach(C=>{C.readyState!==WebSocket.OPEN&&C.close()})})}if(_){var T;let w;S.debug("[choose-best-ws] use single url: ",e),(T=this.store)===null||T===void 0||T.recordJoinChannelService({urls:[e],service:"gateway"},t);try{w=new WebSocket(e),c.push(w),w.binaryType="arraybuffer"}catch(C){let O=new Y(A.WS_ERR,"init websocket failed! Error: ".concat(C.toString()));return S.error("[".concat(this.name,"]").concat(O)),void n(O)}w.onopen=()=>{r(w)},w.onclose=C=>{n(C)},w.onmessage=C=>{S.debug("[choose-best-ws]".concat(w.url," onmessage: ").concat(C.data))},Si(this.forceCloseTimeout).then(()=>{w&&w.readyState!==WebSocket.OPEN&&w.close()})}}).then(r=>(this.closeEstablishingWs=void 0,r)).catch(r=>{throw this.closeEstablishingWs=void 0,r})}}class QA extends mt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===xe.CONNECTED?this.emit(le.WS_CONNECTED):e===xe.RECONNECTING?this.emit(le.WS_RECONNECTING,this._websocketReconnectReason):e===xe.CLOSED&&this.emit(le.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",xe.CLOSED),g(this,"reconnectToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new AE(5)),g(this,"pingpongTimer",void 0),g(this,"wsInflateDataTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(le.ON_BINARY_DATA,r.data);let n=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(n,"_id")){let a="res-@".concat(n._id);this.emit(a,n._result,n._message)}else if(Object.prototype.hasOwnProperty.call(n,"_type")){if(this.emit(n._type,n._message),n._type===Ae.ON_NOTIFICATION&&this.handleNotification(n._message),n._type===Ae.ON_USER_BANNED)switch(n._message.error_code){case 14:this.close(Ve.UID_BANNED);break;case 15:this.close(Ve.IP_BANNED);break;case 16:this.close(Ve.CHANNEL_BANNED)}if(n._type===Ae.ON_USER_LICENSE_BANNED)switch(n._message.error_code){case ve.ERR_LICENSE_MISSING:this.close(Ve.LICENSE_MISSING);break;case ve.ERR_LICENSE_EXPIRED:this.close(Ve.LICENSE_EXPIRED);break;case ve.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ve.LICENSE_MINUTES_EXCEEDED);break;case ve.ERR_LICENSE_PERIOD_INVALID:this.close(Ve.LICENSE_PERIOD_INVALID);break;case ve.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ve.LICENSE_MULTIPLE_SDK_SERVICE);break;case ve.ERR_LICENSE_ILLEGAL:this.close(Ve.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new gd("gateway-".concat(this.clientId),this.spec.retryConfig,!0,P("JOIN_GATEWAY_USE_DUAL_DOMAIN"),P("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===xe.CONNECTED&&this.reconnect("retry",Qt.OFFLINE)})}async request(e,t,r,n){let a=at(6,""),c={_id:a,_type:e,_message:t},l=this.websocket.connectionID,u=()=>new F((w,C)=>{if(this.connectionState===xe.CONNECTED)return w();let O=()=>{this.off(le.WS_CLOSED,b),w()},b=()=>{this.off(le.WS_CONNECTED,O),C(new x(A.WS_ABORT))};this.once(le.WS_CONNECTED,O),this.once(le.WS_CLOSED,b),e!==me.PUBLISH&&e!==me.SUBSCRIBE&&e!==me.UNSUBSCRIBE&&e!==me.UNPUBLISH&&e!==me.CONTROL&&e!==me.RESTART_ICE||this.once(le.DISCONNECT_P2P,()=>{C(new x(A.DISCONNECT_P2P))}),e!==me.PUBLISH&&e!==me.RESTART_ICE||this.once(le.ABORT_P2P_EXECUTION,()=>{C(new x(A.DISCONNECT_P2P))})});if(this.connectionState!==xe.CONNECTING&&this.connectionState!==xe.RECONNECTING||e===me.JOIN||e===me.REJOIN||await u(),this.websocket.sendMessage(c,!0),n)return;let h=new F((w,C)=>{let O=!1,b=(U,X)=>{O=!0,w({isSuccess:U==="success",message:X||{}}),this.off(le.WS_CLOSED,k),this.off(le.WS_RECONNECTING,k),this.emit(le.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(a),b);let k=()=>{C(new x(A.WS_ABORT,"type: ".concat(e))),this.off(le.WS_CLOSED,k),this.off(le.WS_RECONNECTING,k),this.off("res-@".concat(a),b)};this.once(le.WS_CLOSED,k),this.once(le.WS_RECONNECTING,k),Si(P("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==l||O||(S.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(le.REQUEST_TIMEOUT,e,t))})}),p=null;try{p=await h}catch(w){if(this.connectionState===xe.CLOSED||e===me.LEAVE)throw new x(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?w.throw():e===me.JOIN||e===me.REJOIN?null:(await u(),await this.request(e,t))}if(p.isSuccess)return p.message;let _=Number(p.message.error_code||p.message.code),E=Ao(_),T=new x(A.UNEXPECTED_RESPONSE,"".concat(E.desc,": ").concat(p.message.error_str),{code:_,data:p.message});return E.action==="success"?p.message:(S.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(_,", message: ").concat(E.desc,", action: ").concat(E.action)),_===ve.ERR_TOO_MANY_BROADCASTERS?((e===me.JOIN||e===me.REJOIN)&&(this.initError=T,this.close()),T.throw()):E.action==="failed"?T.throw():E.action==="quit"?(this.initError=T,this.close(),T.throw()):(_===ve.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=p.message.option,S.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Qt.MULTI_IP)):this.reconnect(E.action,Qt.SERVER_ERROR),e===me.JOIN||e===me.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new F(r=>{let n=a=>{(!t||t(a))&&(this.off(e,n),r(a))};this.on(e,n)})}upload(e,t){let r={_type:e,_message:t};try{this.websocket.sendMessage(r)}catch{let n=P("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>n&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==xe.CONNECTED)return;let a=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(a._type,a._message)},P("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){let r={_type:e,_message:t};this.websocket.sendMessage(r)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new F((r,n)=>{this.once(le.WS_CONNECTED,()=>r(this.joinResponse)),this.once(le.WS_CLOSED,()=>n(this.initError||new x(A.WS_ABORT))),this.connectionState=xe.CONNECTING,this.websocket.init(e).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Ve.LEAVE,this.connectionState=xe.CLOSED,S.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===Ve.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new gd("gateway-".concat(this.clientId),this.spec.retryConfig,!0,P("JOIN_GATEWAY_USE_DUAL_DOMAIN"),P("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(le.ABORT_P2P_EXECUTION);let e=await vt(this,le.REQUEST_JOIN_INFO),t=await this.request(me.JOIN,e);if(!t)return this.emit(le.REPORT_JOIN_GATEWAY,wo.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(le.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=xe.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new x(A.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=Ms(this,le.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;let t=await this.request(me.REJOIN,e);return!!t&&(this.connectionState=xe.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach(r=>{this.emit(Ae.ON_USER_ONLINE,{uid:r.uid}),r.audio&&this.emit(Ae.ON_ADD_AUDIO_STREAM,{uid:r.uid,uint_id:r.uint_id,audio:!0,ssrcId:r.audio_ssrc}),r.video&&this.emit(Ae.ON_ADD_VIDEO_STREAM,{uid:r.uid,uint_id:r.uint_id,video:!0,ssrcId:r.video_ssrc}),r.audio_mute?this.emit(Ae.MUTE_AUDIO,{uid:r.uid}):this.emit(Ae.UNMUTE_AUDIO,{uid:r.uid}),r.video_mute?this.emit(Ae.MUTE_VIDEO,{uid:r.uid}):this.emit(Ae.UNMUTE_VIDEO,{uid:r.uid}),r.audio_enable_local?this.emit(Ae.ENABLE_LOCAL_AUDIO,{uid:r.uid}):this.emit(Ae.DISABLE_LOCAL_AUDIO,{uid:r.uid}),r.video_enable_local?this.emit(Ae.ENABLE_LOCAL_VIDEO,{uid:r.uid}):this.emit(Ae.DISABLE_LOCAL_VIDEO,{uid:r.uid}),r.audio||r.video||this.emit(Ae.ON_REMOVE_STREAM,{uid:r.uid,uint_id:r.uint_id})}),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){S.debug("[".concat(this.clientId,"] receive notification: "),e);let t=Ao(e.code);if(t.action!=="success"){if(t.action!=="failed")return t.action==="quit"?(t.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ve.UID_BANNED),void this.close()):void this.reconnect(t.action,Qt.SERVER_ERROR);S.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=P("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(S.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>P("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Qt.TIMEOUT):this.request(me.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let r=Date.now()-t;this.rttRolling.add(r),P("REPORT_STATS")&&this.send(me.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWsInflateData(){let{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();e!==0&&t!==0&&this.upload(ur.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Ie.RECONNECT_WAITTING_FINISH,e=>{this.emit(le.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(Ie.RECONNECT_CREATE_CONNECTION,e=>{this.emit(le.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Ie.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ie.CLOSED,()=>{this.connectionState=xe.CLOSED}),this.websocket.on(Ie.FAILED,()=>{this._disconnectedReason=Ve.NETWORK_ERROR,this.connectionState=xe.CLOSED}),this.websocket.on(Ie.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===xe.CONNECTED?this.connectionState=xe.RECONNECTING:this.connectionState=xe.CONNECTING}),this.websocket.on(Ie.WILL_RECONNECT,(e,t,r)=>{let n=Ms(this,le.IS_P2P_DISCONNECTED),a=n||e!=="retry";n&&e==="retry"&&(S.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",t=wo.P2P_DISCONNECTED),a&&(S.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(le.REPORT_JOIN_GATEWAY,t||wo.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(le.NEED_RENEW_SESSION),this.emit(le.DISCONNECT_P2P)),r(e)}),this.websocket.on(Ie.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{S.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Qt.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(le.REPORT_JOIN_GATEWAY,e.message||e.code||wo.UNKNOWN_REASON,this.url||""),e instanceof x&&e.code===A.UNEXPECTED_RESPONSE&&e.data.code===ve.ERR_NO_AUTHORIZED)return S.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Qt.SERVER_ERROR);S.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Qt.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Ie.REQUEST_NEW_URLS,(e,t)=>{vt(this,le.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)}),this.websocket.on(Ie.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}var $A=`	
\v\f\r \u2028\u2029\uFEFF`,y5=Wl,C5=bs,ig=$A,ZA=hi("".replace),R5=RegExp("^["+ig+"]+"),I5=RegExp("(^|[^"+ig+"])["+ig+"]+$"),rg=function(i){return function(e){var t=C5(y5(e));return 1&i&&(t=ZA(t,R5,"")),2&i&&(t=ZA(t,I5,"$1")),t}},w5={start:rg(1),end:rg(2),trim:rg(3)},A5=dR.PROPER,O5=Ei,eO=$A,N5=w5.trim;Pt({target:"String",proto:!0,forced:function(i){return O5(function(){return!!eO[i]()||""[i]()!==""||A5&&eO[i].name!==i})}("trim")},{trim:function(){return N5(this)}});var ai,oi,b5=ho("String").trim,D5=Gn,P5=b5,ng=String.prototype,sg=Zi(function(i){var e=i.trim;return typeof i=="string"||i===ng||D5(ng,i)&&e===ng.trim?P5:e});function Hc(i,e,t){return{sampleRate:i,stereo:e,bitrate:t}}function Ge(i,e,t,r,n){return{width:i,height:e,frameRate:t,bitrateMin:r,bitrateMax:n}}function An(i,e,t,r,n){return{width:{max:i},height:{max:e},frameRate:t,bitrateMin:r,bitrateMax:n}}function ag(i,e){return{numSpatialLayers:i,numTemporalLayers:e}}(function(i){i[i.CHOOSE_SERVER=11]="CHOOSE_SERVER",i[i.CLOUD_PROXY=18]="CLOUD_PROXY",i[i.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",i[i.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"})(ai||(ai={})),function(i){i.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",i.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",i.IOS_INTERRUPTION_START="ios-interruption-start",i.IOS_INTERRUPTION_END="ios-interruption-end",i.STATE_CHANGE="state-change"}(oi||(oi={}));let k5={"90p":Ge(160,90),"90p_1":Ge(160,90),"120p":Ge(160,120,15,30,65),"120p_1":Ge(160,120,15,30,65),"120p_3":Ge(120,120,15,30,50),"120p_4":Ge(212,120),"180p":Ge(320,180,15,30,140),"180p_1":Ge(320,180,15,30,140),"180p_3":Ge(180,180,15,30,100),"180p_4":Ge(240,180,15,30,120),"240p":Ge(320,240,15,40,200),"240p_1":Ge(320,240,15,40,200),"240p_3":Ge(240,240,15,40,140),"240p_4":Ge(424,240,15,40,220),"360p":Ge(640,360,15,80,400),"360p_1":Ge(640,360,15,80,400),"360p_3":Ge(360,360,15,80,260),"360p_4":Ge(640,360,30,80,600),"360p_6":Ge(360,360,30,80,400),"360p_7":Ge(480,360,15,80,320),"360p_8":Ge(480,360,30,80,490),"360p_9":Ge(640,360,15,80,800),"360p_10":Ge(640,360,24,80,800),"360p_11":Ge(640,360,24,80,1e3),"480p":Ge(640,480,15,100,500),"480p_1":Ge(640,480,15,100,500),"480p_2":Ge(640,480,30,100,1e3),"480p_3":Ge(480,480,15,100,400),"480p_4":Ge(640,480,30,100,750),"480p_6":Ge(480,480,30,100,600),"480p_8":Ge(848,480,15,100,610),"480p_9":Ge(848,480,30,100,930),"480p_10":Ge(640,480,10,100,400),"720p":Ge(1280,720,15,120,1130),"720p_auto":Ge(1280,720,30,900,3e3),"720p_1":Ge(1280,720,15,120,1130),"720p_2":Ge(1280,720,30,120,2e3),"720p_3":Ge(1280,720,30,120,1710),"720p_5":Ge(960,720,15,120,910),"720p_6":Ge(960,720,30,120,1380),"1080p":Ge(1920,1080,15,120,2080),"1080p_1":Ge(1920,1080,15,120,2080),"1080p_2":Ge(1920,1080,30,120,3e3),"1080p_3":Ge(1920,1080,30,120,3150),"1080p_5":Ge(1920,1080,60,120,4780),"1440p":Ge(2560,1440,30,120,4850),"1440p_1":Ge(2560,1440,30,120,4850),"1440p_2":Ge(2560,1440,60,120,7350),"4k":Ge(3840,2160,30,120,8910),"4k_1":Ge(3840,2160,30,120,8910),"4k_3":Ge(3840,2160,60,120,13500)},rp=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],L5={"480p":An(640,480,5),"480p_1":An(640,480,5),"480p_2":An(640,480,30),"480p_3":An(640,480,15),"720p":An(1280,720,5),"720p_auto":Ge(1280,720,30,900,3e3),"720p_1":An(1280,720,5),"720p_2":An(1280,720,30),"720p_3":An(1280,720,15),"1080p":An(1920,1080,5),"1080p_1":An(1920,1080,5),"1080p_2":An(1920,1080,30),"1080p_3":An(1920,1080,15)},M5={"1SL1TL":ag(1,1),"3SL3TL":ag(3,3),"2SL3TL":ag(2,3)};function fs(i){return i||(i="480p_1"),typeof i=="string"?Object.assign({},k5[i]):i}function og(i){return typeof i=="string"?Object.assign({},L5[i]):i}function np(i){return typeof i=="string"?Object.assign({},M5[i]):i}let U5={speech_low_quality:Hc(16e3,!1),speech_standard:Hc(32e3,!1,18),music_standard:Hc(48e3,!1),standard_stereo:Hc(48e3,!0,56),high_quality:Hc(48e3,!1,128),high_quality_stereo:Hc(48e3,!0,192)};function sp(i){return typeof i=="string"?Object.assign({},U5[i]):i}let Kc=[];function tO(i){return Xt(i,"mediaSource",["screen","window","application"]),!0}var ue,ut,ma,ap,cg,zc,Ea,Oo,hr,op;(function(i){i.NEED_RENEGOTIATE="@need_renegotiate",i.NEED_REPLACE_TRACK="@need_replace_track",i.NEED_CLOSE="@need_close",i.NEED_ENABLE_TRACK="@need_enable_track",i.NEED_DISABLE_TRACK="@need_disable_track",i.NEED_SESSION_ID="@need_sid",i.SET_OPTIMIZATION_MODE="@set_optimization_mode",i.GET_STATS="@get_stats",i.GET_RTC_STATS="@get_rtc_stats",i.GET_LOW_VIDEO_TRACK="@get_low_video_track",i.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",i.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",i.NEED_MUTE_TRACK="@need_mute_track",i.NEED_UNMUTE_TRACK="@need_unmute_track"})(ue||(ue={})),function(i){i.SCREEN_TRACK="screen_track",i.CUSTOM_TRACK="custome_track",i.LOW_STREAM="low_stream"}(ut||(ut={})),function(i){i[i.HIGH_STREAM=0]="HIGH_STREAM",i[i.LOW_STREAM=1]="LOW_STREAM"}(ma||(ma={})),function(i){i[i.HIGH_STREAM=0]="HIGH_STREAM",i[i.LOW_STREAM=1]="LOW_STREAM"}(ap||(ap={})),function(i){i[i.DISABLE=0]="DISABLE",i[i.LOW_STREAM=1]="LOW_STREAM",i[i.AUDIO_ONLY=2]="AUDIO_ONLY"}(cg||(cg={})),function(i){i.TRANSCEIVER_UPDATED="transceiver-updated"}(zc||(zc={})),function(i){i.SOURCE_STATE_CHANGE="source-state-change",i.TRACK_ENDED="track-ended",i.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",i.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",i.CLOSED="closed"}(Ea||(Ea={})),function(i){i.FIRST_FRAME_DECODED="first-frame-decoded",i.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status"}(Oo||(Oo={})),function(i){i.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",i.RECEIVE_TRACK_BUFFER="receive_track_buffer",i.ON_AUDIO_BUFFER="on_audio_buffer",i.UPDATE_SOURCE="update_source"}(hr||(hr={})),function(i){i.UPDATE_TRACK_SOURCE="update-track-source"}(op||(op={}));let lg={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},dg={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},iO={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},x5={uplinkNetworkQuality:0,downlinkNetworkQuality:0},rO={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};var ki,pr,No,Us,Li;(function(i){i.ON_TRACK="on_track",i.ON_NODE="on_node"})(ki||(ki={})),function(i){i.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",i.REQUEST_CONSTRAINTS="request_constraints"}(pr||(pr={})),function(i){i.IDLE="IDLE",i.INITING="INITING",i.INITEND="INITEND"}(No||(No={})),function(i){i.STATE_CHANGE="state_change",i.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",i.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",i.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(Us||(Us={})),function(i){i.NONE="none",i.INIT="init",i.CANPLAY="canplay",i.PLAYING="playing",i.PAUSED="paused",i.SUSPEND="suspend",i.STALLED="stalled",i.WAITING="waiting",i.ERROR="error",i.DESTROYED="destroyed",i.ABORT="abort",i.ENDED="ended",i.EMPTIED="emptied",i.LOADEDDATA="loadeddata"}(Li||(Li={}));let ug={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};var Yc;(function(i){i.OPEN="open",i.MESSAGE="message",i.CLOSE="close",i.CLOSING="closing",i.ERROR="error"})(Yc||(Yc={}));class nO extends mt{constructor(e,t){super(),g(this,"_ID",void 0),g(this,"_rtpTransceiver",void 0),g(this,"_lowRtpTransceiver",void 0),g(this,"_hints",[]),g(this,"_isClosed",!1),g(this,"_originMediaStreamTrack",void 0),g(this,"_mediaStreamTrack",void 0),g(this,"_external",{}),this._ID=t||at(8,"track-"),this._originMediaStreamTrack=e,this._mediaStreamTrack=e,function(r){ge(Kc).call(Kc,r)||Kc.push(r)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){if(!e){let t=Ee.reportApiInvoke(null,{name:jt.GET_MEDIA_STREAM_TRACK,options:[],tag:St.TRACER});this._mediaStreamTrack&&typeof this._mediaStreamTrack.label=="string"?t.onSuccess(this._mediaStreamTrack.label):t.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===ma.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){let t=Kc.indexOf(e);t!==-1&&Kc.splice(t,1)}(this),this.emit(Ea.CLOSED)}_updateRtpTransceiver(e,t){if(t===ma.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(zc.TRANSCEIVER_UPDATED,e,t)}}class Ri extends nO{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}constructor(e,t){super(e,t),g(this,"_enabled",!0),g(this,"_muted",!1),g(this,"_isExternalTrack",!1),g(this,"_isClosed",!1),g(this,"_enabledMutex",void 0),g(this,"processor",void 0),g(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new si("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,t;return(e=(t=this._originMediaStreamTrack)===null||t===void 0?void 0:t.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,S.debug("[".concat(this.getTrackId(),"] close")),this.emit(ue.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,t){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=r,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await st(this,ue.NEED_REPLACE_TRACK,this),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){S.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Ea.TRACK_ENDED)}stateCheck(e,t){if(S.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(t,"]")),So(t,e),this._enabled&&this._muted&&e==="enabled"&&t===!1)throw new Y(A.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",S);if(!this._enabled&&!this._muted&&e==="muted"&&t===!0)throw new Y(A.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",S)}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}function sO(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}let aO=window.AudioContext||window.webkitAudioContext,Gr=null,tt=new class extends mt{constructor(){super(...arguments),g(this,"prevState",void 0),g(this,"curState",void 0),g(this,"currentTime",void 0),g(this,"currentTimeStuckAt",void 0),g(this,"interruptDetectorTrack",void 0),g(this,"onLocalAudioTrackMute",()=>{S.info("ios15-interruption-start"),this.emit(oi.IOS_15_16_INTERRUPTION_START)}),g(this,"onLocalAudioTrackUnmute",async()=>{S.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?S.info("ios15-interruption-end-canceled"):(Gr&&await Gr.suspend(),this.emit(oi.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(i){S.debug("webaudio bindInterruptDetectorTrack ".concat(i.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=i,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(i){S.debug("webaudio unbindInterruptDetectorTrack ".concat(i.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===i&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function V5(){if(!aO)return void S.error("your browser is not support web audio");S.info("create audio context");let i=function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};t%2?sO(Object(r),!0).forEach(function(n){g(e,n,r[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):sO(Object(r)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))})}return e}({},P("WEBAUDIO_INIT_OPTIONS"));S.debug("audio context init option:",JSON.stringify(i)),Gr=new aO(i),tt.curState=Gr.state,Gr.onstatechange=()=>{tt.prevState=tt.curState,tt.curState=Gr?Gr.state:void 0;let{prevState:e,curState:t}=tt,r=t==="running",n=t==="interrupted",a=e==="running",c=e==="suspended",l=e==="interrupted",u=ze().osVersion;(Fi()||ls())&&a&&n&&(S.info("ios".concat(u,"-interruption-start")),tt.emit(oi.IOS_INTERRUPTION_START)),(Fi()||ls())&&(c||l)&&r&&(S.info("ios".concat(u,"-interruption-end")),tt.emit(oi.IOS_INTERRUPTION_END)),e!==t&&(S.debug("AudioContext State Change","".concat(e,"=>").concat(t)),tt.emit(oi.STATE_CHANGE))},setInterval(()=>{var e;let t=(e=Gr)===null||e===void 0?void 0:e.currentTime;tt.currentTime!==t?(tt.currentTimeStuckAt&&(S.debug("AudioContext current time resume at ".concat(t)),tt.currentTimeStuckAt=void 0),tt.currentTime=t):(t!==tt.currentTimeStuckAt&&(Ee.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:t},tag:St.TRACER}).onSuccess(),S.warning("AudioContext current time stuck at ".concat(t))),tt.currentTimeStuckAt=t)},5e3),async function(e){let t=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"],r,n=!1,a=!1,c=!1;function l(O){e.state==="running"?u(!1):Fi()||ls()?e.state==="suspended"&&(u(!0),O&&e.resume().then(p,p)):e.state!=="closed"&&(u(!0),O&&e.resume().then(p,p))}function u(O){if(n!==O){n=O;for(let b=0,k=t;b<k.length;b+=1){let U=k[b];O?window.addEventListener(U,_,{capture:!0,passive:!0}):window.removeEventListener(U,_,{capture:!0,passive:!0})}}}function h(){l(!0)}function p(){l(!1)}function _(){l(!0)}function E(O){if(!c)if(r.paused)if(O){let b;T(!1),c=!0;try{b=r.play(),b?b.then(w,w):(r.addEventListener("playing",w),r.addEventListener("abort",w),r.addEventListener("error",w))}catch{w()}}else T(!0);else T(!1)}function T(O){if(a!==O){a=O;for(let b=0,k=t;b<k.length;b++){let U=k[b];O?window.addEventListener(U,C,{capture:!0,passive:!0}):window.removeEventListener(U,C,{capture:!0,passive:!0})}}}function w(){r.removeEventListener("playing",w),r.removeEventListener("abort",w),r.removeEventListener("error",w),c=!1,E(!1)}function C(){E(!0)}if(Fi()){let O=e.createMediaStreamDestination(),b=document.createElement("div");b.innerHTML="<audio x-webkit-airplay='deny'></audio>",r=b.children.item(0),r.controls=!1,r.disableRemotePlayback=!0,r.preload="auto",r.srcObject=O.stream,E(!0)}tt.on(oi.STATE_CHANGE,h),l(!1)}(Gr)}function qc(){if(!Gr){if(V5(),!Gr)throw new Y(A.NOT_SUPPORTED,"can not create audio context");return Gr}return Gr}function oO(){return!!Gr}function bo(i){if(function(){if(hg!==null)return hg;let r=qc(),n=r.createBufferSource(),a=r.createGain(),c=r.createGain();n.connect(a),n.connect(c),n.disconnect(a);let l=!1;try{n.disconnect(a)}catch{l=!0}return n.disconnect(),hg=l,l}())return;let e=i.connect,t=i.disconnect;i.connect=(r,n,a)=>{var c;return i._inputNodes||(i._inputNodes=[]),ge(c=i._inputNodes).call(c,r)||(r instanceof AudioNode?(i._inputNodes.push(r),e.call(i,r,n,a)):e.call(i,r,n)),i},i.disconnect=(r,n,a)=>{t.call(i),r?CE(i._inputNodes,r):i._inputNodes=[];for(let c of i._inputNodes)e.call(i,c)}}let hg=null;function pg(i,e){let t=!1,r=1/e;if(P("DISABLE_WEBAUDIO")){let n=window.setInterval(()=>{t?window.clearInterval(n):i(performance.now()/1e3)},1e3*r)}else{let n=qc(),a=n.createGain();a.gain.value=0,a.connect(n.destination);let c=()=>{if(t)return void(a=null);let l=n.createOscillator();l.onended=c,l.connect(a),l.start(0),l.stop(n.currentTime+r),i(n.currentTime)};c()}return()=>{t=!0}}let Mi={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1};function ct(){return Mi}class cO{constructor(){g(this,"context",void 0),g(this,"analyserNode",void 0),g(this,"sourceNode",void 0),this.context=qc(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e==null||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Fi()||ls()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;let e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{let r=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(r);for(let n=0;n<e.length;++n)e[n]=r[n]/128-1}let t=yo(e).call(e,(r,n)=>r+n*n,0)/e.length;return Math.max(10*Math.log10(t)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,t;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(t=this.sourceNode)===null||t===void 0||t.connect(this.analyserNode)}catch{S.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class lO extends mt{get processSourceNode(){return this.sourceNode}set processedNode(e){var t;if(!this.isDestroyed&&this._processedNode!==e){try{var r;(r=this.sourceNode)===null||r===void 0||r.disconnect(this.outputNode)}catch{}(t=this._processedNode)===null||t===void 0||t.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),g(this,"outputNode",void 0),g(this,"outputTrack",void 0),g(this,"isPlayed",!1),g(this,"context",void 0),g(this,"audioBufferNode",void 0),g(this,"destNode",void 0),g(this,"audioOutputLevel",0),g(this,"volumeLevelAnalyser",void 0),g(this,"_processedNode",void 0),g(this,"playNode",void 0),g(this,"isDestroyed",!1),g(this,"onNoAudioInput",void 0),g(this,"isNoAudioInput",!1),g(this,"_noAudioInputCount",0),this.context=qc(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),bo(this.outputNode),this.volumeLevelAnalyser=new cO}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=t=>{this.emit(hr.ON_AUDIO_BUFFER,function(r){for(let n=0;n<r.outputBuffer.numberOfChannels;n+=1){let a=r.outputBuffer.getChannelData(n);for(let c=0;c<a.length;c+=1)a[c]=0}return r.inputBuffer}(t))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!ct().webAudioMediaStreamDest)throw new Y(A.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&In(()=>{tt.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Fi()||ls()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();let t=this.volumeLevelAnalyser.getAnalyserNode(),r;t.getFloatTimeDomainData?(r=new Float32Array(t.fftSize),t.getFloatTimeDomainData(r)):(r=new Uint8Array(t.fftSize),t.getByteTimeDomainData(r));let n=!1;for(let a=0;a<r.length;a++)r[a]!==0&&(n=!0);return n?(this.isNoAudioInput=!1,!0):(await Si(200),await this.checkHasAudioInput(e?e+1:1)&&n)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,t;(e=this.processedNode)===null||e===void 0||e.disconnect(),(t=this.sourceNode)===null||t===void 0||t.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class fg extends lO{get isFreeze(){return!1}constructor(e,t,r){var n;if(super(),g(this,"sourceNode",void 0),g(this,"track",void 0),g(this,"clonedTrack",void 0),g(this,"audioElement",void 0),g(this,"isCurrentTrackCloned",!1),g(this,"isRemoteTrack",!1),g(this,"originVolumeLevelAnalyser",void 0),g(this,"rebuildWebAudio",async()=>{if(S.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void S.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>S.info("resume success")),S.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();let l=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?l.stop():this.isCurrentTrackCloned=!0;let u=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(u),bo(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();let h=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(h,this.context.currentTime),bo(this.outputNode),this.emit(hr.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=u,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),e.kind!=="audio")throw new Y(A.UNEXPECTED_ERROR);this.track=e;let a=new MediaStream([this.track]);if(this.isRemoteTrack=!!t,this.sourceNode=this.context.createMediaStreamSource(a),bo(this.sourceNode),r){let l=r.clone();l.enabled=!0,this.clonedTrack=l,S.debug("create an unmuted track ".concat(l.id," from the original track ").concat(r.id," to get the volume"));let u=this.context.createMediaStreamSource(new MediaStream([l]));bo(u),this.originVolumeLevelAnalyser=new cO,this.originVolumeLevelAnalyser.updateSource(u)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=a;let c=ze();t&&c.os===Jt.IOS&&Number((n=c.osVersion)===null||n===void 0?void 0:n.split(".")[0])<15&&(tt.on(oi.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(l=>{l||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;let t=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(t),bo(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(hr.UPDATE_SOURCE),this.audioElement.srcObject=t}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),tt.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){let t=e.clone();t.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=t),S.debug("create an unmuted track ".concat(t.id," from the original track ").concat(e.id," to get the volume"));let r=this.context.createMediaStreamSource(new MediaStream([t]));bo(r),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(r)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function dO(i,e,t){let r=(a,c)=>a?typeof a!="number"?a.max||a.exact||a.ideal||a.min||c:a:c,n={audio:!!t&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxHeight:r(e.height,1080),maxWidth:r(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(n.video.mandatory.maxFrameRate=e.frameRate.max,n.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(n.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(n)}async function F5(i,e){let t=await uO(i.mediaSource),{sourceId:r,audio:n}=await function(a){let c=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new F((l,u)=>{let h=document.createElement("div");h.innerText="share screen",h.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");let p=document.createElement("div");p.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");let _=document.createElement("div");_.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",_.setAttribute("style","height: 12%;");let E=document.createElement("div");E.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");let T=document.createElement("div");T.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");let w=document.createElement("button");w.innerHTML="cancel",w.setAttribute("style","width: 85px;"),w.onclick=()=>{document.body.removeChild(b);let k=new Error("NotAllowedError");k.name="NotAllowedError",u(k)};let C=c,O=document.createElement("div");if(c){let k=document.createElement("input");k.setAttribute("type","checkbox");let U=document.createElement("span");k.setAttribute("style","margin-right: 6px;"),U.innerText="Share audio",k.checked=C,k.onchange=()=>{C=k.checked},O.appendChild(k),O.appendChild(U)}T.appendChild(O),T.appendChild(w),p.appendChild(_),p.appendChild(E),p.appendChild(T);let b=document.createElement("div");b.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),b.appendChild(h),b.appendChild(p),document.body.appendChild(b),a.map(k=>{if(k.id){let U=document.createElement("div");U.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let X=k.thumbnail;try{let{width:z}=X.getSize();z>1920&&(X=X.resize({width:1920}))}catch(z){throw z&&z.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),z}U.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+X.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+k.name.replace(/[\u00A0-\u9999<>\&]/g,function(z){return"&#"+z.charCodeAt(0)+";"})+"</span>",U.onclick=()=>{document.body.removeChild(b),l({sourceId:k.id,audio:C})},E.appendChild(U)}})})}(t,e);return await dO(r,i,n)}async function uO(i){let e=["window","screen"];i!=="application"&&i!=="window"||(e=["window"]),i==="screen"&&(e=["screen"]);let t=Tw();if(!t)throw console.error("failed to fetch electron, please mount it to window"),new Y(A.ELECTRON_IS_NULL);let r=null;try{var n;r=((n=t.desktopCapturer)===null||n===void 0?void 0:n.getSources({types:e}))||t.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{r=null}r&&r.then||(r=new F((a,c)=>{t.desktopCapturer.getSources({types:e},(l,u)=>{l?c(l):a(u)})}));try{return await r}catch(a){throw new Y(A.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,a.toString())}}function hO(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}let _g=new si("safari"),pO=!1,fO=!1;async function Wr(i,e){let t=0,r=null;for(;t<2;)try{r=await j5(i,e,t>0);break}catch(n){if(n instanceof Y)throw S.error("[".concat(e,"] ").concat(n.toString())),n;let a=cp(n.name||n.code||n,n.message);if(a.code===A.MEDIA_OPTION_INVALID){S.debug("[".concat(e,"] detect media option invalid, retry")),t+=1,await Si(500);continue}throw S.error("[".concat(e,"] ").concat(a.toString())),a}if(!r)throw new Y(A.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return r}async function j5(i,e,t){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Y(A.NOT_SUPPORTED,"can not find getUserMedia");t&&(i.video&&(delete i.video.width,delete i.video.height),i.screen&&(delete i.screen.width,delete i.screen.height));let r=ct(),n=new MediaStream;if(i.audioSource&&n.addTrack(i.audioSource),i.videoSource&&n.addTrack(i.videoSource),!i.audio&&!i.video&&!i.screen)return S.debug("Using Video Source/ Audio Source"),n;if(i.screen)if(Tw())i.screen.sourceId?Jc(n,await dO(i.screen.sourceId,i.screen,i.screenAudio)):Jc(n,await F5(i.screen,i.screenAudio));else if(EE()&&i.screen.extensionId&&i.screen.mandatory){if(!r.getStreamFromExtension)throw new Y(A.NOT_SUPPORTED,"This browser does not support screen sharing");S.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));let E=await(c=i.screen.extensionId,l=e,new F((T,w)=>{try{chrome.runtime.sendMessage(c,{getStream:!0},C=>{if(!C||!C.streamId)return S.error("[".concat(l,"] No response from Chrome Plugin. Plugin not installed properly"),C),void w(new Y(A.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));T(C.streamId)})}catch(C){S.error("[".concat(l,"] AgoraRTC screensharing plugin is not accessible(").concat(c,")"),C.toString()),w(new Y(A.CHROME_PLUGIN_NOT_INSTALL))}}));i.screen.mandatory.chromeMediaSourceId=E,Jc(n,await navigator.mediaDevices.getUserMedia({video:{mandatory:i.screen.mandatory}}))}else if(r.getDisplayMedia){var a;i.screen.mediaSource&&tO(i.screen.mediaSource);let E={width:i.screen.width,height:i.screen.height,frameRate:i.screen.frameRate,displaySurface:(a=i.screen.displaySurface)!==null&&a!==void 0?a:i.screen.mediaSource==="screen"?"monitor":i.screen.mediaSource},{selfBrowserSurface:T,surfaceSwitching:w,systemAudio:C}=i.screen,O={selfBrowserSurface:T,surfaceSwitching:w,systemAudio:C};!T&&delete O.selfBrowserSurface,!w&&delete O.surfaceSwitching,!C&&delete O.systemAudio,S.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:E,audio:!!i.screenAudio,controls:O}));let b=await navigator.mediaDevices.getDisplayMedia(function(k){for(var U=1;U<arguments.length;U++){var X=arguments[U]!=null?arguments[U]:{};U%2?hO(Object(X),!0).forEach(function(z){g(k,z,X[z])}):Object.getOwnPropertyDescriptors?Object.defineProperties(k,Object.getOwnPropertyDescriptors(X)):hO(Object(X)).forEach(function(z){Object.defineProperty(k,z,Object.getOwnPropertyDescriptor(X,z))})}return k}({video:E,audio:!!i.screenAudio},O));Jc(n,b)}else{if(!ht())throw S.error("[".concat(e,"] This browser does not support screenSharing")),new Y(A.NOT_SUPPORTED,"This browser does not support screen sharing");{i.screen.mediaSource&&tO(i.screen.mediaSource);let E={video:{mediaSource:i.screen.mediaSource,width:i.screen.width,height:i.screen.height,frameRate:i.screen.frameRate}};S.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(E))),Jc(n,await navigator.mediaDevices.getUserMedia(E))}}var c,l;if(!i.video&&!i.audio)return n;let u={video:i.video,audio:i.audio},h=P("MEDIA_DEVICE_CONSTRAINTS");if(h)try{typeof h=="string"&&(h=JSON.parse(h)),u=IE(u,h)}catch{}S.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(u)),ze();let p,_=null;(Vi()||Fi()||Lh())&&(_=await _g.lock());try{p=await navigator.mediaDevices.getUserMedia(u)}catch(E){throw _&&_(),E}return u.audio&&(pO=!0),u.video&&(fO=!0),Jc(n,p),_&&_(),n}function cp(i,e){switch(i){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new Y(A.MEDIA_OPTION_INVALID,"".concat(i,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new Y(A.DEVICE_NOT_FOUND,"".concat(i,": ").concat(e));case"NotSupportedError":return new Y(A.NOT_SUPPORTED,"".concat(i,": ").concat(e));case"NotReadableError":return new Y(A.NOT_READABLE,"".concat(i,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new Y(A.PERMISSION_DENIED,"".concat(i,": ").concat(e));case"ConstraintNotSatisfiedError":return new Y(A.CONSTRAINT_NOT_SATISFIED,"".concat(i,": ").concat(e));default:return S.error("getUserMedia unexpected error",i),new Y(A.UNEXPECTED_ERROR,"".concat(i,": ").concat(e))}}function Jc(i,e){let t=i.getVideoTracks()[0],r=i.getAudioTracks()[0],n=e.getVideoTracks()[0],a=e.getAudioTracks()[0];a&&(r&&i.removeTrack(r),i.addTrack(a)),n&&(t&&i.removeTrack(t),i.addTrack(n))}let Hr=new class extends mt{get state(){return this._state}set state(i){i!==this._state&&(this.emit(Us.STATE_CHANGE,i),this._state=i)}constructor(){super(),g(this,"_state",No.IDLE),g(this,"isAccessMicrophonePermission",!1),g(this,"isAccessCameraPermission",!1),g(this,"lastAccessMicrophonePermission",!1),g(this,"lastAccessCameraPermission",!1),g(this,"checkdeviceMatched",!1),g(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(P("ENUMERATE_DEVICES_INTERVAL")||(Mh()||kh()===Jt.HARMONY_OS)&&la())&&this.updateDevicesInfo()},P("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(i=>S.error(i.toString()))}async enumerateDevices(i,e){let t=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new Y(A.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();let r=await navigator.mediaDevices.enumerateDevices(),n=this.checkMediaDeviceInfoIsOk(r),a=!this.isAccessMicrophonePermission&&i,c=!this.isAccessCameraPermission&&e;n.audio&&(a=!1),n.video&&(c=!1);let l=null,u=null,h=null;if(!t&&(a||c)){if(_g.isLocked&&(S.debug("[device manager] wait GUM lock"),(await _g.lock())(),S.debug("[device manager] GUM unlock")),pO&&(a=!1,this.isAccessMicrophonePermission=!0),fO&&(c=!1,this.isAccessCameraPermission=!0),S.debug("[device manager] check media device permissions",i,e,a,c),a&&c){try{h=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(p){let _=cp(p.name||p.code||p,p.message);if(_.code===A.PERMISSION_DENIED)throw _;S.warning("getUserMedia failed in getDevices",_)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(a){try{l=await navigator.mediaDevices.getUserMedia({audio:i})}catch(p){let _=cp(p.name||p.code||p,p.message);if(_.code===A.PERMISSION_DENIED)throw _;S.warning("getUserMedia failed in getDevices",_)}this.isAccessMicrophonePermission=!0}else if(c){try{u=await navigator.mediaDevices.getUserMedia({video:e})}catch(p){let _=cp(p.name||p.code||p,p.message);if(_.code===A.PERMISSION_DENIED)throw _;S.warning("getUserMedia failed in getDevices",_)}this.isAccessCameraPermission=!0}S.debug("[device manager] mic permission",i,"cam permission",e)}try{let p=await navigator.mediaDevices.enumerateDevices();return l&&l.getTracks().forEach(_=>_.stop()),u&&u.getTracks().forEach(_=>_.stop()),h&&h.getTracks().forEach(_=>_.stop()),l=null,u=null,h=null,p}catch(p){return l&&l.getTracks().forEach(_=>_.stop()),u&&u.getTracks().forEach(_=>_.stop()),h&&h.getTracks().forEach(_=>_.stop()),l=null,u=null,h=null,new Y(A.ENUMERATE_DEVICES_FAILED,p.toString()).throw()}}async getRecordingDevices(){let i=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,i)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let i=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,i)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let i=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,i)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(i){let e=null;return this.deviceInfoMap.forEach(t=>{t.device.label===i&&(e=t.device.deviceId)}),e}async getDeviceById(i){let e=(await this.enumerateDevices(!0,!0,!0)).find(t=>t.deviceId===i);if(!e)throw new Y(A.DEVICE_NOT_FOUND,"deviceId: ".concat(i));return e}async init(){this.state=No.INITING;try{await this.updateDevicesInfo(),this.state=No.INITEND}catch(i){throw S.warning("Device Detection functionality cannot start properly.",i.toString()),this.state=No.IDLE,!(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")&&new Y(A.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),i}}async updateDevicesInfo(){let i=await this.enumerateDevices(!0,!0,!0),e=Date.now(),t=[];if(i[0]&&i[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;let n=i.find(c=>c.kind==="audioinput"&&c.deviceId==="default"),a=i.find(c=>c.kind==="audiooutput"&&c.deviceId==="default");n&&a?a.groupId===n.groupId?S.debug("[device-check] default input ".concat(n.label," and output ").concat(a.label," is the same group")):S.warning("[device-check] default input ".concat(n.label," and output ").concat(a.label," is not the same group")):S.debug("[device-check] default input or output not found")}let r=this.checkMediaDeviceInfoIsOk(i);if(i.forEach(n=>{if(!n.deviceId)return;let a=this.deviceInfoMap.get("".concat(n.kind,"_").concat(n.deviceId));if((a?a.state:"INACTIVE")!=="ACTIVE"){let c={initAt:e,updateAt:e,device:n,state:"ACTIVE"};this.deviceInfoMap.set("".concat(n.kind,"_").concat(n.deviceId),c),t.push(c)}a&&(a.updateAt=e)}),this.deviceInfoMap.forEach((n,a)=>{n.state==="ACTIVE"&&n.updateAt!==e&&(n.state="INACTIVE",t.push(n))}),this.state!==No.INITEND)return r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));t.forEach(n=>{switch(n.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Us.RECORDING_DEVICE_CHANGED,n);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Us.CAMERA_DEVICE_CHANGED,n);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Us.PLAYOUT_DEVICE_CHANGED,n)}}),r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(i){let e=i.filter(n=>n.kind==="audioinput"),t=i.filter(n=>n.kind==="videoinput"),r={audio:!1,video:!1};for(let n of e)if(n.label&&n.deviceId){r.audio=!0;break}for(let n of t)if(n.label&&n.deviceId){r.video=!0;break}return r}},mg=!1,Kr=new class extends mt{constructor(){super(...arguments),g(this,"onAutoplayFailed",void 0),g(this,"onAudioAutoplayFailed",void 0)}};function _O(){if(ze(),!mg){let i=e=>{e.preventDefault(),mg=!1,ud()?document.body.removeEventListener("click",i,!0):(document.body.removeEventListener("touchstart",i,!0),document.body.removeEventListener("mousedown",i,!0))};mg=!0,ud()?document.body.addEventListener("click",i,!0):(document.body.addEventListener("touchstart",i,!0),document.body.addEventListener("mousedown",i,!0)),S.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Kr.onAutoplayFailed?Kr.onAutoplayFailed():Kr.onAudioAutoplayFailed?S.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):S.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Kr.emit("autoplay-failed")}}function mO(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function EO(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?mO(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):mO(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function gO(i,e,t,r){if(!i)return;let n=Ee.getBaseInfoBySessionId(i);if(!n)return;let a=n.info,c=Date.now(),l=EO(EO({},a),{},{vid:a.vid===void 0?0:Number(a.vid),lts:c,elapse:c-n.startTime,cbRegistered:Kr.onAutoplayFailed||Kr.onAudioAutoplayFailed?1:-1,errorMsg:t,mediaType:e,trackId:r,extend:void 0});Ee.send({type:Et.AUTOPLAY_FAILED,data:l},!0)}let B5=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Cr=new class{constructor(){g(this,"onAutoplayFailed",void 0),g(this,"elementMap",new Map),g(this,"elementStateMap",new Map),g(this,"elementsNeedToResume",[]),g(this,"sinkIdMap",new Map),g(this,"autoResumeAfterInterruption",()=>{Array.from(this.elementMap.entries()).forEach(i=>{let[e,t]=i,r=this.elementStateMap.get(e),n=t.srcObject.getAudioTracks()[0];Pc()?n&&n.readyState==="live"&&tt.curState==="running"&&(S.debug("auto resume after interruption for iOS 15"),t.pause(),t.play()):r&&r==="paused"&&n&&n.readyState==="live"&&tt.curState==="running"&&(S.debug("auto resume after interruption for iOS"),t.play())})}),g(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(i=>{let[e,t]=i,r=t.srcObject.getAudioTracks()[0];r&&r.readyState==="live"&&(S.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),t.pause(),t.play())})}),this.autoResumeAudioElement(),tt.on(oi.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),tt.on(oi.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),tt.on(oi.STATE_CHANGE,()=>{Fi()&&tt.prevState==="suspended"&&tt.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(i,e){let t=this.elementMap.get(i);if(this.sinkIdMap.set(i,e),t)try{await t.setSinkId(e)}catch(r){throw new Y(A.PERMISSION_DENIED,"can not set sink id: "+r.toString())}}play(i,e,t,r){if(this.elementMap.has(e))return;let n=document.createElement("audio");n.autoplay=!0,n.srcObject=new MediaStream([i]),this.bindAudioElementEvents(e,n),this.elementMap.set(e,n),this.elementStateMap.set(e,Li.INIT),this.setVolume(e,t);let a=this.sinkIdMap.get(e);if(a)try{n.setSinkId(a).catch(l=>{S.warning("[".concat(e,"] set sink id failed"),l.toString())})}catch(l){S.warning("[".concat(e,"] set sink id failed"),l.toString())}let c=n.play();c&&c.then&&c.catch(l=>{r&&gO(r,"audio",l.message,e),S.warning("audio element play warning",l.toString()),this.elementMap.has(e)&&l.name==="NotAllowedError"&&(S.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(n),In(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),_O()}))})}updateTrack(i,e){let t=this.elementMap.get(i);t&&(t.srcObject=new MediaStream([e]))}isPlaying(i){return this.elementMap.has(i)&&this.elementStateMap.get(i)==="playing"}setVolume(i,e){let t=this.elementMap.get(i);t&&(e=Math.max(0,Math.min(100,e)),t.volume=e/100)}stop(i){let e=this.elementMap.get(i);if(this.sinkIdMap.delete(i),!e)return;let t=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(t,1),e.srcObject=null,e.remove(),this.elementMap.delete(i),this.elementStateMap.delete(i)}bindAudioElementEvents(i,e){B5.forEach(t=>{e.addEventListener(t,r=>{let n=this.elementStateMap.get(i),a=r.type==="pause"?"paused":r.type;if(S.debug("[".concat(i,"] audio-element-status change ").concat(n," => ").concat(a)),r.type==="error"){let c=e==null?void 0:e.error;c&&S.error("[".concat(i,"] media error, code: ").concat(c.code,", message: ").concat(c.message))}this.elementStateMap.set(i,a)})})}getPlayerState(i){return this.elementStateMap.get(i)||"uninit"}autoResumeAudioElement(){let i=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(t=>{S.debug("Auto resume audio element success")}).catch(t=>{S.warning("Auto resume audio element failed!",t)})}),this.elementsNeedToResume=[]};new F(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{ud()?document.body.addEventListener("click",i,!0):(document.body.addEventListener("touchstart",i,!0),document.body.addEventListener("mousedown",i,!0))})}};function Nt(){return function(i,e,t){let r=t.value;return typeof r=="function"&&(t.value=function(){this._isClosed&&new Y(A.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",S);for(var n=arguments.length,a=new Array(n),c=0;c<n;c++)a[c]=arguments[c];let l=r.apply(this,a);return l instanceof F?new F((u,h)=>{l.then(u).catch(h)}):l}),t}}function SO(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function lp(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?SO(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):SO(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class TO extends mt{constructor(e){super(),g(this,"name","VideoProcessorDestination"),g(this,"ID","0"),g(this,"_source",void 0),g(this,"videoContext",void 0),g(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new Y(A.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new Y(A.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(ki.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(ki.ON_TRACK,void 0)}}class vO extends mt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t){super(),g(this,"constraintsMap",new Map),g(this,"statsRegistry",[]),g(this,"usageRegistry",[]),g(this,"trackId",void 0),g(this,"direction",void 0),g(this,"_chained",!1),this.trackId=e,this.direction=t}async getConstraints(){return await vt(this,pr.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,t){var r;return S.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),st(this,pr.REQUEST_UPDATE_CONSTRAINTS,Array.from(us(r=this.constraintsMap).call(r)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return S.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),st(this,pr.REQUEST_UPDATE_CONSTRAINTS,Array.from(us(t=this.constraintsMap).call(t)))}registerStats(e,t,r){this.statsRegistry.find(n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:r})}unregisterStats(e,t){let r=this.statsRegistry.findIndex(n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){let e=[];for(let{processorID:t,processorName:r,type:n,cb:a}of this.statsRegistry)try{let c=a();e.push({processorID:t,processorName:r,type:n,stats:c})}catch(c){S.error(new Y(A.UNEXPECTED_ERROR,c.message))}return e}registerUsage(e,t){this.usageRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){let t=this.usageRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name);t!==-1&&this.usageRegistry.splice(t,1)}async gatherUsage(){let e=[];if(!this.chained)return[];for(let{cb:t}of this.usageRegistry)try{let r=t();r instanceof F&&(r=await r),e.push(lp(lp({},r),{},{direction:this.direction}))}catch(r){S.error("gather extension usage error",r)}return e}getDirection(){return this.direction}}class dp extends mt{constructor(e){super(),g(this,"name","AudioProcessorDestination"),g(this,"ID","0"),g(this,"inputTrack",void 0),g(this,"inputNode",void 0),g(this,"audioProcessorContext",void 0),g(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new Y(A.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new Y(A.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(ki.ON_TRACK,void 0),this.emit(ki.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(ki.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(ki.ON_NODE,this.inputNode))}}class up extends mt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t,r){super(),g(this,"constraintsMap",new Map),g(this,"statsRegistry",[]),g(this,"audioContext",void 0),g(this,"trackId",void 0),g(this,"direction",void 0),g(this,"usageRegistry",[]),g(this,"_chained",!1),this.audioContext=e,this.trackId=t,this.direction=r}async getConstraints(){return vt(this,pr.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,t){var r;return S.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),st(this,pr.REQUEST_UPDATE_CONSTRAINTS,Array.from(us(r=this.constraintsMap).call(r)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),st(this,pr.REQUEST_UPDATE_CONSTRAINTS,Array.from(us(t=this.constraintsMap).call(t)))}registerStats(e,t,r){this.statsRegistry.find(n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:r})}unregisterStats(e,t){let r=this.statsRegistry.findIndex(n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){let e=[];for(let{processorID:t,processorName:r,type:n,cb:a}of this.statsRegistry)try{let c=a();e.push({processorID:t,processorName:r,type:n,stats:c})}catch(c){S.error(new Y(A.UNEXPECTED_ERROR,c.message))}return e}registerUsage(e,t){this.usageRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){let t=this.usageRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name);t!==-1&&this.usageRegistry.splice(t,1)}async gatherUsage(){let e=[];if(!this.chained)return[];for(let{cb:t}of this.usageRegistry)try{let r=t();r instanceof F&&(r=await r),e.push(lp(lp({},r),{},{direction:this.direction}))}catch(r){S.error("gather extension usage error",r)}return e}getDirection(){return this.direction}}class Eg extends mt{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),g(this,"context",void 0),g(this,"processSourceNode",void 0),g(this,"outputTrack",void 0),g(this,"processedNode",void 0),g(this,"clonedTrack",void 0),g(this,"outputNode",void 0),this.outputNode=new G5}setVolume(){}createOutputTrack(){throw new Y(A.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class G5{disconnect(){}connect(){}}let Xc=null;class W5{constructor(){g(this,"state","open"),g(this,"trigger",void 0),g(this,"tasks",[]),S.debug("[macro-task-queue] is created."),this.trigger=window.setTimeout(()=>{this.state="closed",S.debug("[macro-task-queue] will be closed, all remaining tasks will execute. [".concat(this.tasks.map(e=>e.key),"]")),this.trigger=void 0,this.tasks.forEach(e=>{let{func:t}=e;return t()}),this.tasks.length=0,S.debug("[macro-task-queue] is closed.")})}enqueue(e,t){this.state!=="closed"&&(this.tasks.push({key:e,func:t}),S.debug("[macro-task-queue] is queued, current queue ".concat(this.tasks.length,". ").concat(typeof e=="string"?e:"")))}runTask(e){if(this.state==="closed")return;let t=this.tasks.findIndex(r=>r.key===e);if(t!==-1){let r=this.tasks.splice(t,1);S.debug("[macro-task-queue] is unqueued, current queue ".concat(this.tasks.length,". ").concat(typeof e=="string"?e:"")),r[0].func()}}release(){this.trigger&&(this.state="closed",clearTimeout(this.trigger),this.trigger=void 0,this.tasks.length=0,S.debug("[macro-task-queue] is closed."))}}function gg(i){return function(e,t,r){var n;let a=(n=r.value)!==null&&n!==void 0?n:r.get,c=function(){Xc&&Xc.state==="open"&&Xc.runTask(i);for(var l=arguments.length,u=new Array(l),h=0;h<l;h++)u[h]=arguments[h];return a==null?void 0:a.apply(this,...u)};return r.value?r.value=c:r.get=c,r}}function yO(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Sg(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?yO(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):yO(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class Qe extends Ri{get _source(){return this._trackSource}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get processorDestination(){return this._processorDestination}set processorDestination(e){this._processorDestination=e}get isPlaying(){return this._useAudioElement?Cr.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,r,n,a){super(e,r),g(this,"trackMediaType","audio"),g(this,"_encoderConfig",void 0),g(this,"_trackSource",void 0),g(this,"_enabled",!0),g(this,"_volume",100),g(this,"_useAudioElement",!1),g(this,"_bypassWebAudio",!1),g(this,"processor",void 0),g(this,"_processorContext",void 0),g(this,"_processorDestination",void 0),g(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!n;let c=()=>{this.processorContext=new up(this._source.context,this.getTrackId(),"local"),this.processorDestination=new dp(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(hr.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})},l=a&&Vi()&&!oO();P("DISABLE_WEBAUDIO")?(this._source=new Eg,this._useAudioElement=!0,this._bypassWebAudio=!0):l?this._source=new Eg:(this._source=new fg(e,!1,this._getOriginVolumeLevel?e:void 0),P("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0)),c(),!P("DISABLE_WEBAUDIO")&&l&&(Xc||(Xc=new W5),Xc).enqueue("INIT_WEBAUDIO",()=>{this._source=new fg(e,!1,this._getOriginVolumeLevel?e:void 0),P("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0),c(),this.emit(op.UPDATE_TRACK_SOURCE)})}setVolume(e){nt(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&Cr.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void S.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));let t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,st(this,ue.NEED_REPLACE_TRACK,this).then(()=>{S.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(r=>{S.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),r)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement)throw new Y(A.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Cr.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,r){return this._setEnabled(e,t,r)}async _setEnabled(e,t,r){if(!r){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{r||(this._enabled=!0),await st(this,ue.NEED_ENABLE_TRACK,this),S.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(n){throw r||(this._enabled=!1),S.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}}else{this._originMediaStreamTrack.enabled=!1,r||(this._enabled=!1);try{await st(this,ue.NEED_DISABLE_TRACK,this)}catch(n){throw r||(this._enabled=!0),S.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,S.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await st(this,ue.NEED_MUTE_TRACK,this):await st(this,ue.NEED_UNMUTE_TRACK,this))}getStats(){return pd(()=>{S.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),cr(this,ue.GET_STATS)||Sg({},lg)}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(hr.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(hr.ON_AUDIO_BUFFER),this._source.on(hr.ON_AUDIO_BUFFER,r=>e(r))}play(){S.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(S.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Cr.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){S.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Cr.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];S.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Cr.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this.processor.updateInput({track:e,context:this.processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await st(this,ue.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return F.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new Y(A.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new Y(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;let t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ki.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await st(this,ue.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await st(this,ue.NEED_REPLACE_TRACK,this))}),this.processorDestination.on(ki.ON_NODE,e=>{this._source.processedNode=e})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ki.ON_TRACK),this.processorDestination.removeAllListeners(ki.ON_NODE)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(pr.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(pr.REQUEST_CONSTRAINTS)}}J([gg("INIT_WEBAUDIO"),R("design:type",Object),R("design:paramtypes",[Object])],Qe.prototype,"_source",null),J([gg("INIT_WEBAUDIO"),R("design:type",up),R("design:paramtypes",[up])],Qe.prototype,"processorContext",null),J([gg("INIT_WEBAUDIO"),R("design:type",dp),R("design:paramtypes",[dp])],Qe.prototype,"processorDestination",null),J([Ce({argsMap:(i,e)=>[i.getTrackId(),e],throttleTime:300}),R("design:type",Function),R("design:paramtypes",[Number]),R("design:returntype",void 0)],Qe.prototype,"setVolume",null),J([Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Qe.prototype,"setPlaybackDevice",null),J([Uc("LocalAudioTrack","_enabledMutex"),Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[Boolean,Object,Boolean]),R("design:returntype",F)],Qe.prototype,"setEnabled",null),J([Uc("LocalAudioTrack","_enabledMutex"),Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[Boolean]),R("design:returntype",F)],Qe.prototype,"setMuted",null),J([Nt(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",Object)],Qe.prototype,"getStats",null),J([Nt(),R("design:type",Function),R("design:paramtypes",[Object,Number]),R("design:returntype",void 0)],Qe.prototype,"setAudioFrameCallback",null),J([Ce({argsMap:i=>[i.getTrackId()]}),Nt(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Qe.prototype,"play",null),J([Ce({argsMap:i=>[i.getTrackId()]}),Nt(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Qe.prototype,"stop",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Qe.prototype,"close",null),J([Ce({argsMap:(i,e)=>[i.getTrackId(),e.name]}),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",Object)],Qe.prototype,"pipe",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Qe.prototype,"unpipe",null);class ga extends Qe{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,r,n){super(e,t.encoderConfig?sp(t.encoderConfig):{},n,P("GET_VOLUME_OF_MUTED_AUDIO_TRACK"),!0),g(this,"_config",void 0),g(this,"_deviceName","default"),g(this,"_constraints",void 0),g(this,"_originalConstraints",void 0),g(this,"_enabled",!0),this._config=t,this._constraints=r,this._originalConstraints=r,this._deviceName=e.label,typeof t.bypassWebAudio=="boolean"&&(this._bypassWebAudio=t.bypassWebAudio),(Pc()||SE())&&tt.bindInterruptDetectorTrack(this),this.on(op.UPDATE_TRACK_SOURCE,()=>{this.bindProcessorContextEvents()}),oO()&&this.bindProcessorContextEvents()}async setDevice(e){if(S.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{let t=await Hr.getDeviceById(e),r={};r.audio=Sg({},this._constraints),r.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let n=null;try{n=await Wr(r,this.getTrackId())}catch(a){throw S.error("[".concat(this.getTrackId(),"] setDevice failed"),a.toString()),n=await Wr({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),a}await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{let t=await Hr.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}S.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,r){if(t)return S.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!r){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){var n;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(n=this._source.clonedTrack)===null||n===void 0||n.stop(),r||(this._enabled=!1);try{await st(this,ue.NEED_DISABLE_TRACK,this)}catch(l){throw S.error("[".concat(this.getTrackId(),"] setEnabled false failed"),l.toString()),l}return}let a=Sg({},this._constraints),c=Hr.searchDeviceIdByName(this._deviceName);c&&!a.deviceId&&(a.deviceId=c);try{r||(this._enabled=!0);let l=await Wr({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(l.getAudioTracks()[0],!1),await st(this,ue.NEED_ENABLE_TRACK,this)}catch(l){throw r||(this._enabled=!1),S.error("[".concat(this.getTrackId(),"] setEnabled true failed"),l.toString()),l}S.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Pc()||SE())&&tt.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((Fi()||ls())&&this._enabled&&!this._isClosed&&tt.duringInterruption){let e=async()=>{tt.off(oi.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(S.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};tt.on(oi.IOS_INTERRUPTION_END,e)}else S.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Ea.TRACK_ENDED)}async renewMediaStreamTrack(e){let t=e||this._constraints,r=Hr.searchDeviceIdByName(this._deviceName);if(r&&!t.deviceId&&(t.deviceId=r),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();let n=await Wr({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!0)}}bindProcessorContextEvents(){this.processorContext.on(pr.REQUEST_UPDATE_CONSTRAINTS,async(e,t,r)=>{try{let n=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(n),t()}catch(n){r(n)}}),this.processorContext.on(pr.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}}J([Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],ga.prototype,"setDevice",null),J([Uc("MicrophoneAudioTrack","_enabledMutex"),Ce({argsMap:(i,e,t)=>[i.getTrackId(),e,t]}),Nt(),R("design:type",Function),R("design:paramtypes",[Boolean,Boolean,Boolean]),R("design:returntype",F)],ga.prototype,"setEnabled",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],ga.prototype,"close",null);class Sa extends Qe{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,r,n){super(t.createOutputTrack(),r,n),g(this,"source",void 0),g(this,"_bufferSource",void 0),this.source=e,this._bufferSource=t,this._bufferSource.on(hr.AUDIO_SOURCE_STATE_CHANGE,a=>{this.safeEmit(Ea.SOURCE_STATE_CHANGE,a)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){nt(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}J([Ce({argsMap:(i,e)=>[i.getTrackId(),e,i.duration]}),Nt(),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",void 0)],Sa.prototype,"startProcessAudioBuffer",null),J([Ce({argsMap:i=>[i.getTrackId()]}),Nt(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Sa.prototype,"pauseProcessAudioBuffer",null),J([Ce({argsMap:i=>[i.getTrackId()]}),Nt(),R("design:type",Function),R("design:paramtypes",[Number]),R("design:returntype",void 0)],Sa.prototype,"seekAudioBuffer",null),J([Ce({argsMap:i=>[i.getTrackId()]}),Nt(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Sa.prototype,"resumeProcessAudioBuffer",null),J([Ce({argsMap:i=>[i.getTrackId()]}),Nt(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Sa.prototype,"stopProcessAudioBuffer",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Sa.prototype,"close",null),J([Ce({argsMap:i=>[i.getTrackId()]}),Nt(),R("design:type",Function),R("design:paramtypes",[Number]),R("design:returntype",void 0)],Sa.prototype,"setAudioBufferPlaybackSpeed",null);class Vt extends Qe{get __className__(){return"MixingAudioTrack"}get isActive(){for(let e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){let e=qc().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,at(8,"track-mix-")),g(this,"trackList",void 0),g(this,"destNode",void 0);try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(S.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):S.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){S.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}CE(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){let e={};this.trackList.forEach(t=>{t._encoderConfig&&((t._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=t._encoderConfig.bitrate),(t._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=t._encoderConfig.sampleRate),(t._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=t._encoderConfig.sampleSize),t._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(t=>{t instanceof Vt?t.emit(zc.TRANSCEIVER_UPDATED,e):t._updateRtpTransceiver(e)}))}}function hp(i){let e={};i.facingMode&&(e.facingMode=i.facingMode),i.cameraId&&(e.deviceId={exact:i.cameraId});let t=fs(i.encoderConfig);return t.width!=null&&(e.width=t.width),t.height!=null&&(e.height=t.height),!fw()&&t.frameRate&&(e.frameRate=t.frameRate),ze().name===Xe.EDGE&&typeof e.frameRate=="object"&&(e.frameRate.max=60),ht()&&(e.frameRate={ideal:30,max:30}),e}function CO(i){let e={};if(fw()||(i.AGC!==void 0&&(e.autoGainControl=i.AGC),i.AEC!==void 0&&(e.echoCancellation=i.AEC),i.ANS!==void 0&&(e.noiseSuppression=i.ANS,EE()&&i.ANS&&(e.googHighpassFilter=i.ANS))),i.encoderConfig){let t=sp(i.encoderConfig);e.channelCount=t.stereo?2:1,e.sampleRate=t.sampleRate,e.sampleSize=t.sampleSize}return i.microphoneId&&(e.deviceId={exact:i.microphoneId}),Mh()&&(e.sampleRate=void 0),e}class H5 extends lO{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(hr.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),g(this,"audioBuffer",void 0),g(this,"sourceNode",void 0),g(this,"startPlayTime",0),g(this,"startPlayOffset",0),g(this,"pausePlayTime",0),g(this,"options",void 0),g(this,"currentLoopCount",0),g(this,"currentPlaybackSpeed",100),g(this,"_currentState","stopped"),this.audioBuffer=e,this.options=t,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):S.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){let e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}let RO=new Map;async function K5(i,e){let t=null;if(typeof i=="string"){let n=RO.get(i);if(n)return S.debug("use cached audio resource: ",i),n;try{t=(await Kn(()=>lr.get(i,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(a){throw new Y(A.FETCH_AUDIO_FILE_FAILED,a.toString())}}else t=await new F((n,a)=>{let c=new FileReader;c.onload=l=>{l.target?n(l.target.result):a(new Y(A.READ_LOCAL_AUDIO_FILE_ERROR))},c.onerror=()=>{a(new Y(A.READ_LOCAL_AUDIO_FILE_ERROR))},c.readAsArrayBuffer(i)});let r=await function(n){let a=qc();return new F((c,l)=>{a.decodeAudioData(n,u=>{c(u)},u=>{l(new Y(A.DECODE_AUDIO_FILE_FAILED,u.toString()))})})}(t);return typeof i=="string"&&e&&RO.set(i,r),r}let Tg=i=>{let e=document.createElement("canvas");return e.width=2,e.height=2,new F((t,r)=>{e.toBlob(async n=>{if(e.remove(),n){let a=await IO(n);t({buffer:a,width:e.width,height:e.height})}else r(new Y(A.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},i,1)})},IO=async i=>{let e=await i.arrayBuffer();return new Uint8Array(e)},xs=new class extends mt{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),g(this,"_lastHiddenTime",0),g(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),S.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};function wO(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function AO(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?wO(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):wO(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class vg{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(S.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}constructor(e){g(this,"trackId",void 0),g(this,"config",void 0),g(this,"onFirstVideoFrameDecoded",void 0),g(this,"freezeTimeCounterList",[]),g(this,"renderFreezeAccTime",0),g(this,"isKeepLastFrame",!1),g(this,"timeUpdatedCount",0),g(this,"freezeTime",0),g(this,"playbackTime",0),g(this,"lastTimeUpdatedTime",0),g(this,"autoplayFailed",!1),g(this,"videoTrack",void 0),g(this,"videoElement",void 0),g(this,"cacheVideoElement",void 0),g(this,"videoElementCheckInterval",void 0),g(this,"_videoElementStatus",Li.NONE),g(this,"isGettingVideoDimensions",!1),g(this,"startGetVideoDimensions",()=>{let t=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return S.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(t,500)};!this.isGettingVideoDimensions&&t()}),g(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&tt.curState==="running"&&(S.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(ow())),hw()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),g(this,"handleVideoEvents",t=>{switch(t.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=Li.PLAYING;break;case"loadeddata":if(this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Li.CANPLAY;break;case"stalled":this.videoElementStatus=Li.STALLED;break;case"suspend":this.videoElementStatus=Li.SUSPEND;break;case"pause":this.videoElementStatus=Li.PAUSED,Fi()||ls()||Vi()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(S.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Li.WAITING;break;case"abort":this.videoElementStatus=Li.ABORT;break;case"ended":this.videoElementStatus=Li.ENDED;break;case"emptied":this.videoElementStatus=Li.EMPTIED;break;case"error":{this.videoElementStatus=Li.ERROR;let r=this.videoElement.error;r&&S.error("[".concat(this.trackId,"] media error, code: ").concat(r.code,", message: ").concat(r.message));break}case"timeupdate":{let r=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=r);let n=r-this.lastTimeUpdatedTime,a=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=r,xs.lastVisibleTime<xs.lastHiddenTime||a<xs.lastHiddenTime||a<xs.lastVisibleTime)return;for(n>P("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=n),this.playbackTime+=n;this.playbackTime>=6e3;){this.playbackTime-=6e3;let c=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(c),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),g(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(S.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(ow())),hw()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),tt.on(oi.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),tt.on(oi.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){let t=this.videoElement.play();t&&t.catch&&t.catch(n=>{e&&gO(e,"video",n.message,this.trackId),n.name==="NotAllowedError"?(S.warning("detected video element autoplay failed",n),this.autoplayFailed=!0,this.handleAutoPlayFailed()):S.warning("[".concat(this.trackId,"] play warning: "),n)});let r=ze();if((r.name==="Safari"&&Number(r.version)===15||Pc())&&t&&t.then){let n=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};t.then(n).catch(n)}}getCurrentFrame(){let e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;let t=e.getContext("2d");if(!t)return S.error("create canvas context failed!"),new ImageData(2,2);t.drawImage(this.videoElement,0,0,e.width,e.height);let r=t.getImageData(0,0,e.width,e.height);return e.remove(),r}async getCurrentFrameToUint8Array(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,r=document.createElement("canvas");r.width=this.videoElement.videoWidth,r.height=this.videoElement.videoHeight;let n=r.getContext("2d");return n?(n.drawImage(this.videoElement,0,0,r.width,r.height),new F((a,c)=>{r.toBlob(async l=>{if(r.remove(),l){let u=await IO(l);a({buffer:u,width:r.width,height:r.height})}else c(new Y(A.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,t<0?.1:t>1?1:t)})):await Tg(e)}destroy(){tt.off(oi.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),tt.off(oi.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[]}initVideoElement(){if(this.videoElementStatus=Li.INIT,!this.videoElementCheckInterval&&(OO.forEach(a=>{this.videoElement.addEventListener(a,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(a){return a!==document.body&&document.body.contains(a)})(this.videoElement)||(this.videoElementStatus=Li.DESTROYED)},1e3),P("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,t;let a,c=(l,u)=>{if(this.videoElementStatus===Li.PLAYING){if(a){let _=u.presentationTime-a.presentationTime;_>P("VIDEO_FREEZE_DURATION")&&xs.lastVisibleTime>=xs.lastHiddenTime&&a.timestamp>xs.lastVisibleTime&&a.timestamp>xs.lastHiddenTime&&(this.renderFreezeAccTime+=_)}a=AO(AO({},u),{},{timestamp:l})}var h,p;P("ENABLE_VIDEO_FRAME_CALLBACK")&&((h=(p=this.videoElement).requestVideoFrameCallback)===null||h===void 0||h.call(p,c))};(e=(t=this.videoElement).requestVideoFrameCallback)===null||e===void 0||e.call(t,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Mh()&&(this.videoElement.poster="noposter");let r=ze();r.name==="Safari"&&Number(r.version)===15||Pc()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ht()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ht()&&this.videoElement.load());let n=this.videoElement.play();n!==void 0&&n.catch(a=>{S.debug("[".concat(this.trackId,"] playback interrupted"),a.toString())})}resetVideoElement(){OO.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=Li.NONE}handleAutoPlayFailed(){let e=t=>{t.preventDefault(),this.videoElement.play().then(()=>{S.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(r=>{S.error(r)}),this.autoplayFailed=!1,ud()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};ud()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),_O()}}let OO=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class NO extends vg{constructor(e){super(e),g(this,"container",void 0),g(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;let t=e.element;t!==this.slot&&(this.destroy(),this.slot=t),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var t;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,r):await Tg(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",P("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function bO(i){return new F((e,t)=>{let r=!1,n=document.createElement("video");n.setAttribute("autoplay",""),n.setAttribute("muted",""),n.muted=!0,n.autoplay=!0,n.setAttribute("playsinline",""),n.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(n);let a=Fi()?"canplay":"playing";n.addEventListener(a,()=>{let c=n.videoWidth,l=n.videoHeight;!c&&ht()||(r=!0,n.srcObject=null,n.remove(),e([c,l]))}),n.srcObject=new MediaStream([i]),n.play().catch(Fh),setTimeout(()=>{r||(n.srcObject=null,n.remove(),e([n.videoWidth,n.videoHeight]))},4e3)})}let z5=async(i,e,t)=>{let r=function(c){let l=[];for(let u=0;u<c.length;u+=2)l.push(parseInt(c.slice(u,u+2),16));return Uint8Array.from(l)}(function(c){let l="0123456789abcdef";function u(ce){let ne,Pe="";for(ne=0;ne<=3;ne++)Pe+=l.charAt(ce>>8*ne+4&15)+l.charAt(ce>>8*ne&15);return Pe}function h(ce,ne){let Pe=(65535&ce)+(65535&ne);return(ce>>16)+(ne>>16)+(Pe>>16)<<16|65535&Pe}function p(ce,ne,Pe,We,It,Gt){return h(function(pt,Ir){return pt<<Ir|pt>>>32-Ir}(h(h(ne,ce),h(We,Gt)),It),Pe)}function _(ce,ne,Pe,We,It,Gt,pt){return p(ne&Pe|~ne&We,ce,ne,It,Gt,pt)}function E(ce,ne,Pe,We,It,Gt,pt){return p(ne&We|Pe&~We,ce,ne,It,Gt,pt)}function T(ce,ne,Pe,We,It,Gt,pt){return p(ne^Pe^We,ce,ne,It,Gt,pt)}function w(ce,ne,Pe,We,It,Gt,pt){return p(Pe^(ne|~We),ce,ne,It,Gt,pt)}let C=function(ce){let ne,Pe=1+(ce.length+8>>6),We=new Array(16*Pe);for(ne=0;ne<16*Pe;ne++)We[ne]=0;for(ne=0;ne<ce.length;ne++)We[ne>>2]|=ce.charCodeAt(ne)<<ne%4*8;return We[ne>>2]|=128<<ne%4*8,We[16*Pe-2]=8*ce.length,We}(c),O,b,k,U,X,z=1732584193,j=-271733879,B=-1732584194,W=271733878;for(O=0;O<C.length;O+=16)b=z,k=j,U=B,X=W,z=_(z,j,B,W,C[O+0],7,-680876936),W=_(W,z,j,B,C[O+1],12,-389564586),B=_(B,W,z,j,C[O+2],17,606105819),j=_(j,B,W,z,C[O+3],22,-1044525330),z=_(z,j,B,W,C[O+4],7,-176418897),W=_(W,z,j,B,C[O+5],12,1200080426),B=_(B,W,z,j,C[O+6],17,-1473231341),j=_(j,B,W,z,C[O+7],22,-45705983),z=_(z,j,B,W,C[O+8],7,1770035416),W=_(W,z,j,B,C[O+9],12,-1958414417),B=_(B,W,z,j,C[O+10],17,-42063),j=_(j,B,W,z,C[O+11],22,-1990404162),z=_(z,j,B,W,C[O+12],7,1804603682),W=_(W,z,j,B,C[O+13],12,-40341101),B=_(B,W,z,j,C[O+14],17,-1502002290),j=_(j,B,W,z,C[O+15],22,1236535329),z=E(z,j,B,W,C[O+1],5,-165796510),W=E(W,z,j,B,C[O+6],9,-1069501632),B=E(B,W,z,j,C[O+11],14,643717713),j=E(j,B,W,z,C[O+0],20,-373897302),z=E(z,j,B,W,C[O+5],5,-701558691),W=E(W,z,j,B,C[O+10],9,38016083),B=E(B,W,z,j,C[O+15],14,-660478335),j=E(j,B,W,z,C[O+4],20,-405537848),z=E(z,j,B,W,C[O+9],5,568446438),W=E(W,z,j,B,C[O+14],9,-1019803690),B=E(B,W,z,j,C[O+3],14,-187363961),j=E(j,B,W,z,C[O+8],20,1163531501),z=E(z,j,B,W,C[O+13],5,-1444681467),W=E(W,z,j,B,C[O+2],9,-51403784),B=E(B,W,z,j,C[O+7],14,1735328473),j=E(j,B,W,z,C[O+12],20,-1926607734),z=T(z,j,B,W,C[O+5],4,-378558),W=T(W,z,j,B,C[O+8],11,-2022574463),B=T(B,W,z,j,C[O+11],16,1839030562),j=T(j,B,W,z,C[O+14],23,-35309556),z=T(z,j,B,W,C[O+1],4,-1530992060),W=T(W,z,j,B,C[O+4],11,1272893353),B=T(B,W,z,j,C[O+7],16,-155497632),j=T(j,B,W,z,C[O+10],23,-1094730640),z=T(z,j,B,W,C[O+13],4,681279174),W=T(W,z,j,B,C[O+0],11,-358537222),B=T(B,W,z,j,C[O+3],16,-722521979),j=T(j,B,W,z,C[O+6],23,76029189),z=T(z,j,B,W,C[O+9],4,-640364487),W=T(W,z,j,B,C[O+12],11,-421815835),B=T(B,W,z,j,C[O+15],16,530742520),j=T(j,B,W,z,C[O+2],23,-995338651),z=w(z,j,B,W,C[O+0],6,-198630844),W=w(W,z,j,B,C[O+7],10,1126891415),B=w(B,W,z,j,C[O+14],15,-1416354905),j=w(j,B,W,z,C[O+5],21,-57434055),z=w(z,j,B,W,C[O+12],6,1700485571),W=w(W,z,j,B,C[O+3],10,-1894986606),B=w(B,W,z,j,C[O+10],15,-1051523),j=w(j,B,W,z,C[O+1],21,-2054922799),z=w(z,j,B,W,C[O+8],6,1873313359),W=w(W,z,j,B,C[O+15],10,-30611744),B=w(B,W,z,j,C[O+6],15,-1560198380),j=w(j,B,W,z,C[O+13],21,1309151649),z=w(z,j,B,W,C[O+4],6,-145523070),W=w(W,z,j,B,C[O+11],10,-1120210379),B=w(B,W,z,j,C[O+2],15,718787259),j=w(j,B,W,z,C[O+9],21,-343485551),z=h(z,b),j=h(j,k),B=h(B,U),W=h(W,X);return u(z)+u(j)+u(B)+u(W)}(""+e+t)).slice(0,16),n=r.slice(0,12),a=await window.crypto.subtle.importKey("raw",r,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:n},a,i))},DO=async(i,e,t)=>await z5(i.buffer,e,t);function PO(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function zr(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?PO(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):PO(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class ke extends Ri{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Li.PLAYING)}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,t,r,n,a,c){if(super(e,a),g(this,"trackMediaType","video"),g(this,"_player",void 0),g(this,"isUseScaleResolutionDownBy",!1),g(this,"_videoVisibleTimer",null),g(this,"_statsTimer",null),g(this,"_previousVideoVisibleStatus",void 0),g(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),g(this,"_encoderConfig",void 0),g(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),g(this,"_optimizationMode",void 0),g(this,"_videoHeight",void 0),g(this,"_videoWidth",void 0),g(this,"_forceBitrateLimit",void 0),g(this,"_enabled",!0),g(this,"processorDestination",void 0),g(this,"_processorContext",void 0),Vi()){let{width:l,height:u}=e.getSettings();this._videoWidth=l,this._videoHeight=u}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=t,this._scalabilityMode=r,this._optimizationMode=n,this._hints=c||[],this._hints.indexOf(ut.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(l,u,h){let p=ze();return!(p.name!==l||!p.osVersion)&&(h?Number(p.version)>=u&&Number(p.version)<=h:Number(p.version)===u)}(Xe.CHROME,115)&&kh().indexOf("Windows")!==-1){let l=function(u,h){if("VideoFrame"in window&&"TransformStream"in window&&ct().supportWebRTCInsertableStream){let p=new MediaStreamTrackProcessor(u),_=new MediaStreamTrackGenerator({kind:"video"}),E,T,w=Date.now(),C=()=>{O&&(clearInterval(O),O=void 0),E&&(E.close(),E=void 0),u.stop(),T=void 0,_.removeEventListener("ended",C)},O=window.setInterval(()=>{if(T&&E&&Date.now()-w>(h??1e3))try{_.readyState==="live"?T.enqueue(E.clone()):C()}catch{C()}},h??1e3),b=new TransformStream({transform:(k,U)=>{_.readyState==="live"?(T=U,w=Date.now(),E===void 0?(E=k,U.enqueue(k.clone())):(U.enqueue(E),E=k)):k.close()}});return _.addEventListener("ended",C),p.readable.pipeThrough(b).pipeTo(_.writable),_}}(e);l&&(S.info("local screen video track begin to inject frame"),this._mediaStreamTrack=l)}t&&this._hints.indexOf(ut.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(t),this.processorContext=new vO(this.getTrackId(),"local"),this.processorDestination=new TO(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){let n=document.getElementById(e);n?e=n:(S.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}S.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));let r=zr(zr(zr({},this._getDefaultPlayerConfig()),t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(r):(e instanceof HTMLVideoElement?this._player=new vg(r):this._player=new NO(r),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let n=this.getVideoElementVisibleStatus();this.safeEmit(Ea.VIDEO_ELEMENT_VISIBLE_STATUS,n)}catch{}},P("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,S.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await st(this,ue.NEED_DISABLE_TRACK,this)}catch(r){throw S.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}return t||(this._enabled=!1),void S.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await st(this,ue.NEED_ENABLE_TRACK,this)}catch(r){throw S.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}S.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,S.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await st(this,ue.NEED_MUTE_TRACK,this):await st(this,ue.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,t){if(!this._enabled)throw new Y(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=fs(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){let r=hp({encoderConfig:e});(Vi()||Fi()||ls())&&(r.deviceId=void 0),S.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(n){let a=new Y(A.UNEXPECTED_ERROR,n.toString());throw S.error("[".concat(this.getTrackId(),"] applyConstraints error"),a.toString()),a}}this._encoderConfig=e,this._hints.indexOf(ut.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await st(this,ue.NEED_UPDATE_VIDEO_ENCODER,this)}catch(r){return r.throw(S)}}getStats(){return pd(()=>{S.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),cr(this,ue.GET_STATS)||zr({},dg)}async setBeautyEffect(e){S.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,t):await Tg(e)}async setBitrateLimit(e){if(S.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate);try{await st(this,ue.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw(S)}}}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void S.error(A.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");let t=this._optimizationMode;try{this._optimizationMode=e,await st(this,ue.SET_OPTIMIZATION_MODE,this)}catch(r){throw this._optimizationMode=t,S.error("[".concat(this.getTrackId(),"] set optimization mode failed"),r.toString()),r}S.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return S.error(A.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,S.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){bO(this._originMediaStreamTrack).then(e=>{let[t,r]=e;this._videoHeight=r,this._videoWidth=t}).catch(Fh)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new Y(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");S.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=fs(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(ut.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await st(this,ue.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw(S)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;let{width:e,height:t,frameRate:r}=this.getMediaStreamTrackSettings();if(!e||!t||!r)return;let[n,a]=function(c,l,u,h){let p,_=200*Math.pow(u/15,.6)*Math.pow(c*l/640/360,.75),E=_;if(h==="STANDARD_BITRATE")p=4*_;else{if(h!=="COMPATIABLE_BITRATE")return;p=2*_}return[Math.floor(p),Math.floor(E)]}(e,t,r,P("BITRATE_ADAPTER_TYPE"))||[void 0,void 0];this._encoderConfig.bitrateMin||this._encoderConfig.bitrateMax||(this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=n,S.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(t,", fps: ").concat(r,"] => [brMax: ").concat(n,", brMin: ").concat(a,"]")))}getVideoElementVisibleStatus(){try{var e,t;let r=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),n={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:r==null?void 0:r.parentElement},{element:a,slot:c}=n;if(this.isPlaying&&a instanceof HTMLVideoElement&&c instanceof HTMLElement){let l=gw.checkOneElementVisible(a),u=Object.assign({},l);if(u.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=u.visible;let h=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});u.visible?h.onSuccess("Video is visible"):h.onSuccess("Invisible because of ".concat(u.reason))}return u}return}catch(r){throw new Y(A.GET_VIDEO_ELEMENT_VISIBLE_ERROR,r.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new Y(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;let e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;e&&(r=zr(zr({},r),fs(e))),r=vo(r);let n=at(8,"track-video-cloned-"),a=new ke(t?this._mediaStreamTrack.clone():this._mediaStreamTrack,r,vo(this._scalabilityMode),this._optimizationMode,n,vo(this._hints));return e&&r&&a.setEncoderConfiguration(r),S.debug("clone video track from ".concat(this.getTrackId()," to ").concat(n,", clone ").concat(t)),a}async replaceTrack(e,t){if(!(e instanceof MediaStreamTrack))throw new Y(A.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new Y(A.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,t,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!Vi()&&!Fi())return;this._statsTimer&&window.clearInterval(this._statsTimer);let e=2,t=rp[e],r=-1,n=Date.now(),a=c=>{c>2||c<0||(n=Date.now(),t=rp[c],this.setSenderConfiguration(t))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{let c=this.getStats(),l=cr(this,ue.GET_RTC_STATS);if(c.sendPackets>0&&l){r===-1&&(r=Date.now());let u=Date.now();if(u-r<1e3||u-n<P("PROFILE_SWITCH_INTERVAL"))return;let h=c.sendFrameRate,p=.6*t.frameRate,_=.9*t.frameRate;typeof h=="number"&&h>0&&h<p?e>0&&(e--,a(e),S.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(h,", switchProfile to ").concat(e))):l.OutgoingAvailableBandwidth<t.bitrateMin?e>0&&(e--,a(e),S.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(l.OutgoingAvailableBandwidth,", bitrateMin ").concat(t.bitrateMin,", switchProfile to ").concat(e))):typeof h=="number"&&h>_&&e<rp.length-1&&l.OutgoingAvailableBandwidth>1.2*rp[e+1].bitrateMin&&(e++,a(e),S.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(h,", OutgoingAvailableBandwidth ").concat(l.OutgoingAvailableBandwidth,", switchProfile to ").concat(e)))}},P("CHECK_LOCAL_STATS_INTERVAL"))}bindProcessorDestinationEvents(){this.processorDestination.on(ki.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await st(this,ue.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await st(this,ue.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ki.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(pr.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(pr.REQUEST_CONSTRAINTS)}}J([Ce({argsMap:(i,e,t)=>[i.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",t]}),Nt(),R("design:type",Function),R("design:paramtypes",[Object,Object]),R("design:returntype",void 0)],ke.prototype,"play",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],ke.prototype,"stop",null),J([Uc("LocalVideoTrack","_enabledMutex"),Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[Boolean,Boolean]),R("design:returntype",F)],ke.prototype,"setEnabled",null),J([Uc("LocalVideoTrack","_enabledMutex"),Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[Boolean]),R("design:returntype",F)],ke.prototype,"setMuted",null),J([Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[Object,Boolean]),R("design:returntype",F)],ke.prototype,"setEncoderConfiguration",null),J([Nt(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",Object)],ke.prototype,"getStats",null),J([Ce({argsMap:(i,e,t)=>[i.getTrackId(),e,t]}),Nt(),R("design:type",Function),R("design:paramtypes",[Boolean,Object]),R("design:returntype",F)],ke.prototype,"setBeautyEffect",null),J([Nt(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",ImageData)],ke.prototype,"getCurrentFrameData",null),J([Nt(),R("design:type",Function),R("design:paramtypes",[String,Number]),R("design:returntype",F)],ke.prototype,"getCurrentFrameImage",null),J([Nt(),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",F)],ke.prototype,"setBitrateLimit",null),J([Nt(),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],ke.prototype,"setOptimizationMode",null),J([Nt(),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",void 0)],ke.prototype,"setScalabiltyMode",null),J([Nt(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],ke.prototype,"updateMediaStreamTrackResolution",null),J([Ce({argsMap:(i,e)=>[i.getTrackId(),e.name]}),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",Object)],ke.prototype,"pipe",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],ke.prototype,"unpipe",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],ke.prototype,"close",null),J([Ce({argsMap:(i,e,t)=>[i.getTrackId(),e.label,t]}),R("design:type",Function),R("design:paramtypes",[MediaStreamTrack,Boolean]),R("design:returntype",F)],ke.prototype,"replaceTrack",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],ke.prototype,"startMonitorStats",null);class Ta extends ke{get __className__(){return"CameraVideoTrack"}constructor(e,t,r,n,a,c){super(e,fs(t.encoderConfig),n,a,c),g(this,"_config",void 0),g(this,"_originalConstraints",void 0),g(this,"_constraints",void 0),g(this,"_enabled",!0),g(this,"_deviceName","default"),g(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Pc()||SE())&&!function(){let l=ze();if(l.os!==Jt.IOS||!l.osVersion)return!1;let u=l.osVersion.split(".");return Number(u[0])===15&&Number(u[1])>=2}()&&pw()&&this._enabled&&!this._isClosed&&(S.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=t,this._originalConstraints=r,this._constraints=r,this._deviceName=e.label,this._encoderConfig=fs(this._config.encoderConfig),tt.on(oi.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),tt.on(oi.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(S.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{let t=await Hr.getDeviceById(e),r={};r.video=zr({},this._constraints),r.video.deviceId={exact:e},r.video.facingMode=void 0,this._originMediaStreamTrack.stop();let n=null;try{n=await Wr(r,this.getTrackId())}catch(a){throw S.error("[".concat(this.getTrackId(),"] setDevice failed"),a.toString()),n=await Wr({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),a}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(t){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{let t=await Hr.getDeviceById(e);this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(t){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}S.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){S.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));let t={video:zr(zr({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let r=null;try{r=await Wr(t,this.getTrackId())}catch(n){throw S.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),n.toString()),r=await Wr({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),n}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=zr({},t.video),S.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{let r=await Wr({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1)}await st(this,ue.NEED_ENABLE_TRACK,this)}catch(r){throw S.error("[".concat(this.getTrackId(),"] setEnabled true error"),r.toString()),r}this.updateMediaStreamTrackResolution(),S.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),t||(this._enabled=!1);try{await st(this,ue.NEED_DISABLE_TRACK,this)}catch(r){throw S.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}S.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,t){if(!this._enabled)throw new Y(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=fs(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin);let r=Ut(this._config);r.encoderConfig=e;let n=hp(r);(Vi()||Fi()||ls())&&(n.deviceId=void 0),S.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(a){let c=new Y(A.UNEXPECTED_ERROR,a.toString());throw S.error("[".concat(this.getTrackId(),"] applyConstraints error"),c.toString()),c}this._config=r,this._constraints=n,this._originalConstraints=n,this._encoderConfig=e,this._hints.indexOf(ut.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await st(this,ue.NEED_UPDATE_VIDEO_ENCODER,this)}catch(a){return a.throw(S)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Fi()||ls())&&this._enabled&&!this._isClosed&&tt.duringInterruption){let e=async()=>{tt.off(oi.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(S.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};tt.on(oi.IOS_INTERRUPTION_END,e)}else S.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Ea.TRACK_ENDED)}async renewMediaStreamTrack(e){let t=e||this._constraints,r=Hr.searchDeviceIdByName(this._deviceName);if(r&&!t.deviceId&&(t.deviceId={exact:r}),this._enabled){let n=await Wr({video:t},this.getTrackId());this._constraints=t,await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),tt.off(oi.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),tt.off(oi.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;e&&(r=zr(zr({},r),fs(e))),r=vo(r);let n=at(8,"track-cam-cloned-"),a=new Ta(t?this._mediaStreamTrack.clone():this._mediaStreamTrack,vo(zr(zr({},this._config),{},{encoderConfig:r})),vo(this._constraints),vo(this._scalabilityMode),this._optimizationMode,n);return e&&r&&a.setEncoderConfiguration(r),S.debug("clone track from ".concat(this.getTrackId()," to ").concat(n,", clone ").concat(t)),a}bindProcessorContextEvents(){this.processorContext.on(pr.REQUEST_UPDATE_CONSTRAINTS,async(e,t,r)=>{try{let n=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(n),t()}catch(n){r(n)}}),this.processorContext.on(pr.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}}function kO(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function pp(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?kO(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):kO(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function yg(i,e,t,r){t.optimizationMode&&(r&&r.width&&r.height?(t.encoderConfig=pp(pp({},r),{},{bitrateMin:r.bitrateMin,bitrateMax:r.bitrateMax}),t.optimizationMode!=="motion"&&t.optimizationMode!=="detail"||(e.contentHint=t.optimizationMode,e.contentHint===t.optimizationMode?S.debug("[".concat(i,"] set content hint to"),t.optimizationMode):S.debug("[".concat(i,"] set content hint failed")))):S.warning("[".concat(i,"] can not apply optimization mode bitrate config, no encoderConfig")))}function LO(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function fp(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?LO(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):LO(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}J([Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",F)],Ta.prototype,"setDevice",null),J([Uc("CameraVideoTrack","_enabledMutex"),Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[Boolean,Boolean]),R("design:returntype",F)],Ta.prototype,"setEnabled",null),J([Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),Nt(),R("design:type",Function),R("design:paramtypes",[Object,Boolean]),R("design:returntype",F)],Ta.prototype,"setEncoderConfiguration",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Ta.prototype,"close",null);class MO extends nO{getUserId(){return this._userId}constructor(e,t,r,n){super(e,"track-".concat(e.kind,"-").concat(t,"-").concat(n.clientId,"_").concat(at(5,""))),g(this,"_userId",void 0),g(this,"_uintId",void 0),g(this,"_isDestroyed",!1),g(this,"store",void 0),g(this,"processor",void 0),this._userId=t,this._uintId=r,this.store=n}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,S.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}class _s extends MO{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Li.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,r,n){super(e,t,r,n),g(this,"_videoVisibleTimer",null),g(this,"_previousVideoVisibleStatus",void 0),g(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),g(this,"trackMediaType","video"),g(this,"_videoWidth",void 0),g(this,"_videoHeight",void 0),g(this,"_player",void 0),g(this,"processorDestination",void 0),g(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new vO(this.getTrackId(),"remote"),this.processorDestination=new TO(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return pd(()=>{S.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),cr(this,ue.GET_STATS)||fp({},rO)}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){let n=document.getElementById(e);n?e=n:(S.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}S.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));let r=fp(fp({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(r):(e instanceof HTMLVideoElement?this._player=new vg(r):this._player=new NO(r),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Oo.FIRST_FRAME_DECODED)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let n=this.getVideoElementVisibleStatus();this.safeEmit(Oo.VIDEO_ELEMENT_VISIBLE_STATUS,n)}catch{}},P("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,S.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){bO(this._originMediaStreamTrack).then(e=>{let[t,r]=e;this._videoHeight=r,this._videoWidth=t}).catch(Fh)}_updatePlayerSource(){S.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;let r=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),n={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:r==null?void 0:r.parentElement},{element:a,slot:c}=n;if(this.isPlaying&&a instanceof HTMLVideoElement&&c instanceof HTMLElement){let l=gw.checkOneElementVisible(a),u=Object.assign({},l);if(u.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=u.visible;let h=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});u.visible?h.onSuccess("Video is visible"):h.onSuccess("Invisible because of ".concat(u.reason))}return u}return}catch(r){throw new Y(A.GET_VIDEO_ELEMENT_VISIBLE_ERROR,r.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new Y(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;let e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ki.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ki.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}}J([Ce({argsMap:(i,e,t)=>[i.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",t]}),R("design:type",Function),R("design:paramtypes",[Object,Object]),R("design:returntype",void 0)],_s.prototype,"play",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],_s.prototype,"stop",null),J([Ce({argsMap:(i,e)=>[i.getTrackId(),e.name]}),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",Object)],_s.prototype,"pipe",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],_s.prototype,"unpipe",null);class On extends MO{get isPlaying(){return this._useAudioElement?Cr.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,r,n){super(e,t,r,n),g(this,"trackMediaType","audio"),g(this,"_source",void 0),g(this,"_useAudioElement",!0),g(this,"_volume",100),g(this,"processorContext",void 0),g(this,"processorDestination",void 0),g(this,"_played",!1),g(this,"_bypassWebAudio",!1),P("DISABLE_WEBAUDIO")?(this._source=new Eg,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new fg(e,!0),P("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(hr.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Oo.FIRST_FRAME_DECODED)}),this.processorContext=new up(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new dp(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(hr.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(hr.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(hr.ON_AUDIO_BUFFER),this._source.on(hr.ON_AUDIO_BUFFER,r=>e(r))}setVolume(e){this._volume=e,this._useAudioElement?Cr.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement)throw new Y(A.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Cr.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return pd(()=>{S.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),cr(this,ue.GET_STATS)||fp({},iO)}play(){S.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(S.debug("[".concat(this.getTrackId(),"] use audio element to play")),Cr.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){S.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Cr.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];S.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Cr.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new Y(A.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new Y(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new Y(A.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;let t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ki.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(ki.ON_NODE,e=>{this._source.processedNode=e;let t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ki.ON_TRACK),this.processorDestination.removeAllListeners(ki.ON_NODE)}}J([Ce({argsMap:(i,e)=>[i.getTrackId(),e],throttleTime:300}),R("design:type",Function),R("design:paramtypes",[Number]),R("design:returntype",void 0)],On.prototype,"setVolume",null),J([Ce({argsMap:(i,e)=>[i.getTrackId(),e]}),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],On.prototype,"setPlaybackDevice",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],On.prototype,"play",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],On.prototype,"stop",null),J([Ce({argsMap:(i,e)=>[i.getTrackId(),e.name]}),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",Object)],On.prototype,"pipe",null),J([Ce({argsMap:i=>[i.getTrackId()]}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],On.prototype,"unpipe",null);function Qc(i){let e=i.length;for(;--e>=0;)i[e]=0}let Cg=256,UO=286,Td=30,vd=15,Rg=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),_p=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Y5=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),xO=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Vs=new Array(576);Qc(Vs);let yd=new Array(60);Qc(yd);let Cd=new Array(512);Qc(Cd);let Rd=new Array(256);Qc(Rd);let Ig=new Array(29);Qc(Ig);let mp=new Array(Td);function wg(i,e,t,r,n){this.static_tree=i,this.extra_bits=e,this.extra_base=t,this.elems=r,this.max_length=n,this.has_stree=i&&i.length}let VO,FO,jO;function Ag(i,e){this.dyn_tree=i,this.max_code=0,this.stat_desc=e}Qc(mp);let BO=i=>i<256?Cd[i]:Cd[256+(i>>>7)],Id=(i,e)=>{i.pending_buf[i.pending++]=255&e,i.pending_buf[i.pending++]=e>>>8&255},Yr=(i,e,t)=>{i.bi_valid>16-t?(i.bi_buf|=e<<i.bi_valid&65535,Id(i,i.bi_buf),i.bi_buf=e>>16-i.bi_valid,i.bi_valid+=t-16):(i.bi_buf|=e<<i.bi_valid&65535,i.bi_valid+=t)},ms=(i,e,t)=>{Yr(i,t[2*e],t[2*e+1])},GO=(i,e)=>{let t=0;do t|=1&i,i>>>=1,t<<=1;while(--e>0);return t>>>1},WO=(i,e,t)=>{let r=new Array(16),n,a,c=0;for(n=1;n<=vd;n++)c=c+t[n-1]<<1,r[n]=c;for(a=0;a<=e;a++){let l=i[2*a+1];l!==0&&(i[2*a]=GO(r[l]++,l))}},HO=i=>{let e;for(e=0;e<UO;e++)i.dyn_ltree[2*e]=0;for(e=0;e<Td;e++)i.dyn_dtree[2*e]=0;for(e=0;e<19;e++)i.bl_tree[2*e]=0;i.dyn_ltree[512]=1,i.opt_len=i.static_len=0,i.sym_next=i.matches=0},KO=i=>{i.bi_valid>8?Id(i,i.bi_buf):i.bi_valid>0&&(i.pending_buf[i.pending++]=i.bi_buf),i.bi_buf=0,i.bi_valid=0},zO=(i,e,t,r)=>{let n=2*e,a=2*t;return i[n]<i[a]||i[n]===i[a]&&r[e]<=r[t]},Og=(i,e,t)=>{let r=i.heap[t],n=t<<1;for(;n<=i.heap_len&&(n<i.heap_len&&zO(e,i.heap[n+1],i.heap[n],i.depth)&&n++,!zO(e,r,i.heap[n],i.depth));)i.heap[t]=i.heap[n],t=n,n<<=1;i.heap[t]=r},YO=(i,e,t)=>{let r,n,a,c,l=0;if(i.sym_next!==0)do r=255&i.pending_buf[i.sym_buf+l++],r+=(255&i.pending_buf[i.sym_buf+l++])<<8,n=i.pending_buf[i.sym_buf+l++],r===0?ms(i,n,e):(a=Rd[n],ms(i,a+Cg+1,e),c=Rg[a],c!==0&&(n-=Ig[a],Yr(i,n,c)),r--,a=BO(r),ms(i,a,t),c=_p[a],c!==0&&(r-=mp[a],Yr(i,r,c)));while(l<i.sym_next);ms(i,256,e)},Ng=(i,e)=>{let t=e.dyn_tree,r=e.stat_desc.static_tree,n=e.stat_desc.has_stree,a=e.stat_desc.elems,c,l,u,h=-1;for(i.heap_len=0,i.heap_max=573,c=0;c<a;c++)t[2*c]!==0?(i.heap[++i.heap_len]=h=c,i.depth[c]=0):t[2*c+1]=0;for(;i.heap_len<2;)u=i.heap[++i.heap_len]=h<2?++h:0,t[2*u]=1,i.depth[u]=0,i.opt_len--,n&&(i.static_len-=r[2*u+1]);for(e.max_code=h,c=i.heap_len>>1;c>=1;c--)Og(i,t,c);u=a;do c=i.heap[1],i.heap[1]=i.heap[i.heap_len--],Og(i,t,1),l=i.heap[1],i.heap[--i.heap_max]=c,i.heap[--i.heap_max]=l,t[2*u]=t[2*c]+t[2*l],i.depth[u]=(i.depth[c]>=i.depth[l]?i.depth[c]:i.depth[l])+1,t[2*c+1]=t[2*l+1]=u,i.heap[1]=u++,Og(i,t,1);while(i.heap_len>=2);i.heap[--i.heap_max]=i.heap[1],((p,_)=>{let E=_.dyn_tree,T=_.max_code,w=_.stat_desc.static_tree,C=_.stat_desc.has_stree,O=_.stat_desc.extra_bits,b=_.stat_desc.extra_base,k=_.stat_desc.max_length,U,X,z,j,B,W,ce=0;for(j=0;j<=vd;j++)p.bl_count[j]=0;for(E[2*p.heap[p.heap_max]+1]=0,U=p.heap_max+1;U<573;U++)X=p.heap[U],j=E[2*E[2*X+1]+1]+1,j>k&&(j=k,ce++),E[2*X+1]=j,X>T||(p.bl_count[j]++,B=0,X>=b&&(B=O[X-b]),W=E[2*X],p.opt_len+=W*(j+B),C&&(p.static_len+=W*(w[2*X+1]+B)));if(ce!==0){do{for(j=k-1;p.bl_count[j]===0;)j--;p.bl_count[j]--,p.bl_count[j+1]+=2,p.bl_count[k]--,ce-=2}while(ce>0);for(j=k;j!==0;j--)for(X=p.bl_count[j];X!==0;)z=p.heap[--U],z>T||(E[2*z+1]!==j&&(p.opt_len+=(j-E[2*z+1])*E[2*z],E[2*z+1]=j),X--)}})(i,e),WO(t,h,i.bl_count)},qO=(i,e,t)=>{let r,n,a=-1,c=e[1],l=0,u=7,h=4;for(c===0&&(u=138,h=3),e[2*(t+1)+1]=65535,r=0;r<=t;r++)n=c,c=e[2*(r+1)+1],++l<u&&n===c||(l<h?i.bl_tree[2*n]+=l:n!==0?(n!==a&&i.bl_tree[2*n]++,i.bl_tree[32]++):l<=10?i.bl_tree[34]++:i.bl_tree[36]++,l=0,a=n,c===0?(u=138,h=3):n===c?(u=6,h=3):(u=7,h=4))},JO=(i,e,t)=>{let r,n,a=-1,c=e[1],l=0,u=7,h=4;for(c===0&&(u=138,h=3),r=0;r<=t;r++)if(n=c,c=e[2*(r+1)+1],!(++l<u&&n===c)){if(l<h)do ms(i,n,i.bl_tree);while(--l!=0);else n!==0?(n!==a&&(ms(i,n,i.bl_tree),l--),ms(i,16,i.bl_tree),Yr(i,l-3,2)):l<=10?(ms(i,17,i.bl_tree),Yr(i,l-3,3)):(ms(i,18,i.bl_tree),Yr(i,l-11,7));l=0,a=n,c===0?(u=138,h=3):n===c?(u=6,h=3):(u=7,h=4)}},XO=!1,QO=(i,e,t,r)=>{Yr(i,0+(r?1:0),3),KO(i),Id(i,t),Id(i,~t),t&&i.pending_buf.set(i.window.subarray(e,e+t),i.pending),i.pending+=t};var q5=i=>{XO||((()=>{let e,t,r,n,a,c=new Array(16);for(r=0,n=0;n<28;n++)for(Ig[n]=r,e=0;e<1<<Rg[n];e++)Rd[r++]=n;for(Rd[r-1]=n,a=0,n=0;n<16;n++)for(mp[n]=a,e=0;e<1<<_p[n];e++)Cd[a++]=n;for(a>>=7;n<Td;n++)for(mp[n]=a<<7,e=0;e<1<<_p[n]-7;e++)Cd[256+a++]=n;for(t=0;t<=vd;t++)c[t]=0;for(e=0;e<=143;)Vs[2*e+1]=8,e++,c[8]++;for(;e<=255;)Vs[2*e+1]=9,e++,c[9]++;for(;e<=279;)Vs[2*e+1]=7,e++,c[7]++;for(;e<=287;)Vs[2*e+1]=8,e++,c[8]++;for(WO(Vs,287,c),e=0;e<Td;e++)yd[2*e+1]=5,yd[2*e]=GO(e,5);VO=new wg(Vs,Rg,257,UO,vd),FO=new wg(yd,_p,0,Td,vd),jO=new wg(new Array(0),Y5,0,19,7)})(),XO=!0),i.l_desc=new Ag(i.dyn_ltree,VO),i.d_desc=new Ag(i.dyn_dtree,FO),i.bl_desc=new Ag(i.bl_tree,jO),i.bi_buf=0,i.bi_valid=0,HO(i)},J5=(i,e,t,r)=>{let n,a,c=0;i.level>0?(i.strm.data_type===2&&(i.strm.data_type=(l=>{let u,h=4093624447;for(u=0;u<=31;u++,h>>>=1)if(1&h&&l.dyn_ltree[2*u]!==0)return 0;if(l.dyn_ltree[18]!==0||l.dyn_ltree[20]!==0||l.dyn_ltree[26]!==0)return 1;for(u=32;u<Cg;u++)if(l.dyn_ltree[2*u]!==0)return 1;return 0})(i)),Ng(i,i.l_desc),Ng(i,i.d_desc),c=(l=>{let u;for(qO(l,l.dyn_ltree,l.l_desc.max_code),qO(l,l.dyn_dtree,l.d_desc.max_code),Ng(l,l.bl_desc),u=18;u>=3&&l.bl_tree[2*xO[u]+1]===0;u--);return l.opt_len+=3*(u+1)+5+5+4,u})(i),n=i.opt_len+3+7>>>3,a=i.static_len+3+7>>>3,a<=n&&(n=a)):n=a=t+5,t+4<=n&&e!==-1?QO(i,e,t,r):i.strategy===4||a===n?(Yr(i,2+(r?1:0),3),YO(i,Vs,yd)):(Yr(i,4+(r?1:0),3),((l,u,h,p)=>{let _;for(Yr(l,u-257,5),Yr(l,h-1,5),Yr(l,p-4,4),_=0;_<p;_++)Yr(l,l.bl_tree[2*xO[_]+1],3);JO(l,l.dyn_ltree,u-1),JO(l,l.dyn_dtree,h-1)})(i,i.l_desc.max_code+1,i.d_desc.max_code+1,c+1),YO(i,i.dyn_ltree,i.dyn_dtree)),HO(i),r&&KO(i)},X5=(i,e,t)=>(i.pending_buf[i.sym_buf+i.sym_next++]=e,i.pending_buf[i.sym_buf+i.sym_next++]=e>>8,i.pending_buf[i.sym_buf+i.sym_next++]=t,e===0?i.dyn_ltree[2*t]++:(i.matches++,e--,i.dyn_ltree[2*(Rd[t]+Cg+1)]++,i.dyn_dtree[2*BO(e)]++),i.sym_next===i.sym_end),Q5={_tr_init:q5,_tr_stored_block:QO,_tr_flush_block:J5,_tr_tally:X5,_tr_align:i=>{Yr(i,2,3),ms(i,256,Vs),(e=>{e.bi_valid===16?(Id(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(i)}},wd=(i,e,t,r)=>{let n=65535&i|0,a=i>>>16&65535|0,c=0;for(;t!==0;){c=t>2e3?2e3:t,t-=c;do n=n+e[r++]|0,a=a+n|0;while(--c);n%=65521,a%=65521}return n|a<<16|0};let $5=new Uint32Array((()=>{let i,e=[];for(var t=0;t<256;t++){i=t;for(var r=0;r<8;r++)i=1&i?3988292384^i>>>1:i>>>1;e[t]=i}return e})());var Ji=(i,e,t,r)=>{let n=$5,a=r+t;i^=-1;for(let c=r;c<a;c++)i=i>>>8^n[255&(i^e[c])];return-1^i},Do={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},$c={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};let{_tr_init:Z5,_tr_stored_block:bg,_tr_flush_block:e4,_tr_tally:va,_tr_align:t4}=Q5,{Z_NO_FLUSH:ya,Z_PARTIAL_FLUSH:i4,Z_FULL_FLUSH:r4,Z_FINISH:Nn,Z_BLOCK:$O,Z_OK:tr,Z_STREAM_END:ZO,Z_STREAM_ERROR:Es,Z_DATA_ERROR:n4,Z_BUF_ERROR:Dg,Z_DEFAULT_COMPRESSION:s4,Z_FILTERED:a4,Z_HUFFMAN_ONLY:Ep,Z_RLE:o4,Z_FIXED:c4,Z_DEFAULT_STRATEGY:l4,Z_UNKNOWN:d4,Z_DEFLATED:gp}=$c,Pg=286,u4=30,h4=19,p4=2*Pg+1,f4=15,Po=258,gs=262,Zc=42,ko=113,Ad=666,Lo=(i,e)=>(i.msg=Do[e],e),e0=i=>2*i-(i>4?9:0),Ca=i=>{let e=i.length;for(;--e>=0;)i[e]=0},_4=i=>{let e,t,r,n=i.w_size;e=i.hash_size,r=e;do t=i.head[--r],i.head[r]=t>=n?t-n:0;while(--e);e=n,r=e;do t=i.prev[--r],i.prev[r]=t>=n?t-n:0;while(--e)},Ra=(i,e,t)=>(e<<i.hash_shift^t)&i.hash_mask,on=i=>{let e=i.state,t=e.pending;t>i.avail_out&&(t=i.avail_out),t!==0&&(i.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+t),i.next_out),i.next_out+=t,e.pending_out+=t,i.total_out+=t,i.avail_out-=t,e.pending-=t,e.pending===0&&(e.pending_out=0))},cn=(i,e)=>{e4(i,i.block_start>=0?i.block_start:-1,i.strstart-i.block_start,e),i.block_start=i.strstart,on(i.strm)},wt=(i,e)=>{i.pending_buf[i.pending++]=e},Od=(i,e)=>{i.pending_buf[i.pending++]=e>>>8&255,i.pending_buf[i.pending++]=255&e},kg=(i,e,t,r)=>{let n=i.avail_in;return n>r&&(n=r),n===0?0:(i.avail_in-=n,e.set(i.input.subarray(i.next_in,i.next_in+n),t),i.state.wrap===1?i.adler=wd(i.adler,e,n,t):i.state.wrap===2&&(i.adler=Ji(i.adler,e,n,t)),i.next_in+=n,i.total_in+=n,n)},t0=(i,e)=>{let t,r,n=i.max_chain_length,a=i.strstart,c=i.prev_length,l=i.nice_match,u=i.strstart>i.w_size-gs?i.strstart-(i.w_size-gs):0,h=i.window,p=i.w_mask,_=i.prev,E=i.strstart+Po,T=h[a+c-1],w=h[a+c];i.prev_length>=i.good_match&&(n>>=2),l>i.lookahead&&(l=i.lookahead);do if(t=e,h[t+c]===w&&h[t+c-1]===T&&h[t]===h[a]&&h[++t]===h[a+1]){a+=2,t++;do;while(h[++a]===h[++t]&&h[++a]===h[++t]&&h[++a]===h[++t]&&h[++a]===h[++t]&&h[++a]===h[++t]&&h[++a]===h[++t]&&h[++a]===h[++t]&&h[++a]===h[++t]&&a<E);if(r=Po-(E-a),a=E-Po,r>c){if(i.match_start=e,c=r,r>=l)break;T=h[a+c-1],w=h[a+c]}}while((e=_[e&p])>u&&--n!=0);return c<=i.lookahead?c:i.lookahead},el=i=>{let e=i.w_size,t,r,n;do{if(r=i.window_size-i.lookahead-i.strstart,i.strstart>=e+(e-gs)&&(i.window.set(i.window.subarray(e,e+e-r),0),i.match_start-=e,i.strstart-=e,i.block_start-=e,i.insert>i.strstart&&(i.insert=i.strstart),_4(i),r+=e),i.strm.avail_in===0)break;if(t=kg(i.strm,i.window,i.strstart+i.lookahead,r),i.lookahead+=t,i.lookahead+i.insert>=3)for(n=i.strstart-i.insert,i.ins_h=i.window[n],i.ins_h=Ra(i,i.ins_h,i.window[n+1]);i.insert&&(i.ins_h=Ra(i,i.ins_h,i.window[n+3-1]),i.prev[n&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=n,n++,i.insert--,!(i.lookahead+i.insert<3)););}while(i.lookahead<gs&&i.strm.avail_in!==0)},i0=(i,e)=>{let t,r,n,a=i.pending_buf_size-5>i.w_size?i.w_size:i.pending_buf_size-5,c=0,l=i.strm.avail_in;do{if(t=65535,n=i.bi_valid+42>>3,i.strm.avail_out<n||(n=i.strm.avail_out-n,r=i.strstart-i.block_start,t>r+i.strm.avail_in&&(t=r+i.strm.avail_in),t>n&&(t=n),t<a&&(t===0&&e!==Nn||e===ya||t!==r+i.strm.avail_in)))break;c=e===Nn&&t===r+i.strm.avail_in?1:0,bg(i,0,0,c),i.pending_buf[i.pending-4]=t,i.pending_buf[i.pending-3]=t>>8,i.pending_buf[i.pending-2]=~t,i.pending_buf[i.pending-1]=~t>>8,on(i.strm),r&&(r>t&&(r=t),i.strm.output.set(i.window.subarray(i.block_start,i.block_start+r),i.strm.next_out),i.strm.next_out+=r,i.strm.avail_out-=r,i.strm.total_out+=r,i.block_start+=r,t-=r),t&&(kg(i.strm,i.strm.output,i.strm.next_out,t),i.strm.next_out+=t,i.strm.avail_out-=t,i.strm.total_out+=t)}while(c===0);return l-=i.strm.avail_in,l&&(l>=i.w_size?(i.matches=2,i.window.set(i.strm.input.subarray(i.strm.next_in-i.w_size,i.strm.next_in),0),i.strstart=i.w_size,i.insert=i.strstart):(i.window_size-i.strstart<=l&&(i.strstart-=i.w_size,i.window.set(i.window.subarray(i.w_size,i.w_size+i.strstart),0),i.matches<2&&i.matches++,i.insert>i.strstart&&(i.insert=i.strstart)),i.window.set(i.strm.input.subarray(i.strm.next_in-l,i.strm.next_in),i.strstart),i.strstart+=l,i.insert+=l>i.w_size-i.insert?i.w_size-i.insert:l),i.block_start=i.strstart),i.high_water<i.strstart&&(i.high_water=i.strstart),c?4:e!==ya&&e!==Nn&&i.strm.avail_in===0&&i.strstart===i.block_start?2:(n=i.window_size-i.strstart,i.strm.avail_in>n&&i.block_start>=i.w_size&&(i.block_start-=i.w_size,i.strstart-=i.w_size,i.window.set(i.window.subarray(i.w_size,i.w_size+i.strstart),0),i.matches<2&&i.matches++,n+=i.w_size,i.insert>i.strstart&&(i.insert=i.strstart)),n>i.strm.avail_in&&(n=i.strm.avail_in),n&&(kg(i.strm,i.window,i.strstart,n),i.strstart+=n,i.insert+=n>i.w_size-i.insert?i.w_size-i.insert:n),i.high_water<i.strstart&&(i.high_water=i.strstart),n=i.bi_valid+42>>3,n=i.pending_buf_size-n>65535?65535:i.pending_buf_size-n,a=n>i.w_size?i.w_size:n,r=i.strstart-i.block_start,(r>=a||(r||e===Nn)&&e!==ya&&i.strm.avail_in===0&&r<=n)&&(t=r>n?n:r,c=e===Nn&&i.strm.avail_in===0&&t===r?1:0,bg(i,i.block_start,t,c),i.block_start+=t,on(i.strm)),c?3:1)},Lg=(i,e)=>{let t,r;for(;;){if(i.lookahead<gs){if(el(i),i.lookahead<gs&&e===ya)return 1;if(i.lookahead===0)break}if(t=0,i.lookahead>=3&&(i.ins_h=Ra(i,i.ins_h,i.window[i.strstart+3-1]),t=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart),t!==0&&i.strstart-t<=i.w_size-gs&&(i.match_length=t0(i,t)),i.match_length>=3)if(r=va(i,i.strstart-i.match_start,i.match_length-3),i.lookahead-=i.match_length,i.match_length<=i.max_lazy_match&&i.lookahead>=3){i.match_length--;do i.strstart++,i.ins_h=Ra(i,i.ins_h,i.window[i.strstart+3-1]),t=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart;while(--i.match_length!=0);i.strstart++}else i.strstart+=i.match_length,i.match_length=0,i.ins_h=i.window[i.strstart],i.ins_h=Ra(i,i.ins_h,i.window[i.strstart+1]);else r=va(i,0,i.window[i.strstart]),i.lookahead--,i.strstart++;if(r&&(cn(i,!1),i.strm.avail_out===0))return 1}return i.insert=i.strstart<2?i.strstart:2,e===Nn?(cn(i,!0),i.strm.avail_out===0?3:4):i.sym_next&&(cn(i,!1),i.strm.avail_out===0)?1:2},tl=(i,e)=>{let t,r,n;for(;;){if(i.lookahead<gs){if(el(i),i.lookahead<gs&&e===ya)return 1;if(i.lookahead===0)break}if(t=0,i.lookahead>=3&&(i.ins_h=Ra(i,i.ins_h,i.window[i.strstart+3-1]),t=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart),i.prev_length=i.match_length,i.prev_match=i.match_start,i.match_length=2,t!==0&&i.prev_length<i.max_lazy_match&&i.strstart-t<=i.w_size-gs&&(i.match_length=t0(i,t),i.match_length<=5&&(i.strategy===a4||i.match_length===3&&i.strstart-i.match_start>4096)&&(i.match_length=2)),i.prev_length>=3&&i.match_length<=i.prev_length){n=i.strstart+i.lookahead-3,r=va(i,i.strstart-1-i.prev_match,i.prev_length-3),i.lookahead-=i.prev_length-1,i.prev_length-=2;do++i.strstart<=n&&(i.ins_h=Ra(i,i.ins_h,i.window[i.strstart+3-1]),t=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart);while(--i.prev_length!=0);if(i.match_available=0,i.match_length=2,i.strstart++,r&&(cn(i,!1),i.strm.avail_out===0))return 1}else if(i.match_available){if(r=va(i,0,i.window[i.strstart-1]),r&&cn(i,!1),i.strstart++,i.lookahead--,i.strm.avail_out===0)return 1}else i.match_available=1,i.strstart++,i.lookahead--}return i.match_available&&(r=va(i,0,i.window[i.strstart-1]),i.match_available=0),i.insert=i.strstart<2?i.strstart:2,e===Nn?(cn(i,!0),i.strm.avail_out===0?3:4):i.sym_next&&(cn(i,!1),i.strm.avail_out===0)?1:2};function Ss(i,e,t,r,n){this.good_length=i,this.max_lazy=e,this.nice_length=t,this.max_chain=r,this.func=n}let Nd=[new Ss(0,0,0,0,i0),new Ss(4,4,8,4,Lg),new Ss(4,5,16,8,Lg),new Ss(4,6,32,32,Lg),new Ss(4,4,16,16,tl),new Ss(8,16,32,32,tl),new Ss(8,16,128,128,tl),new Ss(8,32,128,256,tl),new Ss(32,128,258,1024,tl),new Ss(32,258,258,4096,tl)];function m4(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=gp,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*p4),this.dyn_dtree=new Uint16Array(2*(2*u4+1)),this.bl_tree=new Uint16Array(2*(2*h4+1)),Ca(this.dyn_ltree),Ca(this.dyn_dtree),Ca(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(f4+1),this.heap=new Uint16Array(2*Pg+1),Ca(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Pg+1),Ca(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}let bd=i=>{if(!i)return 1;let e=i.state;return!e||e.strm!==i||e.status!==Zc&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==ko&&e.status!==Ad?1:0},r0=i=>{if(bd(i))return Lo(i,Es);i.total_in=i.total_out=0,i.data_type=d4;let e=i.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?Zc:ko,i.adler=e.wrap===2?0:1,e.last_flush=-2,Z5(e),tr},n0=i=>{let e=r0(i);var t;return e===tr&&((t=i.state).window_size=2*t.w_size,Ca(t.head),t.max_lazy_match=Nd[t.level].max_lazy,t.good_match=Nd[t.level].good_length,t.nice_match=Nd[t.level].nice_length,t.max_chain_length=Nd[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),e},s0=(i,e,t,r,n,a)=>{if(!i)return Es;let c=1;if(e===s4&&(e=6),r<0?(c=0,r=-r):r>15&&(c=2,r-=16),n<1||n>9||t!==gp||r<8||r>15||e<0||e>9||a<0||a>c4||r===8&&c!==1)return Lo(i,Es);r===8&&(r=9);let l=new m4;return i.state=l,l.strm=i,l.status=Zc,l.wrap=c,l.gzhead=null,l.w_bits=r,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=n+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+3-1)/3),l.window=new Uint8Array(2*l.w_size),l.head=new Uint16Array(l.hash_size),l.prev=new Uint16Array(l.w_size),l.lit_bufsize=1<<n+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new Uint8Array(l.pending_buf_size),l.sym_buf=l.lit_bufsize,l.sym_end=3*(l.lit_bufsize-1),l.level=e,l.strategy=a,l.method=t,n0(i)};var E4=(i,e)=>{if(bd(i)||e>$O||e<0)return i?Lo(i,Es):Es;let t=i.state;if(!i.output||i.avail_in!==0&&!i.input||t.status===Ad&&e!==Nn)return Lo(i,i.avail_out===0?Dg:Es);let r=t.last_flush;if(t.last_flush=e,t.pending!==0){if(on(i),i.avail_out===0)return t.last_flush=-1,tr}else if(i.avail_in===0&&e0(e)<=e0(r)&&e!==Nn)return Lo(i,Dg);if(t.status===Ad&&i.avail_in!==0)return Lo(i,Dg);if(t.status===Zc&&t.wrap===0&&(t.status=ko),t.status===Zc){let n=gp+(t.w_bits-8<<4)<<8,a=-1;if(a=t.strategy>=Ep||t.level<2?0:t.level<6?1:t.level===6?2:3,n|=a<<6,t.strstart!==0&&(n|=32),n+=31-n%31,Od(t,n),t.strstart!==0&&(Od(t,i.adler>>>16),Od(t,65535&i.adler)),i.adler=1,t.status=ko,on(i),t.pending!==0)return t.last_flush=-1,tr}if(t.status===57){if(i.adler=0,wt(t,31),wt(t,139),wt(t,8),t.gzhead)wt(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),wt(t,255&t.gzhead.time),wt(t,t.gzhead.time>>8&255),wt(t,t.gzhead.time>>16&255),wt(t,t.gzhead.time>>24&255),wt(t,t.level===9?2:t.strategy>=Ep||t.level<2?4:0),wt(t,255&t.gzhead.os),t.gzhead.extra&&t.gzhead.extra.length&&(wt(t,255&t.gzhead.extra.length),wt(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(i.adler=Ji(i.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=69;else if(wt(t,0),wt(t,0),wt(t,0),wt(t,0),wt(t,0),wt(t,t.level===9?2:t.strategy>=Ep||t.level<2?4:0),wt(t,3),t.status=ko,on(i),t.pending!==0)return t.last_flush=-1,tr}if(t.status===69){if(t.gzhead.extra){let n=t.pending,a=(65535&t.gzhead.extra.length)-t.gzindex;for(;t.pending+a>t.pending_buf_size;){let l=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+l),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>n&&(i.adler=Ji(i.adler,t.pending_buf,t.pending-n,n)),t.gzindex+=l,on(i),t.pending!==0)return t.last_flush=-1,tr;n=0,a-=l}let c=new Uint8Array(t.gzhead.extra);t.pending_buf.set(c.subarray(t.gzindex,t.gzindex+a),t.pending),t.pending+=a,t.gzhead.hcrc&&t.pending>n&&(i.adler=Ji(i.adler,t.pending_buf,t.pending-n,n)),t.gzindex=0}t.status=73}if(t.status===73){if(t.gzhead.name){let n,a=t.pending;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>a&&(i.adler=Ji(i.adler,t.pending_buf,t.pending-a,a)),on(i),t.pending!==0)return t.last_flush=-1,tr;a=0}n=t.gzindex<t.gzhead.name.length?255&t.gzhead.name.charCodeAt(t.gzindex++):0,wt(t,n)}while(n!==0);t.gzhead.hcrc&&t.pending>a&&(i.adler=Ji(i.adler,t.pending_buf,t.pending-a,a)),t.gzindex=0}t.status=91}if(t.status===91){if(t.gzhead.comment){let n,a=t.pending;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>a&&(i.adler=Ji(i.adler,t.pending_buf,t.pending-a,a)),on(i),t.pending!==0)return t.last_flush=-1,tr;a=0}n=t.gzindex<t.gzhead.comment.length?255&t.gzhead.comment.charCodeAt(t.gzindex++):0,wt(t,n)}while(n!==0);t.gzhead.hcrc&&t.pending>a&&(i.adler=Ji(i.adler,t.pending_buf,t.pending-a,a))}t.status=103}if(t.status===103){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&(on(i),t.pending!==0))return t.last_flush=-1,tr;wt(t,255&i.adler),wt(t,i.adler>>8&255),i.adler=0}if(t.status=ko,on(i),t.pending!==0)return t.last_flush=-1,tr}if(i.avail_in!==0||t.lookahead!==0||e!==ya&&t.status!==Ad){let n=t.level===0?i0(t,e):t.strategy===Ep?((a,c)=>{let l;for(;;){if(a.lookahead===0&&(el(a),a.lookahead===0)){if(c===ya)return 1;break}if(a.match_length=0,l=va(a,0,a.window[a.strstart]),a.lookahead--,a.strstart++,l&&(cn(a,!1),a.strm.avail_out===0))return 1}return a.insert=0,c===Nn?(cn(a,!0),a.strm.avail_out===0?3:4):a.sym_next&&(cn(a,!1),a.strm.avail_out===0)?1:2})(t,e):t.strategy===o4?((a,c)=>{let l,u,h,p,_=a.window;for(;;){if(a.lookahead<=Po){if(el(a),a.lookahead<=Po&&c===ya)return 1;if(a.lookahead===0)break}if(a.match_length=0,a.lookahead>=3&&a.strstart>0&&(h=a.strstart-1,u=_[h],u===_[++h]&&u===_[++h]&&u===_[++h])){p=a.strstart+Po;do;while(u===_[++h]&&u===_[++h]&&u===_[++h]&&u===_[++h]&&u===_[++h]&&u===_[++h]&&u===_[++h]&&u===_[++h]&&h<p);a.match_length=Po-(p-h),a.match_length>a.lookahead&&(a.match_length=a.lookahead)}if(a.match_length>=3?(l=va(a,1,a.match_length-3),a.lookahead-=a.match_length,a.strstart+=a.match_length,a.match_length=0):(l=va(a,0,a.window[a.strstart]),a.lookahead--,a.strstart++),l&&(cn(a,!1),a.strm.avail_out===0))return 1}return a.insert=0,c===Nn?(cn(a,!0),a.strm.avail_out===0?3:4):a.sym_next&&(cn(a,!1),a.strm.avail_out===0)?1:2})(t,e):Nd[t.level].func(t,e);if(n!==3&&n!==4||(t.status=Ad),n===1||n===3)return i.avail_out===0&&(t.last_flush=-1),tr;if(n===2&&(e===i4?t4(t):e!==$O&&(bg(t,0,0,!1),e===r4&&(Ca(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),on(i),i.avail_out===0))return t.last_flush=-1,tr}return e!==Nn?tr:t.wrap<=0?ZO:(t.wrap===2?(wt(t,255&i.adler),wt(t,i.adler>>8&255),wt(t,i.adler>>16&255),wt(t,i.adler>>24&255),wt(t,255&i.total_in),wt(t,i.total_in>>8&255),wt(t,i.total_in>>16&255),wt(t,i.total_in>>24&255)):(Od(t,i.adler>>>16),Od(t,65535&i.adler)),on(i),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?tr:ZO)},g4=(i,e)=>{let t=e.length;if(bd(i))return Es;let r=i.state,n=r.wrap;if(n===2||n===1&&r.status!==Zc||r.lookahead)return Es;if(n===1&&(i.adler=wd(i.adler,e,t,0)),r.wrap=0,t>=r.w_size){n===0&&(Ca(r.head),r.strstart=0,r.block_start=0,r.insert=0);let u=new Uint8Array(r.w_size);u.set(e.subarray(t-r.w_size,t),0),e=u,t=r.w_size}let a=i.avail_in,c=i.next_in,l=i.input;for(i.avail_in=t,i.next_in=0,i.input=e,el(r);r.lookahead>=3;){let u=r.strstart,h=r.lookahead-2;do r.ins_h=Ra(r,r.ins_h,r.window[u+3-1]),r.prev[u&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=u,u++;while(--h);r.strstart=u,r.lookahead=2,el(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=2,r.match_available=0,i.next_in=c,i.input=l,i.avail_in=a,r.wrap=n,tr},Dd={deflateInit:(i,e)=>s0(i,e,gp,15,8,l4),deflateInit2:s0,deflateReset:n0,deflateResetKeep:r0,deflateSetHeader:(i,e)=>bd(i)||i.state.wrap!==2?Es:(i.state.gzhead=e,tr),deflate:E4,deflateEnd:i=>{if(bd(i))return Es;let e=i.state.status;return i.state=null,e===ko?Lo(i,n4):tr},deflateSetDictionary:g4,deflateInfo:"pako deflate (from Nodeca project)"};let S4=(i,e)=>Object.prototype.hasOwnProperty.call(i,e);var Sp={assign:function(i){let e=Array.prototype.slice.call(arguments,1);for(;e.length;){let t=e.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(let r in t)S4(t,r)&&(i[r]=t[r])}}return i},flattenChunks:i=>{let e=0;for(let r=0,n=i.length;r<n;r++)e+=i[r].length;let t=new Uint8Array(e);for(let r=0,n=0,a=i.length;r<a;r++){let c=i[r];t.set(c,n),n+=c.length}return t}};let a0=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{a0=!1}let Pd=new Uint8Array(256);for(let i=0;i<256;i++)Pd[i]=i>=252?6:i>=248?5:i>=240?4:i>=224?3:i>=192?2:1;Pd[254]=Pd[254]=1;var kd={string2buf:i=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(i);let e,t,r,n,a,c=i.length,l=0;for(n=0;n<c;n++)t=i.charCodeAt(n),(64512&t)==55296&&n+1<c&&(r=i.charCodeAt(n+1),(64512&r)==56320&&(t=65536+(t-55296<<10)+(r-56320),n++)),l+=t<128?1:t<2048?2:t<65536?3:4;for(e=new Uint8Array(l),a=0,n=0;a<l;n++)t=i.charCodeAt(n),(64512&t)==55296&&n+1<c&&(r=i.charCodeAt(n+1),(64512&r)==56320&&(t=65536+(t-55296<<10)+(r-56320),n++)),t<128?e[a++]=t:t<2048?(e[a++]=192|t>>>6,e[a++]=128|63&t):t<65536?(e[a++]=224|t>>>12,e[a++]=128|t>>>6&63,e[a++]=128|63&t):(e[a++]=240|t>>>18,e[a++]=128|t>>>12&63,e[a++]=128|t>>>6&63,e[a++]=128|63&t);return e},buf2string:(i,e)=>{let t=e||i.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(i.subarray(0,e));let r,n,a=new Array(2*t);for(n=0,r=0;r<t;){let c=i[r++];if(c<128){a[n++]=c;continue}let l=Pd[c];if(l>4)a[n++]=65533,r+=l-1;else{for(c&=l===2?31:l===3?15:7;l>1&&r<t;)c=c<<6|63&i[r++],l--;l>1?a[n++]=65533:c<65536?a[n++]=c:(c-=65536,a[n++]=55296|c>>10&1023,a[n++]=56320|1023&c)}}return((c,l)=>{if(l<65534&&c.subarray&&a0)return String.fromCharCode.apply(null,c.length===l?c:c.subarray(0,l));let u="";for(let h=0;h<l;h++)u+=String.fromCharCode(c[h]);return u})(a,n)},utf8border:(i,e)=>{(e=e||i.length)>i.length&&(e=i.length);let t=e-1;for(;t>=0&&(192&i[t])==128;)t--;return t<0||t===0?e:t+Pd[i[t]]>e?t:e}},o0=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};let c0=Object.prototype.toString,{Z_NO_FLUSH:T4,Z_SYNC_FLUSH:v4,Z_FULL_FLUSH:y4,Z_FINISH:C4,Z_OK:Tp,Z_STREAM_END:R4,Z_DEFAULT_COMPRESSION:I4,Z_DEFAULT_STRATEGY:w4,Z_DEFLATED:A4}=$c;function Ld(i){this.options=Sp.assign({level:I4,method:A4,chunkSize:16384,windowBits:15,memLevel:8,strategy:w4},i||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new o0,this.strm.avail_out=0;let t=Dd.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(t!==Tp)throw new Error(Do[t]);if(e.header&&Dd.deflateSetHeader(this.strm,e.header),e.dictionary){let r;if(r=typeof e.dictionary=="string"?kd.string2buf(e.dictionary):c0.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,t=Dd.deflateSetDictionary(this.strm,r),t!==Tp)throw new Error(Do[t]);this._dict_set=!0}}function Mg(i,e){let t=new Ld(e);if(t.push(i,!0),t.err)throw t.msg||Do[t.err];return t.result}Ld.prototype.push=function(i,e){let t=this.strm,r=this.options.chunkSize,n,a;if(this.ended)return!1;for(a=e===~~e?e:e===!0?C4:T4,typeof i=="string"?t.input=kd.string2buf(i):c0.call(i)==="[object ArrayBuffer]"?t.input=new Uint8Array(i):t.input=i,t.next_in=0,t.avail_in=t.input.length;;)if(t.avail_out===0&&(t.output=new Uint8Array(r),t.next_out=0,t.avail_out=r),(a===v4||a===y4)&&t.avail_out<=6)this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;else{if(n=Dd.deflate(t,a),n===R4)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),n=Dd.deflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===Tp;if(t.avail_out!==0){if(a>0&&t.next_out>0)this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;else if(t.avail_in===0)break}else this.onData(t.output)}return!0},Ld.prototype.onData=function(i){this.chunks.push(i)},Ld.prototype.onEnd=function(i){i===Tp&&(this.result=Sp.flattenChunks(this.chunks)),this.chunks=[],this.err=i,this.msg=this.strm.msg};var O4={Deflate:Ld,deflate:Mg,deflateRaw:function(i,e){return(e=e||{}).raw=!0,Mg(i,e)},gzip:function(i,e){return(e=e||{}).gzip=!0,Mg(i,e)},constants:$c};let vp=16209;var N4=function(i,e){let t,r,n,a,c,l,u,h,p,_,E,T,w,C,O,b,k,U,X,z,j,B,W,ce,ne=i.state;t=i.next_in,W=i.input,r=t+(i.avail_in-5),n=i.next_out,ce=i.output,a=n-(e-i.avail_out),c=n+(i.avail_out-257),l=ne.dmax,u=ne.wsize,h=ne.whave,p=ne.wnext,_=ne.window,E=ne.hold,T=ne.bits,w=ne.lencode,C=ne.distcode,O=(1<<ne.lenbits)-1,b=(1<<ne.distbits)-1;e:do{T<15&&(E+=W[t++]<<T,T+=8,E+=W[t++]<<T,T+=8),k=w[E&O];t:for(;;){if(U=k>>>24,E>>>=U,T-=U,U=k>>>16&255,U===0)ce[n++]=65535&k;else{if(!(16&U)){if(!(64&U)){k=w[(65535&k)+(E&(1<<U)-1)];continue t}if(32&U){ne.mode=16191;break e}i.msg="invalid literal/length code",ne.mode=vp;break e}X=65535&k,U&=15,U&&(T<U&&(E+=W[t++]<<T,T+=8),X+=E&(1<<U)-1,E>>>=U,T-=U),T<15&&(E+=W[t++]<<T,T+=8,E+=W[t++]<<T,T+=8),k=C[E&b];i:for(;;){if(U=k>>>24,E>>>=U,T-=U,U=k>>>16&255,!(16&U)){if(!(64&U)){k=C[(65535&k)+(E&(1<<U)-1)];continue i}i.msg="invalid distance code",ne.mode=vp;break e}if(z=65535&k,U&=15,T<U&&(E+=W[t++]<<T,T+=8,T<U&&(E+=W[t++]<<T,T+=8)),z+=E&(1<<U)-1,z>l){i.msg="invalid distance too far back",ne.mode=vp;break e}if(E>>>=U,T-=U,U=n-a,z>U){if(U=z-U,U>h&&ne.sane){i.msg="invalid distance too far back",ne.mode=vp;break e}if(j=0,B=_,p===0){if(j+=u-U,U<X){X-=U;do ce[n++]=_[j++];while(--U);j=n-z,B=ce}}else if(p<U){if(j+=u+p-U,U-=p,U<X){X-=U;do ce[n++]=_[j++];while(--U);if(j=0,p<X){U=p,X-=U;do ce[n++]=_[j++];while(--U);j=n-z,B=ce}}}else if(j+=p-U,U<X){X-=U;do ce[n++]=_[j++];while(--U);j=n-z,B=ce}for(;X>2;)ce[n++]=B[j++],ce[n++]=B[j++],ce[n++]=B[j++],X-=3;X&&(ce[n++]=B[j++],X>1&&(ce[n++]=B[j++]))}else{j=n-z;do ce[n++]=ce[j++],ce[n++]=ce[j++],ce[n++]=ce[j++],X-=3;while(X>2);X&&(ce[n++]=ce[j++],X>1&&(ce[n++]=ce[j++]))}break}}break}}while(t<r&&n<c);X=T>>3,t-=X,T-=X<<3,E&=(1<<T)-1,i.next_in=t,i.next_out=n,i.avail_in=t<r?r-t+5:5-(t-r),i.avail_out=n<c?c-n+257:257-(n-c),ne.hold=E,ne.bits=T};let yp=15,b4=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),D4=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),P4=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),k4=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Md=(i,e,t,r,n,a,c,l)=>{let u=l.bits,h,p,_,E,T,w,C=0,O=0,b=0,k=0,U=0,X=0,z=0,j=0,B=0,W=0,ce=null,ne=new Uint16Array(16),Pe=new Uint16Array(16),We,It,Gt,pt=null;for(C=0;C<=yp;C++)ne[C]=0;for(O=0;O<r;O++)ne[e[t+O]]++;for(U=u,k=yp;k>=1&&ne[k]===0;k--);if(U>k&&(U=k),k===0)return n[a++]=20971520,n[a++]=20971520,l.bits=1,0;for(b=1;b<k&&ne[b]===0;b++);for(U<b&&(U=b),j=1,C=1;C<=yp;C++)if(j<<=1,j-=ne[C],j<0)return-1;if(j>0&&(i===0||k!==1))return-1;for(Pe[1]=0,C=1;C<yp;C++)Pe[C+1]=Pe[C]+ne[C];for(O=0;O<r;O++)e[t+O]!==0&&(c[Pe[e[t+O]]++]=O);if(i===0?(ce=pt=c,w=20):i===1?(ce=b4,pt=D4,w=257):(ce=P4,pt=k4,w=0),W=0,O=0,C=b,T=a,X=U,z=0,_=-1,B=1<<U,E=B-1,i===1&&B>852||i===2&&B>592)return 1;for(;;){We=C-z,c[O]+1<w?(It=0,Gt=c[O]):c[O]>=w?(It=pt[c[O]-w],Gt=ce[c[O]-w]):(It=96,Gt=0),h=1<<C-z,p=1<<X,b=p;do p-=h,n[T+(W>>z)+p]=We<<24|It<<16|Gt|0;while(p!==0);for(h=1<<C-1;W&h;)h>>=1;if(h!==0?(W&=h-1,W+=h):W=0,O++,--ne[C]==0){if(C===k)break;C=e[t+c[O]]}if(C>U&&(W&E)!==_){for(z===0&&(z=U),T+=b,X=C-z,j=1<<X;X+z<k&&(j-=ne[X+z],!(j<=0));)X++,j<<=1;if(B+=1<<X,i===1&&B>852||i===2&&B>592)return 1;_=W&E,n[_]=U<<24|X<<16|T-a|0}}return W!==0&&(n[T+W]=C-z<<24|64<<16|0),l.bits=U,0};let{Z_FINISH:l0,Z_BLOCK:L4,Z_TREES:Cp,Z_OK:Mo,Z_STREAM_END:M4,Z_NEED_DICT:U4,Z_STREAM_ERROR:bn,Z_DATA_ERROR:d0,Z_MEM_ERROR:u0,Z_BUF_ERROR:x4,Z_DEFLATED:h0}=$c,Rp=16180,Ip=16190,Fs=16191,Ug=16192,xg=16194,wp=16199,Ap=16200,Vg=16206,ci=16209,p0=i=>(i>>>24&255)+(i>>>8&65280)+((65280&i)<<8)+((255&i)<<24);function V4(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}let Uo=i=>{if(!i)return 1;let e=i.state;return!e||e.strm!==i||e.mode<Rp||e.mode>16211?1:0},f0=i=>{if(Uo(i))return bn;let e=i.state;return i.total_in=i.total_out=e.total=0,i.msg="",e.wrap&&(i.adler=1&e.wrap),e.mode=Rp,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,Mo},_0=i=>{if(Uo(i))return bn;let e=i.state;return e.wsize=0,e.whave=0,e.wnext=0,f0(i)},m0=(i,e)=>{let t;if(Uo(i))return bn;let r=i.state;return e<0?(t=0,e=-e):(t=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?bn:(r.window!==null&&r.wbits!==e&&(r.window=null),r.wrap=t,r.wbits=e,_0(i))},E0=(i,e)=>{if(!i)return bn;let t=new V4;i.state=t,t.strm=i,t.window=null,t.mode=Rp;let r=m0(i,e);return r!==Mo&&(i.state=null),r},Fg,jg,g0=!0,F4=i=>{if(g0){Fg=new Int32Array(512),jg=new Int32Array(32);let e=0;for(;e<144;)i.lens[e++]=8;for(;e<256;)i.lens[e++]=9;for(;e<280;)i.lens[e++]=7;for(;e<288;)i.lens[e++]=8;for(Md(1,i.lens,0,288,Fg,0,i.work,{bits:9}),e=0;e<32;)i.lens[e++]=5;Md(2,i.lens,0,32,jg,0,i.work,{bits:5}),g0=!1}i.lencode=Fg,i.lenbits=9,i.distcode=jg,i.distbits=5},S0=(i,e,t,r)=>{let n,a=i.state;return a.window===null&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new Uint8Array(a.wsize)),r>=a.wsize?(a.window.set(e.subarray(t-a.wsize,t),0),a.wnext=0,a.whave=a.wsize):(n=a.wsize-a.wnext,n>r&&(n=r),a.window.set(e.subarray(t-r,t-r+n),a.wnext),(r-=n)?(a.window.set(e.subarray(t-r,t),0),a.wnext=r,a.whave=a.wsize):(a.wnext+=n,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=n))),0};var j4=(i,e)=>{let t,r,n,a,c,l,u,h,p,_,E,T,w,C,O,b,k,U,X,z,j,B,W=0,ce=new Uint8Array(4),ne,Pe,We=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Uo(i)||!i.output||!i.input&&i.avail_in!==0)return bn;t=i.state,t.mode===Fs&&(t.mode=Ug),c=i.next_out,n=i.output,u=i.avail_out,a=i.next_in,r=i.input,l=i.avail_in,h=t.hold,p=t.bits,_=l,E=u,B=Mo;e:for(;;)switch(t.mode){case Rp:if(t.wrap===0){t.mode=Ug;break}for(;p<16;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if(2&t.wrap&&h===35615){t.wbits===0&&(t.wbits=15),t.check=0,ce[0]=255&h,ce[1]=h>>>8&255,t.check=Ji(t.check,ce,2,0),h=0,p=0,t.mode=16181;break}if(t.head&&(t.head.done=!1),!(1&t.wrap)||(((255&h)<<8)+(h>>8))%31){i.msg="incorrect header check",t.mode=ci;break}if((15&h)!==h0){i.msg="unknown compression method",t.mode=ci;break}if(h>>>=4,p-=4,j=8+(15&h),t.wbits===0&&(t.wbits=j),j>15||j>t.wbits){i.msg="invalid window size",t.mode=ci;break}t.dmax=1<<t.wbits,t.flags=0,i.adler=t.check=1,t.mode=512&h?16189:Fs,h=0,p=0;break;case 16181:for(;p<16;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if(t.flags=h,(255&t.flags)!==h0){i.msg="unknown compression method",t.mode=ci;break}if(57344&t.flags){i.msg="unknown header flags set",t.mode=ci;break}t.head&&(t.head.text=h>>8&1),512&t.flags&&4&t.wrap&&(ce[0]=255&h,ce[1]=h>>>8&255,t.check=Ji(t.check,ce,2,0)),h=0,p=0,t.mode=16182;case 16182:for(;p<32;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}t.head&&(t.head.time=h),512&t.flags&&4&t.wrap&&(ce[0]=255&h,ce[1]=h>>>8&255,ce[2]=h>>>16&255,ce[3]=h>>>24&255,t.check=Ji(t.check,ce,4,0)),h=0,p=0,t.mode=16183;case 16183:for(;p<16;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}t.head&&(t.head.xflags=255&h,t.head.os=h>>8),512&t.flags&&4&t.wrap&&(ce[0]=255&h,ce[1]=h>>>8&255,t.check=Ji(t.check,ce,2,0)),h=0,p=0,t.mode=16184;case 16184:if(1024&t.flags){for(;p<16;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}t.length=h,t.head&&(t.head.extra_len=h),512&t.flags&&4&t.wrap&&(ce[0]=255&h,ce[1]=h>>>8&255,t.check=Ji(t.check,ce,2,0)),h=0,p=0}else t.head&&(t.head.extra=null);t.mode=16185;case 16185:if(1024&t.flags&&(T=t.length,T>l&&(T=l),T&&(t.head&&(j=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(r.subarray(a,a+T),j)),512&t.flags&&4&t.wrap&&(t.check=Ji(t.check,r,T,a)),l-=T,a+=T,t.length-=T),t.length))break e;t.length=0,t.mode=16186;case 16186:if(2048&t.flags){if(l===0)break e;T=0;do j=r[a+T++],t.head&&j&&t.length<65536&&(t.head.name+=String.fromCharCode(j));while(j&&T<l);if(512&t.flags&&4&t.wrap&&(t.check=Ji(t.check,r,T,a)),l-=T,a+=T,j)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=16187;case 16187:if(4096&t.flags){if(l===0)break e;T=0;do j=r[a+T++],t.head&&j&&t.length<65536&&(t.head.comment+=String.fromCharCode(j));while(j&&T<l);if(512&t.flags&&4&t.wrap&&(t.check=Ji(t.check,r,T,a)),l-=T,a+=T,j)break e}else t.head&&(t.head.comment=null);t.mode=16188;case 16188:if(512&t.flags){for(;p<16;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if(4&t.wrap&&h!==(65535&t.check)){i.msg="header crc mismatch",t.mode=ci;break}h=0,p=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),i.adler=t.check=0,t.mode=Fs;break;case 16189:for(;p<32;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}i.adler=t.check=p0(h),h=0,p=0,t.mode=Ip;case Ip:if(t.havedict===0)return i.next_out=c,i.avail_out=u,i.next_in=a,i.avail_in=l,t.hold=h,t.bits=p,U4;i.adler=t.check=1,t.mode=Fs;case Fs:if(e===L4||e===Cp)break e;case Ug:if(t.last){h>>>=7&p,p-=7&p,t.mode=Vg;break}for(;p<3;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}switch(t.last=1&h,h>>>=1,p-=1,3&h){case 0:t.mode=16193;break;case 1:if(F4(t),t.mode=wp,e===Cp){h>>>=2,p-=2;break e}break;case 2:t.mode=16196;break;case 3:i.msg="invalid block type",t.mode=ci}h>>>=2,p-=2;break;case 16193:for(h>>>=7&p,p-=7&p;p<32;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if((65535&h)!=(h>>>16^65535)){i.msg="invalid stored block lengths",t.mode=ci;break}if(t.length=65535&h,h=0,p=0,t.mode=xg,e===Cp)break e;case xg:t.mode=16195;case 16195:if(T=t.length,T){if(T>l&&(T=l),T>u&&(T=u),T===0)break e;n.set(r.subarray(a,a+T),c),l-=T,a+=T,u-=T,c+=T,t.length-=T;break}t.mode=Fs;break;case 16196:for(;p<14;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if(t.nlen=257+(31&h),h>>>=5,p-=5,t.ndist=1+(31&h),h>>>=5,p-=5,t.ncode=4+(15&h),h>>>=4,p-=4,t.nlen>286||t.ndist>30){i.msg="too many length or distance symbols",t.mode=ci;break}t.have=0,t.mode=16197;case 16197:for(;t.have<t.ncode;){for(;p<3;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}t.lens[We[t.have++]]=7&h,h>>>=3,p-=3}for(;t.have<19;)t.lens[We[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,ne={bits:t.lenbits},B=Md(0,t.lens,0,19,t.lencode,0,t.work,ne),t.lenbits=ne.bits,B){i.msg="invalid code lengths set",t.mode=ci;break}t.have=0,t.mode=16198;case 16198:for(;t.have<t.nlen+t.ndist;){for(;W=t.lencode[h&(1<<t.lenbits)-1],O=W>>>24,b=W>>>16&255,k=65535&W,!(O<=p);){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if(k<16)h>>>=O,p-=O,t.lens[t.have++]=k;else{if(k===16){for(Pe=O+2;p<Pe;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if(h>>>=O,p-=O,t.have===0){i.msg="invalid bit length repeat",t.mode=ci;break}j=t.lens[t.have-1],T=3+(3&h),h>>>=2,p-=2}else if(k===17){for(Pe=O+3;p<Pe;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}h>>>=O,p-=O,j=0,T=3+(7&h),h>>>=3,p-=3}else{for(Pe=O+7;p<Pe;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}h>>>=O,p-=O,j=0,T=11+(127&h),h>>>=7,p-=7}if(t.have+T>t.nlen+t.ndist){i.msg="invalid bit length repeat",t.mode=ci;break}for(;T--;)t.lens[t.have++]=j}}if(t.mode===ci)break;if(t.lens[256]===0){i.msg="invalid code -- missing end-of-block",t.mode=ci;break}if(t.lenbits=9,ne={bits:t.lenbits},B=Md(1,t.lens,0,t.nlen,t.lencode,0,t.work,ne),t.lenbits=ne.bits,B){i.msg="invalid literal/lengths set",t.mode=ci;break}if(t.distbits=6,t.distcode=t.distdyn,ne={bits:t.distbits},B=Md(2,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,ne),t.distbits=ne.bits,B){i.msg="invalid distances set",t.mode=ci;break}if(t.mode=wp,e===Cp)break e;case wp:t.mode=Ap;case Ap:if(l>=6&&u>=258){i.next_out=c,i.avail_out=u,i.next_in=a,i.avail_in=l,t.hold=h,t.bits=p,N4(i,E),c=i.next_out,n=i.output,u=i.avail_out,a=i.next_in,r=i.input,l=i.avail_in,h=t.hold,p=t.bits,t.mode===Fs&&(t.back=-1);break}for(t.back=0;W=t.lencode[h&(1<<t.lenbits)-1],O=W>>>24,b=W>>>16&255,k=65535&W,!(O<=p);){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if(b&&!(240&b)){for(U=O,X=b,z=k;W=t.lencode[z+((h&(1<<U+X)-1)>>U)],O=W>>>24,b=W>>>16&255,k=65535&W,!(U+O<=p);){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}h>>>=U,p-=U,t.back+=U}if(h>>>=O,p-=O,t.back+=O,t.length=k,b===0){t.mode=16205;break}if(32&b){t.back=-1,t.mode=Fs;break}if(64&b){i.msg="invalid literal/length code",t.mode=ci;break}t.extra=15&b,t.mode=16201;case 16201:if(t.extra){for(Pe=t.extra;p<Pe;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}t.length+=h&(1<<t.extra)-1,h>>>=t.extra,p-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=16202;case 16202:for(;W=t.distcode[h&(1<<t.distbits)-1],O=W>>>24,b=W>>>16&255,k=65535&W,!(O<=p);){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if(!(240&b)){for(U=O,X=b,z=k;W=t.distcode[z+((h&(1<<U+X)-1)>>U)],O=W>>>24,b=W>>>16&255,k=65535&W,!(U+O<=p);){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}h>>>=U,p-=U,t.back+=U}if(h>>>=O,p-=O,t.back+=O,64&b){i.msg="invalid distance code",t.mode=ci;break}t.offset=k,t.extra=15&b,t.mode=16203;case 16203:if(t.extra){for(Pe=t.extra;p<Pe;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}t.offset+=h&(1<<t.extra)-1,h>>>=t.extra,p-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){i.msg="invalid distance too far back",t.mode=ci;break}t.mode=16204;case 16204:if(u===0)break e;if(T=E-u,t.offset>T){if(T=t.offset-T,T>t.whave&&t.sane){i.msg="invalid distance too far back",t.mode=ci;break}T>t.wnext?(T-=t.wnext,w=t.wsize-T):w=t.wnext-T,T>t.length&&(T=t.length),C=t.window}else C=n,w=c-t.offset,T=t.length;T>u&&(T=u),u-=T,t.length-=T;do n[c++]=C[w++];while(--T);t.length===0&&(t.mode=Ap);break;case 16205:if(u===0)break e;n[c++]=t.length,u--,t.mode=Ap;break;case Vg:if(t.wrap){for(;p<32;){if(l===0)break e;l--,h|=r[a++]<<p,p+=8}if(E-=u,i.total_out+=E,t.total+=E,4&t.wrap&&E&&(i.adler=t.check=t.flags?Ji(t.check,n,E,c-E):wd(t.check,n,E,c-E)),E=u,4&t.wrap&&(t.flags?h:p0(h))!==t.check){i.msg="incorrect data check",t.mode=ci;break}h=0,p=0}t.mode=16207;case 16207:if(t.wrap&&t.flags){for(;p<32;){if(l===0)break e;l--,h+=r[a++]<<p,p+=8}if(4&t.wrap&&h!==(4294967295&t.total)){i.msg="incorrect length check",t.mode=ci;break}h=0,p=0}t.mode=16208;case 16208:B=M4;break e;case ci:B=d0;break e;case 16210:return u0;default:return bn}return i.next_out=c,i.avail_out=u,i.next_in=a,i.avail_in=l,t.hold=h,t.bits=p,(t.wsize||E!==i.avail_out&&t.mode<ci&&(t.mode<Vg||e!==l0))&&S0(i,i.output,i.next_out,E-i.avail_out),_-=i.avail_in,E-=i.avail_out,i.total_in+=_,i.total_out+=E,t.total+=E,4&t.wrap&&E&&(i.adler=t.check=t.flags?Ji(t.check,n,E,i.next_out-E):wd(t.check,n,E,i.next_out-E)),i.data_type=t.bits+(t.last?64:0)+(t.mode===Fs?128:0)+(t.mode===wp||t.mode===xg?256:0),(_===0&&E===0||e===l0)&&B===Mo&&(B=x4),B},js={inflateReset:_0,inflateReset2:m0,inflateResetKeep:f0,inflateInit:i=>E0(i,15),inflateInit2:E0,inflate:j4,inflateEnd:i=>{if(Uo(i))return bn;let e=i.state;return e.window&&(e.window=null),i.state=null,Mo},inflateGetHeader:(i,e)=>{if(Uo(i))return bn;let t=i.state;return 2&t.wrap?(t.head=e,e.done=!1,Mo):bn},inflateSetDictionary:(i,e)=>{let t=e.length,r,n,a;return Uo(i)?bn:(r=i.state,r.wrap!==0&&r.mode!==Ip?bn:r.mode===Ip&&(n=1,n=wd(n,e,t,0),n!==r.check)?d0:(a=S0(i,e,t,t),a?(r.mode=16210,u0):(r.havedict=1,Mo)))},inflateInfo:"pako inflate (from Nodeca project)"},B4=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};let T0=Object.prototype.toString,{Z_NO_FLUSH:G4,Z_FINISH:W4,Z_OK:Ud,Z_STREAM_END:Bg,Z_NEED_DICT:Gg,Z_STREAM_ERROR:H4,Z_DATA_ERROR:v0,Z_MEM_ERROR:K4}=$c;function xd(i){this.options=Sp.assign({chunkSize:65536,windowBits:15,to:""},i||{});let e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||i&&i.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new o0,this.strm.avail_out=0;let t=js.inflateInit2(this.strm,e.windowBits);if(t!==Ud)throw new Error(Do[t]);if(this.header=new B4,js.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=kd.string2buf(e.dictionary):T0.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(t=js.inflateSetDictionary(this.strm,e.dictionary),t!==Ud)))throw new Error(Do[t])}function Wg(i,e){let t=new xd(e);if(t.push(i),t.err)throw t.msg||Do[t.err];return t.result}xd.prototype.push=function(i,e){let t=this.strm,r=this.options.chunkSize,n=this.options.dictionary,a,c,l;if(this.ended)return!1;for(c=e===~~e?e:e===!0?W4:G4,T0.call(i)==="[object ArrayBuffer]"?t.input=new Uint8Array(i):t.input=i,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(r),t.next_out=0,t.avail_out=r),a=js.inflate(t,c),a===Gg&&n&&(a=js.inflateSetDictionary(t,n),a===Ud?a=js.inflate(t,c):a===v0&&(a=Gg));t.avail_in>0&&a===Bg&&t.state.wrap>0&&i[t.next_in]!==0;)js.inflateReset(t),a=js.inflate(t,c);switch(a){case H4:case v0:case Gg:case K4:return this.onEnd(a),this.ended=!0,!1}if(l=t.avail_out,t.next_out&&(t.avail_out===0||a===Bg))if(this.options.to==="string"){let u=kd.utf8border(t.output,t.next_out),h=t.next_out-u,p=kd.buf2string(t.output,u);t.next_out=h,t.avail_out=r-h,h&&t.output.set(t.output.subarray(u,u+h),0),this.onData(p)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(a!==Ud||l!==0){if(a===Bg)return a=js.inflateEnd(this.strm),this.onEnd(a),this.ended=!0,!0;if(t.avail_in===0)break}}return!0},xd.prototype.onData=function(i){this.chunks.push(i)},xd.prototype.onEnd=function(i){i===Ud&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Sp.flattenChunks(this.chunks)),this.chunks=[],this.err=i,this.msg=this.strm.msg};var z4={Inflate:xd,inflate:Wg,inflateRaw:function(i,e){return(e=e||{}).raw=!0,Wg(i,e)},ungzip:Wg,constants:$c};let{Deflate:pK,deflate:Y4,deflateRaw:fK,gzip:_K}=O4,{Inflate:mK,inflate:q4,inflateRaw:EK,ungzip:gK}=z4;var Hg,J4=Y4,X4=q4;(function(i){i[i.ONE_BYTE=0]="ONE_BYTE",i[i.TWO_BYTE=1]="TWO_BYTE"})(Hg||(Hg={}));class Q4{constructor(){g(this,"_sequence",0),g(this,"_startTime",Date.now()),g(this,"isUseOneByte",!0)}get startTime(){let e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){let t={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){let l=new Uint8Array(4);l.set([1,0,0,0]);let u={id:0,length:4,data:l.buffer},h={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[u]};t.commonPacketHeader.extension=1,t.extension=h,t.payload=this.compress(e),t.commonPacketHeader.length=8+(t.extension.length+2)+t.payload.byteLength}else t.commonPacketHeader.length=8+t.payload.byteLength;let r=new ArrayBuffer(t.commonPacketHeader.length),n=new Uint8Array(r),a=new DataView(r),c=0;if(a.setUint16(c,t.commonPacketHeader.extension<<15|t.commonPacketHeader.reserved<<14|t.commonPacketHeader.length,!0),c+=2,a.setUint32(c,t.commonPacketHeader.sequence,!0),c+=4,a.setUint16(c,t.commonStreamHeader,!0),c+=2,t.extension){let l=this.serializeExtension(t.extension);n.set(new Uint8Array(l),c),c+=l.byteLength}if(n.set(new Uint8Array(t.payload),c),c+=t.payload.byteLength,c!==t.commonPacketHeader.length)throw Error("serialize error!");return r}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);let t=new DataView(e),r=0,n=t.getUint16(r,!0);r+=2;let a=(32768&n)>>15;t.getUint16(r+2,!0),t.getUint16(r,!0);let c,l;if(r+=4,t.getUint16(r,!0),r+=2,a){l=this.deserializeExtension(e.slice(r)),r+=2+l.length,c=e.slice(r);let u=!1;if(l.datas.length>0){let h=l.datas.find(p=>p.id===0);h&&(u=(1&new DataView(h.data).getUint32(0,!0))==1)}c=u?this.decompress(c):c}else c=e.slice(8);return c}serializeExtension(e){let{profile:t,length:r,datas:n}=e,a=new ArrayBuffer(r+2),c=new Uint8Array(a),l=new DataView(a),u=0;if(l.setUint8(u++,t),l.setUint8(u++,r),n.forEach(h=>{t?(l.setUint8(u++,h.id),l.setUint8(u++,h.length),c.set(new Uint8Array(h.data),u),u+=h.data.byteLength):(l.setUint8(u++,h.id|h.length<<4),c.set(new Uint8Array(h.data),u),u+=h.data.byteLength)}),u!==r+2)throw Error("serialize extension error, is ".concat(u,"!==").concat(r+2));return a}deserializeExtension(e){let t=new DataView(e),r=0,n=t.getUint8(r);r++;let a=t.getUint8(r);r++;let c=n===Hg.TWO_BYTE,l=[],u=new DataView(e,2),h=0;for(;h<a;){let p=0,_=0,E=new ArrayBuffer(0);c?(p=u.getUint8(h),h++,_=u.getUint8(h),h++):(p=15&u.getUint8(h),_=u.getUint8(h)>>4,h++),_>0&&(E=u.buffer.slice(h+2,h+2+_),h+=E.byteLength),l.push({id:p,length:_,data:E})}if(h!==a)throw Error("parse error");return{profile:n,length:a,datas:l}}decompress(e){return X4(new Uint8Array(e))}compress(e){return J4(new Uint8Array(e))}}class y0 extends mt{constructor(e,t){super(),g(this,"_version",1),g(this,"_type",3),g(this,"_config",void 0),g(this,"_originDataChannel",void 0),g(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),g(this,"_dataStreamPacketHandler",void 0),g(this,"_datachannelEventMap",new Map),this._config=e,t&&(this._originDataChannel=t,this._bandDataChannelEvents(t)),this._initPacketHeader(),this._dataStreamPacketHandler=new Q4}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return P("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,t;return(e=(t=this._originDataChannel)===null||t===void 0?void 0:t.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,t;return(e=(t=this._originDataChannel)===null||t===void 0?void 0:t.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new F((e,t)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();let r=setTimeout(()=>{var n;t(new Y(A.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((n=this._originDataChannel)===null||n===void 0?void 0:n.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(r),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(r),new Y(A.DATACHANNEL_CONNECTION_TIMEOUT)}}else t(new Y(A.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){let e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[Yc.OPEN,Yc.CLOSE,Yc.ERROR].forEach(t=>{let r=()=>{this.emit(t)};this._datachannelEventMap.set(t,r),e.addEventListener(t,r)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(t=>{let[r,n]=t;e.removeEventListener(r,n)}),this._datachannelEventMap.clear()}}class $4 extends y0{constructor(e){super(e),g(this,"_messageListener",void 0),this._messageListener=t=>{if(t.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);let r=t.data.slice(0,this._dataStreamPacketHeader.byteLength);if(new DataView(r).getUint8(3)!==this.id)return;let n=t.data.slice(this._dataStreamPacketHeader.byteLength);n=this._dataStreamPacketHandler.deserialize(n),this.emit(Yc.MESSAGE,n)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class C0 extends y0{send(e){if(this._originDataChannel){let t=e;t=this._dataStreamPacketHandler.serialize(e);let r=new Uint8Array(this._dataStreamPacketHeader.byteLength+t.byteLength);r.set(new Uint8Array(this._dataStreamPacketHeader),0),r.set(new Uint8Array(t),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(r.buffer)}}}class Z4 extends mt{constructor(){super(...arguments),g(this,"resultStorage",new Map)}setLocalAudioStats(e,t,r){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(r,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(r,t))}setLocalVideoStats(e,t,r){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(r,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(r,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(r))}setRemoteAudioStats(e,t){let r=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",r,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){let r=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",r,this.checkVideoDecode(t))}record(e,t,r){if(P("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});let n=this.resultStorage.get(e);if(n&&(n.result.push(r),n.result.length>=5)){var a;let c=ge(a=n.result).call(a,!0);n.isPrevNormal&&!c&&this.emit("exception",R0[e],e,t),!n.isPrevNormal&&c&&this.emit("exception",R0[e]+2e3,e+"_RECOVER",t),n.isPrevNormal=c,n.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,t){return t instanceof Vt&&!t.isActive||!!t.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,t){let r=null;t._encoderConfig&&t._encoderConfig.frameRate&&(r=qr(t._encoderConfig.frameRate));let n=e.captureFrameRate;return!r||!n||!(r>10&&n<5||r<10&&r>=5&&n<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,t){return t instanceof Vt&&!t.isActive||!!t.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}let R0={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Ii=new class{markSubscribeStart(i,e){performance.mark("agora-web-sdk/".concat(i,"/subscribe-").concat(e))}markPublishStart(i,e){performance.mark("agora-web-sdk/".concat(i,"/publish-").concat(e))}measureFromSubscribeStart(i,e){let t=performance.getEntriesByName("agora-web-sdk/".concat(i,"/subscribe-").concat(e));if(t.length>0){let r=t[t.length-1];return Math.round(performance.now()-r.startTime)}return 0}measureFromPublishStart(i,e){let t=performance.getEntriesByName("agora-web-sdk/".concat(i,"/publish-").concat(e));if(t.length>0){let r=t[t.length-1];return Math.round(performance.now()-r.startTime)}return 0}};function I0(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function xo(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?I0(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):I0(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class il{constructor(e){g(this,"store",void 0),g(this,"onStatsException",void 0),g(this,"onUploadPublishDuration",void 0),g(this,"onStatsChanged",void 0),g(this,"localStats",new Map),g(this,"remoteStats",new Map),g(this,"updateStatsInterval",void 0),g(this,"trafficStats",void 0),g(this,"trafficStatsPeerList",[]),g(this,"uplinkStats",void 0),g(this,"exceptionMonitor",void 0),g(this,"p2pChannel",void 0),g(this,"scalabilityMode",JE.L1T1),g(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new Z4,this.exceptionMonitor.on("exception",(t,r,n)=>{this.onStatsException&&this.onStatsException(t,r,n)})}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get($.LocalAudioTrack)||xo({},lg)}getLocalVideoTrackStats(){return this.localStats.get($.LocalVideoTrack)||xo({},dg)}getRemoteAudioTrackStats(e){let t=(a,c)=>{if(!this.trafficStats)return c;let l=this.trafficStats.peer_delay.find(u=>u.peer_uid===a);return l&&(c.publishDuration=l.B_ppad+(Date.now()-this.trafficStats.timestamp)),c},r={};if(e){var n;let a=(n=this.remoteStats.get(e))===null||n===void 0?void 0:n.audioStats;a&&(r[e]=t(e,a))}else Array.from(this.remoteStats.entries()).forEach(a=>{let[c,{audioStats:l}]=a;l&&(r[c]=t(c,l))});return r}getRemoteNetworkQualityStats(e){let t={};if(e){var r;let n=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.networkStats;n&&(t[e]=n)}else Array.from(this.remoteStats.entries()).forEach(n=>{let[a,{networkStats:c}]=n;c&&(t[a]=c)});return t}getRemoteVideoTrackStats(e){let t=(a,c)=>{if(!this.trafficStats)return c;let l=this.trafficStats.peer_delay.find(u=>u.peer_uid===a);return l&&(c.publishDuration=l.B_ppvd+(Date.now()-this.trafficStats.timestamp)),c},r={};if(e){var n;let a=(n=this.remoteStats.get(e))===null||n===void 0?void 0:n.videoStats;a&&(r[e]=t(e,a))}else Array.from(this.remoteStats.entries()).forEach(a=>{let[c,{videoStats:l}]=a;l&&(r[c]=t(c,l))});return r}getRTCStats(){let e=0,t=0,r=0,n=0,a=this.localStats.get($.LocalAudioTrack);a&&(e+=a.sendBytes,t+=a.sendBitrate);let c=this.localStats.get($.LocalVideoTrack);c&&(e+=c.sendBytes,t+=c.sendBitrate);let l=this.localStats.get($.LocalVideoLowTrack);l&&(e+=l.sendBytes,t+=l.sendBitrate),this.remoteStats.forEach(h=>{let{audioStats:p,videoStats:_}=h;p&&(r+=p.receiveBytes,n+=p.receiveBitrate),_&&(r+=_.receiveBytes,n+=_.receiveBitrate)});let u=1;return this.trafficStats&&(u+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:u,SendBitrate:t,SendBytes:e,RecvBytes:r,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(t=>t.B_ppad!==void 0||t.B_ppvd!==void 0),e.peer_delay.filter(t=>this.trafficStatsPeerList.indexOf(t.peer_uid)===-1).forEach(t=>{var r;let n=(r=this.p2pChannel)===null||r===void 0?void 0:r.getRemoteMedia(t.peer_uid),a=n!=null&&n.videoSSRC?Ii.measureFromSubscribeStart(this.store.clientId,n.videoSSRC):0,c=n!=null&&n.audioSSRC?Ii.measureFromSubscribeStart(this.store.clientId,n.audioSSRC):0;t.B_ppad!==void 0&&t.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(t.peer_uid,t.B_ppad,t.B_ppvd,a>c?a:c),this.trafficStatsPeerList.push(t.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&S.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,r){if(!e)return!1;let n=!!r&&t.framesDecodeFreezeTime>r.framesDecodeFreezeTime,a=!r||t.framesDecodeCount>r.framesDecodeCount;return n||!a}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(t=>{let[r,n]=t;switch(r){case $.LocalVideoTrack:case $.LocalVideoLowTrack:{let c=n,l=xo({},dg),u=e.getStats(),h=e.getLocalMedia(r);if(u){let p=u.videoSend.find(_=>_.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(p){let _=e.getLocalVideoSize(),E=e.getEncoderConfig($.LocalVideoTrack);p.codec!=="H264"&&p.codec!=="H265"&&p.codec!=="VP8"&&p.codec!=="VP9"&&p.codec!=="AV1X"&&p.codec!=="AV1"||(l.codecType=p.codec),l.sendBytes=p.bytes,l.sendBitrate=c?8*Math.max(0,l.sendBytes-c.sendBytes):0,p.inputFrame?(l.captureFrameRate=p.inputFrame.frameRate,l.captureResolutionHeight=p.inputFrame.height,l.captureResolutionWidth=p.inputFrame.width):_&&(l.captureResolutionWidth=_.width,l.captureResolutionHeight=_.height),p.sentFrame?(l.sendFrameRate=p.sentFrame.frameRate,l.sendResolutionHeight=p.sentFrame.height,l.sendResolutionWidth=p.sentFrame.width):_&&(l.sendResolutionWidth=_.width,l.sendResolutionHeight=_.height),p.avgEncodeMs&&(l.encodeDelay=p.avgEncodeMs),E&&E.bitrateMax&&(l.targetSendBitrate=1e3*E.bitrateMax),l.sendPackets=p.packets,l.sendPacketsLost=p.packetsLost,l.sendJitterMs=p.jitterMs,l.sendRttMs=p.rttMs,l.totalDuration=c?c.totalDuration+1:1,l.totalFreezeTime=c?c.totalFreezeTime:0,this.isLocalVideoFreeze(p)&&(l.totalFreezeTime+=1),p.scalabilityMode&&this.scalabilityMode!==p.scalabilityMode&&(S.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(p.scalabilityMode)),this.scalabilityMode=p.scalabilityMode)}this.trafficStats&&(l.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var a;this.localStats.set(r,l),((c==null?void 0:c.sendResolutionWidth)!==l.sendResolutionWidth||(c==null?void 0:c.sendResolutionHeight)!==l.sendResolutionHeight)&&((a=this.onStatsChanged)===null||a===void 0||a.call(this,"resolution",{width:l.sendResolutionWidth,height:l.sendResolutionHeight})),l&&h&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,h.track,l);break}case $.LocalAudioTrack:{let c=n,l=xo({},lg),u=e.getStats(),h=e.getLocalMedia(r);if(u){let p=u.audioSend.find(_=>_.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(p){if(p.codec!=="opus"&&p.codec!=="aac"&&p.codec!=="PCMU"&&p.codec!=="PCMA"&&p.codec!=="G722"||(l.codecType=p.codec),p.inputLevel)l.sendVolumeLevel=Math.round(32767*p.inputLevel);else{let _=e.getLocalAudioVolume();_&&(l.sendVolumeLevel=Math.round(32767*_))}l.sendBytes=p.bytes,l.sendPackets=p.packets,l.sendPacketsLost=p.packetsLost,l.sendJitterMs=p.jitterMs,l.sendRttMs=p.rttMs,l.sendBitrate=c?8*Math.max(0,l.sendBytes-c.sendBytes):0}}this.trafficStats&&(l.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set($.LocalAudioTrack,l),l&&h&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,h.track,l);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(t=>{let[r,{videoStats:n,audioStats:a,videoPcStats:c}]=t,l=a,u=n,h=c,p=xo({},iO),_=xo({},rO),E=xo({},x5),{audioTrack:T,videoTrack:w,audioSSRC:C,videoSSRC:O}=e.getRemoteMedia(r),b=e.getStats(),k=b==null?void 0:b.audioRecv.find(z=>z.ssrc===C),U=b==null?void 0:b.videoRecv.find(z=>z.ssrc===O),X=this.trafficStats&&this.trafficStats.peer_delay.find(z=>z.peer_uid===r);if(k&&(k.codec!=="opus"&&k.codec!=="aac"&&k.codec!=="PCMU"&&k.codec!=="PCMA"&&k.codec!=="G722"||(p.codecType=k.codec),k.outputLevel?p.receiveLevel=Math.round(32767*k.outputLevel):T&&(p.receiveLevel=Math.round(32767*T.getVolumeLevel())),p.receiveBytes=k.bytes,p.receivePackets=k.packets,p.receivePacketsLost=k.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost),p.receiveBitrate=l?8*Math.max(0,p.receiveBytes-l.receiveBytes):0,p.totalDuration=l?l.totalDuration+1:1,p.totalFreezeTime=l?l.totalFreezeTime:0,p.freezeRate=p.totalFreezeTime/p.totalDuration,p.receiveDelay=k.jitterBufferMs,p.totalDuration>10&&il.isRemoteAudioFreeze(T)&&(p.totalFreezeTime+=1)),U){U.codec!=="H264"&&U.codec!=="H265"&&U.codec!=="VP8"&&U.codec!=="VP9"&&U.codec!=="AV1X"&&U.codec!=="AV1"||(_.codecType=U.codec),_.receiveBytes=U.bytes,_.receiveBitrate=u?8*Math.max(0,_.receiveBytes-u.receiveBytes):0,_.decodeFrameRate=U.decodeFrameRate<0?0:U.decodeFrameRate,_.renderFrameRate=U.decodeFrameRate<0?0:U.decodeFrameRate,U.outputFrame&&(_.renderFrameRate=U.outputFrame.frameRate),U.receivedFrame?(_.receiveFrameRate=U.receivedFrame.frameRate,_.receiveResolutionHeight=U.receivedFrame.height,_.receiveResolutionWidth=U.receivedFrame.width):w&&(_.receiveResolutionHeight=w._videoHeight||0,_.receiveResolutionWidth=w._videoWidth||0),U.framesRateFirefox!==void 0&&(_.receiveFrameRate=Math.round(U.framesRateFirefox)),_.receivePackets=U.packets,_.receivePacketsLost=U.packetsLost,_.packetLossRate=_.receivePacketsLost/(_.receivePackets+_.receivePacketsLost),_.totalDuration=u?u.totalDuration+1:1,_.totalFreezeTime=u?u.totalFreezeTime:0,_.receiveDelay=U.jitterBufferMs||0;let z=!!O&&e.getRemoteVideoIsReady(O);w&&z&&il.isRemoteVideoFreeze(w,U,h)&&(_.totalFreezeTime+=1),_.freezeRate=_.totalFreezeTime/_.totalDuration}X&&(p.end2EndDelay=X.B_ad,_.end2EndDelay=X.B_vd,p.transportDelay=X.B_ed,_.transportDelay=X.B_ed,p.currentPacketLossRate=X.B_ealr4/100,_.currentPacketLossRate=X.B_evlr4/100,E.uplinkNetworkQuality=X.B_punq?X.B_punq:0,E.downlinkNetworkQuality=X.B_pdnq?X.B_pdnq:0),this.remoteStats.set(r,{audioStats:p,videoStats:_,videoPcStats:U,networkStats:E}),T&&this.exceptionMonitor.setRemoteAudioStats(T,p),w&&this.exceptionMonitor.setRemoteVideoStats(w,_)})}}function w0(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Op(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?w0(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):w0(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function Vd(i){return i.match(/^[\.\:\d]+$/)?"".concat(i.replace(/[^\d]/g,"-"),".").concat(P("TURN_DOMAIN")):(S.info("Cannot recognized as IP address ".concat(i,". Used As Host instead")),i)}function A0(i,e){var t,r;let n=P("GATEWAY_DOMAINS"),a=n[1]&&e.indexOf(n[1])!==-1?1:0;i.addresses=i.addresses||[];let c=i.addresses.map(u=>u.domain_prefix?{address:"".concat(u.domain_prefix,".").concat(n[a++%n.length],":").concat(u.port)}:u.ip.match(/^[\.\:\d]+$/)?{ip:u.ip,port:u.port,address:"".concat(u.ip.replace(/[^\d]/g,"-"),".").concat(n[a++%n.length],":").concat(u.port)}:(S.info("Cannot recognized as IP address ".concat(u.ip,". Used As Host instead")),{ip:u.ip,port:u.port,address:"".concat(u.ip,":").concat(u.port)}));if((t=i.detail)!==null&&t!==void 0&&t[18]&&typeof((r=i.detail)===null||r===void 0?void 0:r[18])=="string"){let u=i.detail[18],h=u==null?void 0:u.split(";");for(let p=0;p<h.length;p++){var l;let _=sg(l=h[p]).call(l);c[p]&&_&&(c[p].ip6=_)}}return{gatewayAddrs:c,uid:i.uid,cid:i.cid,cert:i.cert,vid:i.detail&&i.detail[8],uni_lbs_ip:i.detail&&i.detail[1],res:i,csIp:i.detail&&i.detail[502]}}function qr(i){return typeof i=="number"?i:i.exact||i.ideal||i.max||i.min||0}function Np(i){let e=i._encoderConfig;if(!e)return{};let t={resolution:e.width&&e.height?"".concat(qr(e.width),"x").concat(qr(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(t.maxFrameRate=e.frameRate,t.minFrameRate=e.frameRate):e.frameRate&&(t.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,t.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),t}function O0(i){let e={connectionType:0,googRtt:i.rtt};switch(i.selectedCandidatePair.localCandidate.candidateType){case"relay":{let t=i.selectedCandidatePair.localCandidate.relayProtocol;t==="udp"&&(e.connectionType=1),t==="tcp"&&(e.connectionType=3),t==="tls"&&(e.connectionType=4);break}case"srflx":e.connectionType=2}return e}function N0(i){return i>=0&&i<.17?1:i>=.17&&i<.36?2:i>=.36&&i<.59?3:i>=.59&&i<=1?4:i>1?5:0}function Kg(i,e){let t,r,n;switch(e){case ai.CHOOSE_SERVER:r=4096,n="choose server";break;case ai.CLOUD_PROXY:r=1048576,n="proxy";break;case ai.CLOUD_PROXY_5:r=4194304,n="proxy5";break;case ai.CLOUD_PROXY_FALLBACK:r=4194310,n="proxy fallback";break;default:throw new x(A.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:i.detail&&i.detail[502],retry:!1})}if(i.response_body.forEach(a=>{a.buffer&&a.buffer.flag===r&&(t={code:a.buffer.code,addresses:(a.buffer.edges_services||[]).map(c=>Op(Op({},c),{},{ticket:a.buffer.cert})),server_ts:i.enter_ts,uid:a.buffer.uid,cid:a.buffer.cid,cname:a.buffer.cname,detail:Op(Op({},a.buffer.detail),i.detail),flag:a.buffer.flag,opid:i.opid,cert:a.buffer.cert})}),!t)throw new x(A.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(n," from multi unilbs response"),{csIp:i.detail&&i.detail[502]});return t}async function eG(i,e){return await F.all(i.addresses.map(async t=>({address:Vd(t.ip),tcpport:t.port,udpport:t.port,username:e&&P("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():Vr.username,password:e&&P("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await c3(e.toString()):Vr.password})))}function zg(i,e){let t=e._videoHeight||e.getMediaStreamTrack(!0).getSettings().height;return t?Math.max(t/qr(i.height),1):(S.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Ia(i){let{candidateType:e,relayProtocol:t,type:r,address:n,port:a,protocol:c}=i;return r==="local-candidate"?{candidateType:e,relayProtocol:t,protocol:c}:{candidateType:e,relayProtocol:t,address:n,port:a,protocol:c}}function b0(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}class tG extends mt{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;ge(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Ot.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Ot.CONNECTED):this._state==="closed"?this.emit(Ot.CLOSED):this._state==="failed"&&this.emit(Ot.FAILED))}constructor(e,t,r,n){super(),g(this,"connectionID",0),g(this,"currentURLIndex",0),g(this,"reconnectReason",void 0),g(this,"_reconnectMode","tryNext"),g(this,"_name",void 0),g(this,"_state","closed"),g(this,"_retryConfig",void 0),g(this,"_reconnectCount",0),g(this,"_forceCloseTimeout",5e3),g(this,"_onlineReconnectListener",void 0),g(this,"_closeEstablishingTransmitter",()=>{}),g(this,"_store",void 0),g(this,"_joinChannelServiceRecordIndex",void 0),g(this,"_useCompress",void 0),g(this,"_inflateLength",0),g(this,"_deflateLength",0),this._store=n,this._name=e,this._retryConfig=function(a){for(var c=1;c<arguments.length;c++){var l=arguments[c]!=null?arguments[c]:{};c%2?b0(Object(l),!0).forEach(function(u){g(a,u,l[u])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(l)):b0(Object(l)).forEach(function(u){Object.defineProperty(a,u,Object.getOwnPropertyDescriptor(l,u))})}return a}({},t),this._useCompress=r}resetReconnectCount(e){S.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;let r=this._transmitter;t?setTimeout(()=>r.close(),500):r.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,t){if(!this._transmitter)return void S.warning("[".concat(this._name,"] can not reconnect, no websocket"));var r;e!==void 0&&(this.reconnectMode=e),S.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((r=this._store)===null||r===void 0||r.recordJoinChannelService({status:"error",errors:[new Error(t)]},this._joinChannelServiceRecordIndex));let n=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),n&&n.bind(this._transmitter)({code:9999,reason:t})}getInflateData(){let e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}var ln;(function(i){i[i.Default=0]="Default",i[i.Ack=1]="Ack"})(ln||(ln={}));class iG{constructor(e,t,r){g(this,"version",1),g(this,"initialRTO",void 0),g(this,"maxBatchAckCount",void 0),g(this,"maxRTO",void 0),g(this,"initialRTT",void 0),g(this,"ID",void 0),g(this,"rtt",void 0),g(this,"packetNumber",1),g(this,"rtoRatioMap",new Map),g(this,"timeoutMap",new Map),g(this,"unorderedPacketQueue",[]),g(this,"batchAckPacketQueue",[]),g(this,"lastOrderedPacketNumber",0),g(this,"batchAckTimer",void 0),g(this,"sendImpl",void 0),g(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=t,this.ID=at(7,"transmitter-"),this.initialRTO=(r==null?void 0:r.initialRTO)!==void 0?r.initialRTO:P("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(r==null?void 0:r.initialRTT)!==void 0?r.initialRTT:P("TRANSMITTER_INITIAL_RTT"),this.rtt=(r==null?void 0:r.initialRTT)!==void 0?r.initialRTT:P("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(r==null?void 0:r.maxBatchAckCount)!==void 0?r.maxBatchAckCount:P("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(r==null?void 0:r.maxRTO)!==void 0?r.maxRTO:P("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:ln.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case ln.Default:{let t;typeof e.payload=="string"?t=new TextEncoder().encode(e.payload):t=e.payload;let r=new ArrayBuffer(t.length+15),n=new DataView(r);return n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.packetNumber),Ew(n,7,BigInt(e.sendTs)),new Uint8Array(n.buffer).set(t,15),r}case ln.Ack:{let t=new ArrayBuffer(16),r=new DataView(t);return r.setUint16(0,e.version),r.setUint8(2,e.type),r.setUint32(3,e.maxAckPacketNumber),r.setUint8(7,e.shift),Ew(r,8,BigInt(e.ackSendTs)),t}}}deserialize(e){let t=new DataView(e),r=t.getUint16(0),n=t.getUint8(2);switch(n){case ln.Default:{let a=t.getUint32(3),c=mw(t,7),l=e.slice(15),u=new TextDecoder().decode(l);return{version:r,type:n,packetNumber:a,sendTs:Number(c),payload:u}}case ln.Ack:{let a=t.getUint32(3),c=t.getUint8(7),l=mw(t,8);return{version:r,type:n,maxAckPacketNumber:a,shift:c,ackSendTs:Number(l)}}default:throw S.error("[".concat(this.ID,"] Unrecognized packet type ").concat(n)),new Error("Unrecognized packet type ".concat(n))}}sendMessage(e){let t=this.packetize(e,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;let r=this.calculateRTO(t),n=window.setTimeout(()=>{this.resendMessage(t)},r);this.timeoutMap.set(t.packetNumber,n),this.sendPacket(t)}onData(e){let t=this.deserialize(e);t.type===ln.Default?this.ack(t):t.type===ln.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(e=>{let[t,r]=e;window.clearTimeout(r)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){let t=this.calculateRTO(e),r=window.setTimeout(()=>{this.resendMessage(e)},t);this.timeoutMap.set(e.packetNumber,r),this.sendPacket(e)}calculateRTO(e){let t=this.rtoRatioMap.get(e.packetNumber);if(t===void 0)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{let r=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),r>this.maxRTO?this.maxRTO:r}}updateRTT(e,t){let r=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-r-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){let t=this.unorderedPacketQueue[0];if(!t){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(t.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){let t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:ln.Ack,version:this.version};this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;let t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:ln.Ack,version:this.version};this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;let e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:ln.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===ln.Default&&(e.sendTs=Math.round(performance.now()));let t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){let r=this.timeoutMap.get(t);r!==void 0&&window.clearTimeout(r),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class D0 extends tG{constructor(e,t){super(e,t,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),g(this,"_initMutex",void 0),g(this,"_reconnectInterrupter",void 0),g(this,"_url",void 0),g(this,"_transmitter",void 0),g(this,"_addresses",void 0),g(this,"_reliableTransmission",void 0),this._initMutex=new si("datachannel");let{timeout:r,timeoutFactor:n}=t,a=Math.max(300,Math.floor(3*r/5)),c=Math.max(1.2,Math.floor(8*n)/10);ji.ONLINE&&(this._retryConfig.timeout=a,this._retryConfig.timeoutFactor=c),Mt.on(Ls.NETWORK_STATE_CHANGE,(l,u)=>{l!==u&&(this.resetReconnectCount("network state change: ".concat(u," -> ").concat(l)),l===ji.ONLINE?(this._retryConfig.timeout=a,this._retryConfig.timeoutFactor=c):(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=n))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=t;let r=(n,a)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex(l=>l.fingerprint||P("FINGERPRINT"));let c=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(c).then(n).catch(a),this.once(Ot.CLOSED,()=>a(new x(A.WS_DISCONNECT))),this.once(Ot.CONNECTED,()=>n())};return this._initMutex.lock().then(n=>new F((a,c)=>{r(a,c)}).then(()=>{n()}).catch(()=>{n()}))}sendMessage(e){let t=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new x(A.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(r){throw new x(A.WS_ERR,"send datachannel signal message error"+r.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){let t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new F((t,r)=>{var n;let a=()=>{S.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),t()},c=async p=>{var _;if((_=this._closeEstablishingTransmitter)===null||_===void 0||_.call(this),S.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(p.code,", reason: ").concat(p.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=p.reason,this.state="reconnecting");let E=cr(this,Ot.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,T=await this.reconnectWithAction(E);if(this.state==="closed")return void S.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!T)return r(new x(A.WS_DISCONNECT,"datachannel reconnect failed: ".concat(p.code))),void this.close(!0);t()}else r(new x(A.WS_DISCONNECT,"datachannel close: ".concat(p.code))),this.close()},l=p=>{var _;(_=this._reliableTransmission)===null||_===void 0||_.onData(p.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),S.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));let u=(n=this._store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),h=Date.now();vt(this,Ot.TO_CONNECT_DATACHANNEL,e).then(p=>{var _,E;if(!p)throw new Error("transmissonInfo not exist yet");let{transmitter:T,close:w}=p;this._transmitter=T,(_=this._store)===null||_===void 0||_.signalChannelOpen();let C=Date.now()-h;S.debug("[choose dc] dc open cost ".concat(C,"ms")),this._reliableTransmission=new iG(O=>{var b;this._transmitter&&this._transmitter.readyState==="open"&&((b=this._transmitter)===null||b===void 0||b.send(O))},O=>{typeof O=="string"&&this.emit(Ot.ON_MESSAGE,O)}),this._closeEstablishingTransmitter=()=>{var O;(O=this._reliableTransmission)===null||O===void 0||O.close(),this._reliableTransmission=void 0,w()},a&&a(),T.onclose=c,T.onmessage=l,(E=this._store)===null||E===void 0||E.recordJoinChannelService({endTs:Date.now(),status:"success"},u),this._joinChannelServiceRecordIndex=u}).catch(p=>{var _;if((_=this._store)===null||_===void 0||_.recordJoinChannelService({endTs:Date.now(),status:p instanceof x&&p.code===A.WS_ABORT?"aborted":"error",errors:[p]},u),this.state!=="closed"){if(p instanceof x&&p.code===A.WS_ERR){let E=new x(A.WS_ERR,"init datachannel failed! Error: ".concat(p.toString()));return S.error("[".concat(this._name,"]").concat(E)),void r(E)}c&&c(p)}else r(new x(A.WS_DISCONNECT,"datachannel is closed: ".concat(p.toString())))})})}async reconnectWithAction(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||Mt.networkState!==ji.OFFLINE||(this._onlineReconnectListener=Mt.onlineWaiter&&Mt.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let r=!0;if(this._reconnectInterrupter=()=>{r=!1},t){let l=Bh(this._reconnectCount,this._retryConfig);S.debug("[".concat(this._name,"] wait ").concat(l,"ms to reconnect datachannel, mode: ").concat(e)),await F.race([Si(l),this._onlineReconnectListener||new F(()=>{})])}if(this.state==="closed"||!r)return!1;this._reconnectCount+=1;let n=async(l,u)=>{this.emit(Ot.RECONNECT_CREATE_CONNECTION,u),await this.createTransmitterConnection(l)};try{if(e==="retry"){let l=this._addresses[this.currentURLIndex];this.emit(Ot.RECONNECT_WAITTING_FINISH,e),await n(l,e)}else if(e==="tryNext"){this.currentURLIndex+=1;for(let u=this.currentURLIndex;u<this._addresses.length;u++){if(this._addresses[u].fingerprint||P("FINGERPRINT")){this.currentURLIndex=u;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return S.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);S.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));let l=this._addresses[this.currentURLIndex];this.emit(Ot.RECONNECT_WAITTING_FINISH,e),await n(l,e)}else e==="recover"&&(S.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(Ot.RECONNECT_WAITTING_FINISH,e),this.emit(Ot.FAILBACK));return!0}catch(l){var a,c;return S.error("[".concat(this._name,"] reconnect failed"),l.toString()),l!=null&&(a=l.data)!==null&&a!==void 0&&a.desc&&Array.isArray(l.data.desc)&&l.data.desc.length&&ge(c=l.data.desc).call(c,"dynamic key expired")?(this.emit(Ot.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,t)}}}class Bs extends mt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===xe.CONNECTED?this.emit(le.WS_CONNECTED):e===xe.RECONNECTING?this.emit(le.WS_RECONNECTING,this._websocketReconnectReason):e===xe.CLOSED&&this.emit(le.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",xe.CLOSED),g(this,"reconnectToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new AE(5)),g(this,"pingpongTimer",void 0),g(this,"inflateDataTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"onWebsocketMessage",r=>{if(r instanceof ArrayBuffer)return void this.emit(le.ON_BINARY_DATA,r);let n=JSON.parse(r);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(n,"_id")){let a="res-@".concat(n._id);this.emit(a,n._result,n._message)}else if(Object.prototype.hasOwnProperty.call(n,"_type")&&(this.emit(n._type,n._message),n._type===Ae.ON_NOTIFICATION&&this.handleNotification(n._message),n._type===Ae.ON_USER_BANNED))switch(n._message.error_code){case 14:this.close(Ve.UID_BANNED);break;case 15:this.close(Ve.IP_BANNED);break;case 16:this.close(Ve.CHANNEL_BANNED)}}),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new D0("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===xe.CONNECTED&&this.reconnect("retry",hs.OFFLINE)})}async request(e,t,r,n){let a=at(6,""),c={_id:a,_type:e,_message:t},l=this.websocket.connectionID,u=()=>new F((w,C)=>{if(this.connectionState===xe.CONNECTED)return w();let O=()=>{this.off(le.WS_CLOSED,b),w()},b=()=>{this.off(le.WS_CONNECTED,O),C(new x(A.WS_ABORT))};this.once(le.WS_CONNECTED,O),this.once(le.WS_CLOSED,b),e!==me.PUBLISH&&e!==me.SUBSCRIBE&&e!==me.UNSUBSCRIBE&&e!==me.UNPUBLISH&&e!==me.CONTROL&&e!==me.RESTART_ICE||this.once(le.DISCONNECT_P2P,()=>{C(new x(A.DISCONNECT_P2P))}),e!==me.PUBLISH&&e!==me.RESTART_ICE||this.once(le.ABORT_P2P_EXECUTION,()=>{C(new x(A.DISCONNECT_P2P))})});if(this.connectionState!==xe.CONNECTING&&this.connectionState!==xe.RECONNECTING||e===me.JOIN||e===me.REJOIN||await u(),e===me.LEAVE&&(this.websocket.unbindDcCloseEventListener(),n=!0),this.websocket.sendMessage(c,!0,!1),n)return;let h=new F((w,C)=>{let O=!1,b=(U,X)=>{O=!0,w({isSuccess:U==="success",message:X||{}}),this.off(le.WS_CLOSED,k),this.off(le.WS_RECONNECTING,k),this.emit(le.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(a),b);let k=()=>{C(new x(A.WS_ABORT,"type: ".concat(e))),this.off(le.WS_CLOSED,k),this.off(le.WS_RECONNECTING,k),this.off("res-@".concat(a),b)};this.once(le.WS_CLOSED,k),this.once(le.WS_RECONNECTING,k),Si(P("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==l||O||(S.warning("dc request timeout, type: ".concat(e)),this.emit(le.REQUEST_TIMEOUT,e,t))})}),p=null;try{p=await h}catch(w){if(this.connectionState===xe.CLOSED||e===me.LEAVE)throw new x(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?w.throw():e===me.JOIN||e===me.REJOIN?null:(await u(),await this.request(e,t))}if(p.isSuccess)return p.message;let _=Number(p.message.error_code||p.message.code),E=Ao(_),T=new x(A.UNEXPECTED_RESPONSE,"".concat(E.desc,": ").concat(p.message.error_str),{code:_,data:p.message});return E.action==="success"?p.message:(S.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(_,", message: ").concat(E.desc,", action: ").concat(E.action)),_===ve.ERR_TOO_MANY_BROADCASTERS?((e===me.JOIN||e===me.REJOIN)&&(this.initError=T,this.close()),T.throw()):E.action==="failed"?T.throw():E.action==="quit"?(this.initError=T,this.close(),T.throw()):(_===ve.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=p.message.option,S.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",hs.MULTI_IP)):this.reconnect(E.action,hs.SERVER_ERROR),e===me.JOIN||e===me.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new F(r=>{let n=a=>{(!t||t(a))&&(this.off(e,n),r(a))};this.on(e,n)})}upload(e,t){let r={_type:e,_message:t};try{this.websocket.sendMessage(r)}catch{let n=P("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>n&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==xe.CONNECTED)return;let a=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(a._type,a._message)},P("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){let r={_type:e,_message:t};this.websocket.sendMessage(r)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new F((r,n)=>{this.once(le.WS_CONNECTED,()=>r(this.joinResponse)),this.once(le.WS_CLOSED,()=>n(this.initError||new x(A.WS_ABORT))),this.connectionState=xe.CONNECTING,this.websocket.init(e).catch(n),this.websocket.once(Ot.FAILBACK,()=>{this.openConnectionTime===void 0&&n(new x(A.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{t&&this.openConnectionTime===void 0&&(S.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),n(new x(A.INIT_DATACHANNEL_TIMEOUT)))},P("DC_JOIN_WITH_FAILBACK"))})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Ve.LEAVE,this.connectionState=xe.CLOSED,S.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===Ve.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new D0("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(le.ABORT_P2P_EXECUTION);let e=await vt(this,le.DATACHANNEL_CONNECTING),t=await this.request(me.JOIN,e);if(!t)return this.emit(le.REPORT_JOIN_GATEWAY,A.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(le.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=xe.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new x(A.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=Ms(this,le.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;let t=await this.request(me.REJOIN,e);return!!t&&(this.connectionState=xe.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach(r=>{this.emit(Ae.ON_USER_ONLINE,{uid:r.uid}),r.audio&&this.emit(Ae.ON_ADD_AUDIO_STREAM,{uid:r.uid,uint_id:r.uint_id,audio:!0,ssrcId:r.audio_ssrc}),r.video&&this.emit(Ae.ON_ADD_VIDEO_STREAM,{uid:r.uid,uint_id:r.uint_id,video:!0,ssrcId:r.video_ssrc}),r.audio_mute?this.emit(Ae.MUTE_AUDIO,{uid:r.uid}):this.emit(Ae.UNMUTE_AUDIO,{uid:r.uid}),r.video_mute?this.emit(Ae.MUTE_VIDEO,{uid:r.uid}):this.emit(Ae.UNMUTE_VIDEO,{uid:r.uid}),r.audio_enable_local?this.emit(Ae.ENABLE_LOCAL_AUDIO,{uid:r.uid}):this.emit(Ae.DISABLE_LOCAL_AUDIO,{uid:r.uid}),r.video_enable_local?this.emit(Ae.ENABLE_LOCAL_VIDEO,{uid:r.uid}):this.emit(Ae.DISABLE_LOCAL_VIDEO,{uid:r.uid}),r.audio||r.video||this.emit(Ae.ON_REMOVE_STREAM,{uid:r.uid,uint_id:r.uint_id})}),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){S.debug("[".concat(this.clientId,"] receive notification: "),e);let t=Ao(e.code);if(t.action!=="success"){if(t.action!=="failed")return t.action==="quit"?(t.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ve.UID_BANNED),void this.close()):void this.reconnect(t.action,hs.SERVER_ERROR);S.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=P("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(S.warning("PINGPONG Timeout. Last Socket Message: ".concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>P("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",hs.TIMEOUT):this.request(me.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let r=Date.now()-t;this.rttRolling.add(r),P("REPORT_STATS")&&this.send(me.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleInflateData(){let{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();e!==0&&t!==0&&this.upload(ur.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Ot.RECONNECT_WAITTING_FINISH,e=>{this.emit(le.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(Ot.RECONNECT_CREATE_CONNECTION,e=>{this.emit(le.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Ot.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ot.CLOSED,()=>{this.connectionState=xe.CLOSED}),this.websocket.on(Ot.FAILED,()=>{this._disconnectedReason=Ve.NETWORK_ERROR,this.connectionState=xe.CLOSED}),this.websocket.on(Ot.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===xe.CONNECTED?this.connectionState=xe.RECONNECTING:this.connectionState=xe.CONNECTING}),this.websocket.on(Ot.WILL_RECONNECT,(e,t)=>{if(Ms(this,le.IS_P2P_DISCONNECTED)&&e==="retry")return S.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(le.NEED_RENEW_SESSION),this.emit(le.DISCONNECT_P2P),t("tryNext");e!=="retry"&&(S.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(le.NEED_RENEW_SESSION),this.emit(le.DISCONNECT_P2P)),t(e)}),this.websocket.on(Ot.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{S.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",hs.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(le.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof x&&e.code===A.UNEXPECTED_RESPONSE&&e.data.code===ve.ERR_NO_AUTHORIZED)return S.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",hs.SERVER_ERROR);S.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",hs.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Ot.REQUEST_NEW_URLS,(e,t)=>{vt(this,le.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)}),this.websocket.on(Ot.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(Ot.TO_CONNECT_DATACHANNEL,async(e,t,r)=>vt(this,le.DATACHANNEL_PRECONNECT,e).then(t).catch(r)),this.websocket.on(Ot.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(le.DATACHANNEL_FAILBACK)})}}class bp extends mt{constructor(e){super(),g(this,"_signal",void 0),g(this,"_sequence",0),g(this,"_userMap",new Map),g(this,"_encoder",new TextEncoder),this._signal=e}async send(e,t,r,n,a){var c,l,u;typeof t!="string"&&(t=JSON.stringify(t)),n=(c=n)!==null&&c!==void 0?c:at(6,""),a=(l=a)!==null&&l!==void 0?l:this._sequence++;let h={_id:n,_type:e,_seq:(u=a)!==null&&u!==void 0?u:this._sequence++,_message:t};if(P("SHOW_P2P_LOG")&&S.debug("send message",h),this.sendStreamMessage(JSON.stringify(h)),r)return;let p=new F((E,T)=>{let w=window.setTimeout(()=>{this.off("res-@".concat(n),C),S.warning("[external-signal] request timeout, type: ".concat(e)),this._userMap.size===0?T(new Y(A.INVALID_REMOTE_USER)):T(new Y(A.TIMEOUT))},P("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),C=(O,b)=>{w&&window.clearTimeout(w),O==="success"?E({isSuccess:!0,message:b}):T(new Y(A.UNEXPECTED_ERROR,b))};this.once("res-@".concat(n),C)}),_;try{_=await p}catch(E){if(E.code===A.TIMEOUT)return await this.send(e,t,!1,n,a);throw E}return _.isSuccess?_.message:void 0}sendStreamMessage(e){this._splitMessage(e).forEach(t=>{this._signal.request(me.DATA_STREAM,{payload:Vh(this._encoder.encode(t))})})}onMessage(e){let{_uid:t}=e,r,n=this._userMap.get(t);if(n?r=n.splitMessageMap:(r=new Map,this._userMap.set(t,{isStart:!1,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map})),"id"in e&&"total"in e){var a;let{id:c,total:l}=e,u=(a=r.get(c))!==null&&a!==void 0?a:[];if(u.push(e),r.has(c)||r.set(c,u),u.length!==l)return;{let h=td(u).call(u,(p,_)=>p.index-_.index).map(p=>p.payload).join("");r.delete(c),(e=JSON.parse(h))._uid=t}}this.handleReceivedMessage(e)}setStart(e){this._userMap.has(e)?this._userMap.get(e).isStart=!0:this._userMap.set(e,{isStart:!0,splitMessageMap:new Map,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map}),this.handleReceivedMessage()}setEnd(e){return this._userMap.delete(e),this._userMap.size===0}ack(e,t,r){this.send(lt.ACK,JSON.stringify({success:!r,message:t}),!0,e)}handleReceivedMessage(e){let t=()=>{this._userMap.forEach(h=>{let{receivedMessagesMap:p,nextExpectedSequenceNumber:_}=h;for(;p.has(_);){let E=p.get(_);p.delete(_),this.receiveMessage(E),h.nextExpectedSequenceNumber++}})};if(!e)return void t();let{_uid:r,_seq:n}=e,a=this._userMap.get(r),{receivedMessagesMap:c,isStart:l,nextExpectedSequenceNumber:u}=a;n<u?S.debug("[external-signal] receive old message, seq: ".concat(n)):(c.set(n,e),l&&n===u&&(this.receiveMessage(e),c.delete(u),a.nextExpectedSequenceNumber++,t()))}receiveMessage(e){let{_id:t,_type:r,_message:n,_uid:a}=e;if(P("SHOW_P2P_LOG")&&S.debug("",e),t)switch(e._type){case lt.PUBLISH:let c=JSON.parse(n);this._signal.emit(r,c,a),this.ack(e._id);break;case lt.CONTROL:case lt.UNPUBLISH:case lt.DO_SUBSCRIBE:case lt.DO_UNSUBSCRIBE:{let l=JSON.parse(n);l.uid=a,vt(this._signal,r,l).then(u=>{this.ack(e._id,u)}).catch(u=>{this.ack(e._id,void 0,!0)});break}case lt.ACK:{let{success:l,message:u}=JSON.parse(n);this.emit("res-@".concat(t),l?"success":"failed",u);break}case lt.CALL:vt(this,r,n).then(l=>{this.ack(t,l)});break;case lt.RESTART_ICE:case lt.EXCHANGE_SDP:case lt.SUBSCRIBE:case lt.UNSUBSCRIBE:vt(this._signal,r,n).then(l=>{this.ack(t,l)}).catch(l=>{this.ack(e._id,void 0,!0)});break;case lt.CANDIDATE:this._signal.emit(r,n),this.ack(t);break;case lt.JOIN:this.emit(r,JSON.parse(n));break;default:this.emit(r,n),this.ack(t)}}_splitMessage(e){if(e.length<bp.MAX_MESSAGE_SIZE)return[e];let t=[],r=at(6,""),n=0,a=Math.ceil(e.length/800);for(;e.length>0;){n++;let c=e.slice(0,800);t.push({id:r,index:n,total:a,payload:c}),e=e.slice(800)}return t.map(c=>JSON.stringify(c))}clear(){this._sequence=0,this._userMap.clear()}}g(bp,"MAX_MESSAGE_SIZE",1024);class P0 extends mt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===xe.CONNECTED?this.emit(le.WS_CONNECTED):e===xe.RECONNECTING?this.emit(le.WS_RECONNECTING,this._websocketReconnectReason):e===xe.CLOSED&&this.emit(le.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",xe.CLOSED),g(this,"reconnectToken",void 0),g(this,"_userInRoom",!1),g(this,"_userOnlineTime",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new AE(5)),g(this,"pingpongTimer",void 0),g(this,"wsInflateDataTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"_external_signal",void 0),g(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(le.ON_BINARY_DATA,r.data);let n=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(n,"_id")){let a="res-@".concat(n._id);this.emit(a,n._result,n._message)}else if(Object.prototype.hasOwnProperty.call(n,"_type")){switch(n._type){case Ae.ON_DATA_STREAM:return void this.handleDataStream(n._message);case Ae.MUTE_AUDIO:case Ae.MUTE_VIDEO:case Ae.ON_P2P_LOST:return;case Ae.ON_USER_ONLINE:this.emit(n._type,n._message);let{uid:a}=n._message;return this._external_signal.setStart(a),void this._external_signal.send(lt.JOIN,{onlineTime:this._userOnlineTime},!0)}if(this.emit(n._type,n._message),n._type===Ae.ON_NOTIFICATION&&this.handleNotification(n._message),n._type===Ae.ON_USER_BANNED)switch(n._message.error_code){case 14:this.close(Ve.UID_BANNED);break;case 15:this.close(Ve.IP_BANNED);break;case 16:this.close(Ve.CHANNEL_BANNED)}if(n._type===Ae.ON_USER_LICENSE_BANNED)switch(n._message.error_code){case ve.ERR_LICENSE_MISSING:this.close(Ve.LICENSE_MISSING);break;case ve.ERR_LICENSE_EXPIRED:this.close(Ve.LICENSE_EXPIRED);break;case ve.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ve.LICENSE_MINUTES_EXCEEDED);break;case ve.ERR_LICENSE_PERIOD_INVALID:this.close(Ve.LICENSE_PERIOD_INVALID);break;case ve.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ve.LICENSE_MULTIPLE_SDK_SERVICE);break;case ve.ERR_LICENSE_ILLEGAL:this.close(Ve.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new gd("gateway-".concat(this.clientId),this.spec.retryConfig,!0,P("JOIN_GATEWAY_USE_DUAL_DOMAIN"),P("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===xe.CONNECTED&&this.reconnect("retry",Qt.OFFLINE)}),this._external_signal=new bp(this),this._handleSignalP2PEvents()}async request(e,t,r,n){let a=at(6,""),c={_id:a,_type:e,_message:t},l=this.websocket.connectionID,u=()=>new F((w,C)=>{if(this.connectionState===xe.CONNECTED)return w();let O=()=>{this.off(le.WS_CLOSED,b),w()},b=()=>{this.off(le.WS_CONNECTED,O),C(new Y(A.WS_ABORT))};this.once(le.WS_CONNECTED,O),this.once(le.WS_CLOSED,b),e!==me.PUBLISH&&e!==me.SUBSCRIBE&&e!==me.UNSUBSCRIBE&&e!==me.UNPUBLISH&&e!==me.CONTROL&&e!==me.RESTART_ICE||this.once(le.DISCONNECT_P2P,()=>{C(new Y(A.DISCONNECT_P2P))}),e!==me.PUBLISH&&e!==me.RESTART_ICE||this.once(le.ABORT_P2P_EXECUTION,()=>{C(new Y(A.DISCONNECT_P2P))})});if(this.connectionState!==xe.CONNECTING&&this.connectionState!==xe.RECONNECTING||e===me.JOIN||e===me.REJOIN||await u(),this.websocket.sendMessage(c,!0),n)return;let h=new F((w,C)=>{let O=!1,b=(U,X)=>{O=!0,w({isSuccess:U==="success",message:X||{}}),this.off(le.WS_CLOSED,k),this.off(le.WS_RECONNECTING,k),this.emit(le.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(a),b);let k=()=>{C(new Y(A.WS_ABORT,"type: ".concat(e))),this.off(le.WS_CLOSED,k),this.off(le.WS_RECONNECTING,k),this.off("res-@".concat(a),b)};this.once(le.WS_CLOSED,k),this.once(le.WS_RECONNECTING,k),Si(P("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==l||O||(S.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(le.REQUEST_TIMEOUT,e,t))})}),p=null;try{p=await h}catch(w){if(this.connectionState===xe.CLOSED||e===me.LEAVE)throw new Y(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?w.throw():e===me.JOIN||e===me.REJOIN?null:(await u(),await this.request(e,t))}if(p.isSuccess)return p.message;let _=Number(p.message.error_code||p.message.code),E=Ao(_),T=new Y(A.UNEXPECTED_RESPONSE,"".concat(E.desc,": ").concat(p.message.error_str),{code:_,data:p.message});return E.action==="success"?p.message:(S.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(_,", message: ").concat(E.desc,", action: ").concat(E.action)),_===ve.ERR_TOO_MANY_BROADCASTERS?((e===me.JOIN||e===me.REJOIN)&&(this.initError=T,this.close()),T.throw()):E.action==="failed"?T.throw():E.action==="quit"?(this.initError=T,this.close(),T.throw()):(_===ve.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=p.message.option,S.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Qt.MULTI_IP)):this.reconnect(E.action,Qt.SERVER_ERROR),e===me.JOIN||e===me.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new F(r=>{let n=a=>{(!t||t(a))&&(this.off(e,n),r(a))};this.on(e,n)})}upload(e,t){let r={_type:e,_message:t};try{this.websocket.sendMessage(r)}catch{let n=P("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>n&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==xe.CONNECTED)return;let a=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(a._type,a._message)},P("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){let r={_type:e,_message:t};this.websocket.sendMessage(r)}async sendExtensionMessage(e,t,r){return await this.waitTillUserOnline(),await this._external_signal.send(e,t,r)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new F((r,n)=>{this.once(le.WS_CONNECTED,()=>r(this.joinResponse)),this.once(le.WS_CLOSED,()=>n(this.initError||new Y(A.WS_ABORT))),this.connectionState=xe.CONNECTING,this.websocket.init(e).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Ve.LEAVE,this.connectionState=xe.CLOSED,S.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===Ve.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new gd("gateway-".concat(this.clientId),this.spec.retryConfig,!0,P("JOIN_GATEWAY_USE_DUAL_DOMAIN"),P("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(le.ABORT_P2P_EXECUTION);let e=await vt(this,le.REQUEST_JOIN_INFO),t=await this.request(me.JOIN,e);if(!t)return this.emit(le.REPORT_JOIN_GATEWAY,A.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(le.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=xe.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),this._userOnlineTime=new Date().getTime(),this._external_signal.clear(),!0}async rejoin(){if(!this.reconnectToken)throw new Y(A.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=Ms(this,le.REQUEST_REJOIN_INFO);return e.token=this.reconnectToken,!!await this.request(me.REJOIN,e)&&(this.connectionState=xe.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleDataStream(e){try{var t;let r=xh(e.payload),n=new TextDecoder().decode(r),a=JSON.parse(n);"total"in a&&"id"in a||ge(t=Object.values(lt)).call(t,a._type)?(e.seq&&delete e.seq,a._uid=e.uid,this._external_signal.onMessage(a)):this.emit(Ae.ON_DATA_STREAM,e)}catch{}}handleNotification(e){S.debug("[".concat(this.clientId,"] receive notification: "),e);let t=Ao(e.code);if(t.action!=="success"){if(t.action!=="failed")return t.action==="quit"?(t.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ve.UID_BANNED),void this.close()):void this.reconnect(t.action,Qt.SERVER_ERROR);S.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=P("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(S.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>P("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Qt.TIMEOUT):this.request(me.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let r=Date.now()-t;this.rttRolling.add(r),P("REPORT_STATS")&&this.send(me.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWsInflateData(){let{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();e!==0&&t!==0&&this.upload(ur.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Ie.RECONNECT_WAITTING_FINISH,e=>{this.emit(le.WS_RECONNECT_WAITTING_FINISH,e)}),this.websocket.on(Ie.RECONNECT_CREATE_CONNECTION,e=>{this.emit(le.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Ie.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ie.CLOSED,()=>{this.connectionState=xe.CLOSED}),this.websocket.on(Ie.FAILED,()=>{this._disconnectedReason=Ve.NETWORK_ERROR,this.connectionState=xe.CLOSED}),this.websocket.on(Ie.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===xe.CONNECTED?this.connectionState=xe.RECONNECTING:this.connectionState=xe.CONNECTING}),this.websocket.on(Ie.WILL_RECONNECT,(e,t,r)=>{if(Ms(this,le.IS_P2P_DISCONNECTED)&&e==="retry")return S.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(le.NEED_RENEW_SESSION),this.emit(le.DISCONNECT_P2P),r("tryNext");e!=="retry"&&(S.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(le.NEED_RENEW_SESSION),this.emit(le.DISCONNECT_P2P)),r(e)}),this.websocket.on(Ie.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{S.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Qt.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(le.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof Y&&e.code===A.UNEXPECTED_RESPONSE&&e.data.code===ve.ERR_NO_AUTHORIZED)return S.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Qt.SERVER_ERROR);S.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Qt.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Ie.REQUEST_NEW_URLS,(e,t)=>{vt(this,le.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)}),this.websocket.on(Ie.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}_handleSignalP2PEvents(){this._external_signal.on(lt.JOIN,async e=>{if(this._userOnlineTime&&this._userOnlineTime<e.onlineTime){let t=await vt(this,le.P2P_START,void 0),r=await this._external_signal.send(lt.CALL,t);this.emit(le.P2P_CONNECTION,r,!0)}this._userInRoom=!0,this.emit("user-online")}),this.on(Ae.ON_USER_OFFLINE,async e=>{this._external_signal.clear(),this._userInRoom=!1}),this._external_signal.on(lt.CALL,async(e,t,r)=>{this._userInRoom=!0,this.emit("user-online");try{t(await vt(this,le.P2P_START,e))}catch(n){r(n)}})}async waitTillUserOnline(){return new F(e=>{if(this._userInRoom)e();else{let t=()=>{this.off("user-online",t),e()};this.on("user-online",t)}})}}function k0(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Dn(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?k0(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):k0(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}let Yg=new Map;class rG extends mt{get state(){return this._state}set state(e){if(e===this._state)return;let t=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(Ct.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(Ct.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){S.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){super(),g(this,"store",void 0),g(this,"joinInfo",void 0),g(this,"key",void 0),g(this,"ntpOffset",0),g(this,"signal",void 0),g(this,"role",void 0),g(this,"inChannelInfo",{joinAt:null,duration:0}),g(this,"spec",void 0),g(this,"_state","DISCONNECTED"),g(this,"_statsCollector",void 0),g(this,"_disconnectedReason",void 0),g(this,"isSignalRecover",!1),g(this,"hasChangeBGPAddress",!1),g(this,"trafficStatsInterval",void 0),g(this,"networkQualityInterval",void 0),g(this,"_joinGatewayStartTime",0),g(this,"_signalTimeout",!1),g(this,"_clientRoleOptions",void 0),g(this,"_isProactiveJoin",!1),this.store=e,this.spec=t,this.signal=this.store.useP2P?new P0(Dn(Dn({},t),{},{retryConfig:t.websocketRetryConfig}),e):this.store.useDataChannel?new Bs(Dn(Dn({},t),{},{retryConfig:t.websocketRetryConfig}),e):new QA(Dn(Dn({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(e,t,r){if(this.signal instanceof Bs){let u=!1;e.cloudProxyServer!=="disabled"?(S.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),u=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(S.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),u=!0):e.apResponse.addresses.some(h=>h.fingerprint)||P("FINGERPRINT")||(S.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),u=!0),u&&this.resetSignal()}this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);let n=Date.now(),a=Yg.get(e.cname);if(a||(a=new Map,Yg.set(e.cname,a)),this._isProactiveJoin=!0,a.has(e.uid)){let u=new x(A.UID_CONFLICT);throw Ee.joinGateway(e.sid,{lts:n,succ:!1,ec:u.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof Bs?"1":"0"}),this._isProactiveJoin=!1,u}a.set(e.uid,!0),this.joinInfo=e,this.key=t;let c=0;this.joinGatewayStartTime=n;let l=e.proxyServer;try{let u;if(S.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof Bs?"datachannel":"websocket"," join uid ").concat(c)),this.signal instanceof Bs)u=await this.signal.init(e.apResponse.addresses,r);else{let h=e.gatewayAddrs.map(p=>{let{address:_}=p,[E,T]=_.split(":"),w={host:E,port:T};return e.proxyServer&&(w.proxy=e.proxyServer),w});u=await this.signal.init(h,r)}c=u.uid,S.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof Bs?"datachannel":"websocket"," join uid ").concat(c," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(u){throw u&&u.code===A.INIT_WEBSOCKET_TIMEOUT?(S.warning("[".concat(this.store.clientId,"] User join failed"),u.toString()),u):u&&u.code===A.INIT_DATACHANNEL_TIMEOUT?(S.warning("[".concat(this.store.clientId,"] User join datachannel failed"),u.toString()),this.resetSignal(),u):(S.error("[".concat(this.store.clientId,"] User join failed"),u.toString()),Ee.joinGateway(e.sid,{lts:n,succ:!1,ec:u.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!l,signalChannel:this.signal instanceof Bs?"1":"0"}),this._isProactiveJoin=!1,a.delete(e.uid),this.signal.close(),u)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),S.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(u=>{S.warning("[".concat(this.store.clientId,"] get traffic stats error"),u.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Ct.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Ct.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Ct.NETWORK_QUALITY,{uplinkNetworkQuality:N0(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:N0(this._statsCollector.trafficStats.B_dnq)}):this.emit(Ct.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),c}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],t=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){t!==Ve.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==xe.CONNECTED||await function(r,n){return n===1/0?r:F.race([r,l3(n)])}(this.signal.request(me.LEAVE,void 0,!0),3e3)}catch(r){S.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),r)}this.signal.close(t),t!==Ve.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,t,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let n={state:"offer",p2p_id:this.store.p2pId,ortc:t,mode:this.spec.mode,extend:P("PUB_EXTEND"),twcc:!!P("PUBLISH_TWCC"),rtx:!!P("USE_PUB_RTX")};try{return(await this.signal.request(me.PUBLISH,n,!0))._message}catch(a){if(r&&a.data&&a.data.code===ve.ERR_PUBLISH_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),a.toString()),await this.tryUnpubBeforeRepub(e,t),this.publish(e,t,!1);throw a}}async publishDataChannel(e,t,r){var n;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let a={stream_id:t.streamId,ordered:t.ordered?1:0,max_retrans_times:(n=t.maxRetransmits)!==null&&n!==void 0?n:10,channel_id:t.channelId,metadata:t.metadata};try{await this.signal.request(me.PUBLISH_DATASTREAM,a,!0)}catch(c){if(r&&c.data&&c.data.code===ve.ERR_PUBLISH_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),c.toString()),await this.tryUnpubDataChannelBeforeRepub(e,t),this.publishDataChannel(e,t,!1);throw c}}async unpublish(e,t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(me.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(r){S.warning("[".concat(this.store.clientId,"] unpublish warning: "),r)}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await F.all(e.map(t=>this.signal.request(me.UNPUBLISH_DATASTREAM,{channel_id:t},!0)))}catch(t){S.warning("unpublish datachannels warning: ",t)}}async subscribe(e,t,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));let n={stream_id:e,stream_type:t.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!P("SUBSCRIBE_TWCC"),rtx:!!P("USE_SUB_RTX"),extend:P("SUB_EXTEND"),ssrcId:t.ssrcId,svc:Array.isArray(P("SVC"))&&P("SVC").length!==0?P("SVC"):void 0};try{return(await this.signal.request(me.SUBSCRIBE,n,!0))._message}catch(a){if(r&&a.data&&a.data.code===ve.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),a.toString()),await this.tryUnsubBeforeResub(e,t),await this.subscribe(e,t,!1);throw a}}async subscribeDataChannel(e,t,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));let n={uid:e,stream_id:t.id,channel_id:t.datachannelId};try{return void await this.signal.request(me.SUBSCRIBE_DATASTREAM,n,!0)}catch(a){if(r&&a.data&&a.data.code===ve.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),a.toString()),await this.tryUnsubDataChannelBeforeResub(e,t),await this.subscribeDataChannel(e,t,!1);throw a}}async subscribeAll(e,t){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));let r={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!P("USE_SUB_RTX")};try{return await this.signal.request(me.SUBSCRIBE_STREAMS,r,!0)}catch(n){if(t&&n.data&&n.data.code===ve.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),n.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw n}}async setVideoProfile(e){let t=function(r){if(!(r.bitrateMax&&r.bitrateMin&&r.frameRate&&r.height&&r.width))return;let n=r.frameRate,a=r.width,c=r.height,l=!0;return typeof n!="number"&&(n=n.exact||n.ideal||n.max||n.min||0,n||(l=!1)),typeof a!="number"&&(a=a.exact||a.ideal||a.max||a.min||0,a||(l=!1)),typeof c!="number"&&(c=c.exact||c.ideal||c.max||c.min||0,n||(l=!1)),l?{stream_type:0,width:a,height:c,fps:n,start_bps:1e3*r.bitrateMax,min_bps:1e3*r.bitrateMin,target_bps:1e3*r.bitrateMax}:void 0}(e);if(t)return this.signal.request(me.SET_VIDEO_PROFILE,t);S.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,t){try{await this.signal.request(me.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:t},!0)}catch(r){S.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),r)}}async unsubscribeDataChannel(e,t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await F.all(e.map(r=>this.signal.request(me.UNSUBSCRIBE_DATASTREAM,{stream_id:r,uid:t},!0)))}catch(r){S.warning("unsubscribeDataChannel warning: ",r)}}async massUnsubscribe(e){try{await this.signal.request(me.UNSUBSCRIBE_STREAMS,e,!0)}catch(t){S.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),t)}}async reconnectPC(e){let{iceParameters:t,dtlsParameters:r,rtpCapabilities:n}=e;return{gatewayEstablishParams:await this.signal.request(me.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:r,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(me.GATEWAY_INFO)}async renewToken(e){await this.signal.request(me.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),this.state!=="CONNECTED")return void(this.role=e);let r,n=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(r=this._clientRoleOptions.delay,n=1):n=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:n=0,await this.signal.request(me.SET_CLIENT_ROLE,{role:e,level:n,delay:r,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(me.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(me.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(me.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(me.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(me.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,t,r){if(this.signal instanceof P0)return this.signal.sendExtensionMessage(e,t,r)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Dn({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(me.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){let e=Yg.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;let e=function(t){let r;return r=t.startsWith("dc")?t.match(/(dc\:\/\/)?([^:]+):(\d+)/):t.match(/(wss\:\/\/)?([^:]+):(\d+)/),r?{username:Vr.username,password:Vr.password,turnServerURL:r[2],tcpport:parseInt(r[3])+30,udpport:parseInt(r[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Dn(Dn({},Vr),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;let e=await this.signal.request(me.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(t=>{let r=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(n=>n.peer_uid===t.peer_uid);r&&r.B_st!==t.B_st&&In(()=>{this.emit(Ct.STREAM_TYPE_CHANGE,t.peer_uid,t.B_st)})}),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new x(A.UNEXPECTED_ERROR,"can not generate join message, no join info");let t=Object.assign({},this.joinInfo.apResponse),r=P("REPORT_APP_SCENARIO");if(typeof r!="string")try{r=JSON.stringify(r)}catch{r=void 0}r&&r.length>128&&(r=void 0);let n=Dn({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:nn,browser:navigator.userAgent,process_id:P("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:P("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:r,attributes:{userAttributes:{enablePublishedUserList:P("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:P("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof P("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?P("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof P("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?P("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof P("ENABLE_USER_LICENSE_CHECK")=="boolean"?P("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:P("USE_PUB_RTX")===!0||P("USE_SUB_RTX")===!0||void 0,disableFEC:P("DISABLE_FEC"),enableNTPReport:!!P("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!P("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof P("ENABLE_DATASTREAM_2")=="boolean"?P("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof P("RTM2_FLAG")=="number"?P("RTM2_FLAG"):void 0,enableUserAutoRebalanceCheck:!!P("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof P("USE_XR")=="boolean"?P("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,P("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),this.joinInfo.defaultVideoStream!==void 0&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new x(A.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(le.WS_RECONNECT_WAITTING_FINISH,e=>{var t;ge(t=["tryNext","recover"]).call(t,e)&&this.joinInfo&&Ee.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on(le.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(le.WS_RECONNECTING,e=>{this.joinInfo&&Ee.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||Qt.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",Ee.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(le.WS_CLOSED,e=>{let t;switch(e){case Ve.LEAVE:t=Qt.LEAVE;break;case Ve.UID_BANNED:case Ve.IP_BANNED:case Ve.CHANNEL_BANNED:case Ve.SERVER_ERROR:t=Qt.SERVER_ERROR;break;case Ve.FALLBACK:t=Qt.FALLBACK;break;case Ve.LICENSE_MISSING:case Ve.LICENSE_EXPIRED:case Ve.LICENSE_MINUTES_EXCEEDED:case Ve.LICENSE_PERIOD_INVALID:case Ve.LICENSE_MULTIPLE_SDK_SERVICE:case Ve.LICENSE_ILLEGAL:case Ve.TOKEN_EXPIRE:t=e;break;default:t=Qt.NETWORK_ERROR}S.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(t||"undefined -> "+Qt.NETWORK_ERROR)),this.joinInfo&&Ee.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===Ve.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t}),this._disconnectedReason=e,e!==Ve.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(le.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(S.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),Ee.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Bs?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){let e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void S.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));it("EVENT_REPORT_DOMAIN",e[1]),it("EVENT_REPORT_BACKUP_DOMAIN",e[1]),it("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}),this.signal.on(Ae.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(le.REQUEST_RECOVER,(e,t,r)=>{if(!this.joinInfo)return r(new x(A.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,vt(this,Ct.REQUEST_NEW_GATEWAY_LIST).then(t).catch(r)}),this.signal.on(le.REQUEST_JOIN_INFO,async e=>{var t;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));let{iceParameters:r,dtlsParameters:n,rtpCapabilities:a}=await vt(this,Ct.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(t=this.joinInfo)===null||t===void 0?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:r,dtlsParameters:n,rtpCapabilities:a,version:"2"}}))}),this.signal.on(le.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(le.REPORT_JOIN_GATEWAY,(e,t)=>{this.joinInfo&&(Ee.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Bs?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on(le.IS_P2P_DISCONNECTED,e=>{e(Ms(this,Ct.IS_P2P_DISCONNECTED))}),this.signal.on(le.DISCONNECT_P2P,()=>{this.emit(Ct.DISCONNECT_P2P)}),this.signal.on(le.NEED_RENEW_SESSION,()=>{this.emit(Ct.NEED_RENEW_SESSION)}),this.signal.on(le.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(le.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(le.JOIN_RESPONSE,e=>{let t=this.getCurrentGatewayAddress();this.emit(Ct.JOIN_RESPONSE,e,t)}),this.signal.on(le.DATACHANNEL_PRECONNECT,async(e,t,r)=>{this.updateTurnConfigFromSignal();let n=this.getCurrentGatewayAddress();return vt(this,Ct.DATACHANNEL_PRECONNECT,e,n).then(t).catch(r)}),this.signal.on(le.DATACHANNEL_CONNECTING,async e=>{let{iceParameters:t,dtlsParameters:r,rtpCapabilities:n}=await vt(this,Ct.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:t,dtlsParameters:r,rtpCapabilities:n,version:"2"}}))}),this.signal.on(le.DATACHANNEL_FAILBACK,()=>{S.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Ct.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(e,t){try{await this.signal.request(me.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[t]},!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),r),r}}async tryUnsubDataChannelBeforeResub(e,t){try{await this.signal.request(me.UNSUBSCRIBE,{stream_id:t.id},!0)}catch(r){throw S.warning("unsubscribe datachannel warning",r),r}}async tryUnpubBeforeRepub(e,t){try{await this.signal.request(me.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),r),r}}async tryUnpubDataChannelBeforeRepub(e,t){try{await this.signal.request(me.UNPUBLISH_DATASTREAM,{channnel_id:t.channelId},!0)}catch(r){throw S.warning("unpublish datastream warning: ",r),r}}async tryMassUnsubBeforeResub(e){let t={users:e.map(r=>({stream_id:r.stream_id,stream_type:r.stream_type}))};try{await this.signal.request(me.UNSUBSCRIBE_STREAMS,t,!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),r),r}}async muteLocal(e,t){let r={action:e.find(n=>n.stream_type===et.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(me.CONTROL,r,!0,!0)}catch(n){throw S.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),n),n}}async unmuteLocal(e,t){let r={action:e.find(n=>n.stream_type===et.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(me.CONTROL,r,!0,!0)}catch(n){throw S.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),n),n}}async muteRemote(e,t){let r={action:e===fe.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(me.CONTROL,r,!0,!0)}catch(n){throw S.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),n),n}}async unmuteRemote(e,t){let r={action:e===fe.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(me.CONTROL,r,!0,!0)}catch(n){throw S.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),n),n}}uploadStats(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){let t={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(me.RESTART_ICE,t,!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),r),r}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,Qt.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!P("GATEWAY_WSS_ADDRESS"))return(e=this.joinInfo)!==null&&e!==void 0&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(me.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Ve.FALLBACK)),this.store.useDataChannel=!1,this.signal=new QA(Dn(Dn({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Ct.RESET_SIGNAL,Zh.websocket)}}let Dp=0,qg=0;function Gs(i,e,t,r){return new F((n,a)=>{e.timeout=e.timeout||P("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!t?(e.data=JSON.stringify(e.data),Dp+=ds(e.data)):t&&(e.data.size?Dp+=e.data.size:e.data instanceof FormData?Dp+=ww(e.data):Dp+=ds(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=i,lr.request(e).then(c=>{typeof c.data=="string"?qg+=ds(c.data):c.data instanceof ArrayBuffer||c.data instanceof Uint8Array?qg+=c.data.byteLength:qg+=ds(JSON.stringify(c.data)),r&&n({data:c.data,headers:c.headers}),n(c.data)}).catch(c=>{lr.isCancel(c)?a(new x(A.OPERATION_ABORTED,"cancel token canceled")):c.code==="ECONNABORTED"?a(new x(A.NETWORK_TIMEOUT,c.message)):c.response?a(new x(A.NETWORK_RESPONSE_ERROR,c.response.status)):a(new x(A.NETWORK_ERROR,c.message))})})}(function(){var i;function e(Z){var re=0;return function(){return re<Z.length?{done:!1,value:Z[re++]}:{done:!0}}}var t=typeof Object.defineProperties=="function"?Object.defineProperty:function(Z,re,he){return Z==Array.prototype||Z==Object.prototype||(Z[re]=he.value),Z},r,n=function(Z){Z=[typeof globalThis=="object"&&globalThis,Z,typeof window=="object"&&window,typeof self=="object"&&self,typeof uc=="object"&&uc];for(var re=0;re<Z.length;++re){var he=Z[re];if(he&&he.Math==Math)return he}throw Error("Cannot find global object")}(this);function a(Z,re){if(re)e:{var he=n;Z=Z.split(".");for(var Ne=0;Ne<Z.length-1;Ne++){var qe=Z[Ne];if(!(qe in he))break e;he=he[qe]}(re=re(Ne=he[Z=Z[Z.length-1]]))!=Ne&&re!=null&&t(he,Z,{configurable:!0,writable:!0,value:re})}}function c(Z){return(Z={next:Z})[Symbol.iterator]=function(){return this},Z}function l(Z){var re=typeof Symbol<"u"&&Symbol.iterator&&Z[Symbol.iterator];return re?re.call(Z):{next:e(Z)}}if(a("Symbol",function(Z){function re(qe,oe){this.A=qe,t(this,"description",{configurable:!0,writable:!0,value:oe})}if(Z)return Z;re.prototype.toString=function(){return this.A};var he="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",Ne=0;return function qe(oe){if(this instanceof qe)throw new TypeError("Symbol is not a constructor");return new re(he+(oe||"")+"_"+Ne++,oe)}}),a("Symbol.iterator",function(Z){if(Z)return Z;Z=Symbol("Symbol.iterator");for(var re="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),he=0;he<re.length;he++){var Ne=n[re[he]];typeof Ne=="function"&&typeof Ne.prototype[Z]!="function"&&t(Ne.prototype,Z,{configurable:!0,writable:!0,value:function(){return c(e(this))}})}return Z}),typeof Object.setPrototypeOf=="function")r=Object.setPrototypeOf;else{var u;e:{var h={};try{h.__proto__={a:!0},u=h.a;break e}catch{}u=!1}r=u?function(Z,re){if(Z.__proto__=re,Z.__proto__!==re)throw new TypeError(Z+" is not extensible");return Z}:null}var p=r;function _(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function E(Z){if(Z.m)throw new TypeError("Generator is already running");Z.m=!0}function T(Z,re){return Z.h=3,{value:re}}function w(Z){this.g=new _,this.G=Z}function C(Z,re,he,Ne){try{var qe=re.call(Z.g.j,he);if(!(qe instanceof Object))throw new TypeError("Iterator result "+qe+" is not an object");if(!qe.done)return Z.g.m=!1,qe;var oe=qe.value}catch(y){return Z.g.j=null,Z.g.s(y),O(Z)}return Z.g.j=null,Ne.call(Z.g,oe),O(Z)}function O(Z){for(;Z.g.h;)try{var re=Z.G(Z.g);if(re)return Z.g.m=!1,{value:re.value,done:!1}}catch(he){Z.g.v=void 0,Z.g.s(he)}if(Z.g.m=!1,Z.g.l){if(re=Z.g.l,Z.g.l=null,re.F)throw re.D;return{value:re.return,done:!0}}return{value:void 0,done:!0}}function b(Z){this.next=function(re){return Z.o(re)},this.throw=function(re){return Z.s(re)},this.return=function(re){return function(he,Ne){E(he.g);var qe=he.g.j;return qe?C(he,"return"in qe?qe.return:function(oe){return{value:oe,done:!0}},Ne,he.g.return):(he.g.return(Ne),O(he))}(Z,re)},this[Symbol.iterator]=function(){return this}}function k(Z,re){return re=new b(new w(re)),p&&Z.prototype&&p(re,Z.prototype),re}if(_.prototype.o=function(Z){this.v=Z},_.prototype.s=function(Z){this.l={D:Z,F:!0},this.h=this.C||this.u},_.prototype.return=function(Z){this.l={return:Z},this.h=this.u},w.prototype.o=function(Z){return E(this.g),this.g.j?C(this,this.g.j.next,Z,this.g.o):(this.g.o(Z),O(this))},w.prototype.s=function(Z){return E(this.g),this.g.j?C(this,this.g.j.throw,Z,this.g.o):(this.g.s(Z),O(this))},a("Array.prototype.entries",function(Z){return Z||function(){return function(re,he){re instanceof String&&(re+="");var Ne=0,qe=!1,oe={next:function(){if(!qe&&Ne<re.length){var y=Ne++;return{value:he(y,re[y]),done:!1}}return qe=!0,{done:!0,value:void 0}}};return oe[Symbol.iterator]=function(){return oe},oe}(this,function(re,he){return[re,he]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var U=function(Z,re){for(var he=0;he<Z.length;he++)re(Z[he])},X=function(Z){return Z.replace(/\r?\n|\r/g,`\r
`)},z=function(Z,re,he){return re instanceof Blob?(he=he!==void 0?he+"":typeof re.name=="string"?re.name:"blob",re.name===he&&Object.prototype.toString.call(re)!=="[object Blob]"||(re=new File([re],he)),[String(Z),re]):[String(Z),String(re)]},j=function(Z,re){if(Z.length<re)throw new TypeError(re+" argument required, but only "+Z.length+" present.")},B=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,W=B.FormData,ce=B.XMLHttpRequest&&B.XMLHttpRequest.prototype.send,ne=B.Request&&B.fetch,Pe=B.navigator&&B.navigator.sendBeacon,We=B.Element&&B.Element.prototype,It=B.Symbol&&Symbol.toStringTag;It&&(Blob.prototype[It]||(Blob.prototype[It]="Blob"),"File"in B&&!File.prototype[It]&&(File.prototype[It]="File"));try{new File([],"")}catch{B.File=function(Z,re,he){return Z=new Blob(Z,he||{}),Object.defineProperties(Z,{name:{value:re},lastModified:{value:+(he&&he.lastModified!==void 0?new Date(he.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),It&&Object.defineProperty(Z,It,{value:"File"}),Z}}var Gt=function(Z){return Z.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},pt=function(Z){this.i=[];var re=this;Z&&U(Z.elements,function(he){if(he.name&&!he.disabled&&he.type!=="submit"&&he.type!=="button"&&!he.matches("form fieldset[disabled] *"))if(he.type==="file"){var Ne=he.files&&he.files.length?he.files:[new File([],"",{type:"application/octet-stream"})];U(Ne,function(qe){re.append(he.name,qe)})}else he.type==="select-multiple"||he.type==="select-one"?U(he.options,function(qe){!qe.disabled&&qe.selected&&re.append(he.name,qe.value)}):he.type==="checkbox"||he.type==="radio"?he.checked&&re.append(he.name,he.value):(Ne=he.type==="textarea"?X(he.value):he.value,re.append(he.name,Ne))})};if((i=pt.prototype).append=function(Z,re,he){j(arguments,2),this.i.push(z(Z,re,he))},i.delete=function(Z){j(arguments,1);var re=[];Z=String(Z),U(this.i,function(he){he[0]!==Z&&re.push(he)}),this.i=re},i.entries=function Z(){var re,he=this;return k(Z,function(Ne){if(Ne.h==1&&(re=0),Ne.h!=3)return re<he.i.length?Ne=T(Ne,he.i[re]):(Ne.h=0,Ne=void 0),Ne;re++,Ne.h=2})},i.forEach=function(Z,re){j(arguments,1);for(var he=l(this),Ne=he.next();!Ne.done;Ne=he.next()){var qe=l(Ne.value);Ne=qe.next().value,qe=qe.next().value,Z.call(re,qe,Ne,this)}},i.get=function(Z){j(arguments,1);var re=this.i;Z=String(Z);for(var he=0;he<re.length;he++)if(re[he][0]===Z)return re[he][1];return null},i.getAll=function(Z){j(arguments,1);var re=[];return Z=String(Z),U(this.i,function(he){he[0]===Z&&re.push(he[1])}),re},i.has=function(Z){j(arguments,1),Z=String(Z);for(var re=0;re<this.i.length;re++)if(this.i[re][0]===Z)return!0;return!1},i.keys=function Z(){var re,he,Ne,qe,oe=this;return k(Z,function(y){if(y.h==1&&(re=l(oe),he=re.next()),y.h!=3)return he.done?void(y.h=0):(Ne=he.value,qe=l(Ne),T(y,qe.next().value));he=re.next(),y.h=2})},i.set=function(Z,re,he){j(arguments,2),Z=String(Z);var Ne=[],qe=z(Z,re,he),oe=!0;U(this.i,function(y){y[0]===Z?oe&&(oe=!Ne.push(qe)):Ne.push(y)}),oe&&Ne.push(qe),this.i=Ne},i.values=function Z(){var re,he,Ne,qe,oe=this;return k(Z,function(y){if(y.h==1&&(re=l(oe),he=re.next()),y.h!=3)return he.done?void(y.h=0):(Ne=he.value,(qe=l(Ne)).next(),T(y,qe.next().value));he=re.next(),y.h=2})},pt.prototype._asNative=function(){for(var Z=new W,re=l(this),he=re.next();!he.done;he=re.next()){var Ne=l(he.value);he=Ne.next().value,Ne=Ne.next().value,Z.append(he,Ne)}return Z},pt.prototype._blob=function(){var Z="----formdata-polyfill-"+Math.random(),re=[],he="--"+Z+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(Ne,qe){return typeof Ne=="string"?re.push(he+Gt(X(qe))+`"\r
\r
`+X(Ne)+`\r
`):re.push(he+Gt(X(qe))+'"; filename="'+Gt(Ne.name)+`"\r
Content-Type: `+(Ne.type||"application/octet-stream")+`\r
\r
`,Ne,`\r
`)}),re.push("--"+Z+"--"),new Blob(re,{type:"multipart/form-data; boundary="+Z})},pt.prototype[Symbol.iterator]=function(){return this.entries()},pt.prototype.toString=function(){return"[object FormData]"},We&&!We.matches&&(We.matches=We.matchesSelector||We.mozMatchesSelector||We.msMatchesSelector||We.oMatchesSelector||We.webkitMatchesSelector||function(Z){for(var re=(Z=(this.document||this.ownerDocument).querySelectorAll(Z)).length;0<=--re&&Z.item(re)!==this;);return-1<re}),It&&(pt.prototype[It]="FormData"),ce){var Ir=B.XMLHttpRequest.prototype.setRequestHeader;B.XMLHttpRequest.prototype.setRequestHeader=function(Z,re){Ir.call(this,Z,re),Z.toLowerCase()==="content-type"&&(this.B=!0)},B.XMLHttpRequest.prototype.send=function(Z){Z instanceof pt?(Z=Z._blob(),this.B||this.setRequestHeader("Content-Type",Z.type),ce.call(this,Z)):ce.call(this,Z)}}ne&&(B.fetch=function(Z,re){return re&&re.body&&re.body instanceof pt&&(re.body=re.body._blob()),ne.call(this,Z,re)}),Pe&&(B.navigator.sendBeacon=function(Z,re){return re instanceof pt&&(re=re._asNative()),Pe.call(this,Z,re)}),B.FormData=pt}})();let Pp=()=>{let i=P("AREAS");return i.length===0&&i.push(He.GLOBAL),yo(i).call(i,(e,t,r)=>{let n=L0(t);return n?r===0?n:"".concat(e,",").concat(n):e},"")},L0=i=>i===He.OVERSEA?"".concat(pi.ASIA,",").concat(pi.EUROPE,",").concat(pi.AFRICA,",").concat(pi.NORTH_AMERICA,",").concat(pi.SOUTH_AMERICA,",").concat(pi.OCEANIA):pi[i],nG=i=>{let e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return i.map(t=>{let r=ep[t],n=Object.keys(r);n&&n.map(a=>{a!=="CODE"&&(e[a]=e[a].concat(r[a]))})}),e},kp={GLOBAL:{ASIA:[He.CHINA,He.JAPAN,He.INDIA,He.KOREA,He.HKMC],EUROPE:[],NORTH_AMERICA:[He.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Lp=Object.keys(kp[He.GLOBAL]),Jg=[He.CHINA,He.NORTH_AMERICA,He.EUROPE,He.ASIA,He.JAPAN,He.INDIA,He.OCEANIA,He.SOUTH_AMERICA,He.AFRICA,He.KOREA,He.HKMC,He.US],sG=function(i,e){let t=[];if(ge(i).call(i,He.GLOBAL)){let a=[He.GLOBAL,He.OVERSEA],c=Object.keys(ep);if(e===He.GLOBAL)throw new x(A.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===He.CHINA)t=[He.OVERSEA];else if(n=e,ge(Lp).call(Lp,n)){let l=(r=e,kp[He.GLOBAL][r]||[]),u=[...a,e,...l];t=c.filter(h=>!ge(u).call(u,h))}else if(function(l){let u=!1;return Lp.forEach(h=>{var p;ge(p=kp[He.GLOBAL][h]).call(p,l)&&(u=!0)}),u}(e)){let l=function(h){let p;return Lp.forEach(_=>{var E;ge(E=kp[He.GLOBAL][_]).call(E,h)&&(p=_)}),p}(e),u=[...a,l,e];t=c.filter(h=>!ge(u).call(u,h))}else t=i;t=function(l){let u=[];return Jg.forEach(h=>{ge(l).call(l,h)&&u.push(h)}),u.concat(l.filter(h=>!ge(Jg).call(Jg,h)))}(t)}else t=i;var r,n;return t};function M0(i){var e,t;if(!i&&ge(e=P("AREAS")).call(e,He.EXTENSIONS))return S.debug("update area from ap : reset"),void Xg(n5,!0);if(!ge(t=P("AREAS")).call(t,He.GLOBAL)||!i)return;let r=ep.EXTENSIONS;r&&(r={CODE:L0(He.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(i,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(i,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(i,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(i,".agora.io"),"cds-ap-web-2-".concat(i,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(i,".agora.io"),"sua-ap-web-2-".concat(i,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(i,".agora.io"),"uap-ap-web-2-".concat(i,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(i,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(i,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(i,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(i,".agora.io")]},S.debug("update area from ap success: ".concat(i,",config is "),r),it("AREAS",[He.EXTENSIONS],!0),Object.keys(r).map(n=>{n==="LOG_UPLOAD_SERVER"||n==="EVENT_REPORT_DOMAIN"||n==="EVENT_REPORT_BACKUP_DOMAIN"||n==="PROXY_SERVER_TYPE3"?it(n,r[n][0]):it(n,r[n])}))}function Xg(i){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],t=Ee.reportApiInvoke(null,{name:jt.SET_AREA,options:i,tag:St.TRACER});try{let r=[];if(typeof i=="string"&&(r=[i]),Array.isArray(i)&&(i.forEach(a=>{if(!ge(jA).call(jA,a))throw new x(A.INVALID_PARAMS,"invalid area code")}),r=i),Object.prototype.toString.call(i)==="[object Object]"){let{areaCode:a,excludedArea:c}=i;if(!a)throw new x(A.INVALID_PARAMS,"area code is needed");let l=a;typeof a=="string"&&(l=[a]),r=c?sG(l,c):l}if(!e){if(ua.AREAS){let a=new x(A.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return t.onError(a),void S.warning("setArea is prohibited because of config-distribute")}if(ge(r).call(r,He.GLOBAL)&&P("AREAS")===He.EXTENSIONS){let a=new x(A.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return t.onError(a),void S.warning("setArea is prohibited because of ap extensions")}}it("AREAS",r,e);let n=nG(r);Object.keys(n).map(a=>{a==="LOG_UPLOAD_SERVER"||a==="EVENT_REPORT_DOMAIN"||a==="EVENT_REPORT_BACKUP_DOMAIN"||a==="PROXY_SERVER_TYPE3"?it(a,n[a][0]):it(a,n[a])}),S.debug("set area success:",r.join(","))}catch(r){throw t.onError(r),r}t.onSuccess()}function U0(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Qg(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?U0(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):U0(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}let $g=1;function aG(i,e,t,r,n){$g+=1;let a={sid:t.sid,command:"convergeAllocateEdge",uid:"666",appId:t.appId,ts:Math.floor(Date.now()/1e3),seq:$g,requestId:$g,version:nn,cname:t.cname},c={service_name:e,json_body:JSON.stringify(a)},l,u,h=i[0];return Kn(async()=>{l=Date.now();let p=await Gs(h,{data:c,cancelToken:r,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(u=Date.now()-l,p.code!==0){let T=new x(A.UNEXPECTED_RESPONSE,"live streaming ap error, code"+p.code,{retry:!0,responseTime:u});throw S.error(T.toString()),T}let _=JSON.parse(p.json_body);if(_.code!==200){let T=new x(A.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(_.code,", reason: ").concat(_.reason),{code:_.code,responseTime:u});throw S.error(T.toString()),T}if(!_.servers||_.servers.length===0){let T=new x(A.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:_.code,responseTime:u});throw S.error(T.toString()),T}let E=function(T,w){return{addressList:T.servers.map(C=>"wss://".concat(C.address.replace(/\./g,"-"),".").concat(P("WORKER_DOMAIN"),":").concat(C.wss,"?serviceName=").concat(encodeURIComponent(w))),workerToken:T.workerToken,vid:T.vid}}(_,e);return P("LIVE_STREAMING_ADDRESS")&&(E.addressList=P("LIVE_STREAMING_ADDRESS")instanceof Array?P("LIVE_STREAMING_ADDRESS"):[P("LIVE_STREAMING_ADDRESS")]),Qg(Qg({},E),{},{responseTime:u})},(p,_)=>(Ee.apworkerEvent(t.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(p.addressList),firstSuccess:_===0,responseTime:u,serverIp:i[_%i.length]}),!1),(p,_)=>(Ee.apworkerEvent(t.sid,{success:!1,sc:p.data&&p.data.code||200,serviceName:e,responseTime:u,serverIp:i[_%i.length]}),!!(p.code!==A.OPERATION_ABORTED&&p.code!==A.UNEXPECTED_RESPONSE||p.data&&p.data.retry)&&(h=i[(_+1)%i.length],!0)),n)}let Zg=1;function x0(i,e,t,r){let{url:n,areaCode:a}=i,c=Date.now(),l,[u,h]=B0(e,a,[ai.CHOOSE_SERVER]),p=Mt.networkState;return Kn(async()=>{p&&Mt.networkState===ji.OFFLINE&&Mt.onlineWaiter&&await F.race([Mt.onlineWaiter,Si(r&&r.maxRetryTimeout||xt.maxRetryTimeout)]),p=Mt.networkState;let{data:_,headers:E}=await Gs(n,{data:u,cancelToken:t,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);l=E.http3==="1"?1:-1,Ee.reportResourceTiming(n,e.sid),F0(_,n,e,c,[ai.CHOOSE_SERVER],l);let T=Kg(_,ai.CHOOSE_SERVER);return j0(T),A0(T,n)},_=>(_&&Ee.joinChooseServer(e.sid,{lts:c,succ:!0,csAddr:n,opid:h,serverList:_.gatewayAddrs.map(E=>E.address),ec:null,cid:_.cid.toString(),uid:_.uid.toString(),csIp:_.csIp,unilbsServerIds:[ai.CHOOSE_SERVER].toString(),isHttp3:l}),!1),_=>_.code!==A.OPERATION_ABORTED&&(_.code===A.CAN_NOT_GET_GATEWAY_SERVER?_.data.retry:(Ee.joinChooseServer(e.sid,{lts:c,succ:!1,csAddr:n,serverList:null,opid:h,ec:_.code,csIp:_.data&&_.data.csIp,unilbsServerIds:[ai.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:p}),isHttp3:l}),S.warning("[".concat(e.clientId,"] Choose server network error, retry"),_),!0)),r)}function V0(i,e,t,r){let n,{url:a,areaCode:c,serviceIds:l}=i,u=Date.now(),[h,p]=B0(e,c,l),_;return Kn(async()=>{_&&Mt.networkState===ji.OFFLINE&&Mt.onlineWaiter&&await F.race([Mt.onlineWaiter,Si(r&&r.maxRetryTimeout||xt.maxRetryTimeout)]),_=Mt.networkState;let{data:E,headers:T}=await Gs(a,{data:h,cancelToken:t,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);n=T.http3==="1"?1:-1,Ee.reportResourceTiming(a,e.sid),F0(E,a,e,u,l,n);let w=Kg(E,ai.CHOOSE_SERVER),C=Kg(E,e.cloudProxyServer==="proxy5"?ai.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?ai.CLOUD_PROXY:ai.CLOUD_PROXY_FALLBACK);return j0(w),{gatewayInfo:A0(w,a),proxyInfo:C,url:a}},E=>(E.gatewayInfo&&Ee.joinChooseServer(e.sid,{lts:u,succ:!0,csAddr:a,serverList:E.gatewayInfo.gatewayAddrs.map(T=>T.address),ec:null,opid:p,cid:E.gatewayInfo.cid.toString(),uid:E.gatewayInfo.uid.toString(),csIp:E.gatewayInfo.csIp,unilbsServerIds:l.toString(),isHttp3:n}),E.proxyInfo&&Ee.joinWebProxyAP(e.sid,{lts:u,sucess:1,apServerAddr:a,turnServerAddrList:E.proxyInfo.addresses.map(T=>T.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:l.toString()}),!1),E=>E.code!==A.OPERATION_ABORTED&&(E.code===A.CAN_NOT_GET_GATEWAY_SERVER?E.data.retry:(Ee.joinWebProxyAP(e.sid,{lts:u,sucess:0,apServerAddr:a,turnServerAddrList:null,errorCode:E.code,eventType:e.cloudProxyServer,unilbsServerIds:l.toString(),extend:JSON.stringify({networkState:_})}),S.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),E),!0)),r)}let F0=(i,e,t,r,n,a)=>{let c=[],l=u=>{u.flag===4096?Ee.joinChooseServer(t.sid,{lts:r,succ:!1,csAddr:e,opid:i.opid,serverList:null,ec:u.error.message,csIp:u.error.data&&u.error.data.csIp,unilbsServerIds:n.toString(),isHttp3:a}):u.flag!==1048576&&u.flag!==4194304&&u.flag!==4194310||Ee.joinWebProxyAP(t.sid,{lts:r,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:u.error.code,eventType:t.cloudProxyServer,unilbsServerIds:n.toString()})};if(i.response_body.forEach(u=>{let h=u.buffer.code;if(u.uri===23&&h===0&&!u.buffer.edges_services)if(u.buffer.flag===4194310)S.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),u.buffer.edges_services=[];else{let p={error:new x(A.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:i.detail[502]}),flag:u.buffer.flag};c.push(p),l(p)}if(h!==0){let p=ip(h),_={error:new x(A.CAN_NOT_GET_GATEWAY_SERVER,p.desc,{desc:p.desc,retry:p.retry,csIp:i.detail[502]}),flag:u.buffer.flag};u.buffer.flag===4194310?S.warning(_.error.toString()):c.push(_),l(_)}}),c.length)throw S.warning("[".concat(t.clientId,"] multi unilbs ").concat(e," failed, ").concat(c.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message,", retry: ").concat(u.error.data.retry)).join(" | "))),new x(A.CAN_NOT_GET_GATEWAY_SERVER,c.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message)).join(" | "),{retry:!!c.find(u=>u.error.data.retry),csIp:i.detail[502],desc:[...new Set(c.map(u=>{var h;return u==null||(h=u.error)===null||h===void 0||(h=h.data)===null||h===void 0?void 0:h.desc}).filter(u=>!!u))]})},j0=i=>{var e,t,r,n;if(i.addresses&&i.addresses.length===0&&i.code===0)throw new x(A.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:i.detail&&i.detail[502]});if(P("AP_AREA")&&((r=i.detail)!==null&&r!==void 0&&r[23]&&typeof((n=i.detail)===null||n===void 0?void 0:n[23])=="string"?M0(i.detail[23].toLowerCase()):M0()),(e=i.detail)!==null&&e!==void 0&&e[19]&&typeof((t=i.detail)===null||t===void 0?void 0:t[19])=="string"){let c=i.detail[19],l=c==null?void 0:c.split(";");for(let u=0;u<l.length;u++){var a;let h=sg(a=l[u]).call(a);i.addresses[u]&&l&&(i.addresses[u].fingerprint=h)}}if(P("GATEWAY_ADDRESS")&&P("GATEWAY_ADDRESS").length>0){S.debug("assign gateway address to",P("GATEWAY_ADDRESS"));let c=P("GATEWAY_ADDRESS").map(l=>{var u,h;let p=(u=(h=i.addresses.find(_=>_.ip===l.ip&&_.port===l.port))===null||h===void 0?void 0:h.fingerprint)!==null&&u!==void 0?u:"";return{ip:l.ip,port:l.port,ticket:i.addresses[0]&&i.addresses[0].ticket,fingerprint:p}});i.addresses=c}},oG=(i,e)=>{if(i.response_body&&i.response_body.length){let t=i.response_body[0];if(t.buffer.code!==0){let r=ip(t.buffer.code);throw new x(A.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(r.desc),{retry:r.retry})}return t.buffer.ticket}throw S.debug("update ticket request received ap response without response body:",e),new x(A.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},B0=(i,e,t)=>{let r=Math.floor(Math.random()*1e12),n={appid:i.appId,client_ts:Date.now(),opid:r,sid:i.sid,request_bodies:[{uri:22,buffer:{cname:i.cname,detail:Qg({6:i.stringUid,11:e,12:P("USE_NEW_TOKEN")?"1":void 0,22:e},P("AP_RTM")?{26:"RTM2"}:{}),key:i.token,service_ids:t,uid:i.uid||0}}]};n.request_bodies.forEach(c=>{i.multiIP&&i.multiIP.gateway_ip&&(c.buffer.detail[5]=JSON.stringify({vocs_ip:[i.multiIP.uni_lbs_ip],vos_ip:[i.multiIP.gateway_ip]}))});let a=new FormData;return a.append("request",JSON.stringify(n)),[a,r]},cG=(i,e)=>{let t=Math.floor(Math.random()*1e12),r={appid:i.appId,client_ts:Date.now(),opid:t,sid:i.sid,request_bodies:[{uri:28,buffer:{cname:i.cname,detail:{1:"",6:i.stringUid,12:"1"},token:i.token,service_ids:e,uid:i.uid||0,edges_services:i.apResponse.addresses.map(a=>({ip:a.ip,port:a.port}))}}]},n=new FormData;return n.append("request",JSON.stringify(r)),[n,t]},rl=0;function nl(i){return F.all(i.map(e=>e.then(t=>{throw t},t=>t))).then(e=>{throw e},e=>e)}let Fd=async i=>{let{fragementLength:e,referenceList:t,asyncMapHandler:r,allFailedhandler:n,promisesCollector:a}=i,c=0,l=e,u,h=0,p=async()=>{let _=(()=>{let E=c*l,T=E+l;return t.slice(E,T).map(r)})();a&&a.push(..._);try{u=await nl(_)}catch(E){if(h+=l,c++,!(h>=t.length))return void await p();n(E)}_.forEach(E=>E.cancel())};return await p(),u};async function eS(i,e,t,r){return{gatewayInfo:await async function(n,a,c,l){let u=null,h=[],p=async()=>{let E=P("WEBCS_DOMAIN").slice(0,P("AJAX_REQUEST_CONCURRENT")).map(C=>({url:n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(C+"/api/v2/transpond/webrtc?v=2"):"https://".concat(C,"/api/v2/transpond/webrtc?v=2"),areaCode:Pp()})),T=l.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:E.map(C=>C.url)}),w=await Fd({fragementLength:P("FRAGEMENT_LENGTH"),referenceList:E,asyncMapHandler:C=>(S.debug("[".concat(n.clientId,"] Connect to choose_server:"),C.url),x0(C,n,a,c)),allFailedhandler:C=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:C},T),C[0]},promisesCollector:h});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},T),w},_=async()=>{if(await Si(1e3),u!==null)return u;let E=P("WEBCS_DOMAIN_BACKUP_LIST").map(C=>({url:n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(C+"/api/v2/transpond/webrtc?v=2"):"https://".concat(C,"/api/v2/transpond/webrtc?v=2"),areaCode:Pp()})),T=l.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:E.map(C=>C.url)}),w=await Fd({fragementLength:P("FRAGEMENT_LENGTH"),referenceList:E,asyncMapHandler:C=>(S.debug("[".concat(n.clientId,"] Connect to backup choose_server:"),C.url),x0(C,n,a,c)),allFailedhandler:C=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:C},T),C[0]},promisesCollector:h});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},T),w};try{return u=await nl([p(),_()]),h.length&&h.forEach(E=>E.cancel&&typeof E.cancel=="function"&&E.cancel()),u}catch(E){throw E[0]}}(i,e,t,r)}}async function G0(i,e,t,r,n){let a=i.cloudProxyServer;if(a==="disabled"){if(!r)return;if(i.useLocalAccessPoint)return await eS(i,e,t,n);if(P("JOIN_WITH_FALLBACK_MEDIA_PROXY")){let{gatewayInfo:h,proxyInfo:p}=await H0(i,e,t,n);return i.turnServer&&i.turnServer.mode!=="auto"||(i.turnServer={mode:"manual",servers:p.map(_=>({turnServerURL:_.address,tcpport:_.tcpport||Vr.tcpport,udpport:_.udpport||Vr.udpport,username:_.username||Vr.username,password:_.password||Vr.password,forceturn:!1,security:!0}))}),{gatewayInfo:h}}return await eS(i,e,t,n)}let{proxyInfo:c,gatewayInfo:l}=await H0(i,e,t,n),u={gatewayInfo:l};return i.turnServer={mode:"manual",servers:c.map(h=>({turnServerURL:h.address,tcpport:a==="proxy3"?void 0:h.tcpport?h.tcpport:Vr.tcpport,udpport:a==="proxy4"?void 0:h.udpport?h.udpport:Vr.udpport,username:h.username||Vr.username,password:h.password||Vr.password,forceturn:a!=="proxy4",security:a==="proxy5"}))},S.debug("[".concat(i.clientId,"] set proxy server: ").concat(i.proxyServer,", mode: ").concat(a)),u}async function W0(i,e,t,r,n){let a=P("ACCOUNT_REGISTER").slice(0,P("AJAX_REQUEST_CONCURRENT")),c=[];c=e.proxyServer?a.map(u=>"https://".concat(e.proxyServer,"/ap/?url=").concat(u+"/api/v1")):a.map(u=>"https://".concat(u,"/api/v1"));let l=n==null?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:c});try{let u=await async function(h,p,_,E,T){let w=Date.now(),C={sid:_.sid,opid:10,appid:_.appId,string_uid:p},O=h[0],b=await Kn(()=>Gs(O+"".concat(O.indexOf("?")===-1?"?":"&","action=stringuid"),{data:C,cancelToken:E,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(k,U)=>{if(k.code===0){if(k.uid<=0||k.uid>=Math.pow(2,32))throw S.error("Invalid Uint Uid ".concat(p," => ").concat(k.uid),k),Ee.reqUserAccount(C.sid,{lts:w,success:!1,serverAddr:O,stringUid:C.string_uid,uid:k.uid,errorCode:A.INVALID_UINT_UID_FROM_STRING_UID,extend:C}),new x(A.INVALID_UINT_UID_FROM_STRING_UID);return Ee.reqUserAccount(C.sid,{lts:w,success:!0,serverAddr:O,stringUid:C.string_uid,uid:k.uid,errorCode:null,extend:C}),!1}let X=ip(k.code);return X.retry&&(O=h[(U+1)%h.length]),Ee.reqUserAccount(C.sid,{lts:w,success:!1,serverAddr:O,stringUid:C.string_uid,uid:k.uid,errorCode:X.desc,extend:C}),X.retry},(k,U)=>k.code!==A.OPERATION_ABORTED&&(Ee.reqUserAccount(C.sid,{lts:w,success:!1,serverAddr:O,stringUid:C.string_uid,uid:null,errorCode:k.code,extend:C}),O=h[(U+1)%h.length],!0),T);if(b.code!==0){let k=ip(b.code);throw new x(A.UNEXPECTED_RESPONSE,k.desc)}return b}(c,i,e,t,r);return n==null||n.recordJoinChannelService({status:"success",endTs:Date.now()},l),u.uid}catch(u){throw n==null||n.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[u]},l),u}}async function lG(i,e,t){let r=P("CDS_AP").slice(0,P("AJAX_REQUEST_CONCURRENT")).map(l=>i.proxyServer?"https://".concat(i.proxyServer,"/ap/?url=").concat(l+"/api/v1"):"https://".concat(l,"/api/v1?action=config")).map(l=>function(u,h,p,_){let E=ze(),T={flag:64,cipher_method:0,features:{device:E.name,system:E.os,system_general:navigator.userAgent,vendor:h.appId,version:nn,cname:h.cname,sid:h.sid,session_id:h.sid,detail:"",proxyServer:h.proxyServer}};return Kn(()=>Gs(u,{data:T,timeout:1e3,cancelToken:p,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,w=>w.code!==A.OPERATION_ABORTED,_)}(l,i,e,t)),n=null,a=null,c={};try{n=await nl(r)}catch(l){if(l.code===A.OPERATION_ABORTED)throw l;a=l}if(r.forEach(l=>l.cancel()),Ee.reportApiInvoke(i.sid,{name:jt.REQUEST_CONFIG_DISTRIBUTE,options:{error:a,res:n}}).onSuccess(),n&&n.test_tags)try{c=function(l){if(!l.test_tags)return{};let u=l.test_tags,h=Object.keys(u),p={};return h.forEach(_=>{var E;let T=sg(E=_.slice(4)).call(E),w=JSON.parse(u[_])[1];p[T]=w}),p}(n)}catch{}return c}async function H0(i,e,t,r){let n=P("PROXY_SERVER_TYPE3"),a=(T,w,C)=>{let O=C||n;return Array.isArray(O)&&(O=w%2==0?n[1]:n[0]),"https://".concat(O,"/ap/?url=").concat(T)},c=null,l=[],u=async()=>{let T=P("WEBCS_DOMAIN").slice(0,P("AJAX_REQUEST_CONCURRENT")).map((O,b)=>{let k;return k=i.cloudProxyServer==="disabled"&&i.proxyServer?a("".concat(O,"/api/v2/transpond/webrtc?v=2"),b,i.proxyServer):i.cloudProxyServer==="disabled"||i.cloudProxyServer==="fallback"?"https://".concat(O,"/api/v2/transpond/webrtc?v=2"):a("".concat(O,"/api/v2/transpond/webrtc?v=2"),b),{url:k,areaCode:Pp(),serviceIds:[ai.CHOOSE_SERVER,i.cloudProxyServer==="proxy5"?ai.CLOUD_PROXY_5:i.cloudProxyServer==="proxy3"||i.cloudProxyServer==="proxy4"?ai.CLOUD_PROXY:ai.CLOUD_PROXY_FALLBACK]}}),w=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:T.map(O=>O.url)}),C=await Fd({fragementLength:P("FRAGEMENT_LENGTH"),referenceList:T,asyncMapHandler:O=>(S.debug("[".concat(i.clientId,"] Connect to choose_server:"),O.url),V0(O,i,e,t)),allFailedhandler:O=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:O},w),O[0]},promisesCollector:l});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},w),C},h=async()=>{if(await Si(1e3),c!==null)return c;let T=P("WEBCS_DOMAIN_BACKUP_LIST").map((O,b)=>{let k;return k=i.cloudProxyServer==="disabled"&&i.proxyServer?a("".concat(O,"/api/v2/transpond/webrtc?v=2"),b,i.proxyServer):i.cloudProxyServer==="disabled"||i.cloudProxyServer==="fallback"?"https://".concat(O,"/api/v2/transpond/webrtc?v=2"):a("".concat(O,"/api/v2/transpond/webrtc?v=2"),b),{url:k,areaCode:Pp(),serviceIds:[ai.CHOOSE_SERVER,i.cloudProxyServer==="proxy5"?ai.CLOUD_PROXY_5:i.cloudProxyServer==="proxy3"||i.cloudProxyServer==="proxy4"?ai.CLOUD_PROXY:ai.CLOUD_PROXY_FALLBACK]}}),w=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:T.map(O=>O.url)}),C=await Fd({fragementLength:P("FRAGEMENT_LENGTH"),referenceList:T,asyncMapHandler:O=>(S.debug("[".concat(i.clientId,"] Connect to backup choose_server:"),O.url),V0(O,i,e,t)),allFailedhandler:O=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:O},w),O[0]},promisesCollector:l});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},w),C},p,_,E;try{({gatewayInfo:p,proxyInfo:_,url:E}=await nl([u(),h()]))}catch(T){throw T[0]}if(l.length&&l.forEach(T=>T.cancel&&typeof T.cancel=="function"&&T.cancel()),!p||!_)throw new x(A.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(i.apUrl=E,i.cloudProxyServer!=="disabled"&&Array.isArray(n)&&E){let T=/^https?:\/\/(.+?)(\/.*)?$/.exec(E)[1];ge(n).call(n,T)&&(i.proxyServer=T,S.setProxyServer(T),Ee.setProxyServer(T))}return c={gatewayInfo:p,proxyInfo:await eG(_,p.uid)},c}async function K0(i,e,t,r){let n=P("UAP_AP").slice(0,P("AJAX_REQUEST_CONCURRENT")).map(a=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(a+"/api/v1?action=uap"):"https://".concat(a,"/api/v1?action=uap"));return await aG(n,i,e,t,r)}async function dG(i,e,t){let r=P("UAP_AP").slice(0,P("AJAX_REQUEST_CONCURRENT")).map(n=>i.proxyServer?"https://".concat(i.proxyServer,"/ap/?url=").concat(n+"/api/v1?action=uap"):"https://".concat(n,"/api/v1?action=uap")).map(n=>function(a,c,l,u){let h={command:"convergeAllocateEdge",sid:c.sid,appId:c.appId,token:c.token,ts:Date.now(),version:nn,cname:c.cname,uid:c.uid.toString(),requestId:Zg,seq:Zg};Zg+=1;let p={service_name:"tele_channel",json_body:JSON.stringify(h)};return Kn(async()=>{let _=await Gs(a,{data:p,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(_.code!==0){let T=new x(A.UNEXPECTED_RESPONSE,"cross channel ap error, code"+_.code,{retry:!0});throw S.error(T.toString()),T}let E=JSON.parse(_.json_body);if(E.code!==200){let T=new x(A.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(E.code,", reason: ").concat(E.reason));throw S.error(T.toString()),T}if(!E.servers||E.servers.length===0){let T=new x(A.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw S.error(T.toString()),T}return{vid:E.vid,workerToken:E.workerToken,addressList:(P("CHANNEL_MEDIA_RELAY_SERVERS")||E.servers).map(T=>"wss://".concat(T.address.replace(/\./g,"-"),".").concat(P("WORKER_DOMAIN"),":").concat(T.wss))}},void 0,_=>!!(_.code!==A.OPERATION_ABORTED&&_.code!==A.UNEXPECTED_RESPONSE||_.data&&_.data.retry),u)}(n,i,e,t));try{let n=await nl(r);return r.forEach(a=>a.cancel()),n}catch(n){throw n[0]}}async function uG(i,e,t){let r=null,n=[],a=async c=>{let l=P(c?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(u=>i.proxyServer?"https://".concat(i.proxyServer,"/ap/?url=").concat(u+"/api/v2/transpond/webrtc?v=2"):"https://".concat(u,"/api/v2/transpond/webrtc?v=2"));return c&&(await Si(1e3),r!==null)?r:await Fd({fragementLength:P("FRAGEMENT_LENGTH"),referenceList:l,asyncMapHandler:u=>(S.debug("[".concat(i.clientId,"] update ticket, Connect to ").concat(c?"backup":""," choose_server:"),u),function(h,p,_,E){let[T]=cG(p,[ai.CHOOSE_SERVER]),w=Mt.networkState;return Kn(async()=>{w&&Mt.networkState===ji.OFFLINE&&Mt.onlineWaiter&&await F.race([Mt.onlineWaiter,Si(E&&E.maxRetryTimeout||xt.maxRetryTimeout)]),w=Mt.networkState;let C=await Gs(h,{data:T,cancelToken:_,headers:{"Content-Type":"multipart/form-data;"}},!0);return oG(C,h)},()=>!1,C=>C.code!==A.OPERATION_ABORTED&&(C.code===A.UPDATE_TICKET_FAILED?C.data.retry:(S.warning("[".concat(p.clientId,"] update ticket network error, retry"),C),!0)),E)}(u,i,e,t)),allFailedhandler:u=>{throw u[0]},promisesCollector:n})};try{return r=await nl([a(!1),a(!0)]),n.length&&n.forEach(c=>c.cancel&&typeof c.cancel=="function"&&c.cancel()),r}catch(c){throw c[0]}}function z0(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Y0(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?z0(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):z0(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class hG extends mt{constructor(){super(),g(this,"configs",void 0),g(this,"joinInfo",void 0),g(this,"cancelToken",void 0),g(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),g(this,"interval",void 0),g(this,"mutex",new si("config-distribute")),g(this,"mutableParamsRead",!1)}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),P("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},P("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,Ee.reportApiInvoke(null,{options:void 0,name:jt.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:St.TRACER}).onSuccess(JSON.stringify(ua))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void S.debug("[config-distribute] get config distribute interrupted have no joininfo");let e,t=await this.mutex.lock();try{e=await lG(this.joinInfo,this.cancelToken,this.retryConfig),S.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(r){let n=new x(A.NETWORK_RESPONSE_ERROR,r);S.warning("[config-distribute] ".concat(n.toString()))}finally{t()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&t.uplink.max_bitrate!==void 0&&t.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(Ed.UPDATE_BITRATE_LIMIT,e):this.emit(Ed.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&Y0({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var t;let r=td(t=Object.keys(e).filter(a=>/^webrtc_ng_global_parameter/.test(a))).call(t);for(let a=0;a<r.length;a++)for(let c=r.length-1;c>a;c--){let l=r[c];if(typeof e[l].__priority=="number"){let u=e[l].__priority,h=r[c-1];if(typeof e[h].__priority=="number"){if(!(u>e[h].__priority))continue;{let p=l;r[c]=r[c-1],r[c-1]=p}}else{let p=l;r[c]=r[c-1],r[c-1]=p}}}let n={};r.forEach(a=>{let c=e[a],l=c.__expires;Object.keys(c).forEach(u=>{u==="__priority"||u==="__expires"||Object.prototype.hasOwnProperty.call(n,u)||(n[u]=Y0({value:c[u]},l&&{expires:l}))})});try{(function(l){try{let u=Date.now();Object.keys(l).forEach(h=>{switch(h){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(Yi,h)){let{value:p,expires:_}=l[h];if(_&&_<=u)return;ua[h]=p,Yi[h]=p,S.debug("Update global parameters from config distribute",h,p)}}})}catch(u){S.error("Error update config immediately: ".concat(l),u.message)}})(n);let a=JSON.stringify(n),c=window.btoa(a);window.localStorage.setItem("websdk_ng_global_parameter",c),S.debug("Caching global parameters ".concat(a))}catch(a){S.error("Error caching global parameters:",a.message)}}}function q0(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function jd(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?q0(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):q0(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class pG extends mt{constructor(e,t,r,n){super(),g(this,"spec",void 0),g(this,"token",void 0),g(this,"websocket",void 0),g(this,"pingpongTimer",void 0),g(this,"reconnectMode","retry"),g(this,"serviceMode",void 0),g(this,"reqId",0),g(this,"commandReqId",0),g(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),g(this,"handleWebSocketMessage",a=>{if(!a.data)return;let c=JSON.parse(a.data);c.requestId?this.emit("@".concat(c.requestId,"-").concat(c.sid),c):this.serviceMode===Ht.INJECT?this.emit(wn.INJECT_STREAM_STATUS,c):(Ee.workerEvent(this.spec.sid,{actionType:"status",serverCode:c.code,workerType:this.serviceMode===Ht.TRANSCODE?1:2}),this.emit(wn.PUBLISH_STREAM_STATUS,c))}),this.spec=t,this.token=e,this.serviceMode=n,this.websocket=new Sd("live-streaming",r),this.websocket.on(Ie.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Ie.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Ie.REQUEST_NEW_URLS,(a,c)=>{vt(this,wn.REQUEST_NEW_ADDRESS).then(a).catch(c)}),this.websocket.on(Ie.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}async request(e,t,r,n){this.reqId+=1,e==="request"&&(this.commandReqId+=1);let a=this.commandReqId,c=this.reqId;if(!c||!this.websocket)throw new x(A.UNEXPECTED_ERROR);let l=jd({command:e,sdkVersion:nn==="4.19.3"?"0.0.1":nn,seq:c,requestId:c,allocate:r,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if(this.websocket.state==="closed")throw new x(A.WS_DISCONNECT);let u=()=>new F((E,T)=>{this.websocket.once(Ie.CLOSED,()=>T(new x(A.WS_ABORT))),this.websocket.once(Ie.CONNECTED,E)});this.websocket.state!=="connected"&&await u(),l.clientRequest&&(l.clientRequest.workerToken=this.token);let h=new F((E,T)=>{let w=()=>{T(new x(A.WS_ABORT))};this.websocket.once(Ie.RECONNECTING,w),this.websocket.once(Ie.CLOSED,w),this.once("@".concat(c,"-").concat(this.spec.sid),C=>{E(C)})});n&&Ee.workerEvent(this.spec.sid,jd(jd({},n),{},{requestId:a,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));let p=Date.now();this.websocket.sendMessage(l);let _=null;try{_=await h}catch(E){if(this.websocket.state==="closed")throw E;return await u(),await this.request(e,t,r)}return n&&Ee.workerEvent(this.spec.sid,jd(jd({},n),{},{requestId:a,actionType:"response",payload:JSON.stringify(_.serverResponse),serverCode:_.code,success:_.code===200,responseTime:Date.now()-p})),_.code!==200&&this.handleResponseError(_),_}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){let e=nn==="4.19.3"?"0.0.1":nn;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case kt.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void S.warning("live stream response already exists stream");case kt.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case kt.LIVE_STREAM_RESPONSE_BAD_STREAM:case kt.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new x(A.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case kt.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new x(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case kt.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new x(A.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case kt.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let t=new x(A.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(wn.WARNING,t,e.serverResponse.url)}case kt.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{let t=new x(A.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(wn.WARNING,t,e.serverResponse.url)}case kt.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new x(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case kt.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new x(A.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case kt.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{let t=new x(A.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(wn.WARNING,t,e.serverResponse.url)}case kt.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new x(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case kt.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new x(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case kt.LIVE_STREAM_RESPONSE_WORKER_LOST:case kt.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;throw new x(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case kt.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream"||e.serverResponse.command==="UninjectStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new x(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new x(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case kt.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case kt.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case kt.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case kt.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new x(A.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Fh)},6e3)}}function J0(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ir(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?J0(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):J0(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class fG extends mt{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:xt,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:xt;super(),g(this,"onLiveStreamWarning",void 0),g(this,"onLiveStreamError",void 0),g(this,"onInjectStatusChange",void 0),g(this,"spec",void 0),g(this,"retryTimeout",1e4),g(this,"connection",void 0),g(this,"httpRetryConfig",void 0),g(this,"wsRetryConfig",void 0),g(this,"streamingTasks",new Map),g(this,"isStartingStreamingTask",!1),g(this,"taskMutex",new si("live-streaming")),g(this,"cancelToken",lr.CancelToken.source()),g(this,"transcodingConfig",void 0),g(this,"injectConfig",ir({},p5)),g(this,"injectLoopTimes",0),g(this,"uapResponse",void 0),g(this,"lastTaskId",1),g(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=r,this.wsRetryConfig=t}async setTranscodingConfig(e){let t=ir(ir({},h5),e);t.videoCodecProfile!==66&&t.videoCodecProfile!==77&&t.videoCodecProfile!==100&&(S.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(t.videoCodecProfile," -> 100")),t.videoCodecProfile=100),t.transcodingUsers||(t.transcodingUsers=t.userConfigs),t.transcodingUsers&&(t.transcodingUsers=t.transcodingUsers.map(c=>ir(ir(ir({},u5),c),{},{zOrder:c.zOrder?c.zOrder+1:1}))),function(c){Tt(c.width)||nt(c.width,"config.width",0,1e4),Tt(c.height)||nt(c.height,"config.height",0,1e4),Tt(c.videoBitrate)||nt(c.videoBitrate,"config.videoBitrate",1,1e6),Tt(c.videoFrameRate)||nt(c.videoFrameRate,"config.videoFrameRate"),Tt(c.lowLatency)||So(c.lowLatency,"config.lowLatency"),Tt(c.audioSampleRate)||Xt(c.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Tt(c.audioBitrate)||nt(c.audioBitrate,"config.audioBitrate",1,128),Tt(c.audioChannels)||Xt(c.audioChannels,"config.audioChannels",[1,2,3,4,5]),Tt(c.videoGop)||nt(c.videoGop,"config.videoGop"),Tt(c.videoCodecProfile)||Xt(c.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Tt(c.userCount)||nt(c.userCount,"config.userCount",0,17),Tt(c.backgroundColor)||nt(c.backgroundColor,"config.backgroundColor",0,16777215),Tt(c.userConfigExtraInfo)||yi(c.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),c.transcodingUsers&&!Tt(c.transcodingUsers)&&(ks(c.transcodingUsers,"config.transcodingUsers"),c.transcodingUsers.forEach((l,u)=>{$E(l.uid),Tt(l.x)||nt(l.x,"transcodingUser[".concat(u,"].x"),0,1e4),Tt(l.y)||nt(l.y,"transcodingUser[".concat(u,"].y"),0,1e4),Tt(l.width)||nt(l.width,"transcodingUser[".concat(u,"].width"),0,1e4),Tt(l.height)||nt(l.height,"transcodingUser[".concat(u,"].height"),0,1e4),Tt(l.zOrder)||nt(l.zOrder-1,"transcodingUser[".concat(u,"].zOrder"),0,100),Tt(l.alpha)||nt(l.alpha,"transcodingUser[".concat(u,"].alpha"),0,1,!1)})),Tt(c.watermark)||eg(c.watermark,"watermark"),Tt(c.backgroundImage)||eg(c.backgroundImage,"backgroundImage"),c.images&&!Tt(c.images)&&(ks(c.images,"config.images"),c.images.forEach((l,u)=>{eg(l,"images[".concat(u,"]"))}))}(t);let r=[];t.images&&r.push(...t.images.map(c=>ir(ir(ir({},ZE),c),{},{zOrder:255}))),t.backgroundImage&&(r.push(ir(ir(ir({},ZE),t.backgroundImage),{},{zOrder:0})),delete t.backgroundImage),t.watermark&&(r.push(ir(ir(ir({},ZE),t.watermark),{},{zOrder:255})),delete t.watermark),t.images=r,t.transcodingUsers&&(t.userConfigs=t.transcodingUsers.map(c=>ir({},c)),t.userCount=t.transcodingUsers.length,delete t.transcodingUsers);let n=(t.userConfigs||[]).map(c=>typeof c.uid=="number"?F.resolve(c.uid):W0(c.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await F.all(n)).forEach((c,l)=>{t.userConfigs&&t.userConfigs[l]&&(t.userConfigs[l].uid=c)}),this.transcodingConfig=t,this.connection)try{var a;let c=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(us(a=this.streamingTasks).call(a)).map(l=>l.taskId).join("#")});S.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(c.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(c){if(!c.data||!c.data.retry)throw c;c.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(l=>{S.warning("[".concat(this.spec.clientId,"] live streaming receive error"),c.toString(),"try to republish",l.url),this.startLiveStreamingTask(l.url,l.mode,c).then(()=>{S.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(l.url," success"))}).catch(u=>{S.error("[".concat(this.spec.clientId,"] live streaming republish failed"),l.url,u.toString()),this.onLiveStreamError&&this.onLiveStreamError(l.url,u)})})}}setInjectStreamConfig(e,t){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=t}async startLiveStreamingTask(e,t,r){var n;if(Array.from(us(n=this.streamingTasks).call(n)).find(u=>u.mode===Ht.INJECT)&&t===Ht.INJECT)return new x(A.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&t===Ht.TRANSCODE)throw new x(A.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let a={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};S.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(t));let c=await this.taskMutex.lock();if(!this.connection&&r)return void c();if(this.streamingTasks.get(e)&&!r)return c(),new x(A.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(t))}catch(u){throw c(),u}switch(t){case Ht.TRANSCODE:a.transcodingConfig=ir({},this.transcodingConfig);break;case Ht.RAW:break;case Ht.INJECT:a={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(a.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;let l=this.lastTaskId++;try{let u=new F((p,_)=>{Si(this.retryTimeout).then(()=>{if(r)return _(r);let E=this.statusError.get(e);return E?(this.statusError.delete(e),_(E)):void 0})}),h=await F.race([this.connection.request("request",{clientRequest:a},!0,{url:e,command:"PublishStream",workerType:t===Ht.TRANSCODE?1:2,requestByUser:!r,tid:l.toString()}),u]);this.isStartingStreamingTask=!1,S.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(h.code)),this.streamingTasks.set(e,{clientRequest:a,mode:t,url:e,taskId:l}),c()}catch(u){if(c(),this.isStartingStreamingTask=!1,!u.data||!u.data.retry||r)throw u;return u.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,t,u)):await this.startLiveStreamingTask(e,t,u)}}stopLiveStreamingTask(e){return new F((t,r)=>{let n=this.streamingTasks.get(e);if(!n||!this.connection)return new x(A.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();let a=n.mode;n.abortTask=()=>{S.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),t()},this.connection.request("request",{clientRequest:{command:a===Ht.INJECT?"UninjectStream":"UnpublishStream",url:n.url}},!1,{url:e,command:"UnPublishStream",workerType:a===Ht.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(c=>{S.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(c.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&a!==Ht.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),t(),a===Ht.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(pa.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)}).catch(r)})}async controlInjectStream(e,t,r,n){let a=this.streamingTasks.get(e);if(!a||!this.connection||a.mode!==Ht.INJECT)throw new x(A.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:t,audioVolume:r,position:n}})).serverResponse}resetAllTask(){var e;let t=Array.from(us(e=this.streamingTasks).call(e));this.terminate();for(let r of t)this.startLiveStreamingTask(r.url,r.mode).catch(n=>{this.onLiveStreamError&&this.onLiveStreamError(r.url,n)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=lr.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new x(A.UNEXPECTED_ERROR,"live streaming connection has already connected");let t=await vt(this,Wc.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new pG(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(wn.WARNING,(r,n)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(n,r)),this.connection.on(wn.PUBLISH_STREAM_STATUS,r=>this.handlePublishStreamServer(r)),this.connection.on(wn.INJECT_STREAM_STATUS,r=>this.handleInjectStreamServerStatus(r)),this.connection.on(wn.REQUEST_NEW_ADDRESS,(r,n)=>{if(!this.connection)return n(new x(A.UNEXPECTED_ERROR,"can not get new live streaming address list"));vt(this,Wc.REQUEST_WORKER_MANAGER_LIST,e).then(a=>{this.uapResponse=a,r(a.addressList)}).catch(n)}),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(e){let t=e.serverStatus&&e.serverStatus.url||"empty_url",r=this.streamingTasks.get(t),n=e.reason;switch(e.code){case kt.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case kt.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case kt.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case kt.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{let c=new x(A.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(r)return S.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(t,c);if(!this.isStartingStreamingTask)return;this.statusError.set(t,c)}case kt.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let c=new x(A.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,n);return this.onLiveStreamWarning&&this.onLiveStreamWarning(t,c)}case kt.LIVE_STREAM_RESPONSE_WORKER_LOST:case kt.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var a;if(!this.connection)return;this.connection.tryNextAddress();let c=Array.from(us(a=this.streamingTasks).call(a));for(let l of c)l.abortTask?l.abortTask():(S.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",l.url),this.startLiveStreamingTask(l.url,l.mode,new x(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{S.debug("[".concat(this.spec.clientId,"] republish live stream success"),l.url)}).catch(u=>{S.error(u.toString()),this.onLiveStreamError&&this.onLiveStreamError(l.url,u)}));return}}}handleInjectStreamServerStatus(e){let t=Number(e.uid),r=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(pa.INJECT_STREAM_STATUS_START_SUCCESS,t,r));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(pa.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,t,r),void this.streamingTasks.delete(r);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(pa.INJECT_STREAM_STATUS_START_UNAUTHORIZED,t,r),void this.streamingTasks.delete(r);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(pa.INJECT_STREAM_STATUS_BROKEN,t,r),void this.streamingTasks.delete(r);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(pa.INJECT_STREAM_STATUS_START_TIMEOUT,t,r),void this.streamingTasks.delete(r);default:return void S.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class Mp{constructor(){g(this,"destChannelMediaInfos",new Map),g(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){FA(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){FA(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){QE(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function X0(i){if(!(i instanceof Mp))return new x(A.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();let e=i.getSrcChannelMediaInfo(),t=i.getDestChannelMediaInfo();if(!e)return new x(A.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(t.size===0)return new x(A.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class _G extends mt{constructor(e,t,r){super(),g(this,"ws",void 0),g(this,"requestId",1),g(this,"heartBeatTimer",void 0),g(this,"joinInfo",void 0),g(this,"clientId",void 0),g(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),g(this,"onClose",n=>{this.emit("close"),this.dispose()}),g(this,"onMessage",n=>{let a=JSON.parse(n.data);if(!a||a.command!=="serverResponse"||!a.requestId)return a&&a.command==="serverStatus"&&a.serverStatus&&a.serverStatus.command?(this.emit("status",a.serverStatus),void this.emit(a.serverStatus.command,a.serverStatus)):void 0;this.emit("req_".concat(a.requestId),a)}),this.joinInfo=e,this.clientId=t,this.ws=new Sd("cross-channel-".concat(this.clientId),r),this.ws.on(Ie.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(Ie.CONNECTED,this.onOpen),this.ws.on(Ie.ON_MESSAGE,this.onMessage),this.ws.on(Ie.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){let t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new F((t,r)=>{let n=window.setTimeout(()=>{r(new x(A.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,a=>{window.clearTimeout(n),a.state&&a.state!==0?r(new x(A.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)}),this.once("dispose",()=>{window.clearTimeout(n),r(new x(A.WS_ABORT))})})}async request(e){if(this.ws.state==="closed")throw new x(A.WS_DISCONNECT);let t=()=>new F((c,l)=>{this.ws.once(Ie.CLOSED,()=>l(new x(A.WS_ABORT))),this.ws.once(Ie.CONNECTED,c)});this.ws.state!=="connected"&&await t();let r=this.sendMessage(e),n=new F((c,l)=>{let u=()=>{l(new x(A.WS_ABORT))};this.ws.once(Ie.RECONNECTING,u),this.ws.once(Ie.CLOSED,u),this.once("req_".concat(r),c),Si(3e3).then(()=>{this.removeAllListeners("req_".concat(r)),this.ws.off(Ie.RECONNECTING,u),this.ws.off(Ie.CLOSED,u),l(new x(A.TIMEOUT,"cross channel ws request timeout"))})}),a=await n;if(!a||a.code!==200)throw new x(A.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(a)));return a}async connect(e){this.ws.removeAllListeners(Ie.REQUEST_NEW_URLS),this.ws.on(Ie.REQUEST_NEW_URLS,t=>{t(e)}),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){let t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class mG extends mt{set state(e){e!==this._state&&(e!==qi.RELAY_STATE_FAILURE&&(this.errorCode=fa.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,t,r,n,a){super(),g(this,"joinInfo",void 0),g(this,"sid",void 0),g(this,"clientId",void 0),g(this,"cancelToken",lr.CancelToken.source()),g(this,"workerToken",void 0),g(this,"requestId",0),g(this,"signal",void 0),g(this,"prevChannelMediaConfig",void 0),g(this,"httpRetryConfig",void 0),g(this,"_resolution",void 0),g(this,"_state",qi.RELAY_STATE_IDLE),g(this,"errorCode",fa.RELAY_OK),g(this,"onStatus",c=>{S.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(c))),c&&c.command&&(c.command==="onAudioPacketReceived"&&this.emit("event",zn.PACKET_RECEIVED_AUDIO_FROM_SRC),c.command==="onVideoPacketReceived"&&this.emit("event",zn.PACKET_RECEIVED_VIDEO_FROM_SRC),c.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=fa.SRC_TOKEN_EXPIRED,this.state=qi.RELAY_STATE_FAILURE),c.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=fa.DEST_TOKEN_EXPIRED,this.state=qi.RELAY_STATE_FAILURE))}),g(this,"onReconnect",async()=>{S.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",zn.NETWORK_DISCONNECTED),this.state=qi.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(c=>{this.state!==qi.RELAY_STATE_IDLE&&(S.error("auto restart channel media relay failed",c.toString()),this.errorCode=fa.SERVER_CONNECTION_LOST,this.state=qi.RELAY_STATE_FAILURE)})}),this.joinInfo=e,this.clientId=t,this.sid=RE(),this.signal=new _G(this.joinInfo,this.clientId,r),this.httpRetryConfig=n,this._resolution=a}async startChannelMediaRelay(e){if(this.state!==qi.RELAY_STATE_IDLE)throw new x(A.INVALID_OPERATION);this.state=qi.RELAY_STATE_CONNECTING,await this.connect(),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(t){throw t.data&&t.data.serverResponse&&t.data.serverResponse.command==="SetSourceChannel"?new x(A.CROSS_CHANNEL_FAILED_JOIN_SRC):t.data&&t.data.serverResponse&&t.serverResponse.command==="SetDestChannelStatus"?new x(A.CROSS_CHANNEL_FAILED_JOIN_DEST):t.data&&t.data.serverResponse&&t.serverResponse.command==="StartPacketTransfer"?new x(A.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):t}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==qi.RELAY_STATE_RUNNING)throw new x(A.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==qi.RELAY_STATE_RUNNING)throw new x(A.INVALID_OPERATION);let t=this.genMessage(Pi.SetVideoProfile);await this.signal.request(t),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),S.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=qi.RELAY_STATE_IDLE,this.dispose()}dispose(){S.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=lr.CancelToken.source(),this.state=qi.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){let e=await dG(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",zn.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){let t=this.genMessage(Pi.StopPacketTransfer);await this.signal.request(t),await this.signal.waitStatus("Normal Quit"),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));let r=this.genMessage(Pi.SetSdkProfile,e);await this.signal.request(r),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));let n=this.genMessage(Pi.SetSourceChannel,e);await this.signal.request(n),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",zn.PACKET_JOINED_SRC_CHANNEL),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));let a=this.genMessage(Pi.SetSourceUserId,e);await this.signal.request(a),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));let c=this.genMessage(Pi.SetDestChannel,e);await this.signal.request(c),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",zn.PACKET_JOINED_DEST_CHANNEL),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));let l=this.genMessage(Pi.StartPacketTransfer,e);await this.signal.request(l),this.emit("event",zn.PACKET_SENT_TO_DEST_CHANNEL),this.state=qi.RELAY_STATE_RUNNING,S.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){let t=this.genMessage(Pi.UpdateDestChannel,e);await this.signal.request(t),this.emit("event",zn.PACKET_UPDATE_DEST_CHANNEL),S.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){let e=this.genMessage(Pi.StopPacketTransfer);await this.signal.request(e),S.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){let r=[],n=[],a=[];this.requestId+=1;let c={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:nn,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};c.sdkVersion==="4.19.3"&&(c.sdkVersion="0.0.1");let l=null,u=null;switch(e){case Pi.SetSdkProfile:return c.clientRequest={command:"SetSdkProfile",type:"multi_channel"},c;case Pi.SetSourceChannel:if(u=t&&t.getSrcChannelMediaInfo(),!u)throw new x(A.UNEXPECTED_ERROR,"can not find source config");return c.clientRequest={command:"SetSourceChannel",uid:"0",channelName:u.channelName,token:u.token||this.joinInfo.appId},c;case Pi.SetSourceUserId:if(u=t&&t.getSrcChannelMediaInfo(),!u)throw new x(A.UNEXPECTED_ERROR,"can not find source config");return c.clientRequest={command:"SetSourceUserId",uid:u.uid+""},c;case Pi.SetDestChannel:if(l=t&&t.getDestChannelMediaInfo(),!l)throw new x(A.UNEXPECTED_ERROR,"can not find dest config");return l.forEach(h=>{r.push(h.channelName),n.push(h.uid+""),a.push(h.token||this.joinInfo.appId)}),c.clientRequest={command:"SetDestChannel",channelName:r,uid:n,token:a},c;case Pi.StartPacketTransfer:return c.clientRequest={command:"StartPacketTransfer"},c;case Pi.Reconnect:return c.clientRequest={command:"Reconnect"},c;case Pi.StopPacketTransfer:return c.clientRequest={command:"StopPacketTransfer"},c;case Pi.UpdateDestChannel:if(l=t&&t.getDestChannelMediaInfo(),!l)throw new x(A.UNEXPECTED_ERROR,"can not find dest config");return l.forEach(h=>{r.push(h.channelName),n.push(h.uid+""),a.push(h.token||this.joinInfo.appId)}),c.clientRequest={command:"UpdateDestChannel",channelName:r,uid:n,token:a},c;case Pi.SetVideoProfile:c.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return c}}class wi{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio)return this._audioTrack}get videoTrack(){if(this.hasVideo)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){g(this,"uid",void 0),g(this,"_uintid",void 0),g(this,"_trust_in_room_",!0),g(this,"_trust_audio_enabled_state_",!0),g(this,"_trust_video_enabled_state_",!0),g(this,"_trust_audio_mute_state_",!0),g(this,"_trust_video_mute_state_",!0),g(this,"_audio_muted_",!1),g(this,"_video_muted_",!1),g(this,"_audio_enabled_",!0),g(this,"_video_enabled_",!0),g(this,"_audio_added_",!1),g(this,"_video_added_",!1),g(this,"_trust_video_stream_added_state_",!0),g(this,"_trust_audio_stream_added_state_",!0),g(this,"_audioTrack",void 0),g(this,"_videoTrack",void 0),g(this,"_dataChannels",[]),g(this,"_audioSSRC",void 0),g(this,"_videoSSRC",void 0),g(this,"_audioOrtc",void 0),g(this,"_videoOrtc",void 0),g(this,"_cname",void 0),g(this,"_rtxSsrcId",void 0),this.uid=e,this._uintid=t}}var EG=aw,gG=os;Pt({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var i=gG.f(this);return{promise:i.promise,resolve:i.resolve,reject:i.reject}}});var SG=os,TG=Nc;Pt({target:"Promise",stat:!0,forced:!0},{try:function(i){var e=SG.f(this),t=TG(i);return(t.error?e.reject:e.resolve)(t.value),e.promise}});var tS=Zi(EG),Q0=Sc.f("asyncIterator"),vG=Zi(Q0);function iS(i,e){this.v=i,this.k=e}function Bd(i){var e,t;function r(a,c){try{var l=i[a](c),u=l.value,h=u instanceof iS;tS.resolve(h?u.v:u).then(function(p){if(h){var _=a==="return"?"return":"next";if(!u.k||p.done)return r(_,p);p=i[_](p).value}n(l.done?"return":"normal",p)},function(p){r("throw",p)})}catch(p){n("throw",p)}}function n(a,c){switch(a){case"return":e.resolve({value:c,done:!0});break;case"throw":e.reject(c);break;default:e.resolve({value:c,done:!1})}(e=e.next)?r(e.key,e.arg):t=null}this._invoke=function(a,c){return new tS(function(l,u){var h={key:a,arg:c,resolve:l,reject:u,next:null};t?t=t.next=h:(e=t=h,r(a,c))})},typeof i.return!="function"&&(this.return=void 0)}function dn(i){return function(){return new Bd(i.apply(this,arguments))}}function Ye(i){return new iS(i,0)}function Up(i){var e={},t=!1;function r(n,a){return t=!0,{done:!1,value:new iS(a=new tS(function(c){c(i[n](a))}),1)}}return e[Ic!==void 0&&WR||"@@iterator"]=function(){return this},e.next=function(n){return t?(t=!1,n):r("next",n)},typeof i.throw=="function"&&(e.throw=function(n){if(t)throw t=!1,n;return r("throw",n)}),typeof i.return=="function"&&(e.return=function(n){return t?(t=!1,n):r("return",n)}),e}Bd.prototype[typeof Ic=="function"&&vG||"@@asyncIterator"]=function(){return this},Bd.prototype.next=function(i){return this._invoke("next",i)},Bd.prototype.throw=function(i){return this._invoke("throw",i)},Bd.prototype.return=function(i){return this._invoke("return",i)};var $0=Zi(Q0),Z0={exports:{}};(function(i,e){i.exports=(()=>{var t={8:(a,c,l)=>{l.r(c),l.d(c,{Parser:()=>Pe,Printer:()=>Ir,parse:()=>Ne,print:()=>qe});let u=`
`,h="".concat("\r").concat(u),p=" ",_;function E(oe){return oe>="0"&&oe<="9"}function T(oe){return oe>="!"&&oe<="~"}function w(oe){return T(oe)||oe>=""&&oe<=""}function C(oe){return oe==="!"||oe>="#"&&oe<="'"||oe>="*"&&oe<="+"||oe>="-"&&oe<="."||oe>="0"&&oe<="9"||oe>="A"&&oe<="Z"||oe>="^"&&oe<="~"}function O(oe){return oe>="1"&&oe<="9"}function b(oe){return oe>="A"&&oe<="Z"||oe>="a"&&oe<="z"}function k(oe){return oe==="d"||oe==="h"||oe==="m"||oe==="s"}function U(oe){return oe>""&&oe<"	"||oe>"\v"&&oe<"\f"||oe>""&&oe<""}function X(oe){return b(oe)||E(oe)||oe==="+"||oe==="/"}function z(oe){return E(oe)||b(oe)||oe==="+"||oe==="/"||oe==="-"||oe==="_"}function j(oe){return b(oe)||E(oe)||oe==="+"||oe==="/"}function B(oe,y){var N=Object.keys(oe);if(Object.getOwnPropertySymbols){var M=Object.getOwnPropertySymbols(oe);y&&(M=M.filter(function(ie){return Object.getOwnPropertyDescriptor(oe,ie).enumerable})),N.push.apply(N,M)}return N}function W(oe){for(var y=1;y<arguments.length;y++){var N=arguments[y]!=null?arguments[y]:{};y%2?B(Object(N),!0).forEach(function(M){ce(oe,M,N[M])}):Object.getOwnPropertyDescriptors?Object.defineProperties(oe,Object.getOwnPropertyDescriptors(N)):B(Object(N)).forEach(function(M){Object.defineProperty(oe,M,Object.getOwnPropertyDescriptor(N,M))})}return oe}function ce(oe,y,N){return y in oe?Object.defineProperty(oe,y,{value:N,enumerable:!0,configurable:!0,writable:!0}):oe[y]=N,oe}(function(oe){oe.VERSION="v",oe.ORIGIN="o",oe.SESSION_NAME="s",oe.INFORMATION="i",oe.URI="u",oe.EMAIL="e",oe.PHONE="p",oe.CONNECTION="c",oe.BANDWIDTH="b",oe.TIME="t",oe.REPEAT="r",oe.ZONE_ADJUSTMENTS="z",oe.KEY="k",oe.ATTRIBUTE="a",oe.MEDIA="m"})(_||(_={}));class ne{consumeText(y,N){let M=N;for(;M<y.length;){let ie=y[M];if(ie==="\0"||ie==="\r"||ie===u)break;M+=1}if(M-N==0)throw new Error("Invalid text, at ".concat(y));return M}consumeUnicastAddress(y,N,M){return this.consumeTill(y,N,p)}consumeOneOrMore(y,N,M){let ie=N;for(;M(y[ie]);)ie++;if(ie-N==0)throw new Error("Invalid rule at ".concat(N,"."));return ie}consumeSpace(y,N){if(y[N]===p)return N+1;throw new Error("Invalid space at ".concat(N,"."))}consumeIP4Address(y,N){let M=N;for(let ie=0;ie<4;ie++)if(M=this.consumeDecimalUChar(y,M),ie!==3){if(y[M]!==".")throw new Error("Invalid IP4 address.");M++}return M}consumeDecimalUChar(y,N){let M=N;for(let De=0;De<3&&E(y[M]);De++,M++);if(M-N==0)throw new Error("Invalid decimal uchar.");let ie=parseInt(y.slice(N,M));if(ie>=0&&ie<=255)return M;throw new Error("Invalid decimal uchar")}consumeIP6Address(y,N){let M=this.consumeHexpart(y,N);return y[M]===":"&&(M+=1,M=this.consumeIP4Address(y,M)),M}consumeHexpart(y,N){let M=N;if(y[M]===":"&&y[M+1]===":"){M+=2;try{M=this.consumeHexseq(y,M)}catch{}return M}if(M=this.consumeHexseq(y,M),y[M]===":"&&y[M+1]===":"){M+=2;try{M=this.consumeHexseq(y,M)}catch{}return M}return M}consumeHexseq(y,N){let M=N;for(;M=this.consumeHex4(y,M),y[M]===":"&&y[M+1]!==":";)M+=1;return M}consumeHex4(y,N){let M=0;for(;M<4;M++)if(!((ie=y[N+M])>="0"&&ie<="9"||ie>="a"&&ie<="f"||ie>="A"&&ie<="F")){if(M===0)throw new Error("Invalid hex 4");break}var ie;return N+M}consumeFQDN(y,N){let M=N;for(;E(y[M])||b(y[M])||y[M]==="-"||y[M]===".";)M+=1;if(M-N<4)throw new Error("Invalid FQDN");return M}consumeExtnAddr(y,N){return this.consumeOneOrMore(y,N,w)}consumeMulticastAddress(y,N,M){switch(M){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(y,N);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(y,N);default:try{return this.consumeFQDN(y,N)}catch{return this.consumeExtnAddr(y,N)}}}consumeIP6MulticastAddress(y,N){let M=this.consumeHexpart(y,N);return y[M]==="/"?this.consumeInteger(y,M+1):M}consumeIP4MulticastAddress(y,N){let M=N+3,ie=y.slice(N,M),De=parseInt(ie);if(De<224||De>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let gt=0;gt<3;gt++){if(y[M]!==".")throw new Error("Invalid IP4 multicast address.");M+=1,M=this.consumeDecimalUChar(y,M)}return y[M]==="/"&&(M+=1),M=this.consumeTTL(y,M),y[M]==="/"&&(M=this.consumeInteger(y,M)),M}consumeInteger(y,N){if(!O(y[N]))throw new Error("Invalid integer.");for(N+=1;E(y[N]);)N+=1;return N}consumeTTL(y,N){if(y[N]==="0")return N+1;if(!O(y[N]))throw new Error("Invalid TTL.");N+=1;for(let M=0;M<2&&E(y[N]);M++)N+=1;return N}consumeToken(y,N){return this.consumeOneOrMore(y,N,C)}consumeTime(y,N){let M=N;if(y[M]==="0")return M+1;for(O(y[M])&&(M+=1);E(y[M]);)M++;if(M-N<10)throw new Error("Invalid time");return M}consumeAddress(y,N){return this.consumeTill(y,N,p)}consumeTypedTime(y,N){let M=N;return M=this.consumeOneOrMore(y,M,E),k(y[M])?M+1:M}consumeRepeatInterval(y,N){if(!O(y[N]))throw new Error("Invalid repeat interval");for(N+=1;E(y[N]);)N+=1;return k(y[N])&&(N+=1),N}consumePort(y,N){return this.consumeOneOrMore(y,N,E)}consume(y,N,M){for(let ie=0;ie<M.length;ie++){if(N+ie>=y.length)throw new Error("consume exceeding value length");if(y[N+ie]!==M[ie])throw new Error("consume ".concat(M," failed at ").concat(ie))}return N+M.length}consumeTill(y,N,M){let ie=N;for(;ie<y.length&&(typeof M!="string"||y[ie]!==M)&&(typeof M!="function"||!M(y[ie]));)ie++;return ie}}class Pe extends ne{constructor(){super(),ce(this,"records",[]),ce(this,"currentLine",0)}parse(y){let N=this.probeEOL(y);this.records=y.split(N).filter(Wt=>!!Wt.trim()).map(this.parseLine),this.currentLine=0;let M=this.parseVersion(),ie=this.parseOrigin(),De=this.parseSessionName(),gt=this.parseInformation(),Oi=this.parseUri(),wr=this.parseEmail(),Ws=this.parsePhone(),$p=this.parseConnection(),Zp=this.parseBandWidth(),_n=this.parseTimeFields(),Pa=this.parseKey(),dl=this.parseSessionAttribute(),bt=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:M,origin:ie,sessionName:De,information:gt,uri:Oi,emails:wr,phones:Ws,connection:$p,bandwidths:Zp,timeFields:_n,key:Pa,attributes:dl,mediaDescriptions:bt}}getCurrentRecord(){let y=this.records[this.currentLine];if(!y)throw new Error("Record doesn't exit.");return y}probeEOL(y){for(let N=0;N<y.length;N++)if(y[N]===u)return y[N-1]==="\r"?h:u;throw new Error("Invalid newline character.")}parseLine(y,N){if(y.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");let M=y[0];if(y[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:M,value:y.slice(2),line:N,cur:0}}parseSessionAttribute(){let y=new It;for(;this.currentLine<this.records.length;){let N=this.getCurrentRecord();if(N.type!==_.ATTRIBUTE)break;let M={attField:this.extractOneOrMore(N,ie=>C(ie)&&ie!==":"),_cur:0};N.value[N.cur]===":"&&(N.cur+=1,M.attValue=this.extractOneOrMore(N,U)),y.parse(M),this.currentLine++}return y.digest()}parseMediaAttributes(y){let N=new Gt(y);for(;this.currentLine<this.records.length;){let M=this.getCurrentRecord();if(M.type!==_.ATTRIBUTE)break;let ie={attField:this.extractOneOrMore(M,De=>C(De)&&De!==":"),_cur:0};M.value[M.cur]===":"&&(M.cur+=1,ie.attValue=this.extractOneOrMore(M,U)),N.parse(ie),this.currentLine++}return N.digest()}parseKey(){let y=this.getCurrentRecord();if(y.type===_.KEY){if(y.value==="prompt"||y.value==="clear:"||y.value==="base64:"||y.value==="uri:")return y.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){let y=this.getCurrentRecord();if(y.type===_.ZONE_ADJUSTMENTS){let N=[];for(;;)try{let M=this.extract(y,this.consumeTime);this.consumeSpaceForRecord(y);let ie=!1;y.value[y.cur]==="-"&&(ie=!0,y.cur+=1);let De=this.extract(y,this.consumeTypedTime);N.push({time:M,typedTime:De,back:ie})}catch{break}if(N.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,N}return[]}parseRepeat(){let y=[];for(;;){let N=this.getCurrentRecord();if(N.type!==_.REPEAT)break;{let M=this.extract(N,this.consumeRepeatInterval),ie=this.parseTypedTime(N);y.push({repeatInterval:M,typedTimes:ie}),this.currentLine++}}return y}parseTypedTime(y){let N=[];for(;;)try{this.consumeSpaceForRecord(y),N.push(this.extract(y,this.consumeTypedTime))}catch{break}if(N.length===0)throw new Error("Invalid typed time.");return N}parseTime(){let y=this.getCurrentRecord(),N=this.extract(y,this.consumeTime);this.consumeSpaceForRecord(y);let M=this.extract(y,this.consumeTime);return this.currentLine++,{startTime:N,stopTime:M}}parseBandWidth(){let y=[];for(;this.currentLine<this.records.length;){let N=this.getCurrentRecord();if(N.type!==_.BANDWIDTH)break;{let M=this.extractOneOrMore(N,C);if(N.value[N.cur]!==":")throw new Error("Invalid bandwidth field.");N.cur++;let ie=this.extractOneOrMore(N,E);y.push({bwtype:M,bandwidth:ie}),this.currentLine++}}return y}parseVersion(){let y=this.getCurrentRecord();if(y.type!==_.VERSION)throw new Error("first sdp record must be version");let N=y.value.slice(0,this.consumeOneOrMore(y.value,0,E));if(N.length!==y.value.length)throw new Error('invalid proto version, "v='.concat(y.value,'"'));return this.currentLine++,N}parseOrigin(){let y=this.getCurrentRecord();if(y.type!==_.ORIGIN)throw new Error("second line of sdp must be origin");let N=this.extractOneOrMore(y,w);this.consumeSpaceForRecord(y);let M=this.extractOneOrMore(y,E);this.consumeSpaceForRecord(y);let ie=this.extractOneOrMore(y,E);this.consumeSpaceForRecord(y);let De=this.extractOneOrMore(y,C);this.consumeSpaceForRecord(y);let gt=this.extractOneOrMore(y,C);this.consumeSpaceForRecord(y);let Oi=this.extract(y,this.consumeUnicastAddress);return this.currentLine++,{username:N,sessId:M,sessVersion:ie,nettype:De,addrtype:gt,unicastAddress:Oi}}parseSessionName(){let y=this.getCurrentRecord();if(y.type===_.SESSION_NAME){let N=this.extract(y,this.consumeText);return this.currentLine++,N}}parseInformation(){let y=this.getCurrentRecord();if(y.type!==_.INFORMATION)return;let N=this.extract(y,this.consumeText);return this.currentLine++,N}parseUri(){let y=this.getCurrentRecord();if(y.type===_.URI)return this.currentLine++,y.value}parseEmail(){let y=[];for(;;){let N=this.getCurrentRecord();if(N.type!==_.EMAIL)break;y.push(N.value),this.currentLine++}return y}parsePhone(){let y=[];for(;;){let N=this.getCurrentRecord();if(N.type!==_.PHONE)break;y.push(N.value),this.currentLine++}return y}parseConnection(){let y=this.getCurrentRecord();if(y.type===_.CONNECTION){let N=this.extractOneOrMore(y,C);this.consumeSpaceForRecord(y);let M=this.extractOneOrMore(y,C);this.consumeSpaceForRecord(y);let ie=this.extract(y,this.consumeAddress);return this.currentLine++,{nettype:N,addrtype:M,address:ie}}}parseMedia(){let y=this.getCurrentRecord(),N=this.extract(y,this.consumeToken);this.consumeSpaceForRecord(y);let M=this.extract(y,this.consumePort);y.value[y.cur]==="/"&&(y.cur+=1,M+=this.extract(y,this.consumeInteger)),this.consumeSpaceForRecord(y);let ie=[];for(ie.push(this.extract(y,this.consumeToken));y.value[y.cur]==="/";)y.cur+=1,ie.push(this.extract(y,this.consumeToken));if(ie.length===0)throw new Error("Invalid proto");let De=this.parseFmt(y);return this.currentLine++,{mediaType:N,port:M,protos:ie,fmts:De}}parseTimeFields(){let y=[];for(;this.getCurrentRecord().type===_.TIME;){let N=this.parseTime(),M=this.parseRepeat(),ie=this.parseZone();y.push({time:N,repeats:M,zones:ie})}return y}parseMediaDescription(){let y=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===_.MEDIA;){let N=this.parseMedia(),M=this.parseInformation(),ie=this.parseConnections(),De=this.parseBandWidth(),gt=this.parseKey(),Oi=this.parseMediaAttributes(N);y.push({media:N,information:M,connections:ie,bandwidths:De,key:gt,attributes:Oi})}return y}parseConnections(){let y=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===_.CONNECTION;)y.push(this.parseConnection());return y}parseFmt(y){let N=[];for(;;)try{this.consumeSpaceForRecord(y),N.push(this.extract(y,this.consumeToken))}catch{break}if(N.length===0)throw new Error("Invalid fmts");return N}extract(y,N,...M){let ie=N.call(this,y.value,y.cur,...M),De=y.value.slice(y.cur,ie);return y.cur=ie,De}extractOneOrMore(y,N){let M=this.consumeOneOrMore(y.value,y.cur,N),ie=y.value.slice(y.cur,M);return y.cur=M,ie}consumeSpaceForRecord(y){if(y.value[y.cur]!==p)throw new Error("Invalid space at ".concat(y.cur,"."));y.cur+=1}}class We extends ne{constructor(...y){super(...y),ce(this,"attributes",void 0),ce(this,"digested",!1)}extractOneOrMore(y,N,M){let ie=this.consumeOneOrMore(y.attValue,y._cur,N),De=y.attValue.slice(y._cur,ie),[gt,Oi]=M||[];if(typeof gt=="number"&&De.length<gt)throw new Error("error in length, should be more or equal than ".concat(gt," characters."));if(typeof Oi=="number"&&De.length>Oi)throw new Error("error in length, should be less or equal than ".concat(Oi," characters."));return y._cur=ie,De}consumeAttributeSpace(y){if(y.attValue[y._cur]!==p)throw new Error("Invalid space at ".concat(y._cur,"."));y._cur+=1}extract(y,N,...M){if(!y.attValue)throw new Error("Nothing to extract from attValue.");let ie=N.call(this,y.attValue,y._cur,...M),De=y.attValue.slice(y._cur,ie);return y._cur=ie,De}atEnd(y){if(!y.attValue)throw new Error;return y._cur>=y.attValue.length}peekChar(y){if(!y.attValue)throw new Error;return y.attValue[y._cur]}peek(y,N){if(!y.attValue)throw new Error;for(let M=0;M<N.length;M++)if(N[M]!==y.attValue[y._cur+M])return!1;return!0}parseIceUfrag(y){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(y,X,[4,256])}parseIcePwd(y){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(y,X,[22,256])}parseIceOptions(y){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");let N=[];for(;!this.atEnd(y);){N.push(this.extractOneOrMore(y,X));try{this.consumeAttributeSpace(y)}catch(M){if(this.atEnd(y))break;throw M}}this.attributes.iceOptions=N}parseFingerprint(y){let N=this.extract(y,this.consumeToken);this.consumeAttributeSpace(y);let M=this.extract(y,this.consumeTill);this.attributes.fingerprints.push({hashFunction:N,fingerprint:M})}parseExtmap(y){let N=this.extractOneOrMore(y,E),M;this.peekChar(y)==="/"&&(this.extract(y,this.consume,"/"),M=this.extract(y,this.consumeToken)),this.consumeAttributeSpace(y);let ie=this.extract(y,this.consumeTill,p),De=W(W({entry:parseInt(N,10)},M&&{direction:M}),{},{extensionName:ie});this.peekChar(y)===p&&(this.consumeAttributeSpace(y),De.extensionAttributes=this.extract(y,this.consumeTill)),this.attributes.extmaps.push(De)}parseSetup(y){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");let N=this.extract(y,this.consumeTill);if(N!=="active"&&N!=="passive"&&N!=="actpass"&&N!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=N}}class It extends We{constructor(...y){super(...y),ce(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(y){if(this.digested)throw new Error("already digested");try{switch(y.attField){case"group":this.parseGroup(y);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(y);break;case"ice-pwd":this.parseIcePwd(y);break;case"ice-options":this.parseIceOptions(y);break;case"fingerprint":this.parseFingerprint(y);break;case"setup":this.parseSetup(y);break;case"tls-id":this.parseTlsId(y);break;case"identity":this.parseIdentity(y);break;case"extmap":this.parseExtmap(y);break;case"msid-semantic":this.parseMsidSemantic(y);break;default:y.ignored=!0,this.attributes.unrecognized.push(y)}}catch(N){throw console.error("parsing session attribute ".concat(y.attField,' error, "a=').concat(y.attField,":").concat(y.attValue,'"')),N}if(!y.ignored&&y.attValue&&!this.atEnd(y))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(y){let N=this.extract(y,this.consumeToken),M=[];for(;!this.atEnd(y)&&this.peekChar(y)===p;)this.consumeAttributeSpace(y),M.push(this.extract(y,this.consumeToken));this.attributes.groups.push({semantic:N,identificationTag:M})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(y){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(y,z)}parseIdentity(y){let N=this.extractOneOrMore(y,j),M=[];for(;!this.atEnd(y)&&this.peekChar(y)===p;){this.consumeAttributeSpace(y);let ie=this.extract(y,this.consumeToken);this.extract(y,this.consume,"=");let De=this.extractOneOrMore(y,gt=>gt!==p&&U(gt));M.push({name:ie,value:De})}this.attributes.identities.push({assertionValue:N,extensions:M})}parseMsidSemantic(y){this.peekChar(y)===p&&this.consumeAttributeSpace(y);let N={semantic:this.extract(y,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(y)}catch{break}if(this.peekChar(y)==="*"){this.extract(y,this.consume,"*"),N.applyForAll=!0;break}{let M=this.extract(y,this.consumeTill,p);N.identifierList.push(M)}}this.attributes.msidSemantic=N}}class Gt extends We{constructor(y){super(),ce(this,"attributes",void 0),y.protos.indexOf("RTP")!==-1||y.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(y){if(this.digested)throw new Error("already digested");try{switch(y.attField){case"extmap":this.parseExtmap(y);break;case"setup":this.parseSetup(y);break;case"ice-ufrag":this.parseIceUfrag(y);break;case"ice-pwd":this.parseIcePwd(y);break;case"ice-options":this.parseIceOptions(y);break;case"candidate":this.parseCandidate(y);break;case"remote-candidate":this.parseRemoteCandidate(y);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(y);break;case"rtpmap":this.parseRtpmap(y);break;case"ptime":this.parsePtime(y);break;case"maxptime":this.parseMaxPtime(y);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(y);break;case"ssrc":this.parseSSRC(y);break;case"fmtp":this.parseFmtp(y);break;case"rtcp-fb":this.parseRtcpFb(y);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(y);break;case"mid":this.parseMid(y);break;case"msid":this.parseMsid(y);break;case"imageattr":this.parseImageAttr(y);break;case"rid":this.parseRid(y);break;case"simulcast":this.parseSimulcast(y);break;case"sctp-port":this.parseSctpPort(y);break;case"max-message-size":this.parseMaxMessageSize(y);break;case"ssrc-group":this.parseSSRCGroup(y);break;default:y.ignored=!0,this.attributes.unrecognized.push(y)}}catch(N){throw console.error("parsing media attribute ".concat(y.attField,' error, "a=').concat(y.attField,":").concat(y.attValue,'"')),N}if(!y.ignored&&y.attValue&&!this.atEnd(y))throw new Error("attribute parsing error")}parseCandidate(y){let N=this.extractOneOrMore(y,X,[1,32]);this.consumeAttributeSpace(y);let M=this.extractOneOrMore(y,E,[1,5]);this.consumeAttributeSpace(y);let ie=this.extract(y,this.consumeToken);this.consumeAttributeSpace(y);let De=this.extractOneOrMore(y,E,[1,10]);this.consumeAttributeSpace(y);let gt=this.extract(y,this.consumeAddress);this.consumeAttributeSpace(y);let Oi=this.extract(y,this.consumePort);this.consumeAttributeSpace(y),this.extract(y,this.consume,"typ"),this.consumeAttributeSpace(y);let wr={foundation:N,componentId:M,transport:ie,priority:De,connectionAddress:gt,port:Oi,type:this.extract(y,this.consumeToken),extension:{}};for(this.peek(y," raddr")&&(this.extract(y,this.consume," raddr"),this.consumeAttributeSpace(y),wr.relAddr=this.extract(y,this.consumeAddress)),this.peek(y," rport")&&(this.extract(y,this.consume," rport"),this.consumeAttributeSpace(y),wr.relPort=this.extract(y,this.consumePort));this.peekChar(y)===p;){this.consumeAttributeSpace(y);let Ws=this.extract(y,this.consumeToken);this.consumeAttributeSpace(y),wr.extension[Ws]=this.extractOneOrMore(y,T)}this.attributes.candidates.push(wr)}parseRemoteCandidate(y){let N=[];for(;;){let M=this.extractOneOrMore(y,E,[1,5]);this.consumeAttributeSpace(y);let ie=this.extract(y,this.consumeAddress);this.consumeAttributeSpace(y);let De=this.extract(y,this.consumePort);N.push({componentId:M,connectionAddress:ie,port:De});try{this.consumeAttributeSpace(y)}catch{break}}this.attributes.remoteCandidatesList.push(N)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(y){let N=this.extract(y,this.consumeToken);this.consumeAttributeSpace(y);let M=this.extract(y,this.consumeTill,"/");this.extract(y,this.consume,"/");let ie={encodingName:M,clockRate:this.extractOneOrMore(y,E)};this.atEnd(y)||this.peekChar(y)!=="/"||(this.extract(y,this.consume,"/"),ie.encodingParameters=parseInt(this.extract(y,this.consumeTill),10));let De=this.attributes.payloads.find(gt=>gt.payloadType===parseInt(N,10));De?De.rtpMap=ie:this.attributes.payloads.push({payloadType:parseInt(N,10),rtpMap:ie,rtcpFeedbacks:[]})}parsePtime(y){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(y,this.consumeTill)}parseMaxPtime(y){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(y,this.consumeTill)}parseDirection(y){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=y.attField}parseSSRC(y){let N=this.extractOneOrMore(y,E);this.consumeAttributeSpace(y);let M=this.extract(y,this.consumeTill,":"),ie;this.peekChar(y)===":"&&(this.extract(y,this.consume,":"),ie=this.extract(y,this.consumeTill));let De=this.attributes.ssrcs.find(gt=>gt.ssrcId===parseInt(N,10));De?De.attributes[M]=ie:this.attributes.ssrcs.push({ssrcId:parseInt(N,10),attributes:{[M]:ie}})}parseFmtp(y){let N=this.extract(y,this.consumeTill,p);this.consumeAttributeSpace(y);let M=this.extract(y,this.consumeTill),ie={};M.split(";").forEach(gt=>{let[Oi,wr]=gt.split("=");Oi=Oi.trim();let Ws=typeof wr=="string"?wr.trim():null;typeof Oi=="string"&&Oi.length>0&&(ie[Oi]=Ws)});let De=this.attributes.payloads.find(gt=>gt.payloadType===parseInt(N,10));De?De.fmtp={parameters:ie}:this.attributes.payloads.push({payloadType:parseInt(N,10),rtcpFeedbacks:[],fmtp:{parameters:ie}})}parseFmtParameters(y){let N={},M=this.extract(y,this.consumeTill,"=");y._cur++;let ie=this.extract(y,this.consumeTill,";");for(N[M]=ie;y.attValue[y._cur]===";";){let De=this.extract(y,this.consumeTill,"=");y._cur++;let gt=this.extract(y,this.consumeTill,";");N[De]=gt}return N}parseRtcpFb(y){let N="";N=this.peekChar(y)==="*"?this.extract(y,this.consume,"*"):this.extract(y,this.consumeTill,p),this.consumeAttributeSpace(y);let M=this.extract(y,this.consumeTill,p),ie;if(M==="trr-int")ie={type:M,interval:this.extract(y,this.consumeTill)};else{let De={type:M};this.peekChar(y)===p&&(this.consumeAttributeSpace(y),De.parameter=this.extract(y,this.consumeToken),this.peekChar(y)===p&&(De.additional=this.extract(y,this.consumeTill))),ie=De}if(N==="*")this.attributes.rtcpFeedbackWildcards.push(ie);else{let De=this.attributes.payloads.find(gt=>gt.payloadType===parseInt(N,10));De?De.rtcpFeedbacks.push(ie):this.attributes.payloads.push({payloadType:parseInt(N,10),rtcpFeedbacks:[ie]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(y){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");let N={port:this.extract(y,this.consumePort)};this.peekChar(y)===p&&(this.consumeAttributeSpace(y),N.netType=this.extractOneOrMore(y,C),this.consumeAttributeSpace(y),N.addressType=this.extractOneOrMore(y,C),this.consumeAttributeSpace(y),N.address=this.extract(y,this.consumeAddress)),this.attributes.rtcp=N}parseMsid(y){let N={id:this.extractOneOrMore(y,C,[1,64])};this.peekChar(y)===p&&(this.consumeAttributeSpace(y),N.appdata=this.extractOneOrMore(y,C,[1,64])),this.attributes.msids.push(N)}parseImageAttr(y){this.attributes.imageattr.push(y.attValue)}parseRid(y){let N=this.extractOneOrMore(y,ie=>b(ie)||E(ie)||ie==="_"||ie==="-");this.consumeAttributeSpace(y);let M={id:N,direction:this.extract(y,this.consumeToken),params:[]};if(this.peekChar(y)===p){if(this.consumeAttributeSpace(y),this.peek(y,"pt=")){this.extract(y,this.consume,"pt=");let ie=[];for(;;){let De=this.extract(y,this.consumeToken);ie.push(De);try{this.extract(y,this.consume,",")}catch{break}}M.payloads=ie,this.peekChar(y)===p&&this.extract(y,this.consume,p)}for(;;){let ie=this.extract(y,this.consumeToken);switch(ie){case"depend":{let De={type:ie,rids:this.extract(y,this.consume,"=").split(",")};M.params.push(De);break}default:{let De={type:ie};this.peekChar(y)==="="&&(this.extract(y,this.consume,"="),De.val=this.extract(y,this.consumeTill,";")),M.params.push(De)}}try{this.extract(y,this.consume,";")}catch{break}}}this.attributes.rids.push(M)}parseSimulcast(y){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=y.attValue,this.extract(y,this.consumeTill)}parseSctpPort(y){this.attributes.sctpPort=this.extractOneOrMore(y,E,[1,5])}parseMaxMessageSize(y){this.attributes.maxMessageSize=this.extractOneOrMore(y,E,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(y){this.attributes.mid=this.extract(y,this.consumeToken)}parseSSRCGroup(y){let N=this.extract(y,this.consumeToken),M=[];for(;;)try{this.consumeAttributeSpace(y);let ie=this.extract(y,this.consumeInteger);M.push(parseInt(ie,10))}catch{break}this.attributes.ssrcGroups.push({semantic:N,ssrcIds:M})}}function pt(oe,y,N){return y in oe?Object.defineProperty(oe,y,{value:N,enumerable:!0,configurable:!0,writable:!0}):oe[y]=N,oe}class Ir{constructor(){pt(this,"eol",h)}print(y,N){let M="";return N&&(this.eol=N),M+=this.printVersion(y.version),M+=this.printOrigin(y.origin),M+=this.printSessionName(y.sessionName),M+=this.printInformation(y.information),M+=this.printUri(y.uri),M+=this.printEmail(y.emails),M+=this.printPhone(y.phones),M+=this.printConnection(y.connection),M+=this.printBandwidth(y.bandwidths),M+=this.printTimeFields(y.timeFields),M+=this.printKey(y.key),M+=this.printSessionAttributes(y.attributes),M+=this.printMediaDescription(y.mediaDescriptions),M}printVersion(y){return"v=".concat(y).concat(this.eol)}printOrigin(y){return"o=".concat(y.username," ").concat(y.sessId," ").concat(y.sessVersion," ").concat(y.nettype," ").concat(y.addrtype," ").concat(y.unicastAddress).concat(this.eol)}printSessionName(y){return y?"s=".concat(y).concat(this.eol):""}printInformation(y){return y?"i=".concat(y).concat(this.eol):""}printUri(y){return y?"u=".concat(y).concat(this.eol):""}printEmail(y){let N="";for(let M of y)N+="e=".concat(M).concat(this.eol);return N}printPhone(y){let N="";for(let M of y)N+="e=".concat(M).concat(this.eol);return N}printConnection(y){return y?"c=".concat(y.nettype," ").concat(y.addrtype," ").concat(y.address).concat(this.eol):""}printBandwidth(y){let N="";for(let M of y)N+="b=".concat(M.bwtype,":").concat(M.bandwidth).concat(this.eol);return N}printTimeFields(y){let N="";for(let M of y){N+="t=".concat(M.time.startTime," ").concat(M.time.startTime).concat(this.eol);for(let ie of M.repeats)N+="r=".concat(ie.repeatInterval," ").concat(ie.typedTimes.join(" ")).concat(this.eol);M.zoneAdjustments&&(N+="z=",N+="z=".concat(M.zoneAdjustments.map(ie=>"".concat(ie.time," ").concat(ie.back?"-":""," ").concat(ie.typedTime)).join(" ")).concat(this.eol),N+=this.eol)}return N}printKey(y){return y?"k=".concat(y).concat(this.eol):""}printAttributes(y){let N="";for(let M of y)N+="a=".concat(M.attField).concat(M.attValue?":".concat(M.attValue):"").concat(this.eol);return N}printMediaDescription(y){let N="";for(let M of y)N+=this.printMedia(M.media),N+=this.printInformation(M.information),N+=this.printConnections(M.connections),N+=this.printBandwidth(M.bandwidths),N+=this.printKey(M.key),N+=this.printMediaAttributes(M);return N}printConnections(y){let N="";for(let M of y)N+=this.printConnection(M);return N}printMedia(y){return"m=".concat(y.mediaType," ").concat(y.port," ").concat(y.protos.join("/")," ").concat(y.fmts.join(" ")).concat(this.eol)}printSessionAttributes(y){return new re(this.eol).print(y)}printMediaAttributes(y){return new he(this.eol).print(y)}}class Z{constructor(y){pt(this,"eol",void 0),this.eol=y}printIceUfrag(y){return y===void 0?"":"a=ice-ufrag:".concat(y).concat(this.eol)}printIcePwd(y){return y===void 0?"":"a=ice-pwd:".concat(y).concat(this.eol)}printIceOptions(y){return y===void 0?"":"a=ice-options:".concat(y.join(p)).concat(this.eol)}printFingerprints(y){return y.length>0?y.map(N=>"a=fingerprint:".concat(N.hashFunction).concat(p).concat(N.fingerprint)).join(this.eol)+this.eol:""}printExtmap(y){return y.map(N=>"a=extmap:".concat(N.entry).concat(N.direction?"/".concat(N.direction):"").concat(p).concat(N.extensionName).concat(N.extensionAttributes?"".concat(p).concat(N.extensionAttributes):"").concat(this.eol)).join("")}printSetup(y){return y===void 0?"":"a=setup:".concat(y).concat(this.eol)}printUnrecognized(y){return y.map(N=>"a=".concat(N.attField).concat(N.attValue?":".concat(N.attValue):"").concat(this.eol)).join("")}}class re extends Z{print(y){let N="";return N+=this.printGroups(y.groups),N+=this.printMsidSemantic(y.msidSemantic),N+=this.printIceLite(y.iceLite),N+=this.printIceUfrag(y.iceUfrag),N+=this.printIcePwd(y.icePwd),N+=this.printIceOptions(y.iceOptions),N+=this.printFingerprints(y.fingerprints),N+=this.printSetup(y.setup),N+=this.printTlsId(y.tlsId),N+=this.printIdentity(y.identities),N+=this.printExtmap(y.extmaps),N+=this.printUnrecognized(y.unrecognized),N}printGroups(y){let N="";return y.length>0&&(N+=y.map(M=>"a=group:".concat(M.semantic).concat(M.identificationTag.map(ie=>"".concat(p).concat(ie)).join("")).concat(this.eol)).join("")),N}printIceLite(y){return y===void 0?"":"a=ice-lite"+this.eol}printTlsId(y){return y?"a=tls-id:".concat(y).concat(this.eol):""}printIdentity(y){return y.length===0?"":y.map(N=>"a=identity:".concat(N.assertionValue).concat(N.extensions.map(M=>"".concat(p).concat(M.name).concat(M.value?"=".concat(M.value):"")))).join(this.eol)+this.eol}printMsidSemantic(y){if(!y)return"";let N="a=msid-semantic:".concat(y.semantic);return y.applyForAll?N+="".concat(p,"*"):y.identifierList.length>0&&(N+=y.identifierList.map(M=>"".concat(p).concat(M))),N+this.eol}}class he extends Z{print(y){let N=y.attributes,M="";return M+=this.printRTCP(N.rtcp),M+=this.printIceUfrag(N.iceUfrag),M+=this.printIcePwd(N.icePwd),M+=this.printIceOptions(N.iceOptions),M+=this.printCandidates(N.candidates),M+=this.printRemoteCandidatesList(N.remoteCandidatesList),M+=this.printEndOfCandidates(N.endOfCandidates),M+=this.printFingerprints(N.fingerprints),M+=this.printSetup(N.setup),M+=this.printMid(N.mid),M+=this.printExtmap(N.extmaps),M+=this.printRTPRelated(N),M+=this.printPtime(N.ptime),M+=this.printMaxPtime(N.maxPtime),M+=this.printDirection(N.direction),M+=this.printSSRCGroups(N.ssrcGroups),M+=this.printSSRC(N.ssrcs),M+=this.printRTCPMux(N.rtcpMux),M+=this.printRTCPMuxOnly(N.rtcpMuxOnly),M+=this.printRTCPRsize(N.rtcpRsize),M+=this.printMSId(N.msids),M+=this.printImageattr(N.imageattr),M+=this.printRid(N.rids),M+=this.printSimulcast(N.simulcast),M+=this.printSCTPPort(N.sctpPort),M+=this.printMaxMessageSize(N.maxMessageSize),M+=this.printUnrecognized(N.unrecognized),M}printCandidates(y){return y.map(N=>"a=candidate:".concat(N.foundation).concat(p).concat(N.componentId).concat(p).concat(N.transport).concat(p).concat(N.priority).concat(p).concat(N.connectionAddress).concat(p).concat(N.port).concat(p,"typ").concat(p).concat(N.type).concat(N.relAddr?"".concat(p,"raddr").concat(p).concat(N.relAddr):"").concat(N.relPort?"".concat(p,"rport").concat(p).concat(N.relPort):"").concat(Object.keys(N.extension).map(M=>"".concat(p).concat(M).concat(p).concat(N.extension[M])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(y){return y.map(N=>"a=remote-candidates:".concat(N.join(p)).concat(this.eol)).join("")}printEndOfCandidates(y){return y===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(y){if(!y.payloads)return"";let N=y.payloads,M="";M+=y.rtcpFeedbackWildcards.map(ie=>this.printRTCPFeedback("*",ie)).join("");for(let ie of N)M+=this.printRtpMap(ie.payloadType,ie.rtpMap),M+=this.printFmtp(ie.payloadType,ie.fmtp),M+=ie.rtcpFeedbacks.map(De=>this.printRTCPFeedback(ie.payloadType,De)).join("");return M}printFmtp(y,N){if(!N)return"";let M=Object.keys(N.parameters);return M.length===1&&N.parameters[M[0]]===null?"a=fmtp:".concat(y).concat(p).concat(M[0]).concat(this.eol):"a=fmtp:".concat(y).concat(p).concat(Object.keys(N.parameters).map(ie=>"".concat(ie,"=").concat(N.parameters[ie])).join(";")).concat(this.eol)}printRtpMap(y,N){return N?"a=rtpmap:".concat(y).concat(p).concat(N.encodingName,"/").concat(N.clockRate).concat(N.encodingParameters?"/".concat(N.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(y,N){let M="a=rtcp-fb:".concat(y).concat(p),ie=N;return ie.type==="trr-int"?M+="ttr-int".concat(p).concat(ie.interval):(M+="".concat(ie.type),ie.parameter&&(M+="".concat(p).concat(ie.parameter),ie.additional&&(M+="".concat(p).concat(ie.additional)))),M+this.eol}printPtime(y){return y===void 0?"":"a=ptime:".concat(y).concat(this.eol)}printMaxPtime(y){return y===void 0?"":"a=maxptime:".concat(y).concat(this.eol)}printDirection(y){return y===void 0?"":"a=".concat(y).concat(this.eol)}printSSRC(y){return y.map(N=>Object.keys(N.attributes).map(M=>"a=ssrc:".concat(N.ssrcId.toString(10)).concat(p).concat(M).concat(N.attributes[M]?":".concat(N.attributes[M]):"").concat(this.eol)).join("")).join("")}printRTCPMux(y){return y===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(y){return y===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(y){return y===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(y){if(y===void 0)return"";let N="a=rtcp:".concat(y.port);return y.netType&&(N+="".concat(p).concat(y.netType)),y.addressType&&(N+="".concat(p).concat(y.addressType)),y.address&&(N+="".concat(p).concat(y.address)),N+this.eol}printMSId(y){return y.map(N=>"a=msid:".concat(N.id).concat(N.appdata?"".concat(p).concat(N.appdata):"").concat(this.eol)).join("")}printImageattr(y){return y.map(N=>"a=imageattr:".concat(N).concat(this.eol)).join("")}printRid(y){return y.map(N=>{let M="a=rid:".concat(N.id).concat(p).concat(N.direction);return N.payloads&&(M+="".concat(p,"pt=").concat(N.payloads.join(","))),N.params.length>0&&(M+="".concat(p).concat(N.params.map(ie=>ie.type==="depend"?"depend=".concat(ie.rids.join(",")):"".concat(ie.type,"=").concat(ie.val)).join(";"))),M+this.eol}).join("")}printSimulcast(y){return y===void 0?"":"a=simulcast:".concat(y).concat(this.eol)}printSCTPPort(y){return y===void 0?"":"a=sctp-port:".concat(y).concat(this.eol)}printMaxMessageSize(y){return y===void 0?"":"a=max-message-size:".concat(y).concat(this.eol)}printMid(y){return y===void 0?"":"a=mid:".concat(y).concat(this.eol)}printSSRCGroups(y){return y.map(N=>"a=ssrc-group:".concat(N.semantic).concat(N.ssrcIds.map(M=>"".concat(p).concat(M.toString(10))).join("")).concat(this.eol)).join("")}}function Ne(oe){return new Pe().parse(oe)}function qe(oe,y){return new Ir().print(oe,y)}}},r={};function n(a){if(r[a])return r[a].exports;var c=r[a]={exports:{}};return t[a](c,c.exports,n),c.exports}return n.d=(a,c)=>{for(var l in c)n.o(c,l)&&!n.o(a,l)&&Object.defineProperty(a,l,{enumerable:!0,get:c[l]})},n.o=(a,c)=>Object.prototype.hasOwnProperty.call(a,c),n.r=a=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(a,"__esModule",{value:!0})},n(8)})()})(Z0);var At=Z0.exports;function eN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function tN(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?eN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):eN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function rS(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0,{filterRTX:n,filterVideoFec:a,filterAudioFec:c,filterAudioCodec:l,filterVideoCodec:u}=e,{useXR:h}=t,p=[],_=[],E=[],T=[],w=!1,C=!1;if(At.parse(i).mediaDescriptions.forEach(b=>{r&&r!==b.attributes.direction||(b.media.mediaType!=="video"||w||(_=b.attributes.payloads,T=b.attributes.extmaps,w=!0),b.media.mediaType!=="audio"||C||(p=b.attributes.payloads,E=b.attributes.extmaps,C=!0))}),!T||_.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!E||p.length===0)throw new Error("Cannot get audio capabilities from SDP.");_.forEach(b=>{var k;(k=b.rtpMap)!==null&&k!==void 0&&k.clockRate&&(b.rtpMap.clockRate=parseInt(b.rtpMap.clockRate)),h&&b.rtcpFeedbacks.push({type:"rrtr"})}),p.forEach(b=>{var k;(k=b.rtpMap)!==null&&k!==void 0&&k.clockRate&&(b.rtpMap.clockRate=parseInt(b.rtpMap.clockRate)),h&&b.rtcpFeedbacks.push({type:"rrtr"})}),n&&(p=p.filter(b=>{var k;return((k=b.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())!=="rtx"}),_=_.filter(b=>{var k;return((k=b.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())!=="rtx"})),a&&(_=_.filter(b=>{var k;return!/(red)|(ulpfec)|(flexfec)/i.test(((k=b.rtpMap)===null||k===void 0?void 0:k.encodingName)||"")})),c&&(p=p.filter(b=>{var k;return!/(red)|(ulpfec)|(flexfec)/i.test(((k=b.rtpMap)===null||k===void 0?void 0:k.encodingName)||"")})),l&&(l==null?void 0:l.length)>0&&(p=p.filter(b=>{var k;return ge(l).call(l,((k=b.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())||"")})),u&&(u==null?void 0:u.length)>0&&(_=_.filter(b=>{var k;return ge(u).call(u,((k=b.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())||"")}));let O=P("UNSUPPORTED_VIDEO_CODEC");return O&&O.length>0&&(_=_.filter(b=>!(b.rtpMap&&ge(O).call(O,b.rtpMap.encodingName.toLowerCase())))),{audioCodecs:p,videoCodecs:_,audioExtensions:E,videoExtensions:T}}function Vo(i){let e=At.parse(i),t,r;for(let n of e.mediaDescriptions){if(!t){let a=n.attributes.iceUfrag,c=n.attributes.icePwd;if(!a||!c)throw new Error("Cannot get iceUfrag or icePwd from SDP.");t={iceUfrag:a,icePwd:c}}if(!r){let a=n.attributes.fingerprints;a.length>0&&(r={fingerprints:a})}}if(!r&&e.attributes.fingerprints.length>0&&(r={fingerprints:e.attributes.fingerprints}),!r||!t)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:t,dtlsParameters:r}}function iN(i,e){let t=[],r=i.attributes.ssrcGroups.filter(c=>c.semantic==="FID"),n=i.attributes.ssrcGroups.find(c=>c.semantic==="SIM"),a=i.attributes.ssrcs;if(n)n.ssrcIds.forEach(c=>{var l;let u=(l=r.find(h=>h.ssrcIds[0]===c))===null||l===void 0?void 0:l.ssrcIds[1];t.push({ssrcId:c,rtx:e?u:void 0})});else if(r.length>0){let c=r[0].ssrcIds[0],l=r[0].ssrcIds[1];t.push({ssrcId:c,rtx:e?l:void 0})}else{if(a.length===0)throw new Error("No ssrcs found on local media description.");t.push({ssrcId:a[0].ssrcId})}return t}function rN(i,e){let{cname:t}=i,r;e&&e.ip&&typeof e.port=="number"?(r=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],S.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(r.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),S.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):r=i.iceParameters.candidates.map(l=>({foundation:l.foundation,componentId:"1",transport:l.protocol,priority:l.priority.toString(),connectionAddress:l.ip,port:l.port.toString(),type:l.type,extension:{}}));let n={fingerprints:i.dtlsParameters.fingerprints.map(l=>({hashFunction:l.algorithm,fingerprint:l.fingerprint}))},a={iceUfrag:i.iceParameters.iceUfrag,icePwd:i.iceParameters.icePwd},c;switch(i.dtlsParameters.role){case"server":c="passive";break;case"client":c="active";break;case"auto":c="actpass"}return{dtlsParameters:n,iceParameters:a,candidates:r,rtpCapabilities:Fp(i.rtpCapabilities),setup:c,cname:t}}function un(i,e,t){let r=[],n=[];return i.forEach(a=>{let{ssrcId:c,rtx:l}=a,u=at(8,"track-"),h={ssrcId:c,attributes:tN({label:u,mslabel:t=t||at(10,""),msid:"".concat(t," ").concat(u)},e&&{cname:e})};if(r.push(h),l!==void 0){let p={ssrcId:l,attributes:tN({label:u,mslabel:t,msid:"".concat(t," ").concat(u)},e&&{cname:e})};r.push(p),n.push({semantic:"FID",ssrcIds:[c,l]})}}),i.length>1&&n.push({semantic:"SIM",ssrcIds:i.map(a=>{let{ssrcId:c}=a;return c})}),{ssrcs:r,ssrcGroups:n}}function Fo(i,e){e instanceof Qe&&i.attributes.payloads.forEach(t=>{var r;let n=(r=t.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase();if(!n||["opus","pcmu","pcma","g722"].indexOf(n)===-1)return;t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.minptime="10",t.fmtp.parameters.useinbandfec="1";let a=e._encoderConfig;a&&n!=="pcmu"&&n!=="pcma"&&n!=="g722"&&(a.bitrate&&!ht()&&(t.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*a.bitrate))),a.sampleRate&&(t.fmtp.parameters.maxplaybackrate="".concat(a.sampleRate),t.fmtp.parameters["sprop-maxcapturerate"]="".concat(a.sampleRate)),a.stereo&&(t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"))})}function nS(i){let e=i.attributes.unrecognized.findIndex(t=>t.attField==="x-google-flag"&&t.attValue==="conference");e!==-1&&i.attributes.unrecognized.splice(e,1)}function sS(i,e){var t;if(!(e instanceof ke&&e._encoderConfig&&e._hints.indexOf(ut.SCREEN_TRACK)===-1))return;let r=e._encoderConfig;ct().supportMinBitrate&&r.bitrateMin&&i.attributes.payloads.forEach(n=>{var a,c;ge(a=["h264","h265","vp8","vp9","av1"]).call(a,((c=n.rtpMap)===null||c===void 0?void 0:c.encodingName.toLowerCase())||"")&&(n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters["x-google-min-bitrate"]="".concat(r.bitrateMin))}),ct().supportMinBitrate&&!ge(t=e._hints).call(t,ut.LOW_STREAM)&&r.bitrateMax&&i.attributes.payloads.forEach(n=>{var a,c;ge(a=["h264","h265","vp8","vp9","av1"]).call(a,((c=n.rtpMap)===null||c===void 0?void 0:c.encodingName.toLowerCase())||"")&&(n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters["x-google-start-bitrate"]="".concat(P("X_GOOGLE_START_BITRATE")||Math.floor(r.bitrateMax)))})}function nN(i){if(i.media.mediaType!=="video")return;let e=ze();if(e.name!==Xe.SAFARI&&e.os!==Jt.IOS)return;let t=i.attributes.extmaps.findIndex(r=>/video-orientation/g.test(r.extensionName));t!==-1&&i.attributes.extmaps.splice(t,1)}function xp(i,e,t){if(!e)return;let r,n;if(i.media.mediaType==="video"?(r=t.videoExtensions,n=t.videoCodecs):(r=t.audioExtensions,n=t.audioCodecs),e.twcc===!0){let a=r.find(c=>c.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");a&&(i.attributes.extmaps.find(c=>c.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||i.attributes.extmaps.push({entry:a.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(c,l){return l.filter(u=>!!c.find(h=>h.payloadType===u.payloadType&&!!h.rtcpFeedbacks.find(p=>p.type==="transport-cc")))}(n,i.attributes.payloads).forEach(c=>{c.rtcpFeedbacks.find(l=>l.type==="transport-cc")||c.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(e.twcc===!1){let a=i.attributes.extmaps.findIndex(c=>c.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");a!==-1&&i.attributes.extmaps.splice(a,1),i.attributes.payloads.forEach(c=>{let l=c.rtcpFeedbacks.findIndex(u=>u.type==="transport-cc");l!==-1&&c.rtcpFeedbacks.splice(l,1)})}if(e.remb===!0){let a=r.find(c=>c.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");a&&(i.attributes.extmaps.find(c=>c.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||i.attributes.extmaps.push({entry:a.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(c,l){return l.filter(u=>!!c.find(h=>h.payloadType===u.payloadType&&!!h.rtcpFeedbacks.find(p=>p.type==="goog-remb")))}(n,i.attributes.payloads).forEach(c=>{c.rtcpFeedbacks.find(l=>l.type==="goog-remb")||c.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(e.remb===!1){let a=i.attributes.extmaps.findIndex(c=>c.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");a!==-1&&i.attributes.extmaps.splice(a,1),i.attributes.payloads.forEach(c=>{let l=c.rtcpFeedbacks.findIndex(u=>u.type==="goog-remb");l!==-1&&c.rtcpFeedbacks.splice(l,1)})}}function aS(i,e,t){if(ht()||i.media.mediaType!=="video"||!(e instanceof ke)||t!=="vp9"&&t!=="vp8"||t==="vp8"&&!P("SIMULCAST")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;let r=t==="vp8"?2:e._scalabilityMode.numSpatialLayers,n=i.attributes.ssrcs[0],a=i.attributes.ssrcGroups.find(l=>l.semantic==="FID"&&l.ssrcIds[0]===n.ssrcId),c={semantic:"SIM",ssrcIds:[n.ssrcId]};for(let l=1;l<r;l++)i.attributes.ssrcs.push({ssrcId:n.ssrcId+l,attributes:Ut(n.attributes)}),c.ssrcIds.push(n.ssrcId+l),a&&(i.attributes.ssrcs.push({ssrcId:a.ssrcIds[1]+l,attributes:Ut(n.attributes)}),i.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[n.ssrcId+l,a.ssrcIds[1]+l]}));i.attributes.ssrcGroups.unshift(c)}async function sN(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{filterRTX:t,filterVideoFec:r,filterAudioFec:n,filterAudioCodec:a,filterVideoCodec:c}=i,{useXR:l}=e,u=new RTCPeerConnection;u.addTransceiver("video",{direction:"sendonly"}),u.addTransceiver("audio",{direction:"sendonly"}),u.addTransceiver("video",{direction:"recvonly"}),u.addTransceiver("audio",{direction:"recvonly"});let h=(await u.createOffer()).sdp,p=rS(h,{filterRTX:t,filterVideoFec:r,filterAudioFec:n,filterAudioCodec:a,filterVideoCodec:c},{useXR:l},"sendonly"),_=rS(h,{filterRTX:t,filterVideoFec:r,filterAudioFec:n,filterAudioCodec:a,filterVideoCodec:c},{useXR:l},"recvonly"),E={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},T={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},w={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Vp(p,_,"videoExtensions",E,T,w),Vp(p,_,"videoCodecs",E,T,w),Vp(p,_,"audioExtensions",E,T,w),Vp(p,_,"audioCodecs",E,T,w),P("RAISE_H264_BASELINE_PRIORITY")){let C=w.videoCodecs.findIndex(O=>{var b,k;return((b=O.rtpMap)===null||b===void 0?void 0:b.encodingName.toLocaleLowerCase())==="h264"&&((k=O.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"])==="42001f"});if(C!==-1){let O=w.videoCodecs.findIndex(b=>{var k;return((k=b.rtpMap)===null||k===void 0?void 0:k.encodingName.toLocaleLowerCase())==="h264"});if(O<C){S.debug("raising H264 baseline profile priority");let b=w.videoCodecs[C];w.videoCodecs.splice(C,1),w.videoCodecs.splice(O,0,b)}O!==-1&&(T.videoCodecs=T.videoCodecs.filter(b=>{var k,U;return!(((k=b.rtpMap)===null||k===void 0?void 0:k.encodingName.toLocaleLowerCase())==="h264"&&((U=b.fmtp)===null||U===void 0?void 0:U.parameters["profile-level-id"])!=="42001f")})),O!==-1&&P("FILTER_SEND_H264_BASELINE")&&(E.videoCodecs=E.videoCodecs.filter(b=>{var k,U;return!(((k=b.rtpMap)===null||k===void 0?void 0:k.encodingName.toLocaleLowerCase())==="h264"&&((U=b.fmtp)===null||U===void 0?void 0:U.parameters["profile-level-id"])!=="42001f")}))}}try{u.close()}catch{}return{send:E,recv:T,sendrecv:w}}function Vp(i,e,t,r,n,a){if(t==="videoExtensions"||t==="audioExtensions"){let c=[];return i[t].forEach(l=>{e[t].some((u,h)=>{if(l.entry===u.entry&&l.extensionName===u.extensionName)return c.push(h),!0})?a[t].push(l):r[t].push(l)}),void e[t].forEach((l,u)=>{c.indexOf(u)===-1&&n[t].push(l)})}if(t==="videoCodecs"||t==="audioCodecs"){let c=[];return i[t].forEach(l=>{e[t].some((u,h)=>{if(l.payloadType===u.payloadType&&JSON.stringify(l)===JSON.stringify(u))return c.push(h),!0})?a[t].push(l):r[t].push(l)}),void e[t].forEach((l,u)=>{c.indexOf(u)===-1&&n[t].push(l)})}}function Fp(i){let{send:e,recv:t,sendrecv:r}=i;if(!r){if(!e||!t)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:t}}let n,a;return e?(n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n.audioCodecs=[...e.audioCodecs,...r.audioCodecs],n.videoCodecs=[...e.videoCodecs,...r.videoCodecs],n.audioExtensions=[...e.audioExtensions,...r.audioExtensions],n.videoExtensions=[...e.videoExtensions,...r.videoExtensions]):n=r,t?(a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},a.audioCodecs=[...t.audioCodecs,...r.audioCodecs],a.videoCodecs=[...t.videoCodecs,...r.videoCodecs],a.audioExtensions=[...t.audioExtensions,...r.audioExtensions],a.videoExtensions=[...t.videoExtensions,...r.videoExtensions]):a=r,{send:n,recv:a}}function wa(i){i.media.mediaType==="audio"&&i.attributes.payloads.filter(e=>{var t;return((t=e.rtpMap)===null||t===void 0?void 0:t.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function jp(i){i.mediaDescriptions.forEach(e=>{e.media.mediaType!=="video"&&e.media.mediaType!=="audio"||e.attributes.payloads.forEach(t=>{t.rtcpFeedbacks.findIndex(r=>r.type==="rrtr")===-1&&t.rtcpFeedbacks.push({type:"rrtr"})})})}function Bp(i,e,t,r){let n=[];if(i===fe.VIDEO){if(P("H264_PROFILE_LEVEL_ID")&&r==="h264"&&(n=e.videoCodecs.filter(a=>{var c;return ge(c=a.rtpMap&&a.rtpMap.encodingName.toLowerCase()||"").call(c,r)&&a&&a.fmtp&&a.fmtp.parameters["profile-level-id"]===P("H264_PROFILE_LEVEL_ID")})),!Array.isArray(n)||n.length===0){let a=t.videoCodecs.filter(c=>{var l;return ge(l=c.rtpMap&&c.rtpMap.encodingName.toLowerCase()||"").call(l,r)});a.length!==0&&(n=e.videoCodecs.filter(c=>a.some(l=>l.payloadType===c.payloadType)))}if(P("USE_PUB_RTX")){let a=n.map(l=>l.payloadType.toString()),c=e.videoCodecs.filter(l=>l.rtpMap&&l.rtpMap.encodingName==="rtx"&&ge(a).call(a,l.fmtp&&l.fmtp.parameters.apt||""));n=[...n,...c]}n.length===0&&(S.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),n=e.videoCodecs)}else n=e.audioCodecs.filter(a=>{var c;return ge(c=a.rtpMap&&a.rtpMap.encodingName.toLowerCase()||"").call(c,r)}),n.length===0&&(S.warning("codec ".concat(r," not included in rtpCapabilities, fallback to opus")),n=e.audioCodecs.filter(a=>{var c;return ge(c=a.rtpMap&&a.rtpMap.encodingName.toLowerCase()||"").call(c,"opus")}));return n}function aN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function oN(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?aN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):aN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function Pn(i){if(Array.isArray(i))return i.map(t=>t);if(!cN(i))return i;let e={};for(let t in i){let r=i[t];cN(r)||Array.isArray(r)?e[t]=Pn(r):e[t]=r}return e}function cN(i){return!(typeof i!="object"||Array.isArray(i)||!i)}class oS{constructor(e){g(this,"input",[]),g(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}let Ts={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Gd={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Ts,remoteCandidate:Ts}},lN={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},dN={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},uN={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},hN={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function pN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function fN(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?pN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):pN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class cS{constructor(e,t){g(this,"onFirstVideoReceived",void 0),g(this,"onFirstVideoDecoded",void 0),g(this,"onFirstAudioReceived",void 0),g(this,"onFirstVideoDecodedTimeout",void 0),g(this,"onFirstAudioDecoded",void 0),g(this,"onSelectedLocalCandidateChanged",void 0),g(this,"onSelectedRemoteCandidateChanged",void 0),g(this,"videoIsReady",!1),g(this,"videoIsReady2",{}),g(this,"pc",void 0),g(this,"options",void 0),g(this,"intervalTimer",void 0),g(this,"stats",Pn(Gd)),g(this,"isFirstVideoReceived",{}),g(this,"isFirstVideoDecoded",{}),g(this,"isFirstAudioReceived",{}),g(this,"isFirstAudioDecoded",{}),g(this,"isFirstVideoDecodedTimeout",{}),g(this,"lossRateWindowStats",[]),this.pc=e,this.options=t,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new F(e=>{e({local:fN({},Ts),remote:fN({},Ts)})})}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);let t=this.lossRateWindowStats.length,r=["videoSend","audioSend","videoRecv","audioRecv"],n=0,a=0,c=0,l=0;for(let u of r)e[u].forEach((h,p)=>{if(!this.lossRateWindowStats[t-1][u][p]||!this.lossRateWindowStats[0][u][p])return;let _=this.lossRateWindowStats[t-1][u][p].packets-this.lossRateWindowStats[0][u][p].packets,E=this.lossRateWindowStats[t-1][u][p].packetsLost-this.lossRateWindowStats[0][u][p].packetsLost;u==="videoSend"||u==="audioSend"?(n+=_,c+=E):(a+=_,l+=E),Number.isNaN(_)||Number.isNaN(_)?h.packetLostRate=0:h.packetLostRate=_<=0||E<=0?0:E/(_+E)});e.sendPacketLossRate=n<=0||c<=0?0:c/(n+c),e.recvPacketLossRate=a<=0||l<=0?0:l/(a+l)}}function _N(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function yG(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?_N(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):_N(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class CG extends cS{constructor(){super(...arguments),g(this,"_stats",Gd),g(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){let e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=Pn(Gd);let r=t.filter(a=>a.type==="ssrc");this.processSSRCStats(r);let n=t.find(a=>a.type==="VideoBwe");n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach(t=>{var r;let n=ge(r=t.id).call(r,"send");switch("".concat(t.mediaType,"_").concat(n?"send":"recv")){case"video_send":{let a=Pn(dN);a.codec=t.googCodecName,a.adaptionChangeReason="none",t.googCpuLimitedResolution&&(a.adaptionChangeReason="cpu"),t.googBandwidthLimitedResolution&&(a.adaptionChangeReason="bandwidth"),a.avgEncodeMs=Number(t.googAvgEncodeMs),a.inputFrame={width:Number(t.googFrameWidthInput)||Number(t.googFrameWidthSent),height:Number(t.googFrameHeightInput)||Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},a.sentFrame={width:Number(t.googFrameWidthSent),height:Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},a.firsCount=Number(t.googFirReceived),a.nacksCount=Number(t.googNacksReceived),a.plisCount=Number(t.googPlisReceived),a.frameCount=Number(t.framesEncoded),a.bytes=Number(t.bytesSent),a.packets=Number(t.packetsSent),a.packetsLost=Number(t.packetsLost),a.ssrc=Number(t.ssrc),a.rttMs=Number(t.googRtt||0),this._stats.videoSend.push(a),this._stats.rtt=a.rttMs;break}case"video_recv":{let a=Pn(lN),c=this.lastDecodeVideoReceiverStats.get(Number(t.ssrc));if(a.codec=t.googCodecName,a.targetDelayMs=Number(t.googTargetDelayMs),a.renderDelayMs=Number(t.googRenderDelayMs),a.currentDelayMs=Number(t.googCurrentDelayMs),a.minPlayoutDelayMs=Number(t.googMinPlayoutDelayMs),a.decodeMs=Number(t.googDecodeMs),a.maxDecodeMs=Number(t.googMaxDecodeMs),a.receivedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateReceived)},a.decodedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateDecoded)},a.decodeFrameRate=Number(t.googFrameRateDecoded),a.outputFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateOutput)},a.jitterBufferMs=Number(t.googJitterBufferMs),a.firsCount=Number(t.googFirsSent),a.nacksCount=Number(t.googNacksSent),a.plisCount=Number(t.googPlisSent),a.framesDecodeCount=Number(t.framesDecoded),a.bytes=Number(t.bytesReceived),a.packets=Number(t.packetsReceived),a.packetsLost=Number(t.packetsLost),a.ssrc=Number(t.ssrc),a.packets>0&&!this.isFirstVideoReceived[a.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(a.ssrc),this.isFirstVideoReceived[a.ssrc]=!0),a.framesDecodeCount>0&&!this.isFirstVideoDecoded[a.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(a.ssrc,a.decodedFrame.width,a.decodedFrame.height),this.isFirstVideoDecoded[a.ssrc]=!0),c){let l=c.stats,u=Date.now()-c.lts;a.framesDecodeFreezeTime=l.framesDecodeFreezeTime,a.framesDecodeInterval=l.framesDecodeInterval,a.framesDecodeCount>l.framesDecodeCount&&this.isFirstVideoDecoded[a.ssrc]?(c.lts=Date.now(),a.framesDecodeInterval=u,a.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc,10))?a.framesDecodeFreezeTime+=a.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):a.framesDecodeCount<c.stats.framesDecodeCount&&(a.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(a.ssrc,{stats:yG({},a),lts:Date.now()}),this._stats.videoRecv.push(a);break}case"audio_recv":{let a=Pn(hN);a.codec=t.googCodecName,a.outputLevel=Math.abs(Number(t.audioOutputLevel))/32767,a.decodingCNG=Number(t.googDecodingCNG),a.decodingCTN=Number(t.googDecodingCTN),a.decodingCTSG=Number(t.googDecodingCTSG),a.decodingNormal=Number(t.googDecodingNormal),a.decodingPLC=Number(t.googDecodingPLC),a.decodingPLCCNG=Number(t.googDecodingPLCCNG),a.expandRate=Number(t.googExpandRate),a.accelerateRate=Number(t.googAccelerateRate),a.preemptiveExpandRate=Number(t.googPreemptiveExpandRate),a.secondaryDecodedRate=Number(t.googSecondaryDecodedRate),a.speechExpandRate=Number(t.googSpeechExpandRate),a.preferredJitterBufferMs=Number(t.googPreferredJitterBufferMs),a.jitterBufferMs=Number(t.googJitterBufferMs),a.jitterMs=Number(t.googJitterReceived),a.bytes=Number(t.bytesReceived),a.packets=Number(t.packetsReceived),a.packetsLost=Number(t.packetsLost),a.ssrc=Number(t.ssrc),a.receivedFrames=Number(t.googDecodingCTN)||Number(t.packetsReceived),a.droppedFrames=Number(t.googDecodingPLC)+Number(t.googDecodingPLCCNG)||Number(t.packetsLost),a.receivedFrames>0&&!this.isFirstAudioReceived[a.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(a.ssrc),this.isFirstAudioReceived[a.ssrc]=!0),a.decodingNormal>0&&!this.isFirstAudioDecoded[a.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(a.ssrc),this.isFirstAudioDecoded[a.ssrc]=!0),this._stats.audioRecv.push(a);break}case"audio_send":{let a=Pn(uN);a.codec=t.googCodecName,a.inputLevel=Math.abs(Number(t.audioInputLevel))/32767,a.aecReturnLoss=Number(t.googEchoCancellationReturnLoss||0),a.aecReturnLossEnhancement=Number(t.googEchoCancellationReturnLossEnhancement||0),a.residualEchoLikelihood=Number(t.googResidualEchoLikelihood||0),a.residualEchoLikelihoodRecentMax=Number(t.googResidualEchoLikelihoodRecentMax||0),a.bytes=Number(t.bytesSent),a.packets=Number(t.packetsSent),a.packetsLost=Number(t.packetsLost),a.ssrc=Number(t.ssrc),a.rttMs=Number(t.googRtt||0),this._stats.rtt=a.rttMs,this._stats.audioSend.push(a);break}}})}_getStats(){return new F((e,t)=>{this.pc.getStats(e,t)})}statsResponsesToObjects(e){let t=[];return e.result().forEach(r=>{let n={id:r.id,timestamp:r.timestamp.valueOf().toString(),type:r.type};r.names().forEach(a=>{n[a]=r.stat(a)}),t.push(n)}),t}}function mN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function jo(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?mN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):mN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class EN extends cS{constructor(){super(...arguments),g(this,"_stats",Gd),g(this,"report",void 0),g(this,"lastDecodeVideoReceiverStats",new Map),g(this,"lastVideoFramesRecv",new Map),g(this,"lastVideoFramesSent",new Map),g(this,"lastVideoFramesDecode",new Map),g(this,"lastVideoJBDelay",new Map),g(this,"lastAudioJBDelay",new Map),g(this,"mediaBytesSent",new Map),g(this,"mediaBytesRetransmit",new Map),g(this,"mediaBytesTargetEncode",new Map),g(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=Pn(Gd),this.report.forEach(e=>{switch(e.type){case dr.OUTBOUND:case dr.INBOUND:{let t=e.mediaType||e.kind,r=!t&&"frameWidth"in e,n=!t&&!("frameWidth"in e);e.type===dr.OUTBOUND?t==="audio"||n?this.processAudioOutboundStats(e):(t==="video"||r)&&this.processVideoOutboundStats(e):e.type===dr.INBOUND&&(t==="audio"||n?this.processAudioInboundStats(e):(t==="video"||r)&&this.processVideoInboundStats(e));break}case dr.TRANSPORT:{let t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case dr.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){let e=await this.pc.getStats(),t={local:jo({},Ts),remote:jo({},Ts)};return e.forEach(r=>{let n;if(r.type===dr.TRANSPORT&&(n=e.get(r.selectedCandidatePairId)),r.type===dr.CANDIDATE_PAIR&&r.selected&&(n=r),n){let a=(c,l)=>{c.type=l.type,c.id=l.id,l.address&&(c.address=l.address),l.candidateType&&(c.candidateType=l.candidateType),l.port&&(c.port=l.port),l.priority&&(c.priority=l.priority),l.protocol&&(c.protocol=l.protocol),l.relayProtocol&&(c.relayProtocol=l.relayProtocol)};if(n.localCandidateId){let c=e.get(n.localCandidateId);c&&a(t.local,c)}if(n.remoteCandidateId){let c=e.get(n.remoteCandidateId);c&&a(t.remote,c)}}}),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)}),this._stats.audioSend.forEach(t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){let t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){let t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===dr.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===dr.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===dr.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(jo({},t),jo({},this.stats.selectedCandidatePair.localCandidate)),e.type===dr.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(jo({},t),jo({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find(r=>r.ssrc===e.ssrc);t||(t=Pn(hN),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),typeof e.concealedSamples=="number"&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find(c=>c.ssrc===e.ssrc);t||(t=Pn(lN),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;let r=this.lastDecodeVideoReceiverStats.get(t.ssrc),n=this.lastVideoFramesDecode.get(t.ssrc),a=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){let c=t.decodedFrame?t.decodedFrame.width:0,l=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,c,l),this.isFirstVideoDecoded[t.ssrc]=!0}if(r){let c=r.stats,l=a-r.lts;t.framesDecodeFreezeTime=c.framesDecodeFreezeTime,t.framesDecodeInterval=c.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&l>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>c.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(r.lts=Date.now(),t.framesDecodeInterval=l,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<c.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(r.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-r.qpSum)/(e.framesDecoded-r.stats.framesDecodeCount))}n&&a-n.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-n.count)/((a-n.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:a,rate:t.decodeFrameRate})):n?t.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:a,rate:0}),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:jo({},t),lts:r?r.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find(n=>n.ssrc===e.ssrc);t||(t=Pn(dN),this._stats.videoSend.push(t));let r=this.mediaBytesSent.get(e.ssrc);if(r)r.add(e.bytesSent);else{let n=new oS(10);n.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,n)}if(e.retransmittedBytesSent!==void 0){let n=this.mediaBytesRetransmit.get(e.ssrc);if(n)n.add(e.retransmittedBytesSent);else{let a=new oS(10);a.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,a)}}if(e.totalEncodedBytesTarget){let n=this.mediaBytesTargetEncode.get(e.ssrc);if(n)n.add(e.totalEncodedBytesTarget);else{let a=new oS(10);a.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,a)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){let n=this.lastEncoderMs.get(e.ssrc);if(!n||n.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{let a=e.framesEncoded-n.lastFrameCount,c=e.totalEncodeTime-n.lastEncoderTime;t.avgEncodeMs=1e3*c/a}}if(e.framesEncoded&&e.qpSum){let n=this.lastEncoderMs.get(e.ssrc);!n||n.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-n.lastQpSum)/(e.framesEncoded-n.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{let n=this.findRemoteStatsId(e.ssrc,dr.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find(r=>r.ssrc===e.ssrc);if(t||(t=Pn(uN),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{let r=this.findRemoteStatsId(e.ssrc,dr.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,t)}}findRemoteStatsId(e,t){var r;let n=Array.from(us(r=this.report).call(r)).find(a=>a.type===t&&a.ssrc===e);return n?n.id:null}processVideoMediaSource(e,t){let r=this.report.get(e);r&&r.width&&r.height&&r.framesPerSecond&&(t.inputFrame={width:r.width,height:r.height,frameRate:r.framesPerSecond})}processAudioMediaSource(e,t){let r=this.report.get(e);r&&(t.inputLevel=r.audioLevel)}processVideoTrackSenderStats(e,t,r){var n,a,c,l;let u=t?this.report.get(t):void 0,h=(n=u==null?void 0:u.framesSent)!==null&&n!==void 0?n:e.framesSent;if(typeof h!="number")return;let p=(a=u==null?void 0:u.frameWidth)!==null&&a!==void 0?a:e.frameWidth,_=(c=u==null?void 0:u.frameHeight)!==null&&c!==void 0?c:e.frameHeight,E=(l=u==null?void 0:u.framesPerSecond)!==null&&l!==void 0?l:e.framesPerSecond;if(typeof p=="number"&&typeof _=="number"||(p=0,_=0),E==null){let T=Date.now(),w=this.lastVideoFramesSent.get(r.ssrc);w&&T-w.lts>=800?(E=Math.round((h-w.count)/((T-w.lts)/1e3)),this.lastVideoFramesSent.set(r.ssrc,{count:h,lts:T,rate:E})):w?E=w.rate:this.lastVideoFramesSent.set(r.ssrc,{count:h,lts:T,rate:0})}r.sentFrame={width:p,height:_,frameRate:Math.max(0,E)}}processVideoTrackReceiverStats(e,t,r){var n,a,c,l,u;let h=t?this.report.get(t):void 0,p=(n=h==null?void 0:h.framesReceived)!==null&&n!==void 0?n:e.framesReceived,_=(a=h==null?void 0:h.frameWidth)!==null&&a!==void 0?a:e.frameWidth,E=(c=h==null?void 0:h.frameHeight)!==null&&c!==void 0?c:e.frameHeight,T=(l=h==null?void 0:h.jitterBufferDelay)!==null&&l!==void 0?l:e.jitterBufferDelay,w=(u=h==null?void 0:h.jitterBufferEmittedCount)!==null&&u!==void 0?u:e.jitterBufferEmittedCount;if(typeof p=="number"){let C=this.lastVideoFramesRecv.get(r.ssrc),O=Date.now();r.framesReceivedCount=p;let b=0;C&&O-C.lts>=800?(b=Math.round((p-C.count)/((O-C.lts)/1e3)),this.lastVideoFramesRecv.set(r.ssrc,{count:p,lts:O,rate:b})):C?b=C.rate:this.lastVideoFramesRecv.set(r.ssrc,{count:p,lts:O,rate:0}),r.receivedFrame={width:_||0,height:E||0,frameRate:b||0},r.decodedFrame={width:_||0,height:E||0,frameRate:r.decodeFrameRate||0},r.outputFrame={width:_||0,height:E||0,frameRate:r.decodeFrameRate||0}}if(T&&w){let C=this.lastVideoJBDelay.get(r.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},O=C.jitterBufferMs,b=w-C.jitterBufferEmittedCount;b>0&&(O=1e3*(T-C.jitterBufferDelay)/b),r.jitterBufferMs=O,r.currentDelayMs=Math.round(O),this.lastVideoJBDelay.set(r.ssrc,{jitterBufferDelay:T,jitterBufferEmittedCount:w,jitterBufferMs:r.currentDelayMs})}}processAudioTrackSenderStats(e,t,r){var n,a,c,l;let u=t?this.report.get(t):void 0,h=(n=(a=u==null?void 0:u.echoReturnLoss)!==null&&a!==void 0?a:e.echoReturnLoss)!==null&&n!==void 0?n:0,p=(c=(l=u==null?void 0:u.echoReturnLossEnhancement)!==null&&l!==void 0?l:e.echoReturnLossEnhancement)!==null&&c!==void 0?c:0;r.aecReturnLoss=h,r.aecReturnLossEnhancement=p}processAudioTrackReceiverStats(e,t,r){var n,a,c,l,u,h,p;let _=t?this.report.get(t):void 0,E=(n=_==null?void 0:_.removedSamplesForAcceleration)!==null&&n!==void 0?n:e.removedSamplesForAcceleration,T=(a=_==null?void 0:_.totalSamplesReceived)!==null&&a!==void 0?a:e.totalSamplesReceived,w=(c=_==null?void 0:_.jitterBufferDelay)!==null&&c!==void 0?c:e.jitterBufferDelay,C=(l=_==null?void 0:_.jitterBufferEmittedCount)!==null&&l!==void 0?l:e.jitterBufferEmittedCount,O=(u=_==null?void 0:_.audioLevel)!==null&&u!==void 0?u:e==null?void 0:e.audioLevel,b=(h=_==null?void 0:_.totalSamplesDuration)!==null&&h!==void 0?h:e==null?void 0:e.totalSamplesDuration,k=(p=_==null?void 0:_.concealedSamples)!==null&&p!==void 0?p:e.concealedSamples;if(E&&T&&(r.accelerateRate=E/T),w&&C){let X=this.lastAudioJBDelay.get(r.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},z=X.jitterBufferMs,j=C-X.jitterBufferEmittedCount;j>0&&(z=1e3*(w-X.jitterBufferDelay)/j),r.jitterBufferMs=Math.round(z),this.lastAudioJBDelay.set(r.ssrc,{jitterBufferDelay:w,jitterBufferEmittedCount:C,jitterBufferMs:r.jitterBufferMs})}r.outputLevel=O;let U=1920;b&&T&&(U=T/b/50,r.receivedFrames=Math.round(T/U)),k&&(r.droppedFrames=Math.round(k/U))}processRemoteInboundStats(e,t){let r=this.report.get(e);r&&(t.packetsLost=r.packetsLost,r.roundTripTime&&(t.rttMs=1e3*r.roundTripTime),r.jitter&&(t.jitterMs=1e3*r.jitter),r.timestamp&&(t.timestamp=r.timestamp))}getCodecFromCodecStats(e){let t=this.report.get(e);if(!t)return"";let r=t.mimeType.match(/\/(.*)$/);return r&&r[1]?r[1]:""}updateSendBitrate(){let e=0,t=null,r=null;this.mediaBytesSent.forEach(a=>{e+=a.diffMean()}),this.mediaBytesRetransmit.forEach(a=>{t=t===null?a.diffMean():t+a.diffMean()}),this.mediaBytesTargetEncode.forEach(a=>{r=r===null?a.diffMean():r+a.diffMean()});let n=t!==null?e-t:e;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},t!==null&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),r!==null&&(this._stats.bitrate.targetEncoded=8*r/(this.options.updateInterval/1e3))}}class RG extends cS{updateStats(){return F.resolve()}}function Gp(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,n=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4,a=function(){let c=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return c&&c[0]?Number(c[0].split("/")[1]):null}();return a?a<76?new CG(i,{updateInterval:e,lossRateInterval:t,freezeRateLimit:r,firstVideoDecodedTimeout:n}):new EN(i,{updateInterval:e,lossRateInterval:t,freezeRateLimit:r,firstVideoDecodedTimeout:n}):function(c){return!!window.RTCStatsReport&&c.getStats()instanceof F}(i)?new EN(i,{updateInterval:e,lossRateInterval:t,freezeRateLimit:r,firstVideoDecodedTimeout:n}):new RG(i,{updateInterval:e,lossRateInterval:t,freezeRateLimit:r,firstVideoDecodedTimeout:n})}function gN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function SN(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?gN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):gN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class li extends tp{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}constructor(e,t){super(e,t),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"statsFilter",void 0),g(this,"useRTX",!1),g(this,"localCapabilities",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"establishPromise",void 0),g(this,"mutex",new si("P2PConnection-mutex")),this.store=t,this.peerConnection=new RTCPeerConnection(li.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Gp(this.peerConnection,P("STATS_UPDATE_INTERVAL"),void 0,ht()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{let e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let t=Vo(e.sdp),r=rS(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:P("FILTER_VIDEO_FEC"),filterAudioFec:P("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=r,this.initialOffer=e,SN(SN({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:r},offerSDP:e.sdp})}catch(e){throw new Y(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,r,n,a,c){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(u){g(this,"sessionDesc",void 0),g(this,"localCapabilities",void 0),g(this,"rtpCapabilities",void 0),g(this,"candidates",void 0),g(this,"iceParameters",void 0),g(this,"dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),u=Ut(u);let{remoteIceParameters:h,remoteDtlsParameters:p,candidates:_,remoteRTPCapabilities:E,remoteSetup:T,localCapabilities:w,sdkCodec:C,cname:O}=u,b=At.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=E,this.candidates=_,this.iceParameters=h,this.dtlsParameters=p,this.setup=T,this.localCapabilities=w,this.cname=O;for(let k=0;k<b.mediaDescriptions.length;k++){let U=b.mediaDescriptions[k];if(U.attributes.iceUfrag=h.iceUfrag,U.attributes.icePwd=h.icePwd,U.attributes.fingerprints=p.fingerprints,U.attributes.candidates=_,U.attributes.setup=T,U.media.mediaType==="video"){U.media.fmts=E.videoCodecs.map(z=>z.payloadType.toString(10));let X=E.videoCodecs.filter(z=>{var j,B;return(j=z.rtpMap)===null||j===void 0?void 0:ge(B=j.encodingName.toLowerCase()).call(B,C)});X.length===0&&(X=E.videoCodecs),U.attributes.payloads=X,U.attributes.extmaps=E.videoExtensions}U.media.mediaType==="audio"&&(U.media.fmts=E.audioCodecs.map(X=>X.payloadType.toString(10)),U.attributes.payloads=E.audioCodecs,U.attributes.extmaps=E.audioExtensions),b.mediaDescriptions[k]=this.mungMediaDesc(U)}this.sessionDesc=b,this.currentMidIndex=b.mediaDescriptions.length-1}toString(){return At.print(this.sessionDesc)}send(u,h,p){let{ssrcs:_,ssrcGroups:E}=un(h,this.cname),T=this.sessionDesc.mediaDescriptions.find(O=>u===fe.VIDEO?O.media.mediaType==="video":O.media.mediaType==="audio"),w=_[0].attributes.label,C=_[0].attributes.mslabel;return T.attributes.ssrcs=T.attributes.ssrcs.concat(_),T.attributes.ssrcGroups=T.attributes.ssrcGroups.concat(E),{id:w,mslabel:C}}batchSend(u){return u.map(h=>{let{kind:p,ssrcMsg:_}=h;return this.send(p,_,void 0)})}stopSending(u){this.sessionDesc.mediaDescriptions.forEach(h=>{let p=[],_=[],E=[];h.attributes.ssrcs.forEach(T=>{ge(u).call(u,T.attributes.label||"")?E.push(T):p.push(T)}),h.attributes.ssrcGroups.forEach(T=>{var w;ge(w=E.map(C=>C.ssrcId)).call(w,T.ssrcIds[0])||_.push(T)}),h.attributes.ssrcs=p,h.attributes.ssrcGroups=_})}mute(u){let h=this.sessionDesc.mediaDescriptions.find(p=>p.attributes.mid===u);if(!h)throw new Error("mediaDescription not found with ".concat(u," in remote SDP when calling RemoteSDP.mute."));h.attributes.direction="inactive"}unmute(u){let h=this.sessionDesc.mediaDescriptions.find(p=>p.attributes.mid===u);if(!h)throw new Error("mediaDescription not found with ".concat(u," in remote SDP when calling RemoteSDP.unmute."));h.attributes.direction="sendonly"}receive(u,h,p){u.forEach((_,E)=>{let T=_._mediaStreamTrack,w=this.sessionDesc.mediaDescriptions.findIndex(O=>O.attributes.mid===T.kind),C=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[w],_);this.sessionDesc.mediaDescriptions[w]=C})}stopReceiving(u){}updateCandidates(u){u===Ci.TCP?this.candidates.forEach(h=>{this.candidates.findIndex(p=>p.transport==="tcp"&&p.connectionAddress===h.connectionAddress&&p.port===h.port)===-1&&this.candidates.push(oN(oN({},h),{},{foundation:"tcpcandidate",priority:Number(h.priority)-1+"",transport:"tcp",port:Number(h.port)+90+""}))}):this.candidates=this.candidates.filter(h=>h.transport!=="tcp");for(let h of this.sessionDesc.mediaDescriptions)h.attributes.candidates=this.candidates}restartICE(u){u=Ut(u),this.iceParameters=u,this.sessionDesc.mediaDescriptions.forEach(h=>{h.attributes.iceUfrag=u.iceUfrag,h.attributes.icePwd=u.icePwd})}predictReceivingMids(u){let h=[];for(let p=0;p<u;p++)h.push((this.currentMidIndex+p+1).toString(10));return h}mungRecvMediaDsec(u,h){let p=Ut(u);return Fo(p,h),sS(p,h),p}updateRecvMedia(u,h){let p=this.sessionDesc.mediaDescriptions.findIndex(_=>_.attributes.mid===u);if(p!==-1){let _=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[p],h);this.sessionDesc.mediaDescriptions[p]=_}}bumpMid(u){this.currentMidIndex+=u}updateTrackLabel(u,h,p){let _=this.sessionDesc.mediaDescriptions.find(T=>u===fe.VIDEO?T.attributes.mid==="video":T.attributes.mid==="audio");if(_){let T=_.attributes.ssrcs.find(w=>w.attributes.label===h);var E;T&&(T.attributes.label=p,(E=T.attributes.msid)===null||E===void 0||E.replace(h,p))}}mungMediaDesc(u){let h=Ut(u);return nS(h),function(p){let _=p.attributes.extmaps.find(E=>E.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");_&&p.attributes.extmaps.splice(p.attributes.extmaps.indexOf(_),1),p.attributes.payloads.forEach(E=>{let T=E.rtcpFeedbacks.findIndex(w=>w.type==="transport-cc");T!==-1&&E.rtcpFeedbacks.splice(T,1)})}(h),h}getSSRC(u){for(let h of this.sessionDesc.mediaDescriptions)for(let p of h.attributes.ssrcs)if(p.attributes.label===u)return[p]}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:r,remoteRTPCapabilities:n.send,remoteSetup:a,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:c});let l=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(l){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(l.toString()))}}async updateRemoteRTPCapabilities(e,t){throw new Y(A.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,t){var r=this;return dn(function*(){let n=yield Ye(r.mutex.lock());try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let a=e.map(E=>r.peerConnection.addTrack(E._mediaStreamTrack)),c=yield Ye(r.peerConnection.createOffer()),l=At.parse(c.sdp),u=e.map(E=>{let T=E._mediaStreamTrack,w=l.mediaDescriptions.find(C=>C.attributes.mid===T.kind);if(!w)throw new Error("Cannot extract ssrc from mediaDescription.");return function(C,O,b){let k=C.attributes.ssrcs.filter(X=>X.attributes.label===O),U=C.attributes.ssrcGroups;if(k.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(U&&k.length>1){let X=U.find(z=>z.ssrcIds.indexOf(k[0].ssrcId)!==-1);return X?[{ssrcId:X.ssrcIds[0],rtx:b?X.ssrcIds[1]:void 0}]:[{ssrcId:k[0].ssrcId}]}return[{ssrcId:k[0].ssrcId}]}(w,T.id,r.useRTX)}),h;try{h=yield u}catch(E){throw a.forEach(T=>{Vi()&&T.replaceTrack(null),r.peerConnection.removeTrack(T)}),E}let p=r.mungSendOfferSDP(c.sdp,e);r.remoteSDP.receive(e,t,h);let _=r.remoteSDP.toString();return yield Ye(r.peerConnection.setLocalDescription({type:"offer",sdp:p})),yield Ye(r.applySendEncodings(a,e)),yield Ye(r.peerConnection.setRemoteDescription({type:"answer",sdp:_})),e.map((E,T)=>{let w=E._mediaStreamTrack.id;return{localSSRC:u[T],id:w}})}catch(a){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(a.toString()))}finally{n()}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let t=this.peerConnection.getSenders().filter(a=>{var c;return e.indexOf(((c=a.track)===null||c===void 0?void 0:c.id)||"")!==-1});if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map(a=>{Vi()&&a.replaceTrack(null),this.peerConnection.removeTrack(a)});let r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r),this.remoteSDP.stopReceiving(e);let n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(t.toString()))}}async receive(e,t,r,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{id:a,mslabel:c}=this.remoteSDP.send(e,t,n),l=new F((p,_)=>{let E=setTimeout(()=>{_(new Error("Cannot receive track, id: ".concat(a)))},1e4),T=w=>{let C=ze();if((C.name==="Safari"&&Number(C.version)===11||Fi())&&w.track.id!==a&&w.streams[0].id===c){var O;let b=w.streams[0].getTracks()[0];return(O=this.remoteSDP)===null||O===void 0||O.updateTrackLabel(e,a,w.track.id),this.peerConnection.removeEventListener("track",T),clearTimeout(E),void p(b)}if(w.track.id===a)return this.peerConnection.removeEventListener("track",T),clearTimeout(E),void p(w.track)};this.peerConnection.addEventListener("track",T)}),u=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:u});let h=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(h),{track:await l,id:a}}catch(a){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(a.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r)}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let t=this.peerConnection.getSenders().filter(r=>{var n;return e.indexOf(((n=r.track)===null||n===void 0?void 0:n.id)||"")!==-1});if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map(r=>{if(Vi()&&r.track)r.track.enabled=!1;else{let n=r.getParameters();n.encodings.forEach(a=>a.active=!1),r.setParameters(n)}})}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let t=this.peerConnection.getSenders().filter(a=>{var c;return e.indexOf(((c=a.track)===null||c===void 0?void 0:c.id)||"")!==-1});if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map(async a=>{if(Vi()&&a.track)a.track.enabled=!0;else{let c=a.getParameters();c.encodings.forEach(l=>l.active=!0),await a.setParameters(c)}});let r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r);let n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(e){var t=this;return dn(function*(){let r=yield Ye(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(ct().supportPCSetConfiguration){let u=t.peerConnection.getConfiguration(),h=e===Ci.RELAY?"relay":"all";u.iceTransportPolicy!==h&&(S.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(u.iceTransportPolicy,"] to [").concat(h,"]")),u.iceTransportPolicy=h,t.peerConnection.setConfiguration(u))}else if(e===Ci.RELAY)return;e!==Ci.RELAY&&t.remoteSDP.updateCandidates(e);let n=yield Ye(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let a=Vo(n.sdp),{remoteIceParameters:c}=yield a.iceParameters;t.remoteSDP.restartICE(c);let l=t.remoteSDP.toString();yield Ye(t.peerConnection.setLocalDescription(n)),yield Ye(t.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(n){S.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),n)}finally{r()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let r=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(r.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);let a=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new Y(A.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(e,t){let r=this.peerConnection.getSenders().filter(n=>{var a;return((a=n.track)===null||a===void 0?void 0:a.id)===e});r.length===1&&await this.applySendEncodings(r,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){let r=this.peerConnection.getSenders().find(n=>{var a;return((a=n.track)===null||a===void 0?void 0:a.id)===t});r&&await r.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new Y(A.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new Y(A.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},P("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let t={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Lc(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...li.turnServerConfigToIceServers(e.turnServer.servers)),P("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...li.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(t.iceTransportPolicy="relay")}))),t}static turnServerConfigToIceServers(e){let t=[];return e.forEach(r=>{r.security?r.tcpport&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),t}async updateRtpSenderEncodings(e,t){var r;if(t||(t=this.peerConnection.getSenders().find(h=>{var p;return((p=h.track)===null||p===void 0?void 0:p.id)===e._mediaStreamTrack.id})),!t)return S.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!ct().supportSetRtpSenderParameters)return S.warn("Browser not support set rtp-sender parameters");let n={},a={};if(e instanceof ke)switch(e._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(P("DSCP_TYPE")&&la()){var c;let h=P("DSCP_TYPE");ge(c=["very-low","low","medium","high"]).call(c,h)&&(a.networkPriority=h)}let l=t.getParameters(),u=(r=l.encodings)===null||r===void 0?void 0:r[0];u&&Object.assign(u,a),Object.assign(l,n),S.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(l.encodings))),await t.setParameters(l)}async applySendEncodings(e,t){try{if(!ct().supportSetRtpSenderParameters||e.length!==t.length)return;for(let r=0;r<e.length;r++){let n=e[r],a=t[r];n&&a&&await this.updateRtpSenderEncodings(a,n)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){let r=At.parse(e);return t.forEach((n,a)=>{let c=n._mediaStreamTrack,l=r.mediaDescriptions.find(u=>u.attributes.mid===c.kind);l&&Fo(l,n)}),At.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;(t=this.onFirstAudioReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;(t=this.onFirstVideoReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;(t=this.onFirstAudioDecoded)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,r)=>{var n;(n=this.onFirstVideoDecoded)===null||n===void 0||n.call(this,e,t,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let t=this.remoteSDP.batchSend(e).map((a,c)=>{let{id:l,mslabel:u}=a,{kind:h}=e[c];return new F((p,_)=>{let E=setTimeout(()=>{_(new Error("Cannot receive track, id: ".concat(l)))},1e4),T=w=>{let C=ze();if(C.name==="Safari"&&Number(C.version)===11&&w.track.id!==l&&w.streams[0].id===u){var O;let b=w.streams[0].getTracks()[0];return(O=this.remoteSDP)===null||O===void 0||O.updateTrackLabel(h,l,w.track.id),this.peerConnection.removeEventListener("track",T),clearTimeout(E),void p({track:b,id:l})}if(w.track.id===l)return this.peerConnection.removeEventListener("track",T),clearTimeout(E),void p({track:w.track,id:l})};this.peerConnection.addEventListener("track",T)})}),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});let n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await F.all(t)}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;let t=this.remoteSDP.getSSRC(e);return t==null?void 0:t[0].ssrcId}setConfiguration(e){if(ct().supportPCSetConfiguration){let t=li.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function hn(i,e,t){let r=i[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let n=this.mutex,a=await n.lock("Locking from P2PConnection.".concat(e));try{for(var c=arguments.length,l=new Array(c),u=0;u<c;u++)l[u]=arguments[u];return await r.apply(this,l)}finally{a()}},t}function TN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Aa(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?TN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):TN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}J([hn,R("design:type",Function),R("design:paramtypes",[Object,Object,Array,Object,String,String]),R("design:returntype",F)],li.prototype,"connect",null),J([hn,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],li.prototype,"stopSending",null),J([hn,R("design:type",Function),R("design:paramtypes",[String,Array,String,Object]),R("design:returntype",F)],li.prototype,"receive",null),J([hn,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],li.prototype,"stopReceiving",null),J([hn,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],li.prototype,"muteRemote",null),J([hn,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],li.prototype,"unmuteRemote",null),J([hn,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],li.prototype,"muteLocal",null),J([hn,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],li.prototype,"unmuteLocal",null),J([hn,R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],li.prototype,"close",null),J([hn,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],li.prototype,"updateEncoderConfig",null),J([hn,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],li.prototype,"updateSendParameters",null),J([hn,R("design:type",Function),R("design:paramtypes",[Ri,String]),R("design:returntype",F)],li.prototype,"replaceTrack",null),J([hn,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],li.prototype,"getRemoteSSRC",null);let Wd="9",vN=4e4;function yN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function sl(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?yN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):yN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}let zt=class au extends tp{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return(e=(t=this.peerConnection.getReceivers()[0])===null||t===void 0||(t=t.transport)===null||t===void 0?void 0:t.state)!==null&&e!==void 0?e:null}constructor(e,t){super(e,t),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"transportEventReceiver",void 0),g(this,"statsFilter",void 0),g(this,"useXR",P("USE_XR")),g(this,"localCapabilities",void 0),g(this,"remoteCodecs",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"dataStreamChannelMap",new Map),g(this,"establishPromise",void 0),g(this,"mutex",new si("P2PConnection-mutex")),this.store=t,this.peerConnection=new RTCPeerConnection(au.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Gp(this.peerConnection,P("STATS_UPDATE_INTERVAL"),void 0,ht()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(e,t){this.remoteCodecs=t;let r=[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(n=>n.rtpMap&&n.rtpMap.encodingName.toLowerCase()||"").filter(n=>{var a;return ge(a=Object.keys(Ro)).call(a,n)}))];if(Ee.updateRemoteRTPCapabilities(this.store.sessionId,{mids:e,localCodecs:r,remoteCodecs:this.remoteCodecs}),!this.remoteSDP)return void S.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(r,", codecs: ").concat(t));if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){let n=await this.peerConnection.createOffer(),a=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n);let c=this.remoteSDP.toString();a==null||a(c),await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}else S.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let t=Vo(e.sdp),r=await sN({filterRTX:!P("USE_PUB_RTX")&&!P("USE_SUB_RTX"),filterVideoFec:P("FILTER_VIDEO_FEC"),filterAudioFec:P("FILTER_AUDIO_FEC"),filterVideoCodec:P("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=Fp(r),this.initialOffer=e,sl(sl({},t),{},{rtpCapabilities:r,offerSDP:e.sdp})}catch(e){throw new Y(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,r,n,a,c){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return Ut(this._localCapabilities)}get rtpCapabilities(){return Ut(this._rtpCapabilities)}get candidates(){return Ut(this._candidates)}get iceParameters(){return Ut(this._iceParameters)}get dtlsParameters(){return Ut(this._dtlsParameters)}constructor(T){g(this,"sessionDesc",void 0),g(this,"_localCapabilities",void 0),g(this,"_rtpCapabilities",void 0),g(this,"_candidates",void 0),g(this,"_iceParameters",void 0),g(this,"_dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),g(this,"firefoxSsrcMidMap",new Map),T=Ut(T);let{remoteIceParameters:w,remoteDtlsParameters:C,candidates:O,remoteRTPCapabilities:b,remoteSetup:k,localCapabilities:U,cname:X}=T,z=At.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=b,this._candidates=O,this._iceParameters=w,this._dtlsParameters=C,this._localCapabilities=U,this.setup=k,this.cname=X;let j=this.rtpCapabilities.send;for(let B of z.mediaDescriptions){if(B.attributes.iceUfrag=w.iceUfrag,B.attributes.icePwd=w.icePwd,B.attributes.fingerprints=C.fingerprints,B.attributes.candidates=O,B.attributes.setup=k,B.media.mediaType==="video"&&(B.media.fmts=j.videoCodecs.map(W=>W.payloadType.toString(10)),B.attributes.payloads=j.videoCodecs,B.attributes.extmaps=j.videoExtensions,P("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:W,ssrcGroups:ce}=un([{ssrcId:vN,rtx:P("USE_SUB_RTX")?40001:void 0}],this.cname);B.attributes.ssrcs=W,B.attributes.ssrcGroups=ce}if(B.media.mediaType==="audio"&&(B.media.fmts=j.audioCodecs.map(W=>W.payloadType.toString(10)),B.attributes.payloads=j.audioCodecs,B.attributes.extmaps=j.audioExtensions,wa(B),P("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:W,ssrcGroups:ce}=un([{ssrcId:2e4}],this.cname);B.attributes.ssrcs=W,B.attributes.ssrcGroups=ce}}this.sessionDesc=z,this.currentMidIndex=z.mediaDescriptions.length-1}preloadRemoteMedia(){let T=P("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;let w=this.candidates,C=this.dtlsParameters,O=this.iceParameters,b=this.rtpCapabilities.send;for(let k=1;k<T;k++){let U=2*k+2e4,X=2*k+vN,{ssrcs:z,ssrcGroups:j}=un([{ssrcId:U}],this.cname),{ssrcs:B,ssrcGroups:W}=un([{ssrcId:X,rtx:P("USE_SUB_RTX")?X+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Wd,protos:["UDP","TLS","RTP","SAVPF"],fmts:b.videoCodecs.map(ce=>ce.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:O.iceUfrag,icePwd:O.icePwd,unrecognized:[],candidates:w,extmaps:b.videoExtensions,fingerprints:C.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:B,ssrcGroups:W,rtcpFeedbackWildcards:[],payloads:b.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*k)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Wd,protos:["UDP","TLS","RTP","SAVPF"],fmts:b.audioCodecs.map(ce=>ce.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:O.iceUfrag,icePwd:O.icePwd,unrecognized:[],candidates:w,extmaps:b.audioExtensions,fingerprints:C.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:z,ssrcGroups:j,rtcpFeedbackWildcards:[],payloads:b.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*k+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return At.print(this.sessionDesc)}send(T,w,C,O){let{ssrcs:b,ssrcGroups:k}=un(w,this.cname,P("SYNC_GROUP")?C:void 0),U=this.findPreloadMediaDesc(b);if(U){if(ht()&&this.firefoxSsrcMidMap.set(b[0].ssrcId,U.attributes.mid),O&&(O.twcc||O.remb)){let X=this.sessionDesc.mediaDescriptions.indexOf(U);return this.sessionDesc.mediaDescriptions[X]=this.mungSendMediaDesc(U,O),{mid:U.attributes.mid,needExchangeSDP:!0}}return{mid:U.attributes.mid,needExchangeSDP:!1}}{let X=this.findAvailableMediaIndex(T,b),z;return X===-1||X===1&&(Vi()||dw())||X===0&&P("USE_SUB_RTX")||uw()?(z=this.createOrRecycleSendMedia(T,b,k,"sendonly",O),this.updateBundleMids()):(z=Ut(this.sessionDesc.mediaDescriptions[X]),z.attributes.direction="sendonly",z.attributes.ssrcs=b,z.attributes.ssrcGroups=k,this.sessionDesc.mediaDescriptions[X]=this.mungSendMediaDesc(z,O)),ht()&&this.firefoxSsrcMidMap.set(b[0].ssrcId,z.attributes.mid),{mid:z.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){let{mediaDesc:T,needExchangeSDP:w}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:T.attributes.mid,needExchangeSDP:w}}batchSend(T){let w=T.map(b=>{let{kind:k,ssrcMsg:U,mslabel:X}=b;return this.send(k,U,X)}),C=[],O=!1;return w.forEach(b=>{let{mid:k,needExchangeSDP:U}=b;U&&(O=!0),C.push(k)}),{mids:C,needExchangeSDP:O}}stopSending(T){let w=this.sessionDesc.mediaDescriptions.filter(C=>C.attributes.mid&&T.indexOf(C.attributes.mid)!==-1);if(w.length!==T.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");w.forEach(C=>{C.attributes.mid==="0"||ht()||uw()?C.attributes.ssrcs=[]:(C.attributes.ssrcs=[],C.attributes.direction="inactive",C.media.port="0")}),this.updateBundleMids()}mute(T){let w=this.sessionDesc.mediaDescriptions.find(C=>C.attributes.mid===T);if(!w)throw new Error("mediaDescription not found with ".concat(T," in remote SDP when calling RemoteSDP.mute."));w.attributes.direction="inactive"}unmute(T){let w=this.sessionDesc.mediaDescriptions.find(C=>C.attributes.mid===T);if(!w)throw new Error("mediaDescription not found with ".concat(T," in remote SDP when calling RemoteSDP.unmute."));w.attributes.direction="sendonly"}muteRemote(T){let w=this.sessionDesc.mediaDescriptions.filter(C=>ge(T).call(T,C.attributes.mid||""));if(w.length!==T.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");w.forEach(C=>{C.attributes.direction="inactive"})}unmuteRemote(T){let w=this.sessionDesc.mediaDescriptions.filter(C=>ge(T).call(T,C.attributes.mid||""));if(w.length!==T.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");w.forEach(C=>{C.attributes.direction="recvonly"})}receive(T,w,C,O){T.forEach((b,k)=>{this.createOrRecycleRecvMedia(b,[],"recvonly",w,C,O[k])}),this.updateBundleMids()}stopReceiving(T){let w=this.sessionDesc.mediaDescriptions.filter(C=>T.indexOf(C.attributes.mid)!==-1);if(w.length!==T.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");w.forEach(C=>{C.media.port="0",C.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(T){let w=this._candidates.filter(C=>C.transport==="udp");if(T===Ci.TCP){if(w.length===0)return;if(P("TCP_CANDIDATE_ONLY")){let C=this._candidates.filter(O=>O.transport==="tcp");w.forEach(O=>{C.findIndex(b=>b.connectionAddress===O.connectionAddress)===-1&&C.push(Aa(Aa({},O),{},{foundation:"tcpcandidate",priority:Number(O.priority)-1+"",transport:"tcp",port:Number(O.port)+90+""}))}),this._candidates=C}else{let C=[];w.forEach(O=>{C.push(Aa(Aa({},O),{},{foundation:"tcpcandidate",priority:Number(O.priority)-1+"",transport:"tcp",port:Number(O.port)+90+""}))}),this._candidates=[...w,...C]}}else if(T===Ci.RELAY){if(w.length!==0)return;{let C=this._candidates.filter(O=>O.transport==="tcp");C.forEach(O=>{w.push(Aa(Aa({},O),{},{foundation:"udpcandidate",priority:Number(O.priority)+1+"",transport:"udp",port:Number(O.port)-90+""}))}),this._candidates=[...w,...C]}}else w.length===0?(this._candidates.filter(C=>C.transport==="tcp").forEach(C=>{w.push(Aa(Aa({},C),{},{foundation:"udpcandidate",priority:Number(C.priority)+1+"",transport:"udp",port:Number(C.port)-90+""}))}),this._candidates=w):this._candidates=this._candidates.filter(C=>C.transport!=="tcp");for(let C of this.sessionDesc.mediaDescriptions)C.attributes.candidates=this.candidates}restartICE(T){T=Ut(T),this._iceParameters=T,this.sessionDesc.mediaDescriptions.forEach(w=>{w.attributes.iceUfrag=T.iceUfrag,w.attributes.icePwd=T.icePwd})}predictReceivingMids(T){let w=[];for(let C=0;C<T;C++)w.push((this.currentMidIndex+C+1).toString(10));return w}findAvailableMediaIndex(T,w){return this.sessionDesc.mediaDescriptions.findIndex(C=>{let O=C.media.mediaType===T&&C.media.port!=="0"&&(C.attributes.direction==="sendonly"||C.attributes.direction==="sendrecv")&&C.attributes.ssrcs.length===0;if(ht()){if(O){let b=this.firefoxSsrcMidMap.get(w[0].ssrcId);return!(b||C.attributes.mid!=="0"&&C.attributes.mid!=="1")||!(!b||b!==C.attributes.mid)}return!1}return O})}createOrRecycleDataChannel(){for(let C of this.sessionDesc.mediaDescriptions)if(C.media.mediaType==="application")return{mediaDesc:C,needExchangeSDP:!1};this.currentMidIndex+=1;let T="".concat(this.currentMidIndex),w={media:{mediaType:"application",port:Wd,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(T),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(w),{mediaDesc:w,needExchangeSDP:!0}}createOrRecycleRecvMedia(T,w,C,O,b,k){let U=T._mediaStreamTrack.kind,X=this.rtpCapabilities.recv,z=Bp(U,X,this.localCapabilities.send,U===fe.VIDEO?O:b),j=U===fe.VIDEO?X.videoExtensions:X.audioExtensions;this.currentMidIndex+=1;let B="".concat(this.currentMidIndex),W={media:{mediaType:U,port:Wd,protos:["UDP","TLS","RTP","SAVPF"],fmts:z.map(ne=>ne.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:j,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:w,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:z,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:C,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(B)}};W=this.mungRecvMediaDsec(W,T,k);let ce=this.findFirstClosedMedia(U);if(ce){let ne=this.sessionDesc.mediaDescriptions.indexOf(ce);this.sessionDesc.mediaDescriptions[ne]=W}else this.sessionDesc.mediaDescriptions.push(W);return W}updateRemoteCodec(T,w,C){let O=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(W=>W.rtpMap&&W.rtpMap.encodingName.toLowerCase()||"").filter(W=>{var ce;return ge(ce=Object.keys(Ro)).call(ce,W)}))],b=new Set(w);if(O.every(W=>b.has(W)))return S.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(w)),!1;let k=this._rtpCapabilities.recv.videoCodecs.filter(W=>w.some(ce=>{var ne;return ge(ne=W.rtpMap&&W.rtpMap.encodingName.toLowerCase()||"").call(ne,ce)}));if(k.length===0)return S.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(O," codecs: ").concat(w)),!1;let U=[...new Set(k.map(W=>W.rtpMap&&W.rtpMap.encodingName.toLowerCase()||""))],X;if(S.debug("updateRemoteCodec, from ".concat(O," to ").concat(U)),T.length===0)X=this.sessionDesc.mediaDescriptions.filter(W=>W.media.mediaType==="video"&&W.attributes.direction==="recvonly");else if(X=this.sessionDesc.mediaDescriptions.filter(W=>W.attributes.mid&&ge(T).call(T,W.attributes.mid)&&W.attributes.direction==="recvonly"),X.length!==T.length)return S.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(T,", codecs: ").concat(w)),!1;this._rtpCapabilities.recv.videoCodecs=k;let z=this.localCapabilities.send,j=this.rtpCapabilities.recv,B=Bp(fe.VIDEO,j,z,C);return X.forEach(W=>{let ce=B.map(ne=>ne.payloadType.toString(10));S.debug("updateRemoteCodec mid: ".concat(W.attributes.mid,", from ").concat(W.attributes.payloads," to ").concat(B)),W.attributes.payloads=B,W.media.fmts=ce}),!0}createOrRecycleSendMedia(T,w,C,O,b){let k=this.rtpCapabilities.send,U=T===fe.VIDEO?k.videoCodecs:k.audioCodecs,X=T===fe.VIDEO?k.videoExtensions:k.audioExtensions;this.currentMidIndex+=1;let z="".concat(this.currentMidIndex),j={media:{mediaType:T,port:Wd,protos:["UDP","TLS","RTP","SAVPF"],fmts:U.map(W=>W.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:X,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:w,ssrcGroups:C,rtcpFeedbackWildcards:[],payloads:U,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:O,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(z)}};j=this.mungSendMediaDesc(j,b);let B=this.findFirstClosedMedia(T);if(B){let W=this.sessionDesc.mediaDescriptions.indexOf(B);this.sessionDesc.mediaDescriptions[W]=j}else this.sessionDesc.mediaDescriptions.push(j);return j}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(T=>T.media.port!=="0").map(T=>T.attributes.mid)}mungRecvMediaDsec(T,w,C){let O=Ut(T);return nS(O),Fo(O,w),sS(O,w),nN(O),xp(O,C,this.localCapabilities.send),O}mungSendMediaDesc(T,w){let C=Ut(T);return xp(C,w,this.localCapabilities.recv),wa(C),C}updateRecvMedia(T,w){let C=this.sessionDesc.mediaDescriptions.findIndex(O=>O.attributes.mid===T);if(C!==-1){let O=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[C],w);this.sessionDesc.mediaDescriptions[C]=O}}bumpMid(T){this.currentMidIndex+=T}findFirstClosedMedia(T){return this.sessionDesc.mediaDescriptions.find(w=>ht()?w.media.port==="0"&&w.media.mediaType===T:w.media.port==="0")}findPreloadMediaDesc(T){return this.sessionDesc.mediaDescriptions.find(w=>{var C;return((C=w.attributes)===null||C===void 0||(C=C.ssrcs[0])===null||C===void 0?void 0:C.ssrcId)===T[0].ssrcId})}getSSRC(T){var w;return(w=this.sessionDesc.mediaDescriptions.find(C=>C.attributes.mid===T))===null||w===void 0?void 0:w.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:r,remoteRTPCapabilities:n,remoteSetup:a,localCapabilities:this.localCapabilities,cname:c}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let l=this.remoteSDP.toString(),u=At.parse(this.initialOffer.sdp),h=u.mediaDescriptions.find(T=>T.media.mediaType==="audio");h&&wa(h),this.useXR&&jp(u);let p=At.print(u),_=this.logSDPExchange(p||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:p}),_==null||_(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l});let E=this.peerConnection.getTransceivers()[0];if(E!=null&&E.receiver&&this.tryBindTransportEvents(E.receiver),P("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();let T=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:T});let w=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(w)}}catch(l){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(l.toString()))}}send(e,t,r){var n=this;return dn(function*(){let a=yield Ye(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let c=[];e.forEach(C=>{let O=n.peerConnection.addTransceiver(C._mediaStreamTrack,{direction:"sendonly"});c.push(O),C._updateRtpTransceiver(O)}),ht()&&P("SIMULCAST")===!0&&(yield Ye(n.applySimulcastForFirefox(c,e)));let l=yield Ye(n.peerConnection.createOffer()),u=n.remoteSDP.predictReceivingMids(e.length),h=n.mungSendOfferSDP(l.sdp,e,u),p=At.parse(h),_=u.map(C=>{let O=p.mediaDescriptions.find(b=>b.attributes.mid===C);if(!O)throw new Error("Cannot extract ssrc from mediaDescription.");return iN(O,P("USE_PUB_RTX"))}),E;try{E=yield _}catch(C){E=[],n.remoteSDP.receive(e,t,r,E);let O=n.remoteSDP.toString();throw yield Ye(n.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Ye(n.peerConnection.setRemoteDescription({type:"answer",sdp:O})),yield Ye(n.stopSending(u,!0)),C}n.remoteSDP.receive(e,t,r,E);let T=n.remoteSDP.toString(),w=n.logSDPExchange(h,"offer","local","send");return yield Ye(n.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Ye(n.applySimulcastEncodings(c,e)),yield Ye(n.applySendEncodings(c,e)),w==null||w(T),yield Ye(n.peerConnection.setRemoteDescription({type:"answer",sdp:T})),c.map((C,O)=>{let b=u[O];return{localSSRC:_[O],id:b,transceiver:C}})}catch(c){throw c instanceof Y?c:new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(c.toString()))}finally{a()}})()}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let r=this.dataStreamChannelMap.get(e);r&&r.readyState==="open"?S.debug("[P2PConnection] Channels are already available and can be reused directly."):(r=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:P("DATASTREAM_MAX_RETRANSMITS")}),r.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,r)),t.forEach(a=>{a._updateOriginDataChannel(r)});let{needExchangeSDP:n}=this.remoteSDP.sendDataChannel();if(n){let a=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:a});let c=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(c),S.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else S.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(r){throw r instanceof Y?r:new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(r.toString()))}}async stopDataChannels(e){try{let t=this.dataStreamChannelMap.get(e);return t==null||t.close(),void this.dataStreamChannelMap.delete(e)}catch(t){throw t instanceof Y?t:new Y(A.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(t.toString()))}}async stopSending(e,t){let r=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let n=this.peerConnection.getTransceivers().filter(u=>e.indexOf(u.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map(u=>{var h;u.direction="inactive",(h=u.stop)===null||h===void 0||h.call(u)});let a=await this.peerConnection.createOffer(),c=this.logSDPExchange(a.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(a),this.remoteSDP.stopReceiving(e);let l=this.remoteSDP.toString();c==null||c(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(n){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}finally{r&&r()}}async receive(e,t,r,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:a,needExchangeSDP:c}=this.remoteSDP.send(e,t,r,n);if(c){let u=this.remoteSDP.toString(),h=this.logSDPExchange(u,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:u});let p=await this.peerConnection.createAnswer(),_=this.mungReceiveAnswerSDP(p.sdp,a,e);h==null||h(_||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:_}),S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));let l=this.peerConnection.getTransceivers().find(u=>u.mid===a);if(!l)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:l.receiver.track,id:a,transceiver:l}}catch(a){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(a.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let{mids:t,needExchangeSDP:r}=this.remoteSDP.batchSend(e);if(r){let n=this.remoteSDP.toString(),a=this.logSDPExchange(n,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let c=await this.peerConnection.createAnswer();a==null||a(c.sdp||""),await this.peerConnection.setLocalDescription(c),S.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else S.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return t.map(n=>{let a=this.peerConnection.getTransceivers().find(c=>c.mid===n);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:n,transceiver:a}})}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let t=this.remoteSDP.toString(),r=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);let t=this.remoteSDP.toString(),r=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(t.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);let t=this.remoteSDP.toString(),r=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(t.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(c=>c.mid&&e.indexOf(c.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(c=>{c.direction="inactive"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(e);let a=this.remoteSDP.toString();n==null||n(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(c=>c.mid&&e.indexOf(c.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(async(c,l)=>{c.direction="sendonly"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(e);let a=this.remoteSDP.toString();n==null||n(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(e){var t=this;return dn(function*(){let r=yield Ye(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(ct().supportPCSetConfiguration){let h=t.peerConnection.getConfiguration(),p=e===Ci.RELAY?"relay":"all";h.iceTransportPolicy!==p&&(S.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(h.iceTransportPolicy,"] to [").concat(p,"]")),h.iceTransportPolicy=p,t.peerConnection.setConfiguration(h))}else if(e===Ci.RELAY)return;t.remoteSDP.updateCandidates(e);let n=yield Ye(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let a=Vo(n.sdp),{remoteIceParameters:c}=yield a.iceParameters;t.remoteSDP.restartICE(c);let l=t.remoteSDP.toString(),u=t.logSDPExchange(n.sdp||"","offer","local","restartICE");t.store.descriptionStart(),yield Ye(t.peerConnection.setLocalDescription(n)),u==null||u(l),yield Ye(t.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(n){S.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),n)}finally{r()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let r=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(r.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);let a=this.remoteSDP.toString(),c=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),c==null||c(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new Y(A.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(e,t){let r=this.peerConnection.getTransceivers().filter(n=>n.mid===e);r.length===1&&(this.isVP8Simulcast(t)?ht()||await this.applySimulcastEncodings(r,[t]):await this.applySendEncodings(r,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){let r=this.peerConnection.getTransceivers().find(n=>n.mid===t);r&&await r.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let t=e[0].transport.iceTransport,{local:r,remote:n}=t.getSelectedCandidatePair();return{local:sl(sl({},Ts),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:sl(sl({},Ts),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},P("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Lc(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...au.turnServerConfigToIceServers(e.turnServer.servers)),P("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...au.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),P("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(t.iceTransportPolicy="relay")}))),P("ENABLE_ENCODED_TRANSFORM")&&ct().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){let t=[];return e.forEach(r=>{r.security?r.tcpport&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(Vd(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!P("FORCE_TURN_TCP")&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),t}tryBindTransportEvents(e){let t=e.transport;if(t){this.transportEventReceiver=e,t.onstatechange=()=>{var n;t!=null&&t.state&&((n=this.onDTLSTransportStateChange)===null||n===void 0||n.call(this,t.state))},t.onerror=n=>{var a;(a=this.onDTLSTransportError)===null||a===void 0||a.call(this,"error"in n?n.error:n)};let r=t.iceTransport;r&&(r.onstatechange=()=>{let n=t==null?void 0:t.iceTransport.state;var a;n&&((a=this.onICETransportStateChange)===null||a===void 0||a.call(this,n))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){let{local:n,remote:a}=r.getSelectedCandidatePair();S.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol}),", remote ").concat(JSON.stringify({candidateType:a.type,protocol:a.protocol,address:a.address,port:a.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var r;if(t||(t=this.peerConnection.getSenders().find(p=>p.track===e._mediaStreamTrack)),!t)return S.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return S.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!ct().supportSetRtpSenderParameters)return S.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let n={},a={};switch(e._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(e._encoderConfig){var c;let{bitrateMax:p,frameRate:_,scaleResolutionDownBy:E}=e._encoderConfig;p&&(a.maxBitrate=1e3*p),(ge(c=e._hints).call(c,ut.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(_&&(a.maxFramerate=qr(_)),E&&E>=1&&(a.scaleResolutionDownBy=E))}if(P("DSCP_TYPE")&&la()){var l;let p=P("DSCP_TYPE");ge(l=["very-low","low","medium","high"]).call(l,p)&&(a.networkPriority=p)}let u=t.getParameters(),h=(r=u.encodings)===null||r===void 0?void 0:r[0];ht()&&!h&&(n.encodings=[a]),h&&Object.assign(h,a),Object.assign(u,n),S.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(u.encodings))),await t.setParameters(u)}async applySendEncodings(e,t){try{if(!ct().supportSetRtpSenderParameters||e.length!==t.length)return;for(let r=0;r<e.length;r++){let n=e[r],a=t[r];a instanceof ke&&!this.isVP8Simulcast(a)&&await this.updateRtpSenderEncodings(a,n.sender)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,r){let n=At.parse(e);return t.forEach((a,c)=>{let l=r[c],u=n.mediaDescriptions.find(h=>h.attributes.mid===l);u&&(Fo(u,a),aS(u,a,this.store.codec))}),At.print(n)}mungReceiveAnswerSDP(e,t,r){let n=At.parse(e),a=n.mediaDescriptions.find(c=>c.attributes.mid===t);return a&&(r===fe.AUDIO&&a.media.mediaType==="audio"&&wa(a),this.useXR&&jp(n)),At.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;(t=this.onFirstAudioReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;(t=this.onFirstVideoReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;(t=this.onFirstAudioDecoded)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,r)=>{var n;(n=this.onFirstVideoDecoded)===null||n===void 0||n.call(this,e,t,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;(t=this.onFirstVideoDecodedTimeout)===null||t===void 0||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let u=0;u<e.length;u++){var r,n,a,c,l;let h=e[u],p=t[u];if(p instanceof ke&&!ge(r=p._hints).call(r,ut.LOW_STREAM)&&(n=p._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((a=p._encoderConfig)===null||a===void 0?void 0:a.bitrateMax)>200&&(c=p._scalabilityMode)!==null&&c!==void 0&&c.numSpatialLayers&&((l=p._scalabilityMode)===null||l===void 0?void 0:l.numSpatialLayers)>1&&this.store.codec==="vp8"){let _={},E={high:1e3*(p._encoderConfig.bitrateMax-50),medium:5e4};_.encodings=[{rid:"m",active:!0,maxBitrate:E.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:E.high}];let T=h.sender.getParameters();await h.sender.setParameters(Object.assign(T,_))}}}async applySimulcastEncodings(e,t){if(!ht()&&e.length===t.length)for(let r=0;r<e.length;r++){let n=t[r];if(n instanceof ke&&this.isVP8Simulcast(n)){let a=e[r],c={},l={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};c.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:l.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:l.medium,scaleResolutionDownBy:4}];let u=a.sender.getParameters();await a.sender.setParameters(Object.assign(u,c))}}}isVP8Simulcast(e){var t,r,n,a,c;return!!(e instanceof ke&&P("SIMULCAST")&&this.store.codec==="vp8"&&!ge(t=e._hints).call(t,ut.LOW_STREAM)&&(r=e._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((n=e._encoderConfig)===null||n===void 0?void 0:n.bitrateMax)>200&&(a=e._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((c=e._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1)}logSDPExchange(e,t,r,n){if(P("SDP_LOGGING"))return S.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(t," SDP during P2PConnection.").concat(n,`
`),e),t==="offer"?a=>{this.logSDPExchange(a,"answer",r==="local"?"remote":"local",n)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;let t=this.remoteSDP.getSSRC(e);return t==null?void 0:t[0].ssrcId}setConfiguration(e){if(ct().supportPCSetConfiguration){let t=au.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}};function Rr(i,e,t){let r=i[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let n=this.mutex,a=await n.lock("From P2PConnection.".concat(e));try{for(var c=arguments.length,l=new Array(c),u=0;u<c;u++)l[u]=arguments[u];return await r.apply(this,l)}finally{a()}},t}function lS(i,e){let t=document.createElement("video"),r=document.createElement("canvas");t.setAttribute("style","display:none"),r.setAttribute("style","display:none"),t.setAttribute("muted",""),t.muted=!0,t.setAttribute("autoplay",""),t.autoplay=!0,t.setAttribute("playsinline",""),r.width=qr(e.width),r.height=qr(e.height);let n=qr(e.framerate||15);document.body.append(t),document.body.append(r);let a=i._mediaStreamTrack;t.srcObject=new MediaStream([a]),t.play();let c=r.getContext("2d");if(!c)throw new x(A.UNEXPECTED_ERROR,"can not get canvas context");let l=ct(),u=r.captureStream(l.supportRequestFrame?0:n).getVideoTracks()[0];u.canvas||(u.canvas=r),r.startCapture=()=>{if(!t)return r.stopCapture&&r.stopCapture();if(t.paused&&t.play(),t.videoHeight>2&&t.videoWidth>2){let p=t.videoWidth,_=t.videoHeight/p,E=r.width*_;Math.abs(E-r.height)>=2&&(S.debug("adjust low stream resolution","".concat(r.width,"x").concat(r.height," -> ").concat(r.width,"x").concat(E)),r.height=E)}c.drawImage(t,0,0,r.width,r.height),u.requestFrame&&u.requestFrame(),a!==i._mediaStreamTrack&&(a=i._mediaStreamTrack,t.srcObject=new MediaStream([a]))},r.stopCapture=pg(()=>r.startCapture&&r.startCapture(),n);let h=u.stop;return u.stop=()=>{h.call(u),t&&(t.remove(),t.srcObject=null,t=null),r&&(r.width=0,r.remove(),r.stopCapture&&r.stopCapture(),r.startCapture=void 0,r.stopCapture=void 0,r=null),S.debug("clean low stream renderer")},u}function CN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function RN(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?CN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):CN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}J([Rr,R("design:type",Function),R("design:paramtypes",[Array,Array]),R("design:returntype",F)],zt.prototype,"updateRemoteRTPCapabilities",null),J([Rr,R("design:type",Function),R("design:paramtypes",[Object,Object,Array,Object,String,String]),R("design:returntype",F)],zt.prototype,"connect",null),J([Rr,R("design:type",Function),R("design:paramtypes",[Object,Array]),R("design:returntype",F)],zt.prototype,"createDataChannels",null),J([Rr,R("design:type",Function),R("design:paramtypes",[String,Array,String,Object]),R("design:returntype",F)],zt.prototype,"receive",null),J([Rr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],zt.prototype,"batchReceive",null),J([Rr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],zt.prototype,"stopReceiving",null),J([Rr,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],zt.prototype,"muteRemote",null),J([Rr,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],zt.prototype,"unmuteRemote",null),J([Rr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],zt.prototype,"muteLocal",null),J([Rr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],zt.prototype,"unmuteLocal",null),J([Rr,R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],zt.prototype,"close",null),J([Rr,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],zt.prototype,"updateEncoderConfig",null),J([Rr,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],zt.prototype,"updateSendParameters",null),J([Rr,R("design:type",Function),R("design:paramtypes",[Ri,String]),R("design:returntype",F)],zt.prototype,"replaceTrack",null),J([Rr,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],zt.prototype,"getRemoteSSRC",null);let IN=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,Wp="9",dS=2e4,uS=4e4;class IG{get localCapabilities(){return Ut(this._localCapabilities)}get rtpCapabilities(){return Ut(this._rtpCapabilities)}get candidates(){return Ut(this._candidates)}get iceParameters(){return Ut(this._iceParameters)}get dtlsParameters(){return Ut(this._dtlsParameters)}constructor(e){g(this,"sessionDesc",void 0),g(this,"_localCapabilities",void 0),g(this,"_rtpCapabilities",void 0),g(this,"_candidates",void 0),g(this,"_iceParameters",void 0),g(this,"_dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),g(this,"firefoxSsrcMidMap",new Map),e=Ut(e);let{remoteIceParameters:t,remoteDtlsParameters:r,candidates:n,remoteRTPCapabilities:a,remoteSetup:c,localCapabilities:l,cname:u}=e,h=At.parse(IN);this._rtpCapabilities=a,this._candidates=n,this._iceParameters=t,this._dtlsParameters=r,this._localCapabilities=l,this.setup=c,this.cname=u;let p=this.rtpCapabilities.send;for(let _ of h.mediaDescriptions){if(_.attributes.iceUfrag=t.iceUfrag,_.attributes.icePwd=t.icePwd,_.attributes.fingerprints=r.fingerprints,_.attributes.candidates=n,_.attributes.setup=c,_.media.mediaType==="application"&&(_.attributes.sctpPort="5000"),_.media.mediaType==="video"&&(_.media.fmts=p.videoCodecs.map(E=>E.payloadType.toString(10)),_.attributes.payloads=p.videoCodecs,_.attributes.extmaps=p.videoExtensions,P("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:E,ssrcGroups:T}=un([{ssrcId:uS,rtx:P("USE_SUB_RTX")?40001:void 0}],this.cname);_.attributes.ssrcs=E,_.attributes.ssrcGroups=T}if(_.media.mediaType==="audio"&&(_.media.fmts=p.audioCodecs.map(E=>E.payloadType.toString(10)),_.attributes.payloads=p.audioCodecs,_.attributes.extmaps=p.audioExtensions,wa(_),P("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:E,ssrcGroups:T}=un([{ssrcId:dS}],this.cname);_.attributes.ssrcs=E,_.attributes.ssrcGroups=T}}this.sessionDesc=h,this.currentMidIndex=h.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){let t=At.parse(IN);this._rtpCapabilities=e;let r=this.rtpCapabilities.send;for(let n of t.mediaDescriptions){if(n.attributes.iceUfrag=this._iceParameters.iceUfrag,n.attributes.icePwd=this._iceParameters.icePwd,n.attributes.fingerprints=this._dtlsParameters.fingerprints,n.attributes.candidates=this._candidates,n.attributes.setup=this.setup,n.media.mediaType==="application"&&(n.attributes.sctpPort="5000"),n.media.mediaType==="video"&&(n.media.fmts=r.videoCodecs.map(a=>a.payloadType.toString(10)),n.attributes.payloads=r.videoCodecs,n.attributes.extmaps=r.videoExtensions,P("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:a,ssrcGroups:c}=un([{ssrcId:uS,rtx:P("USE_SUB_RTX")?40001:void 0}],this.cname);n.attributes.ssrcs=a,n.attributes.ssrcGroups=c}if(n.media.mediaType==="audio"&&(n.media.fmts=r.audioCodecs.map(a=>a.payloadType.toString(10)),n.attributes.payloads=r.audioCodecs,n.attributes.extmaps=r.audioExtensions,P("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:a,ssrcGroups:c}=un([{ssrcId:dS}],this.cname);n.attributes.ssrcs=a,n.attributes.ssrcGroups=c}}this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;let t=this.candidates,r=this.dtlsParameters,n=this.iceParameters,a=this.rtpCapabilities.send;for(let c=1;c<e;c++){let l=2*c+dS,u=2*c+uS,{ssrcs:h,ssrcGroups:p}=un([{ssrcId:l}],this.cname),{ssrcs:_,ssrcGroups:E}=un([{ssrcId:u,rtx:P("USE_SUB_RTX")?u+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Wp,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.videoCodecs.map(T=>T.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:a.videoExtensions,fingerprints:r.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:_,ssrcGroups:E,rtcpFeedbackWildcards:[],payloads:a.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*c-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Wp,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.audioCodecs.map(T=>T.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:a.audioExtensions,fingerprints:r.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:h,ssrcGroups:p,rtcpFeedbackWildcards:[],payloads:a.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*c)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return At.print(this.sessionDesc)}send(e,t,r,n){let{ssrcs:a,ssrcGroups:c}=un(t,this.cname,P("SYNC_GROUP")?r:void 0),l=this.findPreloadMediaDesc(a);if(l){if(ht()&&this.firefoxSsrcMidMap.set(a[0].ssrcId,l.attributes.mid),n&&(n.twcc||n.remb)){let u=this.sessionDesc.mediaDescriptions.indexOf(l);return this.sessionDesc.mediaDescriptions[u]=this.mungSendMediaDesc(l,n),{mid:l.attributes.mid,needExchangeSDP:!0}}return{mid:l.attributes.mid,needExchangeSDP:!1}}{let u=this.findAvailableMediaIndex(e,a),h;return u===-1||Vi()||Fi()||dw()||u===0&&P("USE_SUB_RTX")?(h=this.createOrRecycleSendMedia(e,a,c,"sendonly",n),this.updateBundleMids()):(h=Ut(this.sessionDesc.mediaDescriptions[u]),h.attributes.direction="sendonly",h.attributes.ssrcs=a,h.attributes.ssrcGroups=c,this.sessionDesc.mediaDescriptions[u]=this.mungSendMediaDesc(h,n)),ht()&&this.firefoxSsrcMidMap.set(a[0].ssrcId,h.attributes.mid),{mid:h.attributes.mid,needExchangeSDP:!0}}}batchSend(e){let t=e.map(a=>{let{kind:c,ssrcMsg:l,mslabel:u}=a;return this.send(c,l,u)}),r=[],n=!1;return t.forEach(a=>{let{mid:c,needExchangeSDP:l}=a;l&&(n=!0),r.push(c)}),{mids:r,needExchangeSDP:n}}stopSending(e){let t=this.sessionDesc.mediaDescriptions.filter(r=>r.attributes.mid&&e.indexOf(r.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(r=>{r.attributes.mid==="0"||ht()||Vi()||Fi()?r.attributes.ssrcs=[]:(r.attributes.ssrcs=[],r.attributes.direction="inactive",r.media.port="0")}),this.updateBundleMids()}mute(e){let t=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){let t=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){let t=this.sessionDesc.mediaDescriptions.filter(r=>ge(e).call(e,r.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(r=>{r.attributes.direction="inactive"})}unmuteRemote(e){let t=this.sessionDesc.mediaDescriptions.filter(r=>ge(e).call(e,r.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(r=>{r.attributes.direction="recvonly"})}receive(e,t,r,n){e.forEach((a,c)=>{this.createOrRecycleRecvMedia(a,[],"recvonly",t,r,n[c])}),this.updateBundleMids()}stopReceiving(e){let t=this.sessionDesc.mediaDescriptions.filter(r=>e.indexOf(r.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(r=>{r.media.port="0",r.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(e){e===Ci.TCP?this._candidates.forEach(t=>{this._candidates.findIndex(r=>r.transport==="tcp"&&r.connectionAddress===t.connectionAddress&&r.port===t.port)===-1&&this._candidates.push(RN(RN({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))}):this._candidates=this._candidates.filter(t=>t.transport!=="tcp");for(let t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(e){e=Ut(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}predictReceivingMids(e){let t=[];for(let r=0;r<e;r++)t.push((this.currentMidIndex+r+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex(r=>{let n=r.media.mediaType===e&&r.media.port!=="0"&&(r.attributes.direction==="sendonly"||r.attributes.direction==="sendrecv")&&r.attributes.ssrcs.length===0;if(ht()){if(n){let a=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(a||r.attributes.mid!=="0"&&r.attributes.mid!=="1")||!(!a||a!==r.attributes.mid)}return!1}return n})}createOrRecycleRecvMedia(e,t,r,n,a,c){let l=e._mediaStreamTrack.kind,u=this.rtpCapabilities.recv,h=Bp(l,u,this.localCapabilities.send,l===fe.VIDEO?n:a),p=l===fe.VIDEO?u.videoExtensions:u.audioExtensions;this.currentMidIndex+=1;let _="".concat(this.currentMidIndex),E={media:{mediaType:l,port:Wp,protos:["UDP","TLS","RTP","SAVPF"],fmts:h.map(w=>w.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:p,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:h,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(_)}};E=this.mungRecvMediaDsec(E,e,c);let T=this.findFirstClosedMedia(l);if(T){let w=this.sessionDesc.mediaDescriptions.indexOf(T);this.sessionDesc.mediaDescriptions[w]=E}else this.sessionDesc.mediaDescriptions.push(E);return E}updateRemoteCodec(e,t,r){let n=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(E=>E.rtpMap&&E.rtpMap.encodingName.toLowerCase()||"").filter(E=>{var T;return ge(T=Object.keys(Ro)).call(T,E)}))],a=new Set(t);if(n.every(E=>a.has(E)))return S.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;let c=this._rtpCapabilities.recv.videoCodecs.filter(E=>t.some(T=>{var w;return ge(w=E.rtpMap&&E.rtpMap.encodingName.toLowerCase()||"").call(w,T)}));if(c.length===0)return S.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(n," codecs: ").concat(t)),!1;let l=[...new Set(c.map(E=>E.rtpMap&&E.rtpMap.encodingName.toLowerCase()||""))],u;if(S.debug("updateRemoteCodec, from ".concat(n," to ").concat(l)),e.length===0)u=this.sessionDesc.mediaDescriptions.filter(E=>E.media.mediaType==="video"&&E.attributes.direction==="recvonly");else if(u=this.sessionDesc.mediaDescriptions.filter(E=>E.attributes.mid&&ge(e).call(e,E.attributes.mid)&&E.attributes.direction==="recvonly"),u.length!==e.length)return S.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;this._rtpCapabilities.recv.videoCodecs=c;let h=this.localCapabilities.send,p=this.rtpCapabilities.recv,_=Bp(fe.VIDEO,p,h,r);return u.forEach(E=>{let T=_.map(w=>w.payloadType.toString(10));S.debug("updateRemoteCodec mid: ".concat(E.attributes.mid,", from ").concat(E.attributes.payloads," to ").concat(_)),E.attributes.payloads=_,E.media.fmts=T}),!0}createOrRecycleSendMedia(e,t,r,n,a){let c=this.rtpCapabilities.send,l=e===fe.VIDEO?c.videoCodecs:c.audioCodecs,u=e===fe.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;let h="".concat(this.currentMidIndex),p={media:{mediaType:e,port:Wp,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map(E=>E.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:r,rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(h)}};p=this.mungSendMediaDesc(p,a);let _=this.findFirstClosedMedia(e);if(_){let E=this.sessionDesc.mediaDescriptions.indexOf(_);this.sessionDesc.mediaDescriptions[E]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}mungRecvMediaDsec(e,t,r){let n=Ut(e);return nS(n),Fo(n,t),sS(n,t),nN(n),xp(n,r,this.localCapabilities.send),n}mungSendMediaDesc(e,t){let r=Ut(e);return xp(r,t,this.localCapabilities.recv),wa(r),r}updateRecvMedia(e,t){let r=this.sessionDesc.mediaDescriptions.findIndex(n=>n.attributes.mid===e);if(r!==-1){let n=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[r],t);this.sessionDesc.mediaDescriptions[r]=n}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(t=>ht()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(t=>{var r;return((r=t.attributes)===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId)===e[0].ssrcId})}getSSRC(e){var t;return(t=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===e))===null||t===void 0?void 0:t.attributes.ssrcs}}function wN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Hp(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?wN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):wN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class Ai extends tp{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,t,r){super(e,t),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"transportEventReceiver",void 0),g(this,"statsFilter",void 0),g(this,"useXR",P("USE_XR")),g(this,"localCapabilities",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"remoteCodecs",void 0),g(this,"dataStreamChannelMap",new Map),g(this,"establishPromise",void 0),g(this,"mutex",new si("NVExtentionsConnection-mutex")),g(this,"rtcMedia",void 0),this.store=t,this.peerConnection=r,this.statsFilter=Gp(this.peerConnection,P("STATS_UPDATE_INTERVAL"),void 0,ht()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{let t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let r=Vo(t.sdp),n=await sN({filterRTX:!P("USE_PUB_RTX")&&!P("USE_SUB_RTX"),filterVideoFec:P("FILTER_VIDEO_FEC"),filterAudioFec:P("FILTER_AUDIO_FEC"),filterVideoCodec:P("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=n,this.initialOffer=t,Hp(Hp({},r),{},{rtpCapabilities:n,offerSDP:t.sdp})}catch(t){throw new x(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(e,t,r,n,a,c){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new IG({remoteIceParameters:e,remoteDtlsParameters:t,candidates:r,remoteRTPCapabilities:n,remoteSetup:a,localCapabilities:Fp(this.localCapabilities),cname:c});let l=this.remoteSDP.toString(),u=At.parse(this.initialOffer.sdp),h=u.mediaDescriptions.find(E=>E.media.mediaType==="audio");h&&wa(h),this.useXR&&jp(u);let p=At.print(u),_=this.logSDPExchange(p||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:p}),_==null||_(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(l){throw new x(A.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(l.toString()))}}async updateRemoteRTPCapabilities(e,t){let r;this.remoteCodecs=t,this.localCapabilities&&(r=Fp(this.localCapabilities));let n=[...new Set(r&&r.send.videoCodecs.map(a=>a.rtpMap&&a.rtpMap.encodingName.toLowerCase()||"").filter(a=>{var c;return ge(c=Object.keys(Ro)).call(c,a)}))];if(Ee.updateRemoteRTPCapabilities(this.store.sessionId,{mids:e,localCodecs:n,remoteCodecs:this.remoteCodecs}),!this.remoteSDP)return void S.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(n,", codecs: ").concat(t));if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){let a=await this.peerConnection.createOffer(),c=this.logSDPExchange(a.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(a);let l=this.remoteSDP.toString();c==null||c(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}else S.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(e){var t,r,n,a;(t=this.remoteSDP)===null||t===void 0||t.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((a=this.remoteSDP)===null||a===void 0||a.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(r=this.remoteSDP)===null||r===void 0||r.preloadRemoteMedia(2);let c=(n=this.remoteSDP)===null||n===void 0?void 0:n.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});let l=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(l),S.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,t,r){var n=this;return dn(function*(){let a=yield Ye(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");let c=[];e.forEach(C=>{let O=n.peerConnection.addTransceiver(C._mediaStreamTrack,{direction:"sendonly"});c.push(O)}),ht()&&P("SIMULCAST")===!0&&(yield Ye(n.applySimulcastForFirefox(c,e)));let l=yield Ye(n.peerConnection.createOffer()),u=n.remoteSDP.predictReceivingMids(e.length),h=n.mungSendOfferSDP(l.sdp,e,u),p=At.parse(h),_=u.map(C=>{let O=p.mediaDescriptions.find(b=>b.attributes.mid===C);if(!O)throw new Error("Cannot extract ssrc from mediaDescription.");return iN(O,P("USE_PUB_RTX"))}),E;try{E=yield _}catch(C){E=[],n.remoteSDP.receive(e,t,r,E);let O=n.remoteSDP.toString();throw yield Ye(n.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Ye(n.peerConnection.setRemoteDescription({type:"answer",sdp:O})),yield Ye(n.stopSending(u,!0)),C}n.remoteSDP.receive(e,t,r,E);let T=n.remoteSDP.toString(),w=n.logSDPExchange(h,"offer","local","send");return yield Ye(n.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield Ye(n.applySimulcastEncodings(c,e)),yield Ye(n.applySendEncodings(c,e)),w==null||w(T),yield Ye(n.peerConnection.setRemoteDescription({type:"answer",sdp:T})),c.map((C,O)=>{let b=u[O];return{localSSRC:_[O],id:b,transceiver:C}})}catch(c){throw c instanceof x?c:new x(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(c.toString()))}finally{a()}})()}async stopSending(e,t){let r=t?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");let n=this.peerConnection.getTransceivers().filter(u=>e.indexOf(u.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");n.map(u=>{var h;u.direction="inactive",(h=u.stop)===null||h===void 0||h.call(u)});let a=await this.peerConnection.createOffer(),c=this.logSDPExchange(a.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(a),this.remoteSDP.stopReceiving(e);let l=this.remoteSDP.toString();c==null||c(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(n){throw new x(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(n.toString()))}finally{r&&r()}}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let r=this.dataStreamChannelMap.get(e);return r&&r.readyState==="open"?S.debug("[P2PConnection] Channels are already available and can be reused directly."):(r=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:P("DATASTREAM_MAX_RETRANSMITS")}),r.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,r)),void t.forEach(n=>{n._updateOriginDataChannel(r)})}catch(r){throw r instanceof x?r:new x(A.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(r.toString()))}}async stopDataChannels(e){try{let t=this.dataStreamChannelMap.get(e);return t==null||t.close(),void this.dataStreamChannelMap.delete(e)}catch(t){throw t instanceof x?t:new x(A.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(t.toString()))}}async receive(e,t,r,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));let{mid:a,needExchangeSDP:c}=this.remoteSDP.send(e,t,r,n);if(c){let u=this.remoteSDP.toString(),h=this.logSDPExchange(u,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:u});let p=await this.peerConnection.createAnswer(),_=this.mungReceiveAnswerSDP(p.sdp,a,e);h==null||h(_||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:_}),S.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else S.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));let l=this.peerConnection.getTransceivers().find(u=>u.mid===a);if(!l)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:l.receiver.track,id:a}}catch(a){throw new x(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(a.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");let{mids:t,needExchangeSDP:r}=this.remoteSDP.batchSend(e);if(r){let n=this.remoteSDP.toString(),a=this.logSDPExchange(n,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let c=await this.peerConnection.createAnswer();a==null||a(c.sdp||""),await this.peerConnection.setLocalDescription(c),S.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else S.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return t.map(n=>{let a=this.peerConnection.getTransceivers().find(c=>c.mid===n);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:n}})}catch(t){throw new x(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(t.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let t=this.remoteSDP.toString(),r=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new x(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);let t=this.remoteSDP.toString(),r=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new x(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(t.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);let t=this.remoteSDP.toString(),r=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new x(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(t.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(c=>c.mid&&e.indexOf(c.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(c=>{c.direction="inactive"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(e);let a=this.remoteSDP.toString();n==null||n(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(t){throw new x(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");let t=this.peerConnection.getTransceivers().filter(c=>c.mid&&e.indexOf(c.mid)!==-1);if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map(async(c,l)=>{c.direction="sendonly"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(e);let a=this.remoteSDP.toString();n==null||n(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(t){throw new x(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(e){var t=this;return dn(function*(){let r=yield Ye(t.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(ct().supportPCSetConfiguration){let h=t.peerConnection.getConfiguration(),p=e===Ci.RELAY?"relay":"all";h.iceTransportPolicy!==p&&(S.debug("restartICE change iceTransportPolicy from [".concat(h.iceTransportPolicy,"] to [").concat(p,"]")),h.iceTransportPolicy=p,t.peerConnection.setConfiguration(h))}else if(e===Ci.RELAY)return;e!==Ci.RELAY&&t.remoteSDP.updateCandidates(e);let n=yield Ye(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let a=Vo(n.sdp),{remoteIceParameters:c}=yield a.iceParameters;t.remoteSDP.restartICE(c);let l=t.remoteSDP.toString(),u=t.logSDPExchange(n.sdp||"","offer","local","restartICE");yield Ye(t.peerConnection.setLocalDescription(n)),u==null||u(l),yield Ye(t.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(n){S.warning("restart ICE failed, abort operation",n)}finally{r()}})()}close(){var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");let r=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(r.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);let a=this.remoteSDP.toString(),c=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),c==null||c(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new x(A.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(e,t){let r=this.peerConnection.getTransceivers().filter(n=>n.mid===e);r.length===1&&(this.isVP8Simulcast(t)?ht()||await this.applySimulcastEncodings(r,[t]):await this.applySendEncodings(r,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){let r=this.peerConnection.getTransceivers().find(n=>n.mid===t);r&&await r.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if((e=this.peerConnection.currentLocalDescription)===null||e===void 0||!e.sdp||!this.localCapabilities)throw new Error;return Hp(Hp({},Vo(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},P("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Lc(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...Ai.turnServerConfigToIceServers(e.turnServer.servers)),P("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...Ai.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),P("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(t.iceTransportPolicy="relay")}))),t}static turnServerConfigToIceServers(e){let t=[];return e.forEach(r=>{r.security?r.tcpport&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(Vd(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!P("FORCE_TURN_TCP")&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),t}async applySendEncodings(e,t){try{if(!ct().supportSetRtpSenderParameters||e.length!==t.length)return;for(let _=0;_<e.length;_++){let E=e[_],T=t[_];if(T&&T instanceof ke){var r,n,a;if(this.isVP8Simulcast(T))continue;let w={},C={};switch(T._optimizationMode){case"motion":w.degradationPreference="maintain-framerate";break;case"detail":w.degradationPreference="maintain-resolution";break;default:w.degradationPreference="balanced"}var c,l,u,h;if((r=T._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&(C.maxBitrate=1e3*((c=T._encoderConfig)===null||c===void 0?void 0:c.bitrateMax)),ge(n=T._hints).call(n,ut.LOW_STREAM)&&((l=T._encoderConfig)!==null&&l!==void 0&&l.frameRate&&(C.maxFramerate=qr(T._encoderConfig.frameRate)),(u=T._encoderConfig)!==null&&u!==void 0&&u.scaleResolutionDownBy&&((h=T._encoderConfig)===null||h===void 0?void 0:h.scaleResolutionDownBy)>1&&(C.scaleResolutionDownBy=T._encoderConfig.scaleResolutionDownBy)),P("DSCP_TYPE")&&la()){var p;let k=P("DSCP_TYPE");ge(p=["very-low","low","medium","high"]).call(p,k)&&(C.networkPriority=k)}let O=E.sender.getParameters(),b=(a=O.encodings)===null||a===void 0?void 0:a[0];ht()&&!b&&(w.encodings=[C]),b&&Object.assign(b,C),Object.assign(O,w),await E.sender.setParameters(O)}}}catch{S.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,r){let n=At.parse(e);return t.forEach((a,c)=>{let l=r[c],u=n.mediaDescriptions.find(h=>h.attributes.mid===l);u&&(Fo(u,a),aS(u,a,this.store.codec))}),At.print(n)}mungReceiveAnswerSDP(e,t,r){let n=At.parse(e),a=n.mediaDescriptions.find(c=>c.attributes.mid===t);return a&&r===fe.AUDIO&&a.media.mediaType==="audio"&&wa(a),this.useXR&&jp(n),At.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;(t=this.onFirstAudioReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;(t=this.onFirstVideoReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;(t=this.onFirstAudioDecoded)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,r)=>{var n;(n=this.onFirstVideoDecoded)===null||n===void 0||n.call(this,e,t,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;(t=this.onFirstVideoDecodedTimeout)===null||t===void 0||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let u=0;u<e.length;u++){var r,n,a,c,l;let h=e[u],p=t[u];if(p instanceof ke&&!ge(r=p._hints).call(r,ut.LOW_STREAM)&&(n=p._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((a=p._encoderConfig)===null||a===void 0?void 0:a.bitrateMax)>200&&(c=p._scalabilityMode)!==null&&c!==void 0&&c.numSpatialLayers&&((l=p._scalabilityMode)===null||l===void 0?void 0:l.numSpatialLayers)>1&&this.store.codec==="vp8"){let _={},E={high:1e3*(p._encoderConfig.bitrateMax-50),medium:5e4};_.encodings=[{rid:"m",active:!0,maxBitrate:E.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:E.high}];let T=h.sender.getParameters();await h.sender.setParameters(Object.assign(T,_))}}}async applySimulcastEncodings(e,t){if(!ht()&&e.length===t.length)for(let r=0;r<e.length;r++){let n=t[r];if(n instanceof ke&&this.isVP8Simulcast(n)){let a=e[r],c={},l={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};c.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:l.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:l.medium,scaleResolutionDownBy:4}];let u=a.sender.getParameters();await a.sender.setParameters(Object.assign(u,c))}}}isVP8Simulcast(e){var t,r,n,a,c;return!!(e instanceof ke&&P("SIMULCAST")&&this.store.codec==="vp8"&&!ge(t=e._hints).call(t,ut.LOW_STREAM)&&(r=e._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((n=e._encoderConfig)===null||n===void 0?void 0:n.bitrateMax)>200&&(a=e._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((c=e._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1)}logSDPExchange(e,t,r,n){if(P("SDP_LOGGING"))return S.upload("exchanging ".concat(r," ").concat(t," SDP during NVExtentionsConnection.").concat(n,`
`),e),t==="offer"?a=>{this.logSDPExchange(a,"answer",r==="local"?"remote":"local",n)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;let t=this.remoteSDP.getSSRC(e);return t==null?void 0:t[0].ssrcId}setConfiguration(e){if(ct().supportPCSetConfiguration){let t=Ai.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function fr(i,e,t){let r=i[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let n=this.mutex,a=await n.lock("From NVExtentionsConnection.".concat(e));try{for(var c=arguments.length,l=new Array(c),u=0;u<c;u++)l[u]=arguments[u];return await r.apply(this,l)}finally{a()}},t}function AN(i){var e,t,r,n=2;for(typeof Symbol<"u"&&(t=$0,r=Symbol.iterator);n--;){if(t&&(e=i[t])!=null)return e.call(i);if(r&&(e=i[r])!=null)return new Kp(e.call(i));t="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function Kp(i){function e(t){if(Object(t)!==t)return F.reject(new TypeError(t+" is not an object."));var r=t.done;return F.resolve(t.value).then(function(n){return{value:n,done:r}})}return Kp=function(t){this.s=t,this.n=t.next},Kp.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var r=this.s.return;return r===void 0?F.resolve({value:t,done:!0}):e(r.apply(this.s,arguments))},throw:function(t){var r=this.s.return;return r===void 0?F.reject(t):e(r.apply(this.s,arguments))}},new Kp(i)}J([fr,R("design:type",Function),R("design:paramtypes",[Object,Object,Array,Object,String,String]),R("design:returntype",F)],Ai.prototype,"connect",null),J([fr,R("design:type",Function),R("design:paramtypes",[Array,Array]),R("design:returntype",F)],Ai.prototype,"updateRemoteRTPCapabilities",null),J([fr,R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",F)],Ai.prototype,"updateRemoteConnect",null),J([fr,R("design:type",Function),R("design:paramtypes",[Object,Array]),R("design:returntype",F)],Ai.prototype,"createDataChannels",null),J([fr,R("design:type",Function),R("design:paramtypes",[String,Array,String,Object]),R("design:returntype",F)],Ai.prototype,"receive",null),J([fr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],Ai.prototype,"batchReceive",null),J([fr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],Ai.prototype,"stopReceiving",null),J([fr,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Ai.prototype,"muteRemote",null),J([fr,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Ai.prototype,"unmuteRemote",null),J([fr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],Ai.prototype,"muteLocal",null),J([fr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],Ai.prototype,"unmuteLocal",null),J([fr,R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Ai.prototype,"close",null),J([fr,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],Ai.prototype,"updateEncoderConfig",null),J([fr,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],Ai.prototype,"updateSendParameters",null),J([fr,R("design:type",Function),R("design:paramtypes",[Ri,String]),R("design:returntype",F)],Ai.prototype,"replaceTrack",null),J([fr,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Ai.prototype,"getRemoteSSRC",null);class Yt extends tp{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,t){super(e,t),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"cname",void 0),g(this,"mutex",new si("DataChannelConnection-mutex")),g(this,"dataChannel",void 0),g(this,"_p2pConnection",void 0),g(this,"establishPromise",void 0),g(this,"_nvMedia",void 0),this.store=t,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Yt.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new Ai(e,t,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;let t=(e=this._nvMedia)===null||e===void 0?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(t)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,t,r,n,a,c){return this.cname=c,await this._p2pConnection.connect(e,t,r,n,a,c),await new F((l,u)=>{let h=setTimeout(()=>{this.closeSignal(),u(new x(A.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(r))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(h),void l()},this.dataChannel.onerror=p=>{this.closeSignal(),u(p)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,t){return this._p2pConnection.updateRemoteRTPCapabilities(e,t)}send(e,t,r){var n=this;return dn(function*(){let a=yield Ye(n.mutex.lock("From DataChannelConnection.send"));try{return yield*Up(AN(n._p2pConnection.send(e,t,r)))}finally{a()}})()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,t,r,n){return this._nvMedia?(S.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,t,this.cname)):(S.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,t,r,n))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return dn(function*(){return yield*Up(AN(t._p2pConnection.restartICE(e)))})()}close(){var e;(e=this._nvMedia)===null||e===void 0||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;(t=this._nvMedia)===null||t===void 0||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,t,r,n){if(P("SDP_LOGGING"))return S.upload("exchanging ".concat(r," ").concat(t," SDP during DataChannelConnection.").concat(n,`
`),e),t==="offer"?a=>{this.logSDPExchange(a,"answer",r==="local"?"remote":"local",n)}:void 0}static resolvePCConfiguration(e){let t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Lc(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...Yt.turnServerConfigToIceServers(e.turnServer.servers)),P("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...Yt.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),P("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(t.iceTransportPolicy="relay")}))),t}static turnServerConfigToIceServers(e){let t=[];return e.forEach(r=>{r.security?r.tcpport&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(Vd(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!P("FORCE_TURN_TCP")&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return(t=this.onICEConnectionStateChange)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return(t=this.onConnectionStateChange)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return(t=this.onDTLSTransportStateChange)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return(t=this.onDTLSTransportError)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return(t=this.onICETransportStateChange)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return(t=this.onFirstAudioReceived)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return(t=this.onFirstVideoReceived)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return(t=this.onFirstAudioDecoded)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,r)=>{var n;return(n=this.onFirstVideoDecoded)===null||n===void 0?void 0:n.call(this,e,t,r)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return(t=this.onFirstVideoDecodedTimeout)===null||t===void 0?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var r;return(r=this.onSelectedLocalCandidateChanged)===null||r===void 0?void 0:r.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var r;return(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0?void 0:r.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}}function Jr(i,e,t){let r=i[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let n=this.mutex,a=await n.lock("From DataChannelConnection.".concat(e));try{for(var c=arguments.length,l=new Array(c),u=0;u<c;u++)l[u]=arguments[u];return await r.apply(this,l)}finally{a()}},t}function ON(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function NN(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ON(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):ON(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}J([Jr,R("design:type",Function),R("design:paramtypes",[Object,Object,Array,Object,String,String]),R("design:returntype",F)],Yt.prototype,"connect",null),J([Jr,R("design:type",Function),R("design:paramtypes",[Array,Array]),R("design:returntype",F)],Yt.prototype,"updateRemoteRTPCapabilities",null),J([Jr,R("design:type",Function),R("design:paramtypes",[Object,Array]),R("design:returntype",F)],Yt.prototype,"createDataChannels",null),J([Jr,R("design:type",Function),R("design:paramtypes",[String,Array,String,Object]),R("design:returntype",F)],Yt.prototype,"receive",null),J([Jr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],Yt.prototype,"stopReceiving",null),J([Jr,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Yt.prototype,"muteRemote",null),J([Jr,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Yt.prototype,"unmuteRemote",null),J([Jr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],Yt.prototype,"muteLocal",null),J([Jr,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],Yt.prototype,"unmuteLocal",null),J([Jr,R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Yt.prototype,"close",null),J([Jr,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],Yt.prototype,"updateEncoderConfig",null),J([Jr,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],Yt.prototype,"updateSendParameters",null),J([Jr,R("design:type",Function),R("design:paramtypes",[Ri,String]),R("design:returntype",F)],Yt.prototype,"replaceTrack",null),J([Jr,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Yt.prototype,"getRemoteSSRC",null);class bN extends mt{constructor(){super(),g(this,"uplinkStatsUploadInterval",void 0),g(this,"uplinkRelatedStatsUploadInterval",void 0),g(this,"uplinkDenoiserStatsUploadInterval",void 0),g(this,"transportStatsUploadInterval",void 0),g(this,"uplinkExtensionStatsUploadInterval",void 0),g(this,"downlinkExtensionStatsUploadInterval",void 0),g(this,"extensionUsageStatsUploadInterval",void 0),g(this,"downlinkStatsUploadInterval",void 0),g(this,"downlinkRelatedStatsUploadInterval",void 0),g(this,"lastStats",void 0),g(this,"uploadUnplinkStarted",!1),g(this,"uploadDownlinkStarted",!1),g(this,"uploadTransportStarted",!1),g(this,"uploadExtensionUsageStarted",!1),g(this,"requestStats",void 0),g(this,"requestTransportStats",void 0),g(this,"requestLocalMedia",void 0),g(this,"requestRemoteMedia",void 0),g(this,"requestAllTracks",void 0),g(this,"requestVideoIsReady",void 0),g(this,"requestUpload",void 0)}startUploadTransportStats(e){this.uploadTransportStarted||(this.uploadTransportStarted=!0,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=window.setInterval(()=>{var t;let r=(t=this.requestStats)===null||t===void 0?void 0:t.call(this);if(r){let a=O0(r);if(e){var n;let c=(n=this.requestStats)===null||n===void 0?void 0:n.call(this,!0);if(c){let l=O0(c);a.connectionType+=l.connectionType<<3}a.connectionType+=110}else a.connectionType+=100;In(()=>{var c;(c=this.requestUpload)===null||c===void 0||c.call(this,ur.TRANSPORT_STATS,a)})}},1e3))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval);let e=new Map;this.extensionUsageStatsUploadInterval=window.setInterval(async()=>{var t,r,n;let a=Date.now(),c={connectionInterval:P("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:a},l=[],u=((t=this.requestAllTracks)===null||t===void 0?void 0:t.call(this))||[];for(let E of u)!E.muted&&E.enabled&&(l=l.concat(await E.getProcessorUsage()));let h=((r=this.requestRemoteMedia)===null||r===void 0?void 0:r.call(this))||[];for(let[E,T]of h)T.has(fe.VIDEO)&&E.videoTrack&&(l=l.concat(await E.videoTrack.getProcessorUsage())),T.has(fe.AUDIO)&&E.audioTrack&&(l=l.concat(await E.audioTrack.getProcessorUsage()));if(l.length===0)return;c.details=function(E,T){let w={};for(let{id:k,value:U,level:X,direction:z}of E){var C;let j=(C=T.get(k))!==null&&C!==void 0?C:0,B=U===2?j+P("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:j;var O,b;T.set(k,B),w[k]?(U===2&&(w[k].value=U),X>w[k].level&&(w[k].level=X),z==="remote"&&(w[k].remoteUidCount+=1),w[k].totalTs=(O=T.get(k))!==null&&O!==void 0?O:0):w[k]={value:U,level:X,remoteUidCount:z==="local"?0:1,totalTs:(b=T.get(k))!==null&&b!==void 0?b:0}}return Object.keys(w).map(k=>{let{level:U,value:X,totalTs:z}=w[k];return{id:k,level:U,value:X,totalTs:z}})}(l,e);let p=Date.now(),_=p>a?p:a+1;(n=this.requestUpload)===null||n===void 0||n.call(this,ur.EXTENSION_USAGE_STATS,{usageStats:c,sendTs:_})},P("EXTENSION_USAGE_UPLOAD_INTERVAL"))}startUploadUplinkStats(){this.uploadUnplinkStarted||(this.uploadUnplinkStarted=!0,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkStatsUploadInterval=window.setInterval(()=>{var e;let t=(e=this.requestStats)===null||e===void 0?void 0:e.call(this);t&&(this.uploadUplinkStats(t),this.lastStats=t)},3e3),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkRelatedStatsUploadInterval=window.setInterval(()=>{var e;let t=(e=this.requestStats)===null||e===void 0?void 0:e.call(this);t&&this.uploadRelatedUplinkStats(t,this.lastStats),this.lastStats=t},1e3),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval=window.setInterval(()=>{var e;let t=(e=this.requestAllTracks)===null||e===void 0?void 0:e.call(this);t&&this.uploadDenoiserStats(t)},2e3),this.uplinkExtensionStatsUploadInterval&&window.clearInterval(this.uplinkExtensionStatsUploadInterval),this.uplinkExtensionStatsUploadInterval=window.setInterval(()=>{var e;let t=(e=this.requestAllTracks)===null||e===void 0?void 0:e.call(this);t&&this.uploadExtensionStats(t)},2e3))}uploadUplinkStats(e){var t;(((t=this.requestLocalMedia)===null||t===void 0?void 0:t.call(this))||[]).forEach(r=>{let[n,{track:a,ssrcs:c}]=r;switch(n){case $.LocalVideoLowTrack:case $.LocalVideoTrack:{let l=function(p,_,E){var T;let w=_.videoSend.find(O=>O.ssrc===p);if(!w)return null;let C={id:at(10,""),timestamp:new Date(_.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:w.ssrc.toString()};switch(C.A_vstd=E._originMediaStreamTrack&&!E._originMediaStreamTrack.enabled||E._mediaStreamTrack&&!E._mediaStreamTrack.enabled?"1":"0",w.sentFrame&&(C.A_fhs=w.sentFrame.height.toString(),C.A_frs=w.sentFrame.frameRate.toString(),C.A_fws=w.sentFrame.width.toString()),w.adaptionChangeReason){case"none":C.A_ac="0";break;case"cpu":C.A_ac="1";break;case"bandwidth":C.A_ac="2";break;case"other":C.A_ac="3"}return C.A_lvps=ug[E._player?E._player.videoElementStatus:"uninit"].toString(),C.A_nr=(T=w.nacksCount)===null||T===void 0?void 0:T.toString(),w.avgEncodeMs&&(C.A_aem=w.avgEncodeMs.toFixed(0).toString()),P("P2P")&&(w.bytes&&(C.bytesSent=w.bytes.toString()),typeof w.packetsLost=="number"&&(C.packetsLost=w.packetsLost.toString()),w.packets&&(C.packetsSent=w.packets.toString())),C}(c[0].ssrcId,e,a),u=n===$.LocalVideoTrack?function(p,_,E){var T,w,C,O,b,k,U,X;let z=_.videoSend.find(ne=>ne.ssrc===p);if(!z)return null;let j={id:at(10,""),timestamp:new Date(_.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:z.ssrc.toString()},B=(T=(w=(C=z.inputFrame)===null||C===void 0?void 0:C.height)!==null&&w!==void 0?w:E==null?void 0:E._videoHeight)!==null&&T!==void 0?T:0,W=(O=(b=(k=z.inputFrame)===null||k===void 0?void 0:k.width)!==null&&b!==void 0?b:E==null?void 0:E._videoWidth)!==null&&O!==void 0?O:0,ce=(U=(X=z.inputFrame)===null||X===void 0?void 0:X.frameRate)!==null&&U!==void 0?U:0;return B&&(j.A_fhi=B+""),W&&(j.A_fwi=W+""),ce&&(j.A_fri=ce+""),j}(c[0].ssrcId,e,a):null;l&&In(()=>{var p;return(p=this.requestUpload)===null||p===void 0?void 0:p.call(this,ur.PUBLISH_STATS,{stream_type:n===$.LocalVideoLowTrack?"low":"high",stats:NN(NN({},l),u)})});let h=function(p){let _={id:"bweforvideo",timestamp:new Date(p.timestamp).toISOString(),type:"VideoBwe"};return p.bitrate.retransmit&&(_.A_rb=p.bitrate.retransmit.toString()),p.bitrate.targetEncoded&&(_.A_teb=p.bitrate.targetEncoded.toString()),_.A_aeb=p.bitrate.actualEncoded.toString(),_.A_tb=p.bitrate.transmit.toString(),p.sendBandwidth!==void 0&&(_.A_asb=p.sendBandwidth.toString()),_}(e);h&&setTimeout(()=>{var p;return(p=this.requestUpload)===null||p===void 0?void 0:p.call(this,ur.PUBLISH_STATS,{stream_type:n===$.LocalVideoLowTrack?"low":"high",stats:h})},1e3);break}case $.LocalAudioTrack:{let l=function(u,h,p){let _=h.audioSend.find(T=>T.ssrc===u);if(!_)return null;let E={id:at(10,""),timestamp:new Date(h.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:_.ssrc.toString()};return E.A_astd=p._originMediaStreamTrack&&!p._originMediaStreamTrack.enabled||p._mediaStreamTrack&&!p._mediaStreamTrack.enabled?"1":"0",_.inputLevel?E.A_ail=Math.round(100*_.inputLevel).toString():E.A_ail=Math.round(100*p._source.getAccurateVolumeLevel()).toString(),E.A_apil=Math.round(100*p._source.getAccurateVolumeLevel()).toString(),_.aecReturnLoss&&(E.A_ecrl=Math.round(_.aecReturnLoss).toString()),_.aecReturnLossEnhancement&&(E.A_ecrle=Math.round(_.aecReturnLossEnhancement).toString()),P("P2P")&&(_.bytes&&(E.bytesSent=_.bytes.toString()),typeof _.packetsLost=="number"&&(E.packetsLost=_.packetsLost.toString()),_.packets&&(E.packetsSent=_.packets.toString())),E}(c[0].ssrcId,e,a);l&&In(()=>{var u;return(u=this.requestUpload)===null||u===void 0?void 0:u.call(this,ur.PUBLISH_STATS,{stream_type:"high",stats:l})});break}}})}uploadRelatedUplinkStats(e,t){var r;(((r=this.requestLocalMedia)===null||r===void 0?void 0:r.call(this))||[]).filter(n=>{let[a]=n;return a===$.LocalVideoLowTrack||a===$.LocalVideoTrack}).forEach(n=>{let[a,{ssrcs:c}]=n,l=function(u,h){let p=h.videoSend.find(_=>_.ssrc===u);return p?{mediaType:"video",isVideoMute:!1,frameRateInput:p.inputFrame&&p.inputFrame.frameRate.toString(),frameRateSent:p.sentFrame&&p.sentFrame.frameRate.toString(),googRtt:p.rttMs.toString(),qpSumPerFrame:Math.floor(p.qpSumPerFrame).toString()}:null}(c[0].ssrcId,e);l&&In(()=>{var u;(u=this.requestUpload)===null||u===void 0||u.call(this,ur.PUBLISH_RELATED_STATS,{stream_type:a===$.LocalVideoLowTrack?"low":"high",stats:l})})})}uploadDenoiserStats(e){for(let a=0;a<e.length;a++){let c=e[a];if(c instanceof ga){var t,r,n;let l=(t=(r=c._external).getDenoiserStats)===null||t===void 0?void 0:t.call(r);return void(l&&((n=this.requestUpload)===null||n===void 0||n.call(this,ur.DENOISER_STATS,l)))}}}uploadExtensionStats(e){for(let t=0;t<e.length;t++)e[t].getProcessorStats().forEach(r=>{var n;(n=this.requestUpload)===null||n===void 0||n.call(this,r.type,r.stats)})}stopUploadUplinkStats(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkStatsUploadInterval=void 0,this.uplinkRelatedStatsUploadInterval=void 0,this.uplinkDenoiserStatsUploadInterval=void 0)}startUploadDownlinkStats(){if(this.uploadDownlinkStarted)return;let e;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let t=!1;this.downlinkStatsUploadInterval=window.setInterval(()=>{var r;let n=(r=this.requestStats)===null||r===void 0?void 0:r.call(this,!0);n&&(this.uploadDownlinkStats(n,t,e),e=n),t=!t},3e3),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkRelatedStatsUploadInterval=window.setInterval(()=>{var r;let n=(r=this.requestStats)===null||r===void 0?void 0:r.call(this,!0);n&&(this.uploadRelatedDownlinkStats(n,this.lastStats),this.lastStats=n)},1e3),this.downlinkExtensionStatsUploadInterval&&window.clearInterval(this.downlinkExtensionStatsUploadInterval),this.downlinkExtensionStatsUploadInterval=window.setInterval(()=>{var r;let n=(r=this.requestRemoteMedia)===null||r===void 0?void 0:r.call(this);n&&this.uploadDownlinkExtensionStats(n)},2e3)}uploadDownlinkStats(e,t,r){var n;(((n=this.requestRemoteMedia)===null||n===void 0?void 0:n.call(this))||[]).forEach(a=>{let[c,l]=a;if(l.has(fe.VIDEO)&&c.videoTrack){let u=c.videoTrack?function(h,p,_,E,T){let w=p.videoRecv.find(k=>k.ssrc===h);if(!w)return null;let C={id:at(10,""),timestamp:new Date(p.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:w.ssrc.toString()};var O,b;if(C.bytesReceived=w.bytes.toString(),C.packetsLost=w.packetsLost.toString(),C.packetsReceived=w.packets.toString(),w.framesRateFirefox&&(C.A_frr=w.framesRateFirefox.toString()),w.receivedFrame?(C.A_frr=w.receivedFrame.frameRate.toString(),C.A_fhr=w.receivedFrame.height.toString(),C.A_fwr=w.receivedFrame.width.toString()):(C.A_fhr=(O=E._videoHeight)===null||O===void 0?void 0:O.toString(),C.A_fwr=(b=E._videoWidth)===null||b===void 0?void 0:b.toString()),C.A_frd=w.decodeFrameRate.toString(),w.outputFrame&&(C.A_fro=w.outputFrame.frameRate.toString()),w.jitterBufferMs!==void 0&&(C.A_jbm=Math.floor(w.jitterBufferMs).toString()),w.currentDelayMs!==void 0&&(C.A_cdm=Math.floor(w.currentDelayMs).toString()),C.A_fs=w.firsCount.toString(),C.A_ns=w.nacksCount.toString(),C.A_ps=w.plisCount.toString(),E&&(C.A_vrtd=E._originMediaStreamTrack.enabled&&E._mediaStreamTrack.enabled?"0":"1"),E._player&&E._player.freezeTimeCounterList.length>0&&(C.A_vrft=Math.round(E._player.freezeTimeCounterList.splice(0,1)[0]).toString()),T&&E._player&&xs.visibility==="visible"){let k=Math.min(6e3,E._player.renderFreezeAccTime);C.A_vrrft=Math.round(k).toString(),E._player.renderFreezeAccTime=Math.max(0,E._player.renderFreezeAccTime-k)}if(C.A_rvps=ug[E._player?E._player.videoElementStatus:"uninit"].toString(),_){let k=_.videoRecv.find(U=>U.ssrc===h);if(k&&w.totalInterFrameDelay!==void 0&&w.totalSquaredInterFrameDelay!==void 0&&k.totalInterFrameDelay!==void 0&&k.totalSquaredInterFrameDelay!==void 0){let U=w.totalInterFrameDelay-k.totalInterFrameDelay,X=w.totalSquaredInterFrameDelay-k.totalSquaredInterFrameDelay,z=w.framesDecodeCount-k.framesDecodeCount,j=U/z*1e3,B=Math.round(1e3*Math.sqrt((X-Math.pow(U,2)/z)/z));!isNaN(B)&&j+B>Math.max(3*j,j+150)&&(C.A_ifdsd=B.toString())}}return C}(c._videoSSRC,e,r,c.videoTrack,t):void 0;u&&In(()=>{var h;return(h=this.requestUpload)===null||h===void 0?void 0:h.call(this,ur.SUBSCRIBE_STATS,{stream_id:c.uid,stats:u})})}if(l.has(fe.AUDIO)&&c.audioTrack){let u=c.audioTrack?function(h,p,_,E){let T=p.audioRecv.find(C=>C.ssrc===h);if(!T)return null;let w={id:at(10,""),timestamp:new Date(p.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:T.ssrc.toString()};if(w.bytesReceived=T.bytes.toString(),w.packetsLost=T.packetsLost.toString(),w.packetsReceived=T.packets.toString(),T.outputLevel?w.A_aol=Math.round(100*T.outputLevel).toString():w.A_aol=Math.round(100*E._source.getAccurateVolumeLevel()).toString(),w.A_apol=Math.round(100*E._source.getAccurateVolumeLevel()).toString(),E&&(w.A_artd=E._originMediaStreamTrack.enabled&&E._mediaStreamTrack.enabled?"0":"1"),w.A_jr=T.jitterMs.toString(),w.A_jbm=Math.floor(T.jitterBufferMs).toString(),w.A_cdm=Math.floor(T.jitterBufferMs).toString(),w.A_raps=ug[Cr.getPlayerState(E.getTrackId())].toString(),_){let C=_.audioRecv.find(O=>O.ssrc===h);if(C){let O=T.concealedSamples-C.concealedSamples;O>0&&(w.A_cs=Math.round(O).toString())}}return w}(c._audioSSRC,e,r,c.audioTrack):void 0;u&&In(()=>{var h;return(h=this.requestUpload)===null||h===void 0?void 0:h.call(this,ur.SUBSCRIBE_STATS,{stream_id:c.uid,stats:u})})}})}uploadRelatedDownlinkStats(e,t){var r;(((r=this.requestRemoteMedia)===null||r===void 0?void 0:r.call(this))||[]).forEach(n=>{let[a,c]=n;if(c.has(fe.VIDEO)&&a.videoTrack){var l;let u=(a._videoSSRC&&((l=this.requestVideoIsReady)===null||l===void 0?void 0:l.call(this,a._videoSSRC))||!1)===!0,h=function(p,_,E,T,w,C){let O=E.videoRecv.find(X=>X.ssrc===p),b=w?w.videoRecv.find(X=>X.ssrc===p):void 0;if(!O)return null;let k=il.isRemoteVideoFreeze(C,O,b)&&_,U={mediaType:"video",isVideoMute:!1,peerId:T,frameRateReceived:O.receivedFrame&&O.receivedFrame.frameRate.toString(),frameRateDecoded:O.decodedFrame&&O.decodedFrame.frameRate.toString(),isFreeze:k,bytesReceived:O.bytes.toString(),packetsReceived:O.packets.toString(),packetsLost:O.packetsLost.toString(),qpSumPerFrame:Math.floor(O.qpSumPerFrame).toString()};return O.framesRateFirefox&&(U.frameRateDecoded=O.framesRateFirefox.toString(),U.frameRateReceived=O.framesRateFirefox.toString()),U}(a._videoSSRC,u,e,a.uid,t,a.videoTrack);h&&In(()=>{var p;(p=this.requestUpload)===null||p===void 0||p.call(this,ur.SUBSCRIBE_RELATED_STATS,{stream_id:a.uid,stats:h})})}if(c.has(fe.AUDIO)&&a.audioTrack){let u=function(h,p,_,E){let T=p.audioRecv.find(C=>C.ssrc===h);if(!T)return null;let w=il.isRemoteAudioFreeze(E);return{mediaType:"audio",isAudioMute:!1,peerId:_,googJitterReceived:T.jitterMs.toString(),isFreeze:w,bytesReceived:T.bytes.toString(),packetsReceived:T.packets.toString(),packetsLost:T.packetsLost.toString(),frameReceived:T.receivedFrames.toString(),frameDropped:T.droppedFrames.toString()}}(a._audioSSRC,e,a.uid,a.audioTrack);u&&In(()=>{var h;(h=this.requestUpload)===null||h===void 0||h.call(this,ur.SUBSCRIBE_RELATED_STATS,{stream_id:a.uid,stats:u})})}})}stopUploadDownlinkStats(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkStatsUploadInterval=void 0,this.downlinkRelatedStatsUploadInterval=void 0)}stopUploadTransportStats(){this.uploadTransportStarted&&(this.uploadTransportStarted=!1,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=void 0)}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval),this.extensionUsageStatsUploadInterval=void 0)}uploadDownlinkExtensionStats(e){e.forEach(t=>{let[r,n]=t;n.has(fe.VIDEO)&&r.videoTrack&&r.videoTrack.getProcessorStats().forEach(a=>{var c;(c=this.requestUpload)===null||c===void 0||c.call(this,a.type,a.stats)}),n.has(fe.AUDIO)&&r.audioTrack&&r.audioTrack.getProcessorStats().forEach(a=>{var c;(c=this.requestUpload)===null||c===void 0||c.call(this,a.type,a.stats)})})}}function DN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Oa(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?DN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):DN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function PN(i){var e,t,r,n=2;for(typeof Symbol<"u"&&(t=$0,r=Symbol.iterator);n--;){if(t&&(e=i[t])!=null)return e.call(i);if(r&&(e=i[r])!=null)return new zp(e.call(i));t="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function zp(i){function e(t){if(Object(t)!==t)return F.reject(new TypeError(t+" is not an object."));var r=t.done;return F.resolve(t.value).then(function(n){return{value:n,done:r}})}return zp=function(t){this.s=t,this.n=t.next},zp.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var r=this.s.return;return r===void 0?F.resolve({value:t,done:!0}):e(r.apply(this.s,arguments))},throw:function(t){var r=this.s.return;return r===void 0?F.reject(t):e(r.apply(this.s,arguments))}},new zp(i)}class di extends mt{get state(){return this._state}set state(e){let t=this._state;this._state=e,this.emit(ye.StateChange,t,this._state)}constructor(e,t){super(),g(this,"store",void 0),g(this,"statsUploader",void 0),g(this,"connection",void 0),g(this,"localTrackMap",new Map),g(this,"remoteUserMap",new Map),g(this,"localDataChannels",[]),g(this,"remoteDataChannelMap",new Map),g(this,"pendingLocalTracks",[]),g(this,"pendingRemoteTracks",[]),g(this,"pendingLocalDataChannels",[]),g(this,"pendingRemoteDataChannels",[]),g(this,"statsCollector",void 0),g(this,"isPlanB",!1),g(this,"shouldForwardP2PCreation",void 0),g(this,"iceFailedCount",0),g(this,"dtlsFailedCount",0),g(this,"mutex",new si("P2PChannel-mutex")),g(this,"_state",Ke.Disconnected),g(this,"_pcStatsUploadType",P("NEW_ICE_RESTART")?Yn.FIRST_CONNECTION:Yn.OLD_FIRST_CONNECTION),g(this,"_isInRestartIce",!1),g(this,"_isStartRestartIce",!1),g(this,"_restartStates",["disconnected","failed"]),g(this,"_restartTimer",void 0),g(this,"_isFirstConnected",!0),g(this,"handleMuteLocalTrack",async(r,n,a)=>{let c=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Ke.Connected)return void a(new Y(A.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));let l=this.filterTobeMutedTracks(r);if(l.length===0)return void n();let u=l.find(p=>p[0]==="videoLowTrack");u&&u[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(l.map(p=>{let[,{id:_}]=p;return _}));let h=this.createMuteMessage(l);await st(this,ye.RequestMuteLocal,h),n()}catch(l){a(l)}finally{c()}}),g(this,"handleUnmuteLocalTrack",async(r,n,a)=>{let c=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Ke.Connected)return void a(new Y(A.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));let l=this.filterTobeUnmutedTracks(r);if(l.length===0)return void n();let u=l.find(p=>p[0]==="videoLowTrack");if(u){let p=u[1];if(p.track._originMediaStreamTrack.stop(),!P("DISABLE_DUAL_STREAM_USE_ENCODING")&&ct().supportDualStreamEncoding){let _=r._mediaStreamTrack.clone();p.track._mediaStreamTrack=_,p.track._originMediaStreamTrack=_}else{let _=lS(r,Ms(this,ye.RequestLowStreamParameter));p.track._mediaStreamTrack=_,p.track._originMediaStreamTrack=_}await new F((_,E)=>{this.handleReplaceTrack(p.track,_,E,!0)})}await this.connection.unmuteLocal(l.map(p=>{let[,{id:_}]=p;return _}));let h=this.createUnmuteMessage(l);await st(this,ye.RequestUnmuteLocal,h),n()}catch(l){a(l)}finally{c()}}),g(this,"handleUpdateVideoEncoder",async(r,n,a)=>{let c=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{let l=this.localTrackMap.get($.LocalVideoTrack);if(!this.connection||!l||l.track!==r||this.state!==Ke.Connected)return void n();let{id:u,track:h}=l;await this.connection.updateSendParameters(u,h),await this.connection.updateEncoderConfig(u,h),this.emit(ye.UpdateVideoEncoder,h),n()}catch(l){a(l)}finally{c()}}),g(this,"handleSetOptimizationMode",async(r,n,a)=>{let c=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{let l=this.localTrackMap.get($.LocalVideoTrack);if(!this.connection||!l||l.track!==r||this.state!==Ke.Connected)return;let{id:u,track:h}=l;await this.connection.updateSendParameters(u,h),n()}catch(l){a(l)}finally{c()}}),g(this,"handleReplaceTrack",async(r,n,a,c)=>{let l;S.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(r.getTrackId(),"]")),typeof c=="boolean"&&c||(l=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var u;let p=Array.from(this.localTrackMap.entries()).find(_=>{let[,{track:E}]=_;return r===E});if(!this.connection||!p||this.state!==Ke.Connected)return void n();if(await((u=this.connection)===null||u===void 0?void 0:u.replaceTrack(r,p[1].id)),this.isPlanB){let _=p[1];_.id=r._mediaStreamTrack.id,this.localTrackMap.set(p[0],_)}if(p[0]===$.LocalVideoTrack&&!P("DISABLE_DUAL_STREAM_USE_ENCODING")&&ct().supportDualStreamEncoding){let _=this.localTrackMap.get($.LocalVideoLowTrack);if(_){let E=r._mediaStreamTrack.clone();_.track._originMediaStreamTrack.stop(),_.track._mediaStreamTrack=E,_.track._originMediaStreamTrack=E,await new F((T,w)=>{this.handleReplaceTrack(_.track,T,w,!0)})}}n()}catch(p){a(p)}finally{var h;(h=l)===null||h===void 0||h()}}),g(this,"handleGetRTCStats",r=>{r(this.statsCollector.getRTCStats())}),g(this,"handleGetLocalVideoStats",r=>{r(this.statsCollector.getLocalVideoTrackStats())}),g(this,"handleGetLocalAudioStats",r=>{r(this.statsCollector.getLocalAudioTrackStats())}),g(this,"handleGetRemoteVideoStats",r=>this.statsCollector.getRemoteVideoTrackStats(r.uid)[r.uid]),g(this,"handleGetRemoteAudioStats",r=>this.statsCollector.getRemoteAudioTrackStats(r.uid)[r.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new bN,this.bindStatsUploaderEvents(),this.isPlanB=!ct().supportUnifiedPlan||P("CHROME_FORCE_PLAN_B")&&la(),this.shouldForwardP2PCreation=P("FORWARD_P2P_CREATION")&&ct().supportPCSetConfiguration&&function(){let r=kh();return r===Jt.ANDROID||r===Jt.IOS||r===Jt.HARMONY_OS}(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Yt({},this.store):this.isPlanB?new li({},this.store):new zt({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var r;this.state=Ke.New;let n=this.shouldForwardP2PCreation&&((r=this.connection)===null||r===void 0?void 0:r.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!n||(n&&this.connection&&(S.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new Yt(e,this.store):this.isPlanB?new li(e,this.store):new zt(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new Y(A.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=P("NEW_ICE_RESTART")?Yn.FIRST_CONNECTION:Yn.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,r,n,a,c){if(!this.connection)throw new Y(A.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof Yt?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(e,t,r,n,a,c),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Ke.Connected)}updateRemoteRTPCapabilities(e){let t=Array.from(this.localTrackMap.entries()).filter(r=>{var n;let[a]=r;return ge(n=[$.LocalVideoLowTrack,$.LocalVideoTrack]).call(n,a)}).map(r=>{let[,{id:n}]=r;return n});if(this.connection instanceof zt){if(!ge(e).call(e,this.store.codec)){let r=["vp8","h264"].find(n=>ge(e).call(e,n));r&&(this.store.codec=r,S.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(t,e)}}async preConnect(e,t,r,n,a,c){if(!this.connection)throw new Y(A.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();let l=await this.connection.connect(e,t,r,n,a,c);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Ke.Connected,l}getEstablishParams(){if(this.connection instanceof Yt)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection){if(this.state===Ke.Disconnected)throw new Y(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");let r=e.filter(n=>this.pendingLocalDataChannels.findIndex(a=>a.id===n.id)!==-1);return void(this.pendingLocalDataChannels=this.pendingLocalDataChannels.concat(r))}let t=this.filterTobePublishedDataChannels(e);t.length!==0&&(t.forEach(r=>{let n=Date.now();this.store.publish(r.id.toString(),"datachannel",n)}),await this.connection.createDataChannels(this.store.uid,t),t.forEach(r=>{this.localDataChannels.push(r);let n=Date.now();this.store.publish(r.id+"","datachannel",void 0,n)}))}publish(e,t,r){var n=this;return dn(function*(){let a=yield Ye(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==Ke.Connected){if(n.state===Ke.Disconnected)throw new Y(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(e);let l=e.filter(u=>n.pendingLocalTracks.indexOf(u)===-1);return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(l))}n.store.pubId=n.store.pubId+1,Ii.markPublishStart(n.store.clientId,n.store.pubId);let c=n.filterTobePublishedTracks(e,t,r);if(c.length===0)return void(yield Ye(n.tryToUnmuteAudio(e)));yield*Up(PN(n.doPublish(n.connection,c)))}finally{a()}})()}doPublish(e,t){var r=this;return dn(function*(){t.forEach(p=>{let{track:_,type:E}=p,T=Date.now();r.store.publish(_.getTrackId(),E===$.LocalAudioTrack?"audio":"video",T)}),r.bindLocalTrackEvents(t);let n=yield Ye(e.send(t.map(p=>{let{track:_}=p;return _}),r.store.codec,r.store.audioCodec)),a=(yield Ye(n.next())).value,c=r.createGatewayPublishMessage(t,a),l;try{l=yield c}catch(p){throw n.throw(p),(p==null?void 0:p.code)===A.WS_ABORT&&t.forEach(_=>{let{track:E}=_;r.pendingLocalTracks.indexOf(E)===-1&&r.pendingLocalTracks.push(E)}),r.unbindLocalTrackEvents(t),p}let u=r.mapPubResToRemoteConfig(c,l),h=(yield Ye(n.next(u))).value;t.forEach(p=>{let{type:_}=p;r.statsCollector.addLocalStats(_)}),r.assignLocalTracks(t,h),r.statsUploader.startUploadUplinkStats(),t.forEach(p=>{let{track:_,type:E}=p,T=Date.now();r.store.publish(_.getTrackId(),E===$.LocalAudioTrack?"audio":"video",void 0,T)})})()}async updateVideoStreamParameter(e,t){let r=this.localTrackMap.get(t);if(!r)return;if(!(r.track instanceof ke))return S.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof zt||this.connection instanceof li))return S.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");let{track:n}=r,a=function(c,l){let u={};return c.height&&c.width&&(u.scaleResolutionDownBy=zg(c,l)),u.maxFramerate=c.framerate?qr(c.framerate):void 0,u.maxBitrate=c.bitrate?1e3*c.bitrate:void 0,u}(e,n);if(n._encoderConfig||(n._encoderConfig={}),t!==$.LocalVideoLowTrack||!P("DISABLE_DUAL_STREAM_USE_ENCODING")&&ct().supportDualStreamEncoding)a.scaleResolutionDownBy!=null&&(n._encoderConfig.scaleResolutionDownBy=a.scaleResolutionDownBy);else{let c=n._originMediaStreamTrack;if(!c.canvas)return S.warn("[".concat(n.getTrackId(),"] no canvas on track"));(function(l,u){let h=l.canvas;u.width&&(h.width=qr(u.width)),u.height&&(h.height=qr(u.height)),u.framerate&&(h.stopCapture&&h.stopCapture(),h.stopCapture=pg(()=>{!h.startCapture&&h.stopCapture&&h.stopCapture(),h.startCapture&&h.startCapture()},qr(u.framerate)))})(c,e)}a.maxBitrate!=null&&(n._encoderConfig.bitrateMax=a.maxBitrate/1e3),a.maxFramerate!=null&&(n._encoderConfig.frameRate&&typeof n._encoderConfig.frameRate=="object"?n._encoderConfig.frameRate.max=a.maxFramerate:n._encoderConfig.frameRate={max:a.maxFramerate}),S.debug("[".concat(n.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(n._encoderConfig))),await this.connection.updateRtpSenderEncodings(n)}publishLowStream(e){var t=this;return dn(function*(){if(!t.connection||t.state!==Ke.Connected)return;let r=yield Ye(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{let a=t.localTrackMap.get($.LocalVideoTrack);if(!a)throw new Y(A.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has($.LocalVideoLowTrack))throw new Y(A.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));let c=[{track:t.getLowVideoTrack(a.track,e),type:$.LocalVideoLowTrack}];if(yield*Up(PN(t.doPublish(t.connection,c))),a.track.muted||!a.track.enabled){var n;let l=(n=t.localTrackMap.get($.LocalVideoLowTrack))===null||n===void 0?void 0:n.id;l!==void 0&&(yield Ye(t.connection.muteLocal([l])))}}finally{r()}})()}async republish(){this.pendingLocalTracks.length>0&&(S.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await vt(this,ye.RequestRePublish,this.pendingLocalTracks),this.emit(ye.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(S.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await vt(this,ye.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){let{user:r,kind:n}=this.pendingRemoteTracks[t];(n!==fe.AUDIO||r._audio_added_&&r._audioSSRC)&&(n!==fe.VIDEO||r._video_added_&&r._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await vt(this,ye.RequestReSubscribe,this.pendingRemoteTracks);else for(let{user:t,kind:r}of this.pendingRemoteTracks)await this.subscribe(t,r,r===fe.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach(t=>{let{user:r}=t;this.emit(ye.MediaReconnectEnd,r.uid)}),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==Ke.Connected)return void e.forEach(n=>{let a=this.pendingLocalTracks.indexOf(n);a!==-1&&this.pendingLocalTracks.splice(a,1)});let t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;let r=t.find(n=>n[0]==="videoLowTrack");return r&&r[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==Ke.Connected)return void e.forEach(r=>{let n=this.pendingLocalDataChannels.indexOf(r);n!==-1&&this.pendingLocalDataChannels.splice(n,1)});let t=this.filterTobeUnpublishedDataChannels(e);return t.length!==0?(t.forEach(r=>{let n=this.localDataChannels.indexOf(r);n!==-1&&this.localDataChannels.splice(n,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),t.map(r=>r.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Ke.Connected)return;let e=this.localTrackMap.get($.LocalVideoLowTrack);if(!e)return;e.track.close();let t=[[$.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){let r=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map(n=>{let[,{id:a}]=n;return a})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(n=>{let[a,{track:c}]=n;return{type:a,track:c}})),t.forEach(n=>{let[a]=n;this.statsCollector.removeLocalStats(a)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadUplinkStats(),r}async subscribeDataChannel(e,t){if(!this.connection||this.state!==Ke.Connected)throw new Y(A.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");let r=t.filter(n=>{var a;return!((a=this.remoteDataChannelMap.get(e))!==null&&a!==void 0&&a.get(n.id))});if(r.length!==0)return await this.connection.createDataChannels(e.uid,r),r.forEach(n=>{var a;this.remoteDataChannelMap.has(e)?(a=this.remoteDataChannelMap.get(e))===null||a===void 0||a.set(n.id,n):this.remoteDataChannelMap.set(e,new Map([[n.id,n]]));let c=this.pendingRemoteDataChannels.findIndex(l=>{let{user:u,id:h}=l;return u.uid===e.uid&&h===n.id});c!==-1&&this.pendingRemoteDataChannels.splice(c,1)}),r.map(n=>n.id)}async subscribe(e,t,r,n,a){var c;if(!this.connection||this.state!==Ke.Connected)throw new Y(A.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((c=this.remoteUserMap.get(e))!==null&&c!==void 0&&c.has(t))return;let l,u,h;if(a){let E=a.find(w=>{let{stream_type:C}=w;return C===t});if(!E)throw new Y(A.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));let T=await this.connection.receive(t,E.ssrcs,String(e._uintid),E.attributes);this.connection instanceof zt&&(h=T.transceiver),l=T.track,u=T.id}else{let E=await this.connection.receive(t,[{ssrcId:r,rtx:n}],String(e._uintid),void 0);this.connection instanceof zt&&(h=E.transceiver),l=E.track,u=E.id}t===fe.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(l):(e._audioTrack=new On(l,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),h&&e._audioTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(l):(e._videoTrack=new _s(l,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),h&&e._videoTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(e,e._videoTrack));let p=this.remoteUserMap.get(e);p?p.set(t,u):this.remoteUserMap.set(e,new Map([[t,u]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadDownlinkStats();let _=this.pendingRemoteTracks.findIndex(E=>{let{user:T,kind:w}=E;return T.uid===e.uid&&t===w});_!==-1&&(this.pendingRemoteTracks.splice(_,1),this.emit(ye.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==Ke.Connected)throw new Y(A.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter(r=>{var n;let{user:a,mediaType:c}=r;return!((n=this.remoteUserMap.get(a))!==null&&n!==void 0&&n.has(c))});let t=await this.connection.batchReceive(e.map(r=>{let{user:n,mediaType:a,ssrcId:c,rtxSsrcId:l}=r;return{kind:a,ssrcMsg:[{ssrcId:c,rtx:l}],mslabel:String(n._uintid)}}));e.forEach((r,n)=>{let{user:a,mediaType:c}=r,{track:l,id:u,transceiver:h}=t[n];c===fe.AUDIO?(a._audioTrack?a._audioTrack._updateOriginMediaStreamTrack(l):(a._audioTrack=new On(l,a.uid,a._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(a._audioTrack.getTrackId()))),h&&a._audioTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(a,a._audioTrack)):(a._videoTrack?a._videoTrack._updateOriginMediaStreamTrack(l):(a._videoTrack=new _s(l,a.uid,a._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(a._videoTrack.getTrackId()))),h&&a._videoTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(a,a._videoTrack));let p=this.remoteUserMap.get(a);p?p.set(c,u):this.remoteUserMap.set(a,new Map([[c,u]])),this.statsCollector.addRemoteStats(a.uid),this.statsUploader.startUploadDownlinkStats();let _=this.pendingRemoteTracks.findIndex(E=>{let{user:T,kind:w}=E;return T.uid===a.uid&&c===w});_!==-1&&(this.pendingRemoteTracks.splice(_,1),this.emit(ye.MediaReconnectEnd,a.uid))})}async unsubscribe(e,t,r){let n=this.pendingRemoteTracks.filter(l=>{let{user:u,kind:h}=l;return t!==void 0?u.uid===e.uid&&t===h:u.uid===e.uid});if(n.forEach(l=>{let u=this.pendingRemoteTracks.indexOf(l);this.pendingRemoteTracks.splice(u,1)}),this.connection&&this.state===Ke.Connected||r||n.forEach(l=>{let{kind:u}=l;var h;if(u===fe.AUDIO)(h=e._audioTrack)===null||h===void 0||h._destroy(),e._audioTrack=void 0;else if(u===fe.VIDEO){var p;(p=e._videoTrack)===null||p===void 0||p._destroy(),e._videoTrack=void 0}}),!this.connection||this.state!==Ke.Connected)return;let a=this.filterTobeUnSubscribedTracks(e,t);if(a.length===0)return;await this.connection.stopReceiving(a.map(l=>{let[,{id:u}]=l;return u}));let c=this.createUnsubscribeMessage(a);return this.withdrawRemoteTracks(a),this.remoteUserMap.size===0&&this.statsUploader.stopUploadDownlinkStats(),a.forEach(l=>{let[u,{kind:h}]=l;var p,_;if(h===fe.VIDEO&&u._videoSSRC&&((p=this.connection)===null||p===void 0||p.setStatsRemoteVideoIsReady(u._videoSSRC,!1)),h===fe.VIDEO)this.unbindRemoteTrackEvents(u._videoTrack),r||((_=u._videoTrack)===null||_===void 0||_._destroy(),u._videoTrack=void 0);else if(h===fe.AUDIO){var E;this.unbindRemoteTrackEvents(u._audioTrack),!r&&((E=u._audioTrack)===null||E===void 0||E._destroy(),u._audioTrack=void 0)}}),c}async unsubscribeDataChannel(e,t){if(t.forEach(a=>{let c=this.pendingRemoteDataChannels.findIndex(l=>l.id===a.id);c!==-1&&this.pendingRemoteDataChannels.splice(c,1)}),!this.connection)return;let r=this.filterTobeUnSubscribedDataChannels(e,t);if(r.length===0)return;t.forEach(a=>{a._close()});let n=this.remoteDataChannelMap.get(e);return r.forEach(a=>{n&&n.delete(a.id)}),n&&n.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),r.map(a=>a.id)}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(let{user:a,mediaType:c}of e){let l=this.pendingRemoteTracks.filter(u=>{let{user:h,kind:p}=u;return c!==void 0?h.uid===a.uid&&c===p:h.uid===a.uid});l.forEach(u=>{let h=this.pendingRemoteTracks.indexOf(u);this.pendingRemoteTracks.splice(h,1)}),t=t.concat(l)}if(!this.connection||this.state!==Ke.Connected)return void t.forEach(a=>{let{user:c,kind:l}=a;var u;if(l===fe.AUDIO)(u=c._audioTrack)===null||u===void 0||u._destroy(),c._audioTrack=void 0;else if(l===fe.VIDEO){var h;(h=c._videoTrack)===null||h===void 0||h._destroy(),c._videoTrack=void 0}});let r=yo(e).call(e,(a,c)=>{let{user:l,mediaType:u}=c,h=this.filterTobeUnSubscribedTracks(l,u);return a.concat(h)},[]);if(r.length===0)return;await this.connection.stopReceiving(r.map(a=>{let[,{id:c}]=a;return c}));let n=this.createUnsubscribeAllMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadDownlinkStats(),r.forEach(a=>{let[c,{kind:l}]=a;var u,h;if(l===fe.VIDEO&&c._videoSSRC&&((u=this.connection)===null||u===void 0||u.setStatsRemoteVideoIsReady(c._videoSSRC,!1)),l===fe.VIDEO)this.unbindRemoteTrackEvents(c._videoTrack),(h=c._videoTrack)===null||h===void 0||h._destroy(),c._videoTrack=void 0;else if(l===fe.AUDIO){var p;this.unbindRemoteTrackEvents(c._audioTrack),(p=c._audioTrack)===null||p===void 0||p._destroy(),c._audioTrack=void 0}}),n}async muteRemote(e,t){if(!this.connection)return;let r=this.remoteUserMap.get(e);if(!r)return void S.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!r.get(t))return void S.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));let n=t===fe.VIDEO?e._videoSSRC:e._audioSSRC;n!==void 0&&this.connection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;let r=this.remoteUserMap.get(e);if(!r)return void S.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));r.get(t)||S.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){let t=this.localTrackMap.get($.LocalAudioTrack);if((t==null?void 0:t.track)instanceof Vt){let r=t.track;return Array.from(this.localTrackMap.entries()).filter(n=>{let[a]=n;return a!==$.LocalAudioTrack}).filter(n=>{let[a]=n;return!(e&&a===$.LocalVideoLowTrack)}).map(n=>{let[,{track:a}]=n;return a}).concat(r.trackList)}return Array.from(this.localTrackMap.entries()).filter(r=>{let[n]=r;return!(e&&n===$.LocalVideoLowTrack)}).map(r=>{let[,{track:n}]=r;return n})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,r,n,a){if(e){let l=this.localTrackMap.get($.LocalAudioTrack),u=n?this.localTrackMap.get($.LocalVideoLowTrack):this.localTrackMap.get($.LocalVideoTrack);Ee.publish(this.store.sessionId,{eventElapse:Ii.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:l==null?void 0:l.track.getTrackLabel(),videoName:u==null?void 0:u.track.getTrackLabel(),screenshare:(u==null?void 0:u.track._hints.indexOf(ut.SCREEN_TRACK))!==-1,audio:!!l,video:!!u,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:a})}else{var c;r||(r=[]);let l=r.find(h=>h instanceof Qe),u=n?(c=this.localTrackMap.get($.LocalVideoTrack))===null||c===void 0?void 0:c.track:r.find(h=>h instanceof ke);Ee.publish(this.store.sessionId,{eventElapse:Ii.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:l==null?void 0:l.getTrackLabel(),videoName:u==null?void 0:u.getTrackLabel(),screenshare:(u==null?void 0:u._hints.indexOf(ut.SCREEN_TRACK))!==-1,audio:!!l,video:!!u,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:a})}}reportSubscribeEvent(e,t,r,n){let a=n===fe.VIDEO?r._videoSSRC:r._audioSSRC;a&&Ee.subscribe(this.store.sessionId,{succ:e,ec:t,video:n===fe.VIDEO,audio:n===fe.AUDIO,peerid:r.uid,subscribeRequestid:n===fe.VIDEO?r._videoSSRC:r._audioSSRC,p2pid:this.store.p2pId,eventElapse:Ii.measureFromSubscribeStart(this.store.clientId,a)})}reset(){S.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new si("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Yt({},this.store):this.isPlanB?new li({},this.store):new zt({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let e=this.localTrackMap.get($.LocalAudioTrack);if((e==null?void 0:e.track)instanceof Vt){if(e.track.trackList.length>0){let t=e.track;e.track.trackList.forEach(r=>{t.removeAudioTrack(r)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Ke.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.connection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){let e=this.localTrackMap.get($.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){let e=this.localTrackMap.get($.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){let t=this.localTrackMap.get(e);return t&&t.track instanceof ke||t&&t.track instanceof Qe?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;let r=this.remoteUserMap.get(e);return!!r&&(!t||r.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;let r=this.remoteUserMap.get(e);return!!r&&(!t||r.has(t))}getRemoteMedia(e){var t;let r=Array.from(Ur(t=this.remoteUserMap).call(t)).find(n=>n.uid===e);return r?{audioTrack:r.audioTrack,audioSSRC:r._audioSSRC,videoTrack:r.videoTrack,videoSSRC:r._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(r=>{let[n]=r;return{uid:n.uid,level:n.audioTrack?100*n.audioTrack._source.getAccurateVolumeLevel():0}}),t=this.localTrackMap.get($.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=td(e).call(e,(r,n)=>r.level-n.level),e}async disconnectForReconnect(){this.connection&&(S.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Ke.Reconnecting,P("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var r;t._videoTrack&&t._videoTrack._player&&((r=t._videoTrack._player.getVideoElement())===null||r===void 0||r.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Yt({},this.store):this.isPlanB?new li({},this.store):new zt({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[r,{track:n}]=e;switch(r){case $.LocalVideoTrack:ge(t=n._hints).call(t,ut.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case $.LocalAudioTrack:n instanceof Vt?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case $.LocalVideoLowTrack:}}),this.emit(ye.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,r]=e;Array.from(Ur(r).call(r)).forEach(n=>{this.setPendingRemoteMedia(t,n)}),this.emit(ye.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(e=>{this.pendingLocalDataChannels.push(e)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(e=>{let[t,r]=e;Array.from(Ur(r).call(r)).forEach(n=>{this.setPendingRemoteDataChannel(t,n)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),S.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(let r of this.pendingRemoteDataChannels){let{user:n,id:a}=r;if((e instanceof wi?e.uid:e)===n.uid&&a===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(let r of this.pendingRemoteTracks){let{user:n,kind:a}=r;if((e instanceof wi?e.uid:e)===n.uid&&t===a)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return dn(function*(){if(!t.connection||t.state!==Ke.Connected||t.connection instanceof Yt)return;let r=yield Ye(t.mutex.lock("From P2PChannel.restartICE")),n;try{n=yield Ye(t.connection.restartICE(e));let c=yield Ye(n.next());if(c.done)return;let l=c.value,u=yield l;switch(t.reportPCDisconnectedOrFailed(e),e){case Ci.TCP:t._pcStatsUploadType=Yn.TCP_RESTART;break;case Ci.RELAY:t._pcStatsUploadType=Yn.RELAY_RESTART;break;default:t._pcStatsUploadType=Yn.OLD_RESTART}t._isInRestartIce=!0,n.next(u)}catch(c){var a;(a=n)===null||a===void 0||a.throw(c)}finally{r()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;let e=this.connection.getStats(),t=this.localTrackMap.get($.LocalVideoTrack),r=this.localTrackMap.get($.LocalAudioTrack),n=e.videoSend.find(w=>w.ssrc===(t==null?void 0:t.ssrcs[0].ssrcId)),a=e.audioSend.find(w=>w.ssrc===(r==null?void 0:r.ssrcs[0].ssrcId));if(!n||!a)return 1;let c=cr(this,ye.NeedSignalRTT),l=n?n.rttMs:void 0,u=a?a.rttMs:void 0,h=l&&u?(l+u)/2:l||u,p=(h&&c?(h+c)/2:h||c)||0,_=100*e.sendPacketLossRate*.7/50+.3*p/1500,E=_<.17?1:_<.36?2:_<.59?3:_<.1?4:5,T=t==null?void 0:t.track;if(T&&T._encoderConfig&&T._hints.indexOf(ut.SCREEN_TRACK)===-1){let w=T._encoderConfig.bitrateMax,C=e.bitrate.actualEncoded;if(w&&C){let O=(1e3*w-C)/(1e3*w);return UA[O<.15?0:O<.3?1:O<.45?2:O<.6?3:4][E]}}return E}getDownlinkNetworkQuality(){if(!this.connection)return 0;let e=this.connection.getStats(),t=0;return Array.from(this.remoteUserMap.entries()).forEach(r=>{let[n]=r,a=n._audioSSRC,c=n._videoSSRC,l=e.audioRecv.find(C=>C.ssrc===a),u=e.videoRecv.find(C=>C.ssrc===c);if(!l&&!u)return void(t+=1);let h=cr(this,ye.NeedSignalRTT),p=e.rtt,_=(p&&h?(p+h)/2:p||h)||0,E=l?l.jitterMs:void 0,T=e.recvPacketLossRate,w=.7*T*100/50+.3*_/1500;E&&(w=.6*T*100/50+.2*_/1500+.2*E/400),t+=w<.1?1:w<.17?2:w<.36?3:w<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new F((t,r)=>{this.handleMuteLocalTrack(e,t,r)})}filterTobePublishedTracks(e,t,r){let n=[],a=ct(),c=this.getAllTracks();e=Mc(e=e.filter(h=>c.indexOf(h)===-1));let l=!1,u=!1;for(let h of e){if(h instanceof ke&&(this.localTrackMap.has($.LocalVideoTrack)||l?new Y(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:h,type:$.LocalVideoTrack}),l=!0),t)){let p=this.getLowVideoTrack(h,r);n.push({track:p,type:$.LocalVideoLowTrack})}if(h instanceof Qe){let p=this.localTrackMap.get($.LocalAudioTrack);if(p){if(!(p.track instanceof Vt))throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(h._bypassWebAudio)throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");p.track.addAudioTrack(h),this.bindLocalAudioTrackEvents(h,!0)}else if(u){let _=n.find(E=>{let{type:T}=E;return T===$.LocalAudioTrack});if(!(_.track instanceof Vt))throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(h._bypassWebAudio)throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");_.track.addAudioTrack(h)}else{if(!a.webAudioMediaStreamDest||h instanceof Vt||h._bypassWebAudio)n.push({track:h,type:$.LocalAudioTrack});else{let _=new Vt;_.addAudioTrack(h),n.push({track:_,type:$.LocalAudioTrack})}u=!0}}}return n}filterTobeUnpublishedTracks(e){let t=[],r=this.getAllTracks();e=Mc(e=e.filter(n=>r.indexOf(n)!==-1));for(let n of e){if(n instanceof Qe){let a=this.localTrackMap.get($.LocalAudioTrack);if(!a)continue;a.track instanceof Vt?(a.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),a.track.trackList.length===0&&(t.push([$.LocalAudioTrack,a]),a.track.close())):t.push([$.LocalAudioTrack,a])}if(n instanceof ke){let a=this.localTrackMap.get($.LocalVideoTrack);if(!a)continue;t.push([$.LocalVideoTrack,a]);let c=this.localTrackMap.get($.LocalVideoLowTrack);c&&t.push([$.LocalVideoLowTrack,c])}}return t}filterTobePublishedDataChannels(e){return e=(e=Mc(e)).filter(t=>this.localDataChannels.findIndex(r=>r.id===t.id)===-1)}filterTobeUnpublishedDataChannels(e){return e=(e=(e=Mc(e)).filter(t=>this.localDataChannels.indexOf(t)!==-1)).filter(t=>t._originDataChannel)}bindLocalTrackEvents(e){e.forEach(t=>{let{track:r,type:n}=t;switch(n){case $.LocalVideoTrack:r.addListener(ue.GET_STATS,this.handleGetLocalVideoStats),r.addListener(ue.GET_RTC_STATS,this.handleGetRTCStats),r.addListener(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.addListener(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.addListener(ue.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),r.addListener(ue.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),r.addListener(ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),r.addListener(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.addListener(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case $.LocalAudioTrack:this.bindLocalAudioTrackEvents(r);case $.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof Vt?e.trackList.forEach(r=>{r.addListener(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.addListener(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.addListener(ue.GET_STATS,this.handleGetLocalAudioStats),r.addListener(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.addListener(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(ue.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(ue.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[r,{track:n}]=t;return{track:n,type:r}})),e.forEach(t=>{let{track:r,type:n}=t;switch(n){case $.LocalVideoTrack:r.off(ue.GET_STATS,this.handleGetLocalVideoStats),r.off(ue.GET_RTC_STATS,this.handleGetRTCStats),r.off(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.off(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.off(ue.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),r.off(ue.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),r.off(ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),r.off(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.off(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case $.LocalAudioTrack:this.unbindLocalAudioTrackEvents(r);case $.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof Vt?e.trackList.forEach(t=>{t.off(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ue.GET_STATS,this.handleGetLocalAudioStats),t.off(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(ue.GET_STATS,this.handleGetLocalAudioStats),e.off(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof _s&&t.addListener(ue.GET_STATS,r=>{r(this.handleGetRemoteVideoStats(e))}),t instanceof On&&t.addListener(ue.GET_STATS,r=>{r(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ue.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,r]=e;r.has(fe.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),r.has(fe.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((r,n)=>{var a;let c,l,{track:u,type:h}=r;switch(h){case $.LocalAudioTrack:c=et.Audio,l={dtx:u instanceof ga&&u._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case $.LocalVideoTrack:c=ge(a=u._hints).call(a,ut.SCREEN_TRACK)?et.Screen:et.High,l=Oa(Oa({},Np(u)),{},{codec:this.store.codec});break;case $.LocalVideoLowTrack:c=et.Low,l=Oa(Oa({},Np(u)),{},{codec:this.store.codec})}return{stream_type:c,attributes:l,ssrcs:t[n]}})}createGatewayUnpublishMessage(e){return e.map(t=>{var r;let n,[a,{track:c,ssrcs:l,id:u}]=t;switch(a){case $.LocalVideoTrack:n=ge(r=c._hints).call(r,ut.SCREEN_TRACK)?et.Screen:et.High;break;case $.LocalAudioTrack:n=et.Audio;break;case $.LocalVideoLowTrack:n=et.Low}return{stream_type:n,ssrcs:l,mid:u}})}assignLocalTracks(e,t){e.forEach((r,n)=>{let{track:a,type:c}=r;this.localTrackMap.set(c,{track:a,id:t[n].id,ssrcs:t[n].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[r]=t;this.localTrackMap.delete(r)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(ye.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),P("NEW_ICE_RESTART")){var r;if(ge(r=this._restartStates).call(r,t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;let n=l=>{(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")&&(S.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(l)),cr(this,ye.QueryClientConnectionState)==="CONNECTED"&&this.emit(ye.RequestRestartICE,l))},a=()=>{e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="checking"&&e.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),S.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(ye.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},c=P("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(P("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&ct().supportPCSetConfiguration)n(Ci.RELAY),this._restartTimer=window.setTimeout(a,c);else if(ht())n(Ci.UDP),this._restartTimer=window.setTimeout(a,4e3);else{if(n(Ci.TCP),ct().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{n(Ci.RELAY),this._restartTimer=window.setTimeout(a,c)},c));this._restartTimer=window.setTimeout(a,c)}},800))}}else{if(t==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout(()=>{e.iceConnectionState==="disconnected"&&P("ICE_RESTART")&&cr(this,ye.QueryClientConnectionState)==="CONNECTED"&&this.emit(ye.RequestRestartICE)},800),void setTimeout(()=>{e.peerConnectionState==="disconnected"&&(S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(ye.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);t==="failed"&&(S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(ye.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),Ee.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:St.TRACER}).onSuccess(),this.emit(ye.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var r;let n=Array.from(Ur(r=this.remoteUserMap).call(r)).find(c=>c._audioSSRC===t);var a;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(a=n.audioTrack)===null||a===void 0||a.emit(Oo.FIRST_FRAME_DECODED),Ee.firstRemoteFrame(this.store.sessionId,$t.FIRST_AUDIO_DECODE,Et.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:Ii.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var r;let n=Array.from(Ur(r=this.remoteUserMap).call(r)).find(a=>a._audioSSRC===t);n&&Ee.firstRemoteFrame(this.store.sessionId,$t.FIRST_AUDIO_RECEIVED,Et.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:Ii.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,r,n)=>{this.reportVideoFirstFrameDecoded(t,r,n)},e.onFirstVideoReceived=t=>{var r;let n=Array.from(Ur(r=this.remoteUserMap).call(r)).find(a=>a._videoSSRC===t);n&&Ee.firstRemoteFrame(this.store.sessionId,$t.FIRST_VIDEO_RECEIVED,Et.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:Ii.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,r)=>{let n=t.candidateType==="relay",a=r.candidateType==="relay";r.candidateType!=="unknown"&&n===a||this.emit(ye.ConnectionTypeChange,n),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Ia(r))," -> ").concat(JSON.stringify(Ia(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,r)=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Ia(r))," -> ").concat(JSON.stringify(Ia(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(e){let t=[];if(this.getAllTracks().indexOf(e)===-1)return t;let r=this.localTrackMap.get($.LocalAudioTrack);if(e instanceof Qe&&(r==null?void 0:r.track)instanceof Vt)return r.track.isActive||t.push([$.LocalAudioTrack,r]),t;let n=Array.from(this.localTrackMap.entries()).find(a=>{let[,{track:c}]=a;return e===c});if(n&&(t.push(n),n[0]===$.LocalVideoTrack)){let a=this.localTrackMap.get($.LocalVideoLowTrack);a&&t.push([$.LocalVideoLowTrack,a])}return t}filterTobeUnmutedTracks(e){let t=[],r=this.localTrackMap.get($.LocalAudioTrack);if(e instanceof Qe&&(r==null?void 0:r.track)instanceof Vt)return r.track.isActive&&t.push([$.LocalAudioTrack,r]),t;let n=Array.from(this.localTrackMap.entries()).find(a=>{let[,{track:c}]=a;return e===c});if(n)if(n[0]===$.LocalVideoTrack){t.push(n);let a=this.localTrackMap.get($.LocalVideoLowTrack);a&&t.push([$.LocalVideoLowTrack,a])}else t.push(n);return t}createMuteMessage(e){return e.map(t=>{var r;let n,[a,{track:c,ssrcs:l,id:u}]=t;switch(a){case $.LocalAudioTrack:n=et.Audio;break;case $.LocalVideoTrack:n=ge(r=c._hints).call(r,ut.SCREEN_TRACK)?et.Screen:et.High;break;case $.LocalVideoLowTrack:n=et.Low}return{stream_type:n,ssrcs:l,mid:u}})}createUnmuteMessage(e){return e.map(t=>{var r;let n,[a,{track:c,ssrcs:l,id:u}]=t;switch(a){case $.LocalAudioTrack:n=et.Audio;break;case $.LocalVideoTrack:n=ge(r=c._hints).call(r,ut.SCREEN_TRACK)?et.Screen:et.High;break;case $.LocalVideoLowTrack:n=et.Low}return{stream_type:n,ssrcs:l,mid:u}})}filterTobeUnSubscribedTracks(e,t){let r=[],n=this.remoteUserMap.get(e);if(!n)return r;if(t){let a=n.get(t);if(!a)return r;r.push([e,{kind:t,id:a}])}else Array.from(n.entries()).forEach(a=>{let[c,l]=a;r.push([e,{kind:c,id:l}])});return r}filterTobeUnSubscribedDataChannels(e,t){let r=[];return t.forEach(n=>{var a;(a=this.remoteDataChannelMap.get(e))!==null&&a!==void 0&&a.has(n.id)&&r.push(n)}),r}createUnsubscribeMessage(e){let t=[];return e.forEach(r=>{let[n,{kind:a,id:c}]=r;switch(a){case fe.VIDEO:return void(n._videoSSRC&&t.push({stream_type:fe.VIDEO,ssrcId:n._videoSSRC}));case fe.AUDIO:return void(n._audioSSRC&&t.push({stream_type:fe.AUDIO,ssrcId:n._audioSSRC}))}}),t}createUnsubscribeAllMessage(e){let t=new Map;return e.forEach(r=>{let[n,{kind:a}]=r;if(t.has(n)){let c=t.get(n);a===fe.VIDEO?c|=Bt.Video:c|=Bt.Audio,t.set(n,c)}else a===fe.VIDEO?t.set(n,Bt.Video):t.set(n,Bt.Audio)}),{users:Array.from(t.entries()).map(r=>{let[n,a]=r;return{stream_id:n.uid,stream_type:a}})}}withdrawRemoteTracks(e){e.forEach(t=>{let[r,{kind:n}]=t,a=this.remoteUserMap.get(r);a&&(a.delete(n),Array.from(a.entries()).length===0&&this.remoteUserMap.delete(r))})}async updateBitrateLimit(e){let t=this.localTrackMap.get($.LocalVideoTrack),r=this.localTrackMap.get($.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),r&&e.low_stream_uplink&&await r.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(e,t){return e.map((r,n)=>{var a;let{stream_type:c}=r;return(a=t.find(l=>{let{stream_type:u}=l;return c===u}))===null||a===void 0?void 0:a.attributes})}async tryToUnmuteAudio(e){for(let r=0;r<e.length;r++)if(e[r]instanceof Qe){var t;let n=this.filterTobeUnmutedTracks(e[r]);if(n.length===0)continue;await((t=this.connection)===null||t===void 0?void 0:t.unmuteLocal(n.map(c=>{let[,{id:l}]=c;return l})));let a=this.createUnmuteMessage(n);return void await st(this,ye.RequestUnmuteLocal,a)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.connection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(ye.RequestUploadStats,e,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Si(Bh(this.dtlsFailedCount,xt)),this.emit(ye.RequestReconnect)}async reconnectP2P(){let e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await vt(this,ye.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(ye.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has($.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof ke)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof ke).length>1)throw new Y(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof Qe).length>1&&(e.some(t=>t instanceof Qe&&t._bypassWebAudio)||!ct().webAudioMediaStreamDest))throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let t of e){if(t instanceof ke&&this.pendingLocalTracks.some(r=>r instanceof ke))throw new Y(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Qe&&this.pendingLocalTracks.some(r=>r instanceof Qe)&&(!ct().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(r=>r instanceof Qe&&r._bypassWebAudio)))throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){let r=!P("DISABLE_DUAL_STREAM_USE_ENCODING")&&ct().supportDualStreamEncoding,n=Oa(Oa({},{width:160,height:120,framerate:15,bitrate:50}),t),a;a=r?e._mediaStreamTrack.clone():lS(e,n);let c=at(8,"track-low-"),l=new ke(a,Oa(Oa({},r&&{scaleResolutionDownBy:zg(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,c);return l.on(zc.TRANSCEIVER_UPDATED,u=>{e._updateRtpTransceiver(u,ma.LOW_STREAM)}),l._hints.push(ut.LOW_STREAM),e.addListener(ue.NEED_CLOSE,()=>{l.close()}),l}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,r){let n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof zt){var a,c,l,u;let h=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:p,dtlsTransportState:_,peerConnectionState:E}=this.connection,{local:T,remote:w}=await this.connection.getSelectedCandidatePair();Ee.pcStats(this.store.sessionId,{startTime:h,eventElapse:e-h||0,iceconnectionsate:p,dtlsstate:_,connectionstate:E,intSucc:t?1:2,error:n,selectedLocalCandidateProtocol:(a=T==null?void 0:T.protocol)!==null&&a!==void 0?a:"",selectedLocalCandidateType:(c=T.candidateType)!==null&&c!==void 0?c:"",selectedLocalCandidateAddress:"".concat(T.address,":").concat(T.port),selectedRemoteCandidateProtocol:(l=w.protocol)!==null&&l!==void 0?l:"",selectedRemoteCandidateType:(u=w.candidateType)!==null&&u!==void 0?u:"",selectedRemoteCandidateAddress:"".concat(w.address,":").concat(w.port),restartCnt:r})}}reportVideoFirstFrameDecoded(e,t,r,n){var a;let c=Array.from(Ur(a=this.remoteUserMap).call(a)).find(l=>l._videoSSRC===e);if(c){n||this.store.subscribe(c.uid,"video",void 0,void 0,void 0,void 0,Date.now());let l=this.store.keyMetrics,u=l.subscribe.find(h=>h.userId===c.uid&&h.type==="video");Ee.firstRemoteVideoDecode(this.store.sessionId,$t.FIRST_VIDEO_DECODE,Et.FIRST_VIDEO_DECODE,{peer:c._uintid,videowidth:t,videoheight:r,subscribeElapse:Ii.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:l.requestAPEnd||0,apStart:l.requestAPStart||0,joinGwEnd:l.joinGatewayEnd||0,joinGwStart:l.joinGatewayStart||0,pcEnd:l.peerConnectionEnd||0,pcStart:l.peerConnectionStart||0,subscriberEnd:(u==null?void 0:u.subscribeEnd)||0,subscriberStart:(u==null?void 0:u.subscribeStart)||0,videoAddNotify:(u==null?void 0:u.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(e,t,r){if(!this.connection)return!1;let n=this.remoteUserMap.get(e);if(!n)return!1;let a=n.get(t);if(!a)return!1;let c=await this.connection.getRemoteSSRC(a);return c!==void 0&&c!==r}resetConnection(e){S.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===Ke.Connected?(S.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===Zh.datachannel?new Yt({},this.store):this.isPlanB?new li({},this.store):new zt({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:r}]=e;t===$.LocalVideoLowTrack?r._updateRtpTransceiver(void 0,ma.LOW_STREAM):r._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof zt&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===Yn.TCP_RESTART&&e===Ci.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,Yn.DISCONNECTED_OR_FAILED)))}}function Ui(i,e,t){let r=i[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let n=this.mutex,a=await n.lock("From P2PChannel.".concat(e));try{for(var c=arguments.length,l=new Array(c),u=0;u<c;u++)l[u]=arguments[u];return await r.apply(this,l)}finally{a()}},t}function wG(i){let e=MN();return function(t,r){let n=t.appId;n!==void 0&&(Ze(r,10),vs(r,n));let a=t.cid;a!==void 0&&(Ze(r,16),Ze(r,a));let c=t.cname;c!==void 0&&(Ze(r,26),vs(r,c));let l=t.deviceId;l!==void 0&&(Ze(r,34),vs(r,l));let u=t.elapse;u!==void 0&&(Ze(r,40),Na(r,u));let h=t.fileSize;h!==void 0&&(Ze(r,48),Na(r,al(h)));let p=t.height;p!==void 0&&(Ze(r,56),Na(r,al(p)));let _=t.jpg;_!==void 0&&(Ze(r,66),Ze(r,_.length),function(Ir,Z){let re=ol(Ir,Z.length);Ir.bytes.set(Z,re)}(r,_));let E=t.networkType;E!==void 0&&(Ze(r,72),Na(r,al(E)));let T=t.osType;T!==void 0&&(Ze(r,80),Na(r,al(T)));let w=t.requestId;w!==void 0&&(Ze(r,90),vs(r,w));let C=t.sdkVersion;C!==void 0&&(Ze(r,98),vs(r,C));let O=t.sequence;O!==void 0&&(Ze(r,104),Na(r,al(O)));let b=t.sid;b!==void 0&&(Ze(r,114),vs(r,b));let k=t.timestamp;k!==void 0&&(Ze(r,120),Na(r,k));let U=t.uid;U!==void 0&&(Ze(r,128),Ze(r,U));let X=t.vid;X!==void 0&&(Ze(r,136),Ze(r,X));let z=t.width;z!==void 0&&(Ze(r,144),Na(r,al(z)));let j=t.service;j!==void 0&&(Ze(r,152),Ze(r,j));let B=t.callbackData;B!==void 0&&(Ze(r,162),vs(r,B));let W=t.jpgEncryption;W!==void 0&&(Ze(r,168),Ze(r,W));let ce=t.requestType;ce!==void 0&&(Ze(r,176),Ze(r,ce));let ne=t.scorePorn;ne!==void 0&&(Ze(r,185),mS(r,ne));let Pe=t.scoreSexy;Pe!==void 0&&(Ze(r,193),mS(r,Pe));let We=t.scoreNeutral;We!==void 0&&(Ze(r,201),mS(r,We));let It=t.scene;It!==void 0&&(Ze(r,208),Ze(r,It));let Gt=t.ossFilePrefix;Gt!==void 0&&(Ze(r,218),vs(r,Gt));let pt=t.serviceVendor;if(pt!==void 0)for(let Ir of pt){Ze(r,226);let Z=MN();NG(Ir,Z),Ze(r,Z.limit),kG(r,Z),PG(Z)}}(i,e),function(t){let r=t.bytes,n=t.limit;return r.length===n?r:r.subarray(0,n)}(e)}function AG(i){return function(t){let r={};e:for(;!UN(t);){let n=ys(t);switch(n>>>3){case 0:break e;case 1:r.code=ys(t);break;case 2:r.msg=xN(t,ys(t));break;case 3:{let a=bG(t);r.data=OG(t),t.limit=a;break}default:kN(t,7&n)}}return r}({bytes:e=i,offset:0,limit:e.length});var e}function OG(i){let e={};e:for(;!UN(i);){let t=ys(i);switch(t>>>3){case 0:break e;case 1:e.requestId=xN(i,ys(i));break;case 2:e.requestType=ys(i)>>>0;break;case 3:e.scorePorn=_S(i);break;case 4:e.scoreSexy=_S(i);break;case 5:e.scoreNeutral=_S(i);break;case 6:e.requestScene=ys(i)>>>0;break;case 7:e.scene=ys(i)>>>0;break;default:kN(i,7&t)}}return e}function NG(i,e){let t=i.service;t!==void 0&&(Ze(e,8),Ze(e,t));let r=i.vendor;r!==void 0&&(Ze(e,16),Ze(e,r));let n=i.token;n!==void 0&&(Ze(e,26),vs(e,n));let a=i.callbackUrl;a!==void 0&&(Ze(e,34),vs(e,a))}function bG(i){let e=ys(i),t=i.limit;return i.limit=i.offset+e,t}function kN(i,e){switch(e){case 0:for(;128&VN(i););break;case 2:pS(i,ys(i));break;case 5:pS(i,4);break;case 1:pS(i,8);break;default:throw new Error("Unimplemented type: "+e)}}J([Ui,R("design:type",Function),R("design:paramtypes",[Object,Boolean]),R("design:returntype",F)],di.prototype,"startP2PConnection",null),J([Ui,R("design:type",Function),R("design:paramtypes",[Object,Object,Array,Object,String,String]),R("design:returntype",F)],di.prototype,"connect",null),J([Ui,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",void 0)],di.prototype,"updateRemoteRTPCapabilities",null),J([Ui,R("design:type",Function),R("design:paramtypes",[Object,Object,Array,Object,String,String]),R("design:returntype",F)],di.prototype,"preConnect",null),J([Ui,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],di.prototype,"publishDataChannel",null),J([Ui,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],di.prototype,"unpublish",null),J([Ui,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],di.prototype,"unpublishDataChannel",null),J([Ui,R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],di.prototype,"unpublishLowStream",null),J([Ui,R("design:type",Function),R("design:paramtypes",[wi,Array]),R("design:returntype",F)],di.prototype,"subscribeDataChannel",null),J([Ui,R("design:type",Function),R("design:paramtypes",[wi,String,Number,Number,Array]),R("design:returntype",F)],di.prototype,"subscribe",null),J([Ui,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],di.prototype,"massSubscribe",null),J([Ui,R("design:type",Function),R("design:paramtypes",[wi,String,Boolean]),R("design:returntype",F)],di.prototype,"unsubscribe",null),J([Ui,R("design:type",Function),R("design:paramtypes",[wi,Array]),R("design:returntype",F)],di.prototype,"unsubscribeDataChannel",null),J([Ui,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],di.prototype,"massUnsubscribe",null),J([Ui,R("design:type",Function),R("design:paramtypes",[wi,String]),R("design:returntype",F)],di.prototype,"muteRemote",null),J([Ui,R("design:type",Function),R("design:paramtypes",[wi,String]),R("design:returntype",F)],di.prototype,"unmuteRemote",null),J([Ui,R("design:type",Function),R("design:paramtypes",[wi,String]),R("design:returntype",F)],di.prototype,"hasRemoteMediaWithLock",null),J([Ui,R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],di.prototype,"disconnectForReconnect",null),J([Ui,R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",F)],di.prototype,"updateBitrateLimit",null),J([Ui,R("design:type",Function),R("design:paramtypes",[wi,String,Number]),R("design:returntype",F)],di.prototype,"remoteMediaSsrcChanged",null);let DG=new Float32Array(1);new Uint8Array(DG.buffer);let hS=new Float64Array(1),_r=new Uint8Array(hS.buffer);function al(i){return{low:i|=0,high:i>>31,unsigned:i>=0}}let LN=[];function MN(){let i=LN.pop();return i?(i.offset=i.limit=0,i):{bytes:new Uint8Array(64),offset:0,limit:0}}function PG(i){LN.push(i)}function pS(i,e){if(i.offset+e>i.limit)throw new Error("Skip past limit");i.offset+=e}function UN(i){return i.offset>=i.limit}function ol(i,e){let t=i.bytes,r=i.offset,n=i.limit,a=r+e;if(a>t.length){let c=new Uint8Array(2*a);c.set(t),i.bytes=c}return i.offset=a,a>n&&(i.limit=a),r}function fS(i,e){let t=i.offset;if(t+e>i.limit)throw new Error("Read past limit");return i.offset+=e,t}function xN(i,e){let t=fS(i,e),r=String.fromCharCode,n=i.bytes,a="",c="";for(let l=0;l<e;l++){let u,h,p,_,E=n[l+t];128&E?(224&E)==192?l+1>=e?c+=a:(u=n[l+t+1],(192&u)!=128?c+=a:(_=(31&E)<<6|63&u,_<128?c+=a:(c+=r(_),l++))):(240&E)==224?l+2>=e?c+=a:(u=n[l+t+1],h=n[l+t+2],(49344&(u|h<<8))!=32896?c+=a:(_=(15&E)<<12|(63&u)<<6|63&h,_<2048||_>=55296&&_<=57343?c+=a:(c+=r(_),l+=2))):(248&E)==240?l+3>=e?c+=a:(u=n[l+t+1],h=n[l+t+2],p=n[l+t+3],(12632256&(u|h<<8|p<<16))!=8421504?c+=a:(_=(7&E)<<18|(63&u)<<12|(63&h)<<6|63&p,_<65536||_>1114111?c+=a:(_-=65536,c+=r(55296+(_>>10),56320+(1023&_)),l+=3))):c+=a:c+=r(E)}return c}function vs(i,e){let t=e.length,r=0;for(let c=0;c<t;c++){let l=e.charCodeAt(c);l>=55296&&l<=56319&&c+1<t&&(l=(l<<10)+e.charCodeAt(++c)-56613888),r+=l<128?1:l<2048?2:l<65536?3:4}Ze(i,r);let n=ol(i,r),a=i.bytes;for(let c=0;c<t;c++){let l=e.charCodeAt(c);l>=55296&&l<=56319&&c+1<t&&(l=(l<<10)+e.charCodeAt(++c)-56613888),l<128?a[n++]=l:(l<2048?a[n++]=l>>6&31|192:(l<65536?a[n++]=l>>12&15|224:(a[n++]=l>>18&7|240,a[n++]=l>>12&63|128),a[n++]=l>>6&63|128),a[n++]=63&l|128)}}function kG(i,e){let t=ol(i,e.limit),r=i.bytes,n=e.bytes;for(let a=0,c=e.limit;a<c;a++)r[a+t]=n[a]}function VN(i){return i.bytes[fS(i,1)]}function FN(i,e){let t=ol(i,1);i.bytes[t]=e}function _S(i){let e=fS(i,8),t=i.bytes;return _r[0]=t[e++],_r[1]=t[e++],_r[2]=t[e++],_r[3]=t[e++],_r[4]=t[e++],_r[5]=t[e++],_r[6]=t[e++],_r[7]=t[e++],hS[0]}function mS(i,e){let t=ol(i,8),r=i.bytes;hS[0]=e,r[t++]=_r[0],r[t++]=_r[1],r[t++]=_r[2],r[t++]=_r[3],r[t++]=_r[4],r[t++]=_r[5],r[t++]=_r[6],r[t++]=_r[7]}function ys(i){let e,t=0,r=0;do e=VN(i),t<32&&(r|=(127&e)<<t),t+=7;while(128&e);return r}function Ze(i,e){for(e>>>=0;e>=128;)FN(i,127&e|128),e>>>=7;FN(i,e)}function Na(i,e){let t=e.low>>>0,r=(e.low>>>28|e.high<<4)>>>0,n=e.high>>>24,a=n===0?r===0?t<16384?t<128?1:2:t<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:n<128?9:10,c=ol(i,a),l=i.bytes;switch(a){case 10:l[c+9]=n>>>7&1;case 9:l[c+8]=a!==9?128|n:127&n;case 8:l[c+7]=a!==8?r>>>21|128:r>>>21&127;case 7:l[c+6]=a!==7?r>>>14|128:r>>>14&127;case 6:l[c+5]=a!==6?r>>>7|128:r>>>7&127;case 5:l[c+4]=a!==5?128|r:127&r;case 4:l[c+3]=a!==4?t>>>21|128:t>>>21&127;case 3:l[c+2]=a!==3?t>>>14|128:t>>>14&127;case 2:l[c+1]=a!==2?t>>>7|128:t>>>7&127;case 1:l[c]=a!==1?128|t:127&t}}function jN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}let LG=new Map([["moderation",1],["supervise",2]]);class Yp extends mt{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let t=this._connectionState;this._connectionState=e,this.emit(Kt.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){var t;this._inspectMode=yo(t=e.map(r=>LG.get(r)||0)).call(t,(r,n)=>r+n),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),g(this,"name","AgoraRTCVideoContentInspect"),g(this,"_connectionState",jr.CONNECTING),g(this,"_innerConnectionState",void 0),g(this,"sequence",0),g(this,"inspectStartTime",void 0),g(this,"workerManagerConnection",void 0),g(this,"workerConnection",void 0),g(this,"workerMessageLengthLimit",void 0),g(this,"inspectIntervalMinimum",void 0),g(this,"qualityRatio",void 0),g(this,"_connectInfo",void 0),g(this,"_cancelTokenSource",lr.CancelToken.source()),g(this,"_retryConfig",void 0),g(this,"wmSequence",0),g(this,"inspectInterval",void 0),g(this,"inspectTimer",null),g(this,"ossFilePrefix",void 0),g(this,"extraInfo",void 0),g(this,"_inspectType",void 0),g(this,"_inspectMode",void 0),g(this,"_quality",1),g(this,"qualityTimer",null),g(this,"_inspectId",void 0),g(this,"_needWorkUrlOnly",!1),g(this,"inspectImage",()=>{if(this.connectionState!==jr.CONNECTED)throw new x(A.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===jr.CONNECTED?this.requestToInspectImage():S.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=at(5,"inspect-"),this.workerMessageLengthLimit=P("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=P("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=P("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Sd("worker-manager-"+this._inspectId,xt),this.on(Kt.STATE_CHANGE,(t,r)=>{this._innerConnectionState=t,S.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Br[t]," ").concat(r||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Sd("worker-"+this._inspectId,xt),this.handleWorkerEvents()}async init(e,t){this.emit(Kt.STATE_CHANGE,Br.CONNECT_AP),this._connectInfo=e;let r=this._cancelTokenSource.token;return this._retryConfig=t,new F((n,a)=>{this.on(Kt.CONNECTION_STATE_CHANGE,(c,l)=>{l===jr.CONNECTED&&n()}),this.requestAP(e,r,t).then(c=>{this.connectWorkerManager(c)}).catch(c=>{a(c)})})}async requestAP(e,t,r){let n=P("WEBCS_DOMAIN").map(l=>"https://".concat(l,"/api/v1")),a=await function(l,u,h,p){let{appId:_,areaCode:E,cname:T,sid:w,token:C,uid:O}=u;rl++;let b="image_moderation_api",k={service_name:b,json_body:JSON.stringify({appId:_,areaCode:E,cname:T,command:"allocateEdge",requestId:rl,seq:rl,sid:w,token:C,ts:Date.now(),uid:O+""})},U,X,z=l[0];return Kn(async()=>{U=Date.now();let j=await Gs(z,{data:k,cancelToken:h,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(X=Date.now()-U,j.code!==0){let ne=new x(A.UNEXPECTED_RESPONSE,"image inspect ap error, code"+j.code,{retry:!0,responseTime:X});throw S.error(ne.toString()),ne}let B=JSON.parse(j.json_body);if(B.code!==200){let ne=new x(A.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(B.code,", reason: ").concat(B.reason),{code:B.code,responseTime:X});throw S.error(ne.toString()),ne}if(!B.servers||!Array.isArray(B.servers)||B.servers.length===0){let ne=new x(A.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:B.code,responseTime:X});throw S.error(ne.toString()),ne}let W=P("VIDEO_INSPECT_WORKER_MANAGER_HOST"),ce=P("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:B.servers.map(ne=>{let{address:Pe,wss:We}=ne;if(Pe&&We)return"wss://".concat(Pe.replace(/\./g,"-"),".").concat(W,":").concat(ce||We)}).filter(ne=>!!ne),workerToken:B.workerToken,vid:B.vid,responseTime:X}},(j,B)=>(Ee.apworkerEvent(w,{success:!0,sc:200,serviceName:b,responseDetail:JSON.stringify(j.addressList),firstSuccess:B===0,responseTime:X,serverIp:l[B%l.length]}),!1),(j,B)=>(Ee.apworkerEvent(w,{success:!1,sc:j.data&&j.data.code||200,serviceName:b,responseTime:X,serverIp:l[B%l.length]}),!!(j.code!==A.OPERATION_ABORTED&&j.code!==A.UNEXPECTED_RESPONSE||j.data&&j.data.retry)&&(z=l[(B+1)%l.length],!0)),p)}(n,e,t,r);this.emit(Kt.STATE_CHANGE,Br.AP_CONNECTED);let{addressList:c}=a;return this.wmSequence++,c}async connectWorkerManager(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=t,this.emit(Kt.STATE_CHANGE,Br.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Ie.CONNECTED,async()=>{this.emit(Kt.STATE_CHANGE,Br.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.19.3",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(Ie.CLOSED,()=>{this._innerConnectionState<Br.GET_WORKER_MANAGER_RESPONSE&&S.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(Ie.FAILED,()=>{this._innerConnectionState<Br.GET_WORKER_MANAGER_RESPONSE&&S.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(Ie.RECONNECTING,()=>{this._innerConnectionState<Br.GET_WORKER_MANAGER_RESPONSE&&S.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(Ie.ON_MESSAGE,async e=>{this.emit(Kt.STATE_CHANGE,Br.GET_WORKER_MANAGER_RESPONSE);let t=this.workerManagerConnection.url;this.workerManagerConnection.close();let r=JSON.parse(e.data);if(r.code!==200)throw S.error("[".concat(this._inspectId,"] Unexpected code ").concat(r.code," from worker manager")),new x(A.UNEXPECTED_RESPONSE,"response code of worker is unexpected",r);if(!(r.serverResponse&&r.serverResponse.portWss&&t))throw S.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(r))),new x(A.UNEXPECTED_RESPONSE,"response content of worker is unexpected",r);{let n=P("VIDEO_INSPECT_WORKER_PORT")||r.serverResponse.portWss,a=t.replace(/:\d+\/?$/,":".concat(n));this.emit(Kt.STATE_CHANGE,Br.CONNECT_WORKER,a),this._needWorkUrlOnly?this.emit(Kt.REQUEST_NEW_WORKER_URL,a):await this.connectWorker(a)}}),this.workerManagerConnection.on(Ie.WILL_RECONNECT,(e,t,r)=>{r(e)}),this.workerManagerConnection.on(Ie.REQUEST_NEW_URLS,(e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)})}handleWorkerEvents(){this.workerConnection.on(Ie.CONNECTED,async()=>{this.emit(Kt.STATE_CHANGE,Br.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=jr.CONNECTED}),this.workerConnection.on(Ie.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){let r=AG(new Uint8Array(e.data));if(P("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&S.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(r)),r.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Kt.INSPECT_RESULT,void 0,void 0);if(r.data&&r.data.scorePorn&&r.data.scoreSexy&&r.data.scoreNeutral){var t;let n={porn:r.data.scorePorn,sexy:r.data.scoreSexy,neutral:r.data.scoreNeutral},a=yo(t=Object.keys(n)).call(t,(l,u)=>n[l]>n[u]?l:u,"porn"),c=Object.keys(n).find(l=>l===a);this.emit(Kt.INSPECT_RESULT,c)}else this.emit(Kt.INSPECT_RESULT,void 0,new x(A.UNEXPECTED_RESPONSE,r.code+"","There is an unexpected data on message"))}else this.emit(Kt.INSPECT_RESULT,void 0,new x(A.UNEXPECTED_RESPONSE,r.code+"",r.msg))}else S.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Kt.INSPECT_RESULT,void 0,new x(A.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(Ie.CLOSED,()=>{this.connectionState=jr.CLOSED}),this.workerConnection.on(Ie.FAILED,()=>{this.connectionState=jr.CLOSED}),this.workerConnection.on(Ie.RECONNECTING,()=>{this.connectionState=this.connectionState===jr.CONNECTED?jr.RECONNECTING:jr.CONNECTING}),this.workerConnection.on(Ie.WILL_RECONNECT,(e,t,r)=>{e==="recover"&&r(e),r("tryNext")}),this.workerConnection.on(Ie.REQUEST_NEW_URLS,(e,t)=>{this.workerManagerConnection.close(),this.once(Kt.REQUEST_NEW_WORKER_URL,r=>{e([r])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(r=>{this.connectWorkerManager(r,!0)}).catch(r=>{t(r)})})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;let e=cr(this,Kt.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(Kt.INSPECT_RESULT,void 0,new x(A.INVALID_OPERATION,"Only the track being played can be inspected"));let r=await this.generateRequestData(e,t);this.workerConnection.sendMessage(r,!0,!0)}else this.emit(Kt.INSPECT_RESULT,void 0,new x(A.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,t){let{appId:r,cname:n,cid:a,vid:c,sid:l,uid:u}=t,h=Date.now(),p=await e.getCurrentFrameImage("image/jpeg",this.quality),_=await DO(p,r,n),E=this.sequence+"-"+a+"-"+u+"-"+h+"-"+at(12,""),T={appId:r,cid:a,cname:n,deviceId:"",elapse:Yp.intToLong(Number(h-this.inspectStartTime)),fileSize:_.byteLength,jpgEncryption:2,height:p.height,width:p.width,jpg:_,networkType:6,osType:7,requestId:E,sdkVersion:"4.19.3",sequence:this.sequence,sid:l,timestamp:Yp.intToLong(h),uid:u,vid:c,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete T.callbackData,this.ossFilePrefix===void 0&&delete T.ossFilePrefix;let w=wG(T);if(w.byteLength<this.workerMessageLengthLimit){if(P("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){let C=function(O){for(var b=1;b<arguments.length;b++){var k=arguments[b]!=null?arguments[b]:{};b%2?jN(Object(k),!0).forEach(function(U){g(O,U,k[U])}):Object.getOwnPropertyDescriptors?Object.defineProperties(O,Object.getOwnPropertyDescriptors(k)):jN(Object(k)).forEach(function(U){Object.defineProperty(O,U,Object.getOwnPropertyDescriptor(k,U))})}return O}({},T);delete C.jpg,S.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(C))}return w}{let C=this.quality*this.qualityRatio;return this.quality=C,await this.generateRequestData(e,{appId:r,cname:n,cid:a,vid:c,sid:l,uid:u})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=lr.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=jr.CLOSED,this.emit(Kt.STATE_CHANGE,Br.CLOSED)}}function MG(i){let e=function(){let t=VG.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(t,r){let n=t.appId;n!==void 0&&(Ft(r,10),Bo(r,n));let a=t.cid;a!==void 0&&(Ft(r,16),Ft(r,a));let c=t.cname;c!==void 0&&(Ft(r,26),Bo(r,c));let l=t.deviceId;l!==void 0&&(Ft(r,34),Bo(r,l));let u=t.elapse;u!==void 0&&(Ft(r,40),ba(r,u));let h=t.fileSize;h!==void 0&&(Ft(r,48),ba(r,cl(h)));let p=t.height;p!==void 0&&(Ft(r,56),ba(r,cl(p)));let _=t.jpg;_!==void 0&&(Ft(r,66),Ft(r,_.length),GN(r,_));let E=t.networkType;E!==void 0&&(Ft(r,72),ba(r,cl(E)));let T=t.osType;T!==void 0&&(Ft(r,80),ba(r,cl(T)));let w=t.requestId;w!==void 0&&(Ft(r,90),Bo(r,w));let C=t.sdkVersion;C!==void 0&&(Ft(r,98),Bo(r,C));let O=t.sequence;O!==void 0&&(Ft(r,104),ba(r,cl(O)));let b=t.sid;b!==void 0&&(Ft(r,114),Bo(r,b));let k=t.timestamp;k!==void 0&&(Ft(r,120),ba(r,k));let U=t.uid;U!==void 0&&(Ft(r,128),Ft(r,U));let X=t.vid;X!==void 0&&(Ft(r,136),Ft(r,X));let z=t.width;z!==void 0&&(Ft(r,144),ba(r,cl(z)));let j=t.service;j!==void 0&&(Ft(r,152),Ft(r,j));let B=t.callbackData;B!==void 0&&(Ft(r,162),Ft(r,B.length),GN(r,B));let W=t.ticket;W!==void 0&&(Ft(r,170),Bo(r,W))}(i,e),function(t){let r=t.bytes,n=t.limit;return r.length===n?r:r.subarray(0,n)}(e)}function UG(i){return function(t){let r={};e:for(;!FG(t);){let n=Hd(t);switch(n>>>3){case 0:break e;case 1:r.code=Hd(t);break;case 2:r.msg=WN(t,Hd(t));break;case 3:r.requestId=WN(t,Hd(t));break;case 4:r.timestamp=jG(t,!1);break;default:xG(t,7&n)}}return r}({bytes:e=i,offset:0,limit:e.length});var e}function xG(i,e){switch(e){case 0:for(;128&kn(i););break;case 2:ES(i,Hd(i));break;case 5:ES(i,4);break;case 1:ES(i,8);break;default:throw new Error("Unimplemented type: "+e)}}function cl(i){return{low:i|=0,high:i>>31,unsigned:i>=0}}let VG=[];function ES(i,e){if(i.offset+e>i.limit)throw new Error("Skip past limit");i.offset+=e}function FG(i){return i.offset>=i.limit}function qp(i,e){let t=i.bytes,r=i.offset,n=i.limit,a=r+e;if(a>t.length){let c=new Uint8Array(2*a);c.set(t),i.bytes=c}return i.offset=a,a>n&&(i.limit=a),r}function BN(i,e){let t=i.offset;if(t+e>i.limit)throw new Error("Read past limit");return i.offset+=e,t}function GN(i,e){let t=qp(i,e.length);i.bytes.set(e,t)}function WN(i,e){let t=BN(i,e),r=String.fromCharCode,n=i.bytes,a="",c="";for(let l=0;l<e;l++){let u,h,p,_,E=n[l+t];128&E?(224&E)==192?l+1>=e?c+=a:(u=n[l+t+1],(192&u)!=128?c+=a:(_=(31&E)<<6|63&u,_<128?c+=a:(c+=r(_),l++))):(240&E)==224?l+2>=e?c+=a:(u=n[l+t+1],h=n[l+t+2],(49344&(u|h<<8))!=32896?c+=a:(_=(15&E)<<12|(63&u)<<6|63&h,_<2048||_>=55296&&_<=57343?c+=a:(c+=r(_),l+=2))):(248&E)==240?l+3>=e?c+=a:(u=n[l+t+1],h=n[l+t+2],p=n[l+t+3],(12632256&(u|h<<8|p<<16))!=8421504?c+=a:(_=(7&E)<<18|(63&u)<<12|(63&h)<<6|63&p,_<65536||_>1114111?c+=a:(_-=65536,c+=r(55296+(_>>10),56320+(1023&_)),l+=3))):c+=a:c+=r(E)}return c}function Bo(i,e){let t=e.length,r=0;for(let c=0;c<t;c++){let l=e.charCodeAt(c);l>=55296&&l<=56319&&c+1<t&&(l=(l<<10)+e.charCodeAt(++c)-56613888),r+=l<128?1:l<2048?2:l<65536?3:4}Ft(i,r);let n=qp(i,r),a=i.bytes;for(let c=0;c<t;c++){let l=e.charCodeAt(c);l>=55296&&l<=56319&&c+1<t&&(l=(l<<10)+e.charCodeAt(++c)-56613888),l<128?a[n++]=l:(l<2048?a[n++]=l>>6&31|192:(l<65536?a[n++]=l>>12&15|224:(a[n++]=l>>18&7|240,a[n++]=l>>12&63|128),a[n++]=l>>6&63|128),a[n++]=63&l|128)}}function kn(i){return i.bytes[BN(i,1)]}function HN(i,e){let t=qp(i,1);i.bytes[t]=e}function Hd(i){let e,t=0,r=0;do e=kn(i),t<32&&(r|=(127&e)<<t),t+=7;while(128&e);return r}function Ft(i,e){for(e>>>=0;e>=128;)HN(i,127&e|128),e>>>=7;HN(i,e)}function jG(i,e){let t,r=0,n=0,a=0;return t=kn(i),r=127&t,128&t&&(t=kn(i),r|=(127&t)<<7,128&t&&(t=kn(i),r|=(127&t)<<14,128&t&&(t=kn(i),r|=(127&t)<<21,128&t&&(t=kn(i),n=127&t,128&t&&(t=kn(i),n|=(127&t)<<7,128&t&&(t=kn(i),n|=(127&t)<<14,128&t&&(t=kn(i),n|=(127&t)<<21,128&t&&(t=kn(i),a=127&t,128&t&&(t=kn(i),a|=(127&t)<<7))))))))),{low:r|n<<28,high:n>>>4|a<<24,unsigned:e}}function ba(i,e){let t=e.low>>>0,r=(e.low>>>28|e.high<<4)>>>0,n=e.high>>>24,a=n===0?r===0?t<16384?t<128?1:2:t<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:n<128?9:10,c=qp(i,a),l=i.bytes;switch(a){case 10:l[c+9]=n>>>7&1;case 9:l[c+8]=a!==9?128|n:127&n;case 8:l[c+7]=a!==8?r>>>21|128:r>>>21&127;case 7:l[c+6]=a!==7?r>>>14|128:r>>>14&127;case 6:l[c+5]=a!==6?r>>>7|128:r>>>7&127;case 5:l[c+4]=a!==5?128|r:127&r;case 4:l[c+3]=a!==4?t>>>21|128:t>>>21&127;case 3:l[c+2]=a!==3?t>>>14|128:t>>>14&127;case 2:l[c+1]=a!==2?t>>>7|128:t>>>7&127;case 1:l[c]=a!==1?128|t:127&t}}let KN={},zN={},Jp=4294967296,YN=Jp*Jp,qN=YN/2,gS=XN(0,!0),JN=XN(0),BG=ll(0,-2147483648,!1),GG=ll(-1,2147483647,!1),WG=ll(-1,-1,!0);function XN(i,e){let t,r,n;return e?(n=0<=(i>>>=0)&&i<256)&&(r=zN[i],r)?r:(t=ll(i,0,!0),n&&(zN[i]=t),t):(n=-128<=(i|=0)&&i<128)&&(r=KN[i],r)?r:(t=ll(i,i<0?-1:0,!1),n&&(KN[i]=t),t)}function ll(i,e,t){return{low:0|i,high:0|e,unsigned:!!t}}function HG(i,e){if(isNaN(i))return e?gS:JN;if(e){if(i<0)return gS;if(i>=YN)return WG}else{if(i<=-qN)return BG;if(i+1>=qN)return GG}return i<0?e?gS:JN:ll(i%Jp|0,i/Jp|0,e)}function QN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}class SS extends mt{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let t=this._connectionState;this._connectionState=e,this.emit(an.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var t;super(),g(this,"name","AgoraRTCImageModeration"),g(this,"_connectionState",yr.CONNECTING),g(this,"_sequence",0),g(this,"_moderationStartTime",void 0),g(this,"_workerConnection",void 0),g(this,"_workerMessageLengthLimit",void 0),g(this,"_qualityRatio",void 0),g(this,"_connectInfo",void 0),g(this,"_cancelTokenSource",lr.CancelToken.source()),g(this,"_retryConfig",void 0),g(this,"_moderationInterval",void 0),g(this,"_moderationTimer",null),g(this,"_moderationMode",1),g(this,"_quality",1),g(this,"_qualityTimer",null),g(this,"_ticket",void 0),g(this,"_moderationIntervalMinimum",void 0),g(this,"_uploadFailedNum",0),g(this,"_uploadNum",0),g(this,"_uploadTimer",null),g(this,"_moderationId",void 0),g(this,"inspectImage",()=>{if(this.connectionState!==yr.CONNECTED)throw new x(A.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===yr.CONNECTED?this.requestToInspectImage():S.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=at(5,"image-moderation-"),this._workerMessageLengthLimit=P("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=P("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(t=e.interval)!==null&&t!==void 0?t:1e3,this._qualityRatio=P("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Sd("worker-"+this._moderationId,xt),this.on(an.STATE_CHANGE,(r,n)=>{S.debug("[".concat(this._moderationId,"] Moderation operation :").concat(_a[r]," ").concat(n||""))}),this.handleWorkerEvents()}async init(e,t){this.emit(an.STATE_CHANGE,_a.CONNECT_AP),this._connectInfo=e;let r=this._cancelTokenSource.token;return this._retryConfig=t,new F((n,a)=>{this.on(an.CONNECTION_STATE_CHANGE,(c,l)=>{c===yr.CONNECTED&&n()}),this.requestAP(e,r,t).then(c=>{this.connectWorker(c)}).catch(c=>{a(c)})})}updateConfig(e){var t;this._moderationInterval=(t=e.interval)!==null&&t!==void 0?t:1e3,S.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===yr.CONNECTED&&this.inspectImage()}async requestAP(e,t,r){let n=P("WEBCS_DOMAIN").map(u=>"https://".concat(u,"/api/v1")),a=await function(u,h,p,_){let{appId:E,areaCode:T,cname:w,sid:C,token:O,uid:b}=h;rl++;let k="moderation_plugin",U={service_name:k,json_body:JSON.stringify({appId:E,areaCode:T,cname:w,command:"allocateEdge",requestId:rl,seq:rl,sid:C,appToken:O,ts:Date.now(),uid:b+""})},X,z,j=u[0];return Kn(async()=>{X=Date.now();let B=await Gs(j,{data:U,cancelToken:p,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(z=Date.now()-X,B.code!==0){let ne=new x(A.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+B.code,{retry:!0,responseTime:z});throw S.error(ne.toString()),ne}let W=JSON.parse(B.json_body);if(W.code!==200){let ne=new x(A.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(W.code,", reason: ").concat(W.reason),{code:W.code,responseTime:z});throw S.error(ne.toString()),ne}if(!W.servers||!Array.isArray(W.servers)||W.servers.length===0){let ne=new x(A.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:W.code,responseTime:z});throw S.error(ne.toString()),ne}if(!W.servers.some(ne=>!!ne.wss)){let ne=new x(A.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:W.code,responseTime:z});throw S.error(ne.toString()),ne}let ce=P("IMAGE_MODERATION_WORKER_HOST");return{addressList:W.servers.map(ne=>{let{address:Pe,wss:We}=ne;if(Pe&&We)return"wss://".concat(Pe.replace(/\./g,"-"),".").concat(ce,":").concat(We,"/moderation")}).filter(ne=>!!ne),workerToken:W.workerToken,vid:W.vid,ticket:W.appTicket,responseTime:z}},(B,W)=>(Ee.apworkerEvent(C,{success:!0,sc:200,serviceName:k,responseDetail:JSON.stringify(B.addressList),firstSuccess:W===0,responseTime:z,serverIp:u[W%u.length]}),!1),(B,W)=>(Ee.apworkerEvent(C,{success:!1,sc:B.data&&B.data.code||200,serviceName:k,responseTime:z,serverIp:u[W%u.length]}),!!(B.code!==A.OPERATION_ABORTED&&B.code!==A.UNEXPECTED_RESPONSE||B.data&&B.data.retry)&&(j=u[(W+1)%u.length],!0)),_)}(n,e,t,r);this.emit(an.STATE_CHANGE,_a.AP_CONNECTED);let{addressList:c,ticket:l}=a;return this._ticket=l,c}async connectWorker(e){this.emit(an.STATE_CHANGE,_a.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(Ie.CONNECTED,async()=>{this.emit(an.STATE_CHANGE,_a.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=yr.CONNECTED}),this._workerConnection.on(Ie.CLOSED,()=>{this.connectionState=yr.CLOSED}),this._workerConnection.on(Ie.FAILED,()=>{this.connectionState=yr.CLOSED}),this._workerConnection.on(Ie.RECONNECTING,()=>{this.connectionState=this.connectionState===yr.CONNECTED?yr.RECONNECTING:yr.CONNECTING}),this._workerConnection.on(Ie.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){let t=UG(new Uint8Array(e.data));P("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&S.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(t)),this._uploadNum++,t.code===void 0||t.code===0||(this._uploadFailedNum++,S.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(t.code,", msg is ").concat(t.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{Ee.reportApiInvoke(this._connectInfo.sid||null,{name:jt.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,t.code],tag:St.TRACER}).onError(new x(A.IMAGE_MODERATION_UPLOAD_FAILED,t.msg)),this._uploadTimer=null},P("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else S.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(Ie.WILL_RECONNECT,(e,t,r)=>{e==="recover"&&r(e),r("tryNext")}),this._workerConnection.on(Ie.REQUEST_NEW_URLS,(e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){let e=cr(this,an.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(P("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&S.debug("Only the track being played can be inspected"));this._sequence++;let r=await this.generateRequestData(e,t);this._workerConnection.sendMessage(r,!0,!0)}else P("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&S.debug("Only the track being published can be inspected")}async generateRequestData(e,t){let{appId:r,cname:n,cid:a,vid:c,sid:l,uid:u}=t,h=Date.now(),p=await e.getCurrentFrameImage("image/jpeg",this.quality),_=await DO(p,r,n),E=this._sequence+"-"+a+"-"+u+"-"+h+"-"+at(12,""),T={appId:r,cid:a,cname:n,deviceId:"",elapse:SS.intToLong(Number(h-this._moderationStartTime)),fileSize:p.buffer.byteLength,height:p.height,width:p.width,jpg:_,networkType:6,osType:7,requestId:E,sdkVersion:"4.19.3",sequence:this._sequence,sid:l,timestamp:HG(h),uid:u,vid:c,service:this._moderationMode,ticket:this._ticket},w=MG(T);if(w.byteLength<this._workerMessageLengthLimit){if(P("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){let C=function(O){for(var b=1;b<arguments.length;b++){var k=arguments[b]!=null?arguments[b]:{};b%2?QN(Object(k),!0).forEach(function(U){g(O,U,k[U])}):Object.getOwnPropertyDescriptors?Object.defineProperties(O,Object.getOwnPropertyDescriptors(k)):QN(Object(k)).forEach(function(U){Object.defineProperty(O,U,Object.getOwnPropertyDescriptor(k,U))})}return O}({},T);delete C.jpg,S.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(C))}return w}{let C=this.quality*this._qualityRatio;return this.quality=C,await this.generateRequestData(e,{appId:r,cname:n,cid:a,vid:c,sid:l,uid:u})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=lr.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=yr.CLOSED,this.emit(an.STATE_CHANGE,_a.CLOSED)}}function $N(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Xp(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$N(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):$N(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class Xi extends KA{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return(e=(t=this.peerConnection.getReceivers()[0])===null||t===void 0||(t=t.transport)===null||t===void 0?void 0:t.state)!==null&&e!==void 0?e:null}constructor(e,t,r){super(e,t),g(this,"direction",void 0),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"transportEventReceiver",void 0),g(this,"statsFilter",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"mutex",new si("P2PConnection-mutex")),g(this,"dataChannel",void 0),g(this,"onLocalCandidate",void 0),this.store=t,this.peerConnection=new RTCPeerConnection(Xi.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.direction=r??Gc.SEND_ONLY,this.dataChannel=this.peerConnection.createDataChannel("agora-p2p-signal",{ordered:!0}),this.statsFilter=Gp(this.peerConnection,P("STATS_UPDATE_INTERVAL"),void 0,ht()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{if(e){await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});let t=await this.peerConnection.createAnswer();if(await this.peerConnection.setLocalDescription(t),!t.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");return t.sdp}{let t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");return await this.peerConnection.setLocalDescription(t),t.sdp}}catch(t){throw new Y(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(e){try{await this.peerConnection.setRemoteDescription({type:"answer",sdp:e})}catch(t){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(t.toString()))}}async addRemoteCandidate(e){try{await this.peerConnection.addIceCandidate(e)}catch(t){throw new Y(A.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(t.toString()))}}async send(e){try{let t=[];e.forEach(a=>{let c=this.peerConnection.addTransceiver(a._mediaStreamTrack,{direction:"sendonly"});t.push(c)}),ht()&&P("SIMULCAST")===!0&&await this.applySimulcastForFirefox(t,e),await this.applySimulcastEncodings(t,e),await this.applySendEncodings(t,e);let r=await this.peerConnection.createOffer();if(await this.peerConnection.setLocalDescription(r),!r.sdp)throw new Error("Cannot get offer.sdp when trying to send PeerConnection.");let n=t.map(a=>{let c=this.getLocalSSRC(a.mid,r.sdp);if(!c)throw new Error("Cannot get ssrc when trying to send PeerConnection.");return{mid:a.mid,localSSRC:[{ssrcId:c}]}});return{sdp:r.sdp,trackMessage:n}}catch(t){throw t instanceof Y?t:new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(t.toString()))}}async stopSending(e,t){let r=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{let n=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length (".concat(n.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));n.map(c=>{var l;c.direction="inactive",(l=c.stop)===null||l===void 0||l.call(c),this.peerConnection.removeTrack(c.sender)});let a=await this.peerConnection.createOffer();if(await this.peerConnection.setLocalDescription(a),!a.sdp)throw new Error("Cannot get offer.sdp when trying to send PeerConnection.");return a.sdp}catch(n){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}finally{r&&r()}}async receive(e,t,r){try{await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to receive track.");await this.peerConnection.setLocalDescription(n),S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."));let a=this.getRemoteMid(r,t);if(a===void 0)throw new Error("Cannot get transceiver mid when trying to receive track.");let c=this.peerConnection.getTransceivers().find(l=>l.mid===a);if(!c||c.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,mid:c.mid,sdp:n.sdp}}catch(n){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async setDescription(e,t){try{if(e==="remote"){await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let r=await this.peerConnection.createAnswer();if(!r.sdp)throw new Error("Cannot get answer sdp when trying to receive track.");return await this.peerConnection.setLocalDescription(r),S.debug("[".concat(this.store.clientId,"] [P2PConnection] exchanging SDP, type is ").concat(e)),r.sdp}await this.peerConnection.setRemoteDescription({type:"answer",sdp:t})}catch(r){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection.setDescription failed; ".concat(r.toString()))}}async stopReceiving(e,t){try{let r=this.peerConnection.getTransceivers().filter(a=>e.indexOf(a.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(a=>{var c;a.direction="inactive",(c=a.stop)===null||c===void 0||c.call(a)}),await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});let n=await this.peerConnection.createAnswer();if(await this.peerConnection.setLocalDescription(n),!n.sdp)throw new Error("Cannot get answer sdp when trying to receive track.");return n.sdp}catch(r){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(r.toString()))}}async restartICE(){try{let e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");return this.store.descriptionStart(),await this.peerConnection.setLocalDescription(e),e.sdp}catch(e){throw new Y(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transportEventReceiver=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){}async updateSendParameters(e,t){let r=this.peerConnection.getTransceivers().filter(n=>n.mid===e);r.length===1&&(this.isVP8Simulcast(t)?ht()||await this.applySimulcastEncodings(r,[t]):await this.applySendEncodings(r,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){let r=this.peerConnection.getTransceivers().find(n=>n.mid===t);r&&await r.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let t=e[0].transport.iceTransport,{local:r,remote:n}=t.getSelectedCandidatePair();return{local:Xp(Xp({},Ts),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:Xp(Xp({},Ts),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{var t;e.candidate&&((t=this.onLocalCandidate)===null||t===void 0||t.call(this,e.candidate)),e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},P("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Lc(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...Xi.turnServerConfigToIceServers(e.turnServer.servers)),P("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...Xi.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),P("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(t.iceTransportPolicy="relay")}))),P("ENABLE_ENCODED_TRANSFORM")&&ct().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){let t=[];return e.forEach(r=>{r.tcpport&&(t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(Vd(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}),t.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=udp")}),t.push({username:r.username,credential:r.password,credentialType:"password",urls:"stun:".concat(r.turnServerURL,":").concat(r.tcpport)}))}),t}tryBindTransportEvents(e){let t=e.transport;if(t){this.transportEventReceiver=e,t.onstatechange=()=>{var n;t!=null&&t.state&&((n=this.onDTLSTransportStateChange)===null||n===void 0||n.call(this,t.state))},t.onerror=n=>{var a;(a=this.onDTLSTransportError)===null||a===void 0||a.call(this,"error"in n?n.error:n)};let r=t.iceTransport;r&&(r.onstatechange=()=>{let n=t==null?void 0:t.iceTransport.state;var a;n&&((a=this.onICETransportStateChange)===null||a===void 0||a.call(this,n))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){let{local:n,remote:a}=r.getSelectedCandidatePair();S.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol}),", remote ").concat(JSON.stringify({candidateType:a.type,protocol:a.protocol,address:a.address,port:a.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var r;if(t||(t=this.peerConnection.getSenders().find(p=>p.track===e._mediaStreamTrack)),!t)return S.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return S.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!ct().supportSetRtpSenderParameters)return S.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let n={},a={};switch(e._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(e._encoderConfig){var c;let{bitrateMax:p,frameRate:_,scaleResolutionDownBy:E}=e._encoderConfig;p&&(a.maxBitrate=1e3*p),ge(c=e._hints).call(c,ut.LOW_STREAM)&&(_&&(a.maxFramerate=qr(_)),E&&E>=1&&(a.scaleResolutionDownBy=E))}if(P("DSCP_TYPE")&&la()){var l;let p=P("DSCP_TYPE");ge(l=["very-low","low","medium","high"]).call(l,p)&&(a.networkPriority=p)}let u=t.getParameters(),h=(r=u.encodings)===null||r===void 0?void 0:r[0];ht()&&!h&&(n.encodings=[a]),h&&Object.assign(h,a),Object.assign(u,n),S.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(u.encodings))),await t.setParameters(u)}async applySendEncodings(e,t){try{if(!ct().supportSetRtpSenderParameters||e.length!==t.length)return;for(let r=0;r<e.length;r++){let n=e[r],a=t[r];a instanceof ke&&!this.isVP8Simulcast(a)&&await this.updateRtpSenderEncodings(a,n.sender)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,r){let n=At.parse(e);return t.forEach((a,c)=>{let l=r[c],u=n.mediaDescriptions.find(h=>h.attributes.mid===l);u&&(Fo(u,a),aS(u,a,this.store.codec))}),At.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;(t=this.onFirstAudioReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;(t=this.onFirstVideoReceived)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;(t=this.onFirstAudioDecoded)===null||t===void 0||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,r)=>{var n;(n=this.onFirstVideoDecoded)===null||n===void 0||n.call(this,e,t,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;(t=this.onFirstVideoDecodedTimeout)===null||t===void 0||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let u=0;u<e.length;u++){var r,n,a,c,l;let h=e[u],p=t[u];if(p instanceof ke&&!ge(r=p._hints).call(r,ut.LOW_STREAM)&&(n=p._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((a=p._encoderConfig)===null||a===void 0?void 0:a.bitrateMax)>200&&(c=p._scalabilityMode)!==null&&c!==void 0&&c.numSpatialLayers&&((l=p._scalabilityMode)===null||l===void 0?void 0:l.numSpatialLayers)>1&&this.store.codec==="vp8"){let _={},E={high:1e3*(p._encoderConfig.bitrateMax-50),medium:5e4};_.encodings=[{rid:"m",active:!0,maxBitrate:E.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:E.high}];let T=h.sender.getParameters();await h.sender.setParameters(Object.assign(T,_))}}}async applySimulcastEncodings(e,t){if(!ht()&&e.length===t.length)for(let r=0;r<e.length;r++){let n=t[r];if(n instanceof ke&&this.isVP8Simulcast(n)){let a=e[r],c={},l={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};c.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:l.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:l.medium,scaleResolutionDownBy:4}];let u=a.sender.getParameters();await a.sender.setParameters(Object.assign(u,c))}}}isVP8Simulcast(e){var t,r,n,a,c;return!!(e instanceof ke&&P("SIMULCAST")&&this.store.codec==="vp8"&&!ge(t=e._hints).call(t,ut.LOW_STREAM)&&(r=e._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((n=e._encoderConfig)===null||n===void 0?void 0:n.bitrateMax)>200&&(a=e._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((c=e._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1)}logSDPExchange(e,t,r,n){if(P("SDP_LOGGING"))return S.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(t," SDP during P2PConnection.").concat(n,`
`),e),t==="offer"?a=>{this.logSDPExchange(a,"answer",r==="local"?"remote":"local",n)}:void 0}getLocalSSRC(e,t){var r,n;if(t=(r=t)!==null&&r!==void 0?r:(n=this.currentLocalDescription)===null||n===void 0?void 0:n.sdp){var a;let c=(a=At.parse(t).mediaDescriptions.find(l=>l.attributes.mid===e))===null||a===void 0?void 0:a.attributes.ssrcs;return c==null?void 0:c[0].ssrcId}}getRemoteMid(e,t){var r,n;if(t=(r=t)!==null&&r!==void 0?r:(n=this.currentRemoteDescription)===null||n===void 0?void 0:n.sdp){var a;return(a=At.parse(t).mediaDescriptions.find(c=>c.attributes.ssrcs.some(l=>l.ssrcId===e)))===null||a===void 0?void 0:a.attributes.mid}}async getRemoteSSRC(e,t){var r,n;if(t=(r=t)!==null&&r!==void 0?r:(n=this.currentRemoteDescription)===null||n===void 0?void 0:n.sdp){var a;let c=(a=At.parse(t).mediaDescriptions.find(l=>l.attributes.mid===e))===null||a===void 0?void 0:a.attributes.ssrcs;return c==null?void 0:c[0].ssrcId}}}function Ln(i,e,t){let r=i[e];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return t.value=async function(){let n=this.mutex,a=await n.lock("From P2PConnection.".concat(e));try{for(var c=arguments.length,l=new Array(c),u=0;u<c;u++)l[u]=arguments[u];return await r.apply(this,l)}finally{a()}},t}var pn;function ZN(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Da(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ZN(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):ZN(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}J([Ln,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Xi.prototype,"establish",null),J([Ln,R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Xi.prototype,"connect",null),J([Ln,R("design:type",Function),R("design:paramtypes",[RTCIceCandidate]),R("design:returntype",F)],Xi.prototype,"addRemoteCandidate",null),J([Ln,R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],Xi.prototype,"send",null),J([Ln,R("design:type",Function),R("design:paramtypes",[String,String,Number]),R("design:returntype",F)],Xi.prototype,"receive",null),J([Ln,R("design:type",Function),R("design:paramtypes",[String,String]),R("design:returntype",F)],Xi.prototype,"setDescription",null),J([Ln,R("design:type",Function),R("design:paramtypes",[Array,String]),R("design:returntype",F)],Xi.prototype,"stopReceiving",null),J([Ln,R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],Xi.prototype,"restartICE",null),J([Ln,R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],Xi.prototype,"close",null),J([Ln,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],Xi.prototype,"updateEncoderConfig",null),J([Ln,R("design:type",Function),R("design:paramtypes",[String,Ri]),R("design:returntype",F)],Xi.prototype,"updateSendParameters",null),J([Ln,R("design:type",Function),R("design:paramtypes",[Ri,String]),R("design:returntype",F)],Xi.prototype,"replaceTrack",null),function(i){i.SEND_ONLY="SEND_ONLY",i.RECEIVE_ONLY="RECEIVE_ONLY"}(pn||(pn={}));class Rt extends mt{get state(){return this._state}set state(e){let t=this._state;this._state=e,this.emit(ye.StateChange,t,this._state)}constructor(e,t){super(),g(this,"store",void 0),g(this,"statsUploader",void 0),g(this,"sendConnection",void 0),g(this,"recvConnection",void 0),g(this,"localTrackMap",new Map),g(this,"remoteUserMap",new Map),g(this,"localDataChannels",[]),g(this,"pendingLocalTracks",[]),g(this,"pendingRemoteTracks",[]),g(this,"statsCollector",void 0),g(this,"dtlsFailedCount",0),g(this,"sendMutex",new si("P2PChannel2-send-mutex")),g(this,"recvMutex",new si("P2PChannel2-recv-mutex")),g(this,"_state",Ke.Disconnected),g(this,"_restartStates",["disconnected","failed"]),g(this,"_restartTimer",void 0),g(this,"handleMuteLocalTrack",async(r,n,a)=>{let c=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Ke.Connected)return void a(new Y(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));let h=this.filterTobeMutedTracks(r);if(h.length===0)return void n();let p=h.find(b=>b[0]==="videoLowTrack");p&&p[1].track._originMediaStreamTrack.stop();let _=!1;var l,u;r.trackMediaType==="video"?_=!((l=this.localTrackMap.get($.LocalAudioTrack))===null||l===void 0||!l.track._muted):_=((u=this.localTrackMap.get($.LocalVideoTrack))===null||u===void 0?void 0:u.id)===void 0;let E=h.filter(b=>{let[k,U]=b;return(k!==$.LocalAudioTrack||_)&&U.id!==void 0}).map(b=>{let[,k]=b;return k}),T;E.length>0&&(T=await this.sendConnection.stopSending(E.map(b=>b.id)),E.forEach(b=>{b.id=void 0,b.ssrcs=void 0}));let w=this.createMuteMessage(h),C=r.trackMediaType==="video"?ps.MUTE_LOCAL_VIDEO:ps.MUTE_LOCAL_AUDIO,O=await vt(this,ye.RequestP2PMuteLocal,{action:C,sdp:T,message:w,isMuteAll:_});O&&await this.sendConnection.setDescription("local",O),(T||r.trackMediaType==="audio")&&await st(this,ye.RequestMuteLocal,w),n()}catch(h){a(h)}finally{c()}}),g(this,"handleUnmuteLocalTrack",async(r,n,a)=>{let c=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Ke.Connected)return void a(new Y(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));let l=this.filterTobeUnmutedTracks(r);if(l.length===0)return void n();let u=this.createUnmuteMessage(l),h=r.trackMediaType==="video"?ps.UNMUTE_LOCAL_VIDEO:ps.UNMUTE_LOCAL_AUDIO;await st(this,ye.RequestP2PMuteLocal,{action:h,message:u}),n()}catch(l){a(l)}finally{c()}}),g(this,"handleUpdateVideoEncoder",async(r,n,a)=>{let c=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{let l=this.localTrackMap.get($.LocalVideoTrack);if(!this.sendConnection||!l||l.track!==r||this.state!==Ke.Connected)return void n();let{id:u,track:h}=l;u&&(await this.sendConnection.updateSendParameters(u,h),await this.sendConnection.updateEncoderConfig(u,h),this.emit(ye.UpdateVideoEncoder,h)),n()}catch(l){a(l)}finally{c()}}),g(this,"handleSetOptimizationMode",async(r,n,a)=>{let c=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{let l=this.localTrackMap.get($.LocalVideoTrack);if(!this.sendConnection||!l||l.track!==r||this.state!==Ke.Connected)return;let{id:u,track:h}=l;u&&await this.sendConnection.updateSendParameters(u,h),n()}catch(l){a(l)}finally{c()}}),g(this,"handleReplaceTrack",async(r,n,a,c)=>{let l;S.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(r.getTrackId(),"]")),typeof c=="boolean"&&c||(l=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var u;let p=Array.from(this.localTrackMap.entries()).find(_=>{let[,{track:E}]=_;return r===E});if(!this.sendConnection||!p||p[1].id===void 0||this.state!==Ke.Connected)return void n();if(await((u=this.sendConnection)===null||u===void 0?void 0:u.replaceTrack(r,p[1].id)),p[0]===$.LocalVideoTrack&&ct().supportDualStreamEncoding){let _=this.localTrackMap.get($.LocalVideoLowTrack);if(_){let E=r._mediaStreamTrack.clone();_.track._originMediaStreamTrack.stop(),_.track._mediaStreamTrack=E,_.track._originMediaStreamTrack=E,await new F((T,w)=>{this.handleReplaceTrack(_.track,T,w,!0)})}}n()}catch(p){a(p)}finally{var h;(h=l)===null||h===void 0||h()}}),g(this,"handleGetLocalVideoStats",r=>{r(this.statsCollector.getLocalVideoTrackStats())}),g(this,"handleGetLocalAudioStats",r=>{r(this.statsCollector.getLocalAudioTrackStats())}),g(this,"handleGetRemoteVideoStats",r=>this.statsCollector.getRemoteVideoTrackStats(r.uid)[r.uid]),g(this,"handleGetRemoteAudioStats",r=>this.statsCollector.getRemoteAudioTrackStats(r.uid)[r.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new bN,this.bindStatsUploaderEvents()}async startP2PConnection(e,t){throw new Y(A.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,t,r,n,a,c){throw new Y(A.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){if(this.state=Ke.New,this.sendConnection&&(S.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset P2PConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),this.recvConnection&&(S.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset P2PConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),this.sendConnection=new Xi(e,this.store),this.bindConnectionEvents(this.sendConnection),this.recvConnection=new Xi(e,this.store,Gc.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection),t){this.store.peerConnectionStart(),await this.recvConnection.establish(t);let r=await this.sendConnection.establish(t);return this.statsUploader.startUploadTransportStats(!0),this.statsUploader.startUploadExtensionUsageStats(),this.state=Ke.Connected,r}return await this.recvConnection.establish(t),this.sendConnection.establish(t)}async p2pConnect(e){if(!this.sendConnection||!this.recvConnection)throw new Y(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.recvConnection.connect(e),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Ke.Connected}async addRemoteCandidate(e){if(!this.sendConnection||!this.recvConnection)throw new Y(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e),await this.sendConnection.addRemoteCandidate(e)}async publish(e,t,r){if(!this.sendConnection||this.state!==Ke.Connected){this.throwIfTrackTypeNotMatch(e);let c=e.filter(l=>this.pendingLocalTracks.indexOf(l)===-1);return void(this.pendingLocalTracks=this.pendingLocalTracks.concat(c))}this.store.pubId=this.store.pubId+1,Ii.markPublishStart(this.store.clientId,this.store.pubId);let n=this.filterTobePublishedTracks(e,t,r);if(n.length===0)return void await this.tryToUnmuteAudio(e);n.forEach(c=>{let{track:l,type:u}=c,h=Date.now();this.store.publish(l.getTrackId(),u===$.LocalAudioTrack?"audio":"video",h)}),this.bindLocalTrackEvents(n);let a=this.createGatewayPublishMessage(n);return this.assignLocalTracks(n),n.forEach(c=>{let{track:l,type:u}=c,h=Date.now();this.store.publish(l.getTrackId(),u===$.LocalAudioTrack?"audio":"video",void 0,h)}),a}async dopublish(e){if(!this.sendConnection||this.state!==Ke.Connected)return;let t=this.localTrackMap.get(e);if(t){let{sdp:r,trackMessage:n}=await this.sendConnection.send([t.track]),{mid:a,localSSRC:c}=n[0];t.id=a,t.ssrcs=c,this.statsCollector.addLocalStats(e),this.statsUploader.startUploadUplinkStats();let l=await vt(this,ye.RequestP2PPublish,{kind:e===$.LocalAudioTrack?fe.AUDIO:fe.VIDEO,sdp:r,ssrcId:c[0].ssrcId});await this.sendConnection.setDescription("local",l);let u=this.createUnmuteMessage([[e,t]]);await st(this,ye.RequestUnmuteLocal,u)}}async setDescription(e,t){let r,n;e==="local"?(r=await this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection):(r=await this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection);try{return!n||this.state!==Ke.Connected?void 0:await n.setDescription(e,t)}finally{r()}}publishLowStream(e){return dn(function*(){throw new Y(A.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(S.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await vt(this,ye.RequestRePublish,this.pendingLocalTracks),this.emit(ye.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublish(e){if(!this.sendConnection||this.state!==Ke.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(u=>!ge(e).call(e,u)));let t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;this.unbindLocalTrackEvents(t.map(u=>{let[h,{track:p}]=u;return{type:h,track:p}}));let r=t.filter(u=>{let[,{id:h}]=u;return h!==void 0});if(!this.sendConnection||this.state!==Ke.Connected)return void e.forEach(u=>{let h=this.pendingLocalTracks.indexOf(u);h!==-1&&this.pendingLocalTracks.splice(h,1)});let n=t.find(u=>u[0]==="videoLowTrack");n&&n[1].track.close();let a,c=this.createGatewayUnpublishMessage(t);r.length>0&&(a=await this.sendConnection.stopSending(r.map(u=>{let[,{id:h}]=u;return h}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(u=>{let[h,{track:p}]=u;return{type:h,track:p}})),t.forEach(u=>{let[h]=u;this.statsCollector.removeLocalStats(h)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadUplinkStats();let l=this.createMuteMessage(t);return await F.all(l.map(async u=>{await st(this,ye.RequestMuteLocal,[u])})),{sdp:a,unpubMsg:c}}async unpublishLowStream(){throw new Y(A.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async doUnpublish(e){if(!this.sendConnection||this.state!==Ke.Connected)return;let t=[];if(e!==fe.AUDIO){let r=this.localTrackMap.get($.LocalVideoTrack);(r==null?void 0:r.id)!==void 0&&t.push([$.LocalVideoTrack,r]);let n=this.localTrackMap.get($.LocalVideoLowTrack);(n==null?void 0:n.id)!==void 0&&t.push([$.LocalVideoLowTrack,n]),this.statsCollector.removeLocalStats($.LocalVideoTrack),this.statsCollector.removeLocalStats($.LocalVideoLowTrack)}if(e!==fe.VIDEO){let r=this.localTrackMap.get($.LocalAudioTrack);(r==null?void 0:r.id)!==void 0&&t.push([$.LocalAudioTrack,r]),this.statsCollector.removeLocalStats($.LocalAudioTrack)}if(t.length>0){let r=await this.sendConnection.stopSending(t.map(c=>{let[,l]=c;return l.id}));t.forEach(c=>{let[,l]=c;l.id=void 0,l.ssrcs=void 0});let n=await vt(this,ye.RequestP2PUnPublish,{sdp:r,kind:e});await this.sendConnection.setDescription("local",n);let a=this.createMuteMessage(t);await F.all(a.map(async c=>{await st(this,ye.RequestMuteLocal,[c])}))}}async subscribe(e,t,r,n){var a;if(!this.recvConnection||this.state!==Ke.Connected)throw new Y(A.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((a=this.remoteUserMap.get(e))!==null&&a!==void 0&&a.has(t))return;let{track:c,mid:l,sdp:u}=await this.recvConnection.receive(t,r,n);t===fe.AUDIO?(e._audioSSRC=n,e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(c):(e._audioTrack=new On(c,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(c):(e._videoTrack=new _s(c,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),this.bindRemoteTrackEvents(e,e._videoTrack));let h=this.remoteUserMap.get(e);h?h.set(t,l):this.remoteUserMap.set(e,new Map([[t,l]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadDownlinkStats(),await st(this,ye.RequestP2PUnmuteRemote,t);let p=this.pendingRemoteTracks.findIndex(_=>{let{user:E,kind:T}=_;return E.uid===e.uid&&t===T});return p!==-1&&(this.pendingRemoteTracks.splice(p,1),this.emit(ye.MediaReconnectEnd,e.uid)),u}async unsubscribe(e,t,r,n){let a=this.pendingRemoteTracks.filter(u=>{let{user:h,kind:p}=u;return r!==void 0?h.uid===e.uid&&r===p:h.uid===e.uid});if(a.forEach(u=>{let h=this.pendingRemoteTracks.indexOf(u);this.pendingRemoteTracks.splice(h,1)}),this.recvConnection&&this.state===Ke.Connected||n||a.forEach(u=>{let{kind:h}=u;var p;if(h===fe.AUDIO)(p=e._audioTrack)===null||p===void 0||p._destroy(),e._audioTrack=void 0;else if(h===fe.VIDEO){var _;(_=e._videoTrack)===null||_===void 0||_._destroy(),e._videoTrack=void 0}}),!this.recvConnection||this.state!==Ke.Connected)return;let c=this.filterTobeUnSubscribedTracks(e,r);if(c.length===0)return void(r!==fe.VIDEO&&st(this,ye.RequestP2PMuteRemote,fe.AUDIO));let l=await this.recvConnection.stopReceiving(c.map(u=>{let[,{id:h}]=u;return h}),t);return this.withdrawRemoteTracks(c),this.remoteUserMap.size===0&&this.statsUploader.stopUploadDownlinkStats(),c.forEach(u=>{let[h,{kind:p}]=u;var _,E;if(p===fe.VIDEO&&h._videoSSRC&&((_=this.recvConnection)===null||_===void 0||_.setStatsRemoteVideoIsReady(h._videoSSRC,!1)),p===fe.VIDEO)this.unbindRemoteTrackEvents(h._videoTrack),n||((E=h._videoTrack)===null||E===void 0||E._destroy(),h._videoTrack=void 0);else if(p===fe.AUDIO){var T;this.unbindRemoteTrackEvents(h._audioTrack),!n&&((T=h._audioTrack)===null||T===void 0||T._destroy(),h._audioTrack=void 0)}}),c.filter(u=>{let[,{kind:h}]=u;return h!==fe.AUDIO}).forEach(u=>{let[,{kind:h}]=u;st(this,ye.RequestP2PMuteRemote,h)}),r!==fe.VIDEO&&st(this,ye.RequestP2PMuteRemote,fe.AUDIO),l}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new Y(A.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new Y(A.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new Y(A.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new Y(A.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;let r=this.remoteUserMap.get(e);if(!r)return void S.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!r.get(t))return void S.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));let n=t===fe.VIDEO?e._videoSSRC:e._audioSSRC;n!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;let r=this.remoteUserMap.get(e);if(!r)return void S.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));r.get(t)||S.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){let t=this.localTrackMap.get($.LocalAudioTrack);if((t==null?void 0:t.track)instanceof Vt){let r=t.track;return Array.from(this.localTrackMap.entries()).filter(n=>{let[a]=n;return a!==$.LocalAudioTrack}).filter(n=>{let[a]=n;return!(e&&a===$.LocalVideoLowTrack)}).map(n=>{let[,{track:a}]=n;return a}).concat(r.trackList)}return Array.from(this.localTrackMap.entries()).filter(r=>{let[n]=r;return!(e&&n===$.LocalVideoLowTrack)}).map(r=>{let[,{track:n}]=r;return n})}reportPublishEvent(e,t,r,n,a){if(e){let l=this.localTrackMap.get($.LocalAudioTrack),u=n?this.localTrackMap.get($.LocalVideoLowTrack):this.localTrackMap.get($.LocalVideoTrack);Ee.publish(this.store.sessionId,{eventElapse:Ii.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:l==null?void 0:l.track.getTrackLabel(),videoName:u==null?void 0:u.track.getTrackLabel(),screenshare:(u==null?void 0:u.track._hints.indexOf(ut.SCREEN_TRACK))!==-1,audio:!!l,video:!!u,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:a})}else{var c;r||(r=[]);let l=r.find(h=>h instanceof Qe),u=n?(c=this.localTrackMap.get($.LocalVideoTrack))===null||c===void 0?void 0:c.track:r.find(h=>h instanceof ke);Ee.publish(this.store.sessionId,{eventElapse:Ii.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:l==null?void 0:l.getTrackLabel(),videoName:u==null?void 0:u.getTrackLabel(),screenshare:(u==null?void 0:u._hints.indexOf(ut.SCREEN_TRACK))!==-1,audio:!!l,video:!!u,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:a})}}reportSubscribeEvent(e,t,r,n){let a=n===fe.VIDEO?r._videoSSRC:r._audioSSRC;a&&Ee.subscribe(this.store.sessionId,{succ:e,ec:t,video:n===fe.VIDEO,audio:n===fe.AUDIO,peerid:r.uid,subscribeRequestid:n===fe.VIDEO?r._videoSSRC:r._audioSSRC,p2pid:this.store.p2pId,eventElapse:Ii.measureFromSubscribeStart(this.store.clientId,a)})}reset(){S.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new si("P2PChannel2-send-mutex"),this.sendMutex=new si("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let e=this.localTrackMap.get($.LocalAudioTrack);if((e==null?void 0:e.track)instanceof Vt){if(e.track.trackList.length>0){let t=e.track;e.track.trackList.forEach(r=>{t.removeAudioTrack(r)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.state=Ke.Disconnected}getStats(e){var t,r;return e?(r=this.recvConnection)===null||r===void 0?void 0:r.getStats():(t=this.sendConnection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.recvConnection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){let e=this.localTrackMap.get($.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){let e=this.localTrackMap.get($.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){let t=this.localTrackMap.get(e);return t&&t.track instanceof ke||t&&t.track instanceof Qe?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;let r=this.remoteUserMap.get(e);return!!r&&(!t||r.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;let r=this.remoteUserMap.get(e);return!!r&&(!t||r.has(t))}getRemoteMedia(e){var t;let r=Array.from(Ur(t=this.remoteUserMap).call(t)).find(n=>n.uid===e);return r?{audioTrack:r.audioTrack,audioSSRC:r._audioSSRC,videoTrack:r.videoTrack,videoSSRC:r._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(r=>{let[n]=r;return{uid:n.uid,level:n.audioTrack?100*n.audioTrack._source.getAccurateVolumeLevel():0}}),t=this.localTrackMap.get($.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=td(e).call(e,(r,n)=>r.level-n.level),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(S.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Ke.Reconnecting,P("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var r;t._videoTrack&&t._videoTrack._player&&((r=t._videoTrack._player.getVideoElement())===null||r===void 0||r.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[r,{track:n}]=e;switch(r){case $.LocalVideoTrack:ge(t=n._hints).call(t,ut.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case $.LocalAudioTrack:n instanceof Vt?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case $.LocalVideoLowTrack:}}),this.emit(ye.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,r]=e;Array.from(Ur(r).call(r)).forEach(n=>{this.setPendingRemoteMedia(t,n)}),this.emit(ye.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),S.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(let r of this.pendingRemoteTracks){let{user:n,kind:a}=r;if((e instanceof wi?e.uid:e)===n.uid&&t===a)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e){let t;t=e.direction===Gc.SEND_ONLY?await this.sendMutex.lock("From P2PChannel.restartICE"):await this.recvMutex.lock("From P2PChannel.restartICE");try{let r=await e.restartICE(),n=await vt(this,ye.RequestP2PRestartICE,r);e.setDescription("local",n)}finally{t()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;let e=this.sendConnection.getStats(),t=this.localTrackMap.get($.LocalVideoTrack),r=this.localTrackMap.get($.LocalAudioTrack),n=e.videoSend.find(w=>{var C;return w.ssrc===(t==null||(C=t.ssrcs)===null||C===void 0?void 0:C[0].ssrcId)}),a=e.audioSend.find(w=>{var C;return w.ssrc===(r==null||(C=r.ssrcs)===null||C===void 0?void 0:C[0].ssrcId)});if(!n||!a)return 1;let c=cr(this,ye.NeedSignalRTT),l=n?n.rttMs:void 0,u=a?a.rttMs:void 0,h=l&&u?(l+u)/2:l||u,p=(h&&c?(h+c)/2:h||c)||0,_=100*e.sendPacketLossRate*.7/50+.3*p/1500,E=_<.17?1:_<.36?2:_<.59?3:_<.1?4:5,T=t==null?void 0:t.track;if(T&&T._encoderConfig&&T._hints.indexOf(ut.SCREEN_TRACK)===-1){let w=T._encoderConfig.bitrateMax,C=e.bitrate.actualEncoded;if(w&&C){let O=(1e3*w-C)/(1e3*w);return UA[O<.15?0:O<.3?1:O<.45?2:O<.6?3:4][E]}}return E}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;let e=this.recvConnection.getStats(),t=0;return Array.from(this.remoteUserMap.entries()).forEach(r=>{let[n]=r,a=n._audioSSRC,c=n._videoSSRC,l=e.audioRecv.find(C=>C.ssrc===a),u=e.videoRecv.find(C=>C.ssrc===c);if(!l&&!u)return void(t+=1);let h=cr(this,ye.NeedSignalRTT),p=e.rtt,_=(p&&h?(p+h)/2:p||h)||0,E=l?l.jitterMs:void 0,T=e.recvPacketLossRate,w=.7*T*100/50+.3*_/1500;E&&(w=.6*T*100/50+.2*_/1500+.2*E/400),t+=w<.1?1:w<.17?2:w<.36?3:w<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new F((t,r)=>{this.handleMuteLocalTrack(e,t,r)})}filterTobePublishedTracks(e,t,r){let n=[],a=ct(),c=this.getAllTracks();e=Mc(e=e.filter(h=>c.indexOf(h)===-1));let l=!1,u=!1;for(let h of e){if(h instanceof ke&&(this.localTrackMap.has($.LocalVideoTrack)||l?new Y(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:h,type:$.LocalVideoTrack}),l=!0),t)){let p=this.getLowVideoTrack(h,r);n.push({track:p,type:$.LocalVideoLowTrack})}if(h instanceof Qe){let p=this.localTrackMap.get($.LocalAudioTrack);if(p){if(!(p.track instanceof Vt))throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(h._bypassWebAudio)throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");p.track.addAudioTrack(h),this.bindLocalAudioTrackEvents(h,!0)}else if(u){let _=n.find(E=>{let{type:T}=E;return T===$.LocalAudioTrack});if(!(_.track instanceof Vt))throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(h._bypassWebAudio)throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");_.track.addAudioTrack(h)}else{if(!a.webAudioMediaStreamDest||h instanceof Vt||h._bypassWebAudio)n.push({track:h,type:$.LocalAudioTrack});else{let _=new Vt;_.addAudioTrack(h),n.push({track:_,type:$.LocalAudioTrack})}u=!0}}}return n}filterTobeUnpublishedTracks(e){let t=[],r=this.getAllTracks();e=Mc(e=e.filter(n=>r.indexOf(n)!==-1));for(let n of e){if(n instanceof Qe){let a=this.localTrackMap.get($.LocalAudioTrack);if(!a)continue;a.track instanceof Vt?(a.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),a.track.trackList.length===0&&(t.push([$.LocalAudioTrack,a]),a.track.close())):t.push([$.LocalAudioTrack,a])}if(n instanceof ke){let a=this.localTrackMap.get($.LocalVideoTrack);if(!a)continue;t.push([$.LocalVideoTrack,a]);let c=this.localTrackMap.get($.LocalVideoLowTrack);c&&t.push([$.LocalVideoLowTrack,c])}}return t}bindLocalTrackEvents(e){e.forEach(t=>{let{track:r,type:n}=t;switch(n){case $.LocalVideoTrack:r.addListener(ue.GET_STATS,this.handleGetLocalVideoStats),r.addListener(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.addListener(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.addListener(ue.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),r.addListener(ue.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),r.addListener(ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),r.addListener(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.addListener(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case $.LocalAudioTrack:this.bindLocalAudioTrackEvents(r);case $.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof Vt?e.trackList.forEach(r=>{r.addListener(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.addListener(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.addListener(ue.GET_STATS,this.handleGetLocalAudioStats),r.addListener(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.addListener(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(ue.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(ue.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[r,{track:n}]=t;return{track:n,type:r}})),e.forEach(t=>{let{track:r,type:n}=t;switch(n){case $.LocalVideoTrack:r.off(ue.GET_STATS,this.handleGetLocalVideoStats),r.off(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),r.off(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),r.off(ue.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),r.off(ue.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),r.off(ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),r.off(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),r.off(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case $.LocalAudioTrack:this.unbindLocalAudioTrackEvents(r);case $.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof Vt?e.trackList.forEach(t=>{t.off(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ue.GET_STATS,this.handleGetLocalAudioStats),t.off(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(ue.GET_STATS,this.handleGetLocalAudioStats),e.off(ue.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ue.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ue.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ue.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ue.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof _s&&t.addListener(ue.GET_STATS,r=>{r(this.handleGetRemoteVideoStats(e))}),t instanceof On&&t.addListener(ue.GET_STATS,r=>{r(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ue.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,r]=e;r.has(fe.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),r.has(fe.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e){return e.map(t=>{var r;let n,a,{track:c,type:l}=t;switch(l){case $.LocalAudioTrack:n=et.Audio,a={dtx:c instanceof ga&&c._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case $.LocalVideoTrack:n=ge(r=c._hints).call(r,ut.SCREEN_TRACK)?et.Screen:et.High,a=Da(Da({},Np(c)),{},{codec:this.store.codec});break;case $.LocalVideoLowTrack:n=et.Low,a=Da(Da({},Np(c)),{},{codec:this.store.codec})}return{kind:l===$.LocalAudioTrack?fe.AUDIO:fe.VIDEO,stream_type:n,attributes:a,isMuted:c.muted||!c.enabled}})}createGatewayUnpublishMessage(e){return e.map(t=>{var r;let n,[a,{track:c,ssrcs:l,id:u}]=t;switch(a){case $.LocalVideoTrack:n=ge(r=c._hints).call(r,ut.SCREEN_TRACK)?et.Screen:et.High;break;case $.LocalAudioTrack:n=et.Audio;break;case $.LocalVideoLowTrack:n=et.Low}return{stream_type:n,ssrcs:l,mid:u}})}assignLocalTracks(e){e.forEach(t=>{let{track:r,type:n}=t;this.localTrackMap.set(n,{track:r})})}withdrawLocalTracks(e){e.forEach(t=>{let[r]=t;this.localTrackMap.delete(r)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{var r;if(S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(ye.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),ge(r=this._restartStates).call(r,t)||e.direction===Gc.SEND_ONLY){if(this._restartTimer)return;let n=()=>{(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")&&(S.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE")),cr(this,ye.QueryClientConnectionState)==="CONNECTED"&&this.restartICE(e))};this._restartTimer=window.setTimeout(()=>{n(),this._restartTimer=void 0},800)}},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),Ee.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:St.TRACER}).onSuccess(),this.emit(ye.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var r;let n=Array.from(Ur(r=this.remoteUserMap).call(r)).find(c=>c._audioSSRC===t);var a;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(a=n.audioTrack)===null||a===void 0||a.emit(Oo.FIRST_FRAME_DECODED),Ee.firstRemoteFrame(this.store.sessionId,$t.FIRST_AUDIO_DECODE,Et.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:Ii.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var r;let n=Array.from(Ur(r=this.remoteUserMap).call(r)).find(a=>a._audioSSRC===t);n&&Ee.firstRemoteFrame(this.store.sessionId,$t.FIRST_AUDIO_RECEIVED,Et.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:Ii.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,r,n)=>{this.reportVideoFirstFrameDecoded(t,r,n)},e.onFirstVideoReceived=t=>{var r;let n=Array.from(Ur(r=this.remoteUserMap).call(r)).find(a=>a._videoSSRC===t);n&&Ee.firstRemoteFrame(this.store.sessionId,$t.FIRST_VIDEO_RECEIVED,Et.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:Ii.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,r)=>{let n=t.candidateType==="relay",a=r.candidateType==="relay";r.candidateType!=="unknown"&&n===a||this.emit(ye.ConnectionTypeChange,n),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Ia(r))," -> ").concat(JSON.stringify(Ia(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,r)=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Ia(r))," -> ").concat(JSON.stringify(Ia(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(ye.LocalCandidate,t)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}filterTobeMutedTracks(e){let t=[];if(this.getAllTracks().indexOf(e)===-1)return t;let r=this.localTrackMap.get($.LocalAudioTrack);if(e instanceof Qe&&(r==null?void 0:r.track)instanceof Vt)return r.track.isActive||t.push([$.LocalAudioTrack,r]),t;let n=Array.from(this.localTrackMap.entries()).find(a=>{let[,{track:c}]=a;return e===c});if(n&&(t.push(n),n[0]===$.LocalVideoTrack)){let a=this.localTrackMap.get($.LocalVideoLowTrack);a&&t.push([$.LocalVideoLowTrack,a])}return t}filterTobeUnmutedTracks(e){let t=[],r=this.localTrackMap.get($.LocalAudioTrack);if(e instanceof Qe&&(r==null?void 0:r.track)instanceof Vt)return r.track.isActive&&t.push([$.LocalAudioTrack,r]),t;let n=Array.from(this.localTrackMap.entries()).find(a=>{let[,{track:c}]=a;return e===c});if(n)if(n[0]===$.LocalVideoTrack){t.push(n);let a=this.localTrackMap.get($.LocalVideoLowTrack);a&&t.push([$.LocalVideoLowTrack,a])}else t.push(n);return t}createMuteMessage(e){return e.map(t=>{var r;let n,[a,{track:c,ssrcs:l,id:u}]=t;switch(a){case $.LocalAudioTrack:n=et.Audio;break;case $.LocalVideoTrack:n=ge(r=c._hints).call(r,ut.SCREEN_TRACK)?et.Screen:et.High;break;case $.LocalVideoLowTrack:n=et.Low}return{stream_type:n,ssrcs:l,mid:u}})}createUnmuteMessage(e){return e.map(t=>{var r;let n,[a,{track:c,ssrcs:l,id:u}]=t;switch(a){case $.LocalAudioTrack:n=et.Audio;break;case $.LocalVideoTrack:n=ge(r=c._hints).call(r,ut.SCREEN_TRACK)?et.Screen:et.High;break;case $.LocalVideoLowTrack:n=et.Low}return{stream_type:n,ssrcs:l,mid:u}})}filterTobeUnSubscribedTracks(e,t){let r=[],n=this.remoteUserMap.get(e);if(!n)return r;if(t){let a=n.get(t);if(!a)return r;r.push([e,{kind:t,id:a}])}else Array.from(n.entries()).forEach(a=>{let[c,l]=a;r.push([e,{kind:c,id:l}])});return r}createUnsubscribeMessage(e){let t=[];return e.forEach(r=>{let[n,{kind:a,id:c}]=r;switch(a){case fe.VIDEO:return void(n._videoSSRC&&t.push({stream_type:fe.VIDEO,ssrcId:n._videoSSRC}));case fe.AUDIO:return void(n._audioSSRC&&t.push({stream_type:fe.AUDIO,ssrcId:n._audioSSRC}))}}),t}withdrawRemoteTracks(e){e.forEach(t=>{let[r,{kind:n}]=t,a=this.remoteUserMap.get(r);a&&(a.delete(n),Array.from(a.entries()).length===0&&this.remoteUserMap.delete(r))})}async updateBitrateLimit(e){let t=this.localTrackMap.get($.LocalVideoTrack),r=this.localTrackMap.get($.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),r&&e.low_stream_uplink&&await r.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){let e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return e!=="connected"&&t!=="connected"}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof Qe){let r=this.filterTobeUnmutedTracks(e[t]);if(r.length===0)continue;let n=this.createUnmuteMessage(r);return void await st(this,ye.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(e=>{let[,{ssrcs:t}]=e;return!!t}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.recvConnection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(ye.RequestUploadStats,e,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Si(Bh(this.dtlsFailedCount,xt)),this.emit(ye.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has($.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof ke)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof ke).length>1)throw new Y(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof Qe).length>1&&(e.some(t=>t instanceof Qe&&t._bypassWebAudio)||!ct().webAudioMediaStreamDest))throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let t of e){if(t instanceof ke&&this.pendingLocalTracks.some(r=>r instanceof ke))throw new Y(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Qe&&this.pendingLocalTracks.some(r=>r instanceof Qe)&&(!ct().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(r=>r instanceof Qe&&r._bypassWebAudio)))throw new Y(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){let r=!P("DISABLE_DUAL_STREAM_USE_ENCODING")&&ct().supportDualStreamEncoding,n=Da(Da({},{width:160,height:120,framerate:15,bitrate:50}),t),a;a=r?e._mediaStreamTrack.clone():lS(e,n);let c=at(8,"track-low-"),l=new ke(a,Da(Da({},r&&{scaleResolutionDownBy:zg(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,c);return l.on(zc.TRANSCEIVER_UPDATED,u=>{e._updateRtpTransceiver(u,ma.LOW_STREAM)}),l._hints.push(ut.LOW_STREAM),e.addListener(ue.NEED_CLOSE,()=>{l.close()}),l}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,r,n){var a;let c=Array.from(Ur(a=this.remoteUserMap).call(a)).find(l=>l._videoSSRC===e);if(c){n||this.store.subscribe(c.uid,"video",void 0,void 0,void 0,void 0,Date.now());let l=this.store.keyMetrics,u=l.subscribe.find(h=>h.userId===c.uid&&h.type==="video");Ee.firstRemoteVideoDecode(this.store.sessionId,$t.FIRST_VIDEO_DECODE,Et.FIRST_VIDEO_DECODE,{peer:c._uintid,videowidth:t,videoheight:r,subscribeElapse:Ii.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:l.requestAPEnd||0,apStart:l.requestAPStart||0,joinGwEnd:l.joinGatewayEnd||0,joinGwStart:l.joinGatewayStart||0,pcEnd:l.peerConnectionEnd||0,pcStart:l.peerConnectionStart||0,subscriberEnd:(u==null?void 0:u.subscribeEnd)||0,subscriberStart:(u==null?void 0:u.subscribeStart)||0,videoAddNotify:(u==null?void 0:u.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(e,t,r){if(!this.recvConnection)return!1;let n=this.remoteUserMap.get(e);if(!n)return!1;let a=n.get(t);if(!a)return!1;let c=await this.recvConnection.getRemoteSSRC(a);return c!==void 0&&c!==r}resetConnection(e){S.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===Ke.Connected?(S.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new Y(A.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new Y(A.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new Y(A.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new Y(A.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new Y(A.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new Y(A.NOT_SUPPORTED)}async preConnect(e,t,r,n,a,c){throw new Y(A.NOT_SUPPORTED)}getEstablishParams(){throw new Y(A.NOT_SUPPORTED)}async reSubscribe(e){throw new Y(A.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new Y(A.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:r}]=e;t===$.LocalVideoLowTrack?r._updateRtpTransceiver(void 0,ma.LOW_STREAM):r._updateRtpTransceiver(void 0)})}}function fn(i){return function(e,t,r){let n=e[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){for(var a=arguments.length,c=new Array(a),l=0;l<a;l++)c[l]=arguments[l];switch(i){case pn.SEND_ONLY:{let u=await this.sendMutex.lock("From P2PChannel2.".concat(t));try{return await n.apply(this,c)}finally{u()}}case pn.RECEIVE_ONLY:{let u=await this.recvMutex.lock("From P2PChannel2.".concat(t));try{return await n.apply(this,c)}finally{u()}}default:{let u=await this.sendMutex.lock("From P2PChannel2.".concat(t)),h=await this.recvMutex.lock("From P2PChannel2.".concat(t));try{return await n.apply(this,c)}finally{u(),h()}}}},r}}function eb(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function tb(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?eb(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):eb(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}J([fn(),R("design:type",Function),R("design:paramtypes",[Object,String]),R("design:returntype",F)],Rt.prototype,"startP2P",null),J([fn(),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Rt.prototype,"p2pConnect",null),J([fn(pn.SEND_ONLY),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Rt.prototype,"dopublish",null),J([fn(pn.SEND_ONLY),R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],Rt.prototype,"unpublish",null),J([fn(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],Rt.prototype,"unpublishLowStream",null),J([fn(pn.SEND_ONLY),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],Rt.prototype,"doUnpublish",null),J([fn(pn.RECEIVE_ONLY),R("design:type",Function),R("design:paramtypes",[wi,String,String,Number]),R("design:returntype",F)],Rt.prototype,"subscribe",null),J([fn(pn.RECEIVE_ONLY),R("design:type",Function),R("design:paramtypes",[wi,String,String,Boolean]),R("design:returntype",F)],Rt.prototype,"unsubscribe",null),J([fn(pn.RECEIVE_ONLY),R("design:type",Function),R("design:paramtypes",[wi,String]),R("design:returntype",F)],Rt.prototype,"muteRemote",null),J([fn(pn.RECEIVE_ONLY),R("design:type",Function),R("design:paramtypes",[wi,String]),R("design:returntype",F)],Rt.prototype,"unmuteRemote",null),J([fn(pn.RECEIVE_ONLY),R("design:type",Function),R("design:paramtypes",[wi,String]),R("design:returntype",F)],Rt.prototype,"hasRemoteMediaWithLock",null),J([fn(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],Rt.prototype,"disconnectForReconnect",null),J([fn(pn.RECEIVE_ONLY),R("design:type",Function),R("design:paramtypes",[wi,String,Number]),R("design:returntype",F)],Rt.prototype,"remoteMediaSsrcChanged",null);let KG=Date.now(),zG=20,TS=new Map,Qp=new Map;async function ib(i){let e=TS.get(i),t=Array.isArray(e)&&e[e.length-1],r=Qp.get(i);if(!t)return void(r.isSyncing=!1);let n={uid:t.uid,payload:xh(t.payload)};r.firstRecvTs===0&&(r.firstRecvTs=t.recvTs,r.firstSendTs=t.sendTs);let a=t.sendTs-r.firstSendTs,c=a-(Date.now()-r.firstRecvTs);c>0&&(r.firstRecvTs=Date.now()-a);let l=t.mediaDelay+c;l<=0?(e.pop(),rb(t.context,n),l=0):l=Math.min(l,zG),setTimeout(()=>e.length&&ib(i),l)}function rb(i,e){i.safeEmit(je.STREAM_MESSAGE,e.uid,e.payload),i.onStreamMessage&&i.onStreamMessage(e)}function YG(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,t=arguments.length>2?arguments[2]:void 0;if(!i.syncWithAudio)return rb(t,{uid:i.uid,payload:xh(i.payload)});let r="".concat(t.id,"-").concat(i.uid),n=TS.get(r)||[],a=n.findIndex(h=>i.sendTs>=h.sendTs),c=tb(tb({},i),{},{context:t,mediaDelay:e,recvTs:Date.now()});a===-1?n.push(c):n.splice(a,0,c),TS.set(r,n);let l=!1;var u;Qp.has(r)?l=!((u=Qp.get(r))===null||u===void 0||!u.isSyncing):Qp.set(r,{isSyncing:l,firstRecvTs:0,firstSendTs:0}),l||ib(r)}let qG=ze().name;function JG(){return!function(i,e,t){let r=ze();if(r.os!==Jt.IOS||!r.osVersion)return!1;let n=r.osVersion.split(".");return t?e&&Number(n[0])===i&&Number(n[1])<e||Number(n[0])<i:e?Number(n[0])===i&&Number(n[1])<=e||Number(n[0])<i:Number(n[0])<=i}(16,0,!0)&&!function(i,e,t){let r=ze();if(r.name!==Xe.SAFARI||!r.osVersion)return!1;let n=r.version.split(".");return t?e&&Number(n[0])===i&&Number(n[1])<e||Number(n[0])<i:e?Number(n[0])===i&&Number(n[1])<=e||Number(n[0])<i:Number(n[0])<=i}(16,0,!0)}function nb(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Kd(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?nb(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):nb(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}si.setLogger(S);class ot extends mt{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let t;if(super(),g(this,"store",void 0),g(this,"_uid",void 0),g(this,"_channelName",void 0),g(this,"_uintUid",void 0),g(this,"_users",[]),g(this,"_config",void 0),g(this,"_clientId",void 0),g(this,"_appId",void 0),g(this,"_sessionId",null),g(this,"_key",void 0),g(this,"_joinInfo",void 0),g(this,"_gateway",void 0),g(this,"_statsCollector",void 0),g(this,"_configDistribute",void 0),g(this,"_leaveMutex",new si("client-leave")),g(this,"_publishMutex",new si("client-publish")),g(this,"_renewTokenMutex",new si("client-renewtoken")),g(this,"_subscribeMutex",new si("client-subscribe")),g(this,"_encryptionMode","none"),g(this,"_encryptionSecret",null),g(this,"_encryptionSalt",null),g(this,"_proxyServer",void 0),g(this,"_turnServer",{servers:[],mode:"auto"}),g(this,"_cloudProxyServerMode","disabled"),g(this,"_isDualStreamEnabled",!1),g(this,"_defaultStreamFallbackType",void 0),g(this,"_lowStreamParameter",void 0),g(this,"_streamFallbackTypeCacheMap",new Map),g(this,"_remoteStreamTypeCacheMap",new Map),g(this,"_axiosCancelSource",lr.CancelToken.source()),g(this,"_audioVolumeIndicationInterval",void 0),g(this,"_networkQualityInterval",void 0),g(this,"_userOfflineTimeout",void 0),g(this,"_streamRemovedTimeout",void 0),g(this,"_injectStreamingClient",void 0),g(this,"_liveTranscodeStreamingClient",void 0),g(this,"_liveRawStreamingClient",void 0),g(this,"_channelMediaRelayClient",void 0),g(this,"_networkQualitySensitivity","normal"),g(this,"_p2pChannel",void 0),g(this,"_useLocalAccessPoint",!1),g(this,"_setLocalAPVersion",void 0),g(this,"_joinAndNotLeaveYet",!1),g(this,"_numberOfJoinCount",0),g(this,"_remoteDefaultVideoStreamType",void 0),g(this,"_inspect",void 0),g(this,"_moderation",void 0),g(this,"_license",void 0),g(this,"_pendingPublishedUsers",[]),g(this,"ntpAlignErrorCount",0),g(this,"remoteInboundOffset",0),g(this,"_handleLocalTrackEnable",(r,n,a)=>{this.publish(r,!1).then(n).catch(a)}),g(this,"_handleLocalTrackDisable",(r,n,a)=>{this.unpublish(r).then(n).catch(a)}),g(this,"_handleUserOnline",r=>{if(P("BLOCK_LOCAL_CLIENT")&&Io(r.uid,this.channelName))return void S.debug("[".concat(r.uid,"] will be ignored in local"));this.isStringUID&&typeof r.uid!="string"&&S.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));let n=this._users.find(a=>a.uid===r.uid);if(n)n._trust_in_room_=!0;else{let a=new wi(r.uid,r.uint_id||r.uid);this._users.push(a),S.debug("[".concat(this._clientId,"] user online"),r.uid),this.safeEmit(je.USER_JOINED,a)}}),g(this,"_handleUserOffline",r=>{if(P("BLOCK_LOCAL_CLIENT")&&Io(r.uid,this.channelName))return;let n=this._users.find(a=>a.uid===r.uid);n&&(this._handleRemoveStream(r),this._handleRemoveDataChannels(r),CE(this._users,n),this._remoteStreamTypeCacheMap.delete(n.uid),this._streamFallbackTypeCacheMap.delete(n.uid),S.debug("[".concat(this._clientId,"] user offline"),r.uid,"reason:",r.reason),this.safeEmit(je.USER_LEAVED,n,r.reason))}),g(this,"_handleAddAudioOrVideoStream",(r,n,a,c,l,u,h)=>{if(P("BLOCK_LOCAL_CLIENT")&&Io(n,this.channelName))return;let p=this._users.find(E=>E.uid===n);if(!p)return void S.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));S.debug("[".concat(this._clientId,"] stream added with uid ").concat(n,", type ").concat(r)),this.store.subscribe(p.uid,r,void 0,void 0,void 0,Date.now());let _=r==="audio"?p.hasAudio:p.hasVideo;p._uintid||(p._uintid=l||n),r==="audio"?p._trust_audio_stream_added_state_=!0:p._trust_video_stream_added_state_=!0,r==="audio"?(p._audio_added_=!0,a!==void 0&&(p._audioSSRC=a),c!==void 0&&(p._cname=c),u&&(p._audioOrtc=u)):(p._video_added_=!0,a!==void 0&&(p._videoSSRC=a),c!==void 0&&(p._cname=c),h!==void 0&&(p._rtxSsrcId=h),u&&(p._videoOrtc=u)),(r==="audio"?p.hasAudio:p.hasVideo)&&!_&&(S.info("[".concat(this._clientId,"] remote user ").concat(p.uid," published ").concat(r)),this.safeEmit(je.USER_PUBLISHED,p,r)),r==="video"?Ee.onGatewayStream(this._sessionId,$t.ON_ADD_VIDEO_STREAM,Et.ON_ADD_VIDEO_STREAM,{peer:l||n,ssrc:p._videoSSRC}):Ee.onGatewayStream(this._sessionId,$t.ON_ADD_AUDIO_STREAM,Et.ON_ADD_AUDIO_STREAM,{peer:l||n,ssrc:p._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(p,r,a).then(E=>{if(E&&(S.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(p.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof di))return this._p2pChannel.unsubscribe(p,r,!0).then(()=>this._subscribe(p,r,!0).catch(T=>{S.error("[".concat(this._clientId,"] resubscribe error"),T.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(p,r)&&(S.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(p.uid," after reconnect.")),this._subscribe(p,r,!0).catch(E=>{S.error("[".concat(this._clientId,"] resubscribe error"),E.toString())}))}),g(this,"_handleRemoveStream",(r,n,a)=>{if(P("BLOCK_LOCAL_CLIENT")&&Io(r.uid,this.channelName))return;let c=this._users.find(u=>u.uid===r.uid);if(!c)return void S.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));S.debug("[".concat(this._clientId,"] stream removed with uid ").concat(r.uid));let l=()=>{};if(c.hasAudio&&c.hasVideo?l=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished audio track")),this.safeEmit(je.USER_UNPUBLISHED,c,"audio"),S.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished video track")),this.safeEmit(je.USER_UNPUBLISHED,c,"video")}:c.hasVideo?l=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished video track")),this.safeEmit(je.USER_UNPUBLISHED,c,"video")}:c.hasAudio&&(l=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(c.uid," unpublished audio track")),this.safeEmit(je.USER_UNPUBLISHED,c,"audio")}),c._trust_audio_stream_added_state_=!0,c._trust_video_stream_added_state_=!0,c._audio_added_=!1,c._video_added_=!1,this._p2pChannel instanceof di)this._p2pChannel.unsubscribe(c).then(u=>{if(u)return this._gateway.unsubscribe(u,c.uid)});else if(n&&a)if(r.sdp){let{sdp:u}=r;this._p2pChannel.unsubscribe(c,u).then(h=>{h&&n(h)}).catch(a)}else n&&n();c._audioSSRC=void 0,c._videoSSRC=void 0,c._audioOrtc=void 0,c._videoOrtc=void 0,c._rtxSsrcId=void 0,Ee.onGatewayStream(this._sessionId,$t.ON_REMOVE_STREAM,Et.ON_REMOVE_STREAM,{peer:r.uint_id||r.uid}),l()}),g(this,"_handleSetStreamLocalEnable",(r,n,a)=>{if(P("BLOCK_LOCAL_CLIENT")&&Io(n,this.channelName))return;let c=this._users.find(h=>h.uid===n);if(!c)return void S.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));S.debug("[".concat(this._clientId,"] local ").concat(r," ").concat(a?"enabled":"disabled"," with uid ").concat(n));let l=r==="audio"?c.hasAudio:c.hasVideo;if(r==="audio"){c._trust_audio_enabled_state_=!0;let h=c._audio_enabled_;if(c._audio_enabled_=a,c._audio_enabled_===h)return;{let p=c._audio_enabled_?"enable-local-audio":"disable-local-audio";S.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(n,", msg: ").concat(p)),this.safeEmit(je.USER_INFO_UPDATED,n,p)}}else{c._trust_video_enabled_state_=!0;let h=c._video_enabled_;if(c._video_enabled_=a,c._video_enabled_===h)return;{let p=c._video_enabled_?"enable-local-video":"disable-local-video";S.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(p)),this.safeEmit(je.USER_INFO_UPDATED,n,p)}}let u=r==="audio"?c.hasAudio:c.hasVideo;return l!==u?!l&&u?(S.info("[".concat(this._clientId,"] remote user ").concat(n," published ").concat(r)),void this.safeEmit(je.USER_PUBLISHED,c,r)):(r==="video"&&c._videoTrack&&c._videoTrack._destroy(),r==="audio"&&c._audioTrack,this._p2pChannel.muteRemote(c,r),S.info("[".concat(this._clientId,"] remote user ").concat(n," unpublished ").concat(r)),void this.safeEmit(je.USER_UNPUBLISHED,c,r)):void 0}),g(this,"_handleMuteStream",(r,n,a,c,l,u)=>{if(P("BLOCK_LOCAL_CLIENT")&&Io(r,this.channelName))return;S.debug("[".concat(this._clientId,"] receive mute message"),r,n,a);let h=this._users.find(E=>E.uid===r);if(!h)return void S.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r));let p=n==="audio"?h.hasAudio:h.hasVideo;if(n==="audio"){h._trust_audio_mute_state_=!0;let E=h._audio_muted_;if(h._audio_muted_=a,h._audio_muted_===E)return;{let T=h._audio_muted_?"mute-audio":"unmute-audio";S.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(T)),this.safeEmit(je.USER_INFO_UPDATED,r,T)}}else{h._trust_video_mute_state_=!0;let E=h._video_muted_;if(h._video_muted_=a,h._video_muted_===E)return;{let T=h._video_muted_?"mute-video":"unmute-video";S.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(T)),this.safeEmit(je.USER_INFO_UPDATED,r,T)}}let _=n==="audio"?h.hasAudio:h.hasVideo;if(p!==_){if(!p&&_)return!this.store.useP2P&&!(n==="audio"?h._audioSSRC:h._videoSSRC)?void S.warning("[".concat(this._clientId,"] remote user ").concat(r," receive ").concat(n," unmute message  before add stream message, ").concat(n," SSRC doesn't exist yet.")):(S.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(n)),void this.safeEmit(je.USER_PUBLISHED,h,n));n==="video"&&h._videoTrack&&h._videoTrack._destroy(),n==="audio"&&h._audioTrack,l&&u&&this._p2pChannel instanceof Rt&&(c?this._p2pChannel.unsubscribe(h,c,n).then(E=>{l(E)}).catch(u):l()),this._p2pChannel.muteRemote(h,n),S.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(n)),this.safeEmit(je.USER_UNPUBLISHED,h,n)}}),g(this,"_handleP2PLost",async r=>{S.debug("[".concat(this._clientId,"] receive p2p lost"),r),parseInt(r.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():S.warning("[".concat(this._clientId,"] P2PLost stream not found"),r)}),g(this,"_handleTokenWillExpire",()=>{S.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(je.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),g(this,"_handleBeforeUnload",r=>{r.type==="beforeunload"&&r.returnValue!==void 0&&r.returnValue!==""||(this.leave(),S.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),g(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(je.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});let r={downlinkNetworkQuality:0,uplinkNetworkQuality:0};r.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),r.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(je.NETWORK_QUALITY,r)}),g(this,"_handleP2PAddAudioOrVideoStream",(r,n)=>{let a=this._users.find(l=>l.uid===n);if(!a)return void S.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));S.debug("[".concat(this._clientId,"] stream added with uid ").concat(n,", type ").concat(r)),this.store.subscribe(a.uid,r,void 0,void 0,void 0,Date.now());let c=r==="audio"?a.hasAudio:a.hasVideo;r==="audio"?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,r==="audio"?a._audio_added_=!0:a._video_added_=!0,(r==="audio"?a.hasAudio:a.hasVideo)&&!c&&(S.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(r)),this.safeEmit(je.USER_PUBLISHED,a,r)),this._p2pChannel.hasPendingRemoteMedia(a,r)&&(S.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,r,!0).catch(l=>{S.error("[".concat(this._clientId,"] resubscribe error"),l.toString())}))}),this._config=e,this._clientId=at(5,"client-"),this.store=new e5(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),S.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(nn," build: ").concat(YE,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{Cw(e.clientRoleOptions),t=Object.assign({},e.clientRoleOptions)}catch(r){S.warning("[".concat(this._clientId,"] ").concat(r.toString()))}this._statsCollector=new il(this.store),this._statsCollector.onStatsException=(r,n,a)=>{S.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(r,", msg: ").concat(n,", uid: ").concat(a)),this.safeEmit(je.EXCEPTION,{code:r,msg:n,uid:a})},this._statsCollector.onUploadPublishDuration=(r,n,a,c)=>{let l=this._users.find(u=>u.uid===r);l&&Ee.peerPublishStatus(this._sessionId,{subscribeElapse:c,audioPublishDuration:n,videoPublishDuration:a,peer:l._uintid})},this.store.useDataChannel=ct().supportDataChannel&&P("SIGNAL_CHANNEL"),this.store.useP2P=P("P2P"),this._gateway=new rG(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||xt,httpRetryConfig:e.httpRetryConfig||xt,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:t}),this._configDistribute=new hG,this.store.useP2P?(this._p2pChannel=new Rt(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new di(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,r,n,a){let c=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],l=arguments.length>6&&arguments[6]!==void 0&&arguments[6];it("JOIN_GATEWAY_USE_443PORT_ONLY",c),it("JOIN_GATEWAY_USE_DUAL_DOMAIN",l);let u=this._gateway.signal.websocket;return u instanceof gd&&(u.use443PortOnly=c,u.tryDoubleDomain=l),async function(h,p,_){Dh.get(h)||Dh.set(h,[]),Ph.get(h)||Ph.set(h,p),cs.get(h)||cs.set(h,0);let E=Dh.get(h),T=Ph.get(h);if(!E||!T)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(cs.get(h)===T){let k=dd();E.push(k),await k.promise}cs.set(h,cs.get(h)+1);for(var w=arguments.length,C=new Array(w>3?w-3:0),O=3;O<w;O++)C[O-3]=arguments[O];let b=await _(...C);return cs.set(h,cs.get(h)-1),cs.get(h)===T-1&&E.length>0&&(E[0].resolve(),E.shift()),cs.get(h)===0&&(Dh.set(h,[]),Ph.set(h,0),cs.set(h,0)),b}("client.join",P("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,r,n,a)}async join(e,t,r,n,a){let c=++this._numberOfJoinCount;this.store.joinStart(),n&&(this.store.uid=n);let l=Z3(),u=AA()?window.isSecureContext:"Browser Not Support";(!AA()&&!l||!window.isSecureContext)&&S.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let h=RE();this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),S.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));let p=Ee.reportApiInvoke(h,{name:jt.JOIN,options:[e,t,r,n],states:{isHttps:l,isSecureContext:u},tag:St.TRACER});Ee.setAppId(e);try{if(!r&&r!==null)throw new x(A.INVALID_PARAMS,"Invalid token: ".concat(r,". If you don not use token, set it to null"));r&&yi(r,"token",1,2047),yi(e,"appid",1,2047),QE(t),n&&$E(n),a&&yi(a,"optionalInfo",1,2047)}catch(C){throw p.onError(C),C}if(S.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(c)),this._leaveMutex.isLocked&&(S.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),S.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){let C=new x(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw p.onError(C),C}this._sessionId||(this._sessionId=h,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";let _=Kd({clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:typeof n!="string"?n:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:r||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:a,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(_.setLocalAPVersion=this._setLocalAPVersion),typeof n=="string"&&(_.stringUid=n,this._uintUid?(_.uid=this._uintUid,this._uintUid=void 0):_.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(_.aesmode=this._encryptionMode,_.aespassword=await o3(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new x(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(_.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:t,appId:e});let E=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&E===this._sessionId&&Ee.joinChannelTimeout(this._sessionId,5)},5e3);try{var T;let C,O=_.cloudProxyServer;if(ge(T=["proxy3","proxy4","proxy5"]).call(T,O)){let X=P("PROXY_SERVER_TYPE3");Array.isArray(X)?_.proxyServer=X[0]:_.proxyServer=X}if(Ee.setProxyServer(_.proxyServer),S.setProxyServer(_.proxyServer),this.store.requestAPStart(),_.stringUid&&!_.uid){let X=await W0(_.stringUid,_,this._axiosCancelSource.token,this._config.httpRetryConfig||xt,this.store);S.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(_.stringUid," => ").concat(X)),_.uid=X,C=await G0(_,this._axiosCancelSource.token,this._config.httpRetryConfig||xt,!0,this.store)}else C=await G0(_,this._axiosCancelSource.token,this._config.httpRetryConfig||xt,!0,this.store);if(!this._joinAndNotLeaveYet)throw new x(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(_,this._axiosCancelSource.token),this._configDistribute.on(Ed.UPDATE_BITRATE_LIMIT,X=>{this._p2pChannel.updateBitrateLimit(X)})},0),this._key=r||e;let b=C.gatewayInfo;this._joinInfo=Kd(Kd({},_),{},{cid:b.cid,uid:_.uid?_.uid:b.uid,vid:b.vid,apResponse:b.res,uni_lbs_ip:b.uni_lbs_ip,gatewayAddrs:b.gatewayAddrs});let k=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new x(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));p.onSuccess(k),this._appId=e,this._channelName=_.cname,this._uid=k,this.store.uid=k,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Vi()?"beforeunload":"pagehide",this._handleBeforeUnload)},0);let U=_.stringUid?"string uid: ".concat(_.stringUid,",uid: ").concat(_.uid):"uid: ".concat(this._uid);return S.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(U)),setTimeout(()=>{S.startUpload()},5e3),this.store.joinEnd(),w=this,ge(ha).call(ha,w)||ha.push(w),k}catch(C){let O=Array.isArray(C)?C[0]:C;throw O&&O.code===A.OPERATION_ABORTED?S.warning("[".concat(this._clientId,"] join number: ").concat(c,", Joining channel failed, rollback"),O):S.error("[".concat(this._clientId,"] join number: ").concat(c,", Joining channel failed, rollback"),O),O.code!==A.OPERATION_ABORTED&&this._numberOfJoinCount===c&&(this._gateway.state="DISCONNECTED",this._reset()),p.onError(O),O}var w}_joinGateway(){if(!this._joinInfo||!this._key)throw new x(A.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!P("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(e=>e).catch(e=>{if(e.code===A.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,Ve.FALLBACK),e;if(e.code===A.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,Ve.FALLBACK),e;throw e}).then(e=>{if(e instanceof x){if(e.code===A.INIT_WEBSOCKET_TIMEOUT){if(S.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new x(A.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";let t=P("PROXY_SERVER_TYPE3");if(Array.isArray(t))if(this._joinInfo.apUrl){let n=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),a=n.slice(n.length-2).join(".");t.forEach(c=>{this._joinInfo&&ge(c).call(c,a)&&(this._joinInfo.proxyServer=c)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=t[0])}else this._joinInfo.proxyServer=t[0];else this._joinInfo.proxyServer=t;let r=P("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return r&&r[1]&&r[1]!=="443"&&S.setProxyServer(this._joinInfo.proxyServer),P("STATS_COLLECTOR_PORT").toString()!=="443"&&Ee.setProxyServer(this._joinInfo.proxyServer),Ee.reportApiInvoke(this._sessionId,{name:jt.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:St.TRACER}).onSuccess(),this.safeEmit(je.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),P("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(n=>{"forceturn"in n&&(n.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(S.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new x(A.INVALID_OPERATION);return Ee.reportApiInvoke(this._sessionId,{name:jt.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:St.TRACER}).onSuccess(),this._joinGateway()}return e}).then(e=>e)}async leave(){S.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Vi()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(t){let r=ha.indexOf(t);r!==-1&&ha.splice(r,1)}(this);let e=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return S.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave(this.connectionState!=="CONNECTED"),S.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof Ri))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new x(A.INVALID_PARAMS,"param list is empty");let r=e;if(this._gateway.role==="audience")throw new x(A.INVALID_OPERATION,"audience can not publish stream");for(let a of r){if(!(a instanceof Ri))throw new x(A.INVALID_PARAMS,"parameter is not local track");if(!a._enabled&&t)throw new x(A.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(a.getTrackId()))}S.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(r.map(a=>"".concat(a.getTrackId()," "))));let n=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&r.forEach(a=>{let c=this._configDistribute.getBitrateLimit();a instanceof ke&&c&&a.setBitrateLimit(c.uplink)});try{await this._publishHighStream(r),S.info("[".concat(this._clientId,"] Publish success, id ").concat(r.map(a=>"".concat(a.getTrackId()," "))))}catch(a){throw S.error("[".concat(this._clientId,"] publish error"),a.toString()),a}finally{n()}}async _publishDataChannel(e){nt(e.id,"id",0,65535,!0),So(e.ordered,"ordered"),yi(e.metadata,"metadata",0,512),S.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));let t=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(n=>n.id===e.id)!==-1)throw new x(A.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new x(A.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&P("FORCE_TURN")&&!P("TURN_ENABLE_TCP")&&!P("TURN_ENABLE_UDP"))throw new x(A.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");let r=new C0(e);await this._p2pChannel.publishDataChannel([r]);try{let n={streamId:e.id,ordered:e.ordered,maxRetransmits:P("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:r._originDataChannelId};await this._gateway.publishDataChannel(this._uid,n,!0)}catch(n){if(n.code!==A.DISCONNECT_P2P)throw n}return await r._waitTillOpen(),S.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(r.id)),r}catch(r){throw S.error("[".concat(this._clientId,"] publish datachannels error"),r.toString()),r}finally{t()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new x(A.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof Ri))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);S.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map(n=>"".concat(n.getTrackId()," "))," "));let r=await this._publishMutex.lock();try{if(this._p2pChannel instanceof Rt){let n=await this._p2pChannel.unpublish(t);if(n){let a=await this._gateway.sendExtensionMessage(lt.UNPUBLISH,n);a&&await this._p2pChannel.setDescription("local",a)}}else{let n=await this._p2pChannel.unpublish(t);n&&await this._gateway.unpublish(n,this._uid),S.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map(a=>"".concat(a.getTrackId()))))}}catch(n){throw S.error("[".concat(this._clientId,"] unpublish error"),n.toString()),n}finally{r&&r()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),S.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map(r=>"".concat(r.id," "))," "));let t=await this._publishMutex.lock();try{let r=await this._p2pChannel.unpublishDataChannel(e);r&&await this._gateway.unpublishDataChannel(r),S.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map(n=>"".concat(n.id))))}catch(r){throw S.error("[".concat(this._clientId,"] unpublish dataChannel error"),r.toString()),r}finally{t&&t()}}async subscribe(e,t,r){return t==="datachannel"?this._subscribeDataChannel(e,r):this._subscribe(e,t)}async _subscribeDataChannel(e,t){var r;if(nt(t,"channelId",0,65535,!0),!this._joinInfo)throw new x(A.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(l=>l===e))throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new x(A.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new x(A.INVALID_REMOTE_USER,"user is not published");let n=(r=e._dataChannels)===null||r===void 0?void 0:r.find(l=>l.id===t);if(!n)throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new x(A.REMOTE_USER_IS_NOT_PUBLISHED);let a=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{let l=await this._p2pChannel.subscribeDataChannel(e,[n]);if(l&&ge(l).call(l,n.id))try{var c;if(!n._originDataChannelId)throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new x(A.REMOTE_USER_IS_NOT_PUBLISHED);let u={id:n.id,datachannelId:n._originDataChannelId,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:(c=n.metadata)!==null&&c!==void 0?c:""};await this._gateway.subscribeDataChannel(e.uid,u,!0)}catch(u){if((u==null?void 0:u.code)!==A.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[n]),u;await this._p2pChannel.unsubscribeDataChannel(e,[n]),this._p2pChannel.setPendingRemoteDataChannel(e,n.id)}return await n._waitTillOpen(),S.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),n}finally{a()}}async _p2pSubscribe(e,t,r){if(Xt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new x(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(c=>c===e)){let c=new x(A.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),c}if(!e.hasAudio&&!e.hasVideo){let c=new x(A.INVALID_REMOTE_USER,"user is not published");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),c}if(!r&&(t==="audio"&&!e.hasAudio||t==="video"&&!e.hasVideo)){let c=new x(A.REMOTE_USER_IS_NOT_PUBLISHED);throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),c}let n=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));let a=t==="audio"?$.LocalAudioTrack:this._joinInfo.defaultVideoStream===ap.LOW_STREAM?$.LocalVideoLowTrack:$.LocalVideoTrack;try{await this._p2pChannel.hasRemoteMediaWithLock(e,t)?await this._p2pChannel.unmuteRemote(e,t):(this.store.subscribe(e.uid,t,Date.now()),this._p2pChannel instanceof Rt&&await this._gateway.sendExtensionMessage(lt.SUBSCRIBE,{trackType:a})),S.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(l=>{S.warning("[".concat(this._clientId,"] auto set fallback failed"),l)});let c=t==="audio"?e._audioTrack:e._videoTrack;if(!c)throw new x(A.UNEXPECTED_ERROR,"can not find remote track in user object");return c}catch(c){throw S.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),c),c}finally{n()}}async _subscribe(e,t,r){if(this._p2pChannel instanceof Rt)return this._p2pSubscribe(e,t);if(Xt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new x(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(h=>h===e)){let h=new x(A.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),h}if(!e.hasAudio&&!e.hasVideo){let h=new x(A.INVALID_REMOTE_USER,"user is not published");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),h}if(!(r||(t!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(t!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){let h=new x(A.REMOTE_USER_IS_NOT_PUBLISHED);throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),h}let n=t==="audio"?e._audioSSRC:e._videoSSRC,a=t==="audio"?e._audioOrtc:e._videoOrtc,c=t==="video"?e._rtxSsrcId:void 0,l={stream_type:t==="audio"?fe.AUDIO:fe.VIDEO,ssrcId:n},u=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{let p=t==="audio"?e._audioSSRC:e._videoSSRC;p!==void 0&&p!==n&&(n=p,a=t==="audio"?e._audioOrtc:e._videoOrtc,c=t==="video"?e._rtxSsrcId:void 0,l={stream_type:t==="audio"?fe.AUDIO:fe.VIDEO,ssrcId:n}),Ii.markSubscribeStart(this.store.clientId,n),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,n,c,a);try{await this._gateway.subscribe(e.uid,l,!0)}catch(_){if((_==null?void 0:_.code)!==A.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),_;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(p){throw this._p2pChannel.reportSubscribeEvent(!1,p==null?void 0:p.code,e,t),p}S.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(p=>{S.warning("[".concat(this._clientId,"] auto set fallback failed"),p)});let h=t==="audio"?e._audioTrack:e._videoTrack;if(!h)throw new x(A.UNEXPECTED_ERROR,"can not find remote track in user object");return h}catch(h){throw S.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),h),h}finally{u()}}async massSubscribe(e){if(ks(e,"subscribeList"),!this._joinInfo)throw new x(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let t=Date.now(),r=new Map,n=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map(u=>{let{user:h,mediaType:p}=u;return"user: ".concat(h==null?void 0:h.uid,", mediaType: ").concat(p)}).join("; ")));let a=(e=[...e]).map(u=>{let{user:h,mediaType:p}=u;return{user:h,mediaType:p}}),c=await this._p2pChannel.globalLock();try{var l;for(let h=e.length-1;h>=0;h--){let p=e[h],{user:_,mediaType:E}=p;if(Xt(E,"mediaType",["audio","video"]),!_){let C=new x(A.INVALID_PARAMS,"user property does not exist in subscribeList item");throw S.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),C}if(!this._users.find(C=>C===_)){let C=new x(A.INVALID_REMOTE_USER,"user is not in the channel");S.error("[".concat(this._clientId,"] can not massSubscribe ").concat(_.uid,", this user is not in the channel")),a[h].error=C,e.splice(h,1);continue}if(E==="audio"&&(!_.hasAudio||_._audioSSRC===void 0)||E==="video"&&(!_.hasVideo||_._videoSSRC===void 0)){let C=new x(A.REMOTE_USER_IS_NOT_PUBLISHED);S.error("[".concat(this._clientId,"] can not subscribe ").concat(_.uid," with mediaType ").concat(E,", remote user is not published")),a[h].error=C,e.splice(h,1);continue}let T=Bt.Video|Bt.LwoVideo,w=r.get(_);if(w){if(E==="video"?w&T:w&Bt.Audio){e.splice(h,1),S.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(_.uid,", mediaType:").concat(E," twice"));continue}r.set(_,w|(E==="video"?T:Bt.Audio))}else r.set(_,E==="video"?T:Bt.Audio)}for(let h=e.length-1;h>=0;h--){let p=e[h],{user:_,mediaType:E}=p,T=Bt.Video|Bt.LwoVideo;if(this._p2pChannel.hasRemoteMedia(_,E)){await this._p2pChannel.unmuteRemoteNoLock(_,E);let w=r.get(_);r.set(_,E==="video"?w^T:w^Bt.Audio),e.splice(h,1)}}this.store.massSubscribe(e.map(h=>({userId:h.user.uid,type:h.mediaType})),t);let u=yo(l=Array.from(r.entries())).call(l,(h,p)=>{let[_,E]=p;if(E===0)return h;let T={stream_id:_.uid,stream_type:E};return E&Bt.Audio&&(T.audio_ssrc=_._audioSSRC),E&Bt.Video&&(T.video_ssrc=_._videoSSRC),h.push(T),h},[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map(p=>{let{user:_,mediaType:E}=p;return{user:_,mediaType:E,ssrcId:E===fe.VIDEO?_._videoSSRC:_._audioSSRC,rtxSsrcId:E===fe.VIDEO?_._rtxSsrcId:void 0}}));let h=new Map;if(u.length>0){let p=await this._gateway.subscribeAll(u,!0);((p==null?void 0:p.users)||[]).forEach(_=>{let{stream_id:E,video_error_code:T,audio_error_code:w,error_code:C}=_;(T||w||C)&&h.set(E,{video_error_code:T,audio_error_code:w,error_code:C})})}if(Array.from(h.entries()).length>0){let p=Array.from(h.entries()).map(_=>{let E,[T,w]=_;return w.error_code||w.video_error_code&&w.audio_error_code?E=void 0:w.video_error_code?E=fe.VIDEO:w.audio_error_code&&(E=fe.AUDIO),{user:this.remoteUsers.find(C=>C.uid===T),mediaType:E}});await this._p2pChannel.massUnsubscribeNoLock(p)}for(let p of a){let _=h.get(p.user.uid);if(_){let E=_.error_code||p.mediaType==="audio"&&_.audio_error_code||p.mediaType==="video"&&_.video_error_code;if(E){let T=Ao(E);S.error("user:".concat(p.user.uid," mediaType:").concat(p.mediaType," has massSubscribe error ").concat(T.desc)),p.error=new x(A.SUBSCRIBE_FAILED,"code ".concat(E,": ").concat(T.desc))}}p.error||(p.mediaType==="video"?p.track=p.user.videoTrack:p.track=p.user.audioTrack)}return this.store.massSubscribe(a.filter(p=>!p.error).map(p=>({userId:p.user.uid,type:p.mediaType})),void 0,Date.now()),a.forEach(p=>{var _;Ee.subscribe(this.store.sessionId,{succ:!!p.error,ec:((_=p.error)===null||_===void 0?void 0:_.code)||null,video:p.mediaType===fe.VIDEO,audio:p.mediaType===fe.AUDIO,peerid:p.user.uid,subscribeRequestid:p.mediaType===fe.VIDEO?p.user._videoSSRC:p.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t)},!0)}),S.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map(p=>{let{user:_,mediaType:E}=p;return"user: ".concat(_==null?void 0:_.uid,", mediaType: ").concat(E)}).join("; "))),a}catch(h){throw await this._p2pChannel.massUnsubscribeNoLock(e),h}}finally{c(),n()}}async unsubscribe(e,t,r){if(t||this.store.useP2P){if(t==="datachannel")return this._unsubscribeDataChannel(e,r)}else await this._unsubscribeDataChannel(e,r);if(t&&Xt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new x(A.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(a=>a===e)){let a=new x(A.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),a}S.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));let n=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof Rt)await this._gateway.sendExtensionMessage(lt.UNSUBSCRIBE,{mediaType:t});else{let a=await this._p2pChannel.unsubscribe(e,t);a&&await this._gateway.unsubscribe(a,e.uid),S.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(a){if(a.code===A.DISCONNECT_P2P)return void S.warning("disconnecting p2p, abort unsubscribe request.");throw S.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),a.toString()),a}finally{n()}}async _unsubscribeDataChannel(e,t){if(t&&nt(t,"id",0,65535,!0),!this._joinInfo)throw new x(A.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(n=>n===e)){let n=new x(A.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),n}let r;if(typeof t=="number"){let n=e._dataChannels.find(a=>a.id===t);n&&(r=[n])}else r=e._dataChannels;if(r===void 0){let n=new x(A.REMOTE_USER_IS_NOT_PUBLISHED);throw S.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),n}S.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(r.map(n=>n.id)));try{let n=await this._p2pChannel.unsubscribeDataChannel(e,r);n&&await this._gateway.unsubscribeDataChannel(n,e.uid),S.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(n))}catch(n){if(n.code===A.DISCONNECT_P2P)return void S.warning("disconnecting p2p, abort unsubscribe request.");throw S.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),n.toString()),n}}async massUnsubscribe(e){if(ks(e,"unsubscribeList"),!this._joinInfo)throw new x(A.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");S.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map(r=>{let{user:n,mediaType:a}=r;return"user: ".concat(n==null?void 0:n.uid,", mediaType: ").concat(a,";")}).join())),e=[...e];let t=new Map;for(let r=e.length-1;r>=0;r--){let{user:n,mediaType:a}=e[r];if(!n){let l=new x(A.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw S.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),l}if(Xt(a,"mediaType",["video","audio",void 0]),!this._users.find(l=>l===n)){S.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),e.splice(r,1);continue}let c=Bt.Video|Bt.LwoVideo;if(t.has(n)){let l=t.get(n),u;switch(a){case"video":u=l&c;break;case"audio":u=l&Bt.Audio;break;default:u=l&(Bt.Audio|c)}if(u){S.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(n.uid,",mediaType:").concat(a," twice.")),e.splice(r,1);continue}a?a==="audio"?t.set(n,l|Bt.Audio):a==="video"&&t.set(n,l|c):t.set(n,l|Bt.Audio|c)}else a?a==="audio"?t.set(n,Bt.Audio):a==="video"&&t.set(n,c):t.set(n,Bt.Audio|c)}try{let r=await this._p2pChannel.massUnsubscribe(e);r&&await this._gateway.massUnsubscribe(r),S.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map(n=>{let{user:a,mediaType:c}=n;return"user: ".concat(a==null?void 0:a.uid,", mediaType: ").concat(c,";")}).join()))}catch(r){if(r.code===A.DISCONNECT_P2P)return void S.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw S.error("[".concat(this._clientId,"] massUnsubscribe error"),r.toString()),r}}async setLowStreamParameter(e){(function(r){if(!r)throw new Y(A.INVALID_PARAMS);Tt(r.width)||TE(r.width,"streamParameter.width"),Tt(r.height)||TE(r.height,"streamParameter.height"),Tt(r.framerate)||TE(r.framerate,"streamParameter.framerate"),Tt(r.bitrate)||nt(r.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&S.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),S.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));let t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,$.LocalVideoLowTrack)}async enableDualStream(){if(!ct().supportDualStream)throw Ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new x(A.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new x(A.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw Ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,Ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),S.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new x(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia($.LocalVideoLowTrack))try{let e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw Ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,Ee.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),S.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(function(r){Xt(r,"role",["audience","host"])}(e),t&&Cw(t),this.mode==="rtc")throw S.warning("[".concat(this._clientId,"]rtc mode can not use setClientRole")),new x(A.INVALID_OPERATION,"rtc mode can not use setClientRole");if(t&&t.level&&e==="host")throw new x(A.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new x(A.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,t),this._config.role=e,S.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level))}getRemoteInboundOffset(){var e;let t=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;let r=t.timestamp-Date.now();return Math.abs(r)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?r:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(yi(e,"proxyServer"),!t){if(this.connectionState!=="DISCONNECTED")throw new x(A.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new x(A.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,Ee.setProxyServer(this._proxyServer),S.setProxyServer(this._proxyServer),S.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if(this.connectionState!=="DISCONNECTED")throw new x(A.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new x(A.INVALID_OPERATION,"You have already set the proxy")}if(Lc(e))return this._turnServer={servers:e,mode:"original-manual"},void S.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map(r=>r.urls).join(","),"."));e.forEach(r=>yw(r)),this._turnServer={servers:e,mode:"manual"},S.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new x(A.INVALID_OPERATION,"you should set license before join channel");if(yi(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new x(A.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,S.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new x(A.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new x(A.INVALID_OPERATION,"You have already set the proxy");let t=[3,4,5],r;switch(e===void 0&&(e=3),e){case 1:case 2:throw new x(A.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:r="proxy3";break;case 4:r="proxy4";break;case 5:r="proxy5";break;default:throw new x(A.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=r,this.store.cloudProxyServerMode=r,S.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new x(A.INVALID_OPERATION,"Stop proxy server after leave channel");Ee.setProxyServer(),S.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",S.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new x(A.INVALID_PARAMS,"accessPoints is required.");ks(e.accessPoints.serverList,"accessPoints.serverList"),yi(e.accessPoints.domain,"accessPoints.domain");let t=(T,w)=>{nt(T,w,0,65535,!0)},r=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),r=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new x(A.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");P("CLOSE_AFB_FOR_LOCAL_AP")&&(it("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),it("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));let n=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,a=e.accessPoints.domain,c=e.accessPoints.serverList.map(T=>n.test(T)?"".concat(T.replace(/\./g,"-"),".").concat(a):T),l=c.map(T=>"".concat(T,":").concat(r));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,it("WEBCS_DOMAIN",l),it("WEBCS_DOMAIN_BACKUP_LIST",l),it("GATEWAY_DOMAINS",[a]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(ks(e.report.hostname,"report.hostname"),it("EVENT_REPORT_DOMAIN",e.report.hostname[0]),it("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(it("EVENT_REPORT_DOMAIN",c[0]),it("EVENT_REPORT_BACKUP_DOMAIN",c[1]||c[0]));let u=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),u=e.report.port),it("STATS_COLLECTOR_PORT",u),e.report?it("ENABLE_EVENT_REPORT",!0):it("ENABLE_EVENT_REPORT",!1);let h="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(ks(e.log.hostname,"log.hostname"),h=e.log.hostname[0]):h=c[0];let p=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),p=e.log.port),it("LOG_UPLOAD_SERVER","".concat(h,":").concat(p));let _=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(ks(e.cds.hostname,"cds.hostname"),_=e.cds.hostname):_=c;let E=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),E=e.cds.port),it("CDS_AP",_.map(T=>"".concat(T,":").concat(E))),e.cds?it("ENABLE_CONFIG_DISTRIBUTE",!0):it("ENABLE_CONFIG_DISTRIBUTE",!1),S.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(ks(e,"serverList"),yi(t,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new x(A.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");let r=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map(n=>r.test(n)?"".concat(n.replace(/\./g,"-"),".").concat(t):n),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,it("WEBCS_DOMAIN",e),it("WEBCS_DOMAIN_BACKUP_LIST",e),it("GATEWAY_DOMAINS",[t]),it("EVENT_REPORT_DOMAIN",e[0]),it("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),it("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),S.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(Xt(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw S.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else S.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){Xt(t,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout(()=>{let r=this._users.find(n=>n.uid===e);r&&r.videoTrack&&r.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(r){throw S.error("[".concat(this._clientId,"] set remote video stream type error"),r.toString()),r}S.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){Xt(t,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(r){throw S.error("[".concat(this._clientId,"] set stream fallback option"),r.toString()),r}S.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,r){(function(a){Xt(a,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),yi(t,"secret");let n=["aes-128-gcm2","aes-256-gcm2"];if(ge(n).call(n,e)){if(!r||!(r instanceof Uint8Array&&r.length===32))throw new x(A.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(r)throw new x(A.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(t)||S.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=t,r&&(this._encryptionSalt=Vh(r))}async renewToken(e){if(yi(e,"token",1,2047),!this._key||!this._joinInfo)throw new x(A.INVALID_OPERATION,"renewToken should not be called before user join");let t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);let r=await this._renewTokenMutex.lock();try{if(P("USE_NEW_TOKEN")){S.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));let n=await uG(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||xt);S.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:n})}else S.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});S.debug("[".concat(this._clientId,"] renewToken success"))}catch(n){throw this._key=t,this._joinInfo.token=t,S.error("[".concat(this._clientId,"] renewToken failed"),n.toString()),n}finally{r()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?S.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{let e=this._p2pChannel.getAudioLevels();this.safeEmit(je.VOLUME_INDICATOR,e)},P("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){let e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if(this.codec!=="h264")throw new x(A.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new x(A.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new x(A.LIVE_STREAMING_TASK_CONFLICT);let r=t?Ht.TRANSCODE:Ht.RAW;return this._createLiveStreamingClient(r).startLiveStreamingTask(e,r)}setLiveTranscoding(e){return this._createLiveStreamingClient(Ht.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){let t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(r=>r&&r.hasUrl(e));if(!t.length)throw new x(A.INVALID_PARAMS,"can not find live streaming url to stop");await F.all(t.map(r=>r&&r.stopLiveStreamingTask(e)))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new x(A.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");let r=this._createLiveStreamingClient(Ht.INJECT);r.setInjectStreamConfig(t,0),await r.startLiveStreamingTask(e,Ht.INJECT)}async removeInjectStreamUrl(){var e;let t=this._createLiveStreamingClient(Ht.INJECT),r=Array.from(us(e=t.streamingTasks).call(e)).find(n=>n.mode===Ht.INJECT);if(!this._joinInfo||!r)throw new x(A.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await t.stopLiveStreamingTask(r.url)}async startChannelMediaRelay(e){X0(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){X0(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new x(A.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){let r=new TextEncoder;e.payload=r.encode(e.payload)}if(new Blob([e.payload]).size>1024)throw new x(A.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(me.DATA_STREAM,{payload:Vh(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-KG},!t)}sendMetadata(e){if(!this._joinInfo)throw new x(A.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new x(A.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(me.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Vh(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(i5),!this._joinInfo)throw new x(A.INVALID_OPERATION,"can not send custom report, not joined");await Ee.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,t){Xt(t.spatialLayer,"spatialLayer",[0,1,2,3]),Xt(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(r){throw S.error("[".concat(this._clientId,"] pick SVC layer failed"),r.toString()),r}}setRTM2Flag(e){if(Xt(e,"flag",[0,1]),!this._joinInfo)throw new x(A.INVALID_OPERATION,"Can't setRtm2Flag, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"Can't setRtm2Flag in ".concat(this.connectionState," state"));return this._gateway.setRTM2Flag(e)}_reset(){if(S.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=lr.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._pendingPublishedUsers=[],this._users.forEach(e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach(t=>t._close()),e._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new si("client-publish"),this._subscribeMutex=new si("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,t){let r=e||RE();e?S.debug("[".concat(this._clientId,"] new Session ").concat(r)):S.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(r)),this._sessionId=r,this.store.sessionId=r,t?Ee.sessionInit(this._sessionId,{lts:new Date().getTime(),cname:t.channel,appid:t.appId,mode:this.mode}):this._joinInfo?Ee.sessionInit(this._sessionId,{lts:new Date().getTime(),cname:this._joinInfo.cname,appid:this._joinInfo.appId,mode:this.mode}):this._gateway.joinInfo&&Ee.sessionInit(this._sessionId,{lts:new Date().getTime(),cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId,mode:this.mode}),this._joinInfo&&(this._joinInfo.sid=r),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=r)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new x(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&P("FORCE_TURN")&&!P("TURN_ENABLE_TCP")&&!P("TURN_ENABLE_UDP"))throw new x(A.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");S.debug("[".concat(this._clientId,"] publish high stream"));try{if(this._p2pChannel instanceof Rt){let r=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(r)try{await this._gateway.sendExtensionMessage(lt.PUBLISH,r)}catch(n){throw this._p2pChannel.unpublish(e),n}}else{let r=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter),n=(await r.next()).value;if(n){var t;let a;try{a=await this._gateway.publish(this._uid,n,!0)}catch(c){if(c.code!==A.DISCONNECT_P2P)throw r.throw(c),c}await r.next(((t=a)===null||t===void 0?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(let a of e)a instanceof ke&&a._encoderConfig&&this._gateway.setVideoProfile(a._encoderConfig),!a.muted&&a.enabled||await this._p2pChannel.muteLocalTrack(a)}}catch(r){if(this._p2pChannel.reportPublishEvent(!1,r==null?void 0:r.code,e),(r==null?void 0:r.code)===A.WS_ABORT)return;throw r}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new x(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(A.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));S.debug("[".concat(this._clientId,"] publish low stream"));let e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{let r=await this._p2pChannel.publishLowStream(this._lowStreamParameter),n=(await r.next()).value;if(n){var t;let a;try{a=await this._gateway.publish(this._uid,n,!0)}catch(c){if(c.code!==A.DISCONNECT_P2P)throw r.throw(c),c}r.next(((t=a)===null||t===void 0?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(r){if(this._p2pChannel.reportPublishEvent(!1,r==null?void 0:r.code,void 0,!0),(r==null?void 0:r.code)===A.WS_ABORT)return;throw r}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId)return new x(A.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();let t=()=>new fG(this._joinInfo,this._config.websocketRetryConfig||xt,this._config.httpRetryConfig||xt),r=n=>{n.onLiveStreamError=(a,c)=>{Ee.reportApiInvoke(this._sessionId,{name:jt.ON_LIVE_STREAM_ERROR,options:[a,c],tag:St.TRACER}).onSuccess(),this.safeEmit(je.LIVE_STREAMING_ERROR,a,c)},n.onLiveStreamWarning=(a,c)=>{Ee.reportApiInvoke(this._sessionId,{name:jt.ON_LIVE_STREAM_WARNING,options:[a,c],tag:St.TRACER}).onSuccess(),this.safeEmit(je.LIVE_STREAMING_WARNING,a,c)},n.on(Wc.REQUEST_WORKER_MANAGER_LIST,(a,c,l)=>{if(!this._joinInfo)return l(new x(A.INVALID_OPERATION,"can not find join info to get worker manager"));K0(a,this._joinInfo,this._axiosCancelSource.token,xt).then(c).catch(l)})};switch(e){case Ht.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),r(this._liveRawStreamingClient)),this._liveRawStreamingClient;case Ht.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),r(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case Ht.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(Wc.REQUEST_WORKER_MANAGER_LIST,(n,a,c)=>{if(!this._joinInfo)return c(new x(A.INVALID_OPERATION,"can not find join info to get worker manager"));K0(n,this._joinInfo,this._axiosCancelSource.token,xt).then(a).catch(c)}),this._injectStreamingClient.onInjectStatusChange=(n,a,c)=>{this.safeEmit(je.INJECT_STREAM_STATUS,n,a,c)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new x(A.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){let{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),r={width:e,height:t};this._channelMediaRelayClient=new mG(this._joinInfo,this._clientId,this._config.websocketRetryConfig||xt,this._config.httpRetryConfig||xt,r),this._channelMediaRelayClient.on("state",n=>{n===qi.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(je.CHANNEL_MEDIA_RELAY_STATE,n)}),this._channelMediaRelayClient.on("event",n=>{this.safeEmit(je.CHANNEL_MEDIA_RELAY_EVENT,n)}),this._statsCollector.onStatsChanged=(n,a)=>{var c;n==="resolution"&&((c=this._channelMediaRelayClient)===null||c===void 0||c.setVideoProfile(a))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){let{added:r,deleted:n}=e,a=[];Array.isArray(r)&&r.length>0&&r.forEach(c=>{let{uid:l,stream_id:u,ordered:h,max_retrans_times:p,metadata:_}=c,E=this._users.find(T=>T._uintid===l);if(!E)return void S.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(S.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(l)),ge(a).call(a,E)||a.push(E),E._uintid||(E._uintid=l),E._dataChannels.findIndex(T=>T.id===c.stream_id)===-1){let T={id:u,ordered:!!h,maxRetransmits:p,metadata:_},w=new $4(T);E._dataChannels.push(w),S.info("[".concat(this._clientId,"] remote user ").concat(E.uid," published datachannel")),t||this.safeEmit(je.USER_PUBLISHED,E,"datachannel",T)}this._p2pChannel.hasPendingRemoteDataChannel(E,c.stream_id)&&(S.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(E.uid," after reconnect.")),this._subscribeDataChannel(E,c.stream_id).catch(T=>{S.error("[".concat(this._clientId,"] resubscribe datachannel error"),T.toString())}))}),t&&(this.safeEmit(je.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(n)&&n.length>0&&n.forEach(c=>{let{uid:l,stream_id:u}=c,h=this._users.find(_=>_._uintid===l);if(!h)return void S.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));let p=h._dataChannels.find(_=>_.id===c.stream_id);p&&(S.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(l)),this._p2pChannel.unsubscribeDataChannel(h,[p]).then(_=>{if(_)return h._dataChannels=h._dataChannels.filter(E=>E!==p),this._gateway.unsubscribeDataChannel(_,h.uid)}),S.info("[".concat(this._clientId,"] remote user ").concat(l," unpublished datachannel ,id:").concat(p.id)),this.safeEmit(je.USER_UNPUBLISHED,h,"datachannel",p._config))})}_handleRemoveDataChannels(e){let t=this._users.find(r=>r.uid===e.uid);if(t){if(t._dataChannels!==void 0&&t._dataChannels.length>0){S.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));let r=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach(n=>{this.safeEmit(je.USER_UNPUBLISHED,t,"datachannel",n._config)})};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then(n=>{if(n)return this._gateway.unsubscribeDataChannel(n,t.uid)}),r()}}else S.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Ct.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(Ct.CONNECTION_STATE_CHANGE,(e,t,r)=>{var n;if(r===Ve.FALLBACK)return;let a=()=>{this.safeEmit(je.CONNECTION_STATE_CHANGE,e,t,r)};if(Ee.reportApiInvoke(this._sessionId||((n=this._gateway.joinInfo)===null||n===void 0?void 0:n.sid)||null,{name:jt.CONNECTION_STATE_CHANGE,options:[e,t,r],tag:St.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:r})),S.info("[".concat(this._clientId,"] connection state change: ").concat(t," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void a();if(e==="RECONNECTING")this._users.forEach(l=>{l._trust_in_room_=!1,l._trust_audio_enabled_state_=!1,l._trust_video_enabled_state_=!1,l._trust_audio_mute_state_=!1,l._trust_video_mute_state_=!1,l._trust_audio_stream_added_state_=!1,l._trust_video_stream_added_state_=!1,l._audioSSRC=void 0,l._videoSSRC=void 0,l._videoOrtc=void 0,l._audioOrtc=void 0,l._cname=void 0,l._rtxSsrcId=void 0}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var c;this._streamFallbackTypeCacheMap.forEach((l,u)=>{this._gateway.setStreamFallbackOption(u,l).catch(h=>{S.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),h)})}),this._remoteStreamTypeCacheMap.forEach((l,u)=>{this._gateway.setRemoteVideoStreamType(u,l).catch(h=>{S.warning("[".concat(this._clientId,"] auto set remote stream type failed"),h)})}),this._remoteDefaultVideoStreamType!==void 0&&((c=this._joinInfo)===null||c===void 0?void 0:c.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{S.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(l=>{S.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(l))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(l=>!l._trust_in_room_).forEach(l=>{S.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(l.uid)),this._handleUserOffline({uid:l.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(l=>{l._trust_audio_mute_state_||(S.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(l.uid)),this._handleMuteStream(l.uid,fe.AUDIO,!1)),l._trust_video_mute_state_||(S.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(l.uid)),this._handleMuteStream(l.uid,fe.VIDEO,!1)),l._trust_audio_enabled_state_||(S.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(l.uid)),this._handleSetStreamLocalEnable("audio",l.uid,!0)),l._trust_video_enabled_state_||(S.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(l.uid)),this._handleSetStreamLocalEnable("video",l.uid,!0)),l._trust_video_stream_added_state_||(S.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(l.uid)),this._handleResetAddStream(l,"video")),l._trust_audio_stream_added_state_||(S.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(l.uid)),this._handleResetAddStream(l,"audio")),l._video_added_||l._audio_added_||(S.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(l.uid)),this._handleRemoveStream({uid:l.uid,uint_id:l._uintid}))}))},1e3))}a()}),this._gateway.on(Ct.REQUEST_NEW_GATEWAY_LIST,(e,t)=>{if(!this._joinInfo)return t(new x(A.UNEXPECTED_ERROR,"can not recover, no join info"));eS(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||xt,this.store).then(r=>{this._joinInfo&&(this._joinInfo.apResponse=r.gatewayInfo.res,this._joinInfo.gatewayAddrs=r.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=r.gatewayInfo.uni_lbs_ip);let n=[];r.gatewayInfo.gatewayAddrs.forEach(a=>{let{address:c}=a,[l,u]=c.split(":");this._joinInfo&&this._joinInfo.proxyServer?n.push({proxy:this._joinInfo.proxyServer,host:l,port:u}):n.push({host:l,port:u})}),e(n)}).catch(t)}),this._gateway.on(Ct.NETWORK_QUALITY,e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(je.NETWORK_QUALITY,e)}),this._gateway.on(Ct.STREAM_TYPE_CHANGE,(e,t)=>{this.safeEmit(je.STREAM_TYPE_CHANGED,e,t),Ee.reportApiInvoke(this._sessionId,{name:jt.STREAM_TYPE_CHANGE,options:[e,t],tag:St.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))}),this._gateway.on(Ct.IS_P2P_DISCONNECTED,e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)}),this._gateway.on(Ct.NEED_RENEW_SESSION,()=>{this._startSession()}),this._gateway.on(Ct.REQUEST_P2P_CONNECTION_PARAMS,async(e,t,r)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(n){r(n)}}),this._gateway.on(Ct.JOIN_RESPONSE,(e,t)=>{if(this.store.useP2P)return;let{dtlsParameters:r,iceParameters:n,candidates:a,rtpCapabilities:c,setup:l,cname:u}=rN(e.ortc,t);this._p2pChannel.connect(n,r,a,c,l,u)}),this._gateway.on(Ct.REQUEST_DC_CONNECTION_PARAMS,e=>{e(this._p2pChannel.getEstablishParams())}),this._gateway.on(Ct.RESET_SIGNAL,e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()}),this._gateway.on(Ct.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(Ct.DATACHANNEL_PRECONNECT,async(e,t,r,n)=>{var a,c,l,u,h,p;await this._p2pChannel.startP2PConnection({turnServer:(a=this._joinInfo)===null||a===void 0?void 0:a.turnServer},!0);let _=function(E,T){let w;return T&&T.ip&&typeof T.port=="number"?(w=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:T.ip,port:T.port.toString(),type:"host",extension:{}}],S.debug("Using remote candidate from AP ".concat(T.ip,":").concat(T.port)),T.ip6&&(w.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:T.ip6,port:T.port.toString(),type:"host",extension:{}}),S.debug("Using IPV6 remote candidate from AP ".concat(T.ip6,":").concat(T.port)))):w=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:E.ip,port:E.port.toString(),type:"host",extension:{}}],w}(e,t);return this._p2pChannel.preConnect({iceUfrag:"".concat((c=this._joinInfo)===null||c===void 0?void 0:c.apResponse.cid,"_").concat((l=this._joinInfo)===null||l===void 0?void 0:l.apResponse.cert),icePwd:"".concat((u=this._joinInfo)===null||u===void 0?void 0:u.apResponse.cid,"_").concat((h=this._joinInfo)===null||h===void 0?void 0:h.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(p=P("FINGERPRINT"))!==null&&p!==void 0?p:e.fingerprint}]},_,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(r).catch(n)})}_handleGatewaySignalEvents(){this._gateway.signal.on(Ae.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Ae.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Ae.ON_ADD_AUDIO_STREAM,e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc)),this._gateway.signal.on(Ae.ON_ADD_VIDEO_STREAM,e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId)),this._gateway.signal.on(Ae.ON_REMOTE_DATASTREAM_UPDATE,e=>{this._handleUpdateDataChannel(e)}),this._gateway.signal.on(Ae.ON_REMOTE_FULL_DATASTREAM_INFO,e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)}),this._gateway.signal.on(Ae.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Ae.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Ae.MUTE_AUDIO,e=>this._handleMuteStream(e.uid,fe.AUDIO,!0)),this._gateway.signal.on(Ae.UNMUTE_AUDIO,e=>this._handleMuteStream(e.uid,fe.AUDIO,!1)),this._gateway.signal.on(Ae.MUTE_VIDEO,e=>this._handleMuteStream(e.uid,fe.VIDEO,!0)),this._gateway.signal.on(Ae.UNMUTE_VIDEO,e=>this._handleMuteStream(e.uid,fe.VIDEO,!1)),this._gateway.signal.on(Ae.RECEIVE_METADATA,e=>{let t=xh(e.metadata);this.safeEmit(je.RECEIVE_METADATA,e.uid,t)}),this._gateway.signal.on(Ae.ON_DATA_STREAM,async e=>{if(!e)return;let t=0;if(e.ordered||e.syncWithAudio){let r=this._p2pChannel.getStats(),n=this.remoteUsers.find(c=>c.uid===e.uid),a=r==null?void 0:r.audioRecv.find(c=>c.ssrc===(n==null?void 0:n._audioSSRC));t=a==null?void 0:a.jitterBufferMs}t==null&&(t=0),YG(e,t,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Ae.ON_CRYPT_ERROR,()=>{pd(()=>{S.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(je.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Ae.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{S.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Ve.TOKEN_EXPIRE),this.safeEmit(je.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Ae.ON_STREAM_FALLBACK_UPDATE,e=>{S.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(je.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Ae.ON_PUBLISH_STREAM,e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),S.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))}),this._gateway.signal.on(Ae.ENABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)}),this._gateway.signal.on(Ae.DISABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)}),this._gateway.signal.on(le.REQUEST_TIMEOUT,(e,t)=>{if(this._joinInfo)switch(e){case me.PUBLISH:{if(!t)return;let a=t.ortc;if(a){var r,n;let c=a.some(h=>{let{stream_type:p}=h;return p===et.Audio}),l=a.some(h=>{let{stream_type:p}=h;return p!==et.Audio}),u=a.some(h=>{let{stream_type:p}=h;return p===et.Screen||p===et.ScreenLow});t.state==="offer"&&Ee.publish(this._joinInfo.sid,{eventElapse:Ii.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:A.TIMEOUT,audio:c,video:l,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:u,audioName:c?(r=a.find(h=>{let{stream_type:p}=h;return p===et.Audio}))===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId.toString():void 0,videoName:l?(n=a.find(h=>{let{stream_type:p}=h;return p!==et.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0})}break}case me.SUBSCRIBE:t&&Ee.subscribe(this._joinInfo.sid,{succ:!1,ec:A.TIMEOUT,audio:t.stream_type===fe.AUDIO,video:t.stream_type===fe.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:Ii.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}}),this._gateway.signal.on(Ae.ON_P2P_OK,e=>{this.uid,this._uid}),this._gateway.signal.on(Ae.ON_PUBLISHED_USER_LIST,e=>{if(e==null||!e.users)return;P("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter(n=>!Io(n.string_id||n.stream_id,this.channelName)));let t=[],r=[];for(let n of e.users){let a=this._users.find(_=>_._uintid===n.stream_id);a?a._trust_in_room_=!0:(a=new wi(n.string_id||n.stream_id,n.stream_id),this._users.push(a),this.getListeners(je.PUBLISHED_USER_LIST).length===0&&(S.debug("[".concat(this._clientId,"] user online"),n.stream_id),this.safeEmit(je.USER_JOINED,a)));let c=Bt.Audio&n.stream_type,l=(Bt.Video|Bt.LwoVideo)&n.stream_type,u=(65280&n.stream_type)!=0,h=c&&a.hasAudio,p=l&&a.hasVideo;l&&(a._trust_video_stream_added_state_=!0,a._video_added_=!0,a._videoSSRC=n.video_ssrc,a._rtxSsrcId=n.video_rtx),c&&(a._trust_audio_stream_added_state_=!0,a._audio_added_=!0,a._audioSSRC=n.audio_ssrc),c&&!h&&this.getListeners(je.PUBLISHED_USER_LIST).length===0&&(S.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published audio")),this.safeEmit(je.USER_PUBLISHED,a,"audio")),l&&!p&&this.getListeners(je.PUBLISHED_USER_LIST).length===0&&(S.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published video")),this.safeEmit(je.USER_PUBLISHED,a,"video")),(c&&!h||l&&!p||u)&&t.push(a),l&&this._p2pChannel.hasPendingRemoteMedia(a,"video")&&r.push({user:a,mediaType:"video"}),c&&this._p2pChannel.hasPendingRemoteMedia(a,"audio")&&r.push({user:a,mediaType:"audio"})}r.length>0&&(S.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(r.map(n=>"user: ".concat(n.user.uid,", mediaType: ").concat(n.mediaType)).join("; ")," ")),this.massSubscribe(r).catch(n=>{S.error("[".concat(this._clientId,"] mass resubscribe error"),n.toString())})),this.getListeners(je.PUBLISHED_USER_LIST).length>0?P("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(S.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map(n=>n.uid).join(", "))),this.safeEmit(je.PUBLISHED_USER_LIST,t)):S.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map(n=>n.uid).join(", ")))}),this._gateway.signal.on(Ae.ON_RTP_CAPABILITY_CHANGE,e=>{let{video_codec:t}=e;this._p2pChannel instanceof di&&this._p2pChannel.updateRemoteRTPCapabilities(t.map(r=>r.toLowerCase()).filter(r=>{var n;return ge(n=Object.keys(Ro)).call(n,r)}))})}_handleP2PEvents(){this._gateway.signal.on(Ae.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(lt.PUBLISH,async(e,t)=>{e.forEach(r=>r.kind===fe.VIDEO?(this._handleP2PAddAudioOrVideoStream("video",t),r.isMuted?this._handleMuteStream(t,fe.VIDEO,!0):this._handleMuteStream(t,fe.VIDEO,!1)):(this._handleP2PAddAudioOrVideoStream("audio",t),r.isMuted?this._handleMuteStream(t,fe.AUDIO,!0):this._handleMuteStream(t,fe.AUDIO,!1)))}),this._gateway.signal.on(le.P2P_START,async(e,t)=>{if(this._p2pChannel instanceof Rt){var r;t(await this._p2pChannel.startP2P({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},e))}}),this._gateway.signal.on(le.P2P_CONNECTION,async e=>{this._p2pChannel instanceof Rt&&await this._p2pChannel.p2pConnect(e)}),this._gateway.signal.on(le.P2P_REMOTE_CANDIDATE_UPDATE,e=>{this._p2pChannel instanceof Rt&&this._p2pChannel.addRemoteCandidate(JSON.parse(e))}),this._gateway.signal.on(lt.SUBSCRIBE,async(e,t,r)=>{if(this._p2pChannel instanceof Rt){let{trackType:n}=JSON.parse(e);try{await this._p2pChannel.dopublish(n),t()}catch(a){r(a)}}}),this._gateway.signal.on(lt.UNSUBSCRIBE,async(e,t,r)=>{if(this._p2pChannel instanceof Rt){let{mediaType:n}=JSON.parse(e);try{await this._p2pChannel.doUnpublish(n),t()}catch(a){r(a)}}}),this._gateway.signal.on(lt.EXCHANGE_SDP,async(e,t,r)=>{if(this._p2pChannel instanceof Rt){let{type:n,sdp:a}=JSON.parse(e);try{t(await this._p2pChannel.setDescription(n,a))}catch(c){r(c)}}}),this._gateway.signal.on(lt.UNPUBLISH,async(e,t,r)=>{if(this._p2pChannel instanceof Rt){let{unpubMsg:n,uid:a}=e;if(n.length===1){let c=n[0].stream_type===et.Audio?fe.AUDIO:fe.VIDEO;this._handleMuteStream(a,c,!0);let{sdp:l}=e;if(this._p2pChannel instanceof Rt&&l){let u=this._users.find(h=>h.uid===a);if(!u)return S.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(a)),void t();this._p2pChannel.unsubscribe(u,l,c).then(h=>{h&&t(h)}).catch(r)}else t()}else this._handleRemoveStream(e,t,r)}}),this._gateway.signal.on(lt.CONTROL,async(e,t,r)=>{let{action:n,sdp:a,isMuteAll:c,uid:l}=e;switch(n){case ps.MUTE_LOCAL_VIDEO:this._handleMuteStream(l,fe.VIDEO,!0,a,t,r);break;case ps.MUTE_LOCAL_AUDIO:t(),this._handleMuteStream(l,fe.AUDIO,!0);break;case ps.UNMUTE_LOCAL_VIDEO:t(),this._handleP2PAddAudioOrVideoStream("video",l),this._handleMuteStream(l,fe.VIDEO,!1);break;case ps.UNMUTE_LOCAL_AUDIO:t(),this._handleP2PAddAudioOrVideoStream("audio",l),this._handleMuteStream(l,fe.AUDIO,!1)}c&&this._handleRemoveStream(e,t,r)}),this._gateway.signal.on(lt.DO_SUBSCRIBE,async(e,t,r)=>{if(this._p2pChannel instanceof Rt){let{kind:n,sdp:a,ssrcId:c,uid:l}=e,u=this._users.find(h=>h.uid===l);if(!u)return S.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)")),void t();try{t(await this._p2pChannel.subscribe(u,n,a,c))}catch(h){r(h)}}}),this._gateway.signal.on(lt.DO_UNSUBSCRIBE,async(e,t,r)=>{if(this._p2pChannel instanceof Rt){let{uid:n,kind:a,sdp:c}=e,l=this._users.find(u=>u.uid===n);if(!l)return S.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)")),void t();try{t(await this._p2pChannel.unsubscribe(l,c,a))}catch(u){r(u)}}}),this._gateway.signal.on(lt.RESTART_ICE,async(e,t,r)=>{if(this._p2pChannel instanceof Rt)try{t(await this._p2pChannel.setDescription("remote",e))}catch(n){r(n)}}),this._p2pChannel.on(ye.RequestP2PRestartICE,async(e,t,r)=>{try{t(await this._gateway.sendExtensionMessage(lt.RESTART_ICE,e))}catch(n){r(n)}}),this._p2pChannel.on(ye.LocalCandidate,e=>{this._gateway.sendExtensionMessage(lt.CANDIDATE,JSON.stringify(e))}),this._p2pChannel.on(ye.RequestP2PMuteLocal,async(e,t,r)=>{try{t(await this._gateway.sendExtensionMessage(lt.CONTROL,e))}catch(n){r(n)}}),this._p2pChannel.on(ye.RequestP2PPublish,async(e,t,r)=>{try{t(await this._gateway.sendExtensionMessage(lt.DO_SUBSCRIBE,e))}catch(n){r(n)}}),this._p2pChannel.on(ye.RequestP2PUnPublish,async(e,t,r)=>{try{t(await this._gateway.sendExtensionMessage(lt.DO_UNSUBSCRIBE,e))}catch(n){r(n)}}),this._p2pChannel.on(ye.RequestP2PUnmuteRemote,async(e,t,r)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(n){n.code===A.DISCONNECT_P2P?t():r(n)}else t()}),this._p2pChannel.on(ye.RequestP2PMuteRemote,async(e,t,r)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(n){n.code===A.DISCONNECT_P2P?t():r(n)}else t()}),this._p2pChannel.on(ye.StateChange,(e,t)=>{t===Ke.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(ye.RequestMuteLocal,async(e,t,r)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(n){n.code===A.DISCONNECT_P2P?t():r(n)}else t()}),this._p2pChannel.on(ye.RequestUnmuteLocal,async(e,t,r)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(n){n.code===A.DISCONNECT_P2P?t():r(n)}else t()}),this._p2pChannel.on(ye.RequestRePublish,(e,t,r)=>{this.publish(e,!1).then(t).catch(r)}),this._p2pChannel.on(ye.RequestRePublishDataChannel,(e,t,r)=>{F.all(e.map(async n=>{await this._p2pChannel.publishDataChannel([n]);let a={streamId:n.id,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:n.metadata,channelId:n._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,a,!0)}catch(c){if(c.code!==A.DISCONNECT_P2P)throw c}})).then(t).catch(r)}),this._p2pChannel.on(ye.RequestReSubscribe,async(e,t,r)=>{try{for(let{user:n,kind:a}of e)a===fe.VIDEO?await this.subscribe(n,"video"):await this.subscribe(n,"audio");t()}catch(n){r(n)}}),this._p2pChannel.on(ye.RequestUploadStats,(e,t)=>{this._gateway.uploadStats(e,t)}),this._p2pChannel.on(ye.MediaReconnectStart,e=>{this.safeEmit(je.MEDIA_RECONNECT_START,e)}),this._p2pChannel.on(ye.MediaReconnectEnd,e=>{this.safeEmit(je.MEDIA_RECONNECT_END,e)}),this._p2pChannel.on(ye.NeedSignalRTT,e=>{e(this._gateway.getSignalRTT())}),this._p2pChannel.on(ye.RequestRestartICE,async e=>{if(this._p2pChannel instanceof Rt)return;let t=await this._p2pChannel.restartICE(e),r=await t.next();if(r.done)return;let n=r.value,a;try{a=await this._gateway.restartICE({iceParameters:n})}catch(l){return void t.throw(l)}let{iceParameters:c}=function(l){let u=l.iceParameters;return{iceParameters:{iceUfrag:u.iceUfrag,icePwd:u.icePwd}}}(a);await t.next({remoteIceParameters:c})}),this._p2pChannel.on(ye.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(ye.RequestReconnectPC,async()=>{var e;let{iceParameters:t,dtlsParameters:r,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:a,gatewayAddress:c}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:r,rtpCapabilities:n}),{dtlsParameters:l,iceParameters:u,candidates:h,rtpCapabilities:p,setup:_,cname:E}=rN(a,c);await this._p2pChannel.connect(u,l,h,p,_,E),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(ye.RequestUnpublishForReconnectPC,async(e,t,r)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),t()):r()}),this._p2pChannel.on(ye.P2PLost,()=>{this.safeEmit(je.P2P_LOST,this.store.uid)}),this._p2pChannel.on(ye.UpdateVideoEncoder,e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)}),this._p2pChannel.on(ye.ConnectionTypeChange,e=>{this.safeEmit(je.IS_USING_CLOUD_PROXY,e)}),this._p2pChannel.on(ye.RequestLowStreamParameter,e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(ye.QueryClientConnectionState,e=>{e(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new x(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new x(A.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new x(A.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new x(A.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{let t=[...new Set(e.inspectType)];t.forEach(r=>{var n;if(!ge(n=["supervise","moderation"]).call(n,r))throw new x(A.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(r," is not a valid inspect type."))}),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new x(A.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{let t=new Yp(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},xt)}catch(t){throw Array.isArray(t)?t[0]:t}}async disableContentInspect(){if(!this._inspect)throw new x(A.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(So(e,"enabled"),e){if(!t)throw new x(A.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(nt(t.interval,"interval",1e3,1/0),this.connectionState!=="CONNECTED"||!this._joinInfo)throw new x(A.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);let r=new SS(t);this._moderation=r,this.handleImageModerationEvents(this._moderation),await r.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},xt)}catch(r){throw Array.isArray(r)?r[0]:r}}else{if(!this._moderation)throw new x(A.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(r){throw Array.isArray(r)?r[0]:r}}}handleImageModerationEvents(e){e.on(an.CONNECTION_STATE_CHANGE,(t,r)=>{if(this.safeEmit(je.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,r),t===yr.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new x(A.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}}),e.on(an.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(r=>r.trackMediaType==="video")[0])})}handleVideoInspectEvents(e){e.on(Kt.CONNECTION_STATE_CHANGE,(t,r)=>{if(this.safeEmit(je.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,r),r===jr.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(je.CONTENT_INSPECT_ERROR,new x(A.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}}),e.on(Kt.INSPECT_RESULT,(t,r)=>{var n;if((r==null?void 0:r.code)===A.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return S.debug("Stop inspect content because that has left channel"),this==null||(n=this._inspect)===null||n===void 0||n.close(),void(this._inspect=void 0);this.safeEmit(je.CONTENT_INSPECT_RESULT,t,r)}),e.on(Kt.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(r=>r.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return S.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){So(e,"enabled"),it("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}J([Ce(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],ot.prototype,"leave",null),J([Ce({argsMap:(i,e)=>{if(!Array.isArray(e)){if(!(e instanceof Ri))return[e];e=[e]}return e.map(t=>t?Object(t).toString():"null")}}),R("design:type",Function),R("design:paramtypes",[Object,Boolean]),R("design:returntype",F)],ot.prototype,"publish",null),J([Ce({argsMap:(i,e)=>(e||(e=[]),e instanceof C0?[e.getChannelId()]:(Array.isArray(e)||(e=[e]),e.map(t=>t.getTrackId())))}),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",F)],ot.prototype,"unpublish",null),J([Ce({argsMap:(i,e,t,r)=>[e.uid,t,r]}),R("design:type",Function),R("design:paramtypes",[wi,String,Number]),R("design:returntype",F)],ot.prototype,"subscribe",null),J([Ce({argsMap:(i,e)=>e.map(t=>{let{user:r,mediaType:n}=t;return[r==null?void 0:r.uid,n]})}),R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],ot.prototype,"massSubscribe",null),J([Ce({argsMap:(i,e,t,r)=>[e.uid,t,r]}),R("design:type",Function),R("design:paramtypes",[wi,String,Number]),R("design:returntype",F)],ot.prototype,"unsubscribe",null),J([Ce({argsMap:(i,e)=>e.map(t=>{let{user:r,mediaType:n}=t;return{uid:r==null?void 0:r.uid,mediaType:n}})}),R("design:type",Function),R("design:paramtypes",[Array]),R("design:returntype",F)],ot.prototype,"massUnsubscribe",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",F)],ot.prototype,"setLowStreamParameter",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],ot.prototype,"enableDualStream",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],ot.prototype,"disableDualStream",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[String,Object]),R("design:returntype",F)],ot.prototype,"setClientRole",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[String,Boolean]),R("design:returntype",void 0)],ot.prototype,"setProxyServer",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Object,Boolean]),R("design:returntype",void 0)],ot.prototype,"setTurnServer",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",void 0)],ot.prototype,"setLicense",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Number]),R("design:returntype",void 0)],ot.prototype,"startProxyServer",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],ot.prototype,"stopProxyServer",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",void 0)],ot.prototype,"setLocalAccessPointsV2",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Array,String]),R("design:returntype",void 0)],ot.prototype,"setLocalAccessPoints",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Number]),R("design:returntype",F)],ot.prototype,"setRemoteDefaultVideoStreamType",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Object,Number]),R("design:returntype",F)],ot.prototype,"setRemoteVideoStreamType",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Object,Number]),R("design:returntype",F)],ot.prototype,"setStreamFallbackOption",null),J([Ce({argsMap:(i,e)=>[e]}),R("design:type",Function),R("design:paramtypes",[String,String,Uint8Array]),R("design:returntype",void 0)],ot.prototype,"setEncryptionConfig",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],ot.prototype,"renewToken",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",void 0)],ot.prototype,"enableAudioVolumeIndicator",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[String,Boolean]),R("design:returntype",F)],ot.prototype,"startLiveStreaming",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",F)],ot.prototype,"setLiveTranscoding",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[String]),R("design:returntype",F)],ot.prototype,"stopLiveStreaming",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[String,Object]),R("design:returntype",F)],ot.prototype,"addInjectStreamUrl",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],ot.prototype,"removeInjectStreamUrl",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Mp]),R("design:returntype",F)],ot.prototype,"startChannelMediaRelay",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Mp]),R("design:returntype",F)],ot.prototype,"updateChannelMediaRelay",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],ot.prototype,"stopChannelMediaRelay",null),J([Ce({argsMap:(i,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",F)],ot.prototype,"sendCustomReportMessage",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Object,Object]),R("design:returntype",F)],ot.prototype,"pickSVCLayer",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Number]),R("design:returntype",F)],ot.prototype,"setRTM2Flag",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Object]),R("design:returntype",F)],ot.prototype,"enableContentInspect",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",F)],ot.prototype,"disableContentInspect",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Boolean,Object]),R("design:returntype",F)],ot.prototype,"setImageModeration",null),J([Ce({reportResult:!0}),R("design:type",Function),R("design:paramtypes",[]),R("design:returntype",Array)],ot.prototype,"getJoinChannelServiceRecords",null),J([Ce(),R("design:type",Function),R("design:paramtypes",[Boolean]),R("design:returntype",F)],ot.prototype,"setPublishAudioFilterEnabled",null);class zd{constructor(e,t){g(this,"id",0),g(this,"element",void 0),g(this,"peerPair",void 0),g(this,"context",void 0),g(this,"audioPlayerElement",void 0),g(this,"audioTrack",void 0),zd.count+=1,this.id=zd.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{let t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;let e=async(r,n)=>{let a=n==="offer"?await r.createOffer():await r.createAnswer();return await r.setLocalDescription(a),r.iceGatheringState==="complete"?r.localDescription:new F(c=>{r.onicegatheringstatechange=()=>{r.iceGatheringState==="complete"&&c(r.localDescription)}})},t=async(r,n)=>await r.setRemoteDescription(n);try{let r=await e(this.peerPair[0],"offer");await t(this.peerPair[1],r);let n=await e(this.peerPair[1],"answer");await t(this.peerPair[0],n)}catch(r){throw new x(A.LOCAL_AEC_ERROR,r.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(t)}catch(n){throw new x(A.LOCAL_AEC_ERROR,n.toString()).print()}if(!t)throw new x(A.LOCAL_AEC_ERROR,"no dest node when local aec").print();let r=t.stream.getAudioTracks()[0];return this.audioTrack=r,r}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();let e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){S.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}g(zd,"count",0);let XG=window.AudioContext||window.webkitAudioContext;class sb{constructor(){g(this,"units",[]),g(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return S.debug("the system does not need to process local aec"),-1;this.context||(this.context=new XG);let t=this.units.find(r=>r&&r.getElement()===e);return t||(t=new zd(e,this.context),this.units.push(t)),t.startEchoCancellation(),S.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return ze().name!==Xe.SAFARI}}J([Ce({report:Ee}),R("design:type",Function),R("design:paramtypes",[HTMLAudioElement]),R("design:returntype",Number)],sb.prototype,"processExternalMediaAEC",null);let QG=new sb;function ab(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ob(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ab(Object(t),!0).forEach(function(r){g(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):ab(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}let vS=window||document;function cb(i){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!vS)return;let t=Zt._cspEventHandlerPointer;if(t&&e)return void console.error(t,e);let r=n=>{if(!(n&&n.blockedURI&&(Zt.onSecurityPolicyViolation||Zt.getListeners(qn.SECURITY_POLICY_VIOLATION).length>0)))return;let a=n.blockedURI;P("CSP_DETECTED_HOSTNAME_LIST").some(c=>ge(a).call(a,c))&&(Zt.onSecurityPolicyViolation&&typeof Zt.onSecurityPolicyViolation=="function"&&Zt.onSecurityPolicyViolation(n),Zt.getListeners(qn.SECURITY_POLICY_VIOLATION).length>0&&Zt.safeEmit(qn.SECURITY_POLICY_VIOLATION,n))};t&&vS.removeEventListener("securitypolicyviolation",t),(e||i&&typeof i=="function"||Zt.getListeners(qn.SECURITY_POLICY_VIOLATION).length>0)&&vS.addEventListener("securitypolicyviolation",r),Zt._cspEventHandlerPointer=r}it("PROCESS_ID","process-".concat(at(8,""),"-").concat(at(4,""),"-").concat(at(4,""),"-").concat(at(4,""),"-").concat(at(12,""))),function(){let i=ze();Mi.getDisplayMedia=function(e){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)}(),Mi.getStreamFromExtension=i.name===Xe.CHROME&&Number(i.version)>34,Mi.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let e=new RTCPeerConnection,t=!1;try{e.addTransceiver("audio"),t=!0}catch{}return e.close(),t}(),Mi.supportMinBitrate=i.name===Xe.CHROME||i.name===Xe.EDGE,Mi.supportSetRtpSenderParameters=function(){let e=ze();return!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters||!window.RTCRtpSender.prototype.getParameters?!1:!!la()||!(!Vi()&&!Lh())||e.name===Xe.FIREFOX&&Number(e.version)>=64}(),i.name===Xe.SAFARI&&(Number(i.version)>=14?Mi.supportDualStream=!0:Mi.supportDualStream=!1),Mi.webAudioMediaStreamDest=function(){let e=ze();return!(e.name===Xe.SAFARI&&Number(e.version)<12)}(),Mi.supportReplaceTrack=function(){return window.RTCRtpSender?typeof RTCRtpSender.prototype.replaceTrack=="function":!1}(),Mi.supportWebGL=typeof WebGLRenderingContext<"u",Mi.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,la()||(Mi.webAudioWithAEC=!0),Mi.supportShareAudio=function(){let e=ze();return(e.os===Jt.WIN_10||e.os===Jt.WIN_81||e.os===Jt.WIN_7||e.os===Jt.LINUX||e.os===Jt.MAC_OS)&&e.name===Xe.CHROME&&Number(e.version)>=74}(),Mi.supportDataChannel=function(){return!!(gE(76)||function(e){let t=ze();return!(t.name!==Xe.FIREFOX||!t.osVersion)&&Number(t.version)>=e}(68)||function(e){let t=ze();return!(t.name!==Xe.SAFARI||!t.osVersion)&&Number(t.version)>=e}(14))}(),Mi.supportPCSetConfiguration=function(){let e=window.RTCPeerConnection;return!ht()&&!!e&&e.prototype.setConfiguration instanceof Function}(),Mi.supportWebRTCEncodedTransform=function(){let e=ze();return e.name==="Chrome"&&Number(e.version)>=86}(),Mi.supportWebRTCInsertableStream=function(){let e=ze();return(e.name===Xe.CHROME||e.name===Xe.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),In(()=>{Mi.supportDualStreamEncoding=function(){let e=ze();return P("DISABLE_WEBAUDIO")?!0:e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&P("CHROME_DUAL_STREAM_USE_ENCODING"))}(),S.info("browser compatibility",JSON.stringify(Mi),JSON.stringify(i))})}(),function(){let i;try{i=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void S.error("Error loading sdk config",e.message)}if(i)try{let e=JSON.parse(window.atob(i)),t=Date.now();S.debug("Loading global parameters from cache",e),Object.keys(e).forEach(r=>{if(Object.prototype.hasOwnProperty.call(Yi,r)){let{value:n,expires:a}=e[r];if(a&&a<=t)return;ua[r]=n,Yi[r]=n}})}catch(e){S.error("Error loading mutableParamsCache: ".concat(i),e.message)}}(),Array.isArray(ua.AREAS)&&ua.AREAS.length>0&&Xg(ua.AREAS,!0);let Zt=function(i){let e=new mt,t=i,r={getListeners:e.getListeners.bind(e),on:(n,a)=>(function(c,l){c===qn.SECURITY_POLICY_VIOLATION&&cb(l,!0)}(n,a),e.on.bind(e)(n,a)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return ob(ob({},t),r)}({__TRACK_LIST__:Kc,VERSION:nn,BUILD:YE,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:(i,e,t)=>{S.debug("setParameter key:".concat(i,", value:").concat(JSON.stringify(e))),it(i,e,t)},getParameter:P,getSupportedCodec:async function(){let i={audio:[],video:[]};try{let e=new RTCPeerConnection;e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"});let t=(await e.createOffer()).sdp;if(!t)return i;e.close(),e=null,i=function(r){let n={video:[],audio:[]};return r.match(/ VP8/i)&&n.video.push("VP8"),r.match(/ VP9/i)&&n.video.push("VP9"),r.match(/ AV1/i)&&n.video.push("AV1"),r.match(/ H264/i)&&n.video.push("H264"),r.match(/ H265/i)&&n.video.push("H265"),r.match(/ opus/i)&&n.audio.push("OPUS"),r.match(/ PCMU/i)&&n.audio.push("PCMU"),r.match(/ PCMA/i)&&n.audio.push("PCMA"),r.match(/ G722/i)&&n.audio.push("G722"),n}(t)}catch(e){throw new x(A.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return i},checkSystemRequirements:function(){let i=Ee.reportApiInvoke(null,{name:jt.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:St.TRACER}),e=!1;try{let a=window.RTCPeerConnection,c=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,l=window.WebSocket;e=!!(a&&c&&l)}catch(a){return S.error("check system requirement failed: ",a),!1}let t=!1,r=ze();r.name===Xe.CHROME&&Number(r.version)>=58&&(!a3()||s3())&&(t=!0),r.name===Xe.FIREFOX&&Number(r.version)>=56&&(t=!0),r.name===Xe.OPERA&&Number(r.version)>=45&&(t=!0),r.name===Xe.SAFARI&&Number(r.version)>=11&&(t=!0),(pw()||ze().name===Xe.QQ)&&(t=!0),S.debug("checkSystemRequirements, api:",e,"browser",t);let n=e&&t;return i.onSuccess(n),n},getDevices:function(i){return Hr.enumerateDevices(!0,!0,i)},getMicrophones:function(i){return Hr.getRecordingDevices(i)},getCameras:function(i){return Hr.getCamerasDevices(i)},getElectronScreenSources:uO,getPlaybackDevices:function(i){return Hr.getSpeakers(i)},createClient:function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"},e=Ee.reportApiInvoke(null,{name:jt.CREATE_CLIENT,options:[i],tag:St.TRACER});try{(function(t){Xt(t.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Xt(t.mode,"config.mode",["rtc","live"]),t.audioCodec!==void 0&&Xt(t.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),t.proxyServer!==void 0&&yi(t.proxyServer,"config.proxyServer",1,1e4),t.turnServer!==void 0&&yw(t.turnServer),t.httpRetryConfig!==void 0&&vw(t.httpRetryConfig),t.websocketRetryConfig!==void 0&&vw(t.websocketRetryConfig)})(i)}catch(t){throw e.onError(t),t}return JG()||(i.codec==="vp9"&&(i.codec="vp8",S.debug("browser not support vp9, force use vp8")),it("UNSUPPORTED_VIDEO_CODEC",["vp9"])),i.audioCodec===void 0&&(i.audioCodec="opus"),e.onSuccess(),new ot(Kd(Kd({forceWaitGatewayResponse:!0},i),{},{role:i.mode==="rtc"?"host":i.role||"audience"}))},createCameraVideoTrack:async function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.CREATE_CAM_VIDEO_TRACK,options:[pp({},i)]}),t=hp(i),r=at(8,"track-cam-"),n=null,a=i.encoderConfig==="720p_auto";S.info("start create camera video track with config",JSON.stringify(i),"trackId",r);try{n=(await Wr({video:t},r)).getVideoTracks()[0]||null}catch(l){throw e.onError(l),l}if(!n){let l=new Y(A.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(l),l.throw(S)}i.optimizationMode&&yg(r,n,i,fs(i.encoderConfig));let c=new Ta(n,i,t,i.scalabiltyMode?np(i.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},i.optimizationMode,r);return a&&c.startMonitorStats(),e.onSuccess(c.getTrackId()),S.info("create camera video success, trackId:",r),c},createCustomVideoTrack:function(i){let e=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.CREATE_CUSTOM_VIDEO_TRACK,options:[i]}),t=new ke(i.mediaStreamTrack,{width:i.width,height:i.height,frameRate:i.frameRate,bitrateMax:i.bitrateMax,bitrateMin:i.bitrateMin},i.scalabiltyMode?np(i.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},i.optimizationMode,at(8,"track-cus-"),[ut.CUSTOM_TRACK]);return e.onSuccess(t.getTrackId()),S.info("create custom video track success with config",i,"trackId",t.getTrackId()),t},createScreenVideoTrack:async function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable",t=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.CREATE_SCREEN_VIDEO_TRACK,options:[pp({},i),e]}),r=i.encoderConfig==="720p_auto";i.encoderConfig?typeof i.encoderConfig=="string"||i.encoderConfig.width&&i.encoderConfig.height||(i.encoderConfig.width={max:1920},i.encoderConfig.height={max:1080}):i.encoderConfig="1080p_2";let n=function(_){let E={};_.screenSourceType&&(E.mediaSource=_.screenSourceType),_.extensionId&&EE()&&(E.extensionId=_.extensionId);let{displaySurface:T,selfBrowserSurface:w,surfaceSwitching:C,systemAudio:O}=_;(gE(107)||cw(107)||lw(93))&&(T&&(Xt(T,"displaySurface",["browser","window","monitor"]),E.displaySurface=T),w?(Xt(w,"selfBrowserSurface",["exclude","include"]),E.selfBrowserSurface=w):E.selfBrowserSurface="include",C&&(Xt(C,"surfaceSwitching",["exclude","include"]),E.surfaceSwitching=C)),(gE(105)||cw(105)||lw(91))&&O&&(Xt(O,"systemAudio",["exclude","include"]),E.systemAudio=O),_.electronScreenSourceId&&(E.sourceId=_.electronScreenSourceId);let b=_.encoderConfig?og(_.encoderConfig):null;return E.mandatory={chromeMediaSource:"desktop",maxWidth:b?b.width:void 0,maxHeight:b?b.height:void 0},b&&(b.frameRate&&(typeof b.frameRate=="number"?(E.mandatory.maxFrameRate=b.frameRate,E.mandatory.minFrameRate=b.frameRate):(E.mandatory.maxFrameRate=b.frameRate.max||b.frameRate.ideal||b.frameRate.exact||void 0,E.mandatory.minFrameRate=b.frameRate.min||b.frameRate.ideal||b.frameRate.exact||void 0),E.frameRate=b.frameRate),b.width&&(E.width=b.width),b.height&&(E.height=b.height)),E}(i),a=at(8,"track-scr-v-"),c=null,l=null,u=ct();if(!u.supportShareAudio&&e==="enable"){let _=new Y(A.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return t.onError(_),_.throw(S)}S.info("start create screen video track with config",i,"withAudio",e,"trackId",a);try{let _=await Wr({screen:n,screenAudio:e==="auto"?u.supportShareAudio:e==="enable"},a);c=_.getVideoTracks()[0]||null,l=_.getAudioTracks()[0]||null}catch(_){throw t.onError(_),_}if(!c){let _=new Y(A.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(_),_.throw(S)}if(!l&&e==="enable"){c&&c.stop();let _=new Y(A.SHARE_AUDIO_NOT_ALLOWED);return t.onError(_),_.throw(S)}i.optimizationMode||(i.optimizationMode="detail"),i.optimizationMode&&(yg(a,c,i,i.encoderConfig&&og(i.encoderConfig)||void 0),i.encoderConfig&&typeof i.encoderConfig!="string"&&(i.encoderConfig.bitrateMin=i.encoderConfig.bitrateMax));let h=new ke(c,i.encoderConfig?og(i.encoderConfig):{},i.scalabiltyMode?np(i.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},i.optimizationMode,a,[ut.SCREEN_TRACK]);if(r&&h.startMonitorStats(),!l)return t.onSuccess(h.getTrackId()),S.info("create screen video track success","video:",h.getTrackId()),h;let p=new Qe(l,void 0,at(8,"track-scr-a-"),!1,!0);return t.onSuccess([h.getTrackId(),p.getTrackId()]),S.info("create screen video track success","video:",h.getTrackId(),"audio:",p.getTrackId()),[h,p]},createMicrophoneAndCameraTracks:async function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.CREATE_MIC_AND_CAM_TRACKS,options:[i,e]}),r=e.encoderConfig==="720p_auto",n=hp(e),a=CO(i),c=at(8,"track-mic-"),l=at(8,"track-cam-"),u=null,h=null;S.info("start create camera video track(".concat(l,") and microphone audio track(").concat(c,") with config, audio: ").concat(JSON.stringify(i),", video: ").concat(JSON.stringify(e)));try{let E=await Wr({audio:a,video:n},"".concat(c,"-").concat(l));u=E.getAudioTracks()[0],h=E.getVideoTracks()[0]}catch(E){throw t.onError(E),E}if(!u||!h){let E=new Y(A.UNEXPECTED_ERROR,"can not find tracks in media stream");return t.onError(E),E.throw(S)}e.optimizationMode&&yg(l,h,e,fs(e.encoderConfig));let p=new ga(u,i,a,c),_=new Ta(h,e,n,e.scalabiltyMode?np(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,l);return r&&_.startMonitorStats(),t.onSuccess([p.getTrackId(),_.getTrackId()]),S.info("create camera video track(".concat(l,") and microphone audio track(").concat(c,") success")),[p,_]},createMicrophoneAudioTrack:async function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.CREATE_MIC_AUDIO_TRACK,options:[i]}),t=CO(i),r=at(8,"track-mic-"),n=null;S.info("start create microphone audio track with config",JSON.stringify(i),"trackId",r);try{n=(await Wr({audio:t},r)).getAudioTracks()[0]||null}catch(c){throw e.onError(c),c}if(!n){let c=new Y(A.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(c),c.throw(S)}let a=new ga(n,i,t,r);return e.onSuccess(a.getTrackId()),S.info("create microphone audio track success, trackId:",r),a},createCustomAudioTrack:function(i){let e=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.CREATE_CUSTOM_AUDIO_TRACK,options:[i]}),t=new Qe(i.mediaStreamTrack,i.encoderConfig?sp(i.encoderConfig):{},at(8,"track-cus-"),!1,!0);return S.info("create custom audio track success with config",i,"trackId",t.getTrackId()),e.onSuccess(t.getTrackId()),t},createBufferSourceAudioTrack:async function(i){var e;let{cacheOnlineFile:t,encoderConfig:r}=i,{source:n}=i,a={source:n instanceof AudioBuffer?"AudioBuffer":n instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":n,cacheOnlineFile:t,encoderConfig:r},c=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.CREATE_BUFFER_AUDIO_TRACK,options:[a]});if(P("DISABLE_WEBAUDIO"))throw new Y(A.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");let l=at(8,"track-buf-");S.info("start create buffer source audio track with config",JSON.stringify(a),"trackId",l);let u=n;if(!(n instanceof AudioBuffer))try{n=await K5(n,t)}catch(_){return c.onError(_),_.throw(S)}let h=new H5(n),p=new Sa(u,h,r?sp(r):{},l);return S.info("create buffer source audio track success, trackId:",l),c.onSuccess(p.getTrackId()),p},setAppType:function(i){if(S.debug("setAppType: ".concat(i)),!(Number.isInteger(i)&&i>=0))throw S.debug("Invalid appType"),new x(A.INVALID_PARAMS,"invalid app type",i);it("APP_TYPE",Math.floor(i))},setLogLevel:function(i){S.setLogLevel(i)},enableLogUpload:function(){P("USE_NEW_LOG")?it("UPLOAD_LOG",!0):S.enableLogUpload()},disableLogUpload:function(){P("USE_NEW_LOG")?it("UPLOAD_LOG",!1):S.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new Mp},checkAudioTrackIsActive:async function(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,t=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(i instanceof Qe||i instanceof On)){let u=new x(A.INVALID_TRACK,"the parameter is not a audio track");return t.onError(u),u.throw()}e&&e<1e3&&(e=1e3);let r=i instanceof Qe?i.getTrackLabel():"remote_track",n=i.getVolumeLevel(),a=n,c=n,l=Date.now();return new F(u=>{let h=setInterval(()=>{let p=i.getVolumeLevel();a=p>a?p:a,c=p<c?p:c;let _=a-c>1e-4,E=Date.now()-l;if(_||E>e){clearInterval(h);let T=_,w={duration:E,deviceLabel:r,maxVolumeLevel:a,result:T};S.info("[track-".concat(i.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(w))),t.onSuccess(w),u(T)}},200)})},checkVideoTrackIsActive:async function(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,t=Ee.reportApiInvoke(null,{tag:St.TRACER,name:jt.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(i instanceof ke||i instanceof _s)){let _=new x(A.INVALID_TRACK,"the parameter is not a video track");return t.onError(_),_.throw()}e&&e<1e3&&(e=1e3);let r=i instanceof ke?i.getTrackLabel():"remote_track",n=i.getMediaStreamTrack(!0),a=document.createElement("video");a.style.width="1px",a.style.height="1px",a.setAttribute("muted",""),a.muted=!0,a.setAttribute("playsinline",""),a.controls=!1,(Vi()||Lh())&&(a.style.opacity="0.01",a.style.position="fixed",a.style.left="0",a.style.top="0",document.body.appendChild(a)),a.srcObject=new MediaStream([n]),a.play();let c=document.createElement("canvas");c.width=160,c.height=120;let l=0,u=0;try{let _=Date.now();l=await function(E,T,w,C){let O,b=0,k=null;return new F((U,X)=>{function z(){b>C&&O&&(O(),U(b));let j=w.getContext("2d");if(!j){let ce=new x(A.UNEXPECTED_ERROR,"can not get canvas 2d context.");return S.error(ce.toString()),void X(ce)}j.drawImage(E,0,0,160,120);let B=j.getImageData(0,0,w.width,w.height),W=Math.floor(B.data.length/3);if(k){for(let ce=0;ce<W;ce+=3)if(B.data[ce]!==k[ce])return b+=1,void(k=B.data);k=B.data}else k=B.data}setTimeout(()=>{O&&(O(),U(b))},T),O=pg(()=>{z()},30)})}(a,e,c,4),u=Date.now()-_}catch(_){throw t.onError(_),_}qG===Xe.SAFARI&&(a.pause(),a.remove()),a.srcObject=null;let h=l>4,p={duration:u,changedPicNum:l,deviceLabel:r,result:h};return S.info("[track-".concat(i.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(p))),t.onSuccess(p),h},setArea:Xg,audioElementPlayCenter:Cr,processExternalMediaAEC:function(i){QG.processExternalMediaAEC(i)},registerExtensions:function(i){i.forEach(e=>{let t=e;t.__registered__=!0,t.logger.hookLog=S.extLog,t.reporter.hookApiInvoke=Ee.extApiInvoke,t.parameters&&Object.keys(t.parameters).forEach(r=>{t.parameters[r]=P(r)})})},ChannelMediaRelayError:fa,ChannelMediaRelayEvent:zn,ChannelMediaRelayState:qi,RemoteStreamFallbackType:cg,RemoteStreamType:ap,ConnectionDisconnectedReason:Ve,AudienceLatencyLevelType:yE,AREAS:He});return Object.defineProperties(Zt,{onAudioAutoplayFailed:{get:()=>Kr.onAudioAutoplayFailed,set:i=>{Kr.onAudioAutoplayFailed=i}},onAutoplayFailed:{get:()=>Kr.onAutoplayFailed,set:i=>{Kr.onAutoplayFailed=i}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Zt._onSecurityPolicyViolation,set(i){Zt._onSecurityPolicyViolation=i,cb(i)}},__CLIENT_LIST__:{get:()=>P("SHOW_GLOBAL_CLIENT_LIST")?ha:[]}}),Hr.on(Us.CAMERA_DEVICE_CHANGED,i=>{S.info("camera device changed",JSON.stringify(i)),Zt.onCameraChanged&&Zt.onCameraChanged(i),Zt.safeEmit(qn.CAMERA_CHANGED,i)}),Hr.on(Us.RECORDING_DEVICE_CHANGED,i=>{S.info("microphone device changed",JSON.stringify(i)),Zt.onMicrophoneChanged&&Zt.onMicrophoneChanged(i),Zt.safeEmit(qn.MICROPHONE_CHANGED,i)}),Hr.on(Us.PLAYOUT_DEVICE_CHANGED,i=>{S.debug("playout device changed",JSON.stringify(i)),Zt.onPlaybackDeviceChanged&&Zt.onPlaybackDeviceChanged(i),Zt.safeEmit(qn.PLAYBACK_DEVICE_CHANGED,i)}),Cr.onAutoplayFailed=()=>{S.info("detect audio element autoplay failed"),Kr.onAudioAutoplayFailed&&Kr.onAudioAutoplayFailed()},tt.on("autoplay-failed",()=>{S.info("detect webaudio autoplay failed"),Kr.onAudioAutoplayFailed&&Kr.onAudioAutoplayFailed(),Zt.safeEmit(qn.AUTOPLAY_FAILED)}),Mt.on(Ls.NETWORK_STATE_CHANGE,(i,e)=>{S.info("[network-indicator] network state changed, ".concat(e," => ").concat(i))}),window&&(window.__ARTC__=Zt),Zt})}),eL={};DH(eL,{AgoraRTCProvider:()=>rL,AgoraRTCReactError:()=>br,AgoraRTCScreenShareProvider:()=>GH,LocalAudioTrack:()=>uL,LocalUser:()=>mL,LocalVideoTrack:()=>fL,RemoteAudioTrack:()=>EL,RemoteUser:()=>SL,RemoteVideoTrack:()=>gL,TrackBoundary:()=>tK,VERSION:()=>aK,default:()=>TL,useAutoPlayAudioTrack:()=>Jv,useAutoPlayVideoTrack:()=>qv,useClientEvent:()=>FH,useConnectionState:()=>HH,useCurrentUID:()=>KH,useIsConnected:()=>ea,useJoin:()=>sL,useLocalCameraTrack:()=>cL,useLocalMicrophoneTrack:()=>oL,useLocalScreenTrack:()=>ZH,useNetworkQuality:()=>zH,usePublish:()=>aL,useRTCClient:()=>Bn,useRTCScreenShareClient:()=>WH,useRemoteAudioTracks:()=>lL,useRemoteUserTrack:()=>qT,useRemoteUsers:()=>dL,useRemoteVideoTracks:()=>QH,useTrackEvent:()=>jH,useVolumeLevel:()=>qH});var kH=nc(sc());function Tr(s,o,d){return s.on(o,d),()=>s.off(o,d)}function LH(s){try{return s()}catch(o){console.error(o)}}function ac(s){return()=>s.forEach(LH)}function MH(s,o){let d=setInterval(s,o);return()=>clearInterval(d)}function y_(s,o){let d=setTimeout(s,o);return()=>clearTimeout(d)}function zv(){let s,o,d;function f(){if(o){let V=o;o=void 0,V()}}async function m(){if(d){let V=d;d=void 0;try{await V()}catch(q){console.error(q)}}}async function v(V){s=!0,await m();try{d=await V()}catch(q){console.error(q)}s=!1,f()}async function I(){s=!0,await m(),s=!1,f()}function D(V){s?o=()=>v(V):v(V)}function L(){s?o=I:I()}return{run:D,dispose:L}}var C_=typeof document<"u"?se.useLayoutEffect:se.useEffect;function UH(s){return s!=null&&typeof s.then=="function"}function to(){let s=se.useRef(!1);return se.useEffect(()=>(s.current=!1,()=>{s.current=!0}),[]),s}function xH(){let s=to();function o(d,f){return new Promise(async(m,v)=>{try{let I=await d;s.current||m(I)}catch(I){s.current?f&&f(I):v(I)}})}return se.useCallback(o,[s])}function tL(s){let o=xH(),[d,f]=se.useState();return C_(()=>{UH(s)?o(s).then(f):f(s)},[s,o]),d}function oc(s,o){let d=se.useRef();se.useEffect(()=>{let{run:f,dispose:m}=d.current||(d.current=zv());return f(s),m},o)}function VH(s,o){let d=s.split("."),f=o.split("."),m=Math.max(d.length,f.length);for(let v=0;v<m;v++){let I=parseInt(d[v]||"0"),D=parseInt(f[v]||"0");if(I>D)return 1;if(I<D)return-1}return 0}function FH(s,o,d){let f=se.useRef(d);C_(()=>{f.current=d},[d]),se.useEffect(()=>{if(s)return Tr(s,o,(...m)=>{f.current&&f.current(...m)})},[o,s])}function jH(s,o,d){let f=se.useRef(d);C_(()=>{f.current=d},[d]),se.useEffect(()=>{if(s)return Tr(s,o,(...m)=>{f.current&&f.current(...m)})},[o,s])}var iL=se.createContext(null);function rL({client:s,children:o}){return we.jsx(iL.Provider,{value:s,children:o})}function BH(s){let o=se.useContext(iL);return s||o}function Bn(s){let o=BH(s);if(!o)throw new Error("Agora RTC client not found. Should be wrapped in <AgoraRTCProvider value={client} />");return o}var nL=se.createContext(null);function GH({client:s,children:o}){return we.jsx(nL.Provider,{value:s,children:o})}function WH(s){let o=se.useContext(nL);return s||o}function HH(s){let o=Bn(s),[d,f]=se.useState(o?o.connectionState:"DISCONNECTED");return se.useEffect(()=>{if(o){f(o.connectionState);let m;return ac([Tr(o,"connection-state-change",v=>{m==null||m(),v==="CONNECTED"?m=y_(()=>f(v),0):f(v)}),()=>m==null?void 0:m()])}else f("DISCONNECTED")},[o]),d}function ea(s){let o=Bn(s),[d,f]=se.useState(o?o.connectionState==="CONNECTED":!1);return se.useEffect(()=>{if(o){f(o.connectionState==="CONNECTED");let m;return ac([Tr(o,"connection-state-change",v=>{m==null||m(),m=y_(()=>f(v==="CONNECTED"),0)}),()=>m==null?void 0:m()])}else f(!1)},[o]),d}function KH(s){let o=Bn(s),[d,f]=se.useState(o==null?void 0:o.uid);return se.useEffect(()=>{if(o)return Tr(o,"connection-state-change",m=>{if(m==="CONNECTED")return y_(()=>f(o.uid),0);m==="DISCONNECTED"&&f(void 0)})},[o]),d}var br=class extends Error{constructor(o,d){var s=(...UK)=>(super(...UK),Yd(this,"rtcMethod"),Yd(this,"rtcError"),Yd(this,"name","AgoraRTCReactException"),this);s(typeof d=="string"?d:d.message),this.rtcMethod=o,this.rtcError=d}log(o){console[o](this)}};function sL(s,o=!0,d){let f=Bn(d),m=ea(d),v=se.useRef(),[I,D]=se.useState(!1),[L,V]=se.useState(0),[q,H]=se.useState(null),te=to();return oc(async()=>{if(te.current||(H(null),V(0),D(!1)),o&&f){try{te.current||D(!0);let{appid:pe,channel:ee,token:ae,uid:K}=typeof s=="function"?await s():s,G=await f.join(pe,ee,ae,K);te.current||V(G)}catch(pe){console.error(pe),te.current||H(new br("IAgoraRTCClient.join",pe))}te.current||D(!1);let de=v.current||(v.current=zv());return ac([()=>{de.dispose()},()=>{de.run(()=>f.unpublish(f.localTracks))},()=>{for(let pe of f.localTracks)pe.isPlaying&&pe.stop(),pe.close();de.run(()=>f.leave())}])}},[o,d]),{data:L,isLoading:I,isConnected:m,error:q}}var AD=()=>({uplinkNetworkQuality:0,downlinkNetworkQuality:0,delay:0});function zH(s){let o=Bn(s),[d,f]=se.useState(AD);return se.useEffect(()=>{if(o)return Tr(o,"network-quality",m=>f({uplinkNetworkQuality:m.uplinkNetworkQuality,downlinkNetworkQuality:m.downlinkNetworkQuality,delay:o.getRTCStats().RTT??0}));f(AD())},[o]),d}var YH=nc(sc());function aL(s,o=!0,d){let f=Bn(d),m=ea(d),v=se.useRef([]),[I,D]=se.useState(!1),[L,V]=se.useState(null),q=to();return oc(async()=>{if(q.current||(D(!1),V(null)),!f||!m||!o)return;let H=s.filter(Boolean),te=ee=>{let ae=VH(YH.default.VERSION,"4.18.2")>=0;return ae||new br("usePublish","please check your agora-rtc-sdk-ng version in package.json, it's recommend upgrade to >= 4.18.2").log("warn"),ae?f.mode!=="live"||f.role!=="audience":!0},de=ee=>v.current.some(ae=>ae&&ae.getTrackId()===ee.getTrackId()),pe=ee=>te()&&ee.enabled&&o&&!de(ee);for(let ee=0;ee<H.length;ee++){let ae=H[ee];if(ae&&pe(ae)){await f.unpublish(v.current.filter(K=>(K==null?void 0:K.trackMediaType)===ae.trackMediaType));try{q.current||D(!0),await f.publish(ae)}catch(K){console.error(K),q.current||V(new br("IAgoraRTCClient.publish",K))}q.current||D(!1)}}v.current=H},[m,o,f,s]),{isLoading:I,error:L}}function qH(s){let[o,d]=se.useState(0);return se.useEffect(()=>{if(s)return MH(()=>{d(s.getVolumeLevel())},1e3)},[s]),o}var JH=nc(sc());function oL(s=!0,o={ANS:!0,AEC:!0},d){let f=ea(d),[m,v]=se.useState(null),[I,D]=se.useState(!1),[L,V]=se.useState(null),q=to();return oc(async()=>{if(q.current||(D(!1),V(null)),f&&s&&!m){try{q.current||D(!0);let H=await JH.default.createMicrophoneAudioTrack(o);q.current||v(H)}catch(H){console.error(H),q.current||V(new br("IAgoraRTC.createMicrophoneAudioTrack",H))}q.current||D(!1)}!f&&!q.current&&v(null)},[f,s]),{localMicrophoneTrack:m,isLoading:I,error:L}}var XH=nc(sc());function cL(s=!0,o,d){let f=ea(d),[m,v]=se.useState(null),[I,D]=se.useState(!1),[L,V]=se.useState(null),q=to();return oc(async()=>{if(q.current||(D(!1),V(null)),f&&s&&!m){try{q.current||D(!0);let H=await XH.default.createCameraVideoTrack(o);q.current||v(H)}catch(H){console.error(H),q.current||V(new br("IAgoraRTC.createCameraVideoTrack",H))}q.current||D(!1)}!f&&!q.current&&v(null)},[f,s]),{localCameraTrack:m,isLoading:I,error:L}}function lL(s,o){let d=Bn(o),[f,m]=se.useState([]),v=ea(),I=se.useRef([]),[D,L]=se.useState(!1),[V,q]=se.useState(null),H=to();return oc(async()=>{if(H.current||q(null),!Array.isArray(s)||!v)return;let te=async ee=>{if(!ee.audioTrack&&s.some(({uid:ae})=>ee.uid===ae)){try{H.current||L(!0),await d.subscribe(ee,"audio")}catch(ae){console.error(ae),H.current||q(new br("IAgoraRTCClient.subscribe",ae))}ee.audioTrack&&!I.current.some(ae=>ae.getUserId()===ee.uid)&&I.current.push(ee.audioTrack),I.current=I.current.map(ae=>ee.audioTrack&&ae.getUserId()===ee.uid&&ae.getTrackId()!==ee.audioTrack.getTrackId()?ee.audioTrack:ae),H.current||(m(I.current),L(!1))}},de=async ee=>{if(s.some(({uid:ae})=>ee.uid===ae)){H.current||(I.current=I.current.filter(ae=>ae.getUserId()!==ee.uid),m(I.current));try{H.current||L(!0),await d.unsubscribe(ee,"audio")}catch(ae){console.error(ae),H.current||q(new br("IAgoraRTCClient.unsubscribe",ae))}H.current||L(!1)}};s.map(ee=>{!ee.audioTrack&&ee.hasAudio&&te(ee)});let pe=[];for(let ee=0;ee<I.current.length;ee++){let ae=I.current[ee];if(!s.some(K=>K.uid===ae.getUserId())){let K=d.remoteUsers.find(G=>G.uid===ae.getUserId());K&&pe.push({user:K,mediaType:"audio"}),I.current.splice(ee,1),ee--}}if(pe.length>0){try{H.current||L(!0),await d.massUnsubscribe(pe)}catch(ee){console.error(ee),H.current||q(new br("IAgoraRTCClient.massUnsubscribe",ee))}H.current||(m(I.current.slice()),L(!1))}return ac([Tr(d,"user-published",(ee,ae)=>{s.find(K=>K.uid===ee.uid)&&ae==="audio"&&te(ee)}),Tr(d,"user-unpublished",(ee,ae)=>{s.find(K=>K.uid===ee.uid)&&ae==="audio"&&de(ee)})])},[v,d,s]),{audioTracks:f,isLoading:D,error:V}}function QH(s,o){let d=Bn(o),[f,m]=se.useState([]),v=ea(),I=se.useRef([]),[D,L]=se.useState(!1),[V,q]=se.useState(null),H=to();return oc(async()=>{if(H.current||q(null),!Array.isArray(s)||!v)return;let te=async ee=>{if(!ee.videoTrack&&s.some(({uid:ae})=>ee.uid===ae)){try{H.current||L(!0),await d.subscribe(ee,"video")}catch(ae){console.error(ae),H.current||q(new br("IAgoraRTCClient.subscribe",ae))}ee.videoTrack&&!I.current.some(ae=>ae.getUserId()===ee.uid)&&I.current.push(ee.videoTrack),I.current=I.current.map(ae=>ee.videoTrack&&ae.getUserId()===ee.uid&&ae.getTrackId()!==ee.videoTrack.getTrackId()?ee.videoTrack:ae),H.current||(m(I.current),L(!1))}},de=async ee=>{if(s.some(({uid:ae})=>ee.uid===ae)){H.current||(I.current=I.current.filter(ae=>ae.getUserId()!==ee.uid),m(I.current));try{H.current||L(!0),await d.unsubscribe(ee,"video")}catch(ae){console.error(ae),H.current||q(new br("IAgoraRTCClient.unsubscribe",ae))}H.current||L(!1)}};s.map(ee=>{!ee.videoTrack&&ee.hasVideo&&te(ee)});let pe=[];for(let ee=0;ee<I.current.length;ee++){let ae=I.current[ee];if(!s.some(K=>K.uid===ae.getUserId())){let K=d.remoteUsers.find(G=>G.uid===ae.getUserId());K&&pe.push({user:K,mediaType:"video"}),I.current.splice(ee,1),ee--}}if(pe.length>0){try{H.current||L(!0),await d.massUnsubscribe(pe)}catch(ee){console.error(ee),H.current||q(new br("IAgoraRTCClient.massUnsubscribe",ee))}H.current||(m(I.current.slice()),L(!1))}return ac([Tr(d,"user-published",(ee,ae)=>{s.find(K=>K.uid===ee.uid)&&ae==="video"&&te(ee)}),Tr(d,"user-unpublished",(ee,ae)=>{s.find(K=>K.uid===ee.uid)&&ae==="video"&&de(ee)})])},[v,d,s]),{videoTracks:f,isLoading:D,error:V}}function qT(s,o,d){let f=Bn(d),m=o==="audio"?"audioTrack":"videoTrack",[v,I]=se.useState(s&&s[m]),D=ea(),L=se.useRef(),[V,q]=se.useState(!1),[H,te]=se.useState(null);return se.useEffect(()=>{if(!s||!D)return;let de=!1;de||te(null);let pe=o==="audio"?"hasAudio":"hasVideo",ee=s.uid,ae=async(Q,_e)=>{if(Q[m]&&f.remoteUsers.some(({uid:Re})=>Q.uid===Re))try{de||q(!0),await f.unsubscribe(Q,_e)}catch(Re){de||te(new br("IAgoraRTCClient.unsubscribe",Re)),console.error(Re)}de||(I(void 0),q(!1))},K=async(Q,_e)=>{try{!Q[m]&&f.remoteUsers.some(({uid:Re})=>Q.uid===Re)&&(de||q(!0),await f.subscribe(Q,_e)),de||I(Q[m])}catch(Re){de||te(new br("IAgoraRTCClient.subscribe",Re)),console.error(Re)}de||q(!1)},G=L.current||(L.current=zv());return!s[m]&&s[pe]?G.run(()=>K(s,o)):I(s[m]),ac([()=>{de=!0,G.dispose()},Tr(f,"user-published",(Q,_e)=>{Q.uid===ee&&_e===o&&G.run(()=>K(Q,o))}),Tr(f,"user-unpublished",(Q,_e)=>{Q.uid===ee&&_e===o&&G.run(()=>ae(Q,o))})])},[D,f,s,o,m]),{track:v,isLoading:V,error:H}}function dL(s){let o=Bn(s),[d,f]=se.useState(o?o.remoteUsers:[]);return se.useEffect(()=>{if(o){let m=()=>f(o.remoteUsers.slice());return ac([Tr(o,"user-joined",m),Tr(o,"user-left",m),Tr(o,"user-published",m),Tr(o,"user-unpublished",m)])}},[o]),d}var $H=nc(sc());function ZH(s=!0,o,d,f){let m=ea(f),[v,I]=se.useState(null),[D,L]=se.useState(!1),[V,q]=se.useState(null),H=to();return oc(async()=>{if(H.current||(L(!1),q(null)),m&&s&&!v){try{H.current||L(!0);let te=await $H.default.createScreenVideoTrack(o,d);H.current||I(te)}catch(te){console.error(te),H.current||q(new br("IAgoraRTC.createScreenVideoTrack",te))}H.current||L(!1)}(!m||!s)&&!H.current&&I(null)},[m,s]),{screenTrack:v,isLoading:D,error:V}}function eK(){let s=new Map,o=1500;return{onMount:d=>{let f=s.get(d);f&&(f(),s.delete(d))},onUnmount:d=>{let f=s.get(d);f&&f(),s.set(d,y_(()=>{d.isPlaying&&d.stop(),s.delete(d)},o))},dispose:()=>{for(let[d,f]of s)d.isPlaying&&d.stop(),f&&f();s.clear()}}}var Yv=se.createContext(void 0);function tK({children:s}){let[o]=se.useState(eK);return se.useEffect(()=>o.dispose,[o]),we.jsx(Yv.Provider,{value:o,children:s})}function qv(s,o,d){let f=se.useContext(Yv);se.useEffect(()=>{if(s)return d&&o?s.play(d):s.stop(),f?(f.onMount(s),()=>f.onUnmount(s)):()=>{s.isPlaying&&s.stop()}},[s,d,o,f])}function Jv(s,o){let d=se.useContext(Yv);C_(()=>{if(s)return o?s.play():s.stop(),d?(d.onMount(s),()=>d.onUnmount(s)):()=>{s.isPlaying&&s.stop()}},[s,o,d])}function uL({track:s,play:o=!1,volume:d,disabled:f,muted:m,children:v}){let I=tL(s);return Jv(I,o),se.useEffect(()=>{I&&d!=null&&I.setVolume(d)},[I,d]),se.useEffect(()=>{I&&f!=null&&I.setEnabled(!f).catch(console.warn)},[f,I]),se.useEffect(()=>{I&&m!=null&&I.setMuted(m).catch(console.warn)},[m,I]),v?we.jsx(we.Fragment,{children:v}):null}var hL={position:"relative",width:"100%",height:"100%",overflow:"hidden",background:"#000"},pL={width:"100%",height:"100%"},Xv={position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"hidden",zIndex:2},R_=(s,o)=>se.useMemo(()=>({...s,...o}),[s,o]);function fL({track:s,play:o,disabled:d,muted:f,style:m,...v}){let I=R_(pL,m),[D,L]=se.useState(null),V=tL(s);return qv(V,o,D),se.useEffect(()=>{V&&d!=null&&V.setEnabled(!d).catch(console.warn)},[d,V]),se.useEffect(()=>{V&&f!=null&&V.setMuted(f).catch(console.warn)},[f,V]),we.jsx("div",{...v,ref:L,style:I})}var iK={width:"100%",height:"100%",background:"#1a1e21 center/cover no-repeat",filter:"blur(16px) brightness(0.4)"},rK={position:"absolute",top:"50%",left:"50%",maxWidth:"50%",maxHeight:"50%",aspectRatio:"1",transform:"translate(-50%, -50%)",borderRadius:"50%",overflow:"hidden",objectFit:"cover"};function _L({cover:s}){return we.jsx("div",{style:Xv,children:typeof s=="string"?we.jsxs(we.Fragment,{children:[we.jsx("div",{style:{...iK,backgroundImage:`url(${s})`}}),we.jsx("img",{src:s,style:rK})]}):s()})}function mL({micOn:s,cameraOn:o,audioTrack:d,videoTrack:f,playAudio:m,playVideo:v,volume:I,cover:D,children:L,style:V,...q}){let H=R_(hL,V);return v=v??!!o,m=m??!!s,we.jsxs("div",{...q,style:H,children:[we.jsx(fL,{disabled:!o,play:v,track:f}),we.jsx(uL,{disabled:!s,play:m,track:d,volume:I}),D&&!o&&we.jsx(_L,{cover:D}),we.jsx("div",{style:Xv,children:L})]})}function EL({track:s,play:o=!1,playbackDeviceId:d,volume:f,children:m}){return Jv(s,o),se.useEffect(()=>{s&&d!=null&&s.setPlaybackDevice(d).catch(console.warn)},[s,d]),se.useEffect(()=>{s&&f!=null&&s.setVolume(f)},[s,f]),m?we.jsx(we.Fragment,{children:m}):null}function gL({track:s,play:o,style:d,...f}){let m=R_(pL,d),[v,I]=se.useState(null);return qv(s,o,v),we.jsx("div",{...f,ref:I,style:m})}function SL({user:s,playVideo:o,playAudio:d,playbackDeviceId:f,volume:m,cover:v,style:I,children:D,...L}){let V=R_(hL,I),{track:q}=qT(s,"video"),{track:H}=qT(s,"audio");return o=o??(s==null?void 0:s.hasVideo),d=d??(s==null?void 0:s.hasAudio),we.jsxs("div",{...L,style:V,children:[we.jsx(gL,{play:o,track:q}),we.jsx(EL,{play:d,playbackDeviceId:f,track:H,volume:m}),v&&!o&&we.jsx(_L,{cover:v}),we.jsx("div",{style:Xv,children:D})]})}var nK=nc(sc()),sK=class{constructor(){Yd(this,"appType",1001);nK.default.setAppType(this.appType)}};new sK;var aK="2.0.0";PH(eL,nc(sc()));var TL=kH.default;const gf=14,Sf=8,JS=8,XS=4;function oK({volumeLevel:s=0,noise:o=.075,...d}){const[f,m]=se.useState(0);return se.useEffect(()=>{if(s&&o){const v=Math.max(0,Math.min(1,o)),I=setInterval(()=>{m(s+Math.random()*v*(Math.random()>.5?1:-1))},50);return()=>clearInterval(I)}},[s,o]),we.jsxs("svg",{fill:"none",height:"24",viewBox:"0 0 24 24",width:"24",xmlns:"http://www.w3.org/2000/svg",...d,children:[we.jsx("defs",{children:we.jsx("clipPath",{id:"icon-mic-v-clip",children:we.jsx("rect",{height:gf,rx:Sf/2,width:Sf,x:JS,y:XS})})}),we.jsx("path",{d:"M0 0h24v24H0z",fill:"#999CA3",opacity:".01"}),we.jsx("rect",{clipPath:"url(#icon-mic-v-clip)",fill:"#fff",height:gf,width:Sf,x:JS,y:XS}),we.jsx("path",{d:"M4 16.625h2v-1.25H4v1.25Zm6 4h4v-1.25h-4v1.25Zm8-4h2v-1.25h-2v1.25Zm-4 4A4.625 4.625 0 0 0 18.625 16h-1.25A3.375 3.375 0 0 1 14 19.375v1.25ZM5.375 16A4.625 4.625 0 0 0 10 20.625v-1.25A3.375 3.375 0 0 1 6.625 16h-1.25Z",fill:"#fff"}),we.jsx("g",{clipPath:"url(#icon-mic-v-clip)",children:we.jsx("rect",{fill:"#44AD00",height:gf*2,style:{transform:`translateY(${(1-f)*gf}px)`,transition:"transform .1s"},width:Sf,x:JS,y:XS})})]})}const cK=se.memo(function(o){return we.jsxs("svg",{fill:"none",height:"24",viewBox:"0 0 24 24",width:"24",xmlns:"http://www.w3.org/2000/svg",...o,children:[we.jsx("path",{d:"m5 5 14 14",stroke:"rgb(225, 225, 225, 0.35)",strokeLinejoin:"round",strokeWidth:"1.25"}),we.jsx("path",{clipRule:"evenodd",d:"M19.277 16.625H20v-1.25h-1.973l1.25 1.25Zm-3.239 2.065.89.89a4.602 4.602 0 0 1-2.716 1.04l-.212.005h-4a4.626 4.626 0 0 1-4.55-3.787l-.033-.213H4v-1.25h2c.345 0 .625.28.625.625a3.375 3.375 0 0 0 3.19 3.37l.185.005h4a3.36 3.36 0 0 0 2.038-.685Zm.587-4.717V8a4.625 4.625 0 0 0-8.5-2.526l.911.91a3.374 3.374 0 0 1 6.281.991H14v1.25h1.375v.75H14v1.25h1.375v.75h-1.348l1.25 1.25h.098v.098l1.25 1.25Zm-2.587 2.717.89.89A4.625 4.625 0 0 1 7.375 14v-3.973l1.25 1.25v.098h.098l1.25 1.25H8.625V14a3.375 3.375 0 0 0 5.413 2.69Z",fill:"rgb(225, 225, 225, 0.35)",fillRule:"evenodd"})]})}),lK=se.memo(function(o){return we.jsxs("svg",{fill:"none",height:"24",viewBox:"0 0 24 24",width:"24",xmlns:"http://www.w3.org/2000/svg",...o,children:[we.jsx("circle",{cx:"12",cy:"11",r:"7",stroke:"#fff",strokeLinejoin:"round",strokeWidth:"1.25"}),we.jsx("circle",{cx:"12",cy:"11",r:"3",stroke:"#fff",strokeLinejoin:"round",strokeWidth:"1.25"}),we.jsx("circle",{cx:"14.625",cy:"6.625",fill:"#fff",r:".625"}),we.jsx("path",{d:"M7 18.25a8.004 8.004 0 0 0 10 0",stroke:"#fff",strokeLinejoin:"round",strokeWidth:"1.25"})]})}),dK=se.memo(function(o){return we.jsxs("svg",{fill:"none",height:"24",viewBox:"0 0 24 24",width:"24",xmlns:"http://www.w3.org/2000/svg",...o,children:[we.jsx("path",{d:"m5 5 14 14",stroke:"rgb(225, 225, 225, 0.35)",strokeLinejoin:"round",strokeWidth:"1.25"}),we.jsx("path",{clipRule:"evenodd",d:"m15.72 18.373.91.909a8.63 8.63 0 0 1-9.788-.364l-.232-.18.78-.976a7.38 7.38 0 0 0 8.33.61Zm2.434-2.87A7.625 7.625 0 0 0 7.497 4.846l.897.896a6.375 6.375 0 0 1 8.864 8.864l.896.897Zm-3.857 1.446.952.951A7.625 7.625 0 0 1 5.1 7.751l.951.952a6.375 6.375 0 0 0 8.246 8.246Zm.956-4.348a3.625 3.625 0 0 0-4.854-4.854l.964.964a2.378 2.378 0 0 1 2.926 2.926l.964.964Zm-.628-5.351a.625.625 0 1 0 0-1.25.625.625 0 0 0 0 1.25Z",fill:"rgb(225, 225, 225, 0.35)",fillRule:"evenodd"})]})}),uK=()=>{const s="81190c52971d4004b7244bdcd93e2f34",{channelName:o}=nH(),[d,f]=se.useState(!0),[m,v]=se.useState(!0),[I,D]=se.useState(!0),{localMicrophoneTrack:L}=oL(m),{localCameraTrack:V}=cL(I);aL([L,V]);const q=dL(),{audioTracks:H}=lL(q),te=Xk();return sL({appid:s,channel:o,token:null},d),H.map(de=>de.play()),we.jsxs(we.Fragment,{children:[we.jsx("div",{children:q.map(de=>we.jsx(SL,{user:de}))}),we.jsx("div",{children:we.jsx(mL,{audioTrack:L,videoTrack:V,cameraOn:I,micOn:m,playAudio:m,playVideo:I,className:""})}),we.jsx("div",{children:we.jsxs("div",{id:"controlsToolbar",children:[we.jsxs("div",{id:"mediaControls",children:[v&&we.jsx("button",{className:"btn",onClick:()=>v(de=>!de),children:m?we.jsx(oK,{}):we.jsx(cK,{})}),D&&we.jsx("button",{className:"btn",onClick:()=>D(de=>!de),children:I?we.jsx(lK,{}):we.jsx(dK,{})})]}),we.jsx("button",{id:"endConnection",className:RH("btn btn-phone",{"btn-phone-active":d}),onClick:()=>{f(!1),te("/")},children:" Disconnect"})]})})]})};function hK(){const s=Xk(),o=Bn(TL.createClient({codec:"vp8",mode:"rtc"})),d=f=>{s(`/${f}`)};return we.jsxs(SH,{children:[we.jsx(KT,{path:"/",element:we.jsx(CH,{connectToVideo:d})}),we.jsx(KT,{path:"/:channelName",element:we.jsx(rL,{client:o,children:we.jsx(uK,{})})})]})}QS.createRoot(document.getElementById("root")).render(we.jsx(xD.StrictMode,{children:we.jsx(vH,{children:we.jsx(hK,{})})}));
